:PROPERTIES:
:ID:       44f588fc-94b5-4d3d-ae87-7a60366972cb
:END:
#+SETUPFILE:~/.gclrc/org/hugo_setup.org
#+HUGO_SLUG: javascript_confusable_collections
#+HTML_HEAD: <meta name="category" content="javascript"/>
#+HTML_HEAD: <meta name="tags" content="confusable"/>
#+HTML_HEAD: <meta name="createdAt" content="2022-05-10 14:09:15"/>
#+PROPERTY: header-args:js :exports both
#+PROPERTY: header-args :noweb no-export
#+TITLE: JavaScript Confusable Collections
<badge: GCCLL | Homepage | green | / | gnu-emacs | tinder>

#+begin_box
æœ¬æ–‡æ”¶é›†äº†<red:å¼€å‘>ã€<green:å­¦ä¹ >ã€<blue:å†²æµª>è¿‡ç¨‹ä¸­é‡åˆ°çš„å„ç§å®¹æ˜“äº§ç”Ÿç–‘æƒ‘çš„çŸ¥è¯†ç‚¹ã€‚
#+end_box
#+html: <br>

* Array
** Array.prototype.sort

#+begin_src js -n -r :exports both
const arr = [5, 14, 22, 9]
console.log(arr.sort().join(','))
#+end_src

#+RESULTS:
: 14,22,5,9
: undefined

æ˜¯ä¸æ˜¯å¾ˆç–‘æƒ‘æ€ä¹ˆä¸æ˜¯ ~5,9,14,22~ ?

red:è§£æƒ‘ï¼š

[[https://tc39.es/ecma262/#sec-array.prototype.sort][ECMAScriptÂ® 2023 LanguageÂ Specification]] è¿™é‡Œ[fn:sort]æ˜¯æ ‡å‡†é‡Œ sort æ–¹æ³•å®ç°çš„æ­¥
éª¤ï¼Œä¸‹é¢æ˜¯å…¶ä¼ªç ï¼š

#+begin_src js -n -r :exports code
function sort(compareFn) {
  if (compareFn && typeof compareFn !== 'function') {
    throw new TypeError('compareFn must be a function')
  }

  let obj = Object(this)
  let len = obj.length

  if (len == void 0) {
    throw new Error('sort ä¸èƒ½åœ¨éæ•°ç»„å¯¹è±¡ä¸Šä½¿ç”¨')
  }

  function SortCompare(x, y) {
    if (x === undefined && y === undefined) return +0

    if (x === undefined) return 1

    if (y === undefined) return -1

    // ç»“æœåˆæä¾›çš„æ¯”è¾ƒå‡½æ•°å†³å®š
    if (compareFn) {
      let v = compareFn(x, y)
      if (Number.isNaN(v)) return +0

      return v
    }

    // å¦‚æœæ²¡æœ‰ compareFn ä¼šå°†æ¯”è¾ƒçš„ä¸¤ä¸ªå‚æ•°è½¬æˆå­—ç¬¦ä¸²
    let xString = String(x), yString = String(y) (ref:sort-no-compareFn-toString)
    // è¿™é‡Œç”¨åˆ°äº† isLessThan æ¯”è¾ƒ(https://tc39.es/ecma262/#sec-islessthan)
    // è¿™é‡Œå…ˆçœç•¥äº†ï¼Œç›´æ¥å­—ç¬¦ä¸²æ¯”è¾ƒäº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¿›ä¸Šé¢çš„é“¾æ¥äº†è§£å­—ç¬¦ä¸²æ¯”è¾ƒè¯¦æƒ…
    let xSmaller = xString < yString
    if (xSmaller) return -1

    let ySmaller = yString < xString
    if (ySmaller) return 1

    return +0

  }

  // è¿™é‡Œæ˜¯è¿›è¡Œæ¯”è¾ƒåæ›¿æ¢ä½ç½®
  return SortIndexedProperties(obj, len, SortCompare)
}
#+end_src

å¦‚ä¸Šé¢çš„ä¼ªç ï¼Œå®ç°æ­¥éª¤å°±æ˜¯å…ˆæ£€æµ‹æœ‰æ²¡æœ‰ compareFn å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å†³å®šäº†æ¯”è¾ƒçš„æ–¹å¼ï¼Œ
æ˜¯ä¸æ˜¯åº”è¯¥è½¬æˆå­—ç¬¦ä¸²å»æ¯”è¾ƒ[[(sort-no-compareFn-toString)]] ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨ sort çš„æ—¶å€™
å°½é‡éƒ½ä¼ å…¥æ¯”è¾ƒå‡½æ•°ç»™å®ƒã€‚

å­—ç¬¦ä¸²æ¯”è¾ƒï¼š
#+begin_src js -n -r :exports both
console.log('14 < 22 < 5 < 9', '14' < '22', '22' < '5', '5' < '9')
#+end_src

#+RESULTS:
: 14 < 22 < 5 < 9 true true true
: undefined

æ­£ç¡®ä½¿ç”¨ï¼š

#+begin_src js -n -r :exports both
const arr = [5, 14, 22, 9]
console.log(arr.sort((a, b) => a - b).join(','))
#+end_src

#+RESULTS:
: 5,9,14,22
: undefined
* é—­åŒ…

** +setTimeout

#+begin_src js -n -r
for (var i = 0; i < 3; i++) {
  const log = () => {
    console.log('')
    console.log(i)
  }
  setTimeout(log, 100) (ref:closure-01-log)
}

#+end_src

#+RESULTS:
: undefined
: 3
:
: 3
:
: 3

red:è¾“å‡ºç»“æœè§£é‡Šï¼š

for å¾ªç¯æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šé‡æ–°æ‰§è¡Œä¸€é ~var i = 0~ æ“ä½œï¼Œè€Œå¯¹äº ~var~ å®ƒåªä¼šåœ¨ç¬¬ä¸€æ¬¡æ—¶å€™æ˜¯
å£°æ˜ï¼Œåé¢éƒ½æ˜¯é‡æ–°èµ‹å€¼ï¼Œæ‰€ä»¥æ¯æ¬¡ä¼ é€’ç»™é—­åŒ…çš„ ~i~ å…¶å®åœ¨å†…å­˜é‡Œéƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ã€‚

è€Œåœ¨åé¢([[(closure-01-log)]])å¹¶æ²¡æœ‰ç«‹å³æ‰§è¡Œ log ï¼Œåªæ˜¯å°†å…¶åŠ å…¥åˆ°äº†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰
åˆ°åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯ for å¾ªç¯æ‰§è¡Œå®Œä¹‹åæ‰ä¼šå»æ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä¸‰ä¸ª
log() ï¼Œè€Œæ­¤æ—¶çš„ä¸Šä¸‹æ–‡ä¸­çš„ i å€¼å…¶å®å·²ç»æ˜¯ 3 äº†ï¼Œä¹Ÿå°±æ˜¯ for æ‰§è¡Œå®Œä¹‹åçš„æœ€ç»ˆå€¼ã€‚

green:è§£å†³æ–¹æ¡ˆ

1. ~var i = 0~ æ”¹æˆ ~let i = 0~ è®©æ¯æ¬¡éå†éƒ½åˆ›æ–°åˆ›å»º[fn:let-const]ä¸€ä¸ªæ–°çš„å˜é‡ i (var[fn:var] åˆ™ä¸ä¼š)ã€‚

  #+begin_src js -n -r
  for (let i = 0; i < 3; i++) {
    const log = () => {
        console.log('')
        console.log(i)
    }
    setTimeout(log, 100)
  }
  #+end_src

  #+RESULTS:
  : undefined
  : 0
  :
  : 1
  :
  : 2

2. ç«‹å³å‡½æ•°å†åŒ…ä¸€å±‚è°ƒç”¨ä¼ å‚æ–¹å¼

  #+begin_src js -n -r
  for (var i = 0; i < 3; i++) {
    const log = (((i) => {
      return () => {
        console.log('')
        console.log(i)
      }
    })(i))
    setTimeout(log, 100)
  }
  #+end_src

  #+RESULTS:
  : undefined
  : 0
  :
  : 1
  :
  : 2


å…³äº var[fn:var] å£°æ˜å˜é‡çš„æ ‡å‡†è¯´æ˜ï¼š

#+begin_box var å£°æ˜è¯­æ³•æ ‡å‡†è§£é‡Š
A var statement declares variables that are scoped to the running execution
context's VariableEnvironment. Var variables are created when their containing
Environment Record is instantiated and are initialized to undefined when
created. Within the scope of any VariableEnvironment a common BindingIdentifier
may appear <red:in more than one VariableDeclaration but those declarations
collectively define only one variable>. <blue:A variable defined by a
VariableDeclaration with an Initializer is assigned the value of its
Initializer's AssignmentExpression when the VariableDeclaration is executed, not
when the variable is created>.
#+end_box
#+html: <br>

red:çº¢è‰²éƒ¨åˆ† æ„æ€æ˜¯ var å¯ä»¥æœ‰å¤šä¸ªå£°æ˜è¯­å¥ï¼Œä½†æ˜¯ä¸ç®¡å£°æ˜å‡ æ¬¡å®é™…éƒ½åªä¼šåˆ›å»ºä¸€ä¸ªå˜é‡ã€‚

blue:è“è‰²éƒ¨åˆ† æ„æ€æ˜¯å¸¦èµ‹å€¼çš„ var è¯­å¥ï¼Œå¹¶ä¸ä¼šåœ¨åˆ›å»ºå®ƒçš„æ—¶å€™å°±èµ‹å€¼ï¼Œè€Œæ˜¯ç¬¬ä¸€ä¸ªæ‰§
è¡Œçš„æ—¶å€™æ‰ä¼šçœŸæ­£è¢«èµ‹å€¼(è¿™ä¹Ÿå°±æ˜¯blue:varåªä¼šå£°æ˜æå‡è€Œä¸ä¼šæå‡èµ‹å€¼)

#+begin_box æå‡æœ‰å…³çŸ¥è¯†æ‰©å±•

æå‡æ˜¯æŒ‡å½“è¦æ‰§è¡Œçš„ä»£ç åœ¨åˆå§‹åŒ–çš„æ—¶å€™å˜é‡å’Œå‡½æ•°ä¼šæå‡åˆ°å®ƒä½œç”¨åŸŸçš„å¼€å¤´éƒ¨åˆ†ï¼Œè¿™æ ·å³ä½¿ä½ åœ¨å®ƒä¹¦
å†™ä½ç½®å‰é¢å»ä½¿ç”¨å®ƒä¹Ÿæ˜¯ä¸ä¼šæŠ¥é”™ï¼Œå°±æ˜¯å› ä¸ºå®ƒè¢«æå‡äº†ã€‚

å¦‚ï¼š
#+begin_src js -n -r
function test() {
  // ç›¸å½“äº varValue, getValue è¢«æå‡åˆ°è¿™é‡Œæ¥äº†
  console.log('value from function = ' + getValue() + ', value from var = ' + varValue)
  var varValue = 200
  function getValue() {
    return 100
  }
}
test()
#+end_src

å¦‚ä¸Šé¢çš„è¾“å‡ºï¼Œå°±æ˜¯å› ä¸º var å’Œ getValue è¿™ä¸¤ä¸ªè¢«æå‡åˆ°äº† test() å‡½æ•°å†…çš„ä½œç”¨åŸŸé¡¶
éƒ¨æ‰ä¼šè¢«ç¬¬ä¸€è¡Œçš„ console.log è®¿é—®åˆ°ã€‚ä½†æ˜¯ varValue å€¼æ˜¯ undefined è€Œ getValue()
å´å¯ä»¥æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸ºä¸åŒç±»å‹æå‡æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„(<red:var å˜é‡åªä¼šå£°æ˜æå‡ï¼Œä¸ä¼šèµ‹å€¼
æå‡ï¼Œè€Œå£°æ˜å¼å‡½æ•°æ˜¯å£°æ˜å’Œèµ‹å€¼éƒ½ä¼šæå‡>)

<kbd:æ³¨æ„ï¼Œå‡½æ•°åªæœ‰å£°æ˜å¼å‡½æ•°æ‰ä¼šå£°æ˜å’Œèµ‹å€¼åŒæ—¶æå‡ï¼Œè¡¨è¾¾å¼å‡½æ•°å’Œæ™®é€šçš„ var å˜é‡ä¸€æ ·ï¼Œåªæå‡å£°æ˜>ã€‚
#+end_box
#+html: <br>
* è¯­æ³•

** return

æ¥çœ‹ä¸‹ä¸‹é¢çš„ä¾‹å­

#+begin_src js -n -r

function test(item) {
  return
    [item]
}
console.log('test result: ' + test())
#+end_src

#+RESULTS:
: test result: undefined
: undefined

ğŸ˜‚ æœ‰æ²¡å†™è¿‡è¿™è¿™æ ·ä»£ç å‘¢ï¼Ÿï¼Ÿï¼Ÿ

åŸå› [fn:return]ï¼š return è¯­å¥åé¢ä¸èƒ½æœ‰æ¢è¡Œç¬¦ï¼Œä¸‹é¢æ˜¯ [[https://tc39.es/ecma262/#prod-ReturnStatement][ECMAScriptÂ® 2023
LanguageÂ Specification]] ä¸­ return è¯­æ³•çš„å®šä¹‰

[[../assets/img/tmp/js-return-no-linebreak.png]]

/orange:æ‰€æœ‰æ²¡äº‹å¤šçœ‹çœ‹æ ‡å‡†è¿˜æ˜¯æœ‰å¿…è¦çš„/ ã€‚
* Footnote

[fn:let-const] https://tc39.es/ecma262/#sec-let-and-const-declarations
[fn:sort] https://tc39.es/ecma262/#sec-array.prototype.sort
[fn:var] https://tc39.es/ecma262/#sec-variable-statement
[fn:return] https://tc39.es/ecma262/#prod-ReturnStatement

* COMMENT Local Variables       :ARCHIVE:
# Local Variables:
# after-save-hook: gcl/org-html-export-to-html
# End:
