<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-05-10 Tue 15:42 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>JavaScript Confusable Collections</title>
  <meta name="author" content="Zhicheng Lee">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <link rel="icon" type="image/png" sizes="48x48" href=
  "/favicon.ico">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <link rel="stylesheet" href="/assets/js/fancybox/fancybox.css"
  type="text/css" media="screen">
  <script type="text/javascript" src=
  "/assets/js/fancybox/fancybox.umd.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-icons.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/apps.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="javascript">
  <meta name="tags" content="confusable">
  <meta name="createdAt" content="2022-05-10 14:09:15">
  <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;
        
          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster.bundle.min.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster-sideTip-punk.min.css">
  <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
  </script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster.bundle.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster-scrollableTip.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/tooltips.js"></script>
  <style>
           abbr {color: red;}
        
           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
  </style>
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">JavaScript Confusable Collections</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#org81d0028">1. Array</a>
            <ul>
              <li>
                <a href="#orgadeb621">1.1. Array.prototype.sort</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgffa27a4">2. 闭包</a>
            <ul>
              <li>
                <a href="#orge231756">2.1. +setTimeout</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgf17f94e">3. Footnote</a>
          </li>
        </ul>
      </div>
    </div>
    <p><a href="/"><img src=
    "https://img.shields.io/badge/GCCLL-Homepage-green?logo=gnu-emacs"></a></p>
    <div style=
    "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <p>本文收集了<span style="color:red;">开发</span>、<span style=
      "color:green;">学习</span>、<span style=
      "color:blue;">冲浪</span>过程中遇到的各种容易产生疑惑的知识点。</p>
    </div><br>
    <div id="outline-container-org81d0028" class="outline-2">
      <h2 id="org81d0028"><span class="section-number-2">1.</span>
      Array</h2>
      <div class="outline-text-2" id="text-1"></div>
      <div id="outline-container-orgadeb621" class="outline-3">
        <h3 id="orgadeb621"><span class=
        "section-number-3">1.1.</span> Array.prototype.sort</h3>
        <div class="outline-text-3" id="text-1-1">
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">arr</span> = [<span class=
            "org-highlight-numbers-number">5</span>, <span class=
            "org-highlight-numbers-number">14</span>, <span class=
            "org-highlight-numbers-number">22</span>, <span class=
            "org-highlight-numbers-number">9</span>]
<span class=
"linenr">2: </span>console.log(arr.sort().join(<span class=
"org-string">','</span>))
</pre>
          </div>
          <pre class="example">
14,22,5,9
undefined
</pre>
          <p>是不是很疑惑怎么不是 <code>5,9,14,22</code> ?</p>
          <p><span style="color:red;">解惑：</span></p>
          <p><a href=
          "https://tc39.es/ecma262/#sec-array.prototype.sort">ECMAScript®
          2023 Language&nbsp;Specification</a> 这里<sup><a id="fnr.1"
          class="footref" href="#fn.1" role=
          "doc-backlink">1</a></sup>是标准里 sort 方法实现的步 骤，下面是其伪码：</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">sort</span>(<span class=
            "org-variable-name">compareFn</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">if</span> (compareFn &amp;& <span class=
"org-keyword">typeof</span> compareFn !== <span class=
"org-string">'function'</span>) {
<span class="linenr"> 3: </span>    <span class=
"org-keyword">throw</span> <span class=
"org-keyword">new</span> <span class=
"org-type">TypeError</span>(<span class=
"org-string">'compareFn must be a function'</span>)
<span class="linenr"> 4: </span>  }
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">obj</span> = Object(<span class=
"org-constant">this</span>)
<span class="linenr"> 7: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">len</span> = obj.length
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>  <span class=
"org-keyword">if</span> (len == <span class=
"org-keyword">void</span> <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">10: </span>    <span class=
"org-keyword">throw</span> <span class=
"org-keyword">new</span> <span class=
"org-type">Error</span>(<span class=
"org-string">'sort 不能在非数组对象上使用'</span>)
<span class="linenr">11: </span>  }
<span class="linenr">12: </span>
<span class="linenr">13: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">SortCompare</span>(<span class=
"org-variable-name">x</span>, <span class=
"org-variable-name">y</span>) {
<span class="linenr">14: </span>    <span class=
"org-keyword">if</span> (x === <span class=
"org-constant">undefined</span> &amp;& y === <span class=
"org-constant">undefined</span>) <span class=
"org-keyword">return</span> +<span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">15: </span>
<span class="linenr">16: </span>    <span class=
"org-keyword">if</span> (x === <span class=
"org-constant">undefined</span>) <span class=
"org-keyword">return</span> <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">17: </span>
<span class="linenr">18: </span>    <span class=
"org-keyword">if</span> (y === <span class=
"org-constant">undefined</span>) <span class=
"org-keyword">return</span> -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">19: </span>
<span class="linenr">20: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">结果又提供的比较函数决定</span>
<span class="linenr">21: </span>    <span class=
"org-keyword">if</span> (compareFn) {
<span class="linenr">22: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">v</span> = compareFn(x, y)
<span class="linenr">23: </span>      <span class=
"org-keyword">if</span> (Number.isNaN(v)) <span class=
"org-keyword">return</span> +<span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">24: </span>
<span class="linenr">25: </span>      <span class=
"org-keyword">return</span> v
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>
<span class="linenr">28: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如果没有 compareFn 会将比较的两个参数转成字符串</span>
<span id="coderef-sort-no-compareFn-toString" class=
"coderef-off"><span class="linenr">29: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">xString</span> = String(x), <span class=
"org-variable-name">yString</span> = String(y)</span>
<span class="linenr">30: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里用到了 isLessThan 比较(https://tc39.es/ecma262/#sec-islessthan)</span>
<span class="linenr">31: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里先省略了，直接字符串比较了，有兴趣的同学可以进上面的链接了解字符串比较详情</span>
<span class="linenr">32: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">xSmaller</span> = xString &lt; yString
<span class="linenr">33: </span>    <span class=
"org-keyword">if</span> (xSmaller) <span class=
"org-keyword">return</span> -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">34: </span>
<span class="linenr">35: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ySmaller</span> = yString &lt; xString
<span class="linenr">36: </span>    <span class=
"org-keyword">if</span> (ySmaller) <span class=
"org-keyword">return</span> <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">37: </span>
<span class="linenr">38: </span>    <span class=
"org-keyword">return</span> +<span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">39: </span>
<span class="linenr">40: </span>  }
<span class="linenr">41: </span>
<span class="linenr">42: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里是进行比较后替换位置</span>
<span class="linenr">43: </span>  <span class=
"org-keyword">return</span> SortIndexedProperties(obj, len, SortCompare)
<span class="linenr">44: </span>}
</pre>
          </div>
          <p>如上面的伪码，实现步骤就是先检测有没有 compareFn 函数，这个函数决定了比较的方式，
          是不是应该转成字符串去比较<a href=
          "#coderef-sort-no-compareFn-toString" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-sort-no-compareFn-toString');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-sort-no-compareFn-toString');">29</a>
          ，所以在使用 sort 的时候 尽量都传入比较函数给它。</p>
          <p>字符串比较：</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>console.log(<span class=
            "org-string">'14 &lt; 22 &lt; 5 &lt; 9'</span>, <span class=
            "org-string">'14'</span> &lt; <span class=
            "org-string">'22'</span>, <span class=
            "org-string">'22'</span> &lt; <span class=
            "org-string">'5'</span>, <span class=
            "org-string">'5'</span> &lt; <span class=
            "org-string">'9'</span>)
</pre>
          </div>
          <pre class="example">
14 &lt; 22 &lt; 5 &lt; 9 true true true
undefined
</pre>
          <p>正确使用：</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">arr</span> = [<span class=
            "org-highlight-numbers-number">5</span>, <span class=
            "org-highlight-numbers-number">14</span>, <span class=
            "org-highlight-numbers-number">22</span>, <span class=
            "org-highlight-numbers-number">9</span>]
<span class=
"linenr">2: </span>console.log(arr.sort((a, b) =&gt; a - b).join(<span class="org-string">','</span>))
</pre>
          </div>
          <pre class="example">
5,9,14,22
undefined
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-orgffa27a4" class="outline-2">
      <h2 id="orgffa27a4"><span class="section-number-2">2.</span>
      闭包</h2>
      <div class="outline-text-2" id="text-2"></div>
      <div id="outline-container-orge231756" class="outline-3">
        <h3 id="orge231756"><span class=
        "section-number-3">2.1.</span> +setTimeout</h3>
        <div class="outline-text-3" id="text-2-1">
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span><span class=
            "org-keyword">for</span> (<span class=
            "org-keyword">var</span> <span class=
            "org-variable-name">i</span> = <span class=
            "org-highlight-numbers-number">0</span>; i &lt; <span class=
            "org-highlight-numbers-number">3</span>; i++) {
<span class="linenr">2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">log</span> = () =&gt; {
<span class="linenr">3: </span>    console.log(<span class=
"org-string">''</span>)
<span class="linenr">4: </span>    console.log(i)
<span class="linenr">5: </span>  }
<span id="coderef-closure-01-log" class="coderef-off"><span class=
"linenr">6: </span>  setTimeout(log, <span class=
"org-highlight-numbers-number">100</span>)</span>
<span class="linenr">7: </span>}
<span class="linenr">8: </span>
</pre>
          </div>
          <pre class="example">
undefined
3

3

3
</pre>
          <p><span style="color:red;">输出结果解释：</span></p>
          <p>for 循环每次执行都会重新执行一遍 <code>var i = 0</code> 操作，而对于
          <code>var</code> 它只会在第一次时候是 声明，后面都是重新赋值，所以每次传递给闭包的
          <code>i</code> 其实在内存里都是同一个地址。</p>
          <p>而在后面(<a href="#coderef-closure-01-log" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-closure-01-log');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-closure-01-log');">6</a>)并没有立即执行
          log ，只是将其加入到了微任务队列中，等 到同步代码执行完成，这里也就是 for
          循环执行完之后才会去执行微任务队列中的三个 log() ，而此时的上下文中的 i 值其实已经是 3 了，也就是
          for 执行完之后的最终值。</p>
          <p><span style="color:green;">解决方案</span></p>
          <ol class="org-ol">
            <li>
              <p><code>var i = 0</code> 改成 <code>let i = 0</code>
              让每次遍历都创新创建<sup><a id="fnr.2" class="footref" href=
              "#fn.2" role="doc-backlink">2</a></sup>一个新的变量 i
              (var<sup><a id="fnr.3" class="footref" href="#fn.3"
              role="doc-backlink">3</a></sup> 则不会)。</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "linenr">1: </span>  <span class=
                "org-keyword">for</span> (<span class=
                "org-keyword">let</span> <span class=
                "org-variable-name">i</span> = <span class=
                "org-highlight-numbers-number">0</span>; i &lt; <span class=
                "org-highlight-numbers-number">3</span>; i++) {
<span class="linenr">2: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">log</span> = () =&gt; {
<span class="linenr">3: </span>        console.log(<span class=
"org-string">''</span>)
<span class="linenr">4: </span>        console.log(i)
<span class="linenr">5: </span>    }
<span class="linenr">6: </span>    setTimeout(log, <span class=
"org-highlight-numbers-number">100</span>)
<span class="linenr">7: </span>  }
</pre>
              </div>
              <pre class="example">
undefined
0

1

2
</pre>
            </li>
            <li>
              <p>立即函数再包一层调用传参方式</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "linenr">1: </span>  <span class=
                "org-keyword">for</span> (<span class=
                "org-keyword">var</span> <span class=
                "org-variable-name">i</span> = <span class=
                "org-highlight-numbers-number">0</span>; i &lt; <span class=
                "org-highlight-numbers-number">3</span>; i++) {
<span class="linenr">2: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">log</span> = (((i) =&gt; {
<span class="linenr">3: </span>      <span class=
"org-keyword">return</span> () =&gt; {
<span class="linenr">4: </span>        console.log(<span class=
"org-string">''</span>)
<span class="linenr">5: </span>        console.log(i)
<span class="linenr">6: </span>      }
<span class="linenr">7: </span>    })(i))
<span class="linenr">8: </span>    setTimeout(log, <span class=
"org-highlight-numbers-number">100</span>)
<span class="linenr">9: </span>  }
</pre>
              </div>
              <pre class="example">
undefined
0

1

2
</pre>
            </li>
          </ol>
          <p>关于 var<sup><a id="fnr.3.100" class="footref" href=
          "#fn.3" role="doc-backlink">3</a></sup> 声明变量的标准说明：</p>
          <div style=
          "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <h3>var 声明语法标准解释</h3>
            <p>A var statement declares variables that are scoped
            to the running execution context’s VariableEnvironment.
            Var variables are created when their containing
            Environment Record is instantiated and are initialized
            to undefined when created. Within the scope of any
            VariableEnvironment a common BindingIdentifier may
            appear <span style="color:red;">in more than one
            VariableDeclaration but those declarationscollectively
            define only one variable</span>. <span style=
            "color:blue;">A variable defined by
            aVariableDeclaration with an Initializer is assigned
            the value of itsInitializer's AssignmentExpression when
            the VariableDeclaration is executed, notwhen the
            variable is created</span>.</p>
          </div><br>
          <p><span style="color:red;">红色部分</span> 意思是 var
          可以有多个声明语句，但是不管声明几次实际都只会创建一个变量。</p>
          <p><span style="color:blue;">蓝色部分</span> 意思是带赋值的 var
          语句，并不会在创建它的时候就赋值，而是第一个执 行的时候才会真正被赋值(这也就是<span style=
          "color:blue;">var只会声明提升而不会提升赋值</span>)</p>
          <div style=
          "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <h3>提升有关知识扩展</h3>
            <p>提升是指当要执行的代码在初始化的时候变量和函数会提升到它作用域的开头部分，这样即使你在它书
            写位置前面去使用它也是不会报错，就是因为它被提升了。</p>
            <p>如：</p>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">test</span>() {
<span class="linenr">2: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">相当于 varValue, getValue 被提升到这里来了</span>
<span class="linenr">3: </span>  console.log(<span class=
"org-string">'value from function = '</span> + getValue() + <span class="org-string">', value from var = '</span> + varValue)
<span class="linenr">4: </span>  <span class=
"org-keyword">var</span> <span class=
"org-variable-name">varValue</span> = <span class=
"org-highlight-numbers-number">200</span>
<span class="linenr">5: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getValue</span>() {
<span class="linenr">6: </span>    <span class=
"org-keyword">return</span> <span class=
"org-highlight-numbers-number">100</span>
<span class="linenr">7: </span>  }
<span class="linenr">8: </span>}
<span class="linenr">9: </span>test()
</pre>
            </div>
            <pre class="example">
value from function = 100, value from var = undefined
undefined
</pre>
            <p>如上面的输出，就是因为 var 和 getValue 这两个被提升到了 test() 函数内的作用域顶
            部才会被第一行的 console.log 访问到。但是 varValue 值是 undefined 而
            getValue() 却可以执行，这是因为不同类型提升方式是不一样的(<span style=
            "color:red;">var
            变量只会声明提升，不会赋值提升，而声明式函数是声明和赋值都会提升</span>)</p>
            <p><kbd style="">注意，函数只有声明式函数才会声明和赋值同时提升，表达式函数和普通的 var
            变量一样，只提升声明</kbd>。</p>
          </div><br>
        </div>
      </div>
    </div>
    <div id="outline-container-orgf17f94e" class="outline-2">
      <h2 id="orgf17f94e"><span class="section-number-2">3.</span>
      Footnote</h2>
      <div class="outline-text-2" id="text-3"></div>
    </div>
    <div id="footnotes">
      <h2 class="footnotes">Footnotes:</h2>
      <div id="text-footnotes">
        <div class="footdef">
          <sup><a id="fn.1" class="footnum" href="#fnr.1" role=
          "doc-backlink">1</a></sup>
          <div class="footpara" role="doc-footnote">
            <p class="footpara"><a href=
            "https://tc39.es/ecma262/#sec-array.prototype.sort">https://tc39.es/ecma262/#sec-array.prototype.sort</a></p>
          </div>
        </div>
        <div class="footdef">
          <sup><a id="fn.2" class="footnum" href="#fnr.2" role=
          "doc-backlink">2</a></sup>
          <div class="footpara" role="doc-footnote">
            <p class="footpara"><a href=
            "https://tc39.es/ecma262/#sec-let-and-const-declarations">
            https://tc39.es/ecma262/#sec-let-and-const-declarations</a></p>
          </div>
        </div>
        <div class="footdef">
          <sup><a id="fn.3" class="footnum" href="#fnr.3" role=
          "doc-backlink">3</a></sup>
          <div class="footpara" role="doc-footnote">
            <p class="footpara"><a href=
            "https://tc39.es/ecma262/#sec-variable-statement">https://tc39.es/ecma262/#sec-variable-statement</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Zhicheng Lee</p>
    <p class="date">Created: 2022-05-10 Tue 15:42</p>
  </div>
</body>
</html>
