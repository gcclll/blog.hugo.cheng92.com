<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-03-14 Mon 17:46 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>Vue ChangeLog</title>
  <meta name="author" content="Zhicheng Lee">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="vue">
  <meta name="tags" content="CHANGELOG">
  <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;
        
          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster.bundle.min.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster-sideTip-punk.min.css">
  <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
  </script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster.bundle.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster-scrollableTip.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/tooltips.js"></script>
  <style>
           abbr {color: red;}
        
           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
  </style>
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">Vue ChangeLog</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#org000b2fe">1. 3.2 All Important Changes</a>
            <ul>
              <li>
                <a href="#slot-args">1.1. [3.2.4]
                slots.default(a,b,c,…) 插槽使用支持多个参数</a>
              </li>
              <li>
                <a href="#fix-vbind-class">1.2. v-bind style/class
                被解析成了 <code>[object Object]</code> ?</a>
              </li>
              <li>
                <a href="#org1e08537">1.3. <span class=
                "todo TODO">TODO</span> EffectScope ?</a>
              </li>
              <li>
                <a href="#deferredComputed">1.4.
                deferredComputed</a>
              </li>
              <li>
                <a href="#ReactiveEffect2Class">1.5. ReactiveEffect
                从函数变成了一个 class</a>
              </li>
              <li>
                <a href="#new-ref-sugar">1.6. 新增 ref 语法糖（$ref,
                $raw）</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgbf1fd6c">2. 3.2.23~29</a>
            <ul>
              <li>
                <a href="#org0d8594f">2.1. Bug Fixes
                <code>[1/1]</code></a>
              </li>
              <li>
                <a href="#orgcf1f1fd">2.2. Features
                <code>[3/3]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org69b0cf2">3. <span class=
            "done DONE">DONE</span> 3.2.14~22 (2021-09-22 ~
            2021-11-15)</a>
            <ul>
              <li>
                <a href="#org11cacda">3.1. Bug Fixes
                <code>[10/10]</code></a>
              </li>
              <li>
                <a href="#org8235684">3.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgf1a6c64">4. 3.2.13</a>
            <ul>
              <li>
                <a href="#org0bc3a11">4.1. Bug Fixes
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgb8e0016">5. 3.2.12</a>
            <ul>
              <li>
                <a href="#org5adedce">5.1. Bug Fixes
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgd241808">6. 3.2.4</a>
            <ul>
              <li>
                <a href="#org5d842fc">6.1. Bug Fixes
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgaac4f5f">7. 3.2.0-beta.8</a>
            <ul>
              <li>
                <a href="#org3d1b971">7.1. Bug Fixes
                <code>[8/8]</code></a>
              </li>
              <li>
                <a href="#org3e80a32">7.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org6551e51">8. 3.2.0-beta.7</a>
            <ul>
              <li>
                <a href="#orgb94762b">8.1. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#orgfd55979">8.2. Features
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgc290657">9. 3.2.0-beta.6</a>
            <ul>
              <li>
                <a href="#orgc99ae40">9.1. Bug Fixes
                <code>[3/3]</code></a>
              </li>
              <li>
                <a href="#orgef54dbb">9.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org7039d9d">10. 3.2.0-beta.5</a>
            <ul>
              <li>
                <a href="#orgb535c84">10.1. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#org0ff16a4">10.2. Features
                <code>[4/4]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orge0e7de8">11. 3.2.0-beta.4</a>
            <ul>
              <li>
                <a href="#org309ba3b">11.1. Bug Fixes
                <code>[2/2]</code></a>
              </li>
              <li>
                <a href="#org33bf65b">11.2. Performance
                Improvements <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgaa3ced8">12. 3.2.0-beta.3</a>
            <ul>
              <li>
                <a href="#orgd92aae5">12.1. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#org38f8435">12.2. Features
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org62cf55d">13. 3.2.0-beta.2</a>
            <ul>
              <li>
                <a href="#org632b1d2">13.1. Bug Fixes
                <code>[11/11]</code></a>
              </li>
              <li>
                <a href="#org3b3a7ab">13.2. Features
                <code>[3/3]</code></a>
              </li>
              <li>
                <a href="#org2065767">13.3. Performance
                Improvements <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org1572178">14. 3.2.0-beta.1</a>
            <ul>
              <li>
                <a href="#orge5e76ad">14.1. Code Refactoring(代码重构)
                <code>[1/1]</code></a>
              </li>
              <li>
                <a href="#org5b5081d">14.2. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#org6ba2ce7">14.3. Features
                <code>[10/10]</code></a>
              </li>
              <li>
                <a href="#org8d8a413">14.4. Performance
                improvements <code>[7/7]</code></a>
              </li>
              <li>
                <a href="#org86ed1df">14.5. Breaking Changes
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgcbf9c47">15. 小结</a>
          </li>
          <li>
            <a href="#org4ed0d58">16. 3.0.8</a>
            <ul>
              <li>
                <a href="#orgb84366e">16.1. <span class=
                "done DONE">DONE</span> Performance Improvements
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgbfbaa56">17. 3.0.7</a>
            <ul>
              <li>
                <a href="#org3e12a38">17.1. <span class=
                "done DONE">DONE</span> Bug Fixes
                <code>[6/6]</code></a>
              </li>
              <li>
                <a href="#org68bdaf9">17.2. <span class=
                "done DONE">DONE</span> Performance Improvements
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org610afca">18. 3.0.6</a>
            <ul>
              <li>
                <a href="#orgbd70deb">18.1. Bug Fixes
                <code>[3/3]</code></a>
              </li>
              <li>
                <a href="#org83d73c0">18.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgf2e8503">19. 3.0.5</a>
            <ul>
              <li>
                <a href="#orgc86f7da">19.1. <span class=
                "done DONE">DONE</span> <b>Bug Fixes</b>
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <p><a href="/"><img src=
    "https://img.shields.io/badge/GCCLL-Homepage-green?logo=gnu-emacs"></a></p>
    <div style=
    "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <h3>说明</h3>
      <p><a href=
      "https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md">https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md</a></p>
      <p>本文只记录 <abbr class="tooltip" title=
      "The Progressive JavaScript Framework !&lt;br&gt;&lt;br&gt;An approachable, performant and versatile framework for building web user interfaces.&lt;br&gt;&lt;br&gt;&lt;strong&gt;Installation&lt;/strong&gt;:&lt;br&gt;&lt;br&gt;=$ npm init vue@latest=&lt;br&gt;&lt;br&gt;&lt;strong&gt;Without Build Tools&lt;/strong&gt;:">
      Vue3</abbr> 的一些重要更新点或重要的 BUG 修复，目的是为了对 <abbr class="tooltip"
      title=
      "The Progressive JavaScript Framework !&lt;br&gt;&lt;br&gt;An approachable, performant and versatile framework for building web user interfaces.&lt;br&gt;&lt;br&gt;&lt;strong&gt;Installation&lt;/strong&gt;:&lt;br&gt;&lt;br&gt;=$ npm init vue@latest=&lt;br&gt;&lt;br&gt;&lt;strong&gt;Without Build Tools&lt;/strong&gt;:">
      Vue3</abbr> 的 持续关注，本人主要致力于 <abbr class="tooltip" title=
      "The Progressive JavaScript Framework !&lt;br&gt;&lt;br&gt;An approachable, performant and versatile framework for building web user interfaces.&lt;br&gt;&lt;br&gt;&lt;strong&gt;Installation&lt;/strong&gt;:&lt;br&gt;&lt;br&gt;=$ npm init vue@latest=&lt;br&gt;&lt;br&gt;&lt;strong&gt;Without Build Tools&lt;/strong&gt;:">
      Vue3</abbr> 技术栈的开发。</p>
    </div><br>
    <br>
    <div id="outline-container-org000b2fe" class="outline-2">
      <h2 id="org000b2fe"><span class="section-number-2">1.</span>
      3.2 All Important Changes</h2>
      <div class="outline-text-2" id="text-1">
        <ul class="org-ul">
          <li>
            <abbr class="tooltip" title=
            "zsh:1: command not found: wn&lt;br&gt;">v-on</abbr> 支持
            <code>async...await</code> handler <a class="anchor"
            aria-hidden="true" id="von-async" href=
            "#von-async"><svg xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 16 16" width="16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <code>vm = createApp({ ...}).mount(...)</code> 返回的 vm
            上取不到 <code>expose({ foo: 1 })</code> 出来的 属性，
            <code>vm.foo === undefined</code> <a class="anchor"
            aria-hidden="true" id="expose-proxy" href=
            "#expose-proxy"><svg xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 16 16" width="16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <code>defineProps</code> 支持解构操作 <a class="anchor"
            aria-hidden="true" id="defineProps-destructure" href=
            "#defineProps-destructure"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ul>
      </div>
      <div id="outline-container-slot-args" class="outline-3">
        <h3 id="slot-args"><span class=
        "section-number-3">1.1.</span> [3.2.4]
        slots.default(a,b,c,…) 插槽使用支持多个参数</h3>
        <div class="outline-text-3" id="text-slot-args">
          <p>slot.default(…args) 支持多个参数。</p>
          <p>如： <code>h('div', null, slots.default('a', 'b',
          'c'))</code></p>
          <div class="org-src-container">
            <pre class="src src-html">&lt;<span class=
            "org-function-name">template</span>&gt;
  &lt;<span class="org-function-name">demo</span>&gt;
    &lt;<span class=
"org-function-name">template</span> #default=<span class=
"org-string">"a,b,c"</span>&gt;{{a}}, {{b}}, {{c}}&lt;/<span class=
"org-function-name">template</span>&gt;
  &lt;/<span class="org-function-name">demo</span>&gt;
&lt;/<span class="org-function-name">template</span>&gt;

// demo.js
export default {
  name: "Demo",
  props: { ... },
  render() {
    return h('h1', null, this.$slots.default("a", "b", "c"))
  }
}
</pre>
          </div>
          <p>FIX:</p>
          <div class="org-src-container">
            <pre class="src src-diff"><span class=
            "org-diff-context"> packages/runtime-core/src/componentSlots.ts</span>
<span class=
"org-diff-hunk-header">@@ -63,15 +63,15 @@</span><span class=
"org-diff-function"> const normalizeSlot = (</span>
<span class="org-diff-context">  rawSlot: Function,</span>
<span class=
"org-diff-context">  ctx: ComponentInternalInstance | null | undefined</span>
<span class="org-diff-context">): Slot =&gt; {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  const normalized = withCtx((props: any) =&gt; {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  const normalized = withCtx((...args: any[]) =&gt; {</span>
<span class=
"org-diff-context">    if (__DEV__ &amp;& currentInstance) {</span>
<span class="org-diff-context">      warn(</span>
<span class=
"org-diff-context">        `Slot "${key}" invoked outside of the render function: ` +</span>
<span class=
"org-diff-context">          `this will not track dependencies used in the slot. ` +</span>
<span class=
"org-diff-context">          `Invoke the slot function inside the render function instead.`</span>
<span class="org-diff-context">      )</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    return normalizeSlotValue(rawSlot(props))</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    return normalizeSlotValue(rawSlot(...args))</span>
<span class="org-diff-context">  }, ctx) as Slot</span>
<span class="org-diff-context">  // NOT a compiled slot</span>
  ;(normalized as ContextualRenderFn)._c = false
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-fix-vbind-class" class=
      "outline-3">
        <h3 id="fix-vbind-class"><span class=
        "section-number-3">1.2.</span> v-bind style/class 被解析成了
        <code>[object Object]</code> ?</h3>
        <div class="outline-text-3" id="text-fix-vbind-class">
          <p>问题(<a href="">SFC playground</a>)：</p>
          <div class="org-src-container">
            <pre class="src src-html">&lt;<span class=
            "org-function-name">template</span>&gt;
  &lt;<span class=
"org-function-name">button</span> :class=<span class=
"org-string">"{ btn: true }"</span>&gt;1&lt;/<span class=
"org-function-name">button</span>&gt;
  &lt;<span class="org-function-name">button</span> <span class=
"org-variable-name">v-bind</span>=<span class=
"org-string">"{ disabled: true }"</span> :class=<span class=
"org-string">"{ btn: true }"</span>&gt;2&lt;/<span class=
"org-function-name">button</span>&gt;
  &lt;<span class=
"org-function-name">button</span> :class=<span class=
"org-string">"{ btn: true }"</span> <span class=
"org-variable-name">v-bind</span>=<span class=
"org-string">"{ disabled: true }"</span>&gt;3&lt;/<span class=
"org-function-name">button</span>&gt;
&lt;/<span class="org-function-name">template</span>&gt;

&lt;<span class="org-function-name">style</span>&gt;
  .btn {
    color: red;
  }
&lt;/<span class="org-function-name">style</span>&gt;
</pre>
          </div>
          <p>第 1，2 个按钮能正常解析出 <code>btn</code> 类名，但是第三个按钮的 class 变成了
          <code>[object Object]</code></p>
          <p>这要看下 <a href=
          "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/vnode.ts">
          runtime-core/src/vnode.ts:mergeProps</a>
          中是如何对属性进行合并的：</p>
          <p>它首先将第一个属性 extend 出来了，做为了一个基准对象，比如 btn3 就有了:</p>
          <p><code>ret = { class: { btn: true } }</code></p>
          <p>然后进入 for 循环处理剩下的属性 <code>{disabled: true}</code>,
          最后发现走了最后一个</p>
          <p><code>else if (key !== '')</code> 所以最后的 <code>ret = {
          class: { btn: true }, disabled: true }</code></p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "org-keyword">export</span> <span class=
            "org-keyword">function</span> <span class=
            "org-function-name">mergeProps</span><span class=
            "org-rainbow-delimiters-depth-1">(</span>...args: <span class=
            "org-rainbow-delimiters-depth-2">(</span>Data & VNodeProps<span class="org-rainbow-delimiters-depth-2">)[]</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">ret</span> = <span class=
"org-function-name">extend</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">{}</span>, args<span class=
"org-rainbow-delimiters-depth-3">[</span><span class=
"org-highlight-numbers-number">0</span><span class=
"org-rainbow-delimiters-depth-3">]</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
  <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">1</span>; i &lt; <span class=
"org-type">args</span>.<span class=
"org-type">length</span>; <span class=
"org-type">i</span>++<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">toMerge</span> = args<span class=
"org-rainbow-delimiters-depth-3">[</span>i<span class=
"org-rainbow-delimiters-depth-3">]</span>
    <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> <span class=
"org-keyword">in</span> toMerge<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>key === <span class=
"org-string">'class'</span><span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>ret.<span class=
"org-keyword">class</span> !== toMerge.<span class=
"org-keyword">class</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
          ret.<span class="org-keyword">class</span> = <span class=
"org-function-name">normalizeClass</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">[</span>ret.<span class=
"org-keyword">class</span>, toMerge.<span class=
"org-keyword">class</span><span class=
"org-rainbow-delimiters-depth-3">]</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-1">}</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>key === <span class=
"org-string">'style'</span><span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        ret.style = <span class=
"org-function-name">normalizeStyle</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-rainbow-delimiters-depth-2">[</span>ret.style, toMerge.style<span class="org-rainbow-delimiters-depth-2">]</span><span class="org-rainbow-delimiters-depth-1">)</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-function-name">isOn</span><span class=
"org-rainbow-delimiters-depth-1">(</span>key<span class=
"org-rainbow-delimiters-depth-1">)</span><span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">const</span> <span class=
"org-variable-name">existing</span> = ret<span class=
"org-rainbow-delimiters-depth-1">[</span>key<span class=
"org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">const</span> <span class=
"org-variable-name">incoming</span> = toMerge<span class=
"org-rainbow-delimiters-depth-1">[</span>key<span class=
"org-rainbow-delimiters-depth-1">]</span>
        <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>existing !== incoming<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
          ret<span class=
"org-rainbow-delimiters-depth-2">[</span>key<span class=
"org-rainbow-delimiters-depth-2">]</span> = existing
            ? <span class=
"org-rainbow-delimiters-depth-2">[]</span>.<span class=
"org-function-name">concat</span><span class=
"org-rainbow-delimiters-depth-2">(</span>existing <span class=
"org-keyword">as</span> <span class=
"org-typescript-primitive">any</span>, incoming <span class=
"org-keyword">as</span> <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
            : incoming
        <span class="org-rainbow-delimiters-depth-1">}</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>key !== <span class=
"org-string">''</span><span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        ret<span class=
"org-rainbow-delimiters-depth-1">[</span>key<span class=
"org-rainbow-delimiters-depth-1">]</span> = toMerge<span class=
"org-rainbow-delimiters-depth-1">[</span>key<span class=
"org-rainbow-delimiters-depth-1">]</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">return</span> ret
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
          <p>runtime-core 阶段只是对 props 进行了 normalize 处理，真正 patch
          的流程是：</p>
          <p>runtime-core: renderer.ts:patchProps -&gt;
          hostPatchProp = runtime-dom:patchProp.ts</p>
          <p>最后 class 的 patch 是
          runtime-dom/src/modules/class.ts:patchClass</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "org-comment-delimiter">// </span><span class=
            "org-comment">compiler should normalize class + :class bindings on the same element</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">into a single binding ['staticClass', dynamic]</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">patchClass</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-variable-name">el</span>: <span class=
"org-type">Element</span>, <span class=
"org-variable-name">value</span>: <span class=
"org-typescript-primitive">string</span> | <span class=
"org-constant">null</span>, <span class=
"org-variable-name">isSVG</span>: <span class=
"org-typescript-primitive">boolean</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">directly setting className should be faster than setAttribute in theory</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">if this is an element during a transition, take the temporary transition</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">classes into account.</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">transitionClasses</span> = <span class=
"org-rainbow-delimiters-depth-2">(</span>el <span class=
"org-keyword">as</span> ElementWithTransition<span class=
"org-rainbow-delimiters-depth-2">)</span>._vtc
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>transitionClasses<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    value = <span class=
"org-rainbow-delimiters-depth-3">(</span>value
      ? <span class=
"org-rainbow-delimiters-depth-4">[</span>value, ...transitionClasses<span class="org-rainbow-delimiters-depth-4">]</span>
      : <span class=
"org-rainbow-delimiters-depth-4">[</span>...transitionClasses<span class="org-rainbow-delimiters-depth-4">]</span>
    <span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">join</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">' '</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>value == <span class=
"org-constant">null</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    el.<span class=
"org-function-name">removeAttribute</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'class'</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class=
"org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span>isSVG<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    el.<span class=
"org-function-name">setAttribute</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'class'</span>, value<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class=
"org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    el.className = value
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
          <p>而这里面直接就是 <code>setAttribute('class', value)</code> 或
          <code>el.className = value</code> 这就等于 是说一开始的 <code>ret =
          { class: { btn: true }, disable: true }</code> 中的
          <code>class: { btn: true }</code> 到这里 <code>value = {
          btn: true }</code> 最终被自动转成了 <code>[obect
          Object]</code></p>
          <p>那么解决办法就是在 runtime-core 的 normalize 阶段就将 class
          值对象处理成字符串， 如 <a href=
          "https://github.com/vuejs/vue-next/commit/2bdee50a598456392541a8a4b451501e5df2d363">
          commit</a> 所示。</p>
          <div class="org-src-container">
            <pre class="src src-diff"><span class=
            "org-diff-context">packages/runtime-core/src/vnode.ts</span>
<span class=
"org-diff-hunk-header">@@ -778,8 +778,8 @@</span><span class=
"org-diff-function"> export function normalizeChildren(vnode: VNode, children: unknown) {</span>
<span class="org-diff-context">}</span>

<span class=
"org-diff-context">export function mergeProps(...args: (Data & VNodeProps)[]) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  const ret = extend({}, args[0])</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  for (let i = 1; i &lt; args.length; i++) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  const ret: Data = {}</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  for (let i = 0; i &lt; args.length; i++) {</span>
<span class="org-diff-context">    const toMerge = args[i]</span>
<span class=
"org-diff-context">    for (const key in toMerge) {</span>
      if (key === 'class') {
</pre>
          </div>
          <p>不用 extend 将第一个 prop 放入基准对象，都直接进入 for 被处理掉。</p>
          <p>这个时候第一个 <code>{class: { btn: true } }</code> 会进入
          <code>normalizeClass([ret.class,
          toMerge.class])</code></p>
          <p><a href=
          "https://github.com/vuejs/vue-next/tree/master/packages/shared/src/normalizeProp.ts">
          shared/src/normalizeProp.ts:normalizeClass(value:
          unknown)</a></p>
          <p>此时检测到 class 是个对象最后被处理成 <code>"btn"</code> 字符串</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "org-keyword">export</span> <span class=
            "org-keyword">function</span> <span class=
            "org-function-name">normalizeClass</span><span class=
            "org-rainbow-delimiters-depth-1">(</span><span class=
            "org-variable-name">value</span>: <span class=
            "org-typescript-primitive">unknown</span><span class=
            "org-rainbow-delimiters-depth-1">)</span>: <span class=
            "org-typescript-primitive">string</span> <span class=
            "org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">let</span> <span class=
"org-variable-name">res</span> = <span class="org-string">''</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-function-name">isString</span><span class=
"org-rainbow-delimiters-depth-3">(</span>value<span class=
"org-rainbow-delimiters-depth-3">)</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    res = value
  <span class=
"org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-function-name">isArray</span><span class="org-rainbow-delimiters-depth-3">(</span>value<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; <span class=
"org-type">value</span>.<span class=
"org-type">length</span>; <span class=
"org-type">i</span>++<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">const</span> <span class=
"org-variable-name">normalized</span> = <span class=
"org-function-name">normalizeClass</span><span class=
"org-rainbow-delimiters-depth-4">(</span>value<span class=
"org-rainbow-delimiters-depth-1">[</span>i<span class=
"org-rainbow-delimiters-depth-1">]</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>normalized<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        res += normalized + <span class="org-string">' '</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class=
"org-rainbow-delimiters-depth-2">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-2">(</span><span class="org-function-name">isObject</span><span class="org-rainbow-delimiters-depth-3">(</span>value<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> <span class=
"org-keyword">in</span> value<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>value<span class=
"org-rainbow-delimiters-depth-1">[</span>name<span class=
"org-rainbow-delimiters-depth-1">]</span><span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        res += name + <span class="org-string">' '</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">return</span> res.<span class=
"org-function-name">trim</span><span class=
"org-rainbow-delimiters-depth-2">()</span>
<span class="org-rainbow-delimiters-depth-1">}</span>


</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org1e08537" class="outline-3">
        <h3 id="org1e08537"><span class=
        "section-number-3">1.3.</span> <span class=
        "todo TODO">TODO</span> EffectScope ?</h3>
      </div>
      <div id="outline-container-deferredComputed" class=
      "outline-3">
        <h3 id="deferredComputed"><span class=
        "section-number-3">1.4.</span> deferredComputed</h3>
        <div class="outline-text-3" id="text-deferredComputed">
          <div class="warn" id="orgf8344a9">
            <p></p>
            <p><strong>WARNING</strong></p>
            <p></p>
            <p>没有被暴露的 api ，只限 vue 内部 @vue/reactivity 使用。</p>
          </div>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../reactivity/dist/reactivity.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { reactive, effect, ref, deferredComputed } = value

;(<span class="org-keyword">async</span> <span class=
"org-keyword">function</span> () {
<span class="org-keyword">const</span> <span class=
"org-variable-name">tick</span> = Promise.resolve()
<span class="org-keyword">const</span> <span class=
"org-variable-name">src</span> = ref(<span class=
"org-highlight-numbers-number">0</span>)
<span class="org-keyword">const</span> <span class=
"org-variable-name">c</span> = deferredComputed(() =&gt; src.value)
<span class="org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">spy</span> = (val) =&gt; {
console.log(<span class=
"org-string">"i = "</span> + i++ + <span class=
"org-string">', val = '</span> + val)
}
effect(() =&gt; spy(c.value))

src.value = <span class="org-highlight-numbers-number">1</span>
src.value = <span class="org-highlight-numbers-number">2</span>
src.value = <span class="org-highlight-numbers-number">3</span>

console.log(<span class="org-string">'1: i = '</span> + i)
<span class="org-keyword">await</span> tick <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to flush jobs</span>
console.log(<span class="org-string">'2: i = '</span> + i)
}())

<span class="org-keyword">return</span> <span class=
"org-string">''</span>
</pre>
          </div>
          <p>看个正常 computed 的例子:</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../reactivity/dist/reactivity.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { reactive, effect, ref, computed } = value

;(<span class="org-keyword">async</span> <span class=
"org-keyword">function</span> () {
<span class="org-keyword">const</span> <span class=
"org-variable-name">tick</span> = Promise.resolve()
<span class="org-keyword">const</span> <span class=
"org-variable-name">src</span> = ref(<span class=
"org-highlight-numbers-number">0</span>)
<span class="org-keyword">const</span> <span class=
"org-variable-name">c</span> = computed(() =&gt; src.value)
<span class="org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">spy</span> = (val) =&gt; {
console.log(<span class=
"org-string">"i = "</span> + i++ + <span class=
"org-string">', val = '</span> + val)
}
effect(() =&gt; spy(c.value))

src.value = <span class="org-highlight-numbers-number">1</span>
src.value = <span class="org-highlight-numbers-number">2</span>
src.value = <span class="org-highlight-numbers-number">3</span>

console.log(<span class="org-string">'1: i = '</span> + i)
<span class="org-keyword">await</span> tick <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to flush jobs</span>
console.log(<span class="org-string">': i = '</span> + i)
}())

<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">2</span>
</pre>
          </div>
          <p>对比两个结果会发现：</p>
          <p>正常的 computed 在 <code>src.value</code> 改变时每次都会执行 spy,
          这是因为 <code>computed(() =&gt; src.value)</code> 操作让 src
          track 了这个 <code>() =&gt; src.value</code> 因此只要值发生改变就会立即
          执行它，而对于计算属性 c 又依赖了 src.value 因此触发 c 重新计算，从而调用 spy。</p>
          <p>而在 deferredComputed 的实现中将 effect 加入到了 scheduler
          异步队列中去执行，导 致同步的代码没有执行结束之前是不会执行的，只要不重新计算 c.value 就不会改变。那 么
          effect spy 也就不会被执行，从而导致 spy 不会在 src.value 改变时被立即调用。</p>
          <p>但是在后面调用了 <code>await nextTick()</code> 之后会立即将
          scheduler 的队列 flush 掉，此时才 会去执行 compute 重新计算 c.value
          的值，得到的也就是最后一次 src.value 的值(<b>要 清楚一点 await 之前 src.value
          是会发生改变的，只是不会触发重新计算</b>)，然后 c.value 的改变会触发 <code>effect(()
          =&gt; spy(c.value))</code> 去执行。</p>
          <p>关于 scheduler 和 nextTick 可阅读这两文：</p>
          <p><a href="file:///vue/vue-teardown-2-sheduler/">Vue3
          功能拆解② Scheduler 渲染机制</a></p>
          <p><a href=
          "http://localhost:1313/vue/vue-mind-map-runtime-core-1/#scheduler">
          Vue3 源码头脑风暴之 7 ☞ runtime-core(1) - 若叶知秋 - scheduler
          任务调度机制</a></p>
          <p>deferredComputed 源码如下：</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "org-comment-delimiter">// </span><span class=
            "org-comment">只会将 effect 加入 job 队列，不会立即执行</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">scheduler</span> = <span class=
"org-rainbow-delimiters-depth-1">(</span>fn: <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  queue.<span class="org-function-name">push</span><span class=
"org-rainbow-delimiters-depth-2">(</span>fn<span class=
"org-rainbow-delimiters-depth-2">)</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>!queued<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    queued = <span class="org-constant">true</span>
    tick.<span class="org-function-name">then</span><span class=
"org-rainbow-delimiters-depth-3">(</span>flush<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">class</span> <span class=
"org-type">DeferredComputedRefImpl</span>&lt;<span class=
"org-type">T</span>&gt; <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">constructor</span><span class=
"org-rainbow-delimiters-depth-2">(</span>getter: <span class=
"org-type">ComputedGetter</span>&lt;<span class=
"org-type">T</span>&gt;<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">let</span> <span class=
"org-variable-name">compareTarget</span>: <span class=
"org-typescript-primitive">any</span>
    <span class="org-keyword">let</span> <span class=
"org-variable-name">hasCompareTarget</span> = <span class=
"org-constant">false</span>
    <span class="org-keyword">let</span> <span class=
"org-variable-name">scheduled</span> = <span class=
"org-constant">false</span>
    <span class=
"org-typescript-this">this</span>.effect = <span class=
"org-keyword">new</span> <span class=
"org-type">ReactiveEffect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>getter, <span class=
"org-rainbow-delimiters-depth-4">(</span>computedTrigger?: <span class="org-typescript-primitive">boolean</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-4">{</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-typescript-this">this</span>.dep<span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>computedTrigger<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
          compareTarget = <span class=
"org-typescript-this">this</span>._value
          hasCompareTarget = <span class="org-constant">true</span>
        <span class=
"org-rainbow-delimiters-depth-2">}</span> <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>!scheduled<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
          <span class="org-keyword">const</span> <span class=
"org-variable-name">valueToCompare</span> = hasCompareTarget ? compareTarget : <span class="org-typescript-this">this</span>._value
          scheduled = <span class="org-constant">true</span>
          hasCompareTarget = <span class=
"org-constant">false</span>
          <span class=
"org-function-name">scheduler</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
            <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-typescript-this">this</span>.effect.active &amp;& <span class=
"org-typescript-this">this</span>.<span class=
"org-function-name">_get</span><span class=
"org-rainbow-delimiters-depth-2">()</span> !== valueToCompare<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
              <span class=
"org-function-name">triggerRefValue</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
            <span class="org-rainbow-delimiters-depth-1">}</span>
            scheduled = <span class="org-constant">false</span>
          <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">chained upstream computeds are notified synchronously to ensure</span>
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">value invalidation in case of sync access; normal effects are</span>
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">deferred to be triggered in scheduler.</span>
        <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">e</span> <span class=
"org-keyword">of</span> <span class=
"org-typescript-this">this</span>.dep<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
          <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>e.computed<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
            e.scheduler!<span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">computedTrigger */</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
          <span class="org-rainbow-delimiters-depth-3">}</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>
      <span class="org-rainbow-delimiters-depth-1">}</span>
      <span class=
"org-typescript-this">this</span>._dirty = <span class=
"org-constant">true</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class=
"org-typescript-this">this</span>.effect.computed = <span class=
"org-constant">true</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class=
"org-typescript-access-modifier">private</span> <span class=
"org-function-name">_get</span><span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-typescript-this">this</span>._dirty<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class=
"org-typescript-this">this</span>._dirty = <span class=
"org-constant">false</span>
      <span class="org-keyword">return</span> <span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-typescript-this">this</span>._value = <span class=
"org-typescript-this">this</span>.effect.<span class=
"org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-1">()</span>!<span class=
"org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">return</span> <span class=
"org-typescript-this">this</span>._value
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">get</span> <span class=
"org-function-name">value</span><span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class=
"org-function-name">trackRefValue</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">this</span><span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">the computed ref may get wrapped by other proxies e.g. readonly() #3376</span>
    <span class="org-keyword">return</span> <span class=
"org-function-name">toRaw</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">_get</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
          <p>而对于 computed 就没那么多操作</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "org-keyword">class</span> <span class=
            "org-type">ComputedRefImpl</span>&lt;<span class=
            "org-type">T</span>&gt; <span class=
            "org-rainbow-delimiters-depth-1">{</span>
  <span class=
"org-typescript-access-modifier">public</span> dep?: <span class=
"org-type">Dep</span> = <span class="org-constant">undefined</span>

  <span class=
"org-typescript-access-modifier">private</span> _value!: T
  <span class=
"org-typescript-access-modifier">private</span> _dirty = <span class="org-constant">true</span>
  <span class=
"org-typescript-access-modifier">public</span> <span class=
"org-typescript-access-modifier">readonly</span> effect: <span class="org-type">ReactiveEffect</span>&lt;<span class="org-type">T</span>&gt;

  <span class=
"org-typescript-access-modifier">public</span> <span class=
"org-typescript-access-modifier">readonly</span> __v_isRef = <span class="org-constant">true</span>
  <span class=
"org-typescript-access-modifier">public</span> <span class=
"org-typescript-access-modifier">readonly</span> <span class=
"org-rainbow-delimiters-depth-2">[</span>ReactiveFlags.IS_READONLY<span class="org-rainbow-delimiters-depth-2">]</span>: <span class="org-typescript-primitive">boolean</span>

  <span class="org-keyword">constructor</span><span class=
"org-rainbow-delimiters-depth-2">(</span>
    getter: <span class=
"org-type">ComputedGetter</span>&lt;<span class=
"org-type">T</span>&gt;,
    <span class=
"org-typescript-access-modifier">private</span> <span class=
"org-typescript-access-modifier">readonly</span> _setter: <span class="org-type">ComputedSetter</span>&lt;<span class="org-type">T</span>&gt;,
    isReadonly: <span class=
"org-typescript-primitive">boolean</span>
  <span class=
"org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>

    <span class=
"org-typescript-this">this</span>.effect = <span class=
"org-keyword">new</span> <span class=
"org-type">ReactiveEffect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>getter, <span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-4">{</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">scheduler</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>!<span class=
"org-typescript-this">this</span>._dirty<span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
        <span class=
"org-typescript-this">this</span>._dirty = <span class=
"org-constant">true</span>
        <span class=
"org-function-name">triggerRefValue</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-1">}</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class="org-constant">this</span><span class=
"org-rainbow-delimiters-depth-3">[</span>ReactiveFlags.IS_READONLY<span class="org-rainbow-delimiters-depth-3">]</span> = isReadonly
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">get</span> <span class=
"org-function-name">value</span><span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">the computed ref may get wrapped by other proxies e.g. readonly() #3376</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">self</span> = <span class=
"org-function-name">toRaw</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class=
"org-function-name">trackRefValue</span><span class="org-rainbow-delimiters-depth-3">(</span>self<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>self._dirty<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      self._dirty = <span class="org-constant">false</span>
      self._value = self.effect.<span class=
"org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-4">()</span>!
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">return</span> self._value
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">set</span> <span class=
"org-function-name">value</span><span class=
"org-rainbow-delimiters-depth-2">(</span>newValue: T<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>.<span class=
"org-function-name">_setter</span><span class=
"org-rainbow-delimiters-depth-3">(</span>newValue<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-ReactiveEffect2Class" class=
      "outline-3">
        <h3 id="ReactiveEffect2Class"><span class=
        "section-number-3">1.5.</span> ReactiveEffect 从函数变成了一个
        class</h3>
        <div class="outline-text-3" id="text-ReactiveEffect2Class">
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "org-keyword">export</span> <span class=
            "org-keyword">class</span> <span class=
            "org-type">ReactiveEffect</span>&lt;<span class=
            "org-type">T</span> = <span class=
            "org-typescript-primitive">any</span>&gt; <span class=
            "org-rainbow-delimiters-depth-1">{</span>
  active = <span class="org-constant">true</span>
  deps: <span class="org-type">Dep</span><span class=
"org-rainbow-delimiters-depth-2">[]</span> = <span class=
"org-rainbow-delimiters-depth-2">[]</span>

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">can be attached after creation</span>
  computed?: <span class="org-typescript-primitive">boolean</span>
  allowRecurse?: <span class=
"org-typescript-primitive">boolean</span>
  onStop?: <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-typescript-primitive">void</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">dev only</span>
  onTrack?: <span class=
"org-rainbow-delimiters-depth-2">(</span>event: <span class=
"org-type">DebuggerEvent</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-typescript-primitive">void</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">dev only</span>
  onTrigger?: <span class=
"org-rainbow-delimiters-depth-2">(</span>event: <span class=
"org-type">DebuggerEvent</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-typescript-primitive">void</span>

  <span class="org-keyword">constructor</span><span class=
"org-rainbow-delimiters-depth-2">(</span>
    <span class=
"org-typescript-access-modifier">public</span> fn: <span class=
"org-rainbow-delimiters-depth-3">()</span> <span class=
"org-keyword">=&gt;</span> T,
    <span class=
"org-typescript-access-modifier">public</span> scheduler: <span class="org-type">EffectScheduler</span> | <span class="org-constant">null</span> = <span class="org-constant">null</span>,
    scope?: <span class=
"org-type">EffectScope</span> | <span class="org-constant">null</span>
  <span class=
"org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class=
"org-function-name">recordEffectScope</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-constant">this</span>, scope<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>!<span class=
"org-typescript-this">this</span>.active<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">return</span> <span class=
"org-typescript-this">this</span>.<span class=
"org-function-name">fn</span><span class=
"org-rainbow-delimiters-depth-4">()</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>!effectStack.<span class=
"org-function-name">includes</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-4">)</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">try</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        effectStack.<span class=
"org-function-name">push</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-rainbow-delimiters-depth-2">(</span>activeEffect = <span class="org-constant">this</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class=
"org-function-name">enableTracking</span><span class=
"org-rainbow-delimiters-depth-1">()</span>

        trackOpBit = <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; ++effectTrackDepth

        <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>effectTrackDepth &lt;= maxMarkerBits<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
          <span class=
"org-function-name">initDepMarkers</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class=
"org-rainbow-delimiters-depth-1">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
          <span class=
"org-function-name">cleanupEffect</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-1">}</span>
        <span class="org-keyword">return</span> <span class=
"org-typescript-this">this</span>.<span class=
"org-function-name">fn</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">finally</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>effectTrackDepth &lt;= maxMarkerBits<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
          <span class=
"org-function-name">finalizeDepMarkers</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-1">}</span>

        trackOpBit = <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; --effectTrackDepth

        <span class=
"org-function-name">resetTracking</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
        effectStack.<span class=
"org-function-name">pop</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
        <span class="org-keyword">const</span> <span class=
"org-variable-name">n</span> = effectStack.length
        activeEffect = n &gt; <span class=
"org-highlight-numbers-number">0</span> ? effectStack<span class=
"org-rainbow-delimiters-depth-1">[</span>n - <span class=
"org-highlight-numbers-number">1</span><span class=
"org-rainbow-delimiters-depth-1">]</span> : <span class=
"org-constant">undefined</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">stop</span><span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-typescript-this">this</span>.active<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class=
"org-function-name">cleanupEffect</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-typescript-this">this</span>.onStop<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        <span class="org-typescript-this">this</span>.<span class=
"org-function-name">onStop</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
      <span class=
"org-typescript-this">this</span>.active = <span class=
"org-constant">false</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
          <p>依赖收集的时候：</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "org-keyword">export</span> <span class=
            "org-keyword">function</span> <span class=
            "org-function-name">effect</span>&lt;<span class=
            "org-type">T</span> = <span class=
            "org-typescript-primitive">any</span>&gt;<span class=
            "org-rainbow-delimiters-depth-1">(</span>
  fn: <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> T,
  options?: <span class="org-type">ReactiveEffectOptions</span>
<span class="org-rainbow-delimiters-depth-1">)</span>: <span class=
"org-type">ReactiveEffectRunner</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">(</span>fn <span class=
"org-keyword">as</span> ReactiveEffectRunner<span class=
"org-rainbow-delimiters-depth-3">)</span>.effect<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    fn = <span class=
"org-rainbow-delimiters-depth-3">(</span>fn <span class=
"org-keyword">as</span> ReactiveEffectRunner<span class=
"org-rainbow-delimiters-depth-3">)</span>.effect.fn
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">1. new instance</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">_effect</span> = <span class=
"org-keyword">new</span> <span class=
"org-type">ReactiveEffect</span><span class=
"org-rainbow-delimiters-depth-2">(</span>fn<span class=
"org-rainbow-delimiters-depth-2">)</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>options<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-function-name">extend</span><span class=
"org-rainbow-delimiters-depth-3">(</span>_effect, options<span class="org-rainbow-delimiters-depth-3">)</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>options.scope<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-function-name">recordEffectScope</span><span class=
"org-rainbow-delimiters-depth-3">(</span>_effect, options.scope<span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>!options || !options.lazy<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">2. run</span>
    _effect.<span class="org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">runner</span> = _effect.run.<span class=
"org-function-name">bind</span><span class=
"org-rainbow-delimiters-depth-2">(</span>_effect<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">as</span> ReactiveEffectRunner
  runner.effect = _effect
  <span class="org-keyword">return</span> runner
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-new-ref-sugar" class="outline-3">
        <h3 id="new-ref-sugar"><span class=
        "section-number-3">1.6.</span> 新增 ref 语法糖（$ref, $raw）</h3>
        <div class="outline-text-3" id="text-new-ref-sugar">
          <p>新增 ref 语法糖：</p>
          <ol class="org-ol">
            <li>
              <p><code>$ref()</code> 被解析成 <code>_ref()</code></p>
              <p>如： <code>let foo = $ref(1)</code> =&gt; <code>let
              foo = _ref(1)</code></p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> =
      process.env.VNEXT_PKG_RC + <span class=
"org-string">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;

<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">"stb-"</span>, <span class="org-string">""</span>));
<span class=
"org-keyword">const</span> { compileScript, parse } = value;

<span class="org-keyword">function</span> <span class=
"org-function-name">compileSFCScript</span>(<span class=
"org-variable-name">src</span>, <span class=
"org-variable-name">options</span>) {
  <span class=
"org-keyword">const</span> { descriptor } = parse(src)
  <span class=
"org-keyword">return</span> compileScript(descriptor, {
    ...options,
    id: <span class="org-string">'xxxxxxx'</span>
  })
}

<span class="org-keyword">function</span> <span class=
"org-function-name">compileWithRefSugar</span>(<span class=
"org-variable-name">src</span>) {
  <span class=
"org-keyword">return</span> compileSFCScript(src, { refSugar: <span class="org-constant">true</span> })
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">_</span> = (title, src) =&gt; {
  <span class=
"org-keyword">const</span> { content } = compileWithRefSugar(src)
  console.log(title, <span class="org-string">'\n'</span>, content)
}

_(<span class=
"org-string">'$ref declarations &gt; '</span>, <span class=
"org-string">`&lt;script setup&gt;</span>
<span class="org-string">    let foo = $ref()</span>
<span class="org-string">    let a = $ref(1)</span>
<span class="org-string">    let b = $ref({</span>
<span class="org-string">      count: 0</span>
<span class="org-string">    })</span>
<span class="org-string">    let c = () =&gt; {}</span>
<span class="org-string">    let d</span>
<span class="org-string">    &lt;/script&gt;`</span>)

<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>;

</pre>
              </div>
            </li>
          </ol>
        </div>
      </div>
    </div>
    <div id="outline-container-orgbf1fd6c" class="outline-2">
      <h2 id="orgbf1fd6c"><span class="section-number-2">2.</span>
      3.2.23~29</h2>
      <div class="outline-text-2" id="text-2"></div>
      <div id="outline-container-org0d8594f" class="outline-3">
        <h3 id="org0d8594f"><span class=
        "section-number-3">2.1.</span> Bug Fixes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-2-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: handle initial undefined attrs
              (<a href=
              "https://github.com/vuejs/core/issues/5017">#5017</a>)
              (<a href=
              "https://github.com/vuejs/core/commit/6d887aaf591cfa05d5fea978bbd87e3e502bfa86">6d887aa</a>),
              closes <a href=
              "https://github.com/vuejs/core/issues/5016">#5016</a></p>
              <p>值为 <code>undefined</code> 的 attrs 在值发生变化时会被解析到
              props 中去。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-core/src/componentProps.ts</span>
<span class=
"org-diff-hunk-header">@@ -369,7 +369,7 @@</span><span class=
"org-diff-function"> function setFullProps(</span>
<span class="org-diff-context">            continue</span>
<span class="org-diff-context">          }</span>
<span class="org-diff-context">        }</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">        if (value !== attrs[key]) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        if (</span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">!(key in attrs) ||</span></span><span class="org-diff-added"> value !== attrs[key]) {</span>
<span class="org-diff-context">          attrs[key] = value</span>
<span class=
"org-diff-context">          hasAttrsChanged = true</span>
        }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgcf1f1fd" class="outline-3">
        <h3 id="orgcf1f1fd"><span class=
        "section-number-3">2.2.</span> Features
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-2-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: support default value in toRef()
              (<a href=
              "https://github.com/vuejs/core/commit/2db9c909c2cf3845f57b2c930c05cd6c17abe3b0">2db9c90</a>)</p>
              <p>支持设置默认值： <code>toRef(obj, 'x', 1)</code></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/reactivity/src/ref.ts</span>

<span class=
"org-diff-context">class ObjectRefImpl&lt;T extends object, K extends keyof T&gt; {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  constructor(private readonly _object: T, private readonly _key: K) {}</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  constructor(</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    private readonly _object: T,</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    private readonly _key: K,</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    private readonly _defaultValue?: T[K]</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  ) {}</span>

<span class="org-diff-context">  get value() {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    return this._object[this._key]</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    const val = this._object[this._key]</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    return val === undefined ? (this._defaultValue as T[K]) : val</span>
  }
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code> support ref in v-for, remove compat
              deprecation warnings (<a href=
              "https://github.com/vuejs/core/commit/41c18effea9dd32ab899b5de3bb0513abdb52ee4">41c18ef</a>)
            </li>
            <li class="on">
              <code>[X]</code>
              <p>types/script-setup: add generic type to
              defineExpose (<a href=
              "https://github.com/vuejs/core/issues/5035">#5035</a>)
              (<a href=
              "https://github.com/vuejs/core/commit/34985fee6b23018b6eb6322239db6165c1b0e273">34985fe</a>)
              OLD:</p>
              <div class="org-src-container">
                <pre class="src src-html">&lt;<span class=
                "org-function-name">script</span> setup <span class=
                "org-variable-name">lang</span>=<span class=
                "org-string">"ts"</span>&gt;
    import type { IMyComponent } from './MyComponent';

    const publicAPI: IMyComponent = {
        doSomething() {
            // ...
        },
    };

    defineExpose(publicAPI);
&lt;/<span class="org-function-name">script</span>&gt;
</pre>
              </div>
              <p>NEW:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-function-name">defineExpose</span>&lt;<span class=
                "org-type">IMyComponent</span>&gt;<span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-rainbow-delimiters-depth-2">{</span>
    <span class="org-function-name">doSomething</span><span class=
"org-rainbow-delimiters-depth-3">()</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>,
<span class="org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>;

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org69b0cf2" class="outline-2">
      <h2 id="org69b0cf2"><span class="section-number-2">3.</span>
      <span class="done DONE">DONE</span> 3.2.14~22 (2021-09-22 ~
      2021-11-15)</h2>
      <div class="outline-text-2" id="text-3">
        <p>这段时间的更新还是以修复 bug 为主的，另外更新了一个主要的特性
        <code>defineProps</code> 支持解 构。</p>
      </div>
      <div id="outline-container-org11cacda" class="outline-3">
        <h3 id="org11cacda"><span class=
        "section-number-3">3.1.</span> Bug Fixes
        <code>[10/10]</code></h3>
        <div class="outline-text-3" id="text-3-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: fix local var access check for
              bindings in normal script (<a href=
              "https://github.com/vuejs/vue-next/commit/6d6cc9091280ba132d92850f30db31c9152af599">6d6cc90</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4644">#4644</a></p>
              <p>解决 <code>script</code> 和 <code>script setup</code>
              一起用的时候找不到变量问题。</p>
              <div class="org-src-container">
                <pre class="src src-js"> expect(() =&gt;
    compile(<span class="org-string">`</span>
<span class=
"org-string">        &lt;script&gt;const bar = 1&lt;/script&gt;</span>
<span class="org-string">        &lt;script setup&gt;</span>
<span class="org-string">        defineProps({</span>
<span class="org-string">          foo: {</span>
<span class="org-string">            default: () =&gt; bar</span>
<span class="org-string">          }</span>
<span class="org-string">        })</span>
<span class="org-string">        &lt;/script&gt;`</span>)
).not.toThrow(<span class=
"org-string">`cannot reference locally declared variables`</span>)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-core: should treat attribute key as
              expression (<a href=
              "https://github.com/vuejs/vue-next/issues/4658">#4658</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/7aa0ea06c822d84a1d43b40cf5643b983aae6d36">7aa0ea0</a>)</p>
              <p><code>&lt;template v-for="a in b"
              key="c"/&gt;</code> 中的 <code>c</code> 被解析成了变量
              <code>_ctx.c</code> 问题。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: fix props codegen w/ leading import
              (<a href=
              "https://github.com/vuejs/vue-next/commit/d4c04e979934b81a30467aa4b1e717175b9b2d80">d4c04e9</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4764">#4764</a></p>
              <div class="org-src-container">
                <pre class=
                "src src-js">&lt;script setup&gt;<span class=
                "org-keyword">import</span> { ref } from <span class=
                "org-string">'vue'</span> <span class=
                "org-comment-delimiter">// </span><span class=
                "org-comment">this line will cause an error</span>
 <span class="org-keyword">const</span> <span class=
"org-variable-name">props</span>=defineProps({
   foo:String
 })

<span class="org-keyword">const</span> <span class=
"org-variable-name">msg</span> = ref(<span class=
"org-string">'Hello World!'</span>)
&lt;/script&gt;

&lt;template&gt;
  &lt;h1&gt;{{ msg }}&lt;/h1&gt;
  &lt;input v-model=<span class="org-string">"msg"</span>&gt;
&lt;/template&gt;
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support runtime Enum in normal
              script (<a href=
              "https://github.com/vuejs/vue-next/issues/4698">#4698</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/f66d456b7a39db9dae7e70c28bb431ff293d8fef">f66d456</a>)</p>
              <div class="org-src-container">
                <pre class="src src-typescript">   <span class=
                "org-function-name">test</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-string">'runtime Enum in normal script'</span>, <span class=
                "org-rainbow-delimiters-depth-2">()</span> <span class=
                "org-keyword">=&gt;</span> <span class=
                "org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">const</span> <span class=
"org-rainbow-delimiters-depth-3">{</span> content, bindings <span class="org-rainbow-delimiters-depth-3">}</span> = <span class="org-function-name">compile</span><span class="org-rainbow-delimiters-depth-3">(</span>
        <span class="org-string">`&lt;script lang="ts"&gt;</span>
<span class="org-string">          export enum D { D = "D" }</span>
<span class="org-string">          const enum C { C = "C" }</span>
<span class="org-string">          enum B { B = "B" }</span>
<span class="org-string">        &lt;/script&gt;</span>
<span class=
"org-string">        &lt;script setup lang="ts"&gt;</span>
<span class="org-string">        enum Foo { A = 123 }</span>
<span class="org-string">        &lt;/script&gt;`</span>
      <span class="org-rainbow-delimiters-depth-3">)</span>
      <span class="org-function-name">assertCode</span><span class=
"org-rainbow-delimiters-depth-3">(</span>content<span class=
"org-rainbow-delimiters-depth-3">)</span>
      <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>bindings<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">toStrictEqual</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">{</span>
        D: <span class="org-type">BindingTypes.SETUP</span>_CONST,
        C: <span class="org-type">BindingTypes.SETUP</span>_CONST,
        B: <span class="org-type">BindingTypes.SETUP</span>_CONST,
        Foo: <span class="org-type">BindingTypes.SETUP</span>_CONST
      <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class=
"org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>custom-element: fix custom element props access on
              initial render (<a href=
              "https://github.com/vuejs/vue-next/commit/4b7f76e36a7fc650986a20eca258f7a5d912424f">4b7f76e</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4792">#4792</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/runtime-dom/src/apiCustomElement.ts</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      asyncDef().then(resolve)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      asyncDef()</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        .then(resolve)</span>
+        .then(() =&gt; this._update())
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>custom-element: fix initial attr type casting for
              programmtically created elements (<a href=
              "https://github.com/vuejs/vue-next/commit/3ca83179d1a798f65e4e70215c511e2f1b64adb6">3ca8317</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4772">#4772</a></p>
              <p><a href=
              "https://codesandbox.io/s/musing-gates-n5wsn?file=/src/main.js">
              codesandbox.io</a></p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: add v-memo to built-in directives
              check (<a href=
              "https://github.com/vuejs/vue-next/issues/4787">#4787</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/5eb72630a53a8dd82c2b8a9705c21a8075161a3d">5eb7263</a>)</p>
              <p>将 <code>memo</code> 视为 vue 内置指令：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">const isBuiltInDirective = /*#__PURE__*/ makeMap(</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  'bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text'</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  'bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text,memo'</span>
)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: add type for props include Function
              in prod mode (<a href=
              "https://github.com/vuejs/vue-next/issues/4938">#4938</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/9c42a1e2a3385f3b33faed5cdcc430bf8c1fc4b2">9c42a1e</a>)</p>
              <div class="org-src-container">
                <pre class="src src-html">&lt;<span class=
                "org-function-name">script</span> setup <span class=
                "org-variable-name">lang</span>=<span class=
                "org-string">'ts'</span>&gt;

import { onMounted } from 'vue'

var props = withDefaults(defineProps&lt;{f?: Function}&gt;(),{f:()=&gt;[1,2,3]})

onMounted(()=&gt;{
  console.log("f:",props.f)
})

&lt;/<span class="org-function-name">script</span>&gt;
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: externalRE support automatic
              http/https prefix url pattern (<a href=
              "https://github.com/vuejs/vue-next/issues/4922">#4922</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/574070f43f804fd855f4ee319936ec770a56cef0">574070f</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4920">#4920</a></p>
              <div class="org-src-container">
                <pre class="src src-html">&lt;<span class=
                "org-function-name">template</span>&gt;
  <span class="org-comment-delimiter">&lt;!-- </span><span class=
"org-comment">other stuff</span><span class=
"org-comment-delimiter"> --&gt;</span>
  &lt;<span class="org-function-name">img</span> <span class=
"org-variable-name">src</span>=<span class=
"org-string">"//via.placeholder.com/150"</span> /&gt;
  <span class="org-comment-delimiter">&lt;!-- </span><span class=
"org-comment">other stuff</span><span class=
"org-comment-delimiter"> --&gt;</span>
&lt;/<span class="org-function-name">template</span>&gt;
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: improve dedupe listeners when attr
              fallthrough (<a href=
              "https://github.com/vuejs/vue-next/issues/4912">#4912</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/b4eb7e3866d7dc722d93a48f4faae1696d4e7023">b4eb7e3</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4859">#4859</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-core/src/vnode.ts</span>
<span class=
"org-diff-hunk-header">@@ -791,7 +791,10 @@</span><span class=
"org-diff-function"> export function mergeProps(...args: (Data & VNodeProps)[]) {</span>
<span class="org-diff-context">      } else if (isOn(key)) {</span>
<span class=
"org-diff-context">        const existing = ret[key]</span>
<span class=
"org-diff-context">        const incoming = toMerge[key]</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">        if (existing !== incoming) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        if (</span>
<span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added">          existing !== incoming </span><span class="org-diff-added"><span class="org-diff-refine-added">&amp;&</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">          !(isArray(existing) &amp;& existing.includes(incoming))</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added">        ) {</span>
<span class="org-diff-context">          ret[key] = existing</span>
<span class=
"org-diff-context">            ? [].concat(existing as any, incoming as any)</span>
<span class="org-diff-context">            : incoming</span>

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org8235684" class="outline-3">
        <h3 id="org8235684"><span class=
        "section-number-3">3.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-3-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>[3.2.20]compiler-sfc: &lt;script setup&gt;
              defineProps destructure transform (<a href=
              "https://github.com/vuejs/vue-next/issues/4690">#4690</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/467e113b95a3c9c97f8dc309b61c0b2e3caba66f">467e113</a>)
              <span id="defineProps-destructure"></span></p>
              <p><code>defineProps</code> 支持解构操作。</p>
              <p><code>&lt;script setup&gt;const { foo, bar } =
              defineProps(['foo', 'bar'])&lt;/script&gt;</code></p>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgf1a6c64" class="outline-2">
      <h2 id="orgf1a6c64"><span class="section-number-2">4.</span>
      3.2.13</h2>
      <div class="outline-text-2" id="text-4"></div>
      <div id="outline-container-org0bc3a11" class="outline-3">
        <h3 id="org0bc3a11"><span class=
        "section-number-3">4.1.</span> Bug Fixes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-4-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: return the exposeProxy from mount
              (<a href=
              "https://github.com/vuejs/vue-next/issues/4606">#4606</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/5aa425580808d0588aef12ead81c91f7147e1042">5aa4255</a>)
              <span id="expose-proxy"></span></p>
              <p>问题：在 createApp().mount 返回的 vm 上找不到 vm.foo</p>
              <p>FIX:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">getExposeProxy</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-variable-name">instance</span>: <span class=
                "org-type">ComponentInternalInstance</span><span class=
                "org-rainbow-delimiters-depth-1">)</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>instance.exposed<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>
      instance.exposeProxy ||
      <span class=
"org-rainbow-delimiters-depth-4">(</span>instance.exposeProxy = <span class="org-keyword">new</span> <span class="org-type">Proxy</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-function-name">proxyRefs</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-function-name">markRaw</span><span class="org-rainbow-delimiters-depth-3">(</span>instance.exposed<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>, <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-keyword">get</span><span class=
"org-rainbow-delimiters-depth-3">(</span>target, key: <span class=
"org-typescript-primitive">string</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
          <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>key <span class=
"org-keyword">in</span> target<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
            <span class=
"org-keyword">return</span> target<span class=
"org-rainbow-delimiters-depth-1">[</span>key<span class=
"org-rainbow-delimiters-depth-1">]</span>
          <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>key <span class=
"org-keyword">in</span> publicPropertiesMap<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
            <span class=
"org-keyword">return</span> publicPropertiesMap<span class=
"org-rainbow-delimiters-depth-1">[</span>key<span class=
"org-rainbow-delimiters-depth-1">](</span>instance<span class=
"org-rainbow-delimiters-depth-1">)</span>
          <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>
      <span class=
"org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span class=
                "org-function-name">test</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-string">'with mount'</span>, <span class=
                "org-rainbow-delimiters-depth-2">()</span> <span class=
                "org-keyword">=&gt;</span> <span class=
                "org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">Component</span> = <span class=
"org-function-name">defineComponent</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">{</span>
      <span class="org-function-name">setup</span><span class=
"org-rainbow-delimiters-depth-1">(</span>_, <span class=
"org-rainbow-delimiters-depth-2">{</span> expose <span class=
"org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
        <span class="org-function-name">expose</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">{</span>
          foo: <span class="org-highlight-numbers-number">1</span>
        <span class=
"org-rainbow-delimiters-depth-3">}</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class="org-keyword">return</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
          bar: <span class="org-highlight-numbers-number">2</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>
      <span class="org-rainbow-delimiters-depth-1">}</span>,
      <span class="org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-1">()</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">return</span> <span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-string">'div'</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-1">}</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">root</span> = nodeOps.<span class=
"org-function-name">createElement</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'div'</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">vm</span> = <span class=
"org-function-name">createApp</span><span class=
"org-rainbow-delimiters-depth-3">(</span>Component<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">mount</span><span class=
"org-rainbow-delimiters-depth-3">(</span>root<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-keyword">as</span> <span class=
"org-typescript-primitive">any</span>
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>vm.foo<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">toBe</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-highlight-numbers-number">1</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>vm.bar<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">toBe</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-constant">undefined</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgb8e0016" class="outline-2">
      <h2 id="orgb8e0016"><span class="section-number-2">5.</span>
      3.2.12</h2>
      <div class="outline-text-2" id="text-5"></div>
      <div id="outline-container-org5adedce" class="outline-3">
        <h3 id="org5adedce"><span class=
        "section-number-3">5.1.</span> Bug Fixes
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-5-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support nested await statements
              (<a href=
              "https://github.com/vuejs/vue-next/issues/4458">#4458</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ae942cdcd9bd686e7b0394c8e91e63a31ff8fb5d">ae942cd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4448">#4448</a></p>
              <p><code>&lt;script&gt;await (await
              1)&lt;/script&gt;</code></p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-core: v-on inline async function
              expression handler (<a href=
              "https://github.com/vuejs/vue-next/issues/4569">#4569</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/fc968d607b181db9d50cd4b30a8d7e4cc5fe9d2b">fc968d6</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4568">#4568</a>
              <span id="von-async"></span></p>
              <p><code>&lt;div @click="async () =&gt; await foo()"
              /&gt;</code></p>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgd241808" class="outline-2">
      <h2 id="orgd241808"><span class="section-number-2">6.</span>
      3.2.4</h2>
      <div class="outline-text-2" id="text-6"></div>
      <div id="outline-container-org5d842fc" class="outline-3">
        <h3 id="org5d842fc"><span class=
        "section-number-3">6.1.</span> Bug Fixes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-6-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href="#slot-args">runtime-core:
              ensure consistent arguments for tempalte and render
              funtion slot usage</a> (644971e), closes #4367
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgaac4f5f" class="outline-2">
      <h2 id="orgaac4f5f"><span class="section-number-2">7.</span>
      3.2.0-beta.8</h2>
      <div class="outline-text-2" id="text-7">
        <ul class="org-ul">
          <li><b><span style="color:red;">FIX</span></b>
          <abbr class="tooltip" title=
          "&lt;strong&gt;3.2+&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any[]&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;Memoize a sub-tree of the template. Can be used on both elements and components.&lt;br&gt;The directive expects a fixed-length array of dependency values to compare for&lt;br&gt;the memoization. If every value in the array was the same as last render, then&lt;br&gt;updates for the entire sub-tree will be skipped. For example:&lt;br&gt;&lt;br&gt;&lt;div v-memo=''[valueA, valueB]''&gt;&lt;br&gt; ...&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component re-renders, if both valueA and valueB remain the same, all&lt;br&gt;updates for this &lt;div&gt; and its children will be skipped. In fact, even the&lt;br&gt;Virtual DOM VNode creation will also be skipped since the memoized copy of the&lt;br&gt;sub-tree can be reused.&lt;br&gt;&lt;br&gt;It is important to specify the memoization array correctly, otherwise we may&lt;br&gt;skip updates that should indeed be applied. v-memo with an empty dependency&lt;br&gt;array (v-memo=''[]'') would be functionally equivalent to v-once.&lt;br&gt;&lt;br&gt;Usage with v-for&lt;br&gt;&lt;br&gt;v-memo is provided solely for micro optimizations in performance-critical&lt;br&gt;scenarios and should be rarely needed. The most common case where this may prove&lt;br&gt;helpful is when rendering large v-for lists (where length &gt; 1000):&lt;br&gt;&lt;br&gt;&lt;div v-for=''item in list'' :key=''item.id'' v-memo=''[item.id === selected]''&gt;&lt;br&gt; &lt;p&gt;ID: {{ item.id }} - selected: {{ item.id === selected }}&lt;/p&gt;&lt;br&gt; &lt;p&gt;...more child nodes&lt;/p&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component's selected state changes, a large amount of VNodes will be&lt;br&gt;created even though most of the items remained exactly the same. The v-memo&lt;br&gt;usage here is essentially saying ''only update this item if it went from&lt;br&gt;non-selected to selected, or the other way around''. This allows every unaffected&lt;br&gt;item to reuse its previous VNode and skip diffing entirely. Note we don't need&lt;br&gt;to include item.id in the memo dependency array here since Vue automatically&lt;br&gt;infers it from the item's :key.&lt;br&gt;&lt;br&gt;WARNING&lt;br&gt;&lt;br&gt;When using v-memo with v-for, make sure they are used on the same element.&lt;br&gt;v-memo does not work inside v-for.&lt;br&gt;&lt;br&gt;v-memo can also be used on components to manually prevent unwanted updates in&lt;br&gt;certain edge cases where the child component update check has been de-optimized.&lt;br&gt;But again, it is the developer's responsibility to specify correct dependency&lt;br&gt;arrays to avoid skipping necessary updates.&lt;br&gt;&lt;br&gt;See also:&lt;br&gt;&lt;br&gt;v-once (https://vuejs.org/api/built-in-directives.html#v-once)">
          v-memo</abbr> 在 v-for 中使用时支持常量表达式 <code>&lt;div v-for="v
          in list" v-memo="[count &lt; 2 ? true :
          count]"/&gt;</code></li>
        </ul>
      </div>
      <div id="outline-container-org3d1b971" class="outline-3">
        <h3 id="org3d1b971"><span class=
        "section-number-3">7.1.</span> Bug Fixes
        <code>[8/8]</code></h3>
        <div class="outline-text-3" id="text-7-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>v-memo: should work on v-for with constant
              expression (<a href=
              "https://github.com/vuejs/vue-next/issues/4272">#4272</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/3b60358d0e0289298df7937983b3e06123f8eb3d">3b60358</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4246">#4246</a></p>
              <p>v-memo 应用在 v-for 中加入表达式的支持</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-core/src/helpers/renderList.ts</span>
<span class=
"org-diff-hunk-header">@@ -71,7 +71,7 @@</span><span class=
"org-diff-function"> export function renderList(</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">    ret = new Array(source)</span>
<span class=
"org-diff-context">    for (let i = 0; i &lt; source; i++) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      ret[i] = renderItem(i + 1, i)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      ret[i] = renderItem(i + 1, i</span><span class="org-diff-added"><span class="org-diff-refine-added">, undefined, cached &amp;& cached[i]</span></span><span class="org-diff-added">)</span>
<span class="org-diff-context">    }</span>
<span class=
"org-diff-context">  } else if (isObject(source)) {</span>
    if (source[Symbol.iterator as any]) {
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span class=
                "org-function-name">test</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-string">'on v-for /w constant expression '</span>, <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-rainbow-delimiters-depth-3">[</span><span class=
"org-variable-name">el</span>, <span class=
"org-variable-name">vm</span><span class=
"org-rainbow-delimiters-depth-3">]</span> = <span class=
"org-function-name">mount</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">{</span>
      template: <span class=
"org-string">`&lt;div v-for="item in 3"  v-memo="[count &lt; 2 ? true : count]"&gt;</span>
<span class="org-string">          {{count}}</span>
<span class="org-string">        &lt;/div&gt;`</span>,
      data: <span class=
"org-rainbow-delimiters-depth-1">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-rainbow-delimiters-depth-2">{</span>
        count: <span class="org-highlight-numbers-number">0</span>
      <span class=
"org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>el.innerHTML<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">toBe</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">`&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;`</span><span class="org-rainbow-delimiters-depth-3">)</span>

    vm.count = <span class="org-highlight-numbers-number">1</span>
    <span class="org-keyword">await</span> <span class=
"org-function-name">nextTick</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">should not update</span>
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>el.innerHTML<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">toBe</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">`&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;`</span><span class="org-rainbow-delimiters-depth-3">)</span>

    vm.count = <span class="org-highlight-numbers-number">2</span>
    <span class="org-keyword">await</span> <span class=
"org-function-name">nextTick</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">should update</span>
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>el.innerHTML<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">toBe</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">`&lt;div&gt;2&lt;/div&gt;&lt;div&gt;2&lt;/div&gt;&lt;div&gt;2&lt;/div&gt;`</span><span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org3e80a32" class="outline-3">
        <h3 id="org3e80a32"><span class=
        "section-number-3">7.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-7-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href=
              "https://www.cheng92.com/vue/vue-teardown-17-async-component/">
              runtime-dom: support async component in
              defineCustomElement</a> (<a href=
              "https://github.com/vuejs/vue-next/commit/c421fb91b2bec047e665f8269e231bf89f9bfc93">c421fb9</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4261">#4261</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org6551e51" class="outline-2">
      <h2 id="org6551e51"><span class="section-number-2">8.</span>
      3.2.0-beta.7</h2>
      <div class="outline-text-2" id="text-8"></div>
      <div id="outline-container-orgb94762b" class="outline-3">
        <h3 id="orgb94762b"><span class=
        "section-number-3">8.1.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-8-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: dereference nested effect scopes on
              manual stop (<a href=
              "https://github.com/vuejs/vue-next/commit/1867591e7c54406e92575753dd77fffba17606a2">1867591</a>)</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/reactivity/src/effectScope.ts</span>
<span class="org-diff-hunk-header">@@ -1,3 +1,4 @@</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> import { remove } from '@vue/shared'</span>
<span class=
"org-diff-context">import { ReactiveEffect } from './effect'</span>
<span class=
"org-diff-context">import { warn } from './warning'</span>

<span class=
"org-diff-hunk-header">@@ -8,10 +9,12 @@</span><span class=
"org-diff-function"> export class EffectScope {</span>
<span class="org-diff-context">  active = true</span>
<span class=
"org-diff-context">  effects: (ReactiveEffect | EffectScope)[] = []</span>
<span class=
"org-diff-context">  cleanups: (() =&gt; void)[] = []</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  parent: EffectScope | undefined</span>

<span class=
"org-diff-context">  constructor(detached = false) {</span>
<span class="org-diff-context">    if (!detached) {</span>
<span class="org-diff-context">      recordEffectScope(this)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      this.parent = activeEffectScope</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">  }</span>

<span class=
"org-diff-hunk-header">@@ -42,11 +45,14 @@</span><span class=
"org-diff-function"> export class EffectScope {</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">  }</span>

<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  stop() {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  stop(fromParent = false) {</span>
<span class="org-diff-context">    if (this.active) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      this.effects.forEach(e =&gt; e.stop())</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      this.effects.forEach(e =&gt; e.stop(true))</span>
<span class=
"org-diff-context">      this.cleanups.forEach(cleanup =&gt; cleanup())</span>
<span class="org-diff-context">      this.active = false</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      if (!fromParent &amp;& this.parent) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        remove(this.parent.effects, this)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      }</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">  }</span>
}
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span class=
                "org-function-name">it</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-string">'should derefence child scope from parent scope after stopping child scope (no memleaks)'</span>, <span class="org-keyword">async</span> <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">parent</span> = <span class=
"org-keyword">new</span> <span class=
"org-type">EffectScope</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">child</span> = parent.<span class=
"org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-keyword">new</span> <span class=
"org-type">EffectScope</span><span class=
"org-rainbow-delimiters-depth-4">()</span><span class=
"org-rainbow-delimiters-depth-3">)</span>!
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>parent.effects.<span class="org-function-name">includes</span><span class="org-rainbow-delimiters-depth-4">(</span>child<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>.<span class="org-function-name">toBe</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">true</span><span class="org-rainbow-delimiters-depth-3">)</span>
    child.<span class="org-function-name">stop</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>parent.effects.<span class="org-function-name">includes</span><span class="org-rainbow-delimiters-depth-4">(</span>child<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>.<span class="org-function-name">toBe</span><span class="org-rainbow-delimiters-depth-3">(</span><span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code> shared: support custom .toString()
              in text interpolation again (<a href=
              "https://github.com/vuejs/vue-next/issues/4210">#4210</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/9d5fd33d6dadf3186f7979d811dedf092f3ddcb7">9d5fd33</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3944">#3944</a>
              使用插值时候支持自定义的 <code>toString()</code>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>suspense: fix dynamicChildren tracking when
              suspense root is a block itself (<a href=
              "https://github.com/vuejs/vue-next/commit/51ee84fc6a5a1ab83cd02f17154803c47e65ae16">51ee84f</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4183">#4183</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/4198">#4198</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-core/src/components/Suspense.ts</span>
<span class=
"org-diff-hunk-header">@@ -749,7 +749,7 @@</span><span class=
"org-diff-function"> function normalizeSuspenseSlot(s: any) {</span>
<span class="org-diff-context">    s = singleChild</span>
<span class="org-diff-context">  }</span>
<span class="org-diff-context">  s = normalizeVNode(s)</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  if (block) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  if (block </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">&amp;& !s.dynamicChildren</span></span><span class="org-diff-added">) {</span>
<span class=
"org-diff-context">    s.dynamicChildren = block.filter(c =&gt; c !== s)</span>
<span class="org-diff-context">  }</span>
  return s
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgfd55979" class="outline-3">
        <h3 id="orgfd55979"><span class=
        "section-number-3">8.2.</span> Features
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-8-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>server-renderer: decouple esm build from Node +
              improve stream API (<a href=
              "https://github.com/vuejs/vue-next/commit/08672222c611a61f6359543aa202f0841d199bcb">0867222</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3467">#3467</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/3111">#3111</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/3460">#3460</a>
              <span id="0867222"></span></p>
              <p>移除 <code>renderToSTream</code>, 添加
              <code>renderToNodeStream</code>,
              <code>renderToWebStream</code>,
              <code>renderToSimpleStream</code></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">renderToSimpleStream</span>&lt;<span class=
                "org-type">T</span> <span class=
                "org-typescript-access-modifier">extends</span> <span class=
                "org-type">SimpleReadable</span>&gt;<span class=
                "org-rainbow-delimiters-depth-1">(</span>
  input: <span class="org-type">App</span> | VNode,
  context: <span class="org-type">SSRContext</span>,
  stream: T
<span class=
"org-rainbow-delimiters-depth-1">)</span>: T <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-function-name">isVNode</span><span class=
"org-rainbow-delimiters-depth-3">(</span>input<span class=
"org-rainbow-delimiters-depth-3">)</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">raw vnode, wrap with app (for context)</span>
    <span class="org-keyword">return</span> <span class=
"org-function-name">renderToSimpleStream</span><span class=
"org-rainbow-delimiters-depth-3">(</span>
      <span class="org-function-name">createApp</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-rainbow-delimiters-depth-1">{</span> render: <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> input <span class=
"org-rainbow-delimiters-depth-1">}</span><span class=
"org-rainbow-delimiters-depth-4">)</span>,
      context,
      stream
    <span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">rendering an app</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">vnode</span> = <span class=
"org-function-name">createVNode</span><span class=
"org-rainbow-delimiters-depth-2">(</span>input._component, input._props<span class="org-rainbow-delimiters-depth-2">)</span>
  vnode.appContext = input._context
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">provide the ssr context to the tree</span>
  input.<span class="org-function-name">provide</span><span class=
"org-rainbow-delimiters-depth-2">(</span>ssrContextKey, context<span class="org-rainbow-delimiters-depth-2">)</span>

  Promise.<span class=
"org-function-name">resolve</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-function-name">renderComponentVNode</span><span class="org-rainbow-delimiters-depth-3">(</span>vnode<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
    .<span class="org-function-name">then</span><span class=
"org-rainbow-delimiters-depth-2">(</span>buffer <span class=
"org-keyword">=&gt;</span> <span class=
"org-function-name">unrollBuffer</span><span class=
"org-rainbow-delimiters-depth-3">(</span>buffer, stream<span class=
"org-rainbow-delimiters-depth-3">)</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
    .<span class="org-function-name">then</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      stream.<span class=
"org-function-name">push</span><span class="org-rainbow-delimiters-depth-4">(</span><span class="org-constant">null</span><span class="org-rainbow-delimiters-depth-4">)</span>
    <span class=
"org-rainbow-delimiters-depth-3">}</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
    .<span class="org-keyword">catch</span><span class=
"org-rainbow-delimiters-depth-2">(</span>error <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      stream.<span class=
"org-function-name">destroy</span><span class=
"org-rainbow-delimiters-depth-4">(</span>error<span class=
"org-rainbow-delimiters-depth-4">)</span>
    <span class=
"org-rainbow-delimiters-depth-3">}</span><span class=
"org-rainbow-delimiters-depth-2">)</span>

  <span class="org-keyword">return</span> stream
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">node 环境</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">renderToNodeStream</span><span class=
"org-rainbow-delimiters-depth-1">(</span>
  input: <span class="org-type">App</span> | VNode,
  context: <span class="org-type">SSRContext</span> = <span class=
"org-rainbow-delimiters-depth-2">{}</span>
<span class="org-rainbow-delimiters-depth-1">)</span>: <span class=
"org-type">Readable</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">stream</span>: <span class=
"org-type">Readable</span> = __NODE_JS__
    ? <span class="org-keyword">new</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-function-name">require</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'stream'</span><span class=
"org-rainbow-delimiters-depth-3">)</span>.Readable<span class=
"org-rainbow-delimiters-depth-2">)()</span>
    : <span class="org-constant">null</span>

  <span class="org-keyword">return</span> <span class=
"org-function-name">renderToSimpleStream</span><span class=
"org-rainbow-delimiters-depth-2">(</span>input, context, stream<span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">web 环境</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">renderToWebStream</span><span class=
"org-rainbow-delimiters-depth-1">(</span>
  input: <span class="org-type">App</span> | VNode,
  context: <span class="org-type">SSRContext</span> = <span class=
"org-rainbow-delimiters-depth-2">{}</span>
<span class="org-rainbow-delimiters-depth-1">)</span>: <span class=
"org-type">ReadableStream</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">check</span>

  <span class="org-keyword">const</span> <span class=
"org-variable-name">encoder</span> = <span class=
"org-keyword">new</span> <span class=
"org-type">TextEncoder</span><span class=
"org-rainbow-delimiters-depth-2">()</span>
  <span class="org-keyword">let</span> <span class=
"org-variable-name">cancelled</span> = <span class=
"org-constant">false</span>

  <span class="org-keyword">return</span> <span class=
"org-keyword">new</span> <span class=
"org-type">ReadableStream</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">{</span>
    <span class="org-function-name">start</span><span class=
"org-rainbow-delimiters-depth-4">(</span>controller<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
      <span class=
"org-function-name">renderToSimpleStream</span><span class=
"org-rainbow-delimiters-depth-1">(</span>input, context, <span class="org-rainbow-delimiters-depth-2">{</span>
        <span class="org-function-name">push</span><span class=
"org-rainbow-delimiters-depth-3">(</span>content<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
          <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>cancelled<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-keyword">return</span>
          <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>content != <span class=
"org-constant">null</span><span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
            controller.<span class=
"org-function-name">enqueue</span><span class=
"org-rainbow-delimiters-depth-1">(</span>encoder.<span class=
"org-function-name">encode</span><span class=
"org-rainbow-delimiters-depth-2">(</span>content<span class=
"org-rainbow-delimiters-depth-2">)</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
          <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
            controller.<span class=
"org-function-name">close</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
          <span class="org-rainbow-delimiters-depth-4">}</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>,
        <span class="org-function-name">destroy</span><span class=
"org-rainbow-delimiters-depth-3">(</span>err<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
          controller.<span class=
"org-function-name">error</span><span class=
"org-rainbow-delimiters-depth-4">(</span>err<span class=
"org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>
      <span class=
"org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
    <span class="org-rainbow-delimiters-depth-4">}</span>,
    <span class="org-function-name">cancel</span><span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
      cancelled = <span class="org-constant">true</span>
    <span class="org-rainbow-delimiters-depth-4">}</span>
  <span class="org-rainbow-delimiters-depth-3">}</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">import</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span> createApp, h, defineAsyncComponent <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-keyword">from</span> <span class="org-string">'vue'</span>
<span class="org-keyword">import</span> <span class=
"org-rainbow-delimiters-depth-1">{</span> ReadableStream <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-keyword">from</span> <span class="org-string">'stream/web'</span>
<span class="org-keyword">import</span> <span class=
"org-rainbow-delimiters-depth-1">{</span> renderToWebStream <span class="org-rainbow-delimiters-depth-1">}</span> <span class="org-keyword">from</span> <span class="org-string">'../src'</span>

<span class="org-function-name">test</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-string">'should work'</span>, <span class=
"org-keyword">async</span> <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">Async</span> = <span class=
"org-function-name">defineAsyncComponent</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span>
    Promise.<span class=
"org-function-name">resolve</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-rainbow-delimiters-depth-1">{</span>
      render: <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-string">'div'</span>, <span class=
"org-string">'async'</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
    <span class=
"org-rainbow-delimiters-depth-1">}</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
                                    <span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">App</span> = <span class=
"org-rainbow-delimiters-depth-3">{</span>
    render: <span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-4">[</span><span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-string">'div'</span>, <span class=
"org-string">'parent'</span><span class=
"org-rainbow-delimiters-depth-1">)</span>, <span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-1">(</span>Async<span class=
"org-rainbow-delimiters-depth-1">)</span><span class=
"org-rainbow-delimiters-depth-4">]</span>
  <span class="org-rainbow-delimiters-depth-3">}</span>

  <span class="org-keyword">const</span> <span class=
"org-variable-name">stream</span> = <span class=
"org-function-name">renderToWebStream</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-function-name">createApp</span><span class=
"org-rainbow-delimiters-depth-4">(</span>App<span class=
"org-rainbow-delimiters-depth-4">)</span>, <span class=
"org-rainbow-delimiters-depth-4">{}</span>, ReadableStream<span class="org-rainbow-delimiters-depth-3">)</span>

  <span class="org-keyword">const</span> <span class=
"org-variable-name">reader</span> = stream.<span class=
"org-function-name">getReader</span><span class=
"org-rainbow-delimiters-depth-3">()</span>

  <span class="org-keyword">let</span> <span class=
"org-variable-name">res</span> = <span class="org-string">''</span>
  <span class="org-keyword">await</span> reader.<span class=
"org-function-name">read</span><span class=
"org-rainbow-delimiters-depth-3">()</span>.<span class=
"org-function-name">then</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-keyword">function</span> <span class=
"org-function-name">read</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-rainbow-delimiters-depth-1">{</span> done, value <span class=
"org-rainbow-delimiters-depth-1">}</span><span class=
"org-rainbow-delimiters-depth-4">)</span>: <span class=
"org-typescript-primitive">any</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>!done<span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
      res += value
      <span class="org-keyword">return</span> reader.<span class=
"org-function-name">read</span><span class=
"org-rainbow-delimiters-depth-2">()</span>.<span class=
"org-function-name">then</span><span class=
"org-rainbow-delimiters-depth-2">(</span>read<span class=
"org-rainbow-delimiters-depth-2">)</span>
    <span class="org-rainbow-delimiters-depth-1">}</span>
  <span class="org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>

  <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span>res<span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">toBe</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">`&lt;!--[--&gt;&lt;div&gt;parent&lt;/div&gt;&lt;div&gt;async&lt;/div&gt;&lt;!--]--&gt;`</span><span class="org-rainbow-delimiters-depth-3">)</span>
<span class="org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgc290657" class="outline-2">
      <h2 id="orgc290657"><span class="section-number-2">9.</span>
      3.2.0-beta.6</h2>
      <div class="outline-text-2" id="text-9">
        <ul class="org-ul">
          <li><b><span style="color:red;">FIX</span></b> inject
          的时候要能自动 unref, provide + inject 实际上是原型链的实现</li>
        </ul>
      </div>
      <div id="outline-container-orgc99ae40" class="outline-3">
        <h3 id="orgc99ae40"><span class=
        "section-number-3">9.1.</span> Bug Fixes
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-9-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>inject: should auto unwrap injected refs (<a href=
              "https://github.com/vuejs/vue-next/commit/561e210157874b216efc1c17be701a6a81c4383b">561e210</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4196">#4196</a></p>
              <p>在 child 组件中使用 inject 时候要检测是不是 ref 类型，如果是要自动 unref
              下， 即：</p>
              <p>在 parent 中</p>
              <div class="org-src-container">
                <pre class="src src-js">defineComponent({
  provide(): {
    <span class="org-keyword">return</span> { n: ref(<span class=
"org-highlight-numbers-number">0</span>) }
  }
})
</pre>
              </div>
              <p>在 child 中</p>
              <div class="org-src-container">
                <pre class="src src-js">defineComponent({
  inject: [<span class="org-string">'n'</span>],
  render() {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">这里要能直接使用，而不是需要 this.n.value</span>
    <span class="org-keyword">return</span> <span class=
"org-constant">this</span>.n
  }
})
</pre>
              </div>
              <p>所以 vue 内部要将 <code>this.n.value</code> 隐藏掉，从而能直接
              <code>this.n</code> 使用。</p>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/componentOptions.ts">
              runtime-core/src/componentOptions.ts:resolveInjections</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">resolveInjections</span><span class=
                "org-rainbow-delimiters-depth-1">(</span>
  injectOptions: <span class=
"org-type">ComponentInjectOptions</span>,
  ctx: <span class="org-typescript-primitive">any</span>,
  checkDuplicateProperties = NOOP <span class=
"org-keyword">as</span> <span class=
"org-typescript-primitive">any</span>,
  unwrapRef = <span class="org-constant">false</span>
<span class="org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-function-name">isArray</span><span class=
"org-rainbow-delimiters-depth-3">(</span>injectOptions<span class=
"org-rainbow-delimiters-depth-3">)</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    injectOptions = <span class=
"org-function-name">normalizeInject</span><span class=
"org-rainbow-delimiters-depth-3">(</span>injectOptions<span class=
"org-rainbow-delimiters-depth-3">)</span>!
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> <span class=
"org-keyword">in</span> injectOptions<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">opt</span> = <span class=
"org-rainbow-delimiters-depth-3">(</span>injectOptions <span class=
"org-keyword">as</span> ObjectInjectOptions<span class=
"org-rainbow-delimiters-depth-3">)[</span>key<span class=
"org-rainbow-delimiters-depth-3">]</span>
    <span class="org-keyword">let</span> <span class=
"org-variable-name">injected</span>: <span class=
"org-typescript-primitive">unknown</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-function-name">isObject</span><span class=
"org-rainbow-delimiters-depth-4">(</span>opt<span class=
"org-rainbow-delimiters-depth-4">)</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-string">'default'</span> <span class=
"org-keyword">in</span> opt<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        injected = <span class=
"org-function-name">inject</span><span class=
"org-rainbow-delimiters-depth-1">(</span>
          opt.<span class="org-keyword">from</span> || key,
          opt.<span class="org-keyword">default</span>,
          <span class="org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">treat default function as factory */</span>
        <span class="org-rainbow-delimiters-depth-1">)</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        injected = <span class=
"org-function-name">inject</span><span class=
"org-rainbow-delimiters-depth-1">(</span>opt.<span class=
"org-keyword">from</span> || key<span class=
"org-rainbow-delimiters-depth-1">)</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class=
"org-rainbow-delimiters-depth-3">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      injected = <span class=
"org-function-name">inject</span><span class=
"org-rainbow-delimiters-depth-4">(</span>opt<span class=
"org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-function-name">isRef</span><span class=
"org-rainbow-delimiters-depth-4">(</span>injected<span class=
"org-rainbow-delimiters-depth-4">)</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span><span class=
"org-comment"> remove the check in 3.3</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>unwrapRef<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        Object.<span class=
"org-function-name">defineProperty</span><span class=
"org-rainbow-delimiters-depth-1">(</span>ctx, key, <span class=
"org-rainbow-delimiters-depth-2">{</span>
          enumerable: <span class="org-constant">true</span>,
          configurable: <span class="org-constant">true</span>,
          <span class="org-keyword">get</span>: <span class=
"org-rainbow-delimiters-depth-3">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>injected <span class=
"org-keyword">as</span> Ref<span class=
"org-rainbow-delimiters-depth-3">)</span>.value,
          <span class="org-keyword">set</span>: v <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">(</span>injected <span class=
"org-keyword">as</span> Ref<span class=
"org-rainbow-delimiters-depth-4">)</span>.value = v<span class=
"org-rainbow-delimiters-depth-3">)</span>
        <span class=
"org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        ctx<span class=
"org-rainbow-delimiters-depth-1">[</span>key<span class=
"org-rainbow-delimiters-depth-1">]</span> = injected
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class=
"org-rainbow-delimiters-depth-3">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      ctx<span class=
"org-rainbow-delimiters-depth-4">[</span>key<span class=
"org-rainbow-delimiters-depth-4">]</span> = injected
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>__DEV__<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      checkDuplicateProperties!<span class=
"org-rainbow-delimiters-depth-4">(</span>OptionTypes.INJECT, key<span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>


</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>sfc/style-vars: should ignore style variable
              bindings in comments (<a href=
              "https://github.com/vuejs/vue-next/issues/4188">#4188</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/3a75d5d6942a1743789192dca9161f7c30a71e58">3a75d5d</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4185">#4185</a></p>
              <p>过滤掉 css 注释里面的 v-bind</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/compiler-sfc/src/cssVars.ts</span>
<span class=
"org-diff-hunk-header">@@ -37,7 +37,9 @@</span><span class=
"org-diff-function"> export function parseCssVars(sfc: SFCDescriptor): string[] {</span>
<span class="org-diff-context">  const vars: string[] = []</span>
<span class=
"org-diff-context">  sfc.styles.forEach(style =&gt; {</span>
<span class="org-diff-context">    let match</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    while ((match = cssVarRE.exec(</span><span class="org-diff-removed"><span class="org-diff-refine-removed">style.</span></span><span class="org-diff-removed">content))) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">// ignore v-bind() in comments /* ... */</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">    const content = style.content.replace(/\/\*[\s\S]*\*\//g, '')</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added">    while ((match = cssVarRE.exec(content))) {</span>
<span class=
"org-diff-context">      const variable = match[1] || match[2] || match[3]</span>
<span class=
"org-diff-context">      if (!vars.includes(variable)) {</span>
        vars.push(variable)
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgef54dbb" class="outline-3">
        <h3 id="orgef54dbb"><span class=
        "section-number-3">9.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-9-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>unwrap refs in toDisplayString (<a href=
              "https://github.com/vuejs/vue-next/commit/f994b974c0a1ac95d313c8ccfc258c6ba3910b6e">f994b97</a>)
              <span id="f994b97"></span></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/shared/src/toDisplayString.ts</span>
<span class=
"org-diff-hunk-header">@@ -12,8 +12,11 @@</span><span class=
"org-diff-function"> export const toDisplayString = (val: unknown): string =&gt; {</span>
<span class="org-diff-context">    : String(val)</span>
<span class="org-diff-context">}</span>

<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed"> const replacer = (_key: string, val: any) =&gt; {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  if (isMap(val)) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> const replacer = (_key: string, val: any): any =&gt; {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  // can't use isRef here since @vue/shared has no deps</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  if (val &amp;& val.__v_isRef) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    return replacer(_key, val.value)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  } else if (isMap(val)) {</span>
<span class="org-diff-context">    return {</span>
<span class=
"org-diff-context">      [`Map(${val.size})`]: [...val.entries()].reduce((entries, [key, val]) =&gt; {</span>
        ;(entries as any)[`${key} =&gt;`] = val
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org7039d9d" class="outline-2">
      <h2 id="org7039d9d"><span class="section-number-2">10.</span>
      3.2.0-beta.5</h2>
      <div class="outline-text-2" id="text-10"></div>
      <div id="outline-container-orgb535c84" class="outline-3">
        <h3 id="orgb535c84"><span class=
        "section-number-3">10.1.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-10-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>v-model: avoid resetting value of in-focus & lazy
              input (<a href=
              "https://github.com/vuejs/vue-next/commit/ac74e1dd33a45874a96fc13efdaade613c44dd70">ac74e1d</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4182">#4182</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-dom/src/directives/vModel.ts</span>
<span class=
"org-diff-hunk-header">@@ -80,11 +80,14 @@</span><span class=
"org-diff-function"> export const vModelText: ModelDirective&lt;</span>
<span class="org-diff-context">  mounted(el, { value }) {</span>
<span class=
"org-diff-context">    el.value = value == null ? '' : value</span>
<span class="org-diff-context">  },</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  beforeUpdate(el, { value, modifiers: { trim, number } }, vnode) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  beforeUpdate(el, { value, modifiers: { </span><span class="org-diff-added"><span class="org-diff-refine-added">lazy,</span></span><span class="org-diff-added"> trim, number } }, vnode) {</span>
<span class=
"org-diff-context">    el._assign = getModelAssigner(vnode)</span>
<span class=
"org-diff-context">    // avoid clearing unresolved text. #2302</span>
<span class=
"org-diff-context">    if ((el as any).composing) return</span>
<span class=
"org-diff-context">    if (document.activeElement === el) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      if (lazy) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        return</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      }</span>
<span class=
"org-diff-context">      if (trim &amp;& el.value.trim() === value) {</span>
<span class="org-diff-context">        return</span>
      }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org0ff16a4" class="outline-3">
        <h3 id="org0ff16a4"><span class=
        "section-number-3">10.2.</span> Features
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-10-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: avoid exposing imports not used in
              template (<a href=
              "https://github.com/vuejs/vue-next/commit/5a3ccfd9143700c7ca82d2911fe592d0658c5393">5a3ccfd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/commit/5a3ccfd9143700c7ca82d2911fe592d0658c5393">
              #3183</a> <span id="5a3ccfd"></span></p>
              <p>避免导出 <code>&lt;template&gt;</code> 中没有用到的
              <code>&lt;script setup&gt;</code> 中引入的变量。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: hmr for custom elements (<a href=
              "https://github.com/vuejs/vue-next/commit/7a7e1d8e9fed27bc2dbf24076642e83d0c80d9af">7a7e1d8</a>)</p>
              <p>支持自定义元素在开发时的热更新。</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">if</span> <span class=
                "org-rainbow-delimiters-depth-1">(</span>__DEV__<span class=
                "org-rainbow-delimiters-depth-1">)</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  instance.appContext.reload = <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-typescript-this">this</span>.<span class=
"org-function-name">_createVNode</span><span class=
"org-rainbow-delimiters-depth-4">()</span>, <span class=
"org-typescript-this">this</span>.shadowRoot!<span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class=
"org-typescript-this">this</span>.shadowRoot!.<span class=
"org-function-name">querySelectorAll</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'style'</span><span class=
"org-rainbow-delimiters-depth-3">)</span>.<span class=
"org-function-name">forEach</span><span class=
"org-rainbow-delimiters-depth-3">(</span>s <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
      <span class=
"org-typescript-this">this</span>.shadowRoot!.<span class=
"org-function-name">removeChild</span><span class=
"org-rainbow-delimiters-depth-1">(</span>s<span class=
"org-rainbow-delimiters-depth-1">)</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class="org-typescript-this">this</span>.<span class=
"org-function-name">_applyStyles</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: support passing initial props to
              custom element constructor (<a href=
              "https://github.com/vuejs/vue-next/commit/5b76843b693d6477ae44b4bd238c2c892d8f4c77">5b76843</a>)
              支持给自定义元素传递默认属性值。</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span class=
                "org-function-name">describe</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-string">'mounting/unmount'</span>, <span class=
                "org-rainbow-delimiters-depth-2">()</span> <span class=
                "org-keyword">=&gt;</span> <span class=
                "org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">E</span> = <span class=
"org-function-name">defineCustomElement</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">{</span>
      render: <span class=
"org-rainbow-delimiters-depth-1">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-string">'div'</span>, <span class=
"org-string">'hello'</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
      props: <span class="org-rainbow-delimiters-depth-1">{</span>
        msg: <span class="org-rainbow-delimiters-depth-2">{</span>
          <span class="org-keyword">type</span>: <span class=
"org-type">String</span>,
          <span class="org-keyword">default</span>: <span class=
"org-string">'hello'</span>
        <span class="org-rainbow-delimiters-depth-2">}</span>
      <span class="org-rainbow-delimiters-depth-1">}</span>,
      <span class="org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-1">()</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
        <span class="org-keyword">return</span> <span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-string">'div'</span>, <span class=
"org-typescript-this">this</span>.msg<span class=
"org-rainbow-delimiters-depth-2">)</span>
      <span class="org-rainbow-delimiters-depth-1">}</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    customElements.<span class=
"org-function-name">define</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'my-element'</span>, E<span class=
"org-rainbow-delimiters-depth-3">)</span>

    <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>

    <span class="org-function-name">test</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'should work w/ manual instantiation'</span>, <span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-4">{</span>
      <span class="org-keyword">const</span> <span class=
"org-variable-name">e</span> = <span class=
"org-keyword">new</span> <span class=
"org-type">E</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-rainbow-delimiters-depth-2">{</span> msg: <span class="org-string">'inline'</span> <span class="org-rainbow-delimiters-depth-2">}</span><span class="org-rainbow-delimiters-depth-1">)</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">should lazy init</span>
      <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-1">(</span>e._instance<span class=
"org-rainbow-delimiters-depth-1">)</span>.<span class=
"org-function-name">toBe</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-constant">null</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">should initialize on connect</span>
      container.<span class=
"org-function-name">appendChild</span><span class=
"org-rainbow-delimiters-depth-1">(</span>e<span class=
"org-rainbow-delimiters-depth-1">)</span>
      <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-1">(</span>e._instance<span class=
"org-rainbow-delimiters-depth-1">)</span>.<span class=
"org-function-name">toBeTruthy</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
      <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-1">(</span>e.shadowRoot!.innerHTML<span class="org-rainbow-delimiters-depth-1">)</span>.<span class="org-function-name">toBe</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">`&lt;div&gt;inline&lt;/div&gt;`</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
</pre>
              </div>
              <p>feat:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/runtime-dom/src/apiCustomElement.ts</span>
<span class=
"org-diff-hunk-header">@@ -23,8 +23,8 @@</span><span class=
"org-diff-function"> import {</span>
<span class=
"org-diff-context">import { camelize, extend, hyphenate, isArray, toNumber } from '@vue/shared'</span>
<span class=
"org-diff-context">import { hydrate, render } from '.'</span>

<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed"> type VueElementConstructor&lt;P = {}&gt; = {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  new (): VueElement & P</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> </span><span class="org-diff-added"><span class=
"org-diff-refine-added">export</span></span><span class=
"org-diff-added"> type VueElementConstructor&lt;P = {}&gt; = {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  new (</span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">initialProps?: Record&lt;string, any&gt;</span></span><span class="org-diff-added">): VueElement & P</span>
<span class="org-diff-context">}</span>

<span class=
"org-diff-context">// defineCustomElement provides the same type inference as defineComponent</span>
<span class=
"org-diff-hunk-header">@@ -134,8 +134,8 @@</span><span class=
"org-diff-function"> export function defineCustomElement(</span>
<span class=
"org-diff-context">    static get observedAttributes() {</span>
<span class="org-diff-context">      return attrKeys</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">    constructor() {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      super(Comp, attrKeys, propKeys, hydate)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    constructor(initialProps?: Record&lt;string, any&gt;) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      super(Comp, initialProps, attrKeys, propKeys, hydate)</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">  }</span>

<span class=
"org-diff-hunk-header">@@ -163,10 +163,6 @@</span><span class=
"org-diff-function"> const BaseClass = (</span>
<span class="org-diff-context">) as typeof HTMLElement</span>

<span class=
"org-diff-context">export class VueElement extends BaseClass {</span>
<span class="org-diff-context">  /**</span>
<span class="org-diff-context">   * @internal</span>
<span class="org-diff-context">   */</span>
<span class=
"org-diff-hunk-header">@@ -178,6 +174,7 @@</span><span class=
"org-diff-function"> export class VueElement extends BaseClass {</span>

<span class="org-diff-context">  constructor(</span>
<span class=
"org-diff-context">    private _def: ComponentOptions & { styles?: string[] },</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    private _props: Record&lt;string, any&gt; = {},</span>
<span class=
"org-diff-context">    private _attrKeys: string[],</span>
<span class=
"org-diff-context">    private _propKeys: string[],</span>
    hydrate?: RootHydrateFunction
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: support specifying shadow dom styles
              in defineCustomElement (<a href=
              "https://github.com/vuejs/vue-next/commit/a7fa4ac28afb73be00503be87f35e8724fe25443">a7fa4ac</a>)</p>
              <p>给自定义元素增加 styles 支持。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/runtime-dom/src/apiCustomElement.ts</span>

<span class=
"org-diff-context">// overload 5: defining a custom element from the returned value of</span>
<span class=
"org-diff-hunk-header">@@ -176,7 +176,7 @@</span><span class=
"org-diff-function"> export class VueElement extends BaseClass {</span>
<span class="org-diff-context">  _connected = false</span>

<span class="org-diff-context">  constructor(</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    private _def: Component,</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    private _def: Component</span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">Options & { styles?: string[] }</span></span><span class="org-diff-added">,</span>
<span class=
"org-diff-context">    private _attrKeys: string[],</span>
<span class=
"org-diff-context">    private _propKeys: string[],</span>
<span class=
"org-diff-context">    hydrate?: RootHydrateFunction</span>
<span class=
"org-diff-hunk-header">@@ -192,6 +192,13 @@</span><span class=
"org-diff-function"> export class VueElement extends BaseClass {</span>
<span class="org-diff-context">        )</span>
<span class="org-diff-context">      }</span>
<span class=
"org-diff-context">      this.attachShadow({ mode: 'open' })</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      if (_def.styles) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        _def.styles.forEach(css =&gt; {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">          const s = document.createElement('style')</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">          s.textContent = css</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">          this.shadowRoot!.appendChild(s)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        })</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      }</span>
<span class="org-diff-context">    }</span>
  }
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span class=
                "org-function-name">describe</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-string">'styles'</span>, <span class=
                "org-rainbow-delimiters-depth-2">()</span> <span class=
                "org-keyword">=&gt;</span> <span class=
                "org-rainbow-delimiters-depth-2">{</span>
    <span class="org-function-name">test</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'should attach styles to shadow dom'</span>, <span class="org-rainbow-delimiters-depth-4">()</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-4">{</span>
      <span class="org-keyword">const</span> <span class=
"org-variable-name">Foo</span> = <span class=
"org-function-name">defineCustomElement</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-rainbow-delimiters-depth-2">{</span>
        styles: <span class=
"org-rainbow-delimiters-depth-3">[</span><span class=
"org-string">`div { color: red; }`</span><span class=
"org-rainbow-delimiters-depth-3">]</span>,
        <span class="org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-3">()</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
          <span class="org-keyword">return</span> <span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-string">'div'</span>, <span class=
"org-string">'hello'</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
        <span class="org-rainbow-delimiters-depth-3">}</span>
      <span class=
"org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
      customElements.<span class=
"org-function-name">define</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-string">'my-el-with-styles'</span>, Foo<span class=
"org-rainbow-delimiters-depth-1">)</span>
      container.innerHTML = <span class=
"org-string">`&lt;my-el-with-styles&gt;&lt;/my-el-with-styles&gt;`</span>
      <span class="org-keyword">const</span> <span class=
"org-variable-name">el</span> = container.childNodes<span class=
"org-rainbow-delimiters-depth-1">[</span><span class=
"org-highlight-numbers-number">0</span><span class=
"org-rainbow-delimiters-depth-1">]</span> <span class=
"org-keyword">as</span> VueElement
      <span class="org-keyword">const</span> <span class=
"org-variable-name">style</span> = el.shadowRoot?.<span class=
"org-function-name">querySelector</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-string">'style'</span><span class=
"org-rainbow-delimiters-depth-1">)</span>!
      <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-1">(</span>style.textContent<span class="org-rainbow-delimiters-depth-1">)</span>.<span class="org-function-name">toBe</span><span class="org-rainbow-delimiters-depth-1">(</span><span class="org-string">`div { color: red; }`</span><span class="org-rainbow-delimiters-depth-1">)</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orge0e7de8" class="outline-2">
      <h2 id="orge0e7de8"><span class="section-number-2">11.</span>
      3.2.0-beta.4</h2>
      <div class="outline-text-2" id="text-11"></div>
      <div id="outline-container-org309ba3b" class="outline-3">
        <h3 id="org309ba3b"><span class=
        "section-number-3">11.1.</span> Bug Fixes
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-11-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: ensure setupContext.attrs reactivity
              when used in child slots (<a href=
              "https://github.com/vuejs/vue-next/commit/85600056015fcf5c922dc0b5b07aa03a5ba53245">8560005</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4161">#4161</a></p>
              <p>setup 中的 attrs 使用 proxy 代理</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-hunk-header">@@ -859,15 +874,13 @@</span><span class=
                "org-diff-function"> export function createSetupContext(</span>
<span class="org-diff-context">  } else {</span>
<span class="org-diff-context">    return {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      attrs: instance.attrs,</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      get attrs() {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        return attrs || (attrs = createAttrsProxy(instance))</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      },</span>
<span class="org-diff-context">      slots: instance.slots,</span>
<span class="org-diff-context">      emit: instance.emit,</span>
      expose
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org33bf65b" class="outline-3">
        <h3 id="org33bf65b"><span class=
        "section-number-3">11.2.</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-11-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>skip patch on same vnode (<a href=
              "https://github.com/vuejs/vue-next/commit/d13774b881b297f2cd1a8d3193183d241dee625b">d13774b</a>)</p>
              <p>优化：不对同一个节点进行 patch 过程。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/runtime-core/src/renderer.ts</span>
<span class=
"org-diff-hunk-header">@@ -470,6 +470,10 @@</span><span class=
"org-diff-function"> function baseCreateRenderer(</span>
<span class="org-diff-context">    slotScopeIds = null,</span>
<span class=
"org-diff-context">    optimized = __DEV__ &amp;& isHmrUpdating ? false : !!n2.dynamicChildren</span>
<span class="org-diff-context">  ) =&gt; {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    if (n1 === n2) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      return</span>
+    }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgaa3ced8" class="outline-2">
      <h2 id="orgaa3ced8"><span class="section-number-2">12.</span>
      3.2.0-beta.3</h2>
      <div class="outline-text-2" id="text-12">
        <ul class="org-ul">
          <li><b><span style="color:green;">ADD</span></b>
          <code>watchSyncEffect</code> 同步 watch
          effect，回调会在值变更之前被调用</li>
          <li>
            <b><span style="color:green;">ADD</span></b> 添加
            <a href="#deferredComputed">deferredComputed</a>
            支持计算属性异步功能，修改之后取值不会立即计算，而是 在 next tick 之后 flush
            scheduler 队列的时候通过 effect 去触发重新计算。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b> <a href=
            "#fix-vbind-class">修复</a> <code>&lt;button
            class="{btn:true}" v-bind="{disabled:true}"&gt;</code>
            中的 class 被解 析成了 <code>[object Object]</code> 的问题。
          </li>
        </ul>
      </div>
      <div id="outline-container-orgd92aae5" class="outline-3">
        <h3 id="orgd92aae5"><span class=
        "section-number-3">12.1.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-12-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: revert computed scheduler change
              (<a href=
              "https://github.com/vuejs/vue-next/commit/33c2fbfdc80c6f17c7e8435b7a152a4d9ed5c6ed">33c2fbf</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4157">#4157</a></p>
              <p>将 async computed 还原回去了，同时在这个版本中加入了 <a href=
              "#deferredComputed">deferredComputed</a></p>
            </li>
            <li class="on">
              <code>[X]</code> <a href=
              "#fix-vbind-class">runtime-core: fix v-bind
              class/style merging regression</a> (<a href=
              "https://github.com/vuejs/vue-next/commit/2bdee50a598456392541a8a4b451501e5df2d363">2bdee50</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4155">#4155</a>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org38f8435" class="outline-3">
        <h3 id="org38f8435"><span class=
        "section-number-3">12.2.</span> Features
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-12-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href=
              "#deferredComputed">reactivity: deferredComputed</a>
              (<a href=
              "https://github.com/vuejs/vue-next/commit/14ca881a1ba6ad887d5ffc6ce3b7f8461252afee">14ca881</a>)
              <span id="f-deferredComputed"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: watchSyncEffect (<a href=
              "https://github.com/vuejs/vue-next/commit/d87d059ac120ed0496f85474344ef76e40fa9bc7">d87d059</a>)
              <span id="watchSyncEffect"></span> <span id=
              "d87d059"></span></p>
              <p>watch options flush -&gt; sync</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">watchSyncEffect</span><span class=
                "org-rainbow-delimiters-depth-1">(</span>
  effect: <span class="org-type">WatchEffect</span>,
  options?: <span class="org-type">DebuggerOptions</span>
<span class="org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">return</span> <span class=
"org-function-name">doWatch</span><span class=
"org-rainbow-delimiters-depth-2">(</span>
    effect,
    <span class="org-constant">null</span>,
    <span class="org-rainbow-delimiters-depth-3">(</span>__DEV__
      ? Object.<span class=
"org-function-name">assign</span><span class=
"org-rainbow-delimiters-depth-4">(</span>options || <span class=
"org-rainbow-delimiters-depth-1">{}</span>, <span class=
"org-rainbow-delimiters-depth-1">{</span> flush: <span class=
"org-string">'sync'</span> <span class=
"org-rainbow-delimiters-depth-1">}</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
      : <span class=
"org-rainbow-delimiters-depth-4">{</span> flush: <span class=
"org-string">'sync'</span> <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-keyword">as</span> WatchOptionsBase
  <span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { nodeOps, render, nextTick, h, serializeInner: s, defineComponent, ref, watchSyncEffect } = value
<span class="org-keyword">const</span> <span class=
"org-variable-name">count</span> = ref(<span class=
"org-highlight-numbers-number">0</span>)
<span class="org-keyword">const</span> <span class=
"org-variable-name">count2</span> = ref(<span class=
"org-highlight-numbers-number">0</span>)
<span class="org-keyword">let</span> <span class=
"org-variable-name">result1</span>, <span class=
"org-variable-name">result2</span>, <span class=
"org-variable-name">callCount</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">assertion</span> = count =&gt; {
  console.log(<span class=
"org-string">'called '</span> + ++callCount)
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">on mount, watch callback 应该在 DOM 渲染之前被调用</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">on update, 应该在 count 更新之前被调用</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">因为是同步 effect</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">expectedDOM</span> = callCount === <span class=
"org-highlight-numbers-number">1</span> ? <span class=
"org-string">''</span> : <span class=
"org-string">`${count - 1}`</span>
  result1 = s(root) === expectedDOM

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">在同步回调中，在第2次调用时，state mutation 还不会被执行，但是在第3次调用时被执行</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">expectedState</span> = callCount &lt;<span class="org-highlight-numbers-number">3</span> ? <span class="org-highlight-numbers-number">0</span> : <span class="org-highlight-numbers-number">1</span>
  result2 = count2.value === expectedState
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">Comp</span> = {
  setup() {
    watchSyncEffect(() =&gt; {
      assertion(count.value)
    })
    <span class="org-keyword">return</span> () =&gt; count.value
  }
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">root</span> = nodeOps.createElement(<span class="org-string">'div'</span>)
render(h(Comp), root)
console.log(<span class=
"org-string">'before set, result1 = '</span> + result1)
console.log(<span class=
"org-string">'before set, result2 = '</span> + result2)

count.value++
count2.value++
nextTick().then(() =&gt; {
  console.log(<span class=
"org-string">'\nafter set, result1 = '</span> + result1)
  console.log(<span class=
"org-string">'after set, result2 = '</span> + result2)
})

</pre>
              </div>
              <p>源码：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-comment-delimiter">// </span><span class=
                "org-comment">apiWatch.ts -&gt; doWatch(...)</span>
<span class="org-keyword">let</span> <span class=
"org-variable-name">scheduler</span>: <span class=
"org-type">EffectScheduler</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">如果是 flush : 'sync', 这里会直接给 sheduler，这个</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">scheduler 会在值发生变更 trigger -&gt; triggerEffect 中执行</span>
<span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>flush === <span class=
"org-string">'sync'</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  scheduler = job <span class="org-keyword">as</span> <span class=
"org-typescript-primitive">any</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the scheduler function gets called directly</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">getter 已经上面测试中的 watchSyncEffect(fn) 的 fn 函数</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">effect</span> = <span class=
"org-keyword">new</span> <span class=
"org-type">ReactiveEffect</span><span class=
"org-rainbow-delimiters-depth-1">(</span>getter, scheduler<span class="org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">initial run</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>cb<span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
  <span class=
"org-rainbow-delimiters-depth-1">}</span> <span class="org-keyword">else</span> <span class="org-keyword">if</span> <span class="org-rainbow-delimiters-depth-1">(</span>flush === <span class="org-string">'post'</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
  <span class=
"org-rainbow-delimiters-depth-1">}</span> <span class="org-keyword">else</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">on mount 时执行,</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">会进入这里直接的执行 run, 即立即执行一次 watchSyncEffect(fn) 的 fn</span>
    effect.<span class="org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-2">()</span>
  <span class="org-rainbow-delimiters-depth-1">}</span>


<span class="org-comment-delimiter">// </span><span class=
"org-comment">effect.ts -&gt; trigger -&gt; triggerEffects</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">on update 执行的: trigger 的时候如果有 scheduler 会直接执行</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">triggerEffects</span><span class=
"org-rainbow-delimiters-depth-1">(</span>
  dep: <span class=
"org-type">Dep</span> | ReactiveEffect<span class=
"org-rainbow-delimiters-depth-2">[]</span>,
  debuggerEventExtraInfo?: <span class=
"org-type">DebuggerEventExtraInfo</span>
<span class="org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">spread into array for stabilization</span>
  <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">effect</span> <span class=
"org-keyword">of</span> <span class=
"org-function-name">isArray</span><span class=
"org-rainbow-delimiters-depth-3">(</span>dep<span class=
"org-rainbow-delimiters-depth-3">)</span> ? dep : <span class=
"org-rainbow-delimiters-depth-3">[</span>...dep<span class=
"org-rainbow-delimiters-depth-3">]</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>effect !== activeEffect || effect.allowRecurse<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>__DEV__ &amp;& effect.onTrigger<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        effect.<span class=
"org-function-name">onTrigger</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-function-name">extend</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">{</span> effect <span class=
"org-rainbow-delimiters-depth-3">}</span>, debuggerEventExtraInfo<span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>effect.scheduler<span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-rainbow-delimiters-depth-4">{</span>
        effect.<span class=
"org-function-name">scheduler</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        effect.<span class=
"org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org62cf55d" class="outline-2">
      <h2 id="org62cf55d"><span class="section-number-2">13.</span>
      3.2.0-beta.2</h2>
      <div class="outline-text-2" id="text-13">
        <ol class="org-ol">
          <li><b><span style="color:green;">ADD</span></b>: 支持
          <code>&lt;script setup lang="ts"&gt;</code> 中使用
          <code>const enum Foo { A: 100 }</code>, const enum</li>
          <li><b><span style="color:red;">FIX</span></b>: 支持
          <code>&lt;div :style="color: `${value}`"/&gt;</code>
          使用</li>
          <li><b><span style="color:red;">FIX</span></b>: 修复
          <code>watch([a,b], ([newA, newB], [oldA, oldB]) =&gt;
          {})</code> 中 <code>undefined -&gt; [oldA, oldB]</code>
          解构问题</li>
        </ol>
      </div>
      <div id="outline-container-org632b1d2" class="outline-3">
        <h3 id="org632b1d2"><span class=
        "section-number-3">13.1.</span> Bug Fixes
        <code>[11/11]</code></h3>
        <div class="outline-text-3" id="text-13-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support const enum (<a href=
              "https://github.com/vuejs/vue-next/commit/93a950d60d347321df4196d22f64c4810840a3bb">93a950d</a>)</p>
              <p>支持 <code>&lt;script setup lang="ts"&gt;</code> 中使用
              <code>const enum Foo { A: 100 }</code></p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> =
      process.env.VNEXT_PKG_RC + <span class=
"org-string">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">"stb-"</span>, <span class="org-string">""</span>));
<span class=
"org-keyword">const</span> { compileScript, parse } = value;

<span class="org-keyword">function</span> <span class=
"org-function-name">compileSFCScript</span>(<span class=
"org-variable-name">src</span>, <span class=
"org-variable-name">options</span>) {
  <span class=
"org-keyword">const</span> { descriptor } = parse(src)
  <span class=
"org-keyword">return</span> compileScript(descriptor, {
    ...options,
    id: <span class="org-string">'xxxxxxx'</span>
  })
}

<span class="org-keyword">function</span> <span class=
"org-function-name">compileWithRefSugar</span>(<span class=
"org-variable-name">src</span>) {
  <span class=
"org-keyword">return</span> compileSFCScript(src, { refSugar: <span class="org-constant">true</span> })
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">_</span> = (title, src) =&gt; {
  <span class=
"org-keyword">const</span> { content } = compileWithRefSugar(src)
  console.log(title, <span class="org-string">'\n'</span>, content)
}

_(<span class=
"org-string">'const enum &gt;&gt; '</span>, <span class=
"org-string">`</span>
<span class="org-string">&lt;script setup lang="ts"&gt;</span>
<span class="org-string">  const enum Foo { A = 123 }</span>
<span class="org-string">&lt;/script&gt;`</span>)
</pre>
              </div>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/compiler-sfc/src/compileScript.ts</span>
<span class=
"org-diff-hunk-header">@@ -1008,7 +1008,7 @@</span><span class=
"org-diff-function"> export function compileScript(</span>

<span class="org-diff-context">    if (isTS) {</span>
<span class="org-diff-context">      // runtime enum</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      if (node.type === 'TSEnumDeclaration' &amp;& !node.const) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      if (node.type === 'TSEnumDeclaration') {</span>
<span class=
"org-diff-context">        registerBinding(setupBindings, node.id, BindingTypes.SETUP_CONST)</span>
<span class="org-diff-context">      }</span>

</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: computed should not trigger scheduler
              if stopped (<a href=
              "https://github.com/vuejs/vue-next/commit/6eb47f000a1b54b2419c031979502d2793c5189d">6eb47f0</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4149">#4149</a></p>
              <p>组件 deactivated 之后不应该再执行 compute 计算，3.2.1
              中好像又改回去了？</p>
              <div class="org-src-container">
                <pre class="src src-js">(<span class=
                "org-keyword">async</span> <span class=
                "org-keyword">function</span> () {
  <span class="org-keyword">const</span> <span class=
"org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../reactivity/dist/reactivity.cjs.js'</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
  <span class=
"org-keyword">const</span> { reactive, effect, computed, ref } = value
  <span class="org-keyword">const</span> <span class=
"org-variable-name">tick</span> = Promise.resolve()
  <span class="org-keyword">const</span> <span class=
"org-variable-name">queue</span> = []
  <span class="org-keyword">let</span> <span class=
"org-variable-name">queued</span> = <span class=
"org-constant">false</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">schedule</span> = fn =&gt; {
    queue.push(fn)
    <span class="org-keyword">if</span> (!queued) {
      queued = <span class="org-constant">true</span>
      tick.then(flush)
    }
  }

  <span class="org-keyword">const</span> <span class=
"org-variable-name">flush</span> = () =&gt; {
    <span class="org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; queue.length; i++) {
      queue[i]()
    }
    queue.length = <span class=
"org-highlight-numbers-number">0</span>
    queued = <span class="org-constant">false</span>
  }

  <span class="org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">c1Spy</span> = () =&gt; {
    i++
    console.log(<span class="org-string">'xxx'</span>);
  }
  <span class="org-keyword">const</span> <span class=
"org-variable-name">src</span> = ref(<span class=
"org-highlight-numbers-number">0</span>)
  <span class="org-keyword">const</span> <span class=
"org-variable-name">c1</span> = computed(() =&gt; {
    c1Spy()
    <span class=
"org-keyword">return</span> src.value % <span class="org-highlight-numbers-number">2</span>
  })
  effect(() =&gt; c1.value)
  console.log(<span class=
"org-string">`c1Spy called ${i} times`</span>)

  schedule(() =&gt; {
    console.log(<span class="org-string">'\nstopped'</span>);
    c1.effect.stop()
  })

  src.value++

  <span class="org-keyword">await</span> tick
  console.log(<span class=
"org-string">`c1Spy called ${i} times`</span>)

}())

  <span class="org-keyword">return</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: fix null type in required +
              multi-type prop declarations (<a href=
              "https://github.com/vuejs/vue-next/commit/bbf6ca9bca942df639ff0357d713413c9a1c4c05">bbf6ca9</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4146">#4146</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/4147">#4147</a>
              支持多种类型时 null 声明。</p>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span class=
                "org-function-name">test</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-string">'support null in required + multiple-type declarations'</span>, <span class="org-rainbow-delimiters-depth-2">()</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">Comp</span> = <span class=
"org-rainbow-delimiters-depth-3">{</span>
      props: <span class="org-rainbow-delimiters-depth-4">{</span>
        foo: <span class=
"org-rainbow-delimiters-depth-1">{</span> <span class=
"org-keyword">type</span>: <span class=
"org-rainbow-delimiters-depth-2">[</span>Function, <span class=
"org-constant">null</span><span class=
"org-rainbow-delimiters-depth-2">]</span>, required: <span class=
"org-constant">true</span> <span class=
"org-rainbow-delimiters-depth-1">}</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>,
      <span class="org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-rainbow-delimiters-depth-4">{}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">root</span> = nodeOps.<span class=
"org-function-name">createElement</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">'div'</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
      <span class="org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-2">(</span>Comp, <span class=
"org-rainbow-delimiters-depth-3">{</span> foo: <span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-4">{}</span> <span class=
"org-rainbow-delimiters-depth-3">}</span><span class=
"org-rainbow-delimiters-depth-2">)</span>, root<span class=
"org-rainbow-delimiters-depth-1">)</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>.not.<span class=
"org-function-name">toThrow</span><span class=
"org-rainbow-delimiters-depth-3">()</span>

    <span class="org-function-name">expect</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-rainbow-delimiters-depth-4">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
      <span class="org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-function-name">h</span><span class=
"org-rainbow-delimiters-depth-2">(</span>Comp, <span class=
"org-rainbow-delimiters-depth-3">{</span> foo: <span class=
"org-constant">null</span> <span class=
"org-rainbow-delimiters-depth-3">}</span><span class=
"org-rainbow-delimiters-depth-2">)</span>, root<span class=
"org-rainbow-delimiters-depth-1">)</span>
    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>.not.<span class=
"org-function-name">toThrow</span><span class=
"org-rainbow-delimiters-depth-3">()</span>
  <span class="org-rainbow-delimiters-depth-2">}</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
              <p>FIX:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/runtime-core/src/componentProps.ts</span>
<span class=
"org-diff-hunk-header">@@ -529,7 +529,7 @@</span><span class=
"org-diff-function"> function validatePropName(key: string) {</span>
<span class=
"org-diff-context">// so that it works across vms / iframes.</span>
<span class=
"org-diff-context">function getType(ctor: Prop&lt;any&gt;): string {</span>
<span class=
"org-diff-context">  const match = ctor &amp;& ctor.toString().match(/^\s*function (\w+)/)</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  return match ? match[1] : ''</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  return match ? match[1] : </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">ctor === null ? 'null' :</span></span><span class="org-diff-added"> ''</span>
<span class="org-diff-context">}</span>

<span class=
"org-diff-context">function isSameType(a: Prop&lt;any&gt;, b: Prop&lt;any&gt;): boolean {</span>
<span class=
"org-diff-hunk-header">@@ -637,6 +637,8 @@</span><span class=
"org-diff-function"> function assertType(value: unknown, type: PropConstructor): AssertionResult {</span>
<span class="org-diff-context">    valid = isObject(value)</span>
<span class=
"org-diff-context">  } else if (expectedType === 'Array') {</span>
<span class="org-diff-context">    valid = isArray(value)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  } else if (expectedType === 'null') {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    valid = value === null</span>
<span class="org-diff-context">  } else {</span>
<span class=
"org-diff-context">    valid = value instanceof type</span>
<span class="org-diff-context">  }</span>
<span class=
"org-diff-hunk-header">@@ -656,7 +658,7 @@</span><span class=
"org-diff-function"> function getInvalidTypeMessage(</span>
<span class="org-diff-context">): string {</span>
<span class="org-diff-context">  let message =</span>
<span class=
"org-diff-context">    `Invalid prop: type check failed for prop "${name}".` +</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    ` Expected ${expectedTypes.map(capitalize).join(', ')}`</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    ` Expected ${expectedTypes.map(capitalize).join(' | ')}`</span>
<span class=
"org-diff-context">  const expectedType = expectedTypes[0]</span>
<span class=
"org-diff-context">  const receivedType = toRawType(value)</span>
<span class=
"org-diff-context">  const expectedValue = styleValue(value, expectedType)</span>

</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>scheduler: fix insertion for id-less job (<a href=
              "https://github.com/vuejs/vue-next/commit/d810a1a56943aeba5160b42bc917187e99cdfb8e">d810a1a</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4148">#4148</a></p>
              <p>scheduler 调试 job 过程中是按照 job.id 的大小来进行排序的，比如，队列中有三个
              job: <code>job1{id:5}, job4, job2{id:1}, job5,
              job3{id:3}</code> 最后当前队列中会有： <code>[job2, job1, job3,
              job4, job5]</code> 如果一个任务没有 id，会直接按照调用顺序逐个追加 到队列末尾,如
              job4, job5。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-core/src/scheduler.ts</span>
<span class=
"org-diff-hunk-header">@@ -10,6 +10,7 @@</span><span class=
"org-diff-function"> setComputedScheduler(queueJob)</span>
<span class=
"org-diff-context">export interface SchedulerJob extends Function {</span>
<span class="org-diff-context">  id?: number</span>
<span class="org-diff-context">  active?: boolean</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  computed?: boolean</span>
<span class="org-diff-context">  /**</span>
<span class=
"org-diff-context">   * Indicates whether the effect is allowed to recursively trigger itself</span>
<span class=
"org-diff-context">   * when managed by the scheduler.</span>
<span class=
"org-diff-hunk-header">@@ -70,16 +71,15 @@</span><span class=
"org-diff-function"> export function nextTick&lt;T = void&gt;(</span>
<span class=
"org-diff-context">// Use binary-search to find a suitable position in the queue,</span>
<span class=
"org-diff-context">// so that the queue maintains the increasing order of job's id,</span>
<span class=
"org-diff-context">// which can prevent the job from being skipped and also can avoid repeated patching.</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed"> function findInsertionIndex(</span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">job</span></span><span class=
"org-diff-removed">: </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">SchedulerJob</span></span><span class=
"org-diff-removed">) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> function findInsertionIndex(</span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">id</span></span><span class=
"org-diff-added">: </span><span class="org-diff-added"><span class=
"org-diff-refine-added">number</span></span><span class=
"org-diff-added">) {</span>
<span class=
"org-diff-context">  // the start index should be `flushIndex + 1`</span>
<span class="org-diff-context">  let start = flushIndex + 1</span>
<span class="org-diff-context">  let end = queue.length</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  const jobId = getId(job)</span>

<span class="org-diff-context">  while (start &lt; end) {</span>
<span class=
"org-diff-context">    const middle = (start + end) &gt;&gt;&gt; 1</span>
<span class=
"org-diff-context">    const middleJobId = getId(queue[middle])</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    middleJobId &lt; jobId ? (start = middle + 1) : (end = middle)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    middleJobId &lt; id ? (start = middle + 1) : (end = middle)</span>
<span class="org-diff-context">  }</span>

<span class="org-diff-context">  return start</span>
<span class=
"org-diff-hunk-header">@@ -100,11 +100,10 @@</span><span class=
"org-diff-function"> export function queueJob(job: SchedulerJob) {</span>
<span class="org-diff-context">      )) &amp;&</span>
<span class=
"org-diff-context">    job !== currentPreFlushParentJob</span>
<span class="org-diff-context">  ) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">const pos = findInsertionIndex(job)</span></span><span class="org-diff-refine-removed">
</span><span class="org-diff-indicator-removed"><span class=
"org-diff-refine-removed">-</span></span><span class=
"org-diff-removed">    if (</span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">pos &gt; -1) {</span></span><span class=
"org-diff-refine-removed">
</span><span class="org-diff-indicator-removed"><span class=
"org-diff-refine-removed">-</span></span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">      queue.splice(pos, 0,</span></span><span class="org-diff-removed"> job</span><span class="org-diff-removed"><span class="org-diff-refine-removed">)</span></span><span class="org-diff-refine-removed">
</span><span class="org-diff-indicator-removed"><span class=
"org-diff-refine-removed">-</span></span><span class=
"org-diff-removed">    </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">}</span></span><span class=
"org-diff-removed"> </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">else</span></span><span class=
"org-diff-removed"> {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    if (job</span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">.id</span></span><span class=
"org-diff-added"> </span><span class="org-diff-added"><span class=
"org-diff-refine-added">==</span></span><span class=
"org-diff-added"> </span><span class="org-diff-added"><span class=
"org-diff-refine-added">null)</span></span><span class=
"org-diff-added"> {</span>
<span class="org-diff-context">      queue.push(job)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    } else {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      queue.splice(findInsertionIndex(job.id), 0, job)</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">    queueFlush()</span>
<span class="org-diff-context">  }</span>
<span class=
"org-diff-hunk-header">@@ -253,6 +252,7 @@</span><span class=
"org-diff-function"> function flushJobs(seen?: CountMap) {</span>
<span class=
"org-diff-context">        if (__DEV__ &amp;& checkRecursiveUpdates(seen!, job)) {</span>
<span class="org-diff-context">          continue</span>
<span class="org-diff-context">        }</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        // console.log(`running:`, job.id)</span>
<span class=
"org-diff-context">        callWithErrorHandling(job, null, ErrorCodes.SCHEDULER)</span>
<span class="org-diff-context">      }</span>
    }
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>shared: normalizeStyle should handle strings
              (<a href=
              "https://github.com/vuejs/vue-next/commit/a8c3a8ad61b16a31f6754066838440a59ee9db8b">a8c3a8a</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4138">#4138</a></p>
              <p>问题： <code>&lt;h1 :style="`color: ${x};`"
              style=""&gt;Hello World!&lt;/h1&gt;</code></p>
              <p>修复：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/shared/src/normalizeProp.ts</span>
<span class=
"org-diff-hunk-header">@@ -18,6 +18,8 @@</span><span class=
"org-diff-function"> export function normalizeStyle(value: unknown): NormalizedStyle | undefined {</span>
<span class="org-diff-context">      }</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">    return res</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  } else if (isString(value)) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    return parseStringStyle(value)</span>
<span class=
"org-diff-context">  } else if (isObject(value)) {</span>
<span class="org-diff-context">    return value</span>
  }
</pre>
              </div>
              <p>源码：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">listDelimiterRE</span> = <span class=
                "org-string">/;(?![^(]*\))/</span>g
<span class="org-keyword">const</span> <span class=
"org-variable-name">propertyDelimiterRE</span> = <span class=
"org-string">/:(.+)/</span>

<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseStringStyle</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-variable-name">cssText</span>: <span class=
"org-typescript-primitive">string</span><span class=
"org-rainbow-delimiters-depth-1">)</span>: <span class=
"org-type">NormalizedStyle</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">ret</span>: <span class=
"org-type">NormalizedStyle</span> = <span class=
"org-rainbow-delimiters-depth-2">{}</span>
  cssText.<span class="org-function-name">split</span><span class=
"org-rainbow-delimiters-depth-2">(</span>listDelimiterRE<span class="org-rainbow-delimiters-depth-2">)</span>.<span class="org-function-name">forEach</span><span class="org-rainbow-delimiters-depth-2">(</span>item <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-3">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>item<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
      <span class="org-keyword">const</span> <span class=
"org-variable-name">tmp</span> = item.<span class=
"org-function-name">split</span><span class=
"org-rainbow-delimiters-depth-1">(</span>propertyDelimiterRE<span class="org-rainbow-delimiters-depth-1">)</span>
      tmp.length &gt; <span class=
"org-highlight-numbers-number">1</span> &amp;& <span class=
"org-rainbow-delimiters-depth-1">(</span>ret<span class=
"org-rainbow-delimiters-depth-2">[</span>tmp<span class=
"org-rainbow-delimiters-depth-3">[</span><span class=
"org-highlight-numbers-number">0</span><span class=
"org-rainbow-delimiters-depth-3">]</span>.<span class=
"org-function-name">trim</span><span class=
"org-rainbow-delimiters-depth-3">()</span><span class=
"org-rainbow-delimiters-depth-2">]</span> = tmp<span class=
"org-rainbow-delimiters-depth-2">[</span><span class=
"org-highlight-numbers-number">1</span><span class=
"org-rainbow-delimiters-depth-2">]</span>.<span class=
"org-function-name">trim</span><span class=
"org-rainbow-delimiters-depth-2">()</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
    <span class="org-rainbow-delimiters-depth-4">}</span>
  <span class="org-rainbow-delimiters-depth-3">}</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
  <span class="org-keyword">return</span> ret
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>ssr: update initial old value to watch callback in
              ssr usage (<a href=
              "https://github.com/vuejs/vue-next/issues/4103">#4103</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/20b6619793702d265fcc3a7c099f5764fa9d8685">20b6619</a>)
              问题： 指定 <code>immediate: true</code> 时候会立即执行一次，然而此时
              oldValue 是 undefined 会导致 callback([…], [oldA, oldB])
              解构错误(<code>undefined -&gt; [oldA, oldB]</code>)</p>
              <div class="org-src-container">
                <pre class="src src-js">setup(){
  <span class="org-keyword">const</span> <span class=
"org-variable-name">a</span> = ref(<span class=
"org-highlight-numbers-number">1</span>)
  <span class="org-keyword">const</span> <span class=
"org-variable-name">b</span> = ref(<span class=
"org-highlight-numbers-number">2</span>)
  watch([a, b], ([newA, newB], [oldA, oldB]) =&gt; {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
  }, { deep: <span class=
"org-constant">true</span>, immediate: <span class=
"org-constant">true</span> })
}
</pre>
              </div>
              <p>修复： 检查被 watch 的源数据，如果是数据 oldValue 初始化成
              <code>[]</code></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-core/src/apiWatch.ts</span>
<span class=
"org-diff-hunk-header">@@ -265,7 +265,7 @@</span><span class=
"org-diff-function"> function doWatch(</span>
<span class="org-diff-context">    } else if (immediate) {</span>
<span class=
"org-diff-context">      callWithAsyncErrorHandling(cb, instance, ErrorCodes.WATCH_CALLBACK, [</span>
<span class="org-diff-context">        getter(),</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">        undefined,</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">isMultiSource ? [] :</span></span><span class="org-diff-added"> undefined,</span>
<span class="org-diff-context">        onInvalidate</span>
<span class="org-diff-context">      ])</span>
    }
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>v-model: properly detect input type=number
              (<a href=
              "https://github.com/vuejs/vue-next/commit/3056e9b3dcb1ab0bd18227c6fa7bf283f98f6ef6">3056e9b</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3813">#3813</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-dom/src/directives/vModel.ts</span>
<span class=
"org-diff-hunk-header">@@ -49,7 +49,8 @@</span><span class=
"org-diff-function"> export const vModelText: ModelDirective&lt;</span>
<span class="org-diff-indicator-added">&gt;</span><span class=
"org-diff-added"> = {</span>
<span class=
"org-diff-context">  created(el, { modifiers: { lazy, trim, number } }, vnode) {</span>
<span class=
"org-diff-context">    el._assign = getModelAssigner(vnode)</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    const castToNumber = number || el.type === 'number'</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    const castToNumber =</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      number || (vnode.props &amp;& vnode.props.type === 'number')</span>
<span class=
"org-diff-context">    addEventListener(el, lazy ? 'change' : 'input', e =&gt; {</span>
<span class=
"org-diff-context">      if ((e.target as any).composing) return</span>
      let domValue: string | number = el.value
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org3b3a7ab" class="outline-3">
        <h3 id="org3b3a7ab"><span class=
        "section-number-3">13.2.</span> Features
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-13-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler: allow ’comments’ option to affect
              comment inclusion in dev (<a href=
              "https://github.com/vuejs/vue-next/issues/4115">#4115</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/dd0f9d1ce6b0de59c84d334c7190fa9d2cc17a04">dd0f9d1</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3392">#3392</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/3395">#3395</a>
              <span id="dd0f9d1"></span></p>
              <p>由 <code>__DEV__</code> 值决定 comments 是否保留。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: add <a href=
              "#ignore-empty-blocks">ignoreEmpty</a> option for sfc
              parse method (<a href=
              "https://github.com/vuejs/vue-next/commit/8dbecfcbb3d597a644d0f263dfd6d7fcfd23a9fb">8dbecfc</a>)</p>
              <p>支持 sfc <code>parse(src, { ignoreEmpty: true/false
              })</code> 来决定是否忽略空的 script 和 style</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>types: map declared emits to onXXX props in
              inferred prop types (<a href=
              "https://github.com/vuejs/vue-next/issues/3926">#3926</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/69344ff1ae724beb648c34ede8050b3b70ddf4b7">69344ff</a>)
              <span id="69344ff"></span></p>
              <p>emits 事件绑定的函数类型推导。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/runtime-core/src/componentEmits.ts</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> export type EmitsToProps&lt;T extends EmitsOptions&gt; = T extends string[]</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  ? {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      [K in string & `on${Capitalize&lt;T[number]&gt;}`]?: (...args: any[]) =&gt; any</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    }</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  : T extends ObjectEmitsOptions</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  ? {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      [K in string &</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        `on${Capitalize&lt;string & keyof T&gt;}`]?: K extends `on${infer C}`</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        ? T[Uncapitalize&lt;C&gt;] extends null</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">          ? (...args: any[]) =&gt; any</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">          : T[Uncapitalize&lt;C&gt;]</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        : never</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    }</span>
+  : {}
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">  const MyComponent = defineComponent({</span>
<span class=
"org-diff-context">    mixins: [MixinA, MixinB, MixinC, MixinD],</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    emits: ['click'],</span>
<span class="org-diff-context">    props: {</span>
<span class=
"org-diff-context">      // required should make property non-void</span>
<span class="org-diff-context">      z: {</span>
<span class=
"org-diff-hunk-header">@@ -552,6 +554,9 @@</span><span class=
"org-diff-function"> describe('with mixins', () =&gt; {</span>
<span class="org-diff-context">    setup(props) {</span>
<span class=
"org-diff-context">      expectType&lt;string&gt;(props.z)</span>
<span class="org-diff-context">      // props</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      expectType&lt;((...args: any[]) =&gt; any) | undefined&gt;(props.onClick)</span>
<span class="org-diff-context">      // from Base</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      expectType&lt;((...args: any[]) =&gt; any) | undefined&gt;(props.onBar)</span>
<span class=
"org-diff-context">      expectType&lt;string&gt;(props.aP1)</span>
<span class=
"org-diff-context">      expectType&lt;boolean | undefined&gt;(props.aP2)</span>
      expectType&lt;any&gt;(props.bP1)
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org2065767" class="outline-3">
        <h3 id="org2065767"><span class=
        "section-number-3">13.3.</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-13-3">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: ignore empty blocks (<a href=
              "https://github.com/vuejs/vue-next/issues/3520">#3520</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/b771fdbef9a8dadd4c9cc939cc104f7764e40373">b771fdb</a>)
              <span id="ignore-empty-blocks"></span></p>
              <p>忽略 SFC 中的空标签。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">packages/compiler-sfc/src/parse.ts</span>
<span class=
"org-diff-hunk-header">@@ -162,7 +162,8 @@</span><span class=
"org-diff-function"> export function parse(</span>
<span class=
"org-diff-context">    if (node.type !== NodeTypes.ELEMENT) {</span>
<span class="org-diff-context">      return</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">if</span></span><span class=
"org-diff-removed"> </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">(!node.children.length</span></span><span class="org-diff-removed"> </span><span class="org-diff-removed"><span class="org-diff-refine-removed">&amp;&</span></span><span class="org-diff-removed"> </span><span class="org-diff-removed"><span class="org-diff-refine-removed">!hasSrc</span></span><span class="org-diff-removed">(</span><span class="org-diff-removed"><span class="org-diff-refine-removed">node</span></span><span class="org-diff-removed">) </span><span class="org-diff-removed"><span class="org-diff-refine-removed">&amp;&</span></span><span class="org-diff-removed"> node.tag !== 'template') {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">//</span></span><span class=
"org-diff-added"> </span><span class="org-diff-added"><span class=
"org-diff-refine-added">we</span></span><span class=
"org-diff-added"> </span><span class="org-diff-added"><span class=
"org-diff-refine-added">only want to keep the nodes that are not empty</span></span><span class="org-diff-added"> (</span><span class="org-diff-added"><span class="org-diff-refine-added">when the tag is not a template</span></span><span class="org-diff-added">)</span>
<span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added">    </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">if (</span></span><span class=
"org-diff-added">node.tag !== 'template' </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">&amp;& isEmpty(node) &amp;& !hasSrc(node)</span></span><span class="org-diff-added">) {</span>
<span class="org-diff-context">      return</span>
<span class="org-diff-context">    }</span>
<span class="org-diff-context">    switch (node.tag) {</span>
<span class=
"org-diff-hunk-header">@@ -415,3 +416,15 @@</span><span class=
"org-diff-function"> function hasSrc(node: ElementNode) {</span>
<span class="org-diff-context">    return p.name === 'src'</span>
<span class="org-diff-context">  })</span>
<span class="org-diff-context">}</span>
<span class="org-diff-indicator-added">+</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> /**</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> * Returns true if the node has no children</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> * once the empty text nodes (trimmed content) have been filtered out.</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> */</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> function isEmpty(node: ElementNode) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  return (</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    node.children.filter(</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      child =&gt; child.type !== NodeTypes.TEXT || child.content.trim() !== ''</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    ).length === 0</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  )</span>
+ }
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> =
      process.env.VNEXT_PKG_RC + <span class=
"org-string">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">"stb-"</span>, <span class="org-string">""</span>));
<span class=
"org-keyword">const</span> { compileScript, parse } = value;

<span class="org-keyword">const</span> <span class=
"org-variable-name">_</span> = (title, src) =&gt; {
  <span class=
"org-keyword">const</span> { descriptor: { script, styles, template } } = parse(src)
  console.log(title, <span class=
"org-string">'\n'</span>, script, styles, template.content)
}


_(<span class="org-string">'empty tag'</span>, <span class=
"org-string">`&lt;template&gt;</span>
<span class="org-string">  &lt;h1&gt;{{ msg }}&lt;/h1&gt;</span>
<span class="org-string">&lt;/template&gt;</span>

<span class="org-string">&lt;script setup&gt;</span>

<span class="org-string">&lt;/script&gt;</span>

<span class="org-string">&lt;style scoped&gt;</span>

<span class="org-string">&lt;/style&gt;`</span>)
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org1572178" class="outline-2">
      <h2 id="org1572178"><span class="section-number-2">14.</span>
      3.2.0-beta.1</h2>
      <div class="outline-text-2" id="text-14">
        <ol class="org-ol">
          <li>
            <b><span style="color:green;">ADD</span></b>:
            <code>defineCustomElement</code> 结合
            <code>window.customElements</code> 来定义元素 <a class=
            "anchor" aria-hidden="true" id="defineCustomElement"
            href="#defineCustomElement"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b>*<span style="color:green;">ADD</span></b>:
            <abbr class="tooltip" title=
            "&lt;strong&gt;3.2+&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any[]&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;Memoize a sub-tree of the template. Can be used on both elements and components.&lt;br&gt;The directive expects a fixed-length array of dependency values to compare for&lt;br&gt;the memoization. If every value in the array was the same as last render, then&lt;br&gt;updates for the entire sub-tree will be skipped. For example:&lt;br&gt;&lt;br&gt;&lt;div v-memo=''[valueA, valueB]''&gt;&lt;br&gt; ...&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component re-renders, if both valueA and valueB remain the same, all&lt;br&gt;updates for this &lt;div&gt; and its children will be skipped. In fact, even the&lt;br&gt;Virtual DOM VNode creation will also be skipped since the memoized copy of the&lt;br&gt;sub-tree can be reused.&lt;br&gt;&lt;br&gt;It is important to specify the memoization array correctly, otherwise we may&lt;br&gt;skip updates that should indeed be applied. v-memo with an empty dependency&lt;br&gt;array (v-memo=''[]'') would be functionally equivalent to v-once.&lt;br&gt;&lt;br&gt;Usage with v-for&lt;br&gt;&lt;br&gt;v-memo is provided solely for micro optimizations in performance-critical&lt;br&gt;scenarios and should be rarely needed. The most common case where this may prove&lt;br&gt;helpful is when rendering large v-for lists (where length &gt; 1000):&lt;br&gt;&lt;br&gt;&lt;div v-for=''item in list'' :key=''item.id'' v-memo=''[item.id === selected]''&gt;&lt;br&gt; &lt;p&gt;ID: {{ item.id }} - selected: {{ item.id === selected }}&lt;/p&gt;&lt;br&gt; &lt;p&gt;...more child nodes&lt;/p&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component's selected state changes, a large amount of VNodes will be&lt;br&gt;created even though most of the items remained exactly the same. The v-memo&lt;br&gt;usage here is essentially saying ''only update this item if it went from&lt;br&gt;non-selected to selected, or the other way around''. This allows every unaffected&lt;br&gt;item to reuse its previous VNode and skip diffing entirely. Note we don't need&lt;br&gt;to include item.id in the memo dependency array here since Vue automatically&lt;br&gt;infers it from the item's :key.&lt;br&gt;&lt;br&gt;WARNING&lt;br&gt;&lt;br&gt;When using v-memo with v-for, make sure they are used on the same element.&lt;br&gt;v-memo does not work inside v-for.&lt;br&gt;&lt;br&gt;v-memo can also be used on components to manually prevent unwanted updates in&lt;br&gt;certain edge cases where the child component update check has been de-optimized.&lt;br&gt;But again, it is the developer's responsibility to specify correct dependency&lt;br&gt;arrays to avoid skipping necessary updates.&lt;br&gt;&lt;br&gt;See also:&lt;br&gt;&lt;br&gt;v-once (https://vuejs.org/api/built-in-directives.html#v-once)">
            v-memo</abbr> 指令可以指定哪些条件下组件需要更新 <a class="anchor"
            aria-hidden="true" id="v-memo" href=
            "#v-memo"><svg xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 16 16" width="16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b>*<span style="color:green;">ADD</span></b>:
            <code>watchPostEffect</code> 等价于 <code>doWatch(effect,
            null/*cb*/, { flush: 'post' })</code> <a class="anchor"
            aria-hidden="true" id="watchPostEffect" href=
            "#watchPostEffect"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li><b>*<span style="color:green;">ADD</span></b>:
          <code>effectScope</code></li>
          <li>
            <p><b>*<span style="color:green;">ADD</span></b>: ref
            新语法糖 <code>$ref()</code> 等价于 <code>ref()</code>,
            只是不再需要手动从 <code>vue</code> import 了</p>
            <p>之前： <code>&lt;script setup&gt;import { ref } from
            'vue'; var val = ref(1);&lt;/script&gt;</code></p>
            <p>之后： <code>&lt;script setup&gt;var val =
            $ref(1);&lt;/script&gt;</code></p>
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: 使用了
            <a href="file:///web/javascript-api-mutationobserver">MutationObserver</a>
            来解决 <code>cssVar + transition + v-if</code> 时 cssVar 不正
            常生效问题
          </li>
          <li><b><span style="color:pink;">CHG</span></b>:
          <code>ReactiveEffect</code> 改成了 class 来实现，因此 effect
          不再是函数，而是一个 <code>ReactiveEffect</code> 实例对象。</li>
        </ol>
      </div>
      <div id="outline-container-orge5e76ad" class="outline-3">
        <h3 id="orge5e76ad"><span class=
        "section-number-3">14.1.</span> Code Refactoring(代码重构)
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-14-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>remove deprecated scopeId codegen (<a href=
              "https://github.com/vuejs/vue-next/commit/f596e008efd97fe8f9b28f536fbb0fd48b9b6333">f596e00</a>)</p>
              <p>生成的 render 没有 scope id 了 ?</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-indicator-removed">-</span><span class=
                "org-diff-removed"> export const render = /*#__PURE__*/_withId((_ctx, _cache) =&gt; {</span>
+ export function render(_ctx, _cache) {
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org5b5081d" class="outline-3">
        <h3 id="org5b5081d"><span class=
        "section-number-3">14.2.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-14-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>sfc/style-vars: properly re-apply style vars on
              component root elements change (<a href=
              "https://github.com/vuejs/vue-next/commit/49dc2dd1e4a56d0d2ad28003240c99e99ef469e4">49dc2dd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3894">#3894</a>
              <span id="MutationObserver"></span></p>
              <p>在使用 <code>&lt;transition&gt;</code> 和
              <code>v-if</code> 时， <code>SFC &lt;style&gt;</code>
              中的 <code>v-bind(color)</code> 没起作用？</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">// packages/runtime-dom/src/helpers/useCssVars.ts</span>
<span class=
"org-diff-context">// @@ -27,8 +27,12 @@ export function useCssVars(getter: (ctx: any) =&gt; Record&lt;string, string&gt;) {</span>
<span class="org-diff-context">  const setVars = () =&gt;</span>
<span class=
"org-diff-context">    setVarsOnVNode(instance.subTree, getter(instance.proxy!))</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  onMounted(() =&gt; watchEffect(setVars, { flush: 'post' }))</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  onUpdated(setVars)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  watchPostEffect(setVars)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  onMounted(() =&gt; {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    const ob = new MutationObserver(setVars)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    ob.observe(instance.subTree.el!.parentNode, { childList: true })</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    onUnmounted(() =&gt; ob.disconnect())</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  })</span>
}
</pre>
              </div>
              <p>涉及函数： <code>watchPostEffect(setVars)</code> 和
              <code>MutationObserver(setVars)</code> 的使用。</p>
              <p>watchPostEffect 是监听 instance.subTree 状态的变化时执行
              <code>setVars -&gt; setVarsOnVNode</code></p>
              <p>MutationObserver 是 JavaScript 的原生 API
              ，详情可查看<a href=
              "http://localhost:1313/web/javascript-api-mutationobserver/">此文
              JavaScript API - MutationObserver</a> 。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>ensure customElements API ssr compatibility
              (<a href=
              "https://github.com/vuejs/vue-next/commit/de32cfa43e94276c60f93ac4c560cb7b84534cfe">de32cfa</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4129">#4129</a></p>
              <p>解决 SSR 服务端渲染时不支持 <code>HTMLElement</code> 的问题。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">// packages/runtime-dom/src/apiCustomElement.ts</span>
<span class=
"org-diff-hunk-header">@@ -157,7 +157,11 @@</span><span class=
"org-diff-function"> export const defineSSRCustomElement = ((options: any) =&gt; {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed"> export class VueElement extends HTMLElement {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> const BaseClass = (typeof HTMLElement !== 'undefined'</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  ? HTMLElement</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  : class {}) as typeof HTMLElement</span>

<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> export class VueElement extends BaseClass {</span>
<span class="org-diff-context">  /**</span>
<span class="org-diff-context">   * @internal</span>
   */
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: fix default shapeFlag for fragments
              (<a href=
              "https://github.com/vuejs/vue-next/commit/2a310df7531a693be706a96d4191a5bfbf24692d">2a310df</a>)</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">  dynamicProps: string[] | null = null,</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  shapeFlag = ShapeFlags.ELEMENT,</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  shapeFlag = type === Fragment ? 0 : ShapeFlags.ELEMENT,</span>
  isBlockNode = false,
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>ignore .prop/.attr modifiers in ssr (<a href=
              "https://github.com/vuejs/vue-next/commit/29732c2c8681cc3e58251c19149ba3a0ce31cdaf">29732c2</a>)</p>
              <p>忽略 SSR 中的 .prop/.attr 因为这两个的作用是决定该属性是做为 DOM 元素的
              attribute 存在还是以 <code>element.prop = value</code>
              元素对象的属性存在。不管是哪种情况都 和实际的 DOM 元素有关。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">// packages/compiler-core/src/transforms/vBind.ts</span>
<span class=
"org-diff-hunk-header">@@ -37,12 +37,13 @@</span><span class=
"org-diff-function"> export const transformBind: DirectiveTransform = (dir, _node, context) =&gt; {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  if (modifiers.includes('prop')) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    injectPrefix(arg, '.')</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  }</span>

<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  if (modifiers.includes('attr')) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    injectPrefix(arg, '^')</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  if (!context.inSSR) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    if (modifiers.includes('prop')) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      injectPrefix(arg, '.')</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    }</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    if (modifiers.includes('attr')) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      injectPrefix(arg, '^')</span>
+    }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org6ba2ce7" class="outline-3">
        <h3 id="org6ba2ce7"><span class=
        "section-number-3">14.3.</span> Features
        <code>[10/10]</code></h3>
        <div class="outline-text-3" id="text-14-3">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href=
              "file:///vue/vue-update-3.2/#new-ref-sugar">sfc:
              (experimental) new ref sugar</a> (<a href=
              "https://github.com/vuejs/vue-next/commit/562bddb3ce76a0e98e499e199e96fa4271e5d1b4">562bddb</a>)
              <span id="sfc-ref-sugar"></span>
            </li>
            <li class="on">
              <code>[X]</code> sfc: support namespaced component
              tags when using &lt;script setup&gt; (<a href=
              "https://github.com/vuejs/vue-next/commit/e5a4412764f6db255afe01b8a7e6e40ebf707412">e5a4412</a>)
              <span id="e5a4412"></span>
            </li>
            <li class="on">
              <code>[X]</code> custom element reflection, casting
              and edge cases (<a href=
              "https://github.com/vuejs/vue-next/commit/00f0b3c46552626cd7c5ec73ffd0a918c3e1a5fb">00f0b3c</a>)
              <span id="custom-element-refection"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>remove experimental status of &lt;script setup&gt;
              (<a href=
              "https://github.com/vuejs/vue-next/commit/00f0b3c46552626cd7c5ec73ffd0a918c3e1a5fb">27104ea</a>)
              <span id="27104ea"></span></p>
              <p>正式发布 <code>&lt;script setup&gt;</code></p>
            </li>
            <li class="on">
              <code>[X]</code> support v-bind .prop & .attr
              modifiers (<a href=
              "https://github.com/vuejs/vue-next/commit/8610e1c9e23a4316f76fb35eebbab4ad48566fbf">1c7d737</a>)
              <span id="1c7d737"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: defineCustomElement (<a href=
              "https://github.com/vuejs/vue-next/commit/8610e1c9e23a4316f76fb35eebbab4ad48566fbf">8610e1c</a>)
              <span id="defineCustomElement"></span> <span id=
              "8610e1c"></span></p>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/component.ts">
              runtime-core/src/component.ts:</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">interface</span> <span class=
                "org-type">ComponentInternalInstance</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">/**</span>
<span class="org-comment">   * is custom element?</span>
<span class="org-comment">   */</span>
  isCE?: <span class="org-typescript-primitive">boolean</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">createComponentInstance</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">...*/</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">交给 vnode.ce 去处理</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">apply custom element special handling</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>vnode.ce<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    vnode.<span class="org-function-name">ce</span><span class=
"org-rainbow-delimiters-depth-3">(</span>instance<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/helpers/renderSlot.ts">
              runtime-core/src/helpers/renderSlot.ts</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">renderSlot</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-comment-delimiter">/*</span><span class=
                "org-comment">...*/</span><span class=
                "org-rainbow-delimiters-depth-1">)</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>currentRenderingInstance!.isCE<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class=
"org-function-name">createVNode</span><span class=
"org-rainbow-delimiters-depth-3">(</span>
      <span class="org-string">'slot'</span>,
      name === <span class=
"org-string">'default'</span> ? <span class=
"org-constant">null</span> : <span class=
"org-rainbow-delimiters-depth-4">{</span> name <span class=
"org-rainbow-delimiters-depth-4">}</span>,
      fallback &amp;& <span class=
"org-function-name">fallback</span><span class=
"org-rainbow-delimiters-depth-4">()</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <div>
                测试结果 <button onclick=
                "showCode('rhBIQi');">查看源码</button>
              </div>
              <div id="rhBIQi" class="comment-block"></div>
              <script id="s_rhBIQi">
              const p_rhBIQi = document.getElementById('rhBIQi')
              const cr = document.createElement('div')
              p_rhBIQi.appendChild(cr)
              const E = Vue.defineCustomElement({
              render: () => Vue.h('div', 'hello')
              })
              customElements.define('my-element', E)
              cr.innerHTML = "<my-element></my-element>"
              const e = cr.childNodes[0]
              console.log(e, e instanceof E)
              console.log(e._instance)
              console.log(e.shadowRoot.innerHTML)
              </script>
            </li>
            <li class="on">
              <code>[X]</code>
              <p><abbr class="tooltip" title=
              "&lt;strong&gt;3.2+&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any[]&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;Memoize a sub-tree of the template. Can be used on both elements and components.&lt;br&gt;The directive expects a fixed-length array of dependency values to compare for&lt;br&gt;the memoization. If every value in the array was the same as last render, then&lt;br&gt;updates for the entire sub-tree will be skipped. For example:&lt;br&gt;&lt;br&gt;&lt;div v-memo=''[valueA, valueB]''&gt;&lt;br&gt; ...&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component re-renders, if both valueA and valueB remain the same, all&lt;br&gt;updates for this &lt;div&gt; and its children will be skipped. In fact, even the&lt;br&gt;Virtual DOM VNode creation will also be skipped since the memoized copy of the&lt;br&gt;sub-tree can be reused.&lt;br&gt;&lt;br&gt;It is important to specify the memoization array correctly, otherwise we may&lt;br&gt;skip updates that should indeed be applied. v-memo with an empty dependency&lt;br&gt;array (v-memo=''[]'') would be functionally equivalent to v-once.&lt;br&gt;&lt;br&gt;Usage with v-for&lt;br&gt;&lt;br&gt;v-memo is provided solely for micro optimizations in performance-critical&lt;br&gt;scenarios and should be rarely needed. The most common case where this may prove&lt;br&gt;helpful is when rendering large v-for lists (where length &gt; 1000):&lt;br&gt;&lt;br&gt;&lt;div v-for=''item in list'' :key=''item.id'' v-memo=''[item.id === selected]''&gt;&lt;br&gt; &lt;p&gt;ID: {{ item.id }} - selected: {{ item.id === selected }}&lt;/p&gt;&lt;br&gt; &lt;p&gt;...more child nodes&lt;/p&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component's selected state changes, a large amount of VNodes will be&lt;br&gt;created even though most of the items remained exactly the same. The v-memo&lt;br&gt;usage here is essentially saying ''only update this item if it went from&lt;br&gt;non-selected to selected, or the other way around''. This allows every unaffected&lt;br&gt;item to reuse its previous VNode and skip diffing entirely. Note we don't need&lt;br&gt;to include item.id in the memo dependency array here since Vue automatically&lt;br&gt;infers it from the item's :key.&lt;br&gt;&lt;br&gt;WARNING&lt;br&gt;&lt;br&gt;When using v-memo with v-for, make sure they are used on the same element.&lt;br&gt;v-memo does not work inside v-for.&lt;br&gt;&lt;br&gt;v-memo can also be used on components to manually prevent unwanted updates in&lt;br&gt;certain edge cases where the child component update check has been de-optimized.&lt;br&gt;But again, it is the developer's responsibility to specify correct dependency&lt;br&gt;arrays to avoid skipping necessary updates.&lt;br&gt;&lt;br&gt;See also:&lt;br&gt;&lt;br&gt;v-once (https://vuejs.org/api/built-in-directives.html#v-once)">
              v-memo</abbr> 可以指定什么条件下组件会被重新渲染，否则使用缓存结果 (<a href=
              "https://github.com/vuejs/vue-next/commit/3b64508e3b2d648e346cbf34e1641f4022be61b6">3b64508</a>)
              <span id="v-memo"></span> <span id=
              "3b64508"></span></p>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/compiler-core/src/transforms/vFor.ts">
              compiler-core/src/transforms/vFor.ts</a>
              中增加的核心代码：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-comment-delimiter">// </span><span class=
                "org-comment">v-memo</span>
<span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>memo<span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">loop</span> = <span class=
"org-function-name">createFunctionExpression</span><span class=
"org-rainbow-delimiters-depth-2">(</span>
    <span class=
"org-function-name">createForLoopParams</span><span class=
"org-rainbow-delimiters-depth-3">(</span>forNode.parseResult, <span class="org-rainbow-delimiters-depth-4">[</span>
      <span class=
"org-function-name">createSimpleExpression</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-string">`_cached`</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
    <span class=
"org-rainbow-delimiters-depth-4">]</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>
  loop.body = <span class=
"org-function-name">createBlockStatement</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">[</span>
    <span class=
"org-function-name">createCompoundExpression</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-rainbow-delimiters-depth-1">[</span><span class=
"org-string">`const _memo = (`</span>, memo.exp!, <span class=
"org-string">`)`</span><span class=
"org-rainbow-delimiters-depth-1">]</span><span class=
"org-rainbow-delimiters-depth-4">)</span>,
    <span class=
"org-function-name">createCompoundExpression</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-rainbow-delimiters-depth-1">[</span>
      <span class="org-string">`if (_cached`</span>,
      ...<span class=
"org-rainbow-delimiters-depth-2">(</span>keyExp ? <span class=
"org-rainbow-delimiters-depth-3">[</span><span class=
"org-string">` &amp;& _cached.key === `</span>, keyExp<span class=
"org-rainbow-delimiters-depth-3">]</span> : <span class=
"org-rainbow-delimiters-depth-3">[]</span><span class=
"org-rainbow-delimiters-depth-2">)</span>,
      <span class=
"org-string">` &amp;& ${context.helperString(</span>
<span class="org-string">IS_MEMO_SAME</span>
<span class=
"org-string">)}(_cached.memo, _memo)) return _cached`</span>
    <span class=
"org-rainbow-delimiters-depth-1">]</span><span class=
"org-rainbow-delimiters-depth-4">)</span>,
    <span class=
"org-function-name">createCompoundExpression</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-rainbow-delimiters-depth-1">[</span><span class=
"org-string">`const _item = `</span>, childBlock <span class=
"org-keyword">as</span> <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-1">]</span><span class=
"org-rainbow-delimiters-depth-4">)</span>,
    <span class=
"org-function-name">createSimpleExpression</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-string">`_item.memo = _memo`</span><span class=
"org-rainbow-delimiters-depth-4">)</span>,
    <span class=
"org-function-name">createSimpleExpression</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-string">`return _item`</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
  <span class="org-rainbow-delimiters-depth-3">]</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
  renderExp.<span class=
"org-constant">arguments</span>.<span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span>
    loop <span class="org-keyword">as</span> ForIteratorExpression,
    <span class=
"org-function-name">createSimpleExpression</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-string">`_cache`</span><span class=
"org-rainbow-delimiters-depth-3">)</span>,
    <span class=
"org-function-name">createSimpleExpression</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-function-name">String</span><span class=
"org-rainbow-delimiters-depth-4">(</span>context.cached++<span class="org-rainbow-delimiters-depth-4">)</span><span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  renderExp.<span class=
"org-constant">arguments</span>.<span class="org-function-name">push</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-function-name">createFunctionExpression</span><span class="org-rainbow-delimiters-depth-3">(</span>
    <span class=
"org-function-name">createForLoopParams</span><span class=
"org-rainbow-delimiters-depth-4">(</span>forNode.parseResult<span class="org-rainbow-delimiters-depth-4">)</span>,
    childBlock,
    <span class="org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">force newline */</span>
  <span class=
"org-rainbow-delimiters-depth-3">)</span> <span class="org-keyword">as</span> ForIteratorExpression<span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>如：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../compiler-core/dist/compiler-core.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class="org-keyword">const</span> { baseCompile } = value

<span class="org-keyword">const</span> <span class=
"org-variable-name">compile</span> = c =&gt; baseCompile(<span class="org-string">`&lt;div&gt;${c}&lt;/div&gt;`</span>, {
  mode: <span class="org-string">"module"</span>,
  prefixIdentifiers: <span class="org-constant">true</span>
}).code

<span class="org-keyword">function</span> <span class=
"org-function-name">test</span>(<span class=
"org-variable-name">title</span>, <span class=
"org-variable-name">code</span>, <span class=
"org-variable-name">options</span>) {
  console.log(<span class="org-string">'// &gt; '</span> + title)
  console.log(compile(code))
}

console.log(<span class=
"org-string">'// &gt; on root element'</span>)
console.log(  baseCompile(<span class=
"org-string">`&lt;div v-memo="[x]"&gt;&lt;/div&gt;`</span>, {
  mode: <span class="org-string">'module'</span>,
  prefixIdentifiers: <span class="org-constant">true</span>
}).code)

test(<span class=
"org-string">'on normal element'</span>, <span class=
"org-string">`&lt;div v-memo="[x]"&gt;&lt;/div&gt;`</span>)
test(<span class=
"org-string">'on template v-for'</span>, <span class=
"org-string">`&lt;template v-for="{ x, y } in list" :key="x" v-memo="[x, y === z]"&gt;</span>
<span class=
"org-string">          &lt;span&gt;foobar&lt;/span&gt;</span>
<span class="org-string">        &lt;/template&gt;`</span>)
<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
</pre>
              </div>
              <p>_withMemo -&gt; <a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/helpers/withMemo.ts">
              runtime-core/src/helpers/withMemo.ts:withMemo</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">withMemo</span><span class=
                "org-rainbow-delimiters-depth-1">(</span>
  memo: <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-2">[]</span>,
  render: <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> VNode&lt;<span class=
"org-typescript-primitive">any</span>, <span class=
"org-typescript-primitive">any</span>&gt;,
  cache: <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-2">[]</span>,
  index: <span class="org-typescript-primitive">number</span>
<span class="org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">cached</span> = cache<span class=
"org-rainbow-delimiters-depth-2">[</span>index<span class=
"org-rainbow-delimiters-depth-2">]</span> <span class=
"org-keyword">as</span> VNode | <span class=
"org-constant">undefined</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>cached &amp;& <span class=
"org-function-name">isMemoSame</span><span class=
"org-rainbow-delimiters-depth-3">(</span>cached, memo<span class=
"org-rainbow-delimiters-depth-3">)</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> cached
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">ret</span> = <span class=
"org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-2">()</span>

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">shallow clone</span>
  ret.memo = memo.<span class=
"org-function-name">slice</span><span class=
"org-rainbow-delimiters-depth-2">()</span>
  <span class="org-keyword">return</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>cache<span class=
"org-rainbow-delimiters-depth-3">[</span>index<span class=
"org-rainbow-delimiters-depth-3">]</span> = ret<span class=
"org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>判断不重新渲染条件(memo 长度和元素的值必须一致)：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">isMemoSame</span><span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-variable-name">cached</span>: <span class=
                "org-type">VNode</span>, <span class=
                "org-variable-name">memo</span>: <span class=
                "org-typescript-primitive">any</span><span class=
                "org-rainbow-delimiters-depth-2">[]</span><span class=
                "org-rainbow-delimiters-depth-1">)</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">prev</span>: <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-2">[]</span> = cached.memo!
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>prev.length != memo.length<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">return</span> <span class=
"org-constant">false</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; <span class=
"org-type">prev</span>.<span class=
"org-type">length</span>; <span class=
"org-type">i</span>++<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>prev<span class=
"org-rainbow-delimiters-depth-4">[</span>i<span class=
"org-rainbow-delimiters-depth-4">]</span> !== memo<span class=
"org-rainbow-delimiters-depth-4">[</span>i<span class=
"org-rainbow-delimiters-depth-4">]</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">return</span> <span class=
"org-constant">false</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">make sure to let parent block track it when returning cached</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>isBlockTreeEnabled &gt; <span class="org-highlight-numbers-number">0</span> &amp;& currentBlock<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    currentBlock.<span class=
"org-function-name">push</span><span class=
"org-rainbow-delimiters-depth-3">(</span>cached<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">return</span> <span class=
"org-constant">true</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>watchPostEffect (<a href=
              "https://github.com/vuejs/vue-next/commit/42ace9577da49477ff189950a83d6eead73d0efe">42ace95</a>)
              <span id="watchPostEffect"></span> <span id=
              "42ace95"></span></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">function</span> <span class=
                "org-function-name">watchPostEffect</span><span class=
                "org-rainbow-delimiters-depth-1">(</span>
  effect: <span class="org-type">WatchEffect</span>,
  options?: <span class="org-type">DebuggerOptions</span>
<span class="org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">return</span> <span class=
"org-function-name">doWatch</span><span class=
"org-rainbow-delimiters-depth-2">(</span>effect, <span class=
"org-constant">null</span>, <span class=
"org-rainbow-delimiters-depth-3">(</span>__DEV__
    ? Object.<span class=
"org-function-name">assign</span><span class=
"org-rainbow-delimiters-depth-4">(</span>options || <span class=
"org-rainbow-delimiters-depth-1">{}</span>, <span class=
"org-rainbow-delimiters-depth-1">{</span> flush: <span class=
"org-string">'post'</span> <span class=
"org-rainbow-delimiters-depth-1">}</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
    : <span class=
"org-rainbow-delimiters-depth-4">{</span> flush: <span class=
"org-string">'post'</span> <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-keyword">as</span> WatchOptionsBase<span class=
"org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js">(<span class=
                "org-keyword">async</span> <span class=
                "org-keyword">function</span> () {
  <span class="org-keyword">const</span> <span class=
"org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../runtime-test/dist/runtime-test.cjs.js'</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
  <span class="org-keyword">const</span> { render, ref,
          reactive, nextTick, serializeInner, h, nodeOps,
          watchPostEffect
        } = value

  <span class="org-keyword">const</span> <span class=
"org-variable-name">count</span> = ref(<span class=
"org-highlight-numbers-number">0</span>)
  <span class="org-keyword">let</span> <span class=
"org-variable-name">result</span>, <span class=
"org-variable-name">n</span> = <span class=
"org-highlight-numbers-number">0</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">assertion</span> = count =&gt; {
    result = serializeInner(root) === <span class=
"org-string">`${count}`</span>
    n++
  }

  <span class="org-keyword">const</span> <span class=
"org-variable-name">Comp</span> = {
    setup() {
      watchPostEffect(() =&gt; assertion(count.value))
      <span class="org-keyword">return</span> () =&gt; count.value
    }
  }

  <span class="org-keyword">const</span> <span class=
"org-variable-name">root</span> = nodeOps.createElement(<span class="org-string">'div'</span>)
  <span class="org-keyword">try</span> {
    render(h(Comp), root)
  } <span class="org-keyword">catch</span>(e) {
    console.log(e.message);
  }
  console.log(<span class=
"org-string">'1. result = '</span> + result + <span class=
"org-string">', n = '</span> + n)

  count.value++

  <span class="org-keyword">await</span> nextTick()
  console.log(<span class=
"org-string">'\n2. result = '</span> + result + <span class=
"org-string">', n = '</span> + n)
}());
<span class="org-keyword">return</span> <span class=
"org-string">''</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: new effectScope API (<a href=
              "https://github.com/vuejs/vue-next/issues/2195">#2195</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/f5617fc3bb8fd33927b2567622ac4f8b43f9b5d5">f5617fc</a>)
              <span id="f5617fc"></span></p>
              <p>RFC: <a href=
              "https://github.com/vuejs/rfcs/pull/212">vuejs/rfcs#212</a></p>
              <p>新增的 APIs</p>
              <ol class="org-ol">
                <li>EffectScope (class)</li>
                <li>getCurrentScope</li>
                <li>onScopeDispose</li>
              </ol>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: support onTrack/onTrigger debug
              options for computed (<a href=
              "https://github.com/vuejs/vue-next/commit/5cea9a1d4e846f60515ef76ebab4800228645601">5cea9a1</a>)
              <span id="5cea9a1"></span></p>
              <p>支持 <b>DEV</b> 模式下分别在 track 和 trigger 的时候调用 onTrack
              和 onTrigger。</p>
              <p>onTrack -&gt; effect.ts:trackEffects:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">if</span> <span class=
                "org-rainbow-delimiters-depth-1">(</span>shouldTrack<span class=
                "org-rainbow-delimiters-depth-1">)</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  dep.<span class="org-function-name">add</span><span class=
"org-rainbow-delimiters-depth-2">(</span>activeEffect!<span class=
"org-rainbow-delimiters-depth-2">)</span>
  activeEffect!.deps.<span class=
"org-function-name">push</span><span class=
"org-rainbow-delimiters-depth-2">(</span>dep<span class=
"org-rainbow-delimiters-depth-2">)</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>__DEV__ &amp;& activeEffect!.onTrack<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    activeEffect!.<span class=
"org-function-name">onTrack</span><span class=
"org-rainbow-delimiters-depth-3">(</span>
      Object.<span class=
"org-function-name">assign</span><span class=
"org-rainbow-delimiters-depth-4">(</span>
        <span class="org-rainbow-delimiters-depth-1">{</span>
          effect: activeEffect!
        <span class="org-rainbow-delimiters-depth-1">}</span>,
        debuggerEventExtraInfo
      <span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>onTrigger -&gt; effect.ts:triggerEffects:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">for</span> <span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">effect</span> <span class=
                "org-keyword">of</span> <span class=
                "org-function-name">isArray</span><span class=
                "org-rainbow-delimiters-depth-2">(</span>dep<span class=
                "org-rainbow-delimiters-depth-2">)</span> ? dep : <span class=
                "org-rainbow-delimiters-depth-2">[</span>...dep<span class=
                "org-rainbow-delimiters-depth-2">]</span><span class=
                "org-rainbow-delimiters-depth-1">)</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>effect !== activeEffect || effect.allowRecurse<span class="org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>__DEV__ &amp;& effect.onTrigger<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      effect.<span class=
"org-function-name">onTrigger</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-function-name">extend</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-rainbow-delimiters-depth-2">{</span> effect <span class=
"org-rainbow-delimiters-depth-2">}</span>, debuggerEventExtraInfo<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-depth-4">)</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>effect.scheduler<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
      effect.<span class=
"org-function-name">scheduler</span><span class=
"org-rainbow-delimiters-depth-4">()</span>
    <span class=
"org-rainbow-delimiters-depth-3">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      effect.<span class="org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-4">()</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">onTrigger 参数： { effect } & DebuggerEventExtraInfo</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">type</span> <span class=
"org-type">DebuggerEventExtraInfo</span> = <span class=
"org-rainbow-delimiters-depth-1">{</span>
  target: <span class="org-keyword">object</span>
  <span class="org-keyword">type</span>: <span class=
"org-type">TrackOpTypes</span> | TriggerOpTypes
  key: <span class="org-typescript-primitive">any</span>
  newValue?: <span class="org-typescript-primitive">any</span>
  oldValue?: <span class="org-typescript-primitive">any</span>
  oldTarget?: <span class="org-type">Map</span>&lt;<span class=
"org-typescript-primitive">any</span>, <span class=
"org-typescript-primitive">any</span>&gt; | Set&lt;<span class=
"org-typescript-primitive">any</span>&gt;
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>使用：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../reactivity/dist/reactivity.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { reactive, effect, computed } = value

<span class="org-keyword">const</span> <span class=
"org-variable-name">obj</span> = reactive({ foo: <span class=
"org-highlight-numbers-number">1</span> })
<span class="org-keyword">function</span> <span class=
"org-function-name">onTrack</span>(<span class=
"org-variable-name">eventInfo</span>) {
  console.log(<span class=
"org-string">'TrackEventArg='</span>, eventInfo);
}
<span class="org-keyword">function</span> <span class=
"org-function-name">onTrigger</span>(<span class=
"org-variable-name">eventInfo</span>) {
  console.log(<span class=
"org-string">'TriggerEventArg='</span>, eventInfo);
}
<span class="org-keyword">const</span> <span class=
"org-variable-name">c</span> = computed(() =&gt; obj.foo, { onTrigger, onTrack })

c.value;
obj.foo++
console.log(<span class="org-string">'c.value = '</span> + c.value)
<span class="org-keyword">return</span> obj
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org8d8a413" class="outline-3">
        <h3 id="org8d8a413"><span class=
        "section-number-3">14.4.</span> Performance improvements
        <code>[7/7]</code></h3>
        <div class="outline-text-3" id="text-14-4">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>also hoist all-static children array (<a href=
              "https://github.com/vuejs/vue-next/commit/b7ea7c148552874e8bce399eec9fbe565efa2f4d">b7ea7c1</a>)
              如果 children 里面都是静态节点直接将整个 children 数组提升:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">const _hoisted_1 = /*#__PURE__*/_createElementVNode(\\"div\\", { key: \\"foo\\" }, null, -1 /* HOISTED */)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> const _hoisted_2 = [</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  _hoisted_1</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added"> ]</span>

<span class=
"org-diff-context">return function render(_ctx, _cache) {</span>
<span class="org-diff-context">  with (_ctx) {</span>
<span class=
"org-diff-context">    const { createElementVNode: _createElementVNode, openBlock: _openBlock, createElementBlock: _createElementBlock } = _Vue</span>

<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    return (_openBlock(), _createElementBlock(\\"div\\", null, [</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      _hoisted_1</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    ]))</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    return (_openBlock(), _createElementBlock(\\"div\\", null, _hoisted_2))</span>
<span class="org-diff-context">  }</span>
}"
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>hoist dynamic props lists (<a href=
              "https://github.com/vuejs/vue-next/commit/02339b67d8c6fab6ee701a7c4f2773139ed007f5">02339b6</a>)
              动态属性名列表提升：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-indicator-removed">-</span><span class=
                "org-diff-removed">      _createElementVNode(\\"div\\", { id: foo }, null, 8 /* PROPS */, [\\"id\\"])</span>
+      _createElementVNode(\\"div\\", { id: foo }, null, 8 /* PROPS */, _hoisted_1)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: avoid triggering re-render if computed
              value did not change (<a href=
              "https://github.com/vuejs/vue-next/commit/ebaac9a56d82d266e333d077b6457543d7cab9ae">ebaac9a</a>)
              trigger computed value 之前先检查下值有没改变。</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">if</span> <span class=
                "org-rainbow-delimiters-depth-1">(</span><span class=
                "org-typescript-this">this</span>._dirty<span class=
                "org-rainbow-delimiters-depth-1">)</span> <span class=
                "org-rainbow-delimiters-depth-1">{</span>
  <span class=
"org-typescript-this">this</span>._dirty = <span class=
"org-constant">false</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">newValue</span> = <span class=
"org-typescript-this">this</span>.effect.<span class=
"org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-2">()</span>!
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-typescript-this">this</span>._value !== newValue<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-typescript-this">this</span>._value = newValue
    <span class=
"org-function-name">triggerRefValue</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class=
"org-function-name">triggerRefValue</span><span class="org-rainbow-delimiters-depth-2">(</span><span class="org-constant">this</span><span class="org-rainbow-delimiters-depth-2">)</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: improve reactive effect memory usage
              (<a href=
              "https://github.com/vuejs/vue-next/issues/4001">#4001</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/87f69fd0bb67508337fb95cb98135fd5d6ebca7d">87f69fd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2345">#2345</a>
              <span id="87f69fd"></span></p>
              <p>改动点：</p>
              <ol class="org-ol">
                <li>
                  <p>ReactiveEffect 改用 class 来实现(stop, run 都在这个
                  class 里面实现)</p>
                  <div class="org-src-container">
                    <pre class="src src-typescript"><span class=
                    "org-keyword">export</span> <span class=
                    "org-keyword">class</span> <span class=
                    "org-type">ReactiveEffect</span>&lt;<span class=
                    "org-type">T</span> = <span class=
                    "org-typescript-primitive">any</span>&gt; <span class=
                    "org-rainbow-delimiters-depth-1">{</span>
  active = <span class="org-constant">true</span>
  deps: <span class="org-type">Dep</span><span class=
"org-rainbow-delimiters-depth-2">[]</span> = <span class=
"org-rainbow-delimiters-depth-2">[]</span>

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">can be attached after creation</span>
  computed?: <span class="org-typescript-primitive">boolean</span>
  allowRecurse?: <span class=
"org-typescript-primitive">boolean</span>
  onStop?: <span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-typescript-primitive">void</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">dev only</span>
  onTrack?: <span class=
"org-rainbow-delimiters-depth-2">(</span>event: <span class=
"org-type">DebuggerEvent</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-typescript-primitive">void</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">dev only</span>
  onTrigger?: <span class=
"org-rainbow-delimiters-depth-2">(</span>event: <span class=
"org-type">DebuggerEvent</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-typescript-primitive">void</span>

  <span class="org-keyword">constructor</span><span class=
"org-rainbow-delimiters-depth-2">(</span>
    <span class=
"org-typescript-access-modifier">public</span> fn: <span class=
"org-rainbow-delimiters-depth-3">()</span> <span class=
"org-keyword">=&gt;</span> T,
    <span class=
"org-typescript-access-modifier">public</span> scheduler: <span class="org-type">EffectScheduler</span> | <span class="org-constant">null</span> = <span class="org-constant">null</span>,
    scope?: <span class=
"org-type">EffectScope</span> | <span class="org-constant">null</span>
  <span class=
"org-rainbow-delimiters-depth-2">)</span> <span class="org-rainbow-delimiters-depth-2">{</span>
    <span class=
"org-function-name">recordEffectScope</span><span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-constant">this</span>, scope<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">run</span><span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>!<span class=
"org-typescript-this">this</span>.active<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">return</span> <span class=
"org-typescript-this">this</span>.<span class=
"org-function-name">fn</span><span class=
"org-rainbow-delimiters-depth-4">()</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>!effectStack.<span class=
"org-function-name">includes</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-4">)</span><span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class="org-keyword">try</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        effectStack.<span class=
"org-function-name">push</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-rainbow-delimiters-depth-2">(</span>activeEffect = <span class="org-constant">this</span><span class="org-rainbow-delimiters-depth-2">)</span><span class="org-rainbow-delimiters-depth-1">)</span>
        <span class=
"org-function-name">enableTracking</span><span class=
"org-rainbow-delimiters-depth-1">()</span>

        trackOpBit = <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; ++effectTrackDepth

        <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>effectTrackDepth &lt;= maxMarkerBits<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
          <span class=
"org-function-name">initDepMarkers</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class=
"org-rainbow-delimiters-depth-1">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
          <span class=
"org-function-name">cleanupEffect</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-1">}</span>
        <span class="org-keyword">return</span> <span class=
"org-typescript-this">this</span>.<span class=
"org-function-name">fn</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
      <span class=
"org-rainbow-delimiters-depth-4">}</span> <span class=
"org-keyword">finally</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>effectTrackDepth &lt;= maxMarkerBits<span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
          <span class=
"org-function-name">finalizeDepMarkers</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
        <span class="org-rainbow-delimiters-depth-1">}</span>

        trackOpBit = <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; --effectTrackDepth

        <span class=
"org-function-name">resetTracking</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
        effectStack.<span class=
"org-function-name">pop</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
        <span class="org-keyword">const</span> <span class=
"org-variable-name">n</span> = effectStack.length
        activeEffect = n &gt; <span class=
"org-highlight-numbers-number">0</span> ? effectStack<span class=
"org-rainbow-delimiters-depth-1">[</span>n - <span class=
"org-highlight-numbers-number">1</span><span class=
"org-rainbow-delimiters-depth-1">]</span> : <span class=
"org-constant">undefined</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-function-name">stop</span><span class=
"org-rainbow-delimiters-depth-2">()</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-typescript-this">this</span>.active<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
      <span class=
"org-function-name">cleanupEffect</span><span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-constant">this</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
      <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span><span class=
"org-typescript-this">this</span>.onStop<span class=
"org-rainbow-delimiters-depth-4">)</span> <span class=
"org-rainbow-delimiters-depth-4">{</span>
        <span class="org-typescript-this">this</span>.<span class=
"org-function-name">onStop</span><span class=
"org-rainbow-delimiters-depth-1">()</span>
      <span class="org-rainbow-delimiters-depth-4">}</span>
      <span class=
"org-typescript-this">this</span>.active = <span class=
"org-constant">false</span>
    <span class="org-rainbow-delimiters-depth-3">}</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
                  </div>
                </li>
                <li>effect 通过 <code>new ReactiveEffect()</code> 创建,
                收集的依赖通过 <code>_effect.run()</code> 执行。</li>
              </ol>
            </li>
            <li class="on">
              <code>[X]</code> reactivity: ref-specific
              track/trigger and miscellaneous optimizations
              (<a href=
              "https://github.com/vuejs/vue-next/issues/3995">#3995</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/64310405acaccabc24985ade95fb1b5c9c06ef76">6431040</a>)
              <span id="6431040"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: use bitwise dep markers to optimize
              re-tracking (<a href=
              "https://github.com/vuejs/vue-next/issues/4017">#4017</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/6cf2377cd49d24814bdff136bf78c77d50d5b41a">6cf2377</a>)
              <span id="6cf2377"></span></p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../reactivity/dist/reactivity.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { reactive, effect, targetMap, toRaw } = value


console.log(<span class=
"org-string">'&gt; should handle deep effect recursion using cleanup fallback'</span>);
<span class="org-keyword">const</span> <span class=
"org-variable-name">results</span> = reactive([<span class=
"org-highlight-numbers-number">0</span>])
<span class="org-keyword">const</span> <span class=
"org-variable-name">effects</span> = []
<span class="org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">1</span>; i &lt; <span class=
"org-highlight-numbers-number">40</span>;i++) {
  ;(index =&gt; {
    <span class="org-keyword">const</span> <span class=
"org-variable-name">fx</span> = effect(() =&gt; {
      results[index] = results[index - <span class=
"org-highlight-numbers-number">1</span>] * <span class=
"org-highlight-numbers-number">2</span>
    })
    effects.push({ fx, index })
  })(i)
}

<span class="org-comment-delimiter">// </span><span class=
"org-comment">targetMap.forEach((key, value) =&gt; console.log({ key, value }))</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">console.log(toRaw(results).join(','), targetMap.get(toRaw(results)), 'xx');</span>
console.log((<span class=
"org-string">'results[39] = '</span> + results[<span class=
"org-highlight-numbers-number">39</span>]));
<span class="org-keyword">const</span> <span class=
"org-variable-name">deps</span> = targetMap.get(toRaw(results))
<span class="org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; <span class=
"org-highlight-numbers-number">40</span>; i++) {
  <span class="org-keyword">const</span> <span class=
"org-variable-name">dep</span> = deps.get(<span class=
"org-string">''</span> + i)
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">dep &amp;& console.log(i + 1 + ": " + "n(newTracked): " + dep.n +', w(wasTracked): ' + dep.w);</span>
}
results[<span class=
"org-highlight-numbers-number">0</span>] = <span class=
"org-highlight-numbers-number">1</span>
console.log((<span class=
"org-string">'results[39] = 2^39, '</span> + (results[<span class=
"org-highlight-numbers-number">39</span>] === Math.pow(<span class=
"org-highlight-numbers-number">2</span>, <span class=
"org-highlight-numbers-number">39</span>))));

<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>improve VNode creation performance with compiler
              hints (<a href=
              "https://github.com/vuejs/vue-next/issues/3334">#3334</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ceff89905b05381d3d73c480e08c7aff9271b074">ceff899</a>)
              <span id="ceff899"></span></p>
              <p>区分 element 和 component 创建过程，新增两个针对性的函数，分别用来创建
              element(<code>createElementVNode</code>) 和
              component(<code>createComponentVNode</code>)，减少部分检查的
              工作，总的来说优化创建 element 和 component 的过程。</p>
              <p>compiler-core:codegen 阶段 element 由
              <code>_createVNode</code> 改成
              <code>_createElementVNode</code>,
              <code>_createBlock</code> 改成
              <code>_createElementBlock</code></p>
              <p>增加的 helpers: <code>CREATE_VNODE</code> -&gt;
              <code>CREATE_ELEMENT_VNODE</code></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-keyword">export</span> <span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">CREATE_ELEMENT_BLOCK</span> = <span class=
                "org-function-name">Symbol</span><span class=
                "org-rainbow-delimiters-depth-1">(</span>__DEV__ ? <span class=
                "org-string">`createElementBlock`</span> : <span class=
                "org-string">``</span><span class=
                "org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_ELEMENT_VNODE</span> = <span class=
"org-function-name">Symbol</span><span class=
"org-rainbow-delimiters-depth-1">(</span>__DEV__ ? <span class=
"org-string">`createElementVNode`</span> : <span class=
"org-string">``</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">const</span> <span class=
"org-variable-name">NORMALIZE_CLASS</span> = <span class=
"org-function-name">Symbol</span><span class=
"org-rainbow-delimiters-depth-1">(</span>__DEV__ ? <span class=
"org-string">`normalizeClass`</span> : <span class=
"org-string">``</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">const</span> <span class=
"org-variable-name">NORMALIZE_STYLE</span> = <span class=
"org-function-name">Symbol</span><span class=
"org-rainbow-delimiters-depth-1">(</span>__DEV__ ? <span class=
"org-string">`normalizeStyle`</span> : <span class=
"org-string">``</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">const</span> <span class=
"org-variable-name">NORMALIZE_PROPS</span> = <span class=
"org-function-name">Symbol</span><span class=
"org-rainbow-delimiters-depth-1">(</span>__DEV__ ? <span class=
"org-string">`normalizeProps`</span> : <span class=
"org-string">``</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">const</span> <span class=
"org-variable-name">GUARD_REACTIVE_PROPS</span> = <span class=
"org-function-name">Symbol</span><span class=
"org-rainbow-delimiters-depth-1">(</span>__DEV__ ? <span class=
"org-string">`guardReactiveProps`</span> : <span class=
"org-string">``</span><span class=
"org-rainbow-delimiters-depth-1">)</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">compiler-core/src/utils.ts</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">getVNodeHelper</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-variable-name">ssr</span>: <span class=
"org-typescript-primitive">boolean</span>, <span class=
"org-variable-name">isComponent</span>: <span class=
"org-typescript-primitive">boolean</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class=
"org-keyword">return</span> ssr || isComponent ? CREATE_VNODE : <span class="org-type">CREATE</span>_ELEMENT_VNODE
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">getVNodeBlockHelper</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-variable-name">ssr</span>: <span class=
"org-typescript-primitive">boolean</span>, <span class=
"org-variable-name">isComponent</span>: <span class=
"org-typescript-primitive">boolean</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class=
"org-keyword">return</span> ssr || isComponent ? CREATE_BLOCK : <span class="org-type">CREATE</span>_ELEMENT_BLOCK
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">runtime-core/src/vnode.ts</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">guardReactiveProps</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-variable-name">props</span>: <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-variable-name">Data</span> & <span class=
"org-variable-name">VNodeProps</span><span class=
"org-rainbow-delimiters-depth-2">)</span> | <span class=
"org-constant">null</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>!props<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">return</span> <span class="org-constant">null</span>
  <span class="org-keyword">return</span> <span class=
"org-function-name">isProxy</span><span class=
"org-rainbow-delimiters-depth-2">(</span>props<span class=
"org-rainbow-delimiters-depth-2">)</span> || InternalObjectKey <span class="org-keyword">in</span> props
    ? <span class="org-function-name">extend</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-rainbow-delimiters-depth-3">{}</span>, props<span class=
"org-rainbow-delimiters-depth-2">)</span>
    : props
<span class="org-rainbow-delimiters-depth-1">}</span>

<span class="org-comment-delimiter">// </span><span class=
"org-comment">shared/src/normalizeProp.ts</span>
<span class="org-keyword">export</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">normalizeProps</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-variable-name">props</span>: <span class=
"org-type">Record</span>&lt;<span class=
"org-typescript-primitive">string</span>, <span class=
"org-typescript-primitive">any</span>&gt; | <span class=
"org-constant">null</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>!props<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">return</span> <span class="org-constant">null</span>
  <span class="org-keyword">let</span> <span class=
"org-rainbow-delimiters-depth-2">{</span> <span class=
"org-keyword">class</span>: klass, style <span class=
"org-rainbow-delimiters-depth-2">}</span> = props
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>klass &amp;& !<span class=
"org-function-name">isString</span><span class=
"org-rainbow-delimiters-depth-3">(</span>klass<span class=
"org-rainbow-delimiters-depth-3">)</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    props.<span class="org-keyword">class</span> = <span class=
"org-function-name">normalizeClass</span><span class=
"org-rainbow-delimiters-depth-3">(</span>klass<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>style<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    props.style = <span class=
"org-function-name">normalizeStyle</span><span class=
"org-rainbow-delimiters-depth-3">(</span>style<span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>
  <span class="org-keyword">return</span> props
<span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../compiler-core/dist/compiler-core.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { generate, createSimpleExpression, locStub,
        createVNodeCall, createObjectExpression,
        createObjectProperty,
        createCompoundExpression,
        createArrayExpression
      } = value

<span class="org-keyword">function</span> <span class=
"org-function-name">createRoot</span>(<span class=
"org-variable-name">options</span>) {
  <span class="org-keyword">return</span> {
    type: <span class=
"org-highlight-numbers-number">0</span><span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">ROOT</span><span class=
"org-comment-delimiter"> */</span>,
    children: [],
    helpers: [],
    components: [],
    directives: [],
    imports: [],
    hoists: [],
    cached: <span class="org-highlight-numbers-number">0</span>,
    temps: <span class="org-highlight-numbers-number">0</span>,
    codegenNode: createSimpleExpression(<span class=
"org-string">`null`</span>, <span class=
"org-constant">false</span>),
    loc: locStub,
    ...options
  }
}

<span class="org-keyword">function</span> <span class=
"org-function-name">genCode</span>(<span class=
"org-variable-name">node</span>) {
  <span class="org-keyword">return</span> generate(
    createRoot({
      codegenNode: node
    })
  ).code.match(<span class=
"org-string">/with \(_ctx\) \{\s+([^]+)\s+\}\s+\}$/</span>)[<span class="org-highlight-numbers-number">1</span>]
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">mockChildren</span> = createCompoundExpression([<span class="org-string">'children'</span>])
<span class="org-keyword">const</span> <span class=
"org-variable-name">mockDirs</span> = createArrayExpression([
  createArrayExpression([<span class=
"org-string">`foo`</span>, createSimpleExpression(<span class=
"org-string">`bar`</span>, <span class=
"org-constant">false</span>)])
])

<span class="org-keyword">const</span> <span class=
"org-variable-name">mockProps</span> = createObjectExpression([
  createObjectProperty(<span class=
"org-string">`foo`</span>, createSimpleExpression(<span class=
"org-string">`bar`</span>, <span class="org-constant">true</span>))
])

<span class="org-keyword">const</span> <span class=
"org-variable-name">test</span> = (title, ...args) =&gt; console.log(<span class="org-string">'&gt; '</span> + title + <span class="org-string">'\n'</span>, <span class="org-string">"'"</span> + genCode( createVNodeCall(...args) ) + <span class="org-string">"'"</span>)

test(<span class="org-string">'tag only'</span>, <span class=
"org-constant">null</span>, <span class=
"org-string">'"div"'</span>)
test(<span class="org-string">'with props'</span>, <span class=
"org-constant">null</span>, <span class=
"org-string">'"div"'</span>, mockProps)
test(<span class=
"org-string">'with children, no props'</span>, <span class=
"org-constant">null</span>, <span class=
"org-string">'"div"'</span>, <span class=
"org-constant">undefined</span>, mockChildren)
test(<span class=
"org-string">'with children + props'</span>, <span class=
"org-constant">null</span>, <span class=
"org-string">'"div"'</span>, mockProps, mockChildren)
test(<span class="org-string">'as block'</span>, <span class=
"org-constant">null</span>, <span class=
"org-string">'"dv"'</span>, mockProps, mockChildren, <span class=
"org-constant">undefined</span>, <span class=
"org-constant">undefined</span>, <span class=
"org-constant">undefined</span>, <span class=
"org-constant">true</span>)
<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org86ed1df" class="outline-3">
        <h3 id="org86ed1df"><span class=
        "section-number-3">14.5.</span> Breaking Changes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-14-5">
          <ul class="org-ul">
            <li class="on"><code>[X]</code> Output of SFC using
            &lt;style scoped&gt; generated by 3.2+ will be
            incompatible w/ runtime &lt; 3.2.</li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgcbf9c47" class="outline-2">
      <h2 id="orgcbf9c47"><span class="section-number-2">15.</span>
      小结</h2>
      <div class="outline-text-2" id="text-15">
        <p>3.2 更新重点摘要：</p>
        <ol class="org-ol">
          <li><code>v-memo</code> 组件更新条件设置。</li>
          <li><code>$ref()</code> SFC setup 中的新语法糖。</li>
          <li><code>MutationObserver</code> 解决 cssVar + transition
          + v-if 无效问题。</li>
          <li><code>ReactiveEffect</code> 重构成了 class 实现，effect
          不再是函数，而是其实例对象。</li>
        </ol>
      </div>
    </div>
    <div id="outline-container-org4ed0d58" class="outline-2">
      <h2 id="org4ed0d58"><span class="section-number-2">16.</span>
      3.0.8</h2>
      <div class="outline-text-2" id="text-16">
        <ol class="org-ol">
          <li>
            <b><span style="color:yellow;">IMP</span></b>: SFC
            style 中的 <code>::v-slotted</code> 和
            <code>:slotted</code> <a class="anchor" aria-hidden=
            "true" id="slotted" href="#slotted"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ol>
      </div>
      <div id="outline-container-orgb84366e" class="outline-3">
        <h3 id="orgb84366e"><span class=
        "section-number-3">16.1.</span> <span class=
        "done DONE">DONE</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-16-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>support only attaching slot scope ids when
              necessary (<a href=
              "https://github.com/vuejs/vue-next/commit/02cbbb718ca226b087c42e6f132120931307c2a6">02cbbb7</a>)
              <span id="slotted"></span></p>
              <p>SFC style 中使用</p>
              <p><code>:slotted(h1) { color: blue; }</code></p>
              <p>或</p>
              <p><code>::v-slotted(h1) { color: blue; }</code></p>
              <p>可以在当前组件中控制 slot 组件的样式。</p>
              <p><a href=
              "https://codesandbox.io/s/damp-cdn-k9eed?file=/src/main.js">
              https://codesandbox.io/s/damp-cdn-k9eed?file=/src/main.js</a></p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> =
      process.env.VNEXT_PKG_RC + <span class=
"org-string">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">"stb-"</span>, <span class="org-string">""</span>));
<span class=
"org-keyword">const</span> { compileScript, parse, compileStyle } = value;

<span class="org-keyword">function</span> <span class=
"org-function-name">compileScoped</span>(<span class=
"org-variable-name">source</span>, <span class=
"org-variable-name">options</span>) {
  <span class="org-keyword">const</span> <span class=
"org-variable-name">res</span> = compileStyle({
    source,
    filename: <span class="org-string">'test.css'</span>,
    id: <span class="org-string">'data-v-test'</span>,
    scoped: <span class="org-constant">true</span>,
    ...options
  })
  <span class="org-keyword">return</span> res.code
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">src</span> = <span class=
"org-string">`::v-slotted(h1) { color: red; } :slotted(h1) {font-size:12px;}`</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">code</span> = compileScoped(src)
console.log(code)
<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>;
</pre>
              </div>
              <p>下面会检查 style 中是不是含 <code>::v-slotted(...)
              {...}</code> 或 <code>:slotted(...) {..}</code> 指令</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-comment-delimiter">// </span><span class=
                "org-comment">packages/compiler-sfc/src/parse.ts</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">check if the SFC uses :slotted</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">slottedRE</span> = <span class=
"org-string">/(?:::v-|:)slotted\(/</span>
  descriptor.slotted = descriptor.styles.<span class=
"org-function-name">some</span><span class=
"org-rainbow-delimiters-depth-1">(</span>s <span class=
"org-keyword">=&gt;</span> slottedRE.<span class=
"org-function-name">test</span><span class=
"org-rainbow-delimiters-depth-2">(</span>s.content<span class=
"org-rainbow-delimiters-depth-2">)</span><span class=
"org-rainbow-delimiters-depth-1">)</span>
</pre>
              </div>
              <p>根据上面的结果，在 parse SFC template 阶段给组件加上
              <code>scope-id-s</code> 属性， 如：</p>
              <p><code>&lt;div scope-id-s /&gt;</code></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-comment-delimiter">// </span><span class=
                "org-comment">packages/compiler-ssr/src/transforms/ssrTransformSlotOutlet.ts</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">inject slot scope id if current template uses :slotted</span>
  <span class="org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-1">(</span>context.scopeId &amp;& context.slotted !== <span class="org-constant">false</span><span class="org-rainbow-delimiters-depth-1">)</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    args.<span class="org-function-name">push</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-string">`"${context.scopeId}-s"`</span><span class=
"org-rainbow-delimiters-depth-2">)</span>
  <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgbfbaa56" class="outline-2">
      <h2 id="orgbfbaa56"><span class="section-number-2">17.</span>
      3.0.7</h2>
      <div class="outline-text-2" id="text-17">
        <ol class="org-ol">
          <li>
            <b><span style="color:red;">FIX</span></b>:
            <code>&lt;script setup&gt;</code> 中 export default 和
            class 语法 <a class="anchor" aria-hidden="true" id=
            "default-rewrite" href="#default-rewrite"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a> 。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>:
            <abbr class="tooltip" title=
            "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
            v-show</abbr> 的优先级比 <code>{style: { display: 'block'
            }}</code> 更高 <a class="anchor" aria-hidden="true" id=
            "v-show-priority" href="#v-show-priority"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: scheduler 中
            组件更新任务总是保持以 <code>job.id</code> 的增序执行，在插入的时候找到 对应的索引插入
            <a class="anchor" aria-hidden="true" id="job-id-as"
            href="#job-id-as"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ol>
      </div>
      <div id="outline-container-org3e12a38" class="outline-3">
        <h3 id="org3e12a38"><span class=
        "section-number-3">17.1.</span> <span class=
        "done DONE">DONE</span> Bug Fixes <code>[6/6]</code></h3>
        <div class="outline-text-3" id="text-17-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: handle more edge cases in default
              rewrite (1dedc19) <span id=
              "default-rewrite"></span></p>
              <p>处理 setup script 中更多语法情况：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> =
  process.env.VNEXT_PKG_RC + <span class=
"org-string">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">"stb-"</span>, <span class="org-string">""</span>));
<span class="org-keyword">const</span> { rewriteDefault } = value;

<span class="org-keyword">const</span> <span class=
"org-variable-name">test</span> = (hint, code) =&gt; {
  console.log(<span class=
"org-string">'&gt; '</span> + hint + <span class=
"org-string">'\n'</span>);
  console.log(rewriteDefault(code, <span class=
"org-string">'script'</span>))
}

test(<span class="org-string">'1. comments'</span>, <span class=
"org-string">`// export default\nexport default {}`</span>)
test(<span class=
"org-string">'2. export default class'</span>, <span class=
"org-string">`export default class Foo {}`</span>)
test(<span class=
"org-string">'3. export default class + commons'</span>, <span class="org-string">`// export default\nexport default class Foo {}`</span>)
test(<span class=
"org-string">'4. export default class + comments 2'</span>,  <span class="org-string">`export default {}\n`</span> + <span class="org-string">`// export default class Foo {}`</span>)
test(<span class=
"org-string">'5. export default class + comments 3'</span>, <span class="org-string">`/*\nexport default class Foo {}*/\n`</span> + <span class="org-string">`export default class Bar {}`</span>)
console.log(<span class="org-string">'------ end ------ '</span>);

<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>;
</pre>
              </div>
              <p><span style="color:blue;">+RESULTS</span>:</p>
              <pre class="example" id="org7ad0010">
  &gt; 1. comments

  // export default
  const script = {}
  &gt; 2. export default class

  class Foo {}
  const script = Foo
  &gt; 3. export default class + commons

  // export default
  class Foo {}
  const script = Foo
  &gt; 4. export default class + comments 2

  const script = {}
  // export default class Foo {}
  &gt; 5. export default class + comments 3

  /*
  export default class Foo {}*/
  const script = class Bar {}
  ------ end ------
  0
</pre>
            </li>
            <li class="on"><code>[X]</code> deps: pin Rollup to
            2.38 (34f354b), closes #3332</li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: properties in methods should be
              writable and enumerable in DEV (#3301) (e3568ba),
              closes #3300</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> 3  packages/runtime-core/src/componentOptions.ts</span>
<span class=
"org-diff-hunk-header">@@ -610,7 +610,8 @@</span><span class=
"org-diff-function"> export function applyOptions(</span>
<span class=
"org-diff-context">          Object.defineProperty(ctx, key, {</span>
<span class=
"org-diff-context">            value: methodHandler.bind(publicThis),</span>
<span class=
"org-diff-context">            configurable: true,</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">            enumerable: </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">false</span></span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">            enumerable: </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">true,</span></span><span class=
"org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">            writable: true</span></span>
<span class="org-diff-context">          })</span>
<span class="org-diff-context">        } else {</span>
          ctx[key] = methodHandler.bind(publicThis)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>scheduler: ensure updates are always inserted in
              ascending id order (<a href=
              "https://github.com/vuejs/vue-next/issues/3184">#3184</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/45fae9d308e8cb9fe3304d4ca03c373ce63b2e62">45fae9d</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2768">#2768</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/2829">#2829</a>
              <span id="job-id-as"></span></p>
              <p><a href=
              "https://codesandbox.io/s/lucid-wind-c4jky?file=/src/App.vue">
              View isn’t updated in a weird case (combination of
              many factors, transition, injection &
              computed)</a></p>
              <p>确保 updates 总是以升序被插入，那么在插入之前就得找到适当的 job 索引:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span class=
                "org-comment-delimiter">// </span><span class=
                "org-comment">#2768</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">Use binary-search to find a suitable position in the queue,</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">so that the queue maintains the increasing order of job's id,</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">which can prevent the job from being skipped and also can avoid repeated patching.</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">findInsertionIndex</span><span class=
"org-rainbow-delimiters-depth-1">(</span><span class=
"org-variable-name">job</span>: <span class=
"org-type">SchedulerJob</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">the start index should be `flushIndex + 1`</span>
  <span class="org-keyword">let</span> <span class=
"org-variable-name">start</span> = flushIndex + <span class=
"org-highlight-numbers-number">1</span>
  <span class="org-keyword">let</span> <span class=
"org-variable-name">end</span> = queue.length
  <span class="org-keyword">const</span> <span class=
"org-variable-name">jobId</span> = <span class=
"org-function-name">getId</span><span class=
"org-rainbow-delimiters-depth-2">(</span>job<span class=
"org-rainbow-delimiters-depth-2">)</span>

  <span class="org-keyword">while</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>start &lt; <span class=
"org-type">end</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">middle</span> = <span class=
"org-rainbow-delimiters-depth-3">(</span>start + end<span class=
"org-rainbow-delimiters-depth-3">)</span> &gt;&gt;&gt; <span class=
"org-highlight-numbers-number">1</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">middleJobId</span> = <span class=
"org-function-name">getId</span><span class=
"org-rainbow-delimiters-depth-3">(</span>queue<span class=
"org-rainbow-delimiters-depth-4">[</span>middle<span class=
"org-rainbow-delimiters-depth-4">]</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
    middleJobId &lt; <span class=
"org-type">jobId</span> ? <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-type">start</span> = <span class=
"org-type">middle</span> + <span class=
"org-highlight-numbers-number">1</span><span class=
"org-rainbow-delimiters-depth-3">)</span> : <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-type">end</span> = <span class=
"org-type">middle</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
  <span class="org-rainbow-delimiters-depth-2">}</span>

  <span class="org-keyword">return</span> start
<span class="org-rainbow-delimiters-depth-1">}</span>


</pre>
              </div>
              <p>在 update 进入任务队列的时候保证所有 jobs 是以升序排列</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">export function queueJob(job: SchedulerJob) {</span>
<span class=
"org-diff-context">  // the dedupe search uses the startIndex argument of Array.includes()</span>
<span class=
"org-diff-context">  // by default the search index includes the current job that is being run</span>
<span class=
"org-diff-hunk-header">@@ -72,7 +91,12 @@</span><span class=
"org-diff-function"> export function queueJob(job: SchedulerJob) {</span>
<span class="org-diff-context">      )) &amp;&</span>
<span class=
"org-diff-context">    job !== currentPreFlushParentJob</span>
<span class="org-diff-context">  ) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    queue.push(job)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    const pos = findInsertionIndex(job)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    if (pos &gt; -1) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      queue.splice(pos, 0, job)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    } else {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      queue.push(job)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    }</span>
<span class="org-diff-context">    queueFlush()</span>
<span class="org-diff-context">  }</span>
}
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p><abbr class="tooltip" title=
              "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
              v-show</abbr> takes higher priority than style
              attribute (<a href=
              "https://github.com/vuejs/vue-next/issues/3230">#3230</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/5ad4036e29f75dc907e95b99a63325b855332566">5ad4036</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2757">#2757</a>
              <span id="v-show-priority"></span></p>
              <p><abbr class="tooltip" title=
              "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
              v-show</abbr> 也是通过 el.style.<a href=
              "https://developer.mozilla.org/en-US/docs/Web/CSS/display">display</a>
              来实现的，这里意思是如果 style 属性中也有 display 的话，在 <a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-dom/src/modules/style.ts">
              runtime-dom/src/modules/style.ts</a> 中 patch 的时候应该
              <abbr class="tooltip" title=
              "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
              v-show</abbr> 的优先级更高。</p>
            </li>
            <li class="on">
              <code>[X]</code> init devtools after feature flag
              checks (<a href=
              "https://github.com/vuejs/vue-next/commit/d0ea74556f74d8c503ffb7b70f41cbe2ce14db98">d0ea745</a>)
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org68bdaf9" class="outline-3">
        <h3 id="org68bdaf9"><span class=
        "section-number-3">17.2.</span> <span class=
        "done DONE">DONE</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-17-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: only call Set.add if doesn’t already
              have value (<a href=
              "https://github.com/vuejs/vue-next/issues/3307">#3307</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/9cd988342cfa32ddd9479585244eb317d74c9712">9cd9883</a>)</p>
              <p>对于 Set key-value 都是值，所以当有这个 value 的时候再添加就没有什么意义了，
              Set 又是不重复集合。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/reactivity/src/collectionHandlers.ts</span>
<span class=
"org-diff-hunk-header">@@ -76,8 +76,8 @@</span><span class=
"org-diff-function"> function add(this: SetTypes, value: unknown) {</span>
<span class="org-diff-context">  const target = toRaw(this)</span>
<span class=
"org-diff-context">  const proto = getProto(target)</span>
<span class=
"org-diff-context">  const hadKey = proto.has.call(target, value)</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  target.add(value)</span>
<span class="org-diff-context">  if (!hadKey) {</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    target.add(value)</span>
<span class=
"org-diff-context">    trigger(target, TriggerOpTypes.ADD, value, value)</span>
<span class="org-diff-context">  }</span>
  return this
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org610afca" class="outline-2">
      <h2 id="org610afca"><span class="section-number-2">18.</span>
      3.0.6</h2>
      <div class="outline-text-2" id="text-18">
        <p>此次更新重点内容(值得关注的点)：</p>
        <ol class="org-ol">
          <li>
            <b><span style="color:green;">ADD</span></b>:
            <code>BigInt</code> 类型和 <i><abbr class="tooltip" title=
            "Single File Component, 单文件组件，其中包含了 script , style , template, 三种标签&lt;br&gt;为一体的文件， vue 框架所使用的及推崇的一种新的开发方式。">
            SFC</abbr></i> 支持 <a class="anchor" aria-hidden="true"
            id="add-bigint" href="#add-bigint"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: 修复
            <code>class: ['foo', false, undefined, 'bar']</code>
            被解析成 <code>&lt;div class="foo bar"/&gt;</code> 问题
            <a class="anchor" aria-hidden="true" id=
            "fix-array-class" href="#fix-array-class"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a> 。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: 修复
            <code>foo-bar</code> 事件名无法触发问题 <a class="anchor"
            aria-hidden="true" id="fix-kebab-event-name" href=
            "#fix-kebab-event-name"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a> 。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>:
            <code>this.$watch(fn, callback)</code> 的
            <code>fn</code> 第一个参数是 <code>instance.proxy</code>
            <a class="anchor" aria-hidden="true" id="instanceWatch"
            href="#instanceWatch"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ol>
      </div>
      <div id="outline-container-orgbd70deb" class="outline-3">
        <h3 id="orgbd70deb"><span class=
        "section-number-3">18.1.</span> Bug Fixes
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-18-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>remove superfluous spaces when normalizing class
              (<a href=
              "https://github.com/vuejs/vue-next/issues/3083">#3083</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/4b551420fc058c4683219db5d75893f9fc69aa04">4b55142</a>)
              <span id="fix-array-class"></span></p>
              <p>问题如下代码，正常应该忽略 <code>undefind</code>,
              <code>false</code> ：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { nodeOps, render, h, serializeInner: s } = value

<span class="org-keyword">const</span> <span class=
"org-variable-name">Comp</span> = {
  props: { foo: BigInt },
  render() {
    <span class="org-keyword">return</span> h(<span class=
"org-string">'div'</span>, { <span class=
"org-keyword">class</span>: [<span class=
"org-string">'foo'</span>, <span class=
"org-constant">undefined</span>, <span class=
"org-constant">false</span>, <span class=
"org-string">'bar'</span>] }, [<span class=
"org-constant">this</span>.foo])
  }
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">root</span> = nodeOps.createElement(<span class="org-string">'div'</span>)
render(h(Comp,  {
  foo: BigInt(BigInt(<span class=
"org-highlight-numbers-number">100000111</span>)) + BigInt(<span class="org-highlight-numbers-number">2000000000</span>) * BigInt(<span class="org-highlight-numbers-number">30000000</span>)
}), root)

console.log(s(root))
<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
</pre>
              </div>
              <p><span style="color:blue;">+RESULTS</span>:</p>
              <pre class="example">
&lt;div class="foo   bar"&gt;60000000100000111&lt;/div&gt;
0
</pre>
              <p>修复：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/shared/src/normalizeProp.ts</span>
<span class=
"org-diff-hunk-header">@@ -62,7 +62,10 @@</span><span class=
"org-diff-function"> export function normalizeClass(value: unknown): string {</span>
<span class="org-diff-context">    res = value</span>
<span class=
"org-diff-context">  } else if (isArray(value)) {</span>
<span class=
"org-diff-context">    for (let i = 0; i &lt; value.length; i++) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">      </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">res</span></span><span class=
"org-diff-removed"> </span><span class=
"org-diff-removed"><span class=
"org-diff-refine-removed">+</span></span><span class=
"org-diff-removed">= normalizeClass(value[i]) + ' '</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      </span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">const normalized</span></span><span class=
"org-diff-added"> = normalizeClass(value[i])</span>
<span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">      if (normalized) {</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">        res += normalized</span></span><span class="org-diff-added"> + ' '</span>
<span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">      }</span></span>
<span class="org-diff-context">    }</span>
<span class=
"org-diff-context">  } else if (isObject(value)) {</span>
    for (const name in value) {
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: instanceWatch should pass this.proxy
              to source as the first argument (<a href=
              "https://github.com/vuejs/vue-next/issues/2753">#2753</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ec8fd10cec61c33c7c8056413a1c609ac90e1215">ec8fd10</a>)
              <span id="instanceWatch"></span></p>
              <p>当 watch 一个函数的时候，将 instance.proxy
              做为第一个参数传给这个函数。</p>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { nodeOps, render, h, serializeInner: s, createApp } = value

<span class="org-keyword">let</span> <span class=
"org-variable-name">instance</span> = <span class=
"org-constant">null</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">source</span> = (proxy) =&gt; console.log(instance &amp;& ( proxy === instance.proxy ))
<span class="org-keyword">const</span> <span class=
"org-variable-name">Comp</span> = {
  created() {
    instance = <span class="org-constant">this</span>
    <span class=
"org-constant">this</span>.$watch(source, () =&gt; {})
  },
  render() {}
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">root</span> = nodeOps.createElement(<span class="org-string">'div'</span>)
createApp(Comp).mount(root)
<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
</pre>
              </div>
              <p><span style="color:blue;">+RESULTS</span>:</p>
              <pre class="example">
false
0
</pre>
              <p>修复：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context"> packages/runtime-core/src/apiWatch.ts</span>
<span class=
"org-diff-hunk-header">@@ -181,7 +181,9 @@</span><span class=
"org-diff-function"> function doWatch(</span>
<span class=
"org-diff-context">        } else if (isReactive(s)) {</span>
<span class="org-diff-context">          return traverse(s)</span>
<span class=
"org-diff-context">        } else if (isFunction(s)) {</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">          return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">          return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER</span><span class="org-diff-added"><span class="org-diff-refine-added">, [</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">            instance &amp;& (instance.proxy as any)</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">          ]</span></span><span class=
"org-diff-added">)</span>
<span class="org-diff-context">        } else {</span>
<span class=
"org-diff-context">          __DEV__ &amp;& warnInvalidSource(s)</span>
<span class="org-diff-context">        }</span>
<span class=
"org-diff-hunk-header">@@ -190,7 +192,9 @@</span><span class=
"org-diff-function"> function doWatch(</span>
<span class="org-diff-context">    if (cb) {</span>
<span class="org-diff-context">      // getter with cb</span>
<span class="org-diff-context">      getter = () =&gt;</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">        callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER</span><span class="org-diff-added"><span class="org-diff-refine-added">, [</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">          instance &amp;& (instance.proxy as any)</span></span><span class="org-diff-refine-added">
</span><span class="org-diff-indicator-added"><span class=
"org-diff-refine-added">+</span></span><span class=
"org-diff-added"><span class=
"org-diff-refine-added">        ]</span></span><span class=
"org-diff-added">)</span>
<span class="org-diff-context">    } else {</span>
<span class=
"org-diff-context">      // no cb -&gt; simple effect</span>
      getter = () =&gt; {
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org83d73c0" class="outline-3">
        <h3 id="org83d73c0"><span class=
        "section-number-3">18.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-18-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: props type support BigInt (<a href=
              "https://github.com/vuejs/vue-next/issues/2891">#2891</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ffd52885453d1621e45dff645ff1101e74ea40b2">ffd5288</a>)
              <span id="add-bigint"></span></p>
              <p>修改代码：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">const isSimpleType = /*#__PURE__*/ makeMap(</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  'String,Number,Boolean,Function,Symbol'</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  'String,Number,Boolean,Function,Symbol,BigInt'</span>
)
</pre>
              </div>
              <p>测试</p>
              <div class="org-src-container">
                <pre class="src src-js"><span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">url</span> = process.env.VNEXT_PKG_RC +<span class="org-string">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">value</span> = require(url.replace(<span class=
"org-string">'stb-'</span>, <span class="org-string">''</span>))
<span class=
"org-keyword">const</span> { nodeOps, render, h, serializeInner: s } = value

<span class="org-keyword">const</span> <span class=
"org-variable-name">Comp</span> = {
  props: { foo: BigInt },
  render() {
    <span class="org-keyword">return</span> h(<span class=
"org-string">'div'</span>, [<span class=
"org-constant">this</span>.foo])
  }
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">root</span> = nodeOps.createElement(<span class="org-string">'div'</span>)
render(h(Comp,  {
  foo: BigInt(BigInt(<span class=
"org-highlight-numbers-number">100000111</span>)) + BigInt(<span class="org-highlight-numbers-number">2000000000</span>) * BigInt(<span class="org-highlight-numbers-number">30000000</span>)
}), root)

console.log(s(root))
<span class="org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgf2e8503" class="outline-2">
      <h2 id="orgf2e8503"><span class="section-number-2">19.</span>
      3.0.5</h2>
      <div class="outline-text-2" id="text-19"></div>
      <div id="outline-container-orgc86f7da" class="outline-3">
        <h3 id="orgc86f7da"><span class=
        "section-number-3">19.1.</span> <span class=
        "done DONE">DONE</span> <b>Bug Fixes</b>
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-19-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support transforming asset urls with
              full base url. (<a href=
              "https://github.com/vuejs/vue-next/issues/2477">#2477</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/db786b1afe41c26611a215e6d6599d50312b9c2f">db786b1</a>)</p>
              <p>针对相对路径而言，当提供了 base 选项的时候，会使用这个值去拼接，如：</p>
              <p><code>{ transformAssetUrls: { base:
              'https://www.cheng92.com' } }</code></p>
              <p><code>&lt;img src="./vue/img/test.png"
              /&gt;</code> 会被编译成：</p>
              <p><code>createVNode('img', { src:
              'https://www.cheng92.com/vue/img/test.png'
              })</code></p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>skip patchBlockChildren if n1.dynamicChildren is
              null (<a href=
              "https://github.com/vuejs/vue-next/issues/2717">#2717</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8">c59897c</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2715">#2715</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/2485">#2485</a></p>
              <div id="IR8Cl"></div>
              <script src="/assets/js/vue/tests/IR8Cl.js"></script>
              <p>这个问题原因是，一开始 HelloWorld 的 dynamicChildren 是
              null。</p>
              <p>当点击 ADD 按钮的时候增加了一项数据，会进入 mountChildren -&gt;
              patchBlockChildren</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span class=
                "org-keyword">const</span> <span class=
                "org-variable-name">patchBlockChildren</span>: <span class=
                "org-type">PatchBlockChildrenFn</span> = <span class=
                "org-rainbow-delimiters-depth-1">(</span>
    oldChildren,
    newChildren,
    fallbackContainer,
    parentComponent,
    parentSuspense,
    isSVG,
    slotScopeIds
  <span class=
"org-rainbow-delimiters-depth-1">)</span> <span class="org-keyword">=&gt;</span> <span class="org-rainbow-delimiters-depth-1">{</span>
    <span class="org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; <span class=
"org-type">newChildren</span>.<span class=
"org-type">length</span>; <span class=
"org-type">i</span>++<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
      <span class="org-keyword">const</span> <span class=
"org-variable-name">oldVNode</span> = oldChildren<span class=
"org-rainbow-delimiters-depth-3">[</span>i<span class=
"org-rainbow-delimiters-depth-3">]</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dynamicChildren</span>
      <span class="org-keyword">const</span> <span class=
"org-variable-name">newVNode</span> = newChildren<span class=
"org-rainbow-delimiters-depth-3">[</span>i<span class=
"org-rainbow-delimiters-depth-3">]</span>

      <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
      <span class="org-rainbow-delimiters-depth-2">}</span>
    <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
              </div>
              <p>而 <code>dynamicChildren</code> 在初始化的时候是个
              <code>null</code> 值, 一开始就访问了
              <code>dynamicChildren[i]</code> 所以导致报错。</p>
              <p>修复代码(<a href=
              "https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8">c59897c</a>)，加个判断条件：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span class=
                "org-diff-context">  if (</span>
<span class=
"org-diff-context">        patchFlag &gt; 0 &amp;&</span>
<span class=
"org-diff-context">        patchFlag & PatchFlags.STABLE_FRAGMENT &amp;&</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">        dynamicChildren &amp;&</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        dynamicChildren &amp;&</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">        n1.dynamicChildren</span>
<span class="org-diff-context">      ) {</span>
<span class=
"org-diff-context">        // a stable fragment (template root or &lt;template v-for&gt;) doesn't need to</span>
<span class=
"org-diff-context">        // patch children order, but it may contain dynamicChildren.</span>
<span class="org-diff-context">        patchBlockChildren(</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">         n1.dynamicChildren!,</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">          n1.dynamicChildren,</span>
<span class="org-diff-context">          dynamicChildren,</span>
<span class="org-diff-context">          container,</span>
<span class="org-diff-context">          parentComponent,</span>
<span class="org-diff-context">          parentSuspense,</span>
<span class="org-diff-context">          isSVG,</span>
<span class="org-diff-context">          slotScopeIds</span>
<span class="org-diff-context">        )</span>

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Zhicheng Lee</p>
    <p class="date">Created: 2022-03-14 Mon 17:46</p>
  </div>
</body>
</html>
