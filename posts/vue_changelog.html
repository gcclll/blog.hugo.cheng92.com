<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-03-12 Sat 21:01 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>Vue ChangeLog</title>
  <meta name="author" content="Zhicheng Lee">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="vue">
  <meta name="tags" content="CHANGELOG">
  <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;
        
          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster.bundle.min.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster-sideTip-punk.min.css">
  <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
  </script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster.bundle.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster-scrollableTip.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/tooltips.js"></script>
  <style>
           abbr {color: red;}
        
           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
  </style>
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">Vue ChangeLog</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#org42af6d0">1. 3.2 All Important Changes</a>
            <ul>
              <li>
                <a href="#slot-args">1.1. [3.2.4]
                slots.default(a,b,c,…) 插槽使用支持多个参数</a>
              </li>
              <li>
                <a href="#fix-vbind-class">1.2. v-bind style/class
                被解析成了 <code>[object Object]</code> ?</a>
              </li>
              <li>
                <a href="#orgd379207">1.3. <span class=
                "todo TODO">TODO</span> EffectScope ?</a>
              </li>
              <li>
                <a href="#deferredComputed">1.4.
                deferredComputed</a>
              </li>
              <li>
                <a href="#ReactiveEffect2Class">1.5. ReactiveEffect
                从函数变成了一个 class</a>
              </li>
              <li>
                <a href="#new-ref-sugar">1.6. 新增 ref 语法糖（$ref,
                $raw）</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgc96f331">2. 3.2.23~29(2021-11-16 ~
            2022-01-23)</a>
            <ul>
              <li>
                <a href="#orgf22a92c">2.1. Bug Fixes
                <code>[1/1]</code></a>
              </li>
              <li>
                <a href="#org74f0be7">2.2. Features
                <code>[3/3]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orga08a505">3. <span class=
            "done DONE">DONE</span> 3.2.14~22 (2021-09-22 ~
            2021-11-15)</a>
            <ul>
              <li>
                <a href="#orgea34fcd">3.1. Bug Fixes
                <code>[10/10]</code></a>
              </li>
              <li>
                <a href="#org9ed2363">3.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orge668e4a">4. <span class=
            "done DONE">DONE</span> 3.2.13 (2021-09-21)</a>
            <ul>
              <li>
                <a href="#org4fee1b4">4.1. Bug Fixes
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgbe80dab">5. <span class=
            "done DONE">DONE</span> 3.2.12(2021-09-17)</a>
            <ul>
              <li>
                <a href="#orga1b2a60">5.1. Bug Fixes
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org2de7f50">6. <span class=
            "done DONE">DONE</span> 3.2.4(2021-08-17)</a>
            <ul>
              <li>
                <a href="#org8aba9e7">6.1. Bug Fixes
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgcd4b4f1">7. <span class=
            "done DONE">DONE</span> 3.2.0-beta.8 (2021-08-07)</a>
            <ul>
              <li>
                <a href="#org1b1b1e5">7.1. Bug Fixes
                <code>[8/8]</code></a>
              </li>
              <li>
                <a href="#orgc1c24b5">7.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org6aa2909">8. <span class=
            "done DONE">DONE</span> 3.2.0-beta.7 (2021-07-29)</a>
            <ul>
              <li>
                <a href="#orgc7deb50">8.1. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#org8be51f2">8.2. Features
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orga30008e">9. <span class=
            "done DONE">DONE</span> 3.2.0-beta.6 (2021-07-27)</a>
            <ul>
              <li>
                <a href="#org455e858">9.1. Bug Fixes
                <code>[3/3]</code></a>
              </li>
              <li>
                <a href="#org9d8505b">9.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgdbdc06f">10. <span class=
            "done DONE">DONE</span> 3.2.0-beta.5 (2021-07-23)</a>
            <ul>
              <li>
                <a href="#org9e1609b">10.1. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#orge2c7f45">10.2. Features
                <code>[4/4]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org6f0659a">11. <span class=
            "done DONE">DONE</span> 3.2.0-beta.4 (2021-07-21)</a>
            <ul>
              <li>
                <a href="#orgef2e6b9">11.1. Bug Fixes
                <code>[2/2]</code></a>
              </li>
              <li>
                <a href="#orgaec7d2f">11.2. Performance
                Improvements <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org61ba30a">12. <span class=
            "done DONE">DONE</span> 3.2.0-beta.3 (2021-07-20)</a>
            <ul>
              <li>
                <a href="#orge1e4cd0">12.1. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#org17f4f44">12.2. Features
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org36f91e4">13. <span class=
            "done DONE">DONE</span> 3.2.0-beta.2 (2021-07-19)</a>
            <ul>
              <li>
                <a href="#org9c938b6">13.1. Bug Fixes
                <code>[11/11]</code></a>
              </li>
              <li>
                <a href="#org152b377">13.2. Features
                <code>[3/3]</code></a>
              </li>
              <li>
                <a href="#org8cb3293">13.3. Performance
                Improvements <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orga5d923f">14. <span class=
            "done DONE">DONE</span> 3.2.0-beta.1 (2021-07-16)</a>
            <ul>
              <li>
                <a href="#org2cb58ed">14.1. Code Refactoring(代码重构)
                <code>[1/1]</code></a>
              </li>
              <li>
                <a href="#org7e5fe63">14.2. Bug Fixes
                <code>[4/4]</code></a>
              </li>
              <li>
                <a href="#org53f44af">14.3. Features
                <code>[10/10]</code></a>
              </li>
              <li>
                <a href="#orgc8003d5">14.4. Performance
                improvements <code>[7/7]</code></a>
              </li>
              <li>
                <a href="#orgdd6e60a">14.5. Breaking Changes
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org4ecc333">15. 小结</a>
          </li>
          <li>
            <a href="#org8eabcc9">16. 3.0.8</a>
            <ul>
              <li>
                <a href="#org428a861">16.1. <span class=
                "done DONE">DONE</span> Performance Improvements
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org53ba78e">17. 3.0.7</a>
            <ul>
              <li>
                <a href="#orgb985cd9">17.1. <span class=
                "done DONE">DONE</span> Bug Fixes
                <code>[6/6]</code></a>
              </li>
              <li>
                <a href="#org25b8bf2">17.2. <span class=
                "done DONE">DONE</span> Performance Improvements
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org404e73c">18. 3.0.6</a>
            <ul>
              <li>
                <a href="#org2561184">18.1. Bug Fixes
                <code>[3/3]</code></a>
              </li>
              <li>
                <a href="#org7d63978">18.2. Features
                <code>[1/1]</code></a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org569bbcc">19. 3.0.5</a>
            <ul>
              <li>
                <a href="#org9b0769b">19.1. <span class=
                "done DONE">DONE</span> <b>Bug Fixes</b>
                <code>[2/2]</code></a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <p><a href="/"><img src=
    "https://img.shields.io/badge/GCCLL-Homepage-green?logo=gnu-emacs"></a></p>
    <div style=
    "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <h3>说明</h3>
      <p><a href=
      "https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md">https://github.com/vuejs/vue-next/blob/master/CHANGELOG.md</a></p>
      <p>本文只记录 <abbr class="tooltip" title=
      "The Progressive JavaScript Framework !&lt;br&gt;&lt;br&gt;An approachable, performant and versatile framework for building web user interfaces.&lt;br&gt;&lt;br&gt;&lt;strong&gt;Installation&lt;/strong&gt;:&lt;br&gt;&lt;br&gt;=$ npm init vue@latest=&lt;br&gt;&lt;br&gt;&lt;strong&gt;Without Build Tools&lt;/strong&gt;:">
      Vue3</abbr> 的一些重要更新点或重要的 BUG 修复，目的是为了对 <abbr class="tooltip"
      title=
      "The Progressive JavaScript Framework !&lt;br&gt;&lt;br&gt;An approachable, performant and versatile framework for building web user interfaces.&lt;br&gt;&lt;br&gt;&lt;strong&gt;Installation&lt;/strong&gt;:&lt;br&gt;&lt;br&gt;=$ npm init vue@latest=&lt;br&gt;&lt;br&gt;&lt;strong&gt;Without Build Tools&lt;/strong&gt;:">
      Vue3</abbr> 的 持续关注，本人主要致力于 <abbr class="tooltip" title=
      "The Progressive JavaScript Framework !&lt;br&gt;&lt;br&gt;An approachable, performant and versatile framework for building web user interfaces.&lt;br&gt;&lt;br&gt;&lt;strong&gt;Installation&lt;/strong&gt;:&lt;br&gt;&lt;br&gt;=$ npm init vue@latest=&lt;br&gt;&lt;br&gt;&lt;strong&gt;Without Build Tools&lt;/strong&gt;:">
      Vue3</abbr> 技术栈的开发。</p>
    </div><br>
    <br>
    <div id="outline-container-org42af6d0" class="outline-2">
      <h2 id="org42af6d0"><span class="section-number-2">1.</span>
      3.2 All Important Changes</h2>
      <div class="outline-text-2" id="text-1">
        <ul class="org-ul">
          <li>
            <abbr class="tooltip" title=
            "zsh:1: command not found: wn&lt;br&gt;">v-on</abbr> 支持
            <code>async...await</code> handler <a class="anchor"
            aria-hidden="true" id="von-async" href=
            "#von-async"><svg xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 16 16" width="16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <code>vm = createApp({ ...}).mount(...)</code> 返回的 vm
            上取不到 <code>expose({ foo: 1 })</code> 出来的 属性，
            <code>vm.foo === undefined</code> <a class="anchor"
            aria-hidden="true" id="expose-proxy" href=
            "#expose-proxy"><svg xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 16 16" width="16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <code>defineProps</code> 支持解构操作 <a class="anchor"
            aria-hidden="true" id="defineProps-destructure" href=
            "#defineProps-destructure"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ul>
      </div>
      <div id="outline-container-slot-args" class="outline-3">
        <h3 id="slot-args"><span class=
        "section-number-3">1.1.</span> [3.2.4]
        slots.default(a,b,c,…) 插槽使用支持多个参数</h3>
        <div class="outline-text-3" id="text-slot-args">
          <p>slot.default(…args) 支持多个参数。</p>
          <p>如： <code>h('div', null, slots.default('a', 'b',
          'c'))</code></p>
          <div class="org-src-container">
            <pre class="src src-html">&lt;<span style=
            "color: #c678dd;">template</span>&gt;
  &lt;<span style="color: #c678dd;">demo</span>&gt;
    &lt;<span style=
"color: #c678dd;">template</span> #default=<span style=
"color: #98be65;">"a,b,c"</span>&gt;{{a}}, {{b}}, {{c}}&lt;/<span style="color: #c678dd;">template</span>&gt;
  &lt;/<span style="color: #c678dd;">demo</span>&gt;
&lt;/<span style="color: #c678dd;">template</span>&gt;

// demo.js
export default {
  name: "Demo",
  props: { ... },
  render() {
    return h('h1', null, this.$slots.default("a", "b", "c"))
  }
}
</pre>
          </div>
          <p>FIX:</p>
          <div class="org-src-container">
            <pre class="src src-diff"><span style=
            "color: #a4aab6;"> packages/runtime-core/src/componentSlots.ts</span>
<span style=
"color: #a9a1e1;">@@ -63,15 +63,15 @@</span><span style="color: #46D9FF;"> const normalizeSlot = (</span>
<span style="color: #a4aab6;">  rawSlot: Function,</span>
<span style=
"color: #a4aab6;">  ctx: ComponentInternalInstance | null | undefined</span>
<span style="color: #a4aab6;">): Slot =&gt; {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  const normalized = withCtx((props: any) =&gt; {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  const normalized = withCtx((...args: any[]) =&gt; {</span>
<span style=
"color: #a4aab6;">    if (__DEV__ &amp;& currentInstance) {</span>
<span style="color: #a4aab6;">      warn(</span>
<span style=
"color: #a4aab6;">        `Slot "${key}" invoked outside of the render function: ` +</span>
<span style=
"color: #a4aab6;">          `this will not track dependencies used in the slot. ` +</span>
<span style=
"color: #a4aab6;">          `Invoke the slot function inside the render function instead.`</span>
<span style="color: #a4aab6;">      )</span>
<span style="color: #a4aab6;">    }</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    return normalizeSlotValue(rawSlot(props))</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    return normalizeSlotValue(rawSlot(...args))</span>
<span style="color: #a4aab6;">  }, ctx) as Slot</span>
<span style="color: #a4aab6;">  // NOT a compiled slot</span>
  ;(normalized as ContextualRenderFn)._c = false
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-fix-vbind-class" class=
      "outline-3">
        <h3 id="fix-vbind-class"><span class=
        "section-number-3">1.2.</span> v-bind style/class 被解析成了
        <code>[object Object]</code> ?</h3>
        <div class="outline-text-3" id="text-fix-vbind-class">
          <p>问题(<a href="">SFC playground</a>)：</p>
          <div class="org-src-container">
            <pre class="src src-html">&lt;<span style=
            "color: #c678dd;">template</span>&gt;
  &lt;<span style=
"color: #c678dd;">button</span> :class=<span style=
"color: #98be65;">"{ btn: true }"</span>&gt;1&lt;/<span style=
"color: #c678dd;">button</span>&gt;
  &lt;<span style="color: #c678dd;">button</span> <span style=
"color: #dcaeea;">v-bind</span>=<span style=
"color: #98be65;">"{ disabled: true }"</span> :class=<span style=
"color: #98be65;">"{ btn: true }"</span>&gt;2&lt;/<span style=
"color: #c678dd;">button</span>&gt;
  &lt;<span style=
"color: #c678dd;">button</span> :class=<span style=
"color: #98be65;">"{ btn: true }"</span> <span style=
"color: #dcaeea;">v-bind</span>=<span style=
"color: #98be65;">"{ disabled: true }"</span>&gt;3&lt;/<span style=
"color: #c678dd;">button</span>&gt;
&lt;/<span style="color: #c678dd;">template</span>&gt;

&lt;<span style="color: #c678dd;">style</span>&gt;
  .btn {
    color: red;
  }
&lt;/<span style="color: #c678dd;">style</span>&gt;
</pre>
          </div>
          <p>第 1，2 个按钮能正常解析出 <code>btn</code> 类名，但是第三个按钮的 class 变成了
          <code>[object Object]</code></p>
          <p>这要看下 <a href=
          "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/vnode.ts">
          runtime-core/src/vnode.ts:mergeProps</a>
          中是如何对属性进行合并的：</p>
          <p>它首先将第一个属性 extend 出来了，做为了一个基准对象，比如 btn3 就有了:</p>
          <p><code>ret = { class: { btn: true } }</code></p>
          <p>然后进入 for 循环处理剩下的属性 <code>{disabled: true}</code>,
          最后发现走了最后一个</p>
          <p><code>else if (key !== '')</code> 所以最后的 <code>ret = {
          class: { btn: true }, disabled: true }</code></p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span style=
            "color: #51afef;">export</span> <span style=
            "color: #51afef;">function</span> <span style=
            "color: #c678dd;">mergeProps</span><span style=
            "color: #51afef;">(</span>...args: <span style=
            "color: #c678dd;">(</span>Data & VNodeProps<span style=
            "color: #c678dd;">)[]</span><span style=
            "color: #51afef;">)</span> <span style=
            "color: #51afef;">{</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">ret</span> = <span style=
"color: #c678dd;">extend</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">{}</span>, args<span style=
"color: #98be65;">[</span><span style=
"color: #da8548; font-weight: bold;">0</span><span style=
"color: #98be65;">]</span><span style="color: #c678dd;">)</span>
  <span style="color: #51afef;">for</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">1</span>; i &lt; <span style=
"color: #ECBE7B;">args</span>.<span style=
"color: #ECBE7B;">length</span>; <span style=
"color: #ECBE7B;">i</span>++<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">toMerge</span> = args<span style=
"color: #98be65;">[</span>i<span style="color: #98be65;">]</span>
    <span style="color: #51afef;">for</span> <span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">key</span> <span style=
"color: #51afef;">in</span> toMerge<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>key === <span style=
"color: #98be65;">'class'</span><span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>ret.<span style=
"color: #51afef;">class</span> !== toMerge.<span style=
"color: #51afef;">class</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
          ret.<span style=
"color: #51afef;">class</span> = <span style=
"color: #c678dd;">normalizeClass</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">[</span>ret.<span style=
"color: #51afef;">class</span>, toMerge.<span style=
"color: #51afef;">class</span><span style=
"color: #98be65;">]</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">}</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>key === <span style=
"color: #98be65;">'style'</span><span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        ret.style = <span style=
"color: #c678dd;">normalizeStyle</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">[</span>ret.style, toMerge.style<span style=
"color: #c678dd;">]</span><span style="color: #51afef;">)</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span><span style=
"color: #c678dd;">isOn</span><span style=
"color: #51afef;">(</span>key<span style=
"color: #51afef;">)</span><span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">existing</span> = ret<span style=
"color: #51afef;">[</span>key<span style="color: #51afef;">]</span>
        <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">incoming</span> = toMerge<span style=
"color: #51afef;">[</span>key<span style="color: #51afef;">]</span>
        <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>existing !== incoming<span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
          ret<span style="color: #c678dd;">[</span>key<span style=
"color: #c678dd;">]</span> = existing
            ? <span style="color: #c678dd;">[]</span>.<span style=
"color: #c678dd;">concat</span><span style=
"color: #c678dd;">(</span>existing <span style=
"color: #51afef;">as</span> <span style=
"color: #51afef;">any</span>, incoming <span style=
"color: #51afef;">as</span> <span style=
"color: #51afef;">any</span><span style="color: #c678dd;">)</span>
            : incoming
        <span style="color: #51afef;">}</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>key !== <span style=
"color: #98be65;">''</span><span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        ret<span style="color: #51afef;">[</span>key<span style=
"color: #51afef;">]</span> = toMerge<span style=
"color: #51afef;">[</span>key<span style="color: #51afef;">]</span>
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">return</span> ret
<span style="color: #51afef;">}</span>
</pre>
          </div>
          <p>runtime-core 阶段只是对 props 进行了 normalize 处理，真正 patch
          的流程是：</p>
          <p>runtime-core: renderer.ts:patchProps -&gt;
          hostPatchProp = runtime-dom:patchProp.ts</p>
          <p>最后 class 的 patch 是
          runtime-dom/src/modules/class.ts:patchClass</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span style=
            "color: #5B6268;">// </span><span style=
            "color: #5B6268;">compiler should normalize class + :class bindings on the same element</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">into a single binding ['staticClass', dynamic]</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">patchClass</span><span style=
"color: #51afef;">(</span><span style=
"color: #dcaeea;">el</span>: <span style=
"color: #ECBE7B;">Element</span>, <span style=
"color: #dcaeea;">value</span>: <span style=
"color: #51afef;">string</span> | <span style=
"color: #a9a1e1;">null</span>, <span style=
"color: #dcaeea;">isSVG</span>: <span style=
"color: #51afef;">boolean</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">directly setting className should be faster than setAttribute in theory</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">if this is an element during a transition, take the temporary transition</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">classes into account.</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">transitionClasses</span> = <span style=
"color: #c678dd;">(</span>el <span style=
"color: #51afef;">as</span> ElementWithTransition<span style=
"color: #c678dd;">)</span>._vtc
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>transitionClasses<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    value = <span style="color: #98be65;">(</span>value
      ? <span style=
"color: #a9a1e1;">[</span>value, ...transitionClasses<span style=
"color: #a9a1e1;">]</span>
      : <span style=
"color: #a9a1e1;">[</span>...transitionClasses<span style=
"color: #a9a1e1;">]</span>
    <span style="color: #98be65;">)</span>.<span style=
"color: #c678dd;">join</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">' '</span><span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>value == <span style=
"color: #a9a1e1;">null</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    el.<span style=
"color: #c678dd;">removeAttribute</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'class'</span><span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>isSVG<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    el.<span style=
"color: #c678dd;">setAttribute</span><span style="color: #98be65;">(</span><span style="color: #98be65;">'class'</span>, value<span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #c678dd;">{</span>
    el.className = value
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
          </div>
          <p>而这里面直接就是 <code>setAttribute('class', value)</code> 或
          <code>el.className = value</code> 这就等于 是说一开始的 <code>ret =
          { class: { btn: true }, disable: true }</code> 中的
          <code>class: { btn: true }</code> 到这里 <code>value = {
          btn: true }</code> 最终被自动转成了 <code>[obect
          Object]</code></p>
          <p>那么解决办法就是在 runtime-core 的 normalize 阶段就将 class
          值对象处理成字符串， 如 <a href=
          "https://github.com/vuejs/vue-next/commit/2bdee50a598456392541a8a4b451501e5df2d363">
          commit</a> 所示。</p>
          <div class="org-src-container">
            <pre class="src src-diff"><span style=
            "color: #a4aab6;">packages/runtime-core/src/vnode.ts</span>
<span style=
"color: #a9a1e1;">@@ -778,8 +778,8 @@</span><span style="color: #46D9FF;"> export function normalizeChildren(vnode: VNode, children: unknown) {</span>
<span style="color: #a4aab6;">}</span>

<span style=
"color: #a4aab6;">export function mergeProps(...args: (Data & VNodeProps)[]) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  const ret = extend({}, args[0])</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  for (let i = 1; i &lt; args.length; i++) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  const ret: Data = {}</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  for (let i = 0; i &lt; args.length; i++) {</span>
<span style="color: #a4aab6;">    const toMerge = args[i]</span>
<span style=
"color: #a4aab6;">    for (const key in toMerge) {</span>
      if (key === 'class') {
</pre>
          </div>
          <p>不用 extend 将第一个 prop 放入基准对象，都直接进入 for 被处理掉。</p>
          <p>这个时候第一个 <code>{class: { btn: true } }</code> 会进入
          <code>normalizeClass([ret.class,
          toMerge.class])</code></p>
          <p><a href=
          "https://github.com/vuejs/vue-next/tree/master/packages/shared/src/normalizeProp.ts">
          shared/src/normalizeProp.ts:normalizeClass(value:
          unknown)</a></p>
          <p>此时检测到 class 是个对象最后被处理成 <code>"btn"</code> 字符串</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span style=
            "color: #51afef;">export</span> <span style=
            "color: #51afef;">function</span> <span style=
            "color: #c678dd;">normalizeClass</span><span style=
            "color: #51afef;">(</span><span style=
            "color: #dcaeea;">value</span>: <span style=
            "color: #51afef;">unknown</span><span style=
            "color: #51afef;">)</span>: <span style=
            "color: #51afef;">string</span> <span style=
            "color: #51afef;">{</span>
  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">res</span> = <span style=
"color: #98be65;">''</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">isString</span><span style=
"color: #98be65;">(</span>value<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    res = value
  <span style="color: #c678dd;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">isArray</span><span style=
"color: #98be65;">(</span>value<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">for</span> <span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>; i &lt; <span style=
"color: #ECBE7B;">value</span>.<span style=
"color: #ECBE7B;">length</span>; <span style=
"color: #ECBE7B;">i</span>++<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">normalized</span> = <span style=
"color: #c678dd;">normalizeClass</span><span style=
"color: #a9a1e1;">(</span>value<span style=
"color: #51afef;">[</span>i<span style=
"color: #51afef;">]</span><span style="color: #a9a1e1;">)</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>normalized<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        res += normalized + <span style=
"color: #98be65;">' '</span>
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">isObject</span><span style=
"color: #98be65;">(</span>value<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">for</span> <span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">name</span> <span style=
"color: #51afef;">in</span> value<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>value<span style=
"color: #51afef;">[</span>name<span style=
"color: #51afef;">]</span><span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        res += name + <span style="color: #98be65;">' '</span>
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">return</span> res.<span style=
"color: #c678dd;">trim</span><span style=
"color: #c678dd;">()</span>
<span style="color: #51afef;">}</span>


</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-orgd379207" class="outline-3">
        <h3 id="orgd379207"><span class=
        "section-number-3">1.3.</span> <span class=
        "todo TODO">TODO</span> EffectScope ?</h3>
      </div>
      <div id="outline-container-deferredComputed" class=
      "outline-3">
        <h3 id="deferredComputed"><span class=
        "section-number-3">1.4.</span> deferredComputed</h3>
        <div class="outline-text-3" id="text-deferredComputed">
          <div class="warn" id="org1064076">
            <p></p>
            <p><strong>WARNING</strong></p>
            <p></p>
            <p>没有被暴露的 api ，只限 vue 内部 @vue/reactivity 使用。</p>
          </div>
          <div class="org-src-container">
            <pre class="src src-js"><span style=
            "color: #51afef;">const</span> <span style=
            "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../reactivity/dist/reactivity.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { reactive, effect, ref, deferredComputed } = value

;(<span style="color: #51afef;">async</span> <span style=
"color: #51afef;">function</span> () {
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">tick</span> = Promise.resolve()
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">src</span> = ref(<span style=
"color: #da8548; font-weight: bold;">0</span>)
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">c</span> = deferredComputed(() =&gt; src.value)
<span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">spy</span> = (val) =&gt; {
console.log(<span style=
"color: #98be65;">"i = "</span> + i++ + <span style=
"color: #98be65;">', val = '</span> + val)
}
effect(() =&gt; spy(c.value))

src.value = <span style=
"color: #da8548; font-weight: bold;">1</span>
src.value = <span style=
"color: #da8548; font-weight: bold;">2</span>
src.value = <span style=
"color: #da8548; font-weight: bold;">3</span>

console.log(<span style="color: #98be65;">'1: i = '</span> + i)
<span style="color: #51afef;">await</span> tick <span style=
"color: #5B6268;">// </span><span style=
"color: #5B6268;">to flush jobs</span>
console.log(<span style="color: #98be65;">'2: i = '</span> + i)
}())

<span style="color: #51afef;">return</span> <span style=
"color: #98be65;">''</span>
</pre>
          </div>
          <p>看个正常 computed 的例子:</p>
          <div class="org-src-container">
            <pre class="src src-js"><span style=
            "color: #51afef;">const</span> <span style=
            "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../reactivity/dist/reactivity.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { reactive, effect, ref, computed } = value

;(<span style="color: #51afef;">async</span> <span style=
"color: #51afef;">function</span> () {
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">tick</span> = Promise.resolve()
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">src</span> = ref(<span style=
"color: #da8548; font-weight: bold;">0</span>)
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">c</span> = computed(() =&gt; src.value)
<span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">spy</span> = (val) =&gt; {
console.log(<span style=
"color: #98be65;">"i = "</span> + i++ + <span style=
"color: #98be65;">', val = '</span> + val)
}
effect(() =&gt; spy(c.value))

src.value = <span style=
"color: #da8548; font-weight: bold;">1</span>
src.value = <span style=
"color: #da8548; font-weight: bold;">2</span>
src.value = <span style=
"color: #da8548; font-weight: bold;">3</span>

console.log(<span style="color: #98be65;">'1: i = '</span> + i)
<span style="color: #51afef;">await</span> tick <span style=
"color: #5B6268;">// </span><span style=
"color: #5B6268;">to flush jobs</span>
console.log(<span style="color: #98be65;">': i = '</span> + i)
}())

<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">2</span>
</pre>
          </div>
          <p>对比两个结果会发现：</p>
          <p>正常的 computed 在 <code>src.value</code> 改变时每次都会执行 spy,
          这是因为 <code>computed(() =&gt; src.value)</code> 操作让 src
          track 了这个 <code>() =&gt; src.value</code> 因此只要值发生改变就会立即
          执行它，而对于计算属性 c 又依赖了 src.value 因此触发 c 重新计算，从而调用 spy。</p>
          <p>而在 deferredComputed 的实现中将 effect 加入到了 scheduler
          异步队列中去执行，导 致同步的代码没有执行结束之前是不会执行的，只要不重新计算 c.value 就不会改变。那 么
          effect spy 也就不会被执行，从而导致 spy 不会在 src.value 改变时被立即调用。</p>
          <p>但是在后面调用了 <code>await nextTick()</code> 之后会立即将
          scheduler 的队列 flush 掉，此时才 会去执行 compute 重新计算 c.value
          的值，得到的也就是最后一次 src.value 的值(<b>要 清楚一点 await 之前 src.value
          是会发生改变的，只是不会触发重新计算</b>)，然后 c.value 的改变会触发 <code>effect(()
          =&gt; spy(c.value))</code> 去执行。</p>
          <p>关于 scheduler 和 nextTick 可阅读这两文：</p>
          <p><a href="file:///vue/vue-teardown-2-sheduler/">Vue3
          功能拆解② Scheduler 渲染机制</a></p>
          <p><a href=
          "http://localhost:1313/vue/vue-mind-map-runtime-core-1/#scheduler">
          Vue3 源码头脑风暴之 7 ☞ runtime-core(1) - 若叶知秋 - scheduler
          任务调度机制</a></p>
          <p>deferredComputed 源码如下：</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span style=
            "color: #5B6268;">// </span><span style=
            "color: #5B6268;">只会将 effect 加入 job 队列，不会立即执行</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">scheduler</span> = <span style=
"color: #51afef;">(</span>fn: <span style=
"color: #51afef;">any</span><span style=
"color: #51afef;">)</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">{</span>
  queue.<span style="color: #c678dd;">push</span><span style=
"color: #c678dd;">(</span>fn<span style="color: #c678dd;">)</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>!queued<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    queued = <span style="color: #a9a1e1;">true</span>
    tick.<span style="color: #c678dd;">then</span><span style=
"color: #98be65;">(</span>flush<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">class</span> <span style=
"color: #ECBE7B;">DeferredComputedRefImpl</span>&lt;<span style=
"color: #ECBE7B;">T</span>&gt; <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">constructor</span><span style=
"color: #c678dd;">(</span>getter: <span style=
"color: #ECBE7B;">ComputedGetter</span>&lt;<span style=
"color: #ECBE7B;">T</span>&gt;<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">compareTarget</span>: <span style=
"color: #51afef;">any</span>
    <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">hasCompareTarget</span> = <span style=
"color: #a9a1e1;">false</span>
    <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">scheduled</span> = <span style=
"color: #a9a1e1;">false</span>
    <span style="color: #51afef;">this</span>.effect = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">ReactiveEffect</span><span style=
"color: #98be65;">(</span>getter, <span style=
"color: #a9a1e1;">(</span>computedTrigger?: <span style=
"color: #51afef;">boolean</span><span style=
"color: #a9a1e1;">)</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #a9a1e1;">{</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span><span style=
"color: #51afef;">this</span>.dep<span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>computedTrigger<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
          compareTarget = <span style=
"color: #51afef;">this</span>._value
          hasCompareTarget = <span style=
"color: #a9a1e1;">true</span>
        <span style="color: #c678dd;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>!scheduled<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
          <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">valueToCompare</span> = hasCompareTarget ? compareTarget : <span style="color: #51afef;">this</span>._value
          scheduled = <span style="color: #a9a1e1;">true</span>
          hasCompareTarget = <span style=
"color: #a9a1e1;">false</span>
          <span style=
"color: #c678dd;">scheduler</span><span style="color: #98be65;">(</span><span style="color: #a9a1e1;">()</span> <span style="color: #51afef;">=&gt;</span> <span style="color: #a9a1e1;">{</span>
            <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span><span style=
"color: #51afef;">this</span>.effect.active &amp;& <span style=
"color: #51afef;">this</span>.<span style=
"color: #c678dd;">_get</span><span style=
"color: #c678dd;">()</span> !== valueToCompare<span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
              <span style=
"color: #c678dd;">triggerRefValue</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
            <span style="color: #51afef;">}</span>
            scheduled = <span style="color: #a9a1e1;">false</span>
          <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
        <span style="color: #c678dd;">}</span>
        <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">chained upstream computeds are notified synchronously to ensure</span>
        <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">value invalidation in case of sync access; normal effects are</span>
        <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">deferred to be triggered in scheduler.</span>
        <span style="color: #51afef;">for</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">e</span> <span style=
"color: #51afef;">of</span> <span style=
"color: #51afef;">this</span>.dep<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
          <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>e.computed<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
            e.scheduler!<span style=
"color: #a9a1e1;">(</span><span style=
"color: #a9a1e1;">true</span> <span style=
"color: #5B6268;">/* </span><span style=
"color: #5B6268;">computedTrigger */</span><span style=
"color: #a9a1e1;">)</span>
          <span style="color: #98be65;">}</span>
        <span style="color: #c678dd;">}</span>
      <span style="color: #51afef;">}</span>
      <span style=
"color: #51afef;">this</span>._dirty = <span style=
"color: #a9a1e1;">true</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
    <span style=
"color: #51afef;">this</span>.effect.computed = <span style=
"color: #a9a1e1;">true</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #51afef;">private</span> <span style=
"color: #c678dd;">_get</span><span style=
"color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">this</span>._dirty<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style=
"color: #51afef;">this</span>._dirty = <span style=
"color: #a9a1e1;">false</span>
      <span style="color: #51afef;">return</span> <span style=
"color: #a9a1e1;">(</span><span style=
"color: #51afef;">this</span>._value = <span style=
"color: #51afef;">this</span>.effect.<span style=
"color: #c678dd;">run</span><span style=
"color: #51afef;">()</span>!<span style="color: #a9a1e1;">)</span>
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">return</span> <span style=
"color: #51afef;">this</span>._value
  <span style="color: #c678dd;">}</span>

  <span style="color: #51afef;">get</span> <span style=
"color: #c678dd;">value</span><span style=
"color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #c678dd;">trackRefValue</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #98be65;">)</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">the computed ref may get wrapped by other proxies e.g. readonly() #3376</span>
    <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">toRaw</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">this</span><span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">_get</span><span style=
"color: #98be65;">()</span>
  <span style="color: #c678dd;">}</span>

<span style="color: #51afef;">}</span>
</pre>
          </div>
          <p>而对于 computed 就没那么多操作</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span style=
            "color: #51afef;">class</span> <span style=
            "color: #ECBE7B;">ComputedRefImpl</span>&lt;<span style=
            "color: #ECBE7B;">T</span>&gt; <span style=
            "color: #51afef;">{</span>
  <span style="color: #51afef;">public</span> dep?: <span style=
"color: #ECBE7B;">Dep</span> = <span style=
"color: #a9a1e1;">undefined</span>

  <span style="color: #51afef;">private</span> _value!: T
  <span style=
"color: #51afef;">private</span> _dirty = <span style="color: #a9a1e1;">true</span>
  <span style="color: #51afef;">public</span> <span style=
"color: #51afef;">readonly</span> effect: <span style=
"color: #ECBE7B;">ReactiveEffect</span>&lt;<span style=
"color: #ECBE7B;">T</span>&gt;

  <span style="color: #51afef;">public</span> <span style=
"color: #51afef;">readonly</span> __v_isRef = <span style=
"color: #a9a1e1;">true</span>
  <span style="color: #51afef;">public</span> <span style=
"color: #51afef;">readonly</span> <span style=
"color: #c678dd;">[</span>ReactiveFlags.IS_READONLY<span style=
"color: #c678dd;">]</span>: <span style=
"color: #51afef;">boolean</span>

  <span style="color: #51afef;">constructor</span><span style=
"color: #c678dd;">(</span>
    getter: <span style=
"color: #ECBE7B;">ComputedGetter</span>&lt;<span style=
"color: #ECBE7B;">T</span>&gt;,
    <span style="color: #51afef;">private</span> <span style=
"color: #51afef;">readonly</span> _setter: <span style=
"color: #ECBE7B;">ComputedSetter</span>&lt;<span style=
"color: #ECBE7B;">T</span>&gt;,
    isReadonly: <span style="color: #51afef;">boolean</span>
  <span style="color: #c678dd;">)</span> <span style=
"color: #c678dd;">{</span>

    <span style="color: #51afef;">this</span>.effect = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">ReactiveEffect</span><span style=
"color: #98be65;">(</span>getter, <span style=
"color: #a9a1e1;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #a9a1e1;">{</span> <span style=
"color: #5B6268;">// </span><span style=
"color: #5B6268;">scheduler</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>!<span style=
"color: #51afef;">this</span>._dirty<span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style=
"color: #51afef;">this</span>._dirty = <span style=
"color: #a9a1e1;">true</span>
        <span style=
"color: #c678dd;">triggerRefValue</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
      <span style="color: #51afef;">}</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
    <span style="color: #a9a1e1;">this</span><span style=
"color: #98be65;">[</span>ReactiveFlags.IS_READONLY<span style=
"color: #98be65;">]</span> = isReadonly
  <span style="color: #c678dd;">}</span>

  <span style="color: #51afef;">get</span> <span style=
"color: #c678dd;">value</span><span style=
"color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">the computed ref may get wrapped by other proxies e.g. readonly() #3376</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">self</span> = <span style=
"color: #c678dd;">toRaw</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #98be65;">)</span>
    <span style="color: #c678dd;">trackRefValue</span><span style=
"color: #98be65;">(</span>self<span style=
"color: #98be65;">)</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>self._dirty<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      self._dirty = <span style="color: #a9a1e1;">false</span>
      self._value = self.effect.<span style=
"color: #c678dd;">run</span><span style=
"color: #a9a1e1;">()</span>!
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">return</span> self._value
  <span style="color: #c678dd;">}</span>

  <span style="color: #51afef;">set</span> <span style=
"color: #c678dd;">value</span><span style=
"color: #c678dd;">(</span>newValue: T<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">this</span>.<span style=
"color: #c678dd;">_setter</span><span style=
"color: #98be65;">(</span>newValue<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-ReactiveEffect2Class" class=
      "outline-3">
        <h3 id="ReactiveEffect2Class"><span class=
        "section-number-3">1.5.</span> ReactiveEffect 从函数变成了一个
        class</h3>
        <div class="outline-text-3" id="text-ReactiveEffect2Class">
          <div class="org-src-container">
            <pre class="src src-typescript"><span style=
            "color: #51afef;">export</span> <span style=
            "color: #51afef;">class</span> <span style=
            "color: #ECBE7B;">ReactiveEffect</span>&lt;<span style=
            "color: #ECBE7B;">T</span> = <span style=
            "color: #51afef;">any</span>&gt; <span style=
            "color: #51afef;">{</span>
  active = <span style="color: #a9a1e1;">true</span>
  deps: <span style="color: #ECBE7B;">Dep</span><span style=
"color: #c678dd;">[]</span> = <span style=
"color: #c678dd;">[]</span>

  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">can be attached after creation</span>
  computed?: <span style="color: #51afef;">boolean</span>
  allowRecurse?: <span style="color: #51afef;">boolean</span>
  onStop?: <span style="color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">void</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">dev only</span>
  onTrack?: <span style=
"color: #c678dd;">(</span>event: <span style=
"color: #ECBE7B;">DebuggerEvent</span><span style=
"color: #c678dd;">)</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">void</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">dev only</span>
  onTrigger?: <span style=
"color: #c678dd;">(</span>event: <span style=
"color: #ECBE7B;">DebuggerEvent</span><span style=
"color: #c678dd;">)</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">void</span>

  <span style="color: #51afef;">constructor</span><span style=
"color: #c678dd;">(</span>
    <span style="color: #51afef;">public</span> fn: <span style=
"color: #98be65;">()</span> <span style=
"color: #51afef;">=&gt;</span> T,
    <span style=
"color: #51afef;">public</span> scheduler: <span style=
"color: #ECBE7B;">EffectScheduler</span> | <span style=
"color: #a9a1e1;">null</span> = <span style=
"color: #a9a1e1;">null</span>,
    scope?: <span style=
"color: #ECBE7B;">EffectScope</span> | <span style=
"color: #a9a1e1;">null</span>
  <span style="color: #c678dd;">)</span> <span style=
"color: #c678dd;">{</span>
    <span style=
"color: #c678dd;">recordEffectScope</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">this</span>, scope<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #c678dd;">run</span><span style=
"color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>!<span style=
"color: #51afef;">this</span>.active<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">return</span> <span style=
"color: #51afef;">this</span>.<span style=
"color: #c678dd;">fn</span><span style="color: #a9a1e1;">()</span>
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>!effectStack.<span style=
"color: #c678dd;">includes</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #a9a1e1;">this</span><span style=
"color: #a9a1e1;">)</span><span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">try</span> <span style=
"color: #a9a1e1;">{</span>
        effectStack.<span style=
"color: #c678dd;">push</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">(</span>activeEffect = <span style=
"color: #a9a1e1;">this</span><span style=
"color: #c678dd;">)</span><span style="color: #51afef;">)</span>
        <span style=
"color: #c678dd;">enableTracking</span><span style=
"color: #51afef;">()</span>

        trackOpBit = <span style=
"color: #da8548; font-weight: bold;">1</span> &lt;&lt; ++effectTrackDepth

        <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>effectTrackDepth &lt;= maxMarkerBits<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
          <span style=
"color: #c678dd;">initDepMarkers</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">{</span>
          <span style=
"color: #c678dd;">cleanupEffect</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">}</span>
        <span style="color: #51afef;">return</span> <span style=
"color: #51afef;">this</span>.<span style=
"color: #c678dd;">fn</span><span style="color: #51afef;">()</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">finally</span> <span style=
"color: #a9a1e1;">{</span>
        <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>effectTrackDepth &lt;= maxMarkerBits<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
          <span style=
"color: #c678dd;">finalizeDepMarkers</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">}</span>

        trackOpBit = <span style=
"color: #da8548; font-weight: bold;">1</span> &lt;&lt; --effectTrackDepth

        <span style=
"color: #c678dd;">resetTracking</span><span style=
"color: #51afef;">()</span>
        effectStack.<span style=
"color: #c678dd;">pop</span><span style="color: #51afef;">()</span>
        <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">n</span> = effectStack.length
        activeEffect = n &gt; <span style=
"color: #da8548; font-weight: bold;">0</span> ? effectStack<span style="color: #51afef;">[</span>n - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">]</span> : <span style="color: #a9a1e1;">undefined</span>
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #c678dd;">stop</span><span style=
"color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">this</span>.active<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style=
"color: #c678dd;">cleanupEffect</span><span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">this</span><span style="color: #a9a1e1;">)</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span><span style=
"color: #51afef;">this</span>.onStop<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        <span style="color: #51afef;">this</span>.<span style=
"color: #c678dd;">onStop</span><span style=
"color: #51afef;">()</span>
      <span style="color: #a9a1e1;">}</span>
      <span style=
"color: #51afef;">this</span>.active = <span style=
"color: #a9a1e1;">false</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
          </div>
          <p>依赖收集的时候：</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span style=
            "color: #51afef;">export</span> <span style=
            "color: #51afef;">function</span> <span style=
            "color: #c678dd;">effect</span>&lt;<span style=
            "color: #ECBE7B;">T</span> = <span style=
            "color: #51afef;">any</span>&gt;<span style=
            "color: #51afef;">(</span>
  fn: <span style="color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> T,
  options?: <span style=
"color: #ECBE7B;">ReactiveEffectOptions</span>
<span style="color: #51afef;">)</span>: <span style=
"color: #ECBE7B;">ReactiveEffectRunner</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">(</span>fn <span style=
"color: #51afef;">as</span> ReactiveEffectRunner<span style=
"color: #98be65;">)</span>.effect<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    fn = <span style="color: #98be65;">(</span>fn <span style=
"color: #51afef;">as</span> ReactiveEffectRunner<span style=
"color: #98be65;">)</span>.effect.fn
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">1. new instance</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">_effect</span> = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">ReactiveEffect</span><span style=
"color: #c678dd;">(</span>fn<span style="color: #c678dd;">)</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>options<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #c678dd;">extend</span><span style=
"color: #98be65;">(</span>_effect, options<span style=
"color: #98be65;">)</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>options.scope<span style=
"color: #98be65;">)</span> <span style=
"color: #c678dd;">recordEffectScope</span><span style=
"color: #98be65;">(</span>_effect, options.scope<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>!options || !options.lazy<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">2. run</span>
    _effect.<span style="color: #c678dd;">run</span><span style=
"color: #98be65;">()</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">runner</span> = _effect.run.<span style=
"color: #c678dd;">bind</span><span style=
"color: #c678dd;">(</span>_effect<span style=
"color: #c678dd;">)</span> <span style=
"color: #51afef;">as</span> ReactiveEffectRunner
  runner.effect = _effect
  <span style="color: #51afef;">return</span> runner
<span style="color: #51afef;">}</span>
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-new-ref-sugar" class="outline-3">
        <h3 id="new-ref-sugar"><span class=
        "section-number-3">1.6.</span> 新增 ref 语法糖（$ref, $raw）</h3>
        <div class="outline-text-3" id="text-new-ref-sugar">
          <p>新增 ref 语法糖：</p>
          <ol class="org-ol">
            <li>
              <p><code>$ref()</code> 被解析成 <code>_ref()</code></p>
              <p>如： <code>let foo = $ref(1)</code> =&gt; <code>let
              foo = _ref(1)</code></p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> =
      process.env.VNEXT_PKG_RC + <span style=
"color: #98be65;">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">"stb-"</span>, <span style=
"color: #98be65;">""</span>));
<span style=
"color: #51afef;">const</span> { compileScript, parse } = value;

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">compileSFCScript</span>(<span style=
"color: #dcaeea;">src</span>, <span style=
"color: #dcaeea;">options</span>) {
  <span style=
"color: #51afef;">const</span> { descriptor } = parse(src)
  <span style=
"color: #51afef;">return</span> compileScript(descriptor, {
    ...options,
    id: <span style="color: #98be65;">'xxxxxxx'</span>
  })
}

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">compileWithRefSugar</span>(<span style=
"color: #dcaeea;">src</span>) {
  <span style=
"color: #51afef;">return</span> compileSFCScript(src, { refSugar: <span style="color: #a9a1e1;">true</span> })
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">_</span> = (title, src) =&gt; {
  <span style=
"color: #51afef;">const</span> { content } = compileWithRefSugar(src)
  console.log(title, <span style=
"color: #98be65;">'\n'</span>, content)
}

_(<span style=
"color: #98be65;">'$ref declarations &gt; '</span>, <span style=
"color: #98be65;">`&lt;script setup&gt;</span>
<span style="color: #98be65;">    let foo = $ref()</span>
<span style="color: #98be65;">    let a = $ref(1)</span>
<span style="color: #98be65;">    let b = $ref({</span>
<span style="color: #98be65;">      count: 0</span>
<span style="color: #98be65;">    })</span>
<span style="color: #98be65;">    let c = () =&gt; {}</span>
<span style="color: #98be65;">    let d</span>
<span style="color: #98be65;">    &lt;/script&gt;`</span>)

<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>;

</pre>
              </div>
            </li>
          </ol>
        </div>
      </div>
    </div>
    <div id="outline-container-orgc96f331" class="outline-2">
      <h2 id="orgc96f331"><span class="section-number-2">2.</span>
      3.2.23~29(2021-11-16 ~ 2022-01-23)</h2>
      <div class="outline-text-2" id="text-2"></div>
      <div id="outline-container-orgf22a92c" class="outline-3">
        <h3 id="orgf22a92c"><span class=
        "section-number-3">2.1.</span> Bug Fixes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-2-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: handle initial undefined attrs
              (<a href=
              "https://github.com/vuejs/core/issues/5017">#5017</a>)
              (<a href=
              "https://github.com/vuejs/core/commit/6d887aaf591cfa05d5fea978bbd87e3e502bfa86">6d887aa</a>),
              closes <a href=
              "https://github.com/vuejs/core/issues/5016">#5016</a></p>
              <p>值为 <code>undefined</code> 的 attrs 在值发生变化时会被解析到
              props 中去。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-core/src/componentProps.ts</span>
<span style=
"color: #a9a1e1;">@@ -369,7 +369,7 @@</span><span style="color: #46D9FF;"> function setFullProps(</span>
<span style="color: #a4aab6;">            continue</span>
<span style="color: #a4aab6;">          }</span>
<span style="color: #a4aab6;">        }</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">        if (value !== attrs[key]) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        if (</span><span style="color: #98be65; background-color: #21242b;">!(key in attrs) ||</span><span style="color: #98be65; background-color: #21242b;"> value !== attrs[key]) {</span>
<span style="color: #a4aab6;">          attrs[key] = value</span>
<span style=
"color: #a4aab6;">          hasAttrsChanged = true</span>
        }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org74f0be7" class="outline-3">
        <h3 id="org74f0be7"><span class=
        "section-number-3">2.2.</span> Features
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-2-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: support default value in toRef()
              (<a href=
              "https://github.com/vuejs/core/commit/2db9c909c2cf3845f57b2c930c05cd6c17abe3b0">2db9c90</a>)</p>
              <p>支持设置默认值： <code>toRef(obj, 'x', 1)</code></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/reactivity/src/ref.ts</span>

<span style=
"color: #a4aab6;">class ObjectRefImpl&lt;T extends object, K extends keyof T&gt; {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  constructor(private readonly _object: T, private readonly _key: K) {}</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  constructor(</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    private readonly _object: T,</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    private readonly _key: K,</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    private readonly _defaultValue?: T[K]</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  ) {}</span>

<span style="color: #a4aab6;">  get value() {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    return this._object[this._key]</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    const val = this._object[this._key]</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    return val === undefined ? (this._defaultValue as T[K]) : val</span>
  }
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code> support ref in v-for, remove compat
              deprecation warnings (<a href=
              "https://github.com/vuejs/core/commit/41c18effea9dd32ab899b5de3bb0513abdb52ee4">41c18ef</a>)
            </li>
            <li class="on">
              <code>[X]</code>
              <p>types/script-setup: add generic type to
              defineExpose (<a href=
              "https://github.com/vuejs/core/issues/5035">#5035</a>)
              (<a href=
              "https://github.com/vuejs/core/commit/34985fee6b23018b6eb6322239db6165c1b0e273">34985fe</a>)
              OLD:</p>
              <div class="org-src-container">
                <pre class="src src-html">&lt;<span style=
                "color: #c678dd;">script</span> setup <span style=
                "color: #dcaeea;">lang</span>=<span style=
                "color: #98be65;">"ts"</span>&gt;
    import type { IMyComponent } from './MyComponent';

    const publicAPI: IMyComponent = {
        doSomething() {
            // ...
        },
    };

    defineExpose(publicAPI);
&lt;/<span style="color: #c678dd;">script</span>&gt;
</pre>
              </div>
              <p>NEW:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #c678dd;">defineExpose</span>&lt;<span style=
                "color: #ECBE7B;">IMyComponent</span>&gt;<span style=
                "color: #51afef;">(</span><span style=
                "color: #c678dd;">{</span>
    <span style="color: #c678dd;">doSomething</span><span style=
"color: #98be65;">()</span> <span style="color: #98be65;">{</span>
        <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
    <span style="color: #98be65;">}</span>,
<span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>;

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orga08a505" class="outline-2">
      <h2 id="orga08a505"><span class="section-number-2">3.</span>
      <span class="done DONE">DONE</span> 3.2.14~22 (2021-09-22 ~
      2021-11-15)</h2>
      <div class="outline-text-2" id="text-3">
        <p>这段时间的更新还是以修复 bug 为主的，另外更新了一个主要的特性
        <code>defineProps</code> 支持解 构。</p>
      </div>
      <div id="outline-container-orgea34fcd" class="outline-3">
        <h3 id="orgea34fcd"><span class=
        "section-number-3">3.1.</span> Bug Fixes
        <code>[10/10]</code></h3>
        <div class="outline-text-3" id="text-3-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: fix local var access check for
              bindings in normal script (<a href=
              "https://github.com/vuejs/vue-next/commit/6d6cc9091280ba132d92850f30db31c9152af599">6d6cc90</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4644">#4644</a></p>
              <p>解决 <code>script</code> 和 <code>script setup</code>
              一起用的时候找不到变量问题。</p>
              <div class="org-src-container">
                <pre class="src src-js"> expect(() =&gt;
    compile(<span style="color: #98be65;">`</span>
<span style=
"color: #98be65;">        &lt;script&gt;const bar = 1&lt;/script&gt;</span>
<span style="color: #98be65;">        &lt;script setup&gt;</span>
<span style="color: #98be65;">        defineProps({</span>
<span style="color: #98be65;">          foo: {</span>
<span style=
"color: #98be65;">            default: () =&gt; bar</span>
<span style="color: #98be65;">          }</span>
<span style="color: #98be65;">        })</span>
<span style="color: #98be65;">        &lt;/script&gt;`</span>)
).not.toThrow(<span style=
"color: #98be65;">`cannot reference locally declared variables`</span>)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-core: should treat attribute key as
              expression (<a href=
              "https://github.com/vuejs/vue-next/issues/4658">#4658</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/7aa0ea06c822d84a1d43b40cf5643b983aae6d36">7aa0ea0</a>)</p>
              <p><code>&lt;template v-for="a in b"
              key="c"/&gt;</code> 中的 <code>c</code> 被解析成了变量
              <code>_ctx.c</code> 问题。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: fix props codegen w/ leading import
              (<a href=
              "https://github.com/vuejs/vue-next/commit/d4c04e979934b81a30467aa4b1e717175b9b2d80">d4c04e9</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4764">#4764</a></p>
              <div class="org-src-container">
                <pre class=
                "src src-js">&lt;script setup&gt;<span style=
                "color: #51afef;">import</span> { ref } from <span style=
                "color: #98be65;">'vue'</span> <span style=
                "color: #5B6268;">// </span><span style=
                "color: #5B6268;">this line will cause an error</span>
 <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">props</span>=defineProps({
   foo:String
 })

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">msg</span> = ref(<span style=
"color: #98be65;">'Hello World!'</span>)
&lt;/script&gt;

&lt;template&gt;
  &lt;h1&gt;{{ msg }}&lt;/h1&gt;
  &lt;input v-model=<span style="color: #98be65;">"msg"</span>&gt;
&lt;/template&gt;
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support runtime Enum in normal
              script (<a href=
              "https://github.com/vuejs/vue-next/issues/4698">#4698</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/f66d456b7a39db9dae7e70c28bb431ff293d8fef">f66d456</a>)</p>
              <div class="org-src-container">
                <pre class="src src-typescript">   <span style=
                "color: #c678dd;">test</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #98be65;">'runtime Enum in normal script'</span>, <span style="color: #c678dd;">()</span> <span style="color: #51afef;">=&gt;</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #98be65;">{</span> content, bindings <span style=
"color: #98be65;">}</span> = <span style=
"color: #c678dd;">compile</span><span style=
"color: #98be65;">(</span>
        <span style=
"color: #98be65;">`&lt;script lang="ts"&gt;</span>
<span style=
"color: #98be65;">          export enum D { D = "D" }</span>
<span style=
"color: #98be65;">          const enum C { C = "C" }</span>
<span style="color: #98be65;">          enum B { B = "B" }</span>
<span style="color: #98be65;">        &lt;/script&gt;</span>
<span style=
"color: #98be65;">        &lt;script setup lang="ts"&gt;</span>
<span style="color: #98be65;">        enum Foo { A = 123 }</span>
<span style="color: #98be65;">        &lt;/script&gt;`</span>
      <span style="color: #98be65;">)</span>
      <span style="color: #c678dd;">assertCode</span><span style=
"color: #98be65;">(</span>content<span style=
"color: #98be65;">)</span>
      <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>bindings<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toStrictEqual</span><span style=
"color: #98be65;">(</span><span style="color: #a9a1e1;">{</span>
        D: <span style=
"color: #ECBE7B;">BindingTypes.SETUP</span>_CONST,
        C: <span style=
"color: #ECBE7B;">BindingTypes.SETUP</span>_CONST,
        B: <span style=
"color: #ECBE7B;">BindingTypes.SETUP</span>_CONST,
        Foo: <span style=
"color: #ECBE7B;">BindingTypes.SETUP</span>_CONST
      <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
    <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>custom-element: fix custom element props access on
              initial render (<a href=
              "https://github.com/vuejs/vue-next/commit/4b7f76e36a7fc650986a20eca258f7a5d912424f">4b7f76e</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4792">#4792</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/runtime-dom/src/apiCustomElement.ts</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      asyncDef().then(resolve)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      asyncDef()</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        .then(resolve)</span>
+        .then(() =&gt; this._update())
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>custom-element: fix initial attr type casting for
              programmtically created elements (<a href=
              "https://github.com/vuejs/vue-next/commit/3ca83179d1a798f65e4e70215c511e2f1b64adb6">3ca8317</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4772">#4772</a></p>
              <p><a href=
              "https://codesandbox.io/s/musing-gates-n5wsn?file=/src/main.js">
              codesandbox.io</a></p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: add v-memo to built-in directives
              check (<a href=
              "https://github.com/vuejs/vue-next/issues/4787">#4787</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/5eb72630a53a8dd82c2b8a9705c21a8075161a3d">5eb7263</a>)</p>
              <p>将 <code>memo</code> 视为 vue 内置指令：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">const isBuiltInDirective = /*#__PURE__*/ makeMap(</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  'bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text'</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  'bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text,memo'</span>
)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: add type for props include Function
              in prod mode (<a href=
              "https://github.com/vuejs/vue-next/issues/4938">#4938</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/9c42a1e2a3385f3b33faed5cdcc430bf8c1fc4b2">9c42a1e</a>)</p>
              <div class="org-src-container">
                <pre class="src src-html">&lt;<span style=
                "color: #c678dd;">script</span> setup <span style=
                "color: #dcaeea;">lang</span>=<span style=
                "color: #98be65;">'ts'</span>&gt;

import { onMounted } from 'vue'

var props = withDefaults(defineProps&lt;{f?: Function}&gt;(),{f:()=&gt;[1,2,3]})

onMounted(()=&gt;{
  console.log("f:",props.f)
})

&lt;/<span style="color: #c678dd;">script</span>&gt;
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: externalRE support automatic
              http/https prefix url pattern (<a href=
              "https://github.com/vuejs/vue-next/issues/4922">#4922</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/574070f43f804fd855f4ee319936ec770a56cef0">574070f</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4920">#4920</a></p>
              <div class="org-src-container">
                <pre class="src src-html">&lt;<span style=
                "color: #c678dd;">template</span>&gt;
  <span style="color: #5B6268;">&lt;!-- </span><span style=
"color: #5B6268;">other stuff</span><span style=
"color: #5B6268;"> --&gt;</span>
  &lt;<span style="color: #c678dd;">img</span> <span style=
"color: #dcaeea;">src</span>=<span style=
"color: #98be65;">"//via.placeholder.com/150"</span> /&gt;
  <span style="color: #5B6268;">&lt;!-- </span><span style=
"color: #5B6268;">other stuff</span><span style=
"color: #5B6268;"> --&gt;</span>
&lt;/<span style="color: #c678dd;">template</span>&gt;
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: improve dedupe listeners when attr
              fallthrough (<a href=
              "https://github.com/vuejs/vue-next/issues/4912">#4912</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/b4eb7e3866d7dc722d93a48f4faae1696d4e7023">b4eb7e3</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4859">#4859</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-core/src/vnode.ts</span>
<span style=
"color: #a9a1e1;">@@ -791,7 +791,10 @@</span><span style=
"color: #46D9FF;"> export function mergeProps(...args: (Data & VNodeProps)[]) {</span>
<span style="color: #a4aab6;">      } else if (isOn(key)) {</span>
<span style=
"color: #a4aab6;">        const existing = ret[key]</span>
<span style=
"color: #a4aab6;">        const incoming = toMerge[key]</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">        if (existing !== incoming) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        if (</span>
<span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          existing !== incoming </span><span style="color: #98be65; background-color: #21242b;">&amp;&</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          !(isArray(existing) &amp;& existing.includes(incoming))</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        ) {</span>
<span style="color: #a4aab6;">          ret[key] = existing</span>
<span style=
"color: #a4aab6;">            ? [].concat(existing as any, incoming as any)</span>
<span style="color: #a4aab6;">            : incoming</span>

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org9ed2363" class="outline-3">
        <h3 id="org9ed2363"><span class=
        "section-number-3">3.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-3-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>[3.2.20]compiler-sfc: &lt;script setup&gt;
              defineProps destructure transform (<a href=
              "https://github.com/vuejs/vue-next/issues/4690">#4690</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/467e113b95a3c9c97f8dc309b61c0b2e3caba66f">467e113</a>)
              <span id="defineProps-destructure"></span></p>
              <p><code>defineProps</code> 支持解构操作。</p>
              <p><code>&lt;script setup&gt;const { foo, bar } =
              defineProps(['foo', 'bar'])&lt;/script&gt;</code></p>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orge668e4a" class="outline-2">
      <h2 id="orge668e4a"><span class="section-number-2">4.</span>
      <span class="done DONE">DONE</span> 3.2.13 (2021-09-21)</h2>
      <div class="outline-text-2" id="text-4"></div>
      <div id="outline-container-org4fee1b4" class="outline-3">
        <h3 id="org4fee1b4"><span class=
        "section-number-3">4.1.</span> Bug Fixes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-4-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: return the exposeProxy from mount
              (<a href=
              "https://github.com/vuejs/vue-next/issues/4606">#4606</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/5aa425580808d0588aef12ead81c91f7147e1042">5aa4255</a>)
              <span id="expose-proxy"></span></p>
              <p>问题：在 createApp().mount 返回的 vm 上找不到 vm.foo</p>
              <p>FIX:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">getExposeProxy</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #dcaeea;">instance</span>: <span style=
                "color: #ECBE7B;">ComponentInternalInstance</span><span style=
                "color: #51afef;">)</span> <span style=
                "color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>instance.exposed<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> <span style=
"color: #98be65;">(</span>
      instance.exposeProxy ||
      <span style=
"color: #a9a1e1;">(</span>instance.exposeProxy = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">Proxy</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">proxyRefs</span><span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">markRaw</span><span style=
"color: #98be65;">(</span>instance.exposed<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span>, <span style="color: #c678dd;">{</span>
        <span style="color: #51afef;">get</span><span style=
"color: #98be65;">(</span>target, key: <span style=
"color: #51afef;">string</span><span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
          <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>key <span style=
"color: #51afef;">in</span> target<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
            <span style=
"color: #51afef;">return</span> target<span style=
"color: #51afef;">[</span>key<span style="color: #51afef;">]</span>
          <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>key <span style=
"color: #51afef;">in</span> publicPropertiesMap<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
            <span style=
"color: #51afef;">return</span> publicPropertiesMap<span style=
"color: #51afef;">[</span>key<span style=
"color: #51afef;">](</span>instance<span style=
"color: #51afef;">)</span>
          <span style="color: #a9a1e1;">}</span>
        <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span><span style="color: #a9a1e1;">)</span>
    <span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span style=
                "color: #c678dd;">test</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #98be65;">'with mount'</span>, <span style=
                "color: #c678dd;">()</span> <span style=
                "color: #51afef;">=&gt;</span> <span style=
                "color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Component</span> = <span style=
"color: #c678dd;">defineComponent</span><span style=
"color: #98be65;">(</span><span style="color: #a9a1e1;">{</span>
      <span style="color: #c678dd;">setup</span><span style=
"color: #51afef;">(</span>_, <span style=
"color: #c678dd;">{</span> expose <span style=
"color: #c678dd;">}</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
        <span style="color: #c678dd;">expose</span><span style=
"color: #c678dd;">(</span><span style="color: #98be65;">{</span>
          foo: <span style=
"color: #da8548; font-weight: bold;">1</span>
        <span style="color: #98be65;">}</span><span style=
"color: #c678dd;">)</span>
        <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">{</span>
          bar: <span style=
"color: #da8548; font-weight: bold;">2</span>
        <span style="color: #c678dd;">}</span>
      <span style="color: #51afef;">}</span>,
      <span style="color: #c678dd;">render</span><span style=
"color: #51afef;">()</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">h</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">'div'</span><span style=
"color: #c678dd;">)</span>
      <span style="color: #51afef;">}</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">root</span> = nodeOps.<span style=
"color: #c678dd;">createElement</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'div'</span><span style=
"color: #98be65;">)</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">vm</span> = <span style=
"color: #c678dd;">createApp</span><span style=
"color: #98be65;">(</span>Component<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">mount</span><span style=
"color: #98be65;">(</span>root<span style=
"color: #98be65;">)</span> <span style=
"color: #51afef;">as</span> <span style=
"color: #51afef;">any</span>
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>vm.foo<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #da8548; font-weight: bold;">1</span><span style=
"color: #98be65;">)</span>
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>vm.bar<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">undefined</span><span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgbe80dab" class="outline-2">
      <h2 id="orgbe80dab"><span class="section-number-2">5.</span>
      <span class="done DONE">DONE</span> 3.2.12(2021-09-17)</h2>
      <div class="outline-text-2" id="text-5"></div>
      <div id="outline-container-orga1b2a60" class="outline-3">
        <h3 id="orga1b2a60"><span class=
        "section-number-3">5.1.</span> Bug Fixes
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-5-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support nested await statements
              (<a href=
              "https://github.com/vuejs/vue-next/issues/4458">#4458</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ae942cdcd9bd686e7b0394c8e91e63a31ff8fb5d">ae942cd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4448">#4448</a></p>
              <p><code>&lt;script&gt;await (await
              1)&lt;/script&gt;</code></p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-core: v-on inline async function
              expression handler (<a href=
              "https://github.com/vuejs/vue-next/issues/4569">#4569</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/fc968d607b181db9d50cd4b30a8d7e4cc5fe9d2b">fc968d6</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4568">#4568</a>
              <span id="von-async"></span></p>
              <p><code>&lt;div @click="async () =&gt; await foo()"
              /&gt;</code></p>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org2de7f50" class="outline-2">
      <h2 id="org2de7f50"><span class="section-number-2">6.</span>
      <span class="done DONE">DONE</span> 3.2.4(2021-08-17)</h2>
      <div class="outline-text-2" id="text-6"></div>
      <div id="outline-container-org8aba9e7" class="outline-3">
        <h3 id="org8aba9e7"><span class=
        "section-number-3">6.1.</span> Bug Fixes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-6-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href="#slot-args">runtime-core:
              ensure consistent arguments for tempalte and render
              funtion slot usage</a> (644971e), closes #4367
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgcd4b4f1" class="outline-2">
      <h2 id="orgcd4b4f1"><span class="section-number-2">7.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.8
      (2021-08-07)</h2>
      <div class="outline-text-2" id="text-7">
        <ul class="org-ul">
          <li><b><span style="color:red;">FIX</span></b>
          <abbr class="tooltip" title=
          "&lt;strong&gt;3.2+&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any[]&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;Memoize a sub-tree of the template. Can be used on both elements and components.&lt;br&gt;The directive expects a fixed-length array of dependency values to compare for&lt;br&gt;the memoization. If every value in the array was the same as last render, then&lt;br&gt;updates for the entire sub-tree will be skipped. For example:&lt;br&gt;&lt;br&gt;&lt;div v-memo=''[valueA, valueB]''&gt;&lt;br&gt; ...&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component re-renders, if both valueA and valueB remain the same, all&lt;br&gt;updates for this &lt;div&gt; and its children will be skipped. In fact, even the&lt;br&gt;Virtual DOM VNode creation will also be skipped since the memoized copy of the&lt;br&gt;sub-tree can be reused.&lt;br&gt;&lt;br&gt;It is important to specify the memoization array correctly, otherwise we may&lt;br&gt;skip updates that should indeed be applied. v-memo with an empty dependency&lt;br&gt;array (v-memo=''[]'') would be functionally equivalent to v-once.&lt;br&gt;&lt;br&gt;Usage with v-for&lt;br&gt;&lt;br&gt;v-memo is provided solely for micro optimizations in performance-critical&lt;br&gt;scenarios and should be rarely needed. The most common case where this may prove&lt;br&gt;helpful is when rendering large v-for lists (where length &gt; 1000):&lt;br&gt;&lt;br&gt;&lt;div v-for=''item in list'' :key=''item.id'' v-memo=''[item.id === selected]''&gt;&lt;br&gt; &lt;p&gt;ID: {{ item.id }} - selected: {{ item.id === selected }}&lt;/p&gt;&lt;br&gt; &lt;p&gt;...more child nodes&lt;/p&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component's selected state changes, a large amount of VNodes will be&lt;br&gt;created even though most of the items remained exactly the same. The v-memo&lt;br&gt;usage here is essentially saying ''only update this item if it went from&lt;br&gt;non-selected to selected, or the other way around''. This allows every unaffected&lt;br&gt;item to reuse its previous VNode and skip diffing entirely. Note we don't need&lt;br&gt;to include item.id in the memo dependency array here since Vue automatically&lt;br&gt;infers it from the item's :key.&lt;br&gt;&lt;br&gt;WARNING&lt;br&gt;&lt;br&gt;When using v-memo with v-for, make sure they are used on the same element.&lt;br&gt;v-memo does not work inside v-for.&lt;br&gt;&lt;br&gt;v-memo can also be used on components to manually prevent unwanted updates in&lt;br&gt;certain edge cases where the child component update check has been de-optimized.&lt;br&gt;But again, it is the developer's responsibility to specify correct dependency&lt;br&gt;arrays to avoid skipping necessary updates.&lt;br&gt;&lt;br&gt;See also:&lt;br&gt;&lt;br&gt;v-once (https://vuejs.org/api/built-in-directives.html#v-once)">
          v-memo</abbr> 在 v-for 中使用时支持常量表达式 <code>&lt;div v-for="v
          in list" v-memo="[count &lt; 2 ? true :
          count]"/&gt;</code></li>
        </ul>
      </div>
      <div id="outline-container-org1b1b1e5" class="outline-3">
        <h3 id="org1b1b1e5"><span class=
        "section-number-3">7.1.</span> Bug Fixes
        <code>[8/8]</code></h3>
        <div class="outline-text-3" id="text-7-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>v-memo: should work on v-for with constant
              expression (<a href=
              "https://github.com/vuejs/vue-next/issues/4272">#4272</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/3b60358d0e0289298df7937983b3e06123f8eb3d">3b60358</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4246">#4246</a></p>
              <p>v-memo 应用在 v-for 中加入表达式的支持</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-core/src/helpers/renderList.ts</span>
<span style="color: #a9a1e1;">@@ -71,7 +71,7 @@</span><span style=
"color: #46D9FF;"> export function renderList(</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">    ret = new Array(source)</span>
<span style=
"color: #a4aab6;">    for (let i = 0; i &lt; source; i++) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      ret[i] = renderItem(i + 1, i)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      ret[i] = renderItem(i + 1, i</span><span style="color: #98be65; background-color: #21242b;">, undefined, cached &amp;& cached[i]</span><span style="color: #98be65; background-color: #21242b;">)</span>
<span style="color: #a4aab6;">    }</span>
<span style=
"color: #a4aab6;">  } else if (isObject(source)) {</span>
    if (source[Symbol.iterator as any]) {
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span style=
                "color: #c678dd;">test</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #98be65;">'on v-for /w constant expression '</span>, <span style="color: #51afef;">async</span> <span style="color: #c678dd;">()</span> <span style="color: #51afef;">=&gt;</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #98be65;">[</span><span style=
"color: #dcaeea;">el</span>, <span style=
"color: #dcaeea;">vm</span><span style=
"color: #98be65;">]</span> = <span style=
"color: #c678dd;">mount</span><span style=
"color: #98be65;">(</span><span style="color: #a9a1e1;">{</span>
      template: <span style=
"color: #98be65;">`&lt;div v-for="item in 3"  v-memo="[count &lt; 2 ? true : count]"&gt;</span>
<span style="color: #98be65;">          {{count}}</span>
<span style="color: #98be65;">        &lt;/div&gt;`</span>,
      data: <span style="color: #51afef;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">(</span><span style="color: #c678dd;">{</span>
        count: <span style=
"color: #da8548; font-weight: bold;">0</span>
      <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>el.innerHTML<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">`&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;`</span><span style="color: #98be65;">)</span>

    vm.count = <span style=
"color: #da8548; font-weight: bold;">1</span>
    <span style="color: #51afef;">await</span> <span style=
"color: #c678dd;">nextTick</span><span style=
"color: #98be65;">()</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">should not update</span>
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>el.innerHTML<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">`&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;&lt;div&gt;0&lt;/div&gt;`</span><span style="color: #98be65;">)</span>

    vm.count = <span style=
"color: #da8548; font-weight: bold;">2</span>
    <span style="color: #51afef;">await</span> <span style=
"color: #c678dd;">nextTick</span><span style=
"color: #98be65;">()</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">should update</span>
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>el.innerHTML<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">`&lt;div&gt;2&lt;/div&gt;&lt;div&gt;2&lt;/div&gt;&lt;div&gt;2&lt;/div&gt;`</span><span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgc1c24b5" class="outline-3">
        <h3 id="orgc1c24b5"><span class=
        "section-number-3">7.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-7-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href=
              "https://www.cheng92.com/vue/vue-teardown-17-async-component/">
              runtime-dom: support async component in
              defineCustomElement</a> (<a href=
              "https://github.com/vuejs/vue-next/commit/c421fb91b2bec047e665f8269e231bf89f9bfc93">c421fb9</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4261">#4261</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org6aa2909" class="outline-2">
      <h2 id="org6aa2909"><span class="section-number-2">8.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.7
      (2021-07-29)</h2>
      <div class="outline-text-2" id="text-8"></div>
      <div id="outline-container-orgc7deb50" class="outline-3">
        <h3 id="orgc7deb50"><span class=
        "section-number-3">8.1.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-8-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: dereference nested effect scopes on
              manual stop (<a href=
              "https://github.com/vuejs/vue-next/commit/1867591e7c54406e92575753dd77fffba17606a2">1867591</a>)</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/reactivity/src/effectScope.ts</span>
<span style="color: #a9a1e1;">@@ -1,3 +1,4 @@</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> import { remove } from '@vue/shared'</span>
<span style=
"color: #a4aab6;">import { ReactiveEffect } from './effect'</span>
<span style=
"color: #a4aab6;">import { warn } from './warning'</span>

<span style="color: #a9a1e1;">@@ -8,10 +9,12 @@</span><span style=
"color: #46D9FF;"> export class EffectScope {</span>
<span style="color: #a4aab6;">  active = true</span>
<span style=
"color: #a4aab6;">  effects: (ReactiveEffect | EffectScope)[] = []</span>
<span style=
"color: #a4aab6;">  cleanups: (() =&gt; void)[] = []</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  parent: EffectScope | undefined</span>

<span style=
"color: #a4aab6;">  constructor(detached = false) {</span>
<span style="color: #a4aab6;">    if (!detached) {</span>
<span style="color: #a4aab6;">      recordEffectScope(this)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      this.parent = activeEffectScope</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">  }</span>

<span style=
"color: #a9a1e1;">@@ -42,11 +45,14 @@</span><span style="color: #46D9FF;"> export class EffectScope {</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">  }</span>

<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  stop() {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  stop(fromParent = false) {</span>
<span style="color: #a4aab6;">    if (this.active) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      this.effects.forEach(e =&gt; e.stop())</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      this.effects.forEach(e =&gt; e.stop(true))</span>
<span style=
"color: #a4aab6;">      this.cleanups.forEach(cleanup =&gt; cleanup())</span>
<span style="color: #a4aab6;">      this.active = false</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      if (!fromParent &amp;& this.parent) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        remove(this.parent.effects, this)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      }</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">  }</span>
}
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span style=
                "color: #c678dd;">it</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #98be65;">'should derefence child scope from parent scope after stopping child scope (no memleaks)'</span>, <span style="color: #51afef;">async</span> <span style="color: #c678dd;">()</span> <span style="color: #51afef;">=&gt;</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">parent</span> = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">EffectScope</span><span style=
"color: #98be65;">()</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">child</span> = parent.<span style=
"color: #c678dd;">run</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">EffectScope</span><span style=
"color: #a9a1e1;">()</span><span style="color: #98be65;">)</span>!
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>parent.effects.<span style=
"color: #c678dd;">includes</span><span style=
"color: #a9a1e1;">(</span>child<span style=
"color: #a9a1e1;">)</span><span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">true</span><span style="color: #98be65;">)</span>
    child.<span style="color: #c678dd;">stop</span><span style=
"color: #98be65;">()</span>
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>parent.effects.<span style=
"color: #c678dd;">includes</span><span style=
"color: #a9a1e1;">(</span>child<span style=
"color: #a9a1e1;">)</span><span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">false</span><span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code> shared: support custom .toString()
              in text interpolation again (<a href=
              "https://github.com/vuejs/vue-next/issues/4210">#4210</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/9d5fd33d6dadf3186f7979d811dedf092f3ddcb7">9d5fd33</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3944">#3944</a>
              使用插值时候支持自定义的 <code>toString()</code>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>suspense: fix dynamicChildren tracking when
              suspense root is a block itself (<a href=
              "https://github.com/vuejs/vue-next/commit/51ee84fc6a5a1ab83cd02f17154803c47e65ae16">51ee84f</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4183">#4183</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/4198">#4198</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-core/src/components/Suspense.ts</span>
<span style=
"color: #a9a1e1;">@@ -749,7 +749,7 @@</span><span style="color: #46D9FF;"> function normalizeSuspenseSlot(s: any) {</span>
<span style="color: #a4aab6;">    s = singleChild</span>
<span style="color: #a4aab6;">  }</span>
<span style="color: #a4aab6;">  s = normalizeVNode(s)</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  if (block) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  if (block </span><span style="color: #98be65; background-color: #21242b;">&amp;& !s.dynamicChildren</span><span style="color: #98be65; background-color: #21242b;">) {</span>
<span style=
"color: #a4aab6;">    s.dynamicChildren = block.filter(c =&gt; c !== s)</span>
<span style="color: #a4aab6;">  }</span>
  return s
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org8be51f2" class="outline-3">
        <h3 id="org8be51f2"><span class=
        "section-number-3">8.2.</span> Features
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-8-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>server-renderer: decouple esm build from Node +
              improve stream API (<a href=
              "https://github.com/vuejs/vue-next/commit/08672222c611a61f6359543aa202f0841d199bcb">0867222</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3467">#3467</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/3111">#3111</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/3460">#3460</a>
              <span id="0867222"></span></p>
              <p>移除 <code>renderToSTream</code>, 添加
              <code>renderToNodeStream</code>,
              <code>renderToWebStream</code>,
              <code>renderToSimpleStream</code></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">renderToSimpleStream</span>&lt;<span style=
                "color: #ECBE7B;">T</span> <span style=
                "color: #51afef;">extends</span> <span style=
                "color: #ECBE7B;">SimpleReadable</span>&gt;<span style=
                "color: #51afef;">(</span>
  input: <span style="color: #ECBE7B;">App</span> | VNode,
  context: <span style="color: #ECBE7B;">SSRContext</span>,
  stream: T
<span style="color: #51afef;">)</span>: T <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">isVNode</span><span style=
"color: #98be65;">(</span>input<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">raw vnode, wrap with app (for context)</span>
    <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">renderToSimpleStream</span><span style=
"color: #98be65;">(</span>
      <span style="color: #c678dd;">createApp</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #51afef;">{</span> render: <span style=
"color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> input <span style=
"color: #51afef;">}</span><span style="color: #a9a1e1;">)</span>,
      context,
      stream
    <span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">rendering an app</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">vnode</span> = <span style=
"color: #c678dd;">createVNode</span><span style=
"color: #c678dd;">(</span>input._component, input._props<span style="color: #c678dd;">)</span>
  vnode.appContext = input._context
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">provide the ssr context to the tree</span>
  input.<span style="color: #c678dd;">provide</span><span style=
"color: #c678dd;">(</span>ssrContextKey, context<span style=
"color: #c678dd;">)</span>

  Promise.<span style="color: #c678dd;">resolve</span><span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">renderComponentVNode</span><span style=
"color: #98be65;">(</span>vnode<span style=
"color: #98be65;">)</span><span style="color: #c678dd;">)</span>
    .<span style="color: #c678dd;">then</span><span style=
"color: #c678dd;">(</span>buffer <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #c678dd;">unrollBuffer</span><span style=
"color: #98be65;">(</span>buffer, stream<span style=
"color: #98be65;">)</span><span style="color: #c678dd;">)</span>
    .<span style="color: #c678dd;">then</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #98be65;">{</span>
      stream.<span style="color: #c678dd;">push</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #a9a1e1;">null</span><span style="color: #a9a1e1;">)</span>
    <span style="color: #98be65;">}</span><span style=
"color: #c678dd;">)</span>
    .<span style="color: #51afef;">catch</span><span style=
"color: #c678dd;">(</span>error <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #98be65;">{</span>
      stream.<span style=
"color: #c678dd;">destroy</span><span style=
"color: #a9a1e1;">(</span>error<span style=
"color: #a9a1e1;">)</span>
    <span style="color: #98be65;">}</span><span style=
"color: #c678dd;">)</span>

  <span style="color: #51afef;">return</span> stream
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">node 环境</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">renderToNodeStream</span><span style=
"color: #51afef;">(</span>
  input: <span style="color: #ECBE7B;">App</span> | VNode,
  context: <span style=
"color: #ECBE7B;">SSRContext</span> = <span style=
"color: #c678dd;">{}</span>
<span style="color: #51afef;">)</span>: <span style=
"color: #ECBE7B;">Readable</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">stream</span>: <span style=
"color: #ECBE7B;">Readable</span> = __NODE_JS__
    ? <span style="color: #51afef;">new</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">require</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'stream'</span><span style=
"color: #98be65;">)</span>.Readable<span style=
"color: #c678dd;">)()</span>
    : <span style="color: #a9a1e1;">null</span>

  <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">renderToSimpleStream</span><span style=
"color: #c678dd;">(</span>input, context, stream<span style=
"color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">web 环境</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">renderToWebStream</span><span style=
"color: #51afef;">(</span>
  input: <span style="color: #ECBE7B;">App</span> | VNode,
  context: <span style=
"color: #ECBE7B;">SSRContext</span> = <span style=
"color: #c678dd;">{}</span>
<span style="color: #51afef;">)</span>: <span style=
"color: #ECBE7B;">ReadableStream</span> <span style=
"color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">check</span>

  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">encoder</span> = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">TextEncoder</span><span style=
"color: #c678dd;">()</span>
  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">cancelled</span> = <span style=
"color: #a9a1e1;">false</span>

  <span style="color: #51afef;">return</span> <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">ReadableStream</span><span style=
"color: #c678dd;">(</span><span style="color: #98be65;">{</span>
    <span style="color: #c678dd;">start</span><span style=
"color: #a9a1e1;">(</span>controller<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
      <span style=
"color: #c678dd;">renderToSimpleStream</span><span style=
"color: #51afef;">(</span>input, context, <span style=
"color: #c678dd;">{</span>
        <span style="color: #c678dd;">push</span><span style=
"color: #98be65;">(</span>content<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
          <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>cancelled<span style=
"color: #a9a1e1;">)</span> <span style=
"color: #51afef;">return</span>
          <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>content != <span style=
"color: #a9a1e1;">null</span><span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
            controller.<span style=
"color: #c678dd;">enqueue</span><span style=
"color: #51afef;">(</span>encoder.<span style=
"color: #c678dd;">encode</span><span style=
"color: #c678dd;">(</span>content<span style=
"color: #c678dd;">)</span><span style="color: #51afef;">)</span>
          <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #a9a1e1;">{</span>
            controller.<span style=
"color: #c678dd;">close</span><span style=
"color: #51afef;">()</span>
          <span style="color: #a9a1e1;">}</span>
        <span style="color: #98be65;">}</span>,
        <span style="color: #c678dd;">destroy</span><span style=
"color: #98be65;">(</span>err<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
          controller.<span style=
"color: #c678dd;">error</span><span style=
"color: #a9a1e1;">(</span>err<span style="color: #a9a1e1;">)</span>
        <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span>,
    <span style="color: #c678dd;">cancel</span><span style=
"color: #a9a1e1;">()</span> <span style="color: #a9a1e1;">{</span>
      cancelled = <span style="color: #a9a1e1;">true</span>
    <span style="color: #a9a1e1;">}</span>
  <span style="color: #98be65;">}</span><span style=
"color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">import</span> <span style=
                "color: #51afef;">{</span> createApp, h, defineAsyncComponent <span style="color: #51afef;">}</span> <span style="color: #51afef;">from</span> <span style="color: #98be65;">'vue'</span>
<span style="color: #51afef;">import</span> <span style=
"color: #51afef;">{</span> ReadableStream <span style=
"color: #51afef;">}</span> <span style=
"color: #51afef;">from</span> <span style=
"color: #98be65;">'stream/web'</span>
<span style="color: #51afef;">import</span> <span style=
"color: #51afef;">{</span> renderToWebStream <span style=
"color: #51afef;">}</span> <span style=
"color: #51afef;">from</span> <span style=
"color: #98be65;">'../src'</span>

<span style="color: #c678dd;">test</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">'should work'</span>, <span style=
"color: #51afef;">async</span> <span style=
"color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #c678dd;">{</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Async</span> = <span style=
"color: #c678dd;">defineAsyncComponent</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">()</span> <span style=
"color: #51afef;">=&gt;</span>
    Promise.<span style=
"color: #c678dd;">resolve</span><span style="color: #a9a1e1;">(</span><span style="color: #51afef;">{</span>
      render: <span style="color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #c678dd;">h</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">'div'</span>, <span style=
"color: #98be65;">'async'</span><span style=
"color: #c678dd;">)</span>
    <span style="color: #51afef;">}</span><span style=
"color: #a9a1e1;">)</span>
                                    <span style=
"color: #98be65;">)</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">App</span> = <span style=
"color: #98be65;">{</span>
    render: <span style="color: #a9a1e1;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #a9a1e1;">[</span><span style=
"color: #c678dd;">h</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">'div'</span>, <span style=
"color: #98be65;">'parent'</span><span style=
"color: #51afef;">)</span>, <span style=
"color: #c678dd;">h</span><span style=
"color: #51afef;">(</span>Async<span style=
"color: #51afef;">)</span><span style="color: #a9a1e1;">]</span>
  <span style="color: #98be65;">}</span>

  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">stream</span> = <span style=
"color: #c678dd;">renderToWebStream</span><span style=
"color: #98be65;">(</span><span style=
"color: #c678dd;">createApp</span><span style=
"color: #a9a1e1;">(</span>App<span style=
"color: #a9a1e1;">)</span>, <span style=
"color: #a9a1e1;">{}</span>, ReadableStream<span style=
"color: #98be65;">)</span>

  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">reader</span> = stream.<span style=
"color: #c678dd;">getReader</span><span style=
"color: #98be65;">()</span>

  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">res</span> = <span style=
"color: #98be65;">''</span>
  <span style="color: #51afef;">await</span> reader.<span style=
"color: #c678dd;">read</span><span style=
"color: #98be65;">()</span>.<span style=
"color: #c678dd;">then</span><span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">read</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #51afef;">{</span> done, value <span style=
"color: #51afef;">}</span><span style=
"color: #a9a1e1;">)</span>: <span style=
"color: #51afef;">any</span> <span style="color: #a9a1e1;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>!done<span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
      res += value
      <span style=
"color: #51afef;">return</span> reader.<span style=
"color: #c678dd;">read</span><span style=
"color: #c678dd;">()</span>.<span style=
"color: #c678dd;">then</span><span style=
"color: #c678dd;">(</span>read<span style=
"color: #c678dd;">)</span>
    <span style="color: #51afef;">}</span>
  <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>

  <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span>res<span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">`&lt;!--[--&gt;&lt;div&gt;parent&lt;/div&gt;&lt;div&gt;async&lt;/div&gt;&lt;!--]--&gt;`</span><span style="color: #98be65;">)</span>
<span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orga30008e" class="outline-2">
      <h2 id="orga30008e"><span class="section-number-2">9.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.6
      (2021-07-27)</h2>
      <div class="outline-text-2" id="text-9">
        <ul class="org-ul">
          <li><b><span style="color:red;">FIX</span></b> inject
          的时候要能自动 unref, provide + inject 实际上是原型链的实现</li>
        </ul>
      </div>
      <div id="outline-container-org455e858" class="outline-3">
        <h3 id="org455e858"><span class=
        "section-number-3">9.1.</span> Bug Fixes
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-9-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>inject: should auto unwrap injected refs (<a href=
              "https://github.com/vuejs/vue-next/commit/561e210157874b216efc1c17be701a6a81c4383b">561e210</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4196">#4196</a></p>
              <p>在 child 组件中使用 inject 时候要检测是不是 ref 类型，如果是要自动 unref
              下， 即：</p>
              <p>在 parent 中</p>
              <div class="org-src-container">
                <pre class="src src-js">defineComponent({
  provide(): {
    <span style=
"color: #51afef;">return</span> { n: ref(<span style=
"color: #da8548; font-weight: bold;">0</span>) }
  }
})
</pre>
              </div>
              <p>在 child 中</p>
              <div class="org-src-container">
                <pre class="src src-js">defineComponent({
  inject: [<span style="color: #98be65;">'n'</span>],
  render() {
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">这里要能直接使用，而不是需要 this.n.value</span>
    <span style="color: #51afef;">return</span> <span style=
"color: #a9a1e1;">this</span>.n
  }
})
</pre>
              </div>
              <p>所以 vue 内部要将 <code>this.n.value</code> 隐藏掉，从而能直接
              <code>this.n</code> 使用。</p>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/componentOptions.ts">
              runtime-core/src/componentOptions.ts:resolveInjections</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">resolveInjections</span><span style=
                "color: #51afef;">(</span>
  injectOptions: <span style=
"color: #ECBE7B;">ComponentInjectOptions</span>,
  ctx: <span style="color: #51afef;">any</span>,
  checkDuplicateProperties = NOOP <span style=
"color: #51afef;">as</span> <span style=
"color: #51afef;">any</span>,
  unwrapRef = <span style="color: #a9a1e1;">false</span>
<span style="color: #51afef;">)</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">isArray</span><span style=
"color: #98be65;">(</span>injectOptions<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    injectOptions = <span style=
"color: #c678dd;">normalizeInject</span><span style=
"color: #98be65;">(</span>injectOptions<span style=
"color: #98be65;">)</span>!
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">for</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">key</span> <span style=
"color: #51afef;">in</span> injectOptions<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">opt</span> = <span style=
"color: #98be65;">(</span>injectOptions <span style=
"color: #51afef;">as</span> ObjectInjectOptions<span style=
"color: #98be65;">)[</span>key<span style=
"color: #98be65;">]</span>
    <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">injected</span>: <span style=
"color: #51afef;">unknown</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span><span style=
"color: #c678dd;">isObject</span><span style=
"color: #a9a1e1;">(</span>opt<span style=
"color: #a9a1e1;">)</span><span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span><span style=
"color: #98be65;">'default'</span> <span style=
"color: #51afef;">in</span> opt<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        injected = <span style=
"color: #c678dd;">inject</span><span style=
"color: #51afef;">(</span>
          opt.<span style="color: #51afef;">from</span> || key,
          opt.<span style="color: #51afef;">default</span>,
          <span style="color: #a9a1e1;">true</span> <span style=
"color: #5B6268;">/* </span><span style=
"color: #5B6268;">treat default function as factory */</span>
        <span style="color: #51afef;">)</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #a9a1e1;">{</span>
        injected = <span style=
"color: #c678dd;">inject</span><span style=
"color: #51afef;">(</span>opt.<span style=
"color: #51afef;">from</span> || key<span style=
"color: #51afef;">)</span>
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #98be65;">{</span>
      injected = <span style=
"color: #c678dd;">inject</span><span style=
"color: #a9a1e1;">(</span>opt<span style="color: #a9a1e1;">)</span>
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span><span style=
"color: #c678dd;">isRef</span><span style=
"color: #a9a1e1;">(</span>injected<span style=
"color: #a9a1e1;">)</span><span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #5B6268;">// </span><span style=
"color: #ECBE7B; font-weight: bold;">TODO</span><span style=
"color: #5B6268;"> remove the check in 3.3</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>unwrapRef<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        Object.<span style=
"color: #c678dd;">defineProperty</span><span style=
"color: #51afef;">(</span>ctx, key, <span style=
"color: #c678dd;">{</span>
          enumerable: <span style="color: #a9a1e1;">true</span>,
          configurable: <span style="color: #a9a1e1;">true</span>,
          <span style="color: #51afef;">get</span>: <span style=
"color: #98be65;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #98be65;">(</span>injected <span style=
"color: #51afef;">as</span> Ref<span style=
"color: #98be65;">)</span>.value,
          <span style="color: #51afef;">set</span>: v <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">(</span>injected <span style=
"color: #51afef;">as</span> Ref<span style=
"color: #a9a1e1;">)</span>.value = v<span style=
"color: #98be65;">)</span>
        <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #a9a1e1;">{</span>
        ctx<span style="color: #51afef;">[</span>key<span style=
"color: #51afef;">]</span> = injected
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #98be65;">{</span>
      ctx<span style="color: #a9a1e1;">[</span>key<span style=
"color: #a9a1e1;">]</span> = injected
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>__DEV__<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      checkDuplicateProperties!<span style=
"color: #a9a1e1;">(</span>OptionTypes.INJECT, key<span style=
"color: #a9a1e1;">)</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>


</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>sfc/style-vars: should ignore style variable
              bindings in comments (<a href=
              "https://github.com/vuejs/vue-next/issues/4188">#4188</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/3a75d5d6942a1743789192dca9161f7c30a71e58">3a75d5d</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4185">#4185</a></p>
              <p>过滤掉 css 注释里面的 v-bind</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/compiler-sfc/src/cssVars.ts</span>
<span style="color: #a9a1e1;">@@ -37,7 +37,9 @@</span><span style=
"color: #46D9FF;"> export function parseCssVars(sfc: SFCDescriptor): string[] {</span>
<span style="color: #a4aab6;">  const vars: string[] = []</span>
<span style=
"color: #a4aab6;">  sfc.styles.forEach(style =&gt; {</span>
<span style="color: #a4aab6;">    let match</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    while ((match = cssVarRE.exec(</span><span style="color: #ff6c6b; background-color: #23272e;">style.</span><span style="color: #ff6c6b; background-color: #23272e;">content))) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    </span><span style="color: #98be65; background-color: #21242b;">// ignore v-bind() in comments /* ... */</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    const content = style.content.replace(/\/\*[\s\S]*\*\//g, '')</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    while ((match = cssVarRE.exec(content))) {</span>
<span style=
"color: #a4aab6;">      const variable = match[1] || match[2] || match[3]</span>
<span style=
"color: #a4aab6;">      if (!vars.includes(variable)) {</span>
        vars.push(variable)
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org9d8505b" class="outline-3">
        <h3 id="org9d8505b"><span class=
        "section-number-3">9.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-9-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>unwrap refs in toDisplayString (<a href=
              "https://github.com/vuejs/vue-next/commit/f994b974c0a1ac95d313c8ccfc258c6ba3910b6e">f994b97</a>)
              <span id="f994b97"></span></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/shared/src/toDisplayString.ts</span>
<span style="color: #a9a1e1;">@@ -12,8 +12,11 @@</span><span style=
"color: #46D9FF;"> export const toDisplayString = (val: unknown): string =&gt; {</span>
<span style="color: #a4aab6;">    : String(val)</span>
<span style="color: #a4aab6;">}</span>

<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;"> const replacer = (_key: string, val: any) =&gt; {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  if (isMap(val)) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> const replacer = (_key: string, val: any): any =&gt; {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  // can't use isRef here since @vue/shared has no deps</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  if (val &amp;& val.__v_isRef) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    return replacer(_key, val.value)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  } else if (isMap(val)) {</span>
<span style="color: #a4aab6;">    return {</span>
<span style=
"color: #a4aab6;">      [`Map(${val.size})`]: [...val.entries()].reduce((entries, [key, val]) =&gt; {</span>
        ;(entries as any)[`${key} =&gt;`] = val
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orgdbdc06f" class="outline-2">
      <h2 id="orgdbdc06f"><span class="section-number-2">10.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.5
      (2021-07-23)</h2>
      <div class="outline-text-2" id="text-10"></div>
      <div id="outline-container-org9e1609b" class="outline-3">
        <h3 id="org9e1609b"><span class=
        "section-number-3">10.1.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-10-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>v-model: avoid resetting value of in-focus & lazy
              input (<a href=
              "https://github.com/vuejs/vue-next/commit/ac74e1dd33a45874a96fc13efdaade613c44dd70">ac74e1d</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4182">#4182</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-dom/src/directives/vModel.ts</span>
<span style=
"color: #a9a1e1;">@@ -80,11 +80,14 @@</span><span style="color: #46D9FF;"> export const vModelText: ModelDirective&lt;</span>
<span style="color: #a4aab6;">  mounted(el, { value }) {</span>
<span style=
"color: #a4aab6;">    el.value = value == null ? '' : value</span>
<span style="color: #a4aab6;">  },</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  beforeUpdate(el, { value, modifiers: { trim, number } }, vnode) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  beforeUpdate(el, { value, modifiers: { </span><span style="color: #98be65; background-color: #21242b;">lazy,</span><span style="color: #98be65; background-color: #21242b;"> trim, number } }, vnode) {</span>
<span style=
"color: #a4aab6;">    el._assign = getModelAssigner(vnode)</span>
<span style=
"color: #a4aab6;">    // avoid clearing unresolved text. #2302</span>
<span style=
"color: #a4aab6;">    if ((el as any).composing) return</span>
<span style=
"color: #a4aab6;">    if (document.activeElement === el) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      if (lazy) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        return</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      }</span>
<span style=
"color: #a4aab6;">      if (trim &amp;& el.value.trim() === value) {</span>
<span style="color: #a4aab6;">        return</span>
      }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orge2c7f45" class="outline-3">
        <h3 id="orge2c7f45"><span class=
        "section-number-3">10.2.</span> Features
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-10-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: avoid exposing imports not used in
              template (<a href=
              "https://github.com/vuejs/vue-next/commit/5a3ccfd9143700c7ca82d2911fe592d0658c5393">5a3ccfd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/commit/5a3ccfd9143700c7ca82d2911fe592d0658c5393">
              #3183</a> <span id="5a3ccfd"></span></p>
              <p>避免导出 <code>&lt;template&gt;</code> 中没有用到的
              <code>&lt;script setup&gt;</code> 中引入的变量。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: hmr for custom elements (<a href=
              "https://github.com/vuejs/vue-next/commit/7a7e1d8e9fed27bc2dbf24076642e83d0c80d9af">7a7e1d8</a>)</p>
              <p>支持自定义元素在开发时的热更新。</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">if</span> <span style=
                "color: #51afef;">(</span>__DEV__<span style=
                "color: #51afef;">)</span> <span style=
                "color: #51afef;">{</span>
  instance.appContext.reload = <span style=
"color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #c678dd;">{</span>
    <span style="color: #c678dd;">render</span><span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">this</span>.<span style=
"color: #c678dd;">_createVNode</span><span style=
"color: #a9a1e1;">()</span>, <span style=
"color: #51afef;">this</span>.shadowRoot!<span style=
"color: #98be65;">)</span>
    <span style=
"color: #51afef;">this</span>.shadowRoot!.<span style=
"color: #c678dd;">querySelectorAll</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'style'</span><span style=
"color: #98be65;">)</span>.<span style=
"color: #c678dd;">forEach</span><span style=
"color: #98be65;">(</span>s <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #a9a1e1;">{</span>
      <span style=
"color: #51afef;">this</span>.shadowRoot!.<span style=
"color: #c678dd;">removeChild</span><span style=
"color: #51afef;">(</span>s<span style="color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
    <span style="color: #51afef;">this</span>.<span style=
"color: #c678dd;">_applyStyles</span><span style=
"color: #98be65;">()</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: support passing initial props to
              custom element constructor (<a href=
              "https://github.com/vuejs/vue-next/commit/5b76843b693d6477ae44b4bd238c2c892d8f4c77">5b76843</a>)
              支持给自定义元素传递默认属性值。</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span style=
                "color: #c678dd;">describe</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #98be65;">'mounting/unmount'</span>, <span style=
                "color: #c678dd;">()</span> <span style=
                "color: #51afef;">=&gt;</span> <span style=
                "color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">E</span> = <span style=
"color: #c678dd;">defineCustomElement</span><span style=
"color: #98be65;">(</span><span style="color: #a9a1e1;">{</span>
      render: <span style="color: #51afef;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #c678dd;">h</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">'div'</span>, <span style=
"color: #98be65;">'hello'</span><span style=
"color: #51afef;">)</span>
      props: <span style="color: #51afef;">{</span>
        msg: <span style="color: #c678dd;">{</span>
          <span style="color: #51afef;">type</span>: <span style=
"color: #ECBE7B;">String</span>,
          <span style=
"color: #51afef;">default</span>: <span style="color: #98be65;">'hello'</span>
        <span style="color: #c678dd;">}</span>
      <span style="color: #51afef;">}</span>,
      <span style="color: #c678dd;">render</span><span style=
"color: #51afef;">()</span> <span style="color: #51afef;">{</span>
        <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">h</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">'div'</span>, <span style=
"color: #51afef;">this</span>.msg<span style=
"color: #c678dd;">)</span>
      <span style="color: #51afef;">}</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
    customElements.<span style=
"color: #c678dd;">define</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'my-element'</span>, E<span style=
"color: #98be65;">)</span>

    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>

    <span style="color: #c678dd;">test</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'should work w/ manual instantiation'</span>, <span style="color: #a9a1e1;">()</span> <span style="color: #51afef;">=&gt;</span> <span style="color: #a9a1e1;">{</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">e</span> = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">E</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">{</span> msg: <span style=
"color: #98be65;">'inline'</span> <span style=
"color: #c678dd;">}</span><span style="color: #51afef;">)</span>
      <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">should lazy init</span>
      <span style="color: #c678dd;">expect</span><span style=
"color: #51afef;">(</span>e._instance<span style=
"color: #51afef;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #51afef;">(</span><span style=
"color: #a9a1e1;">null</span><span style="color: #51afef;">)</span>
      <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">should initialize on connect</span>
      container.<span style=
"color: #c678dd;">appendChild</span><span style=
"color: #51afef;">(</span>e<span style="color: #51afef;">)</span>
      <span style="color: #c678dd;">expect</span><span style=
"color: #51afef;">(</span>e._instance<span style=
"color: #51afef;">)</span>.<span style=
"color: #c678dd;">toBeTruthy</span><span style=
"color: #51afef;">()</span>
      <span style="color: #c678dd;">expect</span><span style=
"color: #51afef;">(</span>e.shadowRoot!.innerHTML<span style=
"color: #51afef;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">`&lt;div&gt;inline&lt;/div&gt;`</span><span style="color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
</pre>
              </div>
              <p>feat:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/runtime-dom/src/apiCustomElement.ts</span>
<span style="color: #a9a1e1;">@@ -23,8 +23,8 @@</span><span style=
"color: #46D9FF;"> import {</span>
<span style=
"color: #a4aab6;">import { camelize, extend, hyphenate, isArray, toNumber } from '@vue/shared'</span>
<span style=
"color: #a4aab6;">import { hydrate, render } from '.'</span>

<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;"> type VueElementConstructor&lt;P = {}&gt; = {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  new (): VueElement & P</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> </span><span style=
"color: #98be65; background-color: #21242b;">export</span><span style="color: #98be65; background-color: #21242b;"> type VueElementConstructor&lt;P = {}&gt; = {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  new (</span><span style="color: #98be65; background-color: #21242b;">initialProps?: Record&lt;string, any&gt;</span><span style="color: #98be65; background-color: #21242b;">): VueElement & P</span>
<span style="color: #a4aab6;">}</span>

<span style=
"color: #a4aab6;">// defineCustomElement provides the same type inference as defineComponent</span>
<span style=
"color: #a9a1e1;">@@ -134,8 +134,8 @@</span><span style="color: #46D9FF;"> export function defineCustomElement(</span>
<span style=
"color: #a4aab6;">    static get observedAttributes() {</span>
<span style="color: #a4aab6;">      return attrKeys</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">    constructor() {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      super(Comp, attrKeys, propKeys, hydate)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    constructor(initialProps?: Record&lt;string, any&gt;) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      super(Comp, initialProps, attrKeys, propKeys, hydate)</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">  }</span>

<span style=
"color: #a9a1e1;">@@ -163,10 +163,6 @@</span><span style=
"color: #46D9FF;"> const BaseClass = (</span>
<span style="color: #a4aab6;">) as typeof HTMLElement</span>

<span style=
"color: #a4aab6;">export class VueElement extends BaseClass {</span>
<span style="color: #a4aab6;">  /**</span>
<span style="color: #a4aab6;">   * @internal</span>
<span style="color: #a4aab6;">   */</span>
<span style=
"color: #a9a1e1;">@@ -178,6 +174,7 @@</span><span style="color: #46D9FF;"> export class VueElement extends BaseClass {</span>

<span style="color: #a4aab6;">  constructor(</span>
<span style=
"color: #a4aab6;">    private _def: ComponentOptions & { styles?: string[] },</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    private _props: Record&lt;string, any&gt; = {},</span>
<span style=
"color: #a4aab6;">    private _attrKeys: string[],</span>
<span style=
"color: #a4aab6;">    private _propKeys: string[],</span>
    hydrate?: RootHydrateFunction
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: support specifying shadow dom styles
              in defineCustomElement (<a href=
              "https://github.com/vuejs/vue-next/commit/a7fa4ac28afb73be00503be87f35e8724fe25443">a7fa4ac</a>)</p>
              <p>给自定义元素增加 styles 支持。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/runtime-dom/src/apiCustomElement.ts</span>

<span style=
"color: #a4aab6;">// overload 5: defining a custom element from the returned value of</span>
<span style=
"color: #a9a1e1;">@@ -176,7 +176,7 @@</span><span style="color: #46D9FF;"> export class VueElement extends BaseClass {</span>
<span style="color: #a4aab6;">  _connected = false</span>

<span style="color: #a4aab6;">  constructor(</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    private _def: Component,</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    private _def: Component</span><span style="color: #98be65; background-color: #21242b;">Options & { styles?: string[] }</span><span style="color: #98be65; background-color: #21242b;">,</span>
<span style=
"color: #a4aab6;">    private _attrKeys: string[],</span>
<span style=
"color: #a4aab6;">    private _propKeys: string[],</span>
<span style=
"color: #a4aab6;">    hydrate?: RootHydrateFunction</span>
<span style=
"color: #a9a1e1;">@@ -192,6 +192,13 @@</span><span style=
"color: #46D9FF;"> export class VueElement extends BaseClass {</span>
<span style="color: #a4aab6;">        )</span>
<span style="color: #a4aab6;">      }</span>
<span style=
"color: #a4aab6;">      this.attachShadow({ mode: 'open' })</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      if (_def.styles) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        _def.styles.forEach(css =&gt; {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          const s = document.createElement('style')</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          s.textContent = css</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          this.shadowRoot!.appendChild(s)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        })</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      }</span>
<span style="color: #a4aab6;">    }</span>
  }
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span style=
                "color: #c678dd;">describe</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #98be65;">'styles'</span>, <span style=
                "color: #c678dd;">()</span> <span style=
                "color: #51afef;">=&gt;</span> <span style=
                "color: #c678dd;">{</span>
    <span style="color: #c678dd;">test</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'should attach styles to shadow dom'</span>, <span style="color: #a9a1e1;">()</span> <span style="color: #51afef;">=&gt;</span> <span style="color: #a9a1e1;">{</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Foo</span> = <span style=
"color: #c678dd;">defineCustomElement</span><span style=
"color: #51afef;">(</span><span style="color: #c678dd;">{</span>
        styles: <span style="color: #98be65;">[</span><span style=
"color: #98be65;">`div { color: red; }`</span><span style=
"color: #98be65;">]</span>,
        <span style="color: #c678dd;">render</span><span style=
"color: #98be65;">()</span> <span style="color: #98be65;">{</span>
          <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">h</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #98be65;">'div'</span>, <span style=
"color: #98be65;">'hello'</span><span style=
"color: #a9a1e1;">)</span>
        <span style="color: #98be65;">}</span>
      <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
      customElements.<span style=
"color: #c678dd;">define</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">'my-el-with-styles'</span>, Foo<span style=
"color: #51afef;">)</span>
      container.innerHTML = <span style=
"color: #98be65;">`&lt;my-el-with-styles&gt;&lt;/my-el-with-styles&gt;`</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">el</span> = container.childNodes<span style=
"color: #51afef;">[</span><span style=
"color: #da8548; font-weight: bold;">0</span><span style=
"color: #51afef;">]</span> <span style=
"color: #51afef;">as</span> VueElement
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">style</span> = el.shadowRoot?.<span style=
"color: #c678dd;">querySelector</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">'style'</span><span style=
"color: #51afef;">)</span>!
      <span style="color: #c678dd;">expect</span><span style=
"color: #51afef;">(</span>style.textContent<span style=
"color: #51afef;">)</span>.<span style=
"color: #c678dd;">toBe</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">`div { color: red; }`</span><span style=
"color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org6f0659a" class="outline-2">
      <h2 id="org6f0659a"><span class="section-number-2">11.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.4
      (2021-07-21)</h2>
      <div class="outline-text-2" id="text-11"></div>
      <div id="outline-container-orgef2e6b9" class="outline-3">
        <h3 id="orgef2e6b9"><span class=
        "section-number-3">11.1.</span> Bug Fixes
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-11-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: ensure setupContext.attrs reactivity
              when used in child slots (<a href=
              "https://github.com/vuejs/vue-next/commit/85600056015fcf5c922dc0b5b07aa03a5ba53245">8560005</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4161">#4161</a></p>
              <p>setup 中的 attrs 使用 proxy 代理</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a9a1e1;">@@ -859,15 +874,13 @@</span><span style=
                "color: #46D9FF;"> export function createSetupContext(</span>
<span style="color: #a4aab6;">  } else {</span>
<span style="color: #a4aab6;">    return {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      attrs: instance.attrs,</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      get attrs() {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        return attrs || (attrs = createAttrsProxy(instance))</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      },</span>
<span style="color: #a4aab6;">      slots: instance.slots,</span>
<span style="color: #a4aab6;">      emit: instance.emit,</span>
      expose
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgaec7d2f" class="outline-3">
        <h3 id="orgaec7d2f"><span class=
        "section-number-3">11.2.</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-11-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>skip patch on same vnode (<a href=
              "https://github.com/vuejs/vue-next/commit/d13774b881b297f2cd1a8d3193183d241dee625b">d13774b</a>)</p>
              <p>优化：不对同一个节点进行 patch 过程。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/runtime-core/src/renderer.ts</span>
<span style=
"color: #a9a1e1;">@@ -470,6 +470,10 @@</span><span style=
"color: #46D9FF;"> function baseCreateRenderer(</span>
<span style="color: #a4aab6;">    slotScopeIds = null,</span>
<span style=
"color: #a4aab6;">    optimized = __DEV__ &amp;& isHmrUpdating ? false : !!n2.dynamicChildren</span>
<span style="color: #a4aab6;">  ) =&gt; {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    if (n1 === n2) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      return</span>
+    }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org61ba30a" class="outline-2">
      <h2 id="org61ba30a"><span class="section-number-2">12.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.3
      (2021-07-20)</h2>
      <div class="outline-text-2" id="text-12">
        <ul class="org-ul">
          <li><b><span style="color:green;">ADD</span></b>
          <code>watchSyncEffect</code> 同步 watch
          effect，回调会在值变更之前被调用</li>
          <li>
            <b><span style="color:green;">ADD</span></b> 添加
            <a href="#deferredComputed">deferredComputed</a>
            支持计算属性异步功能，修改之后取值不会立即计算，而是 在 next tick 之后 flush
            scheduler 队列的时候通过 effect 去触发重新计算。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b> <a href=
            "#fix-vbind-class">修复</a> <code>&lt;button
            class="{btn:true}" v-bind="{disabled:true}"&gt;</code>
            中的 class 被解 析成了 <code>[object Object]</code> 的问题。
          </li>
        </ul>
      </div>
      <div id="outline-container-orge1e4cd0" class="outline-3">
        <h3 id="orge1e4cd0"><span class=
        "section-number-3">12.1.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-12-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: revert computed scheduler change
              (<a href=
              "https://github.com/vuejs/vue-next/commit/33c2fbfdc80c6f17c7e8435b7a152a4d9ed5c6ed">33c2fbf</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4157">#4157</a></p>
              <p>将 async computed 还原回去了，同时在这个版本中加入了 <a href=
              "#deferredComputed">deferredComputed</a></p>
            </li>
            <li class="on">
              <code>[X]</code> <a href=
              "#fix-vbind-class">runtime-core: fix v-bind
              class/style merging regression</a> (<a href=
              "https://github.com/vuejs/vue-next/commit/2bdee50a598456392541a8a4b451501e5df2d363">2bdee50</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4155">#4155</a>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org17f4f44" class="outline-3">
        <h3 id="org17f4f44"><span class=
        "section-number-3">12.2.</span> Features
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-12-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href=
              "#deferredComputed">reactivity: deferredComputed</a>
              (<a href=
              "https://github.com/vuejs/vue-next/commit/14ca881a1ba6ad887d5ffc6ce3b7f8461252afee">14ca881</a>)
              <span id="f-deferredComputed"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: watchSyncEffect (<a href=
              "https://github.com/vuejs/vue-next/commit/d87d059ac120ed0496f85474344ef76e40fa9bc7">d87d059</a>)
              <span id="watchSyncEffect"></span> <span id=
              "d87d059"></span></p>
              <p>watch options flush -&gt; sync</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">watchSyncEffect</span><span style=
                "color: #51afef;">(</span>
  effect: <span style="color: #ECBE7B;">WatchEffect</span>,
  options?: <span style="color: #ECBE7B;">DebuggerOptions</span>
<span style="color: #51afef;">)</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">doWatch</span><span style=
"color: #c678dd;">(</span>
    effect,
    <span style="color: #a9a1e1;">null</span>,
    <span style="color: #98be65;">(</span>__DEV__
      ? Object.<span style=
"color: #c678dd;">assign</span><span style=
"color: #a9a1e1;">(</span>options || <span style=
"color: #51afef;">{}</span>, <span style=
"color: #51afef;">{</span> flush: <span style=
"color: #98be65;">'sync'</span> <span style=
"color: #51afef;">}</span><span style="color: #a9a1e1;">)</span>
      : <span style="color: #a9a1e1;">{</span> flush: <span style=
"color: #98be65;">'sync'</span> <span style=
"color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span> <span style=
"color: #51afef;">as</span> WatchOptionsBase
  <span style="color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { nodeOps, render, nextTick, h, serializeInner: s, defineComponent, ref, watchSyncEffect } = value
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">count</span> = ref(<span style=
"color: #da8548; font-weight: bold;">0</span>)
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">count2</span> = ref(<span style=
"color: #da8548; font-weight: bold;">0</span>)
<span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">result1</span>, <span style=
"color: #dcaeea;">result2</span>, <span style=
"color: #dcaeea;">callCount</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">assertion</span> = count =&gt; {
  console.log(<span style=
"color: #98be65;">'called '</span> + ++callCount)
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">on mount, watch callback 应该在 DOM 渲染之前被调用</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">on update, 应该在 count 更新之前被调用</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">因为是同步 effect</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">expectedDOM</span> = callCount === <span style=
"color: #da8548; font-weight: bold;">1</span> ? <span style=
"color: #98be65;">''</span> : <span style=
"color: #98be65;">`${count - 1}`</span>
  result1 = s(root) === expectedDOM

  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">在同步回调中，在第2次调用时，state mutation 还不会被执行，但是在第3次调用时被执行</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">expectedState</span> = callCount &lt;<span style=
"color: #da8548; font-weight: bold;">3</span> ? <span style=
"color: #da8548; font-weight: bold;">0</span> : <span style=
"color: #da8548; font-weight: bold;">1</span>
  result2 = count2.value === expectedState
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Comp</span> = {
  setup() {
    watchSyncEffect(() =&gt; {
      assertion(count.value)
    })
    <span style=
"color: #51afef;">return</span> () =&gt; count.value
  }
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">root</span> = nodeOps.createElement(<span style=
"color: #98be65;">'div'</span>)
render(h(Comp), root)
console.log(<span style=
"color: #98be65;">'before set, result1 = '</span> + result1)
console.log(<span style=
"color: #98be65;">'before set, result2 = '</span> + result2)

count.value++
count2.value++
nextTick().then(() =&gt; {
  console.log(<span style=
"color: #98be65;">'\nafter set, result1 = '</span> + result1)
  console.log(<span style=
"color: #98be65;">'after set, result2 = '</span> + result2)
})

</pre>
              </div>
              <p>源码：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #5B6268;">// </span><span style=
                "color: #5B6268;">apiWatch.ts -&gt; doWatch(...)</span>
<span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">scheduler</span>: <span style=
"color: #ECBE7B;">EffectScheduler</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">如果是 flush : 'sync', 这里会直接给 sheduler，这个</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">scheduler 会在值发生变更 trigger -&gt; triggerEffect 中执行</span>
<span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>flush === <span style=
"color: #98be65;">'sync'</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  scheduler = job <span style=
"color: #51afef;">as</span> <span style=
"color: #51afef;">any</span> <span style=
"color: #5B6268;">// </span><span style=
"color: #5B6268;">the scheduler function gets called directly</span>
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">getter 已经上面测试中的 watchSyncEffect(fn) 的 fn 函数</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">effect</span> = <span style=
"color: #51afef;">new</span> <span style=
"color: #ECBE7B;">ReactiveEffect</span><span style=
"color: #51afef;">(</span>getter, scheduler<span style=
"color: #51afef;">)</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">initial run</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>cb<span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
  <span style="color: #51afef;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>flush === <span style=
"color: #98be65;">'post'</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
  <span style="color: #51afef;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">on mount 时执行,</span>
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">会进入这里直接的执行 run, 即立即执行一次 watchSyncEffect(fn) 的 fn</span>
    effect.<span style="color: #c678dd;">run</span><span style=
"color: #c678dd;">()</span>
  <span style="color: #51afef;">}</span>


<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">effect.ts -&gt; trigger -&gt; triggerEffects</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">on update 执行的: trigger 的时候如果有 scheduler 会直接执行</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">triggerEffects</span><span style=
"color: #51afef;">(</span>
  dep: <span style=
"color: #ECBE7B;">Dep</span> | ReactiveEffect<span style=
"color: #c678dd;">[]</span>,
  debuggerEventExtraInfo?: <span style=
"color: #ECBE7B;">DebuggerEventExtraInfo</span>
<span style="color: #51afef;">)</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">spread into array for stabilization</span>
  <span style="color: #51afef;">for</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">effect</span> <span style=
"color: #51afef;">of</span> <span style=
"color: #c678dd;">isArray</span><span style=
"color: #98be65;">(</span>dep<span style=
"color: #98be65;">)</span> ? dep : <span style=
"color: #98be65;">[</span>...dep<span style=
"color: #98be65;">]</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>effect !== activeEffect || effect.allowRecurse<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>__DEV__ &amp;& effect.onTrigger<span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        effect.<span style=
"color: #c678dd;">onTrigger</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">extend</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">{</span> effect <span style=
"color: #98be65;">}</span>, debuggerEventExtraInfo<span style=
"color: #c678dd;">)</span><span style="color: #51afef;">)</span>
      <span style="color: #a9a1e1;">}</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>effect.scheduler<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        effect.<span style=
"color: #c678dd;">scheduler</span><span style=
"color: #51afef;">()</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #a9a1e1;">{</span>
        effect.<span style="color: #c678dd;">run</span><span style=
"color: #51afef;">()</span>
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org36f91e4" class="outline-2">
      <h2 id="org36f91e4"><span class="section-number-2">13.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.2
      (2021-07-19)</h2>
      <div class="outline-text-2" id="text-13">
        <ol class="org-ol">
          <li><b><span style="color:green;">ADD</span></b>: 支持
          <code>&lt;script setup lang="ts"&gt;</code> 中使用
          <code>const enum Foo { A: 100 }</code>, const enum</li>
          <li><b><span style="color:red;">FIX</span></b>: 支持
          <code>&lt;div :style="color: `${value}`"/&gt;</code>
          使用</li>
          <li><b><span style="color:red;">FIX</span></b>: 修复
          <code>watch([a,b], ([newA, newB], [oldA, oldB]) =&gt;
          {})</code> 中 <code>undefined -&gt; [oldA, oldB]</code>
          解构问题</li>
        </ol>
      </div>
      <div id="outline-container-org9c938b6" class="outline-3">
        <h3 id="org9c938b6"><span class=
        "section-number-3">13.1.</span> Bug Fixes
        <code>[11/11]</code></h3>
        <div class="outline-text-3" id="text-13-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support const enum (<a href=
              "https://github.com/vuejs/vue-next/commit/93a950d60d347321df4196d22f64c4810840a3bb">93a950d</a>)</p>
              <p>支持 <code>&lt;script setup lang="ts"&gt;</code> 中使用
              <code>const enum Foo { A: 100 }</code></p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> =
      process.env.VNEXT_PKG_RC + <span style=
"color: #98be65;">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">"stb-"</span>, <span style=
"color: #98be65;">""</span>));
<span style=
"color: #51afef;">const</span> { compileScript, parse } = value;

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">compileSFCScript</span>(<span style=
"color: #dcaeea;">src</span>, <span style=
"color: #dcaeea;">options</span>) {
  <span style=
"color: #51afef;">const</span> { descriptor } = parse(src)
  <span style=
"color: #51afef;">return</span> compileScript(descriptor, {
    ...options,
    id: <span style="color: #98be65;">'xxxxxxx'</span>
  })
}

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">compileWithRefSugar</span>(<span style=
"color: #dcaeea;">src</span>) {
  <span style=
"color: #51afef;">return</span> compileSFCScript(src, { refSugar: <span style="color: #a9a1e1;">true</span> })
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">_</span> = (title, src) =&gt; {
  <span style=
"color: #51afef;">const</span> { content } = compileWithRefSugar(src)
  console.log(title, <span style=
"color: #98be65;">'\n'</span>, content)
}

_(<span style=
"color: #98be65;">'const enum &gt;&gt; '</span>, <span style=
"color: #98be65;">`</span>
<span style="color: #98be65;">&lt;script setup lang="ts"&gt;</span>
<span style="color: #98be65;">  const enum Foo { A = 123 }</span>
<span style="color: #98be65;">&lt;/script&gt;`</span>)
</pre>
              </div>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/compiler-sfc/src/compileScript.ts</span>
<span style=
"color: #a9a1e1;">@@ -1008,7 +1008,7 @@</span><span style=
"color: #46D9FF;"> export function compileScript(</span>

<span style="color: #a4aab6;">    if (isTS) {</span>
<span style="color: #a4aab6;">      // runtime enum</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      if (node.type === 'TSEnumDeclaration' &amp;& !node.const) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      if (node.type === 'TSEnumDeclaration') {</span>
<span style=
"color: #a4aab6;">        registerBinding(setupBindings, node.id, BindingTypes.SETUP_CONST)</span>
<span style="color: #a4aab6;">      }</span>

</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: computed should not trigger scheduler
              if stopped (<a href=
              "https://github.com/vuejs/vue-next/commit/6eb47f000a1b54b2419c031979502d2793c5189d">6eb47f0</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4149">#4149</a></p>
              <p>组件 deactivated 之后不应该再执行 compute 计算，3.2.1
              中好像又改回去了？</p>
              <div class="org-src-container">
                <pre class="src src-js">(<span style=
                "color: #51afef;">async</span> <span style=
                "color: #51afef;">function</span> () {
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../reactivity/dist/reactivity.cjs.js'</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
  <span style=
"color: #51afef;">const</span> { reactive, effect, computed, ref } = value
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">tick</span> = Promise.resolve()
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">queue</span> = []
  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">queued</span> = <span style=
"color: #a9a1e1;">false</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">schedule</span> = fn =&gt; {
    queue.push(fn)
    <span style="color: #51afef;">if</span> (!queued) {
      queued = <span style="color: #a9a1e1;">true</span>
      tick.then(flush)
    }
  }

  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">flush</span> = () =&gt; {
    <span style="color: #51afef;">for</span> (<span style=
"color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>; i &lt; queue.length; i++) {
      queue[i]()
    }
    queue.length = <span style=
"color: #da8548; font-weight: bold;">0</span>
    queued = <span style="color: #a9a1e1;">false</span>
  }

  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">c1Spy</span> = () =&gt; {
    i++
    console.log(<span style="color: #98be65;">'xxx'</span>);
  }
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">src</span> = ref(<span style=
"color: #da8548; font-weight: bold;">0</span>)
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">c1</span> = computed(() =&gt; {
    c1Spy()
    <span style=
"color: #51afef;">return</span> src.value % <span style=
"color: #da8548; font-weight: bold;">2</span>
  })
  effect(() =&gt; c1.value)
  console.log(<span style=
"color: #98be65;">`c1Spy called ${i} times`</span>)

  schedule(() =&gt; {
    console.log(<span style="color: #98be65;">'\nstopped'</span>);
    c1.effect.stop()
  })

  src.value++

  <span style="color: #51afef;">await</span> tick
  console.log(<span style=
"color: #98be65;">`c1Spy called ${i} times`</span>)

}())

  <span style="color: #51afef;">return</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: fix null type in required +
              multi-type prop declarations (<a href=
              "https://github.com/vuejs/vue-next/commit/bbf6ca9bca942df639ff0357d713413c9a1c4c05">bbf6ca9</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4146">#4146</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/4147">#4147</a>
              支持多种类型时 null 声明。</p>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span style=
                "color: #c678dd;">test</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #98be65;">'support null in required + multiple-type declarations'</span>, <span style="color: #c678dd;">()</span> <span style="color: #51afef;">=&gt;</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Comp</span> = <span style=
"color: #98be65;">{</span>
      props: <span style="color: #a9a1e1;">{</span>
        foo: <span style="color: #51afef;">{</span> <span style=
"color: #51afef;">type</span>: <span style=
"color: #c678dd;">[</span>Function, <span style=
"color: #a9a1e1;">null</span><span style=
"color: #c678dd;">]</span>, required: <span style=
"color: #a9a1e1;">true</span> <span style=
"color: #51afef;">}</span>
      <span style="color: #a9a1e1;">}</span>,
      <span style="color: #c678dd;">render</span><span style=
"color: #a9a1e1;">()</span> <span style="color: #a9a1e1;">{}</span>
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">root</span> = nodeOps.<span style=
"color: #c678dd;">createElement</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">'div'</span><span style=
"color: #98be65;">)</span>
    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #a9a1e1;">{</span>
      <span style="color: #c678dd;">render</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">h</span><span style=
"color: #c678dd;">(</span>Comp, <span style=
"color: #98be65;">{</span> foo: <span style=
"color: #a9a1e1;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #a9a1e1;">{}</span> <span style=
"color: #98be65;">}</span><span style=
"color: #c678dd;">)</span>, root<span style=
"color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>.not.<span style=
"color: #c678dd;">toThrow</span><span style=
"color: #98be65;">()</span>

    <span style="color: #c678dd;">expect</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #a9a1e1;">{</span>
      <span style="color: #c678dd;">render</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">h</span><span style=
"color: #c678dd;">(</span>Comp, <span style=
"color: #98be65;">{</span> foo: <span style=
"color: #a9a1e1;">null</span> <span style=
"color: #98be65;">}</span><span style=
"color: #c678dd;">)</span>, root<span style=
"color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span>.not.<span style=
"color: #c678dd;">toThrow</span><span style=
"color: #98be65;">()</span>
  <span style="color: #c678dd;">}</span><span style=
"color: #51afef;">)</span>
</pre>
              </div>
              <p>FIX:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/runtime-core/src/componentProps.ts</span>
<span style=
"color: #a9a1e1;">@@ -529,7 +529,7 @@</span><span style="color: #46D9FF;"> function validatePropName(key: string) {</span>
<span style=
"color: #a4aab6;">// so that it works across vms / iframes.</span>
<span style=
"color: #a4aab6;">function getType(ctor: Prop&lt;any&gt;): string {</span>
<span style=
"color: #a4aab6;">  const match = ctor &amp;& ctor.toString().match(/^\s*function (\w+)/)</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  return match ? match[1] : ''</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  return match ? match[1] : </span><span style="color: #98be65; background-color: #21242b;">ctor === null ? 'null' :</span><span style="color: #98be65; background-color: #21242b;"> ''</span>
<span style="color: #a4aab6;">}</span>

<span style=
"color: #a4aab6;">function isSameType(a: Prop&lt;any&gt;, b: Prop&lt;any&gt;): boolean {</span>
<span style=
"color: #a9a1e1;">@@ -637,6 +637,8 @@</span><span style="color: #46D9FF;"> function assertType(value: unknown, type: PropConstructor): AssertionResult {</span>
<span style="color: #a4aab6;">    valid = isObject(value)</span>
<span style=
"color: #a4aab6;">  } else if (expectedType === 'Array') {</span>
<span style="color: #a4aab6;">    valid = isArray(value)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  } else if (expectedType === 'null') {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    valid = value === null</span>
<span style="color: #a4aab6;">  } else {</span>
<span style=
"color: #a4aab6;">    valid = value instanceof type</span>
<span style="color: #a4aab6;">  }</span>
<span style=
"color: #a9a1e1;">@@ -656,7 +658,7 @@</span><span style="color: #46D9FF;"> function getInvalidTypeMessage(</span>
<span style="color: #a4aab6;">): string {</span>
<span style="color: #a4aab6;">  let message =</span>
<span style=
"color: #a4aab6;">    `Invalid prop: type check failed for prop "${name}".` +</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    ` Expected ${expectedTypes.map(capitalize).join(', ')}`</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    ` Expected ${expectedTypes.map(capitalize).join(' | ')}`</span>
<span style=
"color: #a4aab6;">  const expectedType = expectedTypes[0]</span>
<span style=
"color: #a4aab6;">  const receivedType = toRawType(value)</span>
<span style=
"color: #a4aab6;">  const expectedValue = styleValue(value, expectedType)</span>

</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>scheduler: fix insertion for id-less job (<a href=
              "https://github.com/vuejs/vue-next/commit/d810a1a56943aeba5160b42bc917187e99cdfb8e">d810a1a</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4148">#4148</a></p>
              <p>scheduler 调试 job 过程中是按照 job.id 的大小来进行排序的，比如，队列中有三个
              job: <code>job1{id:5}, job4, job2{id:1}, job5,
              job3{id:3}</code> 最后当前队列中会有： <code>[job2, job1, job3,
              job4, job5]</code> 如果一个任务没有 id，会直接按照调用顺序逐个追加 到队列末尾,如
              job4, job5。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-core/src/scheduler.ts</span>
<span style="color: #a9a1e1;">@@ -10,6 +10,7 @@</span><span style=
"color: #46D9FF;"> setComputedScheduler(queueJob)</span>
<span style=
"color: #a4aab6;">export interface SchedulerJob extends Function {</span>
<span style="color: #a4aab6;">  id?: number</span>
<span style="color: #a4aab6;">  active?: boolean</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  computed?: boolean</span>
<span style="color: #a4aab6;">  /**</span>
<span style=
"color: #a4aab6;">   * Indicates whether the effect is allowed to recursively trigger itself</span>
<span style=
"color: #a4aab6;">   * when managed by the scheduler.</span>
<span style=
"color: #a9a1e1;">@@ -70,16 +71,15 @@</span><span style="color: #46D9FF;"> export function nextTick&lt;T = void&gt;(</span>
<span style=
"color: #a4aab6;">// Use binary-search to find a suitable position in the queue,</span>
<span style=
"color: #a4aab6;">// so that the queue maintains the increasing order of job's id,</span>
<span style=
"color: #a4aab6;">// which can prevent the job from being skipped and also can avoid repeated patching.</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;"> function findInsertionIndex(</span><span style="color: #ff6c6b; background-color: #23272e;">job</span><span style="color: #ff6c6b; background-color: #23272e;">: </span><span style="color: #ff6c6b; background-color: #23272e;">SchedulerJob</span><span style="color: #ff6c6b; background-color: #23272e;">) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> function findInsertionIndex(</span><span style="color: #98be65; background-color: #21242b;">id</span><span style="color: #98be65; background-color: #21242b;">: </span><span style="color: #98be65; background-color: #21242b;">number</span><span style="color: #98be65; background-color: #21242b;">) {</span>
<span style=
"color: #a4aab6;">  // the start index should be `flushIndex + 1`</span>
<span style="color: #a4aab6;">  let start = flushIndex + 1</span>
<span style="color: #a4aab6;">  let end = queue.length</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  const jobId = getId(job)</span>

<span style="color: #a4aab6;">  while (start &lt; end) {</span>
<span style=
"color: #a4aab6;">    const middle = (start + end) &gt;&gt;&gt; 1</span>
<span style=
"color: #a4aab6;">    const middleJobId = getId(queue[middle])</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    middleJobId &lt; jobId ? (start = middle + 1) : (end = middle)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    middleJobId &lt; id ? (start = middle + 1) : (end = middle)</span>
<span style="color: #a4aab6;">  }</span>

<span style="color: #a4aab6;">  return start</span>
<span style=
"color: #a9a1e1;">@@ -100,11 +100,10 @@</span><span style=
"color: #46D9FF;"> export function queueJob(job: SchedulerJob) {</span>
<span style="color: #a4aab6;">      )) &amp;&</span>
<span style=
"color: #a4aab6;">    job !== currentPreFlushParentJob</span>
<span style="color: #a4aab6;">  ) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    </span><span style="color: #ff6c6b; background-color: #23272e;">const pos = findInsertionIndex(job)</span><span style="color: #ff6c6b; background-color: #23272e;">
</span><span style=
"color: #ff6c6b; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    if (</span><span style="color: #ff6c6b; background-color: #23272e;">pos &gt; -1) {</span><span style="color: #ff6c6b; background-color: #23272e;">
</span><span style=
"color: #ff6c6b; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      queue.splice(pos, 0,</span><span style="color: #ff6c6b; background-color: #23272e;"> job</span><span style="color: #ff6c6b; background-color: #23272e;">)</span><span style="color: #ff6c6b; background-color: #23272e;">
</span><span style=
"color: #ff6c6b; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    </span><span style="color: #ff6c6b; background-color: #23272e;">}</span><span style="color: #ff6c6b; background-color: #23272e;"> </span><span style="color: #ff6c6b; background-color: #23272e;">else</span><span style="color: #ff6c6b; background-color: #23272e;"> {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    if (job</span><span style="color: #98be65; background-color: #21242b;">.id</span><span style="color: #98be65; background-color: #21242b;"> </span><span style="color: #98be65; background-color: #21242b;">==</span><span style="color: #98be65; background-color: #21242b;"> </span><span style="color: #98be65; background-color: #21242b;">null)</span><span style="color: #98be65; background-color: #21242b;"> {</span>
<span style="color: #a4aab6;">      queue.push(job)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    } else {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      queue.splice(findInsertionIndex(job.id), 0, job)</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">    queueFlush()</span>
<span style="color: #a4aab6;">  }</span>
<span style=
"color: #a9a1e1;">@@ -253,6 +252,7 @@</span><span style="color: #46D9FF;"> function flushJobs(seen?: CountMap) {</span>
<span style=
"color: #a4aab6;">        if (__DEV__ &amp;& checkRecursiveUpdates(seen!, job)) {</span>
<span style="color: #a4aab6;">          continue</span>
<span style="color: #a4aab6;">        }</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        // console.log(`running:`, job.id)</span>
<span style=
"color: #a4aab6;">        callWithErrorHandling(job, null, ErrorCodes.SCHEDULER)</span>
<span style="color: #a4aab6;">      }</span>
    }
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>shared: normalizeStyle should handle strings
              (<a href=
              "https://github.com/vuejs/vue-next/commit/a8c3a8ad61b16a31f6754066838440a59ee9db8b">a8c3a8a</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4138">#4138</a></p>
              <p>问题： <code>&lt;h1 :style="`color: ${x};`"
              style=""&gt;Hello World!&lt;/h1&gt;</code></p>
              <p>修复：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/shared/src/normalizeProp.ts</span>
<span style="color: #a9a1e1;">@@ -18,6 +18,8 @@</span><span style=
"color: #46D9FF;"> export function normalizeStyle(value: unknown): NormalizedStyle | undefined {</span>
<span style="color: #a4aab6;">      }</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">    return res</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  } else if (isString(value)) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    return parseStringStyle(value)</span>
<span style=
"color: #a4aab6;">  } else if (isObject(value)) {</span>
<span style="color: #a4aab6;">    return value</span>
  }
</pre>
              </div>
              <p>源码：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">listDelimiterRE</span> = <span style=
                "color: #98be65;">/;(?![^(]*\))/</span>g
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">propertyDelimiterRE</span> = <span style=
"color: #98be65;">/:(.+)/</span>

<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">parseStringStyle</span><span style=
"color: #51afef;">(</span><span style=
"color: #dcaeea;">cssText</span>: <span style=
"color: #51afef;">string</span><span style=
"color: #51afef;">)</span>: <span style=
"color: #ECBE7B;">NormalizedStyle</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">ret</span>: <span style=
"color: #ECBE7B;">NormalizedStyle</span> = <span style=
"color: #c678dd;">{}</span>
  cssText.<span style="color: #c678dd;">split</span><span style=
"color: #c678dd;">(</span>listDelimiterRE<span style=
"color: #c678dd;">)</span>.<span style=
"color: #c678dd;">forEach</span><span style=
"color: #c678dd;">(</span>item <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #98be65;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span>item<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">tmp</span> = item.<span style=
"color: #c678dd;">split</span><span style=
"color: #51afef;">(</span>propertyDelimiterRE<span style=
"color: #51afef;">)</span>
      tmp.length &gt; <span style=
"color: #da8548; font-weight: bold;">1</span> &amp;& <span style=
"color: #51afef;">(</span>ret<span style=
"color: #c678dd;">[</span>tmp<span style=
"color: #98be65;">[</span><span style=
"color: #da8548; font-weight: bold;">0</span><span style=
"color: #98be65;">]</span>.<span style=
"color: #c678dd;">trim</span><span style=
"color: #98be65;">()</span><span style=
"color: #c678dd;">]</span> = tmp<span style=
"color: #c678dd;">[</span><span style=
"color: #da8548; font-weight: bold;">1</span><span style=
"color: #c678dd;">]</span>.<span style=
"color: #c678dd;">trim</span><span style=
"color: #c678dd;">()</span><span style="color: #51afef;">)</span>
    <span style="color: #a9a1e1;">}</span>
  <span style="color: #98be65;">}</span><span style=
"color: #c678dd;">)</span>
  <span style="color: #51afef;">return</span> ret
<span style="color: #51afef;">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>ssr: update initial old value to watch callback in
              ssr usage (<a href=
              "https://github.com/vuejs/vue-next/issues/4103">#4103</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/20b6619793702d265fcc3a7c099f5764fa9d8685">20b6619</a>)
              问题： 指定 <code>immediate: true</code> 时候会立即执行一次，然而此时
              oldValue 是 undefined 会导致 callback([…], [oldA, oldB])
              解构错误(<code>undefined -&gt; [oldA, oldB]</code>)</p>
              <div class="org-src-container">
                <pre class="src src-js">setup(){
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">a</span> = ref(<span style=
"color: #da8548; font-weight: bold;">1</span>)
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">b</span> = ref(<span style=
"color: #da8548; font-weight: bold;">2</span>)
  watch([a, b], ([newA, newB], [oldA, oldB]) =&gt; {
    <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
  }, { deep: <span style=
"color: #a9a1e1;">true</span>, immediate: <span style=
"color: #a9a1e1;">true</span> })
}
</pre>
              </div>
              <p>修复： 检查被 watch 的源数据，如果是数据 oldValue 初始化成
              <code>[]</code></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-core/src/apiWatch.ts</span>
<span style=
"color: #a9a1e1;">@@ -265,7 +265,7 @@</span><span style="color: #46D9FF;"> function doWatch(</span>
<span style="color: #a4aab6;">    } else if (immediate) {</span>
<span style=
"color: #a4aab6;">      callWithAsyncErrorHandling(cb, instance, ErrorCodes.WATCH_CALLBACK, [</span>
<span style="color: #a4aab6;">        getter(),</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">        undefined,</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        </span><span style="color: #98be65; background-color: #21242b;">isMultiSource ? [] :</span><span style="color: #98be65; background-color: #21242b;"> undefined,</span>
<span style="color: #a4aab6;">        onInvalidate</span>
<span style="color: #a4aab6;">      ])</span>
    }
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>v-model: properly detect input type=number
              (<a href=
              "https://github.com/vuejs/vue-next/commit/3056e9b3dcb1ab0bd18227c6fa7bf283f98f6ef6">3056e9b</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3813">#3813</a></p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-dom/src/directives/vModel.ts</span>
<span style="color: #a9a1e1;">@@ -49,7 +49,8 @@</span><span style=
"color: #46D9FF;"> export const vModelText: ModelDirective&lt;</span>
<span style=
"color: #22aa22; background-color: #21242b;">&gt;</span><span style="color: #98be65; background-color: #21242b;"> = {</span>
<span style=
"color: #a4aab6;">  created(el, { modifiers: { lazy, trim, number } }, vnode) {</span>
<span style=
"color: #a4aab6;">    el._assign = getModelAssigner(vnode)</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    const castToNumber = number || el.type === 'number'</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    const castToNumber =</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      number || (vnode.props &amp;& vnode.props.type === 'number')</span>
<span style=
"color: #a4aab6;">    addEventListener(el, lazy ? 'change' : 'input', e =&gt; {</span>
<span style=
"color: #a4aab6;">      if ((e.target as any).composing) return</span>
      let domValue: string | number = el.value
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org152b377" class="outline-3">
        <h3 id="org152b377"><span class=
        "section-number-3">13.2.</span> Features
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-13-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler: allow ’comments’ option to affect
              comment inclusion in dev (<a href=
              "https://github.com/vuejs/vue-next/issues/4115">#4115</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/dd0f9d1ce6b0de59c84d334c7190fa9d2cc17a04">dd0f9d1</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3392">#3392</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/3395">#3395</a>
              <span id="dd0f9d1"></span></p>
              <p>由 <code>__DEV__</code> 值决定 comments 是否保留。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: add <a href=
              "#ignore-empty-blocks">ignoreEmpty</a> option for sfc
              parse method (<a href=
              "https://github.com/vuejs/vue-next/commit/8dbecfcbb3d597a644d0f263dfd6d7fcfd23a9fb">8dbecfc</a>)</p>
              <p>支持 sfc <code>parse(src, { ignoreEmpty: true/false
              })</code> 来决定是否忽略空的 script 和 style</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>types: map declared emits to onXXX props in
              inferred prop types (<a href=
              "https://github.com/vuejs/vue-next/issues/3926">#3926</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/69344ff1ae724beb648c34ede8050b3b70ddf4b7">69344ff</a>)
              <span id="69344ff"></span></p>
              <p>emits 事件绑定的函数类型推导。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/runtime-core/src/componentEmits.ts</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> export type EmitsToProps&lt;T extends EmitsOptions&gt; = T extends string[]</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  ? {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      [K in string & `on${Capitalize&lt;T[number]&gt;}`]?: (...args: any[]) =&gt; any</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    }</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  : T extends ObjectEmitsOptions</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  ? {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      [K in string &</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        `on${Capitalize&lt;string & keyof T&gt;}`]?: K extends `on${infer C}`</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        ? T[Uncapitalize&lt;C&gt;] extends null</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          ? (...args: any[]) =&gt; any</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          : T[Uncapitalize&lt;C&gt;]</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        : never</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    }</span>
+  : {}
</pre>
              </div>
              <p>test:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">  const MyComponent = defineComponent({</span>
<span style=
"color: #a4aab6;">    mixins: [MixinA, MixinB, MixinC, MixinD],</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    emits: ['click'],</span>
<span style="color: #a4aab6;">    props: {</span>
<span style=
"color: #a4aab6;">      // required should make property non-void</span>
<span style="color: #a4aab6;">      z: {</span>
<span style=
"color: #a9a1e1;">@@ -552,6 +554,9 @@</span><span style="color: #46D9FF;"> describe('with mixins', () =&gt; {</span>
<span style="color: #a4aab6;">    setup(props) {</span>
<span style=
"color: #a4aab6;">      expectType&lt;string&gt;(props.z)</span>
<span style="color: #a4aab6;">      // props</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      expectType&lt;((...args: any[]) =&gt; any) | undefined&gt;(props.onClick)</span>
<span style="color: #a4aab6;">      // from Base</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      expectType&lt;((...args: any[]) =&gt; any) | undefined&gt;(props.onBar)</span>
<span style=
"color: #a4aab6;">      expectType&lt;string&gt;(props.aP1)</span>
<span style=
"color: #a4aab6;">      expectType&lt;boolean | undefined&gt;(props.aP2)</span>
      expectType&lt;any&gt;(props.bP1)
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org8cb3293" class="outline-3">
        <h3 id="org8cb3293"><span class=
        "section-number-3">13.3.</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-13-3">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: ignore empty blocks (<a href=
              "https://github.com/vuejs/vue-next/issues/3520">#3520</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/b771fdbef9a8dadd4c9cc939cc104f7764e40373">b771fdb</a>)
              <span id="ignore-empty-blocks"></span></p>
              <p>忽略 SFC 中的空标签。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">packages/compiler-sfc/src/parse.ts</span>
<span style=
"color: #a9a1e1;">@@ -162,7 +162,8 @@</span><span style="color: #46D9FF;"> export function parse(</span>
<span style=
"color: #a4aab6;">    if (node.type !== NodeTypes.ELEMENT) {</span>
<span style="color: #a4aab6;">      return</span>
<span style="color: #a4aab6;">    }</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    </span><span style="color: #ff6c6b; background-color: #23272e;">if</span><span style="color: #ff6c6b; background-color: #23272e;"> </span><span style="color: #ff6c6b; background-color: #23272e;">(!node.children.length</span><span style="color: #ff6c6b; background-color: #23272e;"> </span><span style="color: #ff6c6b; background-color: #23272e;">&amp;&</span><span style="color: #ff6c6b; background-color: #23272e;"> </span><span style="color: #ff6c6b; background-color: #23272e;">!hasSrc</span><span style="color: #ff6c6b; background-color: #23272e;">(</span><span style="color: #ff6c6b; background-color: #23272e;">node</span><span style="color: #ff6c6b; background-color: #23272e;">) </span><span style="color: #ff6c6b; background-color: #23272e;">&amp;&</span><span style="color: #ff6c6b; background-color: #23272e;"> node.tag !== 'template') {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    </span><span style="color: #98be65; background-color: #21242b;">//</span><span style="color: #98be65; background-color: #21242b;"> </span><span style="color: #98be65; background-color: #21242b;">we</span><span style="color: #98be65; background-color: #21242b;"> </span><span style="color: #98be65; background-color: #21242b;">only want to keep the nodes that are not empty</span><span style="color: #98be65; background-color: #21242b;"> (</span><span style="color: #98be65; background-color: #21242b;">when the tag is not a template</span><span style="color: #98be65; background-color: #21242b;">)</span>
<span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    </span><span style="color: #98be65; background-color: #21242b;">if (</span><span style="color: #98be65; background-color: #21242b;">node.tag !== 'template' </span><span style="color: #98be65; background-color: #21242b;">&amp;& isEmpty(node) &amp;& !hasSrc(node)</span><span style="color: #98be65; background-color: #21242b;">) {</span>
<span style="color: #a4aab6;">      return</span>
<span style="color: #a4aab6;">    }</span>
<span style="color: #a4aab6;">    switch (node.tag) {</span>
<span style=
"color: #a9a1e1;">@@ -415,3 +416,15 @@</span><span style=
"color: #46D9FF;"> function hasSrc(node: ElementNode) {</span>
<span style="color: #a4aab6;">    return p.name === 'src'</span>
<span style="color: #a4aab6;">  })</span>
<span style="color: #a4aab6;">}</span>
<span style="color: #22aa22; background-color: #21242b;">+</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> /**</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> * Returns true if the node has no children</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> * once the empty text nodes (trimmed content) have been filtered out.</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> */</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> function isEmpty(node: ElementNode) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  return (</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    node.children.filter(</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      child =&gt; child.type !== NodeTypes.TEXT || child.content.trim() !== ''</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    ).length === 0</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  )</span>
+ }
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> =
      process.env.VNEXT_PKG_RC + <span style=
"color: #98be65;">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">"stb-"</span>, <span style=
"color: #98be65;">""</span>));
<span style=
"color: #51afef;">const</span> { compileScript, parse } = value;

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">_</span> = (title, src) =&gt; {
  <span style=
"color: #51afef;">const</span> { descriptor: { script, styles, template } } = parse(src)
  console.log(title, <span style=
"color: #98be65;">'\n'</span>, script, styles, template.content)
}


_(<span style="color: #98be65;">'empty tag'</span>, <span style=
"color: #98be65;">`&lt;template&gt;</span>
<span style=
"color: #98be65;">  &lt;h1&gt;{{ msg }}&lt;/h1&gt;</span>
<span style="color: #98be65;">&lt;/template&gt;</span>

<span style="color: #98be65;">&lt;script setup&gt;</span>

<span style="color: #98be65;">&lt;/script&gt;</span>

<span style="color: #98be65;">&lt;style scoped&gt;</span>

<span style="color: #98be65;">&lt;/style&gt;`</span>)
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-orga5d923f" class="outline-2">
      <h2 id="orga5d923f"><span class="section-number-2">14.</span>
      <span class="done DONE">DONE</span> 3.2.0-beta.1
      (2021-07-16)</h2>
      <div class="outline-text-2" id="text-14">
        <ol class="org-ol">
          <li>
            <b><span style="color:green;">ADD</span></b>:
            <code>defineCustomElement</code> 结合
            <code>window.customElements</code> 来定义元素 <a class=
            "anchor" aria-hidden="true" id="defineCustomElement"
            href="#defineCustomElement"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b>*<span style="color:green;">ADD</span></b>:
            <abbr class="tooltip" title=
            "&lt;strong&gt;3.2+&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any[]&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;Memoize a sub-tree of the template. Can be used on both elements and components.&lt;br&gt;The directive expects a fixed-length array of dependency values to compare for&lt;br&gt;the memoization. If every value in the array was the same as last render, then&lt;br&gt;updates for the entire sub-tree will be skipped. For example:&lt;br&gt;&lt;br&gt;&lt;div v-memo=''[valueA, valueB]''&gt;&lt;br&gt; ...&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component re-renders, if both valueA and valueB remain the same, all&lt;br&gt;updates for this &lt;div&gt; and its children will be skipped. In fact, even the&lt;br&gt;Virtual DOM VNode creation will also be skipped since the memoized copy of the&lt;br&gt;sub-tree can be reused.&lt;br&gt;&lt;br&gt;It is important to specify the memoization array correctly, otherwise we may&lt;br&gt;skip updates that should indeed be applied. v-memo with an empty dependency&lt;br&gt;array (v-memo=''[]'') would be functionally equivalent to v-once.&lt;br&gt;&lt;br&gt;Usage with v-for&lt;br&gt;&lt;br&gt;v-memo is provided solely for micro optimizations in performance-critical&lt;br&gt;scenarios and should be rarely needed. The most common case where this may prove&lt;br&gt;helpful is when rendering large v-for lists (where length &gt; 1000):&lt;br&gt;&lt;br&gt;&lt;div v-for=''item in list'' :key=''item.id'' v-memo=''[item.id === selected]''&gt;&lt;br&gt; &lt;p&gt;ID: {{ item.id }} - selected: {{ item.id === selected }}&lt;/p&gt;&lt;br&gt; &lt;p&gt;...more child nodes&lt;/p&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component's selected state changes, a large amount of VNodes will be&lt;br&gt;created even though most of the items remained exactly the same. The v-memo&lt;br&gt;usage here is essentially saying ''only update this item if it went from&lt;br&gt;non-selected to selected, or the other way around''. This allows every unaffected&lt;br&gt;item to reuse its previous VNode and skip diffing entirely. Note we don't need&lt;br&gt;to include item.id in the memo dependency array here since Vue automatically&lt;br&gt;infers it from the item's :key.&lt;br&gt;&lt;br&gt;WARNING&lt;br&gt;&lt;br&gt;When using v-memo with v-for, make sure they are used on the same element.&lt;br&gt;v-memo does not work inside v-for.&lt;br&gt;&lt;br&gt;v-memo can also be used on components to manually prevent unwanted updates in&lt;br&gt;certain edge cases where the child component update check has been de-optimized.&lt;br&gt;But again, it is the developer's responsibility to specify correct dependency&lt;br&gt;arrays to avoid skipping necessary updates.&lt;br&gt;&lt;br&gt;See also:&lt;br&gt;&lt;br&gt;v-once (https://vuejs.org/api/built-in-directives.html#v-once)">
            v-memo</abbr> 指令可以指定哪些条件下组件需要更新 <a class="anchor"
            aria-hidden="true" id="v-memo" href=
            "#v-memo"><svg xmlns="http://www.w3.org/2000/svg"
            viewbox="0 0 16 16" width="16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b>*<span style="color:green;">ADD</span></b>:
            <code>watchPostEffect</code> 等价于 <code>doWatch(effect,
            null/*cb*/, { flush: 'post' })</code> <a class="anchor"
            aria-hidden="true" id="watchPostEffect" href=
            "#watchPostEffect"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li><b>*<span style="color:green;">ADD</span></b>:
          <code>effectScope</code></li>
          <li>
            <p><b>*<span style="color:green;">ADD</span></b>: ref
            新语法糖 <code>$ref()</code> 等价于 <code>ref()</code>,
            只是不再需要手动从 <code>vue</code> import 了</p>
            <p>之前： <code>&lt;script setup&gt;import { ref } from
            'vue'; var val = ref(1);&lt;/script&gt;</code></p>
            <p>之后： <code>&lt;script setup&gt;var val =
            $ref(1);&lt;/script&gt;</code></p>
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: 使用了
            <a href="file:///web/javascript-api-mutationobserver">MutationObserver</a>
            来解决 <code>cssVar + transition + v-if</code> 时 cssVar 不正
            常生效问题
          </li>
          <li><b><span style="color:pink;">CHG</span></b>:
          <code>ReactiveEffect</code> 改成了 class 来实现，因此 effect
          不再是函数，而是一个 <code>ReactiveEffect</code> 实例对象。</li>
        </ol>
      </div>
      <div id="outline-container-org2cb58ed" class="outline-3">
        <h3 id="org2cb58ed"><span class=
        "section-number-3">14.1.</span> Code Refactoring(代码重构)
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-14-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>remove deprecated scopeId codegen (<a href=
              "https://github.com/vuejs/vue-next/commit/f596e008efd97fe8f9b28f536fbb0fd48b9b6333">f596e00</a>)</p>
              <p>生成的 render 没有 scope id 了 ?</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #aa2222; background-color: #23272e;">-</span><span style=
                "color: #ff6c6b; background-color: #23272e;"> export const render = /*#__PURE__*/_withId((_ctx, _cache) =&gt; {</span>
+ export function render(_ctx, _cache) {
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org7e5fe63" class="outline-3">
        <h3 id="org7e5fe63"><span class=
        "section-number-3">14.2.</span> Bug Fixes
        <code>[4/4]</code></h3>
        <div class="outline-text-3" id="text-14-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>sfc/style-vars: properly re-apply style vars on
              component root elements change (<a href=
              "https://github.com/vuejs/vue-next/commit/49dc2dd1e4a56d0d2ad28003240c99e99ef469e4">49dc2dd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/3894">#3894</a>
              <span id="MutationObserver"></span></p>
              <p>在使用 <code>&lt;transition&gt;</code> 和
              <code>v-if</code> 时， <code>SFC &lt;style&gt;</code>
              中的 <code>v-bind(color)</code> 没起作用？</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">// packages/runtime-dom/src/helpers/useCssVars.ts</span>
<span style=
"color: #a4aab6;">// @@ -27,8 +27,12 @@ export function useCssVars(getter: (ctx: any) =&gt; Record&lt;string, string&gt;) {</span>
<span style="color: #a4aab6;">  const setVars = () =&gt;</span>
<span style=
"color: #a4aab6;">    setVarsOnVNode(instance.subTree, getter(instance.proxy!))</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  onMounted(() =&gt; watchEffect(setVars, { flush: 'post' }))</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  onUpdated(setVars)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  watchPostEffect(setVars)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  onMounted(() =&gt; {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    const ob = new MutationObserver(setVars)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    ob.observe(instance.subTree.el!.parentNode, { childList: true })</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    onUnmounted(() =&gt; ob.disconnect())</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  })</span>
}
</pre>
              </div>
              <p>涉及函数： <code>watchPostEffect(setVars)</code> 和
              <code>MutationObserver(setVars)</code> 的使用。</p>
              <p>watchPostEffect 是监听 instance.subTree 状态的变化时执行
              <code>setVars -&gt; setVarsOnVNode</code></p>
              <p>MutationObserver 是 JavaScript 的原生 API
              ，详情可查看<a href=
              "http://localhost:1313/web/javascript-api-mutationobserver/">此文
              JavaScript API - MutationObserver</a> 。</p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>ensure customElements API ssr compatibility
              (<a href=
              "https://github.com/vuejs/vue-next/commit/de32cfa43e94276c60f93ac4c560cb7b84534cfe">de32cfa</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/4129">#4129</a></p>
              <p>解决 SSR 服务端渲染时不支持 <code>HTMLElement</code> 的问题。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">// packages/runtime-dom/src/apiCustomElement.ts</span>
<span style=
"color: #a9a1e1;">@@ -157,7 +157,11 @@</span><span style=
"color: #46D9FF;"> export const defineSSRCustomElement = ((options: any) =&gt; {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;"> export class VueElement extends HTMLElement {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> const BaseClass = (typeof HTMLElement !== 'undefined'</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  ? HTMLElement</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  : class {}) as typeof HTMLElement</span>

<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> export class VueElement extends BaseClass {</span>
<span style="color: #a4aab6;">  /**</span>
<span style="color: #a4aab6;">   * @internal</span>
   */
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: fix default shapeFlag for fragments
              (<a href=
              "https://github.com/vuejs/vue-next/commit/2a310df7531a693be706a96d4191a5bfbf24692d">2a310df</a>)</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">  dynamicProps: string[] | null = null,</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  shapeFlag = ShapeFlags.ELEMENT,</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  shapeFlag = type === Fragment ? 0 : ShapeFlags.ELEMENT,</span>
  isBlockNode = false,
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>ignore .prop/.attr modifiers in ssr (<a href=
              "https://github.com/vuejs/vue-next/commit/29732c2c8681cc3e58251c19149ba3a0ce31cdaf">29732c2</a>)</p>
              <p>忽略 SSR 中的 .prop/.attr 因为这两个的作用是决定该属性是做为 DOM 元素的
              attribute 存在还是以 <code>element.prop = value</code>
              元素对象的属性存在。不管是哪种情况都 和实际的 DOM 元素有关。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">// packages/compiler-core/src/transforms/vBind.ts</span>
<span style=
"color: #a9a1e1;">@@ -37,12 +37,13 @@</span><span style="color: #46D9FF;"> export const transformBind: DirectiveTransform = (dir, _node, context) =&gt; {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  if (modifiers.includes('prop')) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    injectPrefix(arg, '.')</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  }</span>

<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  if (modifiers.includes('attr')) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    injectPrefix(arg, '^')</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  if (!context.inSSR) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    if (modifiers.includes('prop')) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      injectPrefix(arg, '.')</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    }</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    if (modifiers.includes('attr')) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      injectPrefix(arg, '^')</span>
+    }
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org53f44af" class="outline-3">
        <h3 id="org53f44af"><span class=
        "section-number-3">14.3.</span> Features
        <code>[10/10]</code></h3>
        <div class="outline-text-3" id="text-14-3">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code> <a href=
              "file:///vue/vue-update-3.2/#new-ref-sugar">sfc:
              (experimental) new ref sugar</a> (<a href=
              "https://github.com/vuejs/vue-next/commit/562bddb3ce76a0e98e499e199e96fa4271e5d1b4">562bddb</a>)
              <span id="sfc-ref-sugar"></span>
            </li>
            <li class="on">
              <code>[X]</code> sfc: support namespaced component
              tags when using &lt;script setup&gt; (<a href=
              "https://github.com/vuejs/vue-next/commit/e5a4412764f6db255afe01b8a7e6e40ebf707412">e5a4412</a>)
              <span id="e5a4412"></span>
            </li>
            <li class="on">
              <code>[X]</code> custom element reflection, casting
              and edge cases (<a href=
              "https://github.com/vuejs/vue-next/commit/00f0b3c46552626cd7c5ec73ffd0a918c3e1a5fb">00f0b3c</a>)
              <span id="custom-element-refection"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>remove experimental status of &lt;script setup&gt;
              (<a href=
              "https://github.com/vuejs/vue-next/commit/00f0b3c46552626cd7c5ec73ffd0a918c3e1a5fb">27104ea</a>)
              <span id="27104ea"></span></p>
              <p>正式发布 <code>&lt;script setup&gt;</code></p>
            </li>
            <li class="on">
              <code>[X]</code> support v-bind .prop & .attr
              modifiers (<a href=
              "https://github.com/vuejs/vue-next/commit/8610e1c9e23a4316f76fb35eebbab4ad48566fbf">1c7d737</a>)
              <span id="1c7d737"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-dom: defineCustomElement (<a href=
              "https://github.com/vuejs/vue-next/commit/8610e1c9e23a4316f76fb35eebbab4ad48566fbf">8610e1c</a>)
              <span id="defineCustomElement"></span> <span id=
              "8610e1c"></span></p>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/component.ts">
              runtime-core/src/component.ts:</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">interface</span> <span style=
                "color: #ECBE7B;">ComponentInternalInstance</span> <span style=
                "color: #51afef;">{</span>
  <span style="color: #5B6268;">/**</span>
<span style="color: #5B6268;">   * is custom element?</span>
<span style="color: #5B6268;">   */</span>
  isCE?: <span style="color: #51afef;">boolean</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">createComponentInstance</span><span style=
"color: #51afef;">(</span><span style=
"color: #5B6268;">/*</span><span style=
"color: #5B6268;">...*/</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">交给 vnode.ce 去处理</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">apply custom element special handling</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>vnode.ce<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    vnode.<span style="color: #c678dd;">ce</span><span style=
"color: #98be65;">(</span>instance<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/helpers/renderSlot.ts">
              runtime-core/src/helpers/renderSlot.ts</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">renderSlot</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #5B6268;">/*</span><span style=
                "color: #5B6268;">...*/</span><span style=
                "color: #51afef;">)</span> <span style=
                "color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>currentRenderingInstance!.isCE<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">createVNode</span><span style=
"color: #98be65;">(</span>
      <span style="color: #98be65;">'slot'</span>,
      name === <span style=
"color: #98be65;">'default'</span> ? <span style=
"color: #a9a1e1;">null</span> : <span style=
"color: #a9a1e1;">{</span> name <span style=
"color: #a9a1e1;">}</span>,
      fallback &amp;& <span style=
"color: #c678dd;">fallback</span><span style=
"color: #a9a1e1;">()</span>
    <span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <div>
                测试结果 <button onclick=
                "showCode('rhBIQi');">查看源码</button>
              </div>
              <div id="rhBIQi" class="comment-block"></div>
              <script id="s_rhBIQi">
              const p_rhBIQi = document.getElementById('rhBIQi')
              const cr = document.createElement('div')
              p_rhBIQi.appendChild(cr)
              const E = Vue.defineCustomElement({
              render: () => Vue.h('div', 'hello')
              })
              customElements.define('my-element', E)
              cr.innerHTML = "<my-element></my-element>"
              const e = cr.childNodes[0]
              console.log(e, e instanceof E)
              console.log(e._instance)
              console.log(e.shadowRoot.innerHTML)
              </script>
            </li>
            <li class="on">
              <code>[X]</code>
              <p><abbr class="tooltip" title=
              "&lt;strong&gt;3.2+&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any[]&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;Memoize a sub-tree of the template. Can be used on both elements and components.&lt;br&gt;The directive expects a fixed-length array of dependency values to compare for&lt;br&gt;the memoization. If every value in the array was the same as last render, then&lt;br&gt;updates for the entire sub-tree will be skipped. For example:&lt;br&gt;&lt;br&gt;&lt;div v-memo=''[valueA, valueB]''&gt;&lt;br&gt; ...&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component re-renders, if both valueA and valueB remain the same, all&lt;br&gt;updates for this &lt;div&gt; and its children will be skipped. In fact, even the&lt;br&gt;Virtual DOM VNode creation will also be skipped since the memoized copy of the&lt;br&gt;sub-tree can be reused.&lt;br&gt;&lt;br&gt;It is important to specify the memoization array correctly, otherwise we may&lt;br&gt;skip updates that should indeed be applied. v-memo with an empty dependency&lt;br&gt;array (v-memo=''[]'') would be functionally equivalent to v-once.&lt;br&gt;&lt;br&gt;Usage with v-for&lt;br&gt;&lt;br&gt;v-memo is provided solely for micro optimizations in performance-critical&lt;br&gt;scenarios and should be rarely needed. The most common case where this may prove&lt;br&gt;helpful is when rendering large v-for lists (where length &gt; 1000):&lt;br&gt;&lt;br&gt;&lt;div v-for=''item in list'' :key=''item.id'' v-memo=''[item.id === selected]''&gt;&lt;br&gt; &lt;p&gt;ID: {{ item.id }} - selected: {{ item.id === selected }}&lt;/p&gt;&lt;br&gt; &lt;p&gt;...more child nodes&lt;/p&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;When the component's selected state changes, a large amount of VNodes will be&lt;br&gt;created even though most of the items remained exactly the same. The v-memo&lt;br&gt;usage here is essentially saying ''only update this item if it went from&lt;br&gt;non-selected to selected, or the other way around''. This allows every unaffected&lt;br&gt;item to reuse its previous VNode and skip diffing entirely. Note we don't need&lt;br&gt;to include item.id in the memo dependency array here since Vue automatically&lt;br&gt;infers it from the item's :key.&lt;br&gt;&lt;br&gt;WARNING&lt;br&gt;&lt;br&gt;When using v-memo with v-for, make sure they are used on the same element.&lt;br&gt;v-memo does not work inside v-for.&lt;br&gt;&lt;br&gt;v-memo can also be used on components to manually prevent unwanted updates in&lt;br&gt;certain edge cases where the child component update check has been de-optimized.&lt;br&gt;But again, it is the developer's responsibility to specify correct dependency&lt;br&gt;arrays to avoid skipping necessary updates.&lt;br&gt;&lt;br&gt;See also:&lt;br&gt;&lt;br&gt;v-once (https://vuejs.org/api/built-in-directives.html#v-once)">
              v-memo</abbr> 可以指定什么条件下组件会被重新渲染，否则使用缓存结果 (<a href=
              "https://github.com/vuejs/vue-next/commit/3b64508e3b2d648e346cbf34e1641f4022be61b6">3b64508</a>)
              <span id="v-memo"></span> <span id=
              "3b64508"></span></p>
              <p><a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/compiler-core/src/transforms/vFor.ts">
              compiler-core/src/transforms/vFor.ts</a>
              中增加的核心代码：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #5B6268;">// </span><span style=
                "color: #5B6268;">v-memo</span>
<span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>memo<span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">loop</span> = <span style=
"color: #c678dd;">createFunctionExpression</span><span style=
"color: #c678dd;">(</span>
    <span style=
"color: #c678dd;">createForLoopParams</span><span style=
"color: #98be65;">(</span>forNode.parseResult, <span style=
"color: #a9a1e1;">[</span>
      <span style=
"color: #c678dd;">createSimpleExpression</span><span style=
"color: #51afef;">(</span><span style=
"color: #98be65;">`_cached`</span><span style=
"color: #51afef;">)</span>
    <span style="color: #a9a1e1;">]</span><span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">)</span>
  loop.body = <span style=
"color: #c678dd;">createBlockStatement</span><span style=
"color: #c678dd;">(</span><span style="color: #98be65;">[</span>
    <span style=
"color: #c678dd;">createCompoundExpression</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #51afef;">[</span><span style=
"color: #98be65;">`const _memo = (`</span>, memo.exp!, <span style=
"color: #98be65;">`)`</span><span style=
"color: #51afef;">]</span><span style="color: #a9a1e1;">)</span>,
    <span style=
"color: #c678dd;">createCompoundExpression</span><span style=
"color: #a9a1e1;">(</span><span style="color: #51afef;">[</span>
      <span style="color: #98be65;">`if (_cached`</span>,
      ...<span style=
"color: #c678dd;">(</span>keyExp ? <span style="color: #98be65;">[</span><span style="color: #98be65;">` &amp;& _cached.key === `</span>, keyExp<span style="color: #98be65;">]</span> : <span style="color: #98be65;">[]</span><span style="color: #c678dd;">)</span>,
      <span style=
"color: #98be65;">` &amp;& ${context.helperString(</span>
<span style="color: #98be65;">IS_MEMO_SAME</span>
<span style=
"color: #98be65;">)}(_cached.memo, _memo)) return _cached`</span>
    <span style="color: #51afef;">]</span><span style=
"color: #a9a1e1;">)</span>,
    <span style=
"color: #c678dd;">createCompoundExpression</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #51afef;">[</span><span style=
"color: #98be65;">`const _item = `</span>, childBlock <span style=
"color: #51afef;">as</span> <span style=
"color: #51afef;">any</span><span style=
"color: #51afef;">]</span><span style="color: #a9a1e1;">)</span>,
    <span style=
"color: #c678dd;">createSimpleExpression</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #98be65;">`_item.memo = _memo`</span><span style=
"color: #a9a1e1;">)</span>,
    <span style=
"color: #c678dd;">createSimpleExpression</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #98be65;">`return _item`</span><span style=
"color: #a9a1e1;">)</span>
  <span style="color: #98be65;">]</span><span style=
"color: #c678dd;">)</span>
  renderExp.<span style=
"color: #a9a1e1;">arguments</span>.<span style=
"color: #c678dd;">push</span><span style="color: #c678dd;">(</span>
    loop <span style=
"color: #51afef;">as</span> ForIteratorExpression,
    <span style=
"color: #c678dd;">createSimpleExpression</span><span style=
"color: #98be65;">(</span><span style=
"color: #98be65;">`_cache`</span><span style=
"color: #98be65;">)</span>,
    <span style=
"color: #c678dd;">createSimpleExpression</span><span style=
"color: #98be65;">(</span><span style=
"color: #c678dd;">String</span><span style=
"color: #a9a1e1;">(</span>context.cached++<span style=
"color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">)</span>
<span style="color: #51afef;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">{</span>
  renderExp.<span style=
"color: #a9a1e1;">arguments</span>.<span style=
"color: #c678dd;">push</span><span style=
"color: #c678dd;">(</span><span style=
"color: #c678dd;">createFunctionExpression</span><span style=
"color: #98be65;">(</span>
    <span style=
"color: #c678dd;">createForLoopParams</span><span style=
"color: #a9a1e1;">(</span>forNode.parseResult<span style=
"color: #a9a1e1;">)</span>,
    childBlock,
    <span style="color: #a9a1e1;">true</span> <span style=
"color: #5B6268;">/* </span><span style=
"color: #5B6268;">force newline */</span>
  <span style="color: #98be65;">)</span> <span style=
"color: #51afef;">as</span> ForIteratorExpression<span style=
"color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>如：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../compiler-core/dist/compiler-core.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style="color: #51afef;">const</span> { baseCompile } = value

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">compile</span> = c =&gt; baseCompile(<span style=
"color: #98be65;">`&lt;div&gt;${c}&lt;/div&gt;`</span>, {
  mode: <span style="color: #98be65;">"module"</span>,
  prefixIdentifiers: <span style="color: #a9a1e1;">true</span>
}).code

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">test</span>(<span style=
"color: #dcaeea;">title</span>, <span style=
"color: #dcaeea;">code</span>, <span style=
"color: #dcaeea;">options</span>) {
  console.log(<span style=
"color: #98be65;">'// &gt; '</span> + title)
  console.log(compile(code))
}

console.log(<span style=
"color: #98be65;">'// &gt; on root element'</span>)
console.log(  baseCompile(<span style=
"color: #98be65;">`&lt;div v-memo="[x]"&gt;&lt;/div&gt;`</span>, {
  mode: <span style="color: #98be65;">'module'</span>,
  prefixIdentifiers: <span style="color: #a9a1e1;">true</span>
}).code)

test(<span style=
"color: #98be65;">'on normal element'</span>, <span style=
"color: #98be65;">`&lt;div v-memo="[x]"&gt;&lt;/div&gt;`</span>)
test(<span style=
"color: #98be65;">'on template v-for'</span>, <span style=
"color: #98be65;">`&lt;template v-for="{ x, y } in list" :key="x" v-memo="[x, y === z]"&gt;</span>
<span style=
"color: #98be65;">          &lt;span&gt;foobar&lt;/span&gt;</span>
<span style="color: #98be65;">        &lt;/template&gt;`</span>)
<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>
</pre>
              </div>
              <p>_withMemo -&gt; <a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-core/src/helpers/withMemo.ts">
              runtime-core/src/helpers/withMemo.ts:withMemo</a></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">withMemo</span><span style=
                "color: #51afef;">(</span>
  memo: <span style="color: #51afef;">any</span><span style=
"color: #c678dd;">[]</span>,
  render: <span style="color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> VNode&lt;<span style=
"color: #51afef;">any</span>, <span style=
"color: #51afef;">any</span>&gt;,
  cache: <span style="color: #51afef;">any</span><span style=
"color: #c678dd;">[]</span>,
  index: <span style="color: #51afef;">number</span>
<span style="color: #51afef;">)</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">cached</span> = cache<span style=
"color: #c678dd;">[</span>index<span style=
"color: #c678dd;">]</span> <span style=
"color: #51afef;">as</span> VNode | <span style=
"color: #a9a1e1;">undefined</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>cached &amp;& <span style=
"color: #c678dd;">isMemoSame</span><span style=
"color: #98be65;">(</span>cached, memo<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> cached
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">ret</span> = <span style=
"color: #c678dd;">render</span><span style=
"color: #c678dd;">()</span>

  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">shallow clone</span>
  ret.memo = memo.<span style=
"color: #c678dd;">slice</span><span style=
"color: #c678dd;">()</span>
  <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">(</span>cache<span style=
"color: #98be65;">[</span>index<span style=
"color: #98be65;">]</span> = ret<span style=
"color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>判断不重新渲染条件(memo 长度和元素的值必须一致)：</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">isMemoSame</span><span style=
                "color: #51afef;">(</span><span style=
                "color: #dcaeea;">cached</span>: <span style=
                "color: #ECBE7B;">VNode</span>, <span style=
                "color: #dcaeea;">memo</span>: <span style=
                "color: #51afef;">any</span><span style=
                "color: #c678dd;">[]</span><span style=
                "color: #51afef;">)</span> <span style=
                "color: #51afef;">{</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">prev</span>: <span style=
"color: #51afef;">any</span><span style=
"color: #c678dd;">[]</span> = cached.memo!
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>prev.length != memo.length<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> <span style=
"color: #a9a1e1;">false</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">for</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>; i &lt; <span style=
"color: #ECBE7B;">prev</span>.<span style=
"color: #ECBE7B;">length</span>; <span style=
"color: #ECBE7B;">i</span>++<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>prev<span style=
"color: #a9a1e1;">[</span>i<span style=
"color: #a9a1e1;">]</span> !== memo<span style=
"color: #a9a1e1;">[</span>i<span style=
"color: #a9a1e1;">]</span><span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">return</span> <span style=
"color: #a9a1e1;">false</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">make sure to let parent block track it when returning cached</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>isBlockTreeEnabled &gt; <span style=
"color: #da8548; font-weight: bold;">0</span> &amp;& currentBlock<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    currentBlock.<span style=
"color: #c678dd;">push</span><span style=
"color: #98be65;">(</span>cached<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">return</span> <span style=
"color: #a9a1e1;">true</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>watchPostEffect (<a href=
              "https://github.com/vuejs/vue-next/commit/42ace9577da49477ff189950a83d6eead73d0efe">42ace95</a>)
              <span id="watchPostEffect"></span> <span id=
              "42ace95"></span></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">function</span> <span style=
                "color: #c678dd;">watchPostEffect</span><span style=
                "color: #51afef;">(</span>
  effect: <span style="color: #ECBE7B;">WatchEffect</span>,
  options?: <span style="color: #ECBE7B;">DebuggerOptions</span>
<span style="color: #51afef;">)</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">doWatch</span><span style=
"color: #c678dd;">(</span>effect, <span style=
"color: #a9a1e1;">null</span>, <span style=
"color: #98be65;">(</span>__DEV__
    ? Object.<span style=
"color: #c678dd;">assign</span><span style="color: #a9a1e1;">(</span>options || <span style="color: #51afef;">{}</span>, <span style="color: #51afef;">{</span> flush: <span style="color: #98be65;">'post'</span> <span style="color: #51afef;">}</span><span style="color: #a9a1e1;">)</span>
    : <span style="color: #a9a1e1;">{</span> flush: <span style=
"color: #98be65;">'post'</span> <span style=
"color: #a9a1e1;">}</span><span style=
"color: #98be65;">)</span> <span style=
"color: #51afef;">as</span> WatchOptionsBase<span style=
"color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js">(<span style=
                "color: #51afef;">async</span> <span style=
                "color: #51afef;">function</span> () {
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../runtime-test/dist/runtime-test.cjs.js'</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
  <span style="color: #51afef;">const</span> { render, ref,
          reactive, nextTick, serializeInner, h, nodeOps,
          watchPostEffect
        } = value

  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">count</span> = ref(<span style=
"color: #da8548; font-weight: bold;">0</span>)
  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">result</span>, <span style=
"color: #dcaeea;">n</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">assertion</span> = count =&gt; {
    result = serializeInner(root) === <span style=
"color: #98be65;">`${count}`</span>
    n++
  }

  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Comp</span> = {
    setup() {
      watchPostEffect(() =&gt; assertion(count.value))
      <span style=
"color: #51afef;">return</span> () =&gt; count.value
    }
  }

  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">root</span> = nodeOps.createElement(<span style=
"color: #98be65;">'div'</span>)
  <span style="color: #51afef;">try</span> {
    render(h(Comp), root)
  } <span style="color: #51afef;">catch</span>(e) {
    console.log(e.message);
  }
  console.log(<span style=
"color: #98be65;">'1. result = '</span> + result + <span style=
"color: #98be65;">', n = '</span> + n)

  count.value++

  <span style="color: #51afef;">await</span> nextTick()
  console.log(<span style=
"color: #98be65;">'\n2. result = '</span> + result + <span style=
"color: #98be65;">', n = '</span> + n)
}());
<span style="color: #51afef;">return</span> <span style=
"color: #98be65;">''</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: new effectScope API (<a href=
              "https://github.com/vuejs/vue-next/issues/2195">#2195</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/f5617fc3bb8fd33927b2567622ac4f8b43f9b5d5">f5617fc</a>)
              <span id="f5617fc"></span></p>
              <p>RFC: <a href=
              "https://github.com/vuejs/rfcs/pull/212">vuejs/rfcs#212</a></p>
              <p>新增的 APIs</p>
              <ol class="org-ol">
                <li>EffectScope (class)</li>
                <li>getCurrentScope</li>
                <li>onScopeDispose</li>
              </ol>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: support onTrack/onTrigger debug
              options for computed (<a href=
              "https://github.com/vuejs/vue-next/commit/5cea9a1d4e846f60515ef76ebab4800228645601">5cea9a1</a>)
              <span id="5cea9a1"></span></p>
              <p>支持 <b>DEV</b> 模式下分别在 track 和 trigger 的时候调用 onTrack
              和 onTrigger。</p>
              <p>onTrack -&gt; effect.ts:trackEffects:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">if</span> <span style=
                "color: #51afef;">(</span>shouldTrack<span style=
                "color: #51afef;">)</span> <span style=
                "color: #51afef;">{</span>
  dep.<span style="color: #c678dd;">add</span><span style=
"color: #c678dd;">(</span>activeEffect!<span style=
"color: #c678dd;">)</span>
  activeEffect!.deps.<span style=
"color: #c678dd;">push</span><span style=
"color: #c678dd;">(</span>dep<span style="color: #c678dd;">)</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>__DEV__ &amp;& activeEffect!.onTrack<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    activeEffect!.<span style=
"color: #c678dd;">onTrack</span><span style=
"color: #98be65;">(</span>
      Object.<span style=
"color: #c678dd;">assign</span><span style="color: #a9a1e1;">(</span>
        <span style="color: #51afef;">{</span>
          effect: activeEffect!
        <span style="color: #51afef;">}</span>,
        debuggerEventExtraInfo
      <span style="color: #a9a1e1;">)</span>
    <span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>onTrigger -&gt; effect.ts:triggerEffects:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">for</span> <span style=
                "color: #51afef;">(</span><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">effect</span> <span style=
                "color: #51afef;">of</span> <span style=
                "color: #c678dd;">isArray</span><span style=
                "color: #c678dd;">(</span>dep<span style=
                "color: #c678dd;">)</span> ? dep : <span style=
                "color: #c678dd;">[</span>...dep<span style=
                "color: #c678dd;">]</span><span style=
                "color: #51afef;">)</span> <span style=
                "color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>effect !== activeEffect || effect.allowRecurse<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>__DEV__ &amp;& effect.onTrigger<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      effect.<span style=
"color: #c678dd;">onTrigger</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #c678dd;">extend</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">{</span> effect <span style=
"color: #c678dd;">}</span>, debuggerEventExtraInfo<span style=
"color: #51afef;">)</span><span style="color: #a9a1e1;">)</span>
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>effect.scheduler<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      effect.<span style=
"color: #c678dd;">scheduler</span><span style=
"color: #a9a1e1;">()</span>
    <span style="color: #98be65;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #98be65;">{</span>
      effect.<span style="color: #c678dd;">run</span><span style=
"color: #a9a1e1;">()</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">onTrigger 参数： { effect } & DebuggerEventExtraInfo</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">type</span> <span style=
"color: #ECBE7B;">DebuggerEventExtraInfo</span> = <span style=
"color: #51afef;">{</span>
  target: <span style="color: #51afef;">object</span>
  <span style="color: #51afef;">type</span>: <span style=
"color: #ECBE7B;">TrackOpTypes</span> | TriggerOpTypes
  key: <span style="color: #51afef;">any</span>
  newValue?: <span style="color: #51afef;">any</span>
  oldValue?: <span style="color: #51afef;">any</span>
  oldTarget?: <span style=
"color: #ECBE7B;">Map</span>&lt;<span style=
"color: #51afef;">any</span>, <span style=
"color: #51afef;">any</span>&gt; | Set&lt;<span style=
"color: #51afef;">any</span>&gt;
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>使用：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../reactivity/dist/reactivity.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { reactive, effect, computed } = value

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">obj</span> = reactive({ foo: <span style=
"color: #da8548; font-weight: bold;">1</span> })
<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">onTrack</span>(<span style=
"color: #dcaeea;">eventInfo</span>) {
  console.log(<span style=
"color: #98be65;">'TrackEventArg='</span>, eventInfo);
}
<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">onTrigger</span>(<span style=
"color: #dcaeea;">eventInfo</span>) {
  console.log(<span style=
"color: #98be65;">'TriggerEventArg='</span>, eventInfo);
}
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">c</span> = computed(() =&gt; obj.foo, { onTrigger, onTrack })

c.value;
obj.foo++
console.log(<span style=
"color: #98be65;">'c.value = '</span> + c.value)
<span style="color: #51afef;">return</span> obj
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgc8003d5" class="outline-3">
        <h3 id="orgc8003d5"><span class=
        "section-number-3">14.4.</span> Performance improvements
        <code>[7/7]</code></h3>
        <div class="outline-text-3" id="text-14-4">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>also hoist all-static children array (<a href=
              "https://github.com/vuejs/vue-next/commit/b7ea7c148552874e8bce399eec9fbe565efa2f4d">b7ea7c1</a>)
              如果 children 里面都是静态节点直接将整个 children 数组提升:</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">const _hoisted_1 = /*#__PURE__*/_createElementVNode(\\"div\\", { key: \\"foo\\" }, null, -1 /* HOISTED */)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> const _hoisted_2 = [</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  _hoisted_1</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;"> ]</span>

<span style=
"color: #a4aab6;">return function render(_ctx, _cache) {</span>
<span style="color: #a4aab6;">  with (_ctx) {</span>
<span style=
"color: #a4aab6;">    const { createElementVNode: _createElementVNode, openBlock: _openBlock, createElementBlock: _createElementBlock } = _Vue</span>

<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    return (_openBlock(), _createElementBlock(\\"div\\", null, [</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      _hoisted_1</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    ]))</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    return (_openBlock(), _createElementBlock(\\"div\\", null, _hoisted_2))</span>
<span style="color: #a4aab6;">  }</span>
}"
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>hoist dynamic props lists (<a href=
              "https://github.com/vuejs/vue-next/commit/02339b67d8c6fab6ee701a7c4f2773139ed007f5">02339b6</a>)
              动态属性名列表提升：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #aa2222; background-color: #23272e;">-</span><span style=
                "color: #ff6c6b; background-color: #23272e;">      _createElementVNode(\\"div\\", { id: foo }, null, 8 /* PROPS */, [\\"id\\"])</span>
+      _createElementVNode(\\"div\\", { id: foo }, null, 8 /* PROPS */, _hoisted_1)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: avoid triggering re-render if computed
              value did not change (<a href=
              "https://github.com/vuejs/vue-next/commit/ebaac9a56d82d266e333d077b6457543d7cab9ae">ebaac9a</a>)
              trigger computed value 之前先检查下值有没改变。</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">if</span> <span style=
                "color: #51afef;">(</span><span style=
                "color: #51afef;">this</span>._dirty<span style=
                "color: #51afef;">)</span> <span style=
                "color: #51afef;">{</span>
  <span style="color: #51afef;">this</span>._dirty = <span style=
"color: #a9a1e1;">false</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">newValue</span> = <span style=
"color: #51afef;">this</span>.effect.<span style=
"color: #c678dd;">run</span><span style=
"color: #c678dd;">()</span>!
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #51afef;">this</span>._value !== newValue<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">this</span>._value = newValue
    <span style=
"color: #c678dd;">triggerRefValue</span><span style="color: #98be65;">(</span><span style="color: #a9a1e1;">this</span><span style="color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">{</span>
  <span style="color: #c678dd;">triggerRefValue</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
<span style="color: #51afef;">}</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: improve reactive effect memory usage
              (<a href=
              "https://github.com/vuejs/vue-next/issues/4001">#4001</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/87f69fd0bb67508337fb95cb98135fd5d6ebca7d">87f69fd</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2345">#2345</a>
              <span id="87f69fd"></span></p>
              <p>改动点：</p>
              <ol class="org-ol">
                <li>
                  <p>ReactiveEffect 改用 class 来实现(stop, run 都在这个
                  class 里面实现)</p>
                  <div class="org-src-container">
                    <pre class="src src-typescript"><span style=
                    "color: #51afef;">export</span> <span style=
                    "color: #51afef;">class</span> <span style=
                    "color: #ECBE7B;">ReactiveEffect</span>&lt;<span style=
                    "color: #ECBE7B;">T</span> = <span style=
                    "color: #51afef;">any</span>&gt; <span style=
                    "color: #51afef;">{</span>
  active = <span style="color: #a9a1e1;">true</span>
  deps: <span style="color: #ECBE7B;">Dep</span><span style=
"color: #c678dd;">[]</span> = <span style=
"color: #c678dd;">[]</span>

  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">can be attached after creation</span>
  computed?: <span style="color: #51afef;">boolean</span>
  allowRecurse?: <span style="color: #51afef;">boolean</span>
  onStop?: <span style="color: #c678dd;">()</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">void</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">dev only</span>
  onTrack?: <span style=
"color: #c678dd;">(</span>event: <span style=
"color: #ECBE7B;">DebuggerEvent</span><span style=
"color: #c678dd;">)</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">void</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">dev only</span>
  onTrigger?: <span style=
"color: #c678dd;">(</span>event: <span style=
"color: #ECBE7B;">DebuggerEvent</span><span style=
"color: #c678dd;">)</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">void</span>

  <span style="color: #51afef;">constructor</span><span style=
"color: #c678dd;">(</span>
    <span style="color: #51afef;">public</span> fn: <span style=
"color: #98be65;">()</span> <span style=
"color: #51afef;">=&gt;</span> T,
    <span style=
"color: #51afef;">public</span> scheduler: <span style=
"color: #ECBE7B;">EffectScheduler</span> | <span style=
"color: #a9a1e1;">null</span> = <span style=
"color: #a9a1e1;">null</span>,
    scope?: <span style=
"color: #ECBE7B;">EffectScope</span> | <span style=
"color: #a9a1e1;">null</span>
  <span style="color: #c678dd;">)</span> <span style=
"color: #c678dd;">{</span>
    <span style=
"color: #c678dd;">recordEffectScope</span><span style=
"color: #98be65;">(</span><span style=
"color: #a9a1e1;">this</span>, scope<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #c678dd;">run</span><span style=
"color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>!<span style=
"color: #51afef;">this</span>.active<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">return</span> <span style=
"color: #51afef;">this</span>.<span style=
"color: #c678dd;">fn</span><span style="color: #a9a1e1;">()</span>
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span>!effectStack.<span style=
"color: #c678dd;">includes</span><span style=
"color: #a9a1e1;">(</span><span style=
"color: #a9a1e1;">this</span><span style=
"color: #a9a1e1;">)</span><span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">try</span> <span style=
"color: #a9a1e1;">{</span>
        effectStack.<span style=
"color: #c678dd;">push</span><span style=
"color: #51afef;">(</span><span style=
"color: #c678dd;">(</span>activeEffect = <span style=
"color: #a9a1e1;">this</span><span style=
"color: #c678dd;">)</span><span style="color: #51afef;">)</span>
        <span style=
"color: #c678dd;">enableTracking</span><span style=
"color: #51afef;">()</span>

        trackOpBit = <span style=
"color: #da8548; font-weight: bold;">1</span> &lt;&lt; ++effectTrackDepth

        <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>effectTrackDepth &lt;= maxMarkerBits<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
          <span style=
"color: #c678dd;">initDepMarkers</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">}</span> <span style=
"color: #51afef;">else</span> <span style=
"color: #51afef;">{</span>
          <span style=
"color: #c678dd;">cleanupEffect</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">}</span>
        <span style="color: #51afef;">return</span> <span style=
"color: #51afef;">this</span>.<span style=
"color: #c678dd;">fn</span><span style="color: #51afef;">()</span>
      <span style="color: #a9a1e1;">}</span> <span style=
"color: #51afef;">finally</span> <span style=
"color: #a9a1e1;">{</span>
        <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>effectTrackDepth &lt;= maxMarkerBits<span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
          <span style=
"color: #c678dd;">finalizeDepMarkers</span><span style=
"color: #c678dd;">(</span><span style=
"color: #a9a1e1;">this</span><span style="color: #c678dd;">)</span>
        <span style="color: #51afef;">}</span>

        trackOpBit = <span style=
"color: #da8548; font-weight: bold;">1</span> &lt;&lt; --effectTrackDepth

        <span style=
"color: #c678dd;">resetTracking</span><span style=
"color: #51afef;">()</span>
        effectStack.<span style=
"color: #c678dd;">pop</span><span style="color: #51afef;">()</span>
        <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">n</span> = effectStack.length
        activeEffect = n &gt; <span style=
"color: #da8548; font-weight: bold;">0</span> ? effectStack<span style="color: #51afef;">[</span>n - <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #51afef;">]</span> : <span style="color: #a9a1e1;">undefined</span>
      <span style="color: #a9a1e1;">}</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #c678dd;">stop</span><span style=
"color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">if</span> <span style=
"color: #98be65;">(</span><span style=
"color: #51afef;">this</span>.active<span style=
"color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style=
"color: #c678dd;">cleanupEffect</span><span style="color: #a9a1e1;">(</span><span style="color: #a9a1e1;">this</span><span style="color: #a9a1e1;">)</span>
      <span style="color: #51afef;">if</span> <span style=
"color: #a9a1e1;">(</span><span style=
"color: #51afef;">this</span>.onStop<span style=
"color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span>
        <span style="color: #51afef;">this</span>.<span style=
"color: #c678dd;">onStop</span><span style=
"color: #51afef;">()</span>
      <span style="color: #a9a1e1;">}</span>
      <span style=
"color: #51afef;">this</span>.active = <span style=
"color: #a9a1e1;">false</span>
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
                  </div>
                </li>
                <li>effect 通过 <code>new ReactiveEffect()</code> 创建,
                收集的依赖通过 <code>_effect.run()</code> 执行。</li>
              </ol>
            </li>
            <li class="on">
              <code>[X]</code> reactivity: ref-specific
              track/trigger and miscellaneous optimizations
              (<a href=
              "https://github.com/vuejs/vue-next/issues/3995">#3995</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/64310405acaccabc24985ade95fb1b5c9c06ef76">6431040</a>)
              <span id="6431040"></span>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>reactivity: use bitwise dep markers to optimize
              re-tracking (<a href=
              "https://github.com/vuejs/vue-next/issues/4017">#4017</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/6cf2377cd49d24814bdff136bf78c77d50d5b41a">6cf2377</a>)
              <span id="6cf2377"></span></p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../reactivity/dist/reactivity.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { reactive, effect, targetMap, toRaw } = value


console.log(<span style=
"color: #98be65;">'&gt; should handle deep effect recursion using cleanup fallback'</span>);
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">results</span> = reactive([<span style=
"color: #da8548; font-weight: bold;">0</span>])
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">effects</span> = []
<span style="color: #51afef;">for</span> (<span style=
"color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">1</span>; i &lt; <span style=
"color: #da8548; font-weight: bold;">40</span>;i++) {
  ;(index =&gt; {
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">fx</span> = effect(() =&gt; {
      results[index] = results[index - <span style=
"color: #da8548; font-weight: bold;">1</span>] * <span style=
"color: #da8548; font-weight: bold;">2</span>
    })
    effects.push({ fx, index })
  })(i)
}

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">targetMap.forEach((key, value) =&gt; console.log({ key, value }))</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">console.log(toRaw(results).join(','), targetMap.get(toRaw(results)), 'xx');</span>
console.log((<span style=
"color: #98be65;">'results[39] = '</span> + results[<span style=
"color: #da8548; font-weight: bold;">39</span>]));
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">deps</span> = targetMap.get(toRaw(results))
<span style="color: #51afef;">for</span> (<span style=
"color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>; i &lt; <span style=
"color: #da8548; font-weight: bold;">40</span>; i++) {
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">dep</span> = deps.get(<span style=
"color: #98be65;">''</span> + i)
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">dep &amp;& console.log(i + 1 + ": " + "n(newTracked): " + dep.n +', w(wasTracked): ' + dep.w);</span>
}
results[<span style=
"color: #da8548; font-weight: bold;">0</span>] = <span style=
"color: #da8548; font-weight: bold;">1</span>
console.log((<span style=
"color: #98be65;">'results[39] = 2^39, '</span> + (results[<span style="color: #da8548; font-weight: bold;">39</span>] === Math.pow(<span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">39</span>))));

<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>improve VNode creation performance with compiler
              hints (<a href=
              "https://github.com/vuejs/vue-next/issues/3334">#3334</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ceff89905b05381d3d73c480e08c7aff9271b074">ceff899</a>)
              <span id="ceff899"></span></p>
              <p>区分 element 和 component 创建过程，新增两个针对性的函数，分别用来创建
              element(<code>createElementVNode</code>) 和
              component(<code>createComponentVNode</code>)，减少部分检查的
              工作，总的来说优化创建 element 和 component 的过程。</p>
              <p>compiler-core:codegen 阶段 element 由
              <code>_createVNode</code> 改成
              <code>_createElementVNode</code>,
              <code>_createBlock</code> 改成
              <code>_createElementBlock</code></p>
              <p>增加的 helpers: <code>CREATE_VNODE</code> -&gt;
              <code>CREATE_ELEMENT_VNODE</code></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #51afef;">export</span> <span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">CREATE_ELEMENT_BLOCK</span> = <span style=
                "color: #c678dd;">Symbol</span><span style=
                "color: #51afef;">(</span>__DEV__ ? <span style=
                "color: #98be65;">`createElementBlock`</span> : <span style=
                "color: #98be65;">``</span><span style=
                "color: #51afef;">)</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">CREATE_ELEMENT_VNODE</span> = <span style=
"color: #c678dd;">Symbol</span><span style=
"color: #51afef;">(</span>__DEV__ ? <span style=
"color: #98be65;">`createElementVNode`</span> : <span style=
"color: #98be65;">``</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">NORMALIZE_CLASS</span> = <span style=
"color: #c678dd;">Symbol</span><span style=
"color: #51afef;">(</span>__DEV__ ? <span style=
"color: #98be65;">`normalizeClass`</span> : <span style=
"color: #98be65;">``</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">NORMALIZE_STYLE</span> = <span style=
"color: #c678dd;">Symbol</span><span style=
"color: #51afef;">(</span>__DEV__ ? <span style=
"color: #98be65;">`normalizeStyle`</span> : <span style=
"color: #98be65;">``</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">NORMALIZE_PROPS</span> = <span style=
"color: #c678dd;">Symbol</span><span style=
"color: #51afef;">(</span>__DEV__ ? <span style=
"color: #98be65;">`normalizeProps`</span> : <span style=
"color: #98be65;">``</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">const</span> <span style=
"color: #dcaeea;">GUARD_REACTIVE_PROPS</span> = <span style=
"color: #c678dd;">Symbol</span><span style=
"color: #51afef;">(</span>__DEV__ ? <span style=
"color: #98be65;">`guardReactiveProps`</span> : <span style=
"color: #98be65;">``</span><span style="color: #51afef;">)</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">compiler-core/src/utils.ts</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">getVNodeHelper</span><span style=
"color: #51afef;">(</span><span style=
"color: #dcaeea;">ssr</span>: <span style=
"color: #51afef;">boolean</span>, <span style=
"color: #dcaeea;">isComponent</span>: <span style=
"color: #51afef;">boolean</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style=
"color: #51afef;">return</span> ssr || isComponent ? CREATE_VNODE : <span style="color: #ECBE7B;">CREATE</span>_ELEMENT_VNODE
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">getVNodeBlockHelper</span><span style=
"color: #51afef;">(</span><span style=
"color: #dcaeea;">ssr</span>: <span style=
"color: #51afef;">boolean</span>, <span style=
"color: #dcaeea;">isComponent</span>: <span style=
"color: #51afef;">boolean</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style=
"color: #51afef;">return</span> ssr || isComponent ? CREATE_BLOCK : <span style="color: #ECBE7B;">CREATE</span>_ELEMENT_BLOCK
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">runtime-core/src/vnode.ts</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">guardReactiveProps</span><span style=
"color: #51afef;">(</span><span style=
"color: #dcaeea;">props</span>: <span style=
"color: #c678dd;">(</span><span style=
"color: #dcaeea;">Data</span> & <span style=
"color: #dcaeea;">VNodeProps</span><span style=
"color: #c678dd;">)</span> | <span style=
"color: #a9a1e1;">null</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>!props<span style=
"color: #c678dd;">)</span> <span style=
"color: #51afef;">return</span> <span style=
"color: #a9a1e1;">null</span>
  <span style="color: #51afef;">return</span> <span style=
"color: #c678dd;">isProxy</span><span style=
"color: #c678dd;">(</span>props<span style=
"color: #c678dd;">)</span> || InternalObjectKey <span style=
"color: #51afef;">in</span> props
    ? <span style="color: #c678dd;">extend</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">{}</span>, props<span style=
"color: #c678dd;">)</span>
    : props
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">shared/src/normalizeProp.ts</span>
<span style="color: #51afef;">export</span> <span style=
"color: #51afef;">function</span> <span style=
"color: #c678dd;">normalizeProps</span><span style=
"color: #51afef;">(</span><span style=
"color: #dcaeea;">props</span>: <span style=
"color: #ECBE7B;">Record</span>&lt;<span style=
"color: #51afef;">string</span>, <span style=
"color: #51afef;">any</span>&gt; | <span style=
"color: #a9a1e1;">null</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>!props<span style=
"color: #c678dd;">)</span> <span style=
"color: #51afef;">return</span> <span style=
"color: #a9a1e1;">null</span>
  <span style="color: #51afef;">let</span> <span style=
"color: #c678dd;">{</span> <span style=
"color: #51afef;">class</span>: klass, style <span style=
"color: #c678dd;">}</span> = props
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>klass &amp;& !<span style=
"color: #c678dd;">isString</span><span style=
"color: #98be65;">(</span>klass<span style=
"color: #98be65;">)</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    props.<span style="color: #51afef;">class</span> = <span style=
"color: #c678dd;">normalizeClass</span><span style=
"color: #98be65;">(</span>klass<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #c678dd;">(</span>style<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    props.style = <span style=
"color: #c678dd;">normalizeStyle</span><span style=
"color: #98be65;">(</span>style<span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">return</span> props
<span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../compiler-core/dist/compiler-core.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { generate, createSimpleExpression, locStub,
        createVNodeCall, createObjectExpression,
        createObjectProperty,
        createCompoundExpression,
        createArrayExpression
      } = value

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">createRoot</span>(<span style=
"color: #dcaeea;">options</span>) {
  <span style="color: #51afef;">return</span> {
    type: <span style=
"color: #da8548; font-weight: bold;">0</span><span style=
"color: #5B6268;">/* </span><span style=
"color: #5B6268;">ROOT</span><span style=
"color: #5B6268;"> */</span>,
    children: [],
    helpers: [],
    components: [],
    directives: [],
    imports: [],
    hoists: [],
    cached: <span style=
"color: #da8548; font-weight: bold;">0</span>,
    temps: <span style=
"color: #da8548; font-weight: bold;">0</span>,
    codegenNode: createSimpleExpression(<span style=
"color: #98be65;">`null`</span>, <span style=
"color: #a9a1e1;">false</span>),
    loc: locStub,
    ...options
  }
}

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">genCode</span>(<span style=
"color: #dcaeea;">node</span>) {
  <span style="color: #51afef;">return</span> generate(
    createRoot({
      codegenNode: node
    })
  ).code.match(<span style=
"color: #98be65;">/with \(_ctx\) \{\s+([^]+)\s+\}\s+\}$/</span>)[<span style="color: #da8548; font-weight: bold;">1</span>]
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">mockChildren</span> = createCompoundExpression([<span style="color: #98be65;">'children'</span>])
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">mockDirs</span> = createArrayExpression([
  createArrayExpression([<span style=
"color: #98be65;">`foo`</span>, createSimpleExpression(<span style=
"color: #98be65;">`bar`</span>, <span style=
"color: #a9a1e1;">false</span>)])
])

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">mockProps</span> = createObjectExpression([
  createObjectProperty(<span style=
"color: #98be65;">`foo`</span>, createSimpleExpression(<span style=
"color: #98be65;">`bar`</span>, <span style=
"color: #a9a1e1;">true</span>))
])

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">test</span> = (title, ...args) =&gt; console.log(<span style="color: #98be65;">'&gt; '</span> + title + <span style="color: #98be65;">'\n'</span>, <span style="color: #98be65;">"'"</span> + genCode( createVNodeCall(...args) ) + <span style="color: #98be65;">"'"</span>)

test(<span style="color: #98be65;">'tag only'</span>, <span style=
"color: #a9a1e1;">null</span>, <span style=
"color: #98be65;">'"div"'</span>)
test(<span style=
"color: #98be65;">'with props'</span>, <span style="color: #a9a1e1;">null</span>, <span style="color: #98be65;">'"div"'</span>, mockProps)
test(<span style=
"color: #98be65;">'with children, no props'</span>, <span style=
"color: #a9a1e1;">null</span>, <span style=
"color: #98be65;">'"div"'</span>, <span style=
"color: #a9a1e1;">undefined</span>, mockChildren)
test(<span style=
"color: #98be65;">'with children + props'</span>, <span style=
"color: #a9a1e1;">null</span>, <span style=
"color: #98be65;">'"div"'</span>, mockProps, mockChildren)
test(<span style="color: #98be65;">'as block'</span>, <span style=
"color: #a9a1e1;">null</span>, <span style=
"color: #98be65;">'"dv"'</span>, mockProps, mockChildren, <span style="color: #a9a1e1;">undefined</span>, <span style="color: #a9a1e1;">undefined</span>, <span style="color: #a9a1e1;">undefined</span>, <span style="color: #a9a1e1;">true</span>)
<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgdd6e60a" class="outline-3">
        <h3 id="orgdd6e60a"><span class=
        "section-number-3">14.5.</span> Breaking Changes
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-14-5">
          <ul class="org-ul">
            <li class="on"><code>[X]</code> Output of SFC using
            &lt;style scoped&gt; generated by 3.2+ will be
            incompatible w/ runtime &lt; 3.2.</li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org4ecc333" class="outline-2">
      <h2 id="org4ecc333"><span class="section-number-2">15.</span>
      小结</h2>
      <div class="outline-text-2" id="text-15">
        <p>3.2 更新重点摘要：</p>
        <ol class="org-ol">
          <li><code>v-memo</code> 组件更新条件设置。</li>
          <li><code>$ref()</code> SFC setup 中的新语法糖。</li>
          <li><code>MutationObserver</code> 解决 cssVar + transition
          + v-if 无效问题。</li>
          <li><code>ReactiveEffect</code> 重构成了 class 实现，effect
          不再是函数，而是其实例对象。</li>
        </ol>
      </div>
    </div>
    <div id="outline-container-org8eabcc9" class="outline-2">
      <h2 id="org8eabcc9"><span class="section-number-2">16.</span>
      3.0.8</h2>
      <div class="outline-text-2" id="text-16">
        <ol class="org-ol">
          <li>
            <b><span style="color:yellow;">IMP</span></b>: SFC
            style 中的 <code>::v-slotted</code> 和
            <code>:slotted</code> <a class="anchor" aria-hidden=
            "true" id="slotted" href="#slotted"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ol>
      </div>
      <div id="outline-container-org428a861" class="outline-3">
        <h3 id="org428a861"><span class=
        "section-number-3">16.1.</span> <span class=
        "done DONE">DONE</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-16-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>support only attaching slot scope ids when
              necessary (<a href=
              "https://github.com/vuejs/vue-next/commit/02cbbb718ca226b087c42e6f132120931307c2a6">02cbbb7</a>)
              <span id="slotted"></span></p>
              <p>SFC style 中使用</p>
              <p><code>:slotted(h1) { color: blue; }</code></p>
              <p>或</p>
              <p><code>::v-slotted(h1) { color: blue; }</code></p>
              <p>可以在当前组件中控制 slot 组件的样式。</p>
              <p><a href=
              "https://codesandbox.io/s/damp-cdn-k9eed?file=/src/main.js">
              https://codesandbox.io/s/damp-cdn-k9eed?file=/src/main.js</a></p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> =
      process.env.VNEXT_PKG_RC + <span style=
"color: #98be65;">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">"stb-"</span>, <span style=
"color: #98be65;">""</span>));
<span style=
"color: #51afef;">const</span> { compileScript, parse, compileStyle } = value;

<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">compileScoped</span>(<span style=
"color: #dcaeea;">source</span>, <span style=
"color: #dcaeea;">options</span>) {
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">res</span> = compileStyle({
    source,
    filename: <span style="color: #98be65;">'test.css'</span>,
    id: <span style="color: #98be65;">'data-v-test'</span>,
    scoped: <span style="color: #a9a1e1;">true</span>,
    ...options
  })
  <span style="color: #51afef;">return</span> res.code
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">src</span> = <span style=
"color: #98be65;">`::v-slotted(h1) { color: red; } :slotted(h1) {font-size:12px;}`</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">code</span> = compileScoped(src)
console.log(code)
<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>;
</pre>
              </div>
              <p>下面会检查 style 中是不是含 <code>::v-slotted(...)
              {...}</code> 或 <code>:slotted(...) {..}</code> 指令</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #5B6268;">// </span><span style=
                "color: #5B6268;">packages/compiler-sfc/src/parse.ts</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">check if the SFC uses :slotted</span>
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">slottedRE</span> = <span style=
"color: #98be65;">/(?:::v-|:)slotted\(/</span>
  descriptor.slotted = descriptor.styles.<span style=
"color: #c678dd;">some</span><span style=
"color: #51afef;">(</span>s <span style=
"color: #51afef;">=&gt;</span> slottedRE.<span style=
"color: #c678dd;">test</span><span style=
"color: #c678dd;">(</span>s.content<span style=
"color: #c678dd;">)</span><span style="color: #51afef;">)</span>
</pre>
              </div>
              <p>根据上面的结果，在 parse SFC template 阶段给组件加上
              <code>scope-id-s</code> 属性， 如：</p>
              <p><code>&lt;div scope-id-s /&gt;</code></p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #5B6268;">// </span><span style=
                "color: #5B6268;">packages/compiler-ssr/src/transforms/ssrTransformSlotOutlet.ts</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">inject slot scope id if current template uses :slotted</span>
  <span style="color: #51afef;">if</span> <span style=
"color: #51afef;">(</span>context.scopeId &amp;& context.slotted !== <span style="color: #a9a1e1;">false</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    args.<span style="color: #c678dd;">push</span><span style=
"color: #c678dd;">(</span><span style=
"color: #98be65;">`"${context.scopeId}-s"`</span><span style=
"color: #c678dd;">)</span>
  <span style="color: #51afef;">}</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org53ba78e" class="outline-2">
      <h2 id="org53ba78e"><span class="section-number-2">17.</span>
      3.0.7</h2>
      <div class="outline-text-2" id="text-17">
        <ol class="org-ol">
          <li>
            <b><span style="color:red;">FIX</span></b>:
            <code>&lt;script setup&gt;</code> 中 export default 和
            class 语法 <a class="anchor" aria-hidden="true" id=
            "default-rewrite" href="#default-rewrite"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a> 。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>:
            <abbr class="tooltip" title=
            "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
            v-show</abbr> 的优先级比 <code>{style: { display: 'block'
            }}</code> 更高 <a class="anchor" aria-hidden="true" id=
            "v-show-priority" href="#v-show-priority"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: scheduler 中
            组件更新任务总是保持以 <code>job.id</code> 的增序执行，在插入的时候找到 对应的索引插入
            <a class="anchor" aria-hidden="true" id="job-id-as"
            href="#job-id-as"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ol>
      </div>
      <div id="outline-container-orgb985cd9" class="outline-3">
        <h3 id="orgb985cd9"><span class=
        "section-number-3">17.1.</span> <span class=
        "done DONE">DONE</span> Bug Fixes <code>[6/6]</code></h3>
        <div class="outline-text-3" id="text-17-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: handle more edge cases in default
              rewrite (1dedc19) <span id=
              "default-rewrite"></span></p>
              <p>处理 setup script 中更多语法情况：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> =
  process.env.VNEXT_PKG_RC + <span style=
"color: #98be65;">"/../compiler-sfc/dist/compiler-sfc.cjs.js"</span>;
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">"stb-"</span>, <span style=
"color: #98be65;">""</span>));
<span style=
"color: #51afef;">const</span> { rewriteDefault } = value;

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">test</span> = (hint, code) =&gt; {
  console.log(<span style=
"color: #98be65;">'&gt; '</span> + hint + <span style=
"color: #98be65;">'\n'</span>);
  console.log(rewriteDefault(code, <span style=
"color: #98be65;">'script'</span>))
}

test(<span style=
"color: #98be65;">'1. comments'</span>, <span style=
"color: #98be65;">`// export default\nexport default {}`</span>)
test(<span style=
"color: #98be65;">'2. export default class'</span>, <span style=
"color: #98be65;">`export default class Foo {}`</span>)
test(<span style=
"color: #98be65;">'3. export default class + commons'</span>, <span style="color: #98be65;">`// export default\nexport default class Foo {}`</span>)
test(<span style=
"color: #98be65;">'4. export default class + comments 2'</span>,  <span style="color: #98be65;">`export default {}\n`</span> + <span style="color: #98be65;">`// export default class Foo {}`</span>)
test(<span style=
"color: #98be65;">'5. export default class + comments 3'</span>, <span style="color: #98be65;">`/*\nexport default class Foo {}*/\n`</span> + <span style="color: #98be65;">`export default class Bar {}`</span>)
console.log(<span style=
"color: #98be65;">'------ end ------ '</span>);

<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>;
</pre>
              </div>
              <p><span style="color:blue;">+RESULTS</span>:</p>
              <pre class="example" id="org60f88ef">
  &gt; 1. comments

  // export default
  const script = {}
  &gt; 2. export default class

  class Foo {}
  const script = Foo
  &gt; 3. export default class + commons

  // export default
  class Foo {}
  const script = Foo
  &gt; 4. export default class + comments 2

  const script = {}
  // export default class Foo {}
  &gt; 5. export default class + comments 3

  /*
  export default class Foo {}*/
  const script = class Bar {}
  ------ end ------
  0
</pre>
            </li>
            <li class="on"><code>[X]</code> deps: pin Rollup to
            2.38 (34f354b), closes #3332</li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: properties in methods should be
              writable and enumerable in DEV (#3301) (e3568ba),
              closes #3300</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> 3  packages/runtime-core/src/componentOptions.ts</span>
<span style=
"color: #a9a1e1;">@@ -610,7 +610,8 @@</span><span style="color: #46D9FF;"> export function applyOptions(</span>
<span style=
"color: #a4aab6;">          Object.defineProperty(ctx, key, {</span>
<span style=
"color: #a4aab6;">            value: methodHandler.bind(publicThis),</span>
<span style=
"color: #a4aab6;">            configurable: true,</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">            enumerable: </span><span style="color: #ff6c6b; background-color: #23272e;">false</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">            enumerable: </span><span style="color: #98be65; background-color: #21242b;">true,</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">            writable: true</span>
<span style="color: #a4aab6;">          })</span>
<span style="color: #a4aab6;">        } else {</span>
          ctx[key] = methodHandler.bind(publicThis)
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>scheduler: ensure updates are always inserted in
              ascending id order (<a href=
              "https://github.com/vuejs/vue-next/issues/3184">#3184</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/45fae9d308e8cb9fe3304d4ca03c373ce63b2e62">45fae9d</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2768">#2768</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/2829">#2829</a>
              <span id="job-id-as"></span></p>
              <p><a href=
              "https://codesandbox.io/s/lucid-wind-c4jky?file=/src/App.vue">
              View isn’t updated in a weird case (combination of
              many factors, transition, injection &
              computed)</a></p>
              <p>确保 updates 总是以升序被插入，那么在插入之前就得找到适当的 job 索引:</p>
              <div class="org-src-container">
                <pre class="src src-typescript"><span style=
                "color: #5B6268;">// </span><span style=
                "color: #5B6268;">#2768</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">Use binary-search to find a suitable position in the queue,</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">so that the queue maintains the increasing order of job's id,</span>
<span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">which can prevent the job from being skipped and also can avoid repeated patching.</span>
<span style="color: #51afef;">function</span> <span style=
"color: #c678dd;">findInsertionIndex</span><span style=
"color: #51afef;">(</span><span style=
"color: #dcaeea;">job</span>: <span style=
"color: #ECBE7B;">SchedulerJob</span><span style=
"color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">the start index should be `flushIndex + 1`</span>
  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">start</span> = flushIndex + <span style=
"color: #da8548; font-weight: bold;">1</span>
  <span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">end</span> = queue.length
  <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">jobId</span> = <span style=
"color: #c678dd;">getId</span><span style=
"color: #c678dd;">(</span>job<span style="color: #c678dd;">)</span>

  <span style="color: #51afef;">while</span> <span style=
"color: #c678dd;">(</span>start &lt; <span style=
"color: #ECBE7B;">end</span><span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">middle</span> = <span style=
"color: #98be65;">(</span>start + end<span style=
"color: #98be65;">)</span> &gt;&gt;&gt; <span style=
"color: #da8548; font-weight: bold;">1</span>
    <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">middleJobId</span> = <span style=
"color: #c678dd;">getId</span><span style=
"color: #98be65;">(</span>queue<span style=
"color: #a9a1e1;">[</span>middle<span style=
"color: #a9a1e1;">]</span><span style="color: #98be65;">)</span>
    middleJobId &lt; <span style=
"color: #ECBE7B;">jobId</span> ? <span style=
"color: #98be65;">(</span><span style=
"color: #ECBE7B;">start</span> = <span style=
"color: #ECBE7B;">middle</span> + <span style=
"color: #da8548; font-weight: bold;">1</span><span style=
"color: #98be65;">)</span> : <span style=
"color: #98be65;">(</span><span style=
"color: #ECBE7B;">end</span> = <span style=
"color: #ECBE7B;">middle</span><span style=
"color: #98be65;">)</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #51afef;">return</span> start
<span style="color: #51afef;">}</span>


</pre>
              </div>
              <p>在 update 进入任务队列的时候保证所有 jobs 是以升序排列</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">export function queueJob(job: SchedulerJob) {</span>
<span style=
"color: #a4aab6;">  // the dedupe search uses the startIndex argument of Array.includes()</span>
<span style=
"color: #a4aab6;">  // by default the search index includes the current job that is being run</span>
<span style="color: #a9a1e1;">@@ -72,7 +91,12 @@</span><span style=
"color: #46D9FF;"> export function queueJob(job: SchedulerJob) {</span>
<span style="color: #a4aab6;">      )) &amp;&</span>
<span style=
"color: #a4aab6;">    job !== currentPreFlushParentJob</span>
<span style="color: #a4aab6;">  ) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">    queue.push(job)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    const pos = findInsertionIndex(job)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    if (pos &gt; -1) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      queue.splice(pos, 0, job)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    } else {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      queue.push(job)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    }</span>
<span style="color: #a4aab6;">    queueFlush()</span>
<span style="color: #a4aab6;">  }</span>
}
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p><abbr class="tooltip" title=
              "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
              v-show</abbr> takes higher priority than style
              attribute (<a href=
              "https://github.com/vuejs/vue-next/issues/3230">#3230</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/5ad4036e29f75dc907e95b99a63325b855332566">5ad4036</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2757">#2757</a>
              <span id="v-show-priority"></span></p>
              <p><abbr class="tooltip" title=
              "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
              v-show</abbr> 也是通过 el.style.<a href=
              "https://developer.mozilla.org/en-US/docs/Web/CSS/display">display</a>
              来实现的，这里意思是如果 style 属性中也有 display 的话，在 <a href=
              "https://github.com/vuejs/vue-next/tree/master/packages/runtime-dom/src/modules/style.ts">
              runtime-dom/src/modules/style.ts</a> 中 patch 的时候应该
              <abbr class="tooltip" title=
              "Toggle the element's visibility based on the truthy-ness of the expression&lt;br&gt;value.&lt;br&gt;&lt;br&gt;Expects: &lt;strong&gt;any&lt;/strong&gt;&lt;br&gt;&lt;br&gt;Details&lt;br&gt;&lt;br&gt;&lt;strong&gt;v-show&lt;/strong&gt; works by setting the red:display CSS property via inline styles, and will try&lt;br&gt;to respect the initial display value when the element is visible. It also&lt;br&gt;triggers transitions when its condition changes.&lt;br&gt;&lt;br&gt;See also: Conditional Rendering - v-show (https://vuejs.org/guide/essentials/conditional.html#v-show)">
              v-show</abbr> 的优先级更高。</p>
            </li>
            <li class="on">
              <code>[X]</code> init devtools after feature flag
              checks (<a href=
              "https://github.com/vuejs/vue-next/commit/d0ea74556f74d8c503ffb7b70f41cbe2ce14db98">d0ea745</a>)
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org25b8bf2" class="outline-3">
        <h3 id="org25b8bf2"><span class=
        "section-number-3">17.2.</span> <span class=
        "done DONE">DONE</span> Performance Improvements
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-17-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>reactivity: only call Set.add if doesn’t already
              have value (<a href=
              "https://github.com/vuejs/vue-next/issues/3307">#3307</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/9cd988342cfa32ddd9479585244eb317d74c9712">9cd9883</a>)</p>
              <p>对于 Set key-value 都是值，所以当有这个 value 的时候再添加就没有什么意义了，
              Set 又是不重复集合。</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/reactivity/src/collectionHandlers.ts</span>
<span style="color: #a9a1e1;">@@ -76,8 +76,8 @@</span><span style=
"color: #46D9FF;"> function add(this: SetTypes, value: unknown) {</span>
<span style="color: #a4aab6;">  const target = toRaw(this)</span>
<span style=
"color: #a4aab6;">  const proto = getProto(target)</span>
<span style=
"color: #a4aab6;">  const hadKey = proto.has.call(target, value)</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  target.add(value)</span>
<span style="color: #a4aab6;">  if (!hadKey) {</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">    target.add(value)</span>
<span style=
"color: #a4aab6;">    trigger(target, TriggerOpTypes.ADD, value, value)</span>
<span style="color: #a4aab6;">  }</span>
  return this
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org404e73c" class="outline-2">
      <h2 id="org404e73c"><span class="section-number-2">18.</span>
      3.0.6</h2>
      <div class="outline-text-2" id="text-18">
        <p>此次更新重点内容(值得关注的点)：</p>
        <ol class="org-ol">
          <li>
            <b><span style="color:green;">ADD</span></b>:
            <code>BigInt</code> 类型和 <i><abbr class="tooltip" title=
            "Single File Component, 单文件组件，其中包含了 script , style , template, 三种标签&lt;br&gt;为一体的文件， vue 框架所使用的及推崇的一种新的开发方式。">
            SFC</abbr></i> 支持 <a class="anchor" aria-hidden="true"
            id="add-bigint" href="#add-bigint"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: 修复
            <code>class: ['foo', false, undefined, 'bar']</code>
            被解析成 <code>&lt;div class="foo bar"/&gt;</code> 问题
            <a class="anchor" aria-hidden="true" id=
            "fix-array-class" href="#fix-array-class"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a> 。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>: 修复
            <code>foo-bar</code> 事件名无法触发问题 <a class="anchor"
            aria-hidden="true" id="fix-kebab-event-name" href=
            "#fix-kebab-event-name"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a> 。
          </li>
          <li>
            <b><span style="color:red;">FIX</span></b>:
            <code>this.$watch(fn, callback)</code> 的
            <code>fn</code> 第一个参数是 <code>instance.proxy</code>
            <a class="anchor" aria-hidden="true" id="instanceWatch"
            href="#instanceWatch"><svg xmlns=
            "http://www.w3.org/2000/svg" viewbox="0 0 16 16" width=
            "16" height="16">
            <path fill-rule="evenodd" d=
            "M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path></svg></a>
          </li>
        </ol>
      </div>
      <div id="outline-container-org2561184" class="outline-3">
        <h3 id="org2561184"><span class=
        "section-number-3">18.1.</span> Bug Fixes
        <code>[3/3]</code></h3>
        <div class="outline-text-3" id="text-18-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>remove superfluous spaces when normalizing class
              (<a href=
              "https://github.com/vuejs/vue-next/issues/3083">#3083</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/4b551420fc058c4683219db5d75893f9fc69aa04">4b55142</a>)
              <span id="fix-array-class"></span></p>
              <p>问题如下代码，正常应该忽略 <code>undefind</code>,
              <code>false</code> ：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { nodeOps, render, h, serializeInner: s } = value

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Comp</span> = {
  props: { foo: BigInt },
  render() {
    <span style="color: #51afef;">return</span> h(<span style=
"color: #98be65;">'div'</span>, { <span style=
"color: #51afef;">class</span>: [<span style=
"color: #98be65;">'foo'</span>, <span style=
"color: #a9a1e1;">undefined</span>, <span style=
"color: #a9a1e1;">false</span>, <span style=
"color: #98be65;">'bar'</span>] }, [<span style=
"color: #a9a1e1;">this</span>.foo])
  }
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">root</span> = nodeOps.createElement(<span style=
"color: #98be65;">'div'</span>)
render(h(Comp,  {
  foo: BigInt(BigInt(<span style=
"color: #da8548; font-weight: bold;">100000111</span>)) + BigInt(<span style="color: #da8548; font-weight: bold;">2000000000</span>) * BigInt(<span style="color: #da8548; font-weight: bold;">30000000</span>)
}), root)

console.log(s(root))
<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>
</pre>
              </div>
              <p><span style="color:blue;">+RESULTS</span>:</p>
              <pre class="example">
&lt;div class="foo   bar"&gt;60000000100000111&lt;/div&gt;
0
</pre>
              <p>修复：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/shared/src/normalizeProp.ts</span>
<span style="color: #a9a1e1;">@@ -62,7 +62,10 @@</span><span style=
"color: #46D9FF;"> export function normalizeClass(value: unknown): string {</span>
<span style="color: #a4aab6;">    res = value</span>
<span style="color: #a4aab6;">  } else if (isArray(value)) {</span>
<span style=
"color: #a4aab6;">    for (let i = 0; i &lt; value.length; i++) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">      </span><span style="color: #ff6c6b; background-color: #23272e;">res</span><span style="color: #ff6c6b; background-color: #23272e;"> </span><span style="color: #ff6c6b; background-color: #23272e;">+</span><span style="color: #ff6c6b; background-color: #23272e;">= normalizeClass(value[i]) + ' '</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      </span><span style="color: #98be65; background-color: #21242b;">const normalized</span><span style="color: #98be65; background-color: #21242b;"> = normalizeClass(value[i])</span>
<span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      if (normalized) {</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        res += normalized</span><span style="color: #98be65; background-color: #21242b;"> + ' '</span>
<span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">      }</span>
<span style="color: #a4aab6;">    }</span>
<span style=
"color: #a4aab6;">  } else if (isObject(value)) {</span>
    for (const name in value) {
</pre>
              </div>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: instanceWatch should pass this.proxy
              to source as the first argument (<a href=
              "https://github.com/vuejs/vue-next/issues/2753">#2753</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ec8fd10cec61c33c7c8056413a1c609ac90e1215">ec8fd10</a>)
              <span id="instanceWatch"></span></p>
              <p>当 watch 一个函数的时候，将 instance.proxy
              做为第一个参数传给这个函数。</p>
              <p>测试：</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { nodeOps, render, h, serializeInner: s, createApp } = value

<span style="color: #51afef;">let</span> <span style=
"color: #dcaeea;">instance</span> = <span style=
"color: #a9a1e1;">null</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">source</span> = (proxy) =&gt; console.log(instance &amp;& ( proxy === instance.proxy ))
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Comp</span> = {
  created() {
    instance = <span style="color: #a9a1e1;">this</span>
    <span style=
"color: #a9a1e1;">this</span>.$watch(source, () =&gt; {})
  },
  render() {}
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">root</span> = nodeOps.createElement(<span style=
"color: #98be65;">'div'</span>)
createApp(Comp).mount(root)
<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>
</pre>
              </div>
              <p><span style="color:blue;">+RESULTS</span>:</p>
              <pre class="example">
false
0
</pre>
              <p>修复：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;"> packages/runtime-core/src/apiWatch.ts</span>
<span style=
"color: #a9a1e1;">@@ -181,7 +181,9 @@</span><span style="color: #46D9FF;"> function doWatch(</span>
<span style=
"color: #a4aab6;">        } else if (isReactive(s)) {</span>
<span style="color: #a4aab6;">          return traverse(s)</span>
<span style=
"color: #a4aab6;">        } else if (isFunction(s)) {</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">          return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          return callWithErrorHandling(s, instance, ErrorCodes.WATCH_GETTER</span><span style="color: #98be65; background-color: #21242b;">, [</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">            instance &amp;& (instance.proxy as any)</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          ]</span><span style="color: #98be65; background-color: #21242b;">)</span>
<span style="color: #a4aab6;">        } else {</span>
<span style=
"color: #a4aab6;">          __DEV__ &amp;& warnInvalidSource(s)</span>
<span style="color: #a4aab6;">        }</span>
<span style=
"color: #a9a1e1;">@@ -190,7 +192,9 @@</span><span style="color: #46D9FF;"> function doWatch(</span>
<span style="color: #a4aab6;">    if (cb) {</span>
<span style="color: #a4aab6;">      // getter with cb</span>
<span style="color: #a4aab6;">      getter = () =&gt;</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">        callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER)</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        callWithErrorHandling(source, instance, ErrorCodes.WATCH_GETTER</span><span style="color: #98be65; background-color: #21242b;">, [</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          instance &amp;& (instance.proxy as any)</span><span style="color: #98be65; background-color: #21242b;">
</span><span style=
"color: #98be65; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        ]</span><span style="color: #98be65; background-color: #21242b;">)</span>
<span style="color: #a4aab6;">    } else {</span>
<span style=
"color: #a4aab6;">      // no cb -&gt; simple effect</span>
      getter = () =&gt; {
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org7d63978" class="outline-3">
        <h3 id="org7d63978"><span class=
        "section-number-3">18.2.</span> Features
        <code>[1/1]</code></h3>
        <div class="outline-text-3" id="text-18-2">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>runtime-core: props type support BigInt (<a href=
              "https://github.com/vuejs/vue-next/issues/2891">#2891</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/ffd52885453d1621e45dff645ff1101e74ea40b2">ffd5288</a>)
              <span id="add-bigint"></span></p>
              <p>修改代码：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">const isSimpleType = /*#__PURE__*/ makeMap(</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">  'String,Number,Boolean,Function,Symbol'</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">  'String,Number,Boolean,Function,Symbol,BigInt'</span>
)
</pre>
              </div>
              <p>测试</p>
              <div class="org-src-container">
                <pre class="src src-js"><span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">url</span> = process.env.VNEXT_PKG_RC +<span style="color: #98be65;">'/../runtime-test/dist/runtime-test.cjs.js'</span>
<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">value</span> = require(url.replace(<span style=
"color: #98be65;">'stb-'</span>, <span style=
"color: #98be65;">''</span>))
<span style=
"color: #51afef;">const</span> { nodeOps, render, h, serializeInner: s } = value

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">Comp</span> = {
  props: { foo: BigInt },
  render() {
    <span style="color: #51afef;">return</span> h(<span style=
"color: #98be65;">'div'</span>, [<span style=
"color: #a9a1e1;">this</span>.foo])
  }
}

<span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">root</span> = nodeOps.createElement(<span style=
"color: #98be65;">'div'</span>)
render(h(Comp,  {
  foo: BigInt(BigInt(<span style=
"color: #da8548; font-weight: bold;">100000111</span>)) + BigInt(<span style="color: #da8548; font-weight: bold;">2000000000</span>) * BigInt(<span style="color: #da8548; font-weight: bold;">30000000</span>)
}), root)

console.log(s(root))
<span style="color: #51afef;">return</span> <span style=
"color: #da8548; font-weight: bold;">0</span>
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div id="outline-container-org569bbcc" class="outline-2">
      <h2 id="org569bbcc"><span class="section-number-2">19.</span>
      3.0.5</h2>
      <div class="outline-text-2" id="text-19"></div>
      <div id="outline-container-org9b0769b" class="outline-3">
        <h3 id="org9b0769b"><span class=
        "section-number-3">19.1.</span> <span class=
        "done DONE">DONE</span> <b>Bug Fixes</b>
        <code>[2/2]</code></h3>
        <div class="outline-text-3" id="text-19-1">
          <ul class="org-ul">
            <li class="on">
              <code>[X]</code>
              <p>compiler-sfc: support transforming asset urls with
              full base url. (<a href=
              "https://github.com/vuejs/vue-next/issues/2477">#2477</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/db786b1afe41c26611a215e6d6599d50312b9c2f">db786b1</a>)</p>
              <p>针对相对路径而言，当提供了 base 选项的时候，会使用这个值去拼接，如：</p>
              <p><code>{ transformAssetUrls: { base:
              'https://www.cheng92.com' } }</code></p>
              <p><code>&lt;img src="./vue/img/test.png"
              /&gt;</code> 会被编译成：</p>
              <p><code>createVNode('img', { src:
              'https://www.cheng92.com/vue/img/test.png'
              })</code></p>
            </li>
            <li class="on">
              <code>[X]</code>
              <p>skip patchBlockChildren if n1.dynamicChildren is
              null (<a href=
              "https://github.com/vuejs/vue-next/issues/2717">#2717</a>)
              (<a href=
              "https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8">c59897c</a>),
              closes <a href=
              "https://github.com/vuejs/vue-next/issues/2715">#2715</a>
              <a href=
              "https://github.com/vuejs/vue-next/issues/2485">#2485</a></p>
              <div id="IR8Cl"></div>
              <script src="/assets/js/vue/tests/IR8Cl.js"></script>
              <p>这个问题原因是，一开始 HelloWorld 的 dynamicChildren 是
              null。</p>
              <p>当点击 ADD 按钮的时候增加了一项数据，会进入 mountChildren -&gt;
              patchBlockChildren</p>
              <div class="org-src-container">
                <pre class="src src-typescript">  <span style=
                "color: #51afef;">const</span> <span style=
                "color: #dcaeea;">patchBlockChildren</span>: <span style=
                "color: #ECBE7B;">PatchBlockChildrenFn</span> = <span style=
                "color: #51afef;">(</span>
    oldChildren,
    newChildren,
    fallbackContainer,
    parentComponent,
    parentSuspense,
    isSVG,
    slotScopeIds
  <span style="color: #51afef;">)</span> <span style=
"color: #51afef;">=&gt;</span> <span style=
"color: #51afef;">{</span>
    <span style="color: #51afef;">for</span> <span style=
"color: #c678dd;">(</span><span style=
"color: #51afef;">let</span> <span style=
"color: #dcaeea;">i</span> = <span style=
"color: #da8548; font-weight: bold;">0</span>; i &lt; <span style=
"color: #ECBE7B;">newChildren</span>.<span style=
"color: #ECBE7B;">length</span>; <span style=
"color: #ECBE7B;">i</span>++<span style=
"color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">oldVNode</span> = oldChildren<span style=
"color: #98be65;">[</span>i<span style=
"color: #98be65;">]</span> <span style=
"color: #5B6268;">// </span><span style=
"color: #5B6268;">dynamicChildren</span>
      <span style="color: #51afef;">const</span> <span style=
"color: #dcaeea;">newVNode</span> = newChildren<span style=
"color: #98be65;">[</span>i<span style="color: #98be65;">]</span>

      <span style="color: #5B6268;">// </span><span style=
"color: #5B6268;">...</span>
      <span style="color: #c678dd;">}</span>
    <span style="color: #51afef;">}</span>
</pre>
              </div>
              <p>而 <code>dynamicChildren</code> 在初始化的时候是个
              <code>null</code> 值, 一开始就访问了
              <code>dynamicChildren[i]</code> 所以导致报错。</p>
              <p>修复代码(<a href=
              "https://github.com/vuejs/vue-next/commit/c59897c7b0dbd82b5bbf3fbca945c0639ac37fb8">c59897c</a>)，加个判断条件：</p>
              <div class="org-src-container">
                <pre class="src src-diff"><span style=
                "color: #a4aab6;">  if (</span>
<span style=
"color: #a4aab6;">        patchFlag &gt; 0 &amp;&</span>
<span style=
"color: #a4aab6;">        patchFlag & PatchFlags.STABLE_FRAGMENT &amp;&</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">        dynamicChildren &amp;&</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        dynamicChildren &amp;&</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">        n1.dynamicChildren</span>
<span style="color: #a4aab6;">      ) {</span>
<span style=
"color: #a4aab6;">        // a stable fragment (template root or &lt;template v-for&gt;) doesn't need to</span>
<span style=
"color: #a4aab6;">        // patch children order, but it may contain dynamicChildren.</span>
<span style="color: #a4aab6;">        patchBlockChildren(</span>
<span style=
"color: #aa2222; background-color: #23272e;">-</span><span style=
"color: #ff6c6b; background-color: #23272e;">         n1.dynamicChildren!,</span>
<span style=
"color: #22aa22; background-color: #21242b;">+</span><span style=
"color: #98be65; background-color: #21242b;">          n1.dynamicChildren,</span>
<span style="color: #a4aab6;">          dynamicChildren,</span>
<span style="color: #a4aab6;">          container,</span>
<span style="color: #a4aab6;">          parentComponent,</span>
<span style="color: #a4aab6;">          parentSuspense,</span>
<span style="color: #a4aab6;">          isSVG,</span>
<span style="color: #a4aab6;">          slotScopeIds</span>
<span style="color: #a4aab6;">        )</span>

</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Zhicheng Lee</p>
    <p class="date">Created: 2022-03-12 Sat 21:01</p>
  </div>
</body>
</html>
