<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-04-22 Fri 17:23 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>build your own vue compiler-core</title>
  <meta name="author" content="Zhicheng Lee">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <link rel="icon" type="image/png" sizes="48x48" href=
  "/favicon.ico">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <link rel="stylesheet" href="/assets/js/fancybox/fancybox.css"
  type="text/css" media="screen">
  <script type="text/javascript" src=
  "/assets/js/fancybox/fancybox.umd.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/apps.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="vue">
  <meta name="tags" content="compiler-core">
  <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;
        
          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster.bundle.min.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster-sideTip-punk.min.css">
  <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
  </script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster.bundle.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster-scrollableTip.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/tooltips.js"></script>
  <style>
           abbr {color: red;}
        
           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
  </style>
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">build your own vue compiler-core</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#orgee8810d">1. Global variables</a>
            <ul>
              <li>
                <a href="#org7b61d4c">1.1. babel utils</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#cc-ast-parser">2. ast parser</a>
            <ul>
              <li>
                <a href="#org0e41166">2.1. baseParse()</a>
              </li>
              <li>
                <a href="#org7f2072a">2.2.
                createParserContext()</a>
              </li>
              <li>
                <a href="#org98d9f89">2.3. parseChildren()</a>
              </li>
              <li>
                <a href="#org07e1abe">2.4. parseText()</a>
              </li>
              <li>
                <a href="#org9ef9bcc">2.5. parseTextData()</a>
              </li>
              <li>
                <a href="#org355cd37">2.6. parseInterpolation()</a>
              </li>
              <li>
                <a href="#org816f7bb">2.7. parseElement()</a>
              </li>
              <li>
                <a href="#org63235c0">2.8. parseTag()</a>
              </li>
              <li>
                <a href="#orgf134308">2.9. parseAttributes()</a>
                <ul>
                  <li>
                    <a href="#org2f68db3">2.9.1. parseAttribute</a>
                  </li>
                  <li>
                    <a href="#org5b077c4">2.9.2.
                    parseAttributeValue</a>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <a href="#cc-transform">3. transform</a>
            <ul>
              <li>
                <a href="#org7022c27">3.1. transform()</a>
              </li>
              <li>
                <a href="#orge41bf94">3.2.
                createTransformContext()</a>
              </li>
              <li>
                <a href="#org2147436">3.3. traverseNode()</a>
              </li>
              <li>
                <a href="#org11ca908">3.4. traverseChildren()</a>
              </li>
              <li>
                <a href="#org567a84c">3.5. hoistStatic()</a>
              </li>
              <li>
                <a href="#orgf19f686">3.6. createRootCodegen()</a>
              </li>
              <li>
                <a href="#org20b6e44">3.7.
                createStructuralDirectiveTransform()</a>
              </li>
              <li>
                <a href="#transform-testing">3.8. Testing</a>
              </li>
              <li>
                <a href="#org1e2155b">3.9. transform plugins</a>
                <ul>
                  <li>
                    <a href="#org2292739">3.9.1. makeBlock()</a>
                  </li>
                  <li>
                    <a href="#org345dea5">3.9.2. transformIf()</a>
                  </li>
                  <li>
                    <a href="#org8911660">3.9.3.
                    transformSlotOutlet()</a>
                  </li>
                  <li>
                    <a href="#org385e800">3.9.4.
                    trackSlotScopes()</a>
                  </li>
                  <li>
                    <a href="#orgf1bd16f">3.9.5.
                    trackVForSlotScopes()</a>
                  </li>
                  <li>
                    <a href="#orgf947eb5">3.9.6.
                    transformText()</a>
                  </li>
                  <li>
                    <a href="#org15df7d8">3.9.7.
                    transformElement()</a>
                  </li>
                  <li>
                    <a href="#org748ce73">3.9.8.
                    transformExpression()</a>
                  </li>
                  <li>
                    <a href="#org8efbb9e">3.9.9. transformFor()</a>
                  </li>
                  <li>
                    <a href="#org3c30456">3.9.10.
                    transformOnce()</a>
                  </li>
                  <li>
                    <a href="#org3961cdc">3.9.11.
                    transformMemo()</a>
                  </li>
                  <li>
                    <a href="#orga621827">3.9.12. transformOn()</a>
                  </li>
                  <li>
                    <a href="#orgcf9d93c">3.9.13.
                    transformModel()</a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="#org424fb09">3.10. codegenNode
                creators</a>
                <ul>
                  <li>
                    <a href="#org7f6cbd5">3.10.1. createRoot()</a>
                  </li>
                  <li>
                    <a href="#orgb23bce9">3.10.2.
                    createVNodeCall()</a>
                  </li>
                  <li>
                    <a href="#org680a18f">3.10.3.
                    createArrayExpression()</a>
                  </li>
                  <li>
                    <a href="#org49b9b95">3.10.4.
                    createObjectExpression()</a>
                  </li>
                  <li>
                    <a href="#org98186e9">3.10.5.
                    createObjectProperty()</a>
                  </li>
                  <li>
                    <a href="#org0705d20">3.10.6.
                    createSimpleExpression()</a>
                  </li>
                  <li>
                    <a href="#orgba06049">3.10.7.
                    createInterpolation()</a>
                  </li>
                  <li>
                    <a href="#org5316836">3.10.8.
                    createCompoundExpression()</a>
                  </li>
                  <li>
                    <a href="#org7df99a3">3.10.9.
                    createCallExpression()</a>
                  </li>
                  <li>
                    <a href="#orgdf64175">3.10.10.
                    createFunctionExpression()</a>
                  </li>
                  <li>
                    <a href="#org1814eff">3.10.11.
                    createConditionalExpression()</a>
                  </li>
                  <li>
                    <a href="#orgae99f7d">3.10.12.
                    createCacheExpression()</a>
                  </li>
                  <li>
                    <a href="#orgded71e6">3.10.13.
                    createBlockStatement()</a>
                  </li>
                  <li>
                    <a href="#org5f217d6">3.10.14.
                    createTemplateLiteral()</a>
                  </li>
                  <li>
                    <a href="#org88bcd79">3.10.15.
                    createIfStatement()</a>
                  </li>
                  <li>
                    <a href="#orgda00b78">3.10.16.
                    createAssignmentExpression()</a>
                  </li>
                  <li>
                    <a href="#orgd100f56">3.10.17.
                    createSequenceExpression()</a>
                  </li>
                  <li>
                    <a href="#orge337313">3.10.18.
                    createReturnStatement()</a>
                  </li>
                </ul>
              </li>
              <li>
                <a href="#org4b3e461">3.11. hoists</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#cc-codegen">4. codegen</a>
          </li>
          <li>
            <a href="#cc-compile">5. compile</a>
            <ul>
              <li>
                <a href="#org3110601">5.1.
                getBaseTransformPreset()</a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <p><a href="/"><img src=
    "https://img.shields.io/badge/GCCLL-Homepage-green?logo=gnu-emacs"></a></p>
    <div style=
    "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <h3>Vue3 Compiler-core</h3>
      <p>vue3 编译器核心模块 -&gt; <a href=
      "https://github.com/vuejs/core/blob/main/packages/compiler-core/src/index.ts">
      core/index.ts at main · vuejs/core</a></p>
      <p><span style=
      "color:green;">该模块主要实现将SFC文件编译成render函数，其实主要包含三个阶段</span></p>
      <ol class="org-ol">
        <li>ast parser 阶段, 将 SFC 中的 <code>&lt;template&gt;</code>
        编译成 AST(抽象语法树)；</li>
        <li>transform 阶段，对 ast 的加工处理生成 codegenNode，比如：处理
        <code>for/if/on/bind</code> 等指令；</li>
        <li>codegen 阶段，根据 ast 生成的 codegenNode 去解析拼凑出 render 函数代码，然后
        用 <code>new Function(code)</code> 生成 <code>render</code>
        函数；</li>
      </ol>
      <p>旧博客中的相关文章：</p>
      <p><a href=
      "https://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/">
      Vue3.0 源码系列（二）编译器核心 - Compiler core 1: parse.ts -
      若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue3-source-code-compiler-core-ast_ts/">
      Vue3.0 源码系列（二）编译器核心 - Compiler core 2: ast.ts - 若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue3-source-code-compiler-core-compile_ts/">
      Vue3.0 源码系列（二）编译器核心 - Compiler core 3: compile.ts -
      若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-house-cc/">Vue3
      源码头脑风暴之☞compiler-core - 若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-compiler-core-parser/">
      Vue3 源码头脑风暴之 2 ☞compiler-core - ast parser - 若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-compiler-core-transform-generate/">
      Vue3 源码头脑风暴之 3 ☞compiler-core - transform + codegen -
      若叶知秋</a></p>
      <p>文中测试用例均来自官方用例：<a href=
      "https://github.com/vuejs/core/tree/main/packages/compiler-core/__tests__">core/packages/compiler-core/_<sub>tests</sub>__
      at main · vuejs/core</a></p>
    </div><br>
    <p>当前页面中关键信息表(带文内链接)</p>
    <table>
      <colgroup>
        <col class="org-left">
        <col class="org-left">
        <col class="org-left">
      </colgroup>
      <tbody>
        <tr>
          <td class="org-left">
            <a href="#orge073826">v-if</a>
          </td>
          <td class="org-left">
            <a href="#org6b61c41">v-for</a>
          </td>
          <td class="org-left">
            <a href="#orgb6496b0">v-on</a>
          </td>
        </tr>
        <tr>
          <td class="org-left">
            <a href="#org0ca42d1">&lt;slot/&gt;</a>
          </td>
          <td class="org-left">&nbsp;</td>
          <td class="org-left">&nbsp;</td>
        </tr>
      </tbody>
    </table>
    <div id="outline-container-orgee8810d" class="outline-2">
      <h2 id="orgee8810d"><span class="section-number-2">1.</span>
      Global variables</h2>
      <div class="outline-text-2" id="text-1">
        <p>与实际逻辑没什么关联的变量和函数。</p>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">全局变量</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="org4ea6cf5"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">babelParser</span> = require(process.env.NODE_LIB + <span class="org-string">'/@babel/parser'</span>)
<span class="linenr">  2: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">The default decoder only provides escapes for characters reserved as part of</span>
<span class="linenr">  3: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the template syntax, and is only used if the custom renderer did not provide</span>
<span class="linenr">  4: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">a platform-specific decoder.</span>
<span class="linenr">  5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">decodeRE</span> = <span class=
"org-string">/&amp;(gt|lt|amp|apos|quot);/</span>g
<span id="coderef-html-entities" class="coderef-off"><span class=
"linenr">  6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">decodeMap</span> = {</span>
<span class="linenr">  7: </span>  gt: <span class=
"org-string">'&gt;'</span>,
<span class="linenr">  8: </span>  lt: <span class=
"org-string">'&lt;'</span>,
<span class="linenr">  9: </span>  amp: <span class=
"org-string">'&amp;'</span>,
<span class="linenr"> 10: </span>  apos: <span class=
"org-string">"'"</span>,
<span class="linenr"> 11: </span>  quot: <span class=
"org-string">'"'</span>
<span class="linenr"> 12: </span>}
<span class="linenr"> 13: </span>
<span class="linenr"> 14: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">EMPTY_OBJ</span> = {}
<span class="linenr"> 15: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NO</span> = () =&gt; <span class=
"org-constant">false</span>
<span class="linenr"> 16: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NOOP</span> = () =&gt; {}
<span class="linenr"> 17: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">locStub</span> = {
<span class="linenr"> 18: </span>  source: <span class=
"org-string">''</span>,
<span class="linenr"> 19: </span>  start: { line: <span class=
"org-highlight-numbers-number">1</span>, column: <span class=
"org-highlight-numbers-number">1</span>, offset: <span class=
"org-highlight-numbers-number">0</span> },
<span class="linenr"> 20: </span>  end: { line: <span class=
"org-highlight-numbers-number">1</span>, column: <span class=
"org-highlight-numbers-number">1</span>, offset: <span class=
"org-highlight-numbers-number">0</span> }
<span class="linenr"> 21: </span>}
<span class="linenr"> 22: </span>
<span class="linenr"> 23: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ConstantTypes</span> = {
<span class="linenr"> 24: </span>  NOT_CONSTANT: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 25: </span>  CAN_SKIP_PATCH: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 26: </span>  CAN_HOIST: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 27: </span>  CAN_STRINGIFY: <span class=
"org-highlight-numbers-number">3</span>
<span class="linenr"> 28: </span>}
<span class="linenr"> 29: </span>
<span class="linenr"> 30: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ElementTypes</span> = {
<span class="linenr"> 31: </span>  ELEMENT: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 32: </span>  COMPONENT: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 33: </span>  SLOT: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 34: </span>  TEMPLATE: <span class=
"org-highlight-numbers-number">3</span>
<span class="linenr"> 35: </span>}
<span class="linenr"> 36: </span>
<span class="linenr"> 37: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">Namespaces</span> = {
<span class="linenr"> 38: </span>  HTML: <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 39: </span>}
<span class="linenr"> 40: </span>
<span class="linenr"> 41: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NodeTypes</span> = {
<span class="linenr"> 42: </span>  ROOT: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 43: </span>  ELEMENT: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 44: </span>  TEXT: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 45: </span>  COMMENT: <span class=
"org-highlight-numbers-number">3</span>,
<span class="linenr"> 46: </span>  SIMPLE_EXPRESSION: <span class=
"org-highlight-numbers-number">4</span>,
<span class="linenr"> 47: </span>  INTERPOLATION: <span class=
"org-highlight-numbers-number">5</span>,
<span class="linenr"> 48: </span>  ATTRIBUTE: <span class=
"org-highlight-numbers-number">6</span>,
<span class="linenr"> 49: </span>  DIRECTIVE: <span class=
"org-highlight-numbers-number">7</span>,
<span class="linenr"> 50: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">containers</span>
<span class=
"linenr"> 51: </span>  COMPOUND_EXPRESSION: <span class="org-highlight-numbers-number">8</span>,
<span class="linenr"> 52: </span>  IF: <span class=
"org-highlight-numbers-number">9</span>,
<span class="linenr"> 53: </span>  IF_BRANCH: <span class=
"org-highlight-numbers-number">10</span>,
<span class="linenr"> 54: </span>  FOR: <span class=
"org-highlight-numbers-number">11</span>,
<span class="linenr"> 55: </span>  TEXT_CALL: <span class=
"org-highlight-numbers-number">12</span>,
<span class="linenr"> 56: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">codegen</span>
<span class="linenr"> 57: </span>  VNODE_CALL: <span class=
"org-highlight-numbers-number">13</span>,
<span class="linenr"> 58: </span>  JS_CALL_EXPRESSION: <span class=
"org-highlight-numbers-number">14</span>,
<span class=
"linenr"> 59: </span>  JS_OBJECT_EXPRESSION: <span class=
"org-highlight-numbers-number">15</span>,
<span class="linenr"> 60: </span>  JS_PROPERTY: <span class=
"org-highlight-numbers-number">16</span>,
<span class=
"linenr"> 61: </span>  JS_ARRAY_EXPRESSION: <span class="org-highlight-numbers-number">17</span>,
<span class=
"linenr"> 62: </span>  JS_FUNCTION_EXPRESSION: <span class=
"org-highlight-numbers-number">18</span>,
<span class=
"linenr"> 63: </span>  JS_CONDITIONAL_EXPRESSION: <span class=
"org-highlight-numbers-number">19</span>,
<span class=
"linenr"> 64: </span>  JS_CACHE_EXPRESSION: <span class="org-highlight-numbers-number">20</span>,
<span class="linenr"> 65: </span>
<span class="linenr"> 66: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ssr codegen</span>
<span class="linenr"> 67: </span>  JS_BLOCK_STATEMENT: <span class=
"org-highlight-numbers-number">21</span>,
<span class=
"linenr"> 68: </span>  JS_TEMPLATE_LITERAL: <span class="org-highlight-numbers-number">22</span>,
<span class="linenr"> 69: </span>  JS_IF_STATEMENT: <span class=
"org-highlight-numbers-number">23</span>,
<span class=
"linenr"> 70: </span>  JS_ASSIGNMENT_EXPRESSION: <span class=
"org-highlight-numbers-number">24</span>,
<span class=
"linenr"> 71: </span>  JS_SEQUENCE_EXPRESSION: <span class=
"org-highlight-numbers-number">25</span>,
<span class=
"linenr"> 72: </span>  JS_RETURN_STATEMENT: <span class="org-highlight-numbers-number">26</span>
<span class="linenr"> 73: </span>}
<span class="linenr"> 74: </span>
<span class="linenr"> 75: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">__DEV__</span> = <span class=
"org-constant">true</span>
<span class="linenr"> 76: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">__BROWSER__</span> = <span class=
"org-constant">false</span>
<span class="linenr"> 77: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">defaultParserOptions</span> = {
<span class="linenr"> 78: </span>  delimiters: [<span class=
"org-string">`{{`</span>, <span class="org-string">`}}`</span>],
<span class=
"linenr"> 79: </span>  getNamespace: () =&gt; Namespaces.HTML,
<span class=
"linenr"> 80: </span>  getTextMode: () =&gt; TextModes.DATA,
<span class="linenr"> 81: </span>  isVoidTag: NO,
<span class="linenr"> 82: </span>  isPreTag: NO,
<span class="linenr"> 83: </span>  isCustomElement: NO,
<span class=
"linenr"> 84: </span>  decodeEntities: (rawText) =&gt; rawText.replace(decodeRE, (_, p1) =&gt; decodeMap[p1]),
<span class="linenr"> 85: </span>  onError: defaultOnError,
<span class="linenr"> 86: </span>  onWarn: defaultOnWarn,
<span class="linenr"> 87: </span>  comments: __DEV__
<span class="linenr"> 88: </span>}
<span class="linenr"> 89: </span>
<span class="linenr"> 90: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TagType</span> = {
<span class="linenr"> 91: </span>  Start: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 92: </span>  End: <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr"> 93: </span>}
<span class="linenr"> 94: </span>
<span class="linenr"> 95: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TextModes</span> = {
<span class="linenr"> 96: </span>  DATA: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 97: </span>  RCDATA: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 98: </span>  RAWTEXT: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 99: </span>  CDATA: <span class=
"org-highlight-numbers-number">3</span>,
<span class="linenr">100: </span>  ATTRIBUTE_VALUE: <span class=
"org-highlight-numbers-number">4</span>
<span class="linenr">101: </span>}
<span class="linenr">102: </span>
<span class="linenr">103: </span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">debugOn</span> = <span class=
"org-constant">true</span>
<span class="linenr">104: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">log</span> = (fn, message) =&gt; {
<span class="linenr">105: </span>  <span class=
"org-keyword">if</span> (debugOn) {
<span class="linenr">106: </span>    <span class=
"org-keyword">if</span> (message === <span class=
"org-constant">undefined</span>) {
<span class="linenr">107: </span>      console.log(fn)
<span class="linenr">108: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">109: </span>      console.log(<span class=
"org-string">`[${fn}] ${message}`</span>)
<span class="linenr">110: </span>    }
<span class="linenr">111: </span>  }
<span class="linenr">112: </span>}
<span class="linenr">113: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">logOn</span> = () =&gt; (debugOn = <span class=
"org-constant">true</span>)
<span class="linenr">114: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">logOff</span> = () =&gt; (debugOn = <span class="org-constant">false</span>)
<span class="linenr">115: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">logEnd</span> = (hint = <span class=
"org-string">"END"</span>) =&gt; {
<span class="linenr">116: </span>  <span class=
"org-keyword">if</span> (debugOn)
<span class="linenr">117: </span>    console.log(<span class=
"org-string">`--------- ${hint} ---------`</span>)
<span class="linenr">118: </span>}
<span class="linenr">119: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">logg</span> = ( hint, ...msg ) =&gt; {
<span class="linenr">120: </span>  logEnd(hint)
<span class="linenr">121: </span>  msg.forEach((m) =&gt; log(m))
<span class="linenr">122: </span>}
<span class="linenr">123: </span>
<span class="linenr">124: </span>&lt;&lt;glovalFns&gt;&gt;
<span class="linenr">125: </span>
<span class="linenr">126: </span>&lt;&lt;runtimeHelpers&gt;&gt;
<span class="linenr">127: </span>
<span class="linenr">128: </span>&lt;&lt;patchFlags&gt;&gt;
<span class="linenr">129: </span>
<span class="linenr">130: </span>&lt;&lt;injectProp&gt;&gt;
<span class="linenr">131: </span>
<span class="linenr">132: </span>&lt;&lt;BindingTypes&gt;&gt;
<span class="linenr">133: </span>
<span class="linenr">134: </span>&lt;&lt;babelUtils&gt;&gt;
</pre>
          </div>
        </details><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">Global Functions</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="org843caa7"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">extend</span> = Object.assign
<span class="linenr">  2: </span>
<span class="linenr">  3: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">defaultOnError</span>(<span class=
"org-variable-name">error</span>) {
<span class="linenr">  4: </span>  <span class=
"org-keyword">throw</span> error
<span class="linenr">  5: </span>}
<span class="linenr">  6: </span>
<span class="linenr">  7: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">defaultOnWarn</span>(<span class=
"org-variable-name">msg</span>) {
<span class=
"linenr">  8: </span>  __DEV__ &amp;& console.warn(<span class=
"org-string">`[Vue warn] ${msg.message}`</span>)
<span class="linenr">  9: </span>}
<span class="linenr"> 10: </span>
<span class="linenr"> 11: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">makeMap</span>(<span class=
"org-variable-name">str</span>, <span class=
"org-variable-name">expectsLowerCase</span>) {
<span class="linenr"> 12: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">map</span> = Object.create(<span class=
"org-constant">null</span>)
<span class="linenr"> 13: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">list</span> = str.split(<span class=
"org-string">','</span>)
<span class="linenr"> 14: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; list.length; i++) {
<span class="linenr"> 15: </span>    map[list[i]] = <span class=
"org-constant">true</span>
<span class="linenr"> 16: </span>  }
<span class="linenr"> 17: </span>  <span class=
"org-keyword">return</span> expectsLowerCase ? val =&gt; !!map[val.toLowerCase()] : val =&gt; !!map[val]
<span class="linenr"> 18: </span>}
<span class="linenr"> 19: </span>
<span class="linenr"> 20: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasOwnProperty</span> = Object.<span class=
"org-constant">prototype</span>.hasOwnProperty
<span class="linenr"> 21: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasOwn</span> = (val, key) =&gt; hasOwnProperty.call(val, key)
<span class="linenr"> 22: </span>
<span class="linenr"> 23: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isArray</span> = Array.isArray
<span class="linenr"> 24: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isMap</span> = (val) =&gt; toTypeString(val) === <span class="org-string">'[object Map]'</span>
<span class="linenr"> 25: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSet</span> = (val) =&gt; toTypeString(val) === <span class="org-string">'[object Set]'</span>
<span class="linenr"> 26: </span>
<span class="linenr"> 27: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDate</span> = (val) =&gt; val <span class=
"org-keyword">instanceof</span> <span class="org-type">Date</span>
<span class="linenr"> 28: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isFunction</span> = (val) =&gt; <span class=
"org-keyword">typeof</span> val === <span class=
"org-string">'function'</span>
<span class="linenr"> 29: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isString</span> = (val) =&gt; <span class=
"org-keyword">typeof</span> val === <span class=
"org-string">'string'</span>
<span class="linenr"> 30: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSymbol</span> = (val) =&gt; <span class=
"org-keyword">typeof</span> val === <span class=
"org-string">'symbol'</span>
<span class="linenr"> 31: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isObject</span> = (val) =&gt; val !== <span class="org-constant">null</span> &amp;& <span class="org-keyword">typeof</span> val === <span class="org-string">'object'</span>
<span class="linenr"> 32: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">onRE</span> = <span class=
"org-string">/^on[^a-z]/</span>
<span class="linenr"> 33: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isOn</span> = (key) =&gt; onRE.test(key)
<span class="linenr"> 34: </span>
<span class="linenr"> 35: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isPromise</span> = (val) =&gt; {
<span class="linenr"> 36: </span>  <span class=
"org-keyword">return</span> isObject(val) &amp;& isFunction(val.then) &amp;& isFunction(val.<span class="org-keyword">catch</span>)
<span class="linenr"> 37: </span>}
<span class="linenr"> 38: </span>
<span class="linenr"> 39: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">objectToString</span> = Object.<span class=
"org-constant">prototype</span>.toString
<span class="linenr"> 40: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">toTypeString</span> = (value) =&gt; objectToString.call(value)
<span class="linenr"> 41: </span>
<span class="linenr"> 42: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">toRawType</span> = (value) =&gt; {
<span class="linenr"> 43: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">extract "RawType" from strings like "[object RawType]"</span>
<span class="linenr"> 44: </span>  <span class=
"org-keyword">return</span> toTypeString(value).slice(<span class=
"org-highlight-numbers-number">8</span>, -<span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr"> 45: </span>}
<span class="linenr"> 46: </span>
<span class="linenr"> 47: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isPlainObject</span> = (val) =&gt; toTypeString(val) === <span class="org-string">'[object Object]'</span>
<span class="linenr"> 48: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isIntegerKey</span> = (key) =&gt;
<span class="linenr"> 49: </span>  isString(key) &amp;&
<span class="linenr"> 50: </span>  key !== <span class=
"org-string">'NaN'</span> &amp;&
<span class="linenr"> 51: </span>  key[<span class=
"org-highlight-numbers-number">0</span>] !== <span class=
"org-string">'-'</span> &amp;&
<span class="linenr"> 52: </span>  <span class=
"org-string">''</span> + parseInt(key, <span class=
"org-highlight-numbers-number">10</span>) === key
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isReservedProp</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr"> 55: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the leading comma is intentional so empty string "" is also included</span>
<span class="linenr"> 56: </span>  <span class=
"org-string">',key,ref,ref_for,ref_key,'</span> +
<span class="linenr"> 57: </span>    <span class=
"org-string">'onVnodeBeforeMount,onVnodeMounted,'</span> +
<span class="linenr"> 58: </span>    <span class=
"org-string">'onVnodeBeforeUpdate,onVnodeUpdated,'</span> +
<span class="linenr"> 59: </span>    <span class=
"org-string">'onVnodeBeforeUnmount,onVnodeUnmounted'</span>
<span class="linenr"> 60: </span>)
<span class="linenr"> 61: </span>
<span class="linenr"> 62: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">GLOBALS_WHITE_LISTED</span> =
<span class="linenr"> 63: </span>  <span class=
"org-string">'Infinity,undefined,NaN,isFinite,isNaN,parseFloat,parseInt,decodeURI,'</span> +
<span class="linenr"> 64: </span>  <span class=
"org-string">'decodeURIComponent,encodeURI,encodeURIComponent,Math,Number,Date,Array,'</span> +
<span class="linenr"> 65: </span>  <span class=
"org-string">'Object,Boolean,String,RegExp,Map,Set,JSON,Intl,BigInt'</span>
<span class="linenr"> 66: </span>
<span class="linenr"> 67: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isGloballyWhitelisted</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(GLOBALS_WHITE_LISTED)
<span class="linenr"> 68: </span>
<span class="linenr"> 69: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">nonIdentifierRE</span> = <span class=
"org-string">/^\d|[^\$\w]/</span>
<span class="linenr"> 70: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSimpleIdentifier</span> = (name) =&gt; !nonIdentifierRE.test(name)
<span class="linenr"> 71: </span>
<span class="linenr"> 72: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isBuiltInDirective</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr"> 73: </span>  <span class=
"org-string">'bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text,memo'</span>
<span class="linenr"> 74: </span>)
<span class="linenr"> 75: </span>
<span class="linenr"> 76: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getCursor</span>(<span class=
"org-variable-name">context</span>) {
<span class="linenr"> 77: </span>  <span class=
"org-keyword">const</span> { column, line, offset } = context
<span class="linenr"> 78: </span>  <span class=
"org-keyword">return</span> { column, line, offset }
<span class="linenr"> 79: </span>}
<span class="linenr"> 80: </span>
<span class="linenr"> 81: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getSelection</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">start</span>, <span class=
"org-variable-name">end</span>) {
<span class="linenr"> 82: </span>  end = end || getCursor(context)
<span class="linenr"> 83: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr"> 84: </span>    start,
<span class="linenr"> 85: </span>    end,
<span class=
"linenr"> 86: </span>    source: context.originalSource.slice(start.offset, end.offset)
<span class="linenr"> 87: </span>  }
<span class="linenr"> 88: </span>}
<span class="linenr"> 89: </span>
<span class="linenr"> 90: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">last</span>(<span class=
"org-variable-name">xs</span>) {
<span class="linenr"> 91: </span>  <span class=
"org-keyword">return</span> xs[xs.length - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 92: </span>}
<span class="linenr"> 93: </span>
<span class="linenr"> 94: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">startsWith</span>(<span class=
"org-variable-name">source</span>, <span class=
"org-variable-name">searchString</span>) {
<span class="linenr"> 95: </span>  <span class=
"org-keyword">return</span> source.startsWith(searchString)
<span class="linenr"> 96: </span>}
<span class="linenr"> 97: </span>
<span class="linenr"> 98: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advancePositionWithMutation</span>(<span class=
"org-variable-name">pos</span>, <span class=
"org-variable-name">source</span>, <span class=
"org-variable-name">numberOfCharacters</span> = <span class=
"org-variable-name">source</span>.<span class=
"org-variable-name">length</span>) {
<span class="linenr"> 99: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">linesCount</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">100: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">lastNewLinePos</span> = -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">101: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; numberOfCharacters; i++) {
<span class="linenr">102: </span>    <span class=
"org-keyword">if</span> (source.charCodeAt(i) === <span class=
"org-highlight-numbers-number">10</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">newline char code</span><span class=
"org-comment-delimiter"> */</span>) {
<span class="linenr">103: </span>      linesCount++
<span class="linenr">104: </span>      lastNewLinePos = i
<span class="linenr">105: </span>    }
<span class="linenr">106: </span>  }
<span class="linenr">107: </span>
<span class="linenr">108: </span>  pos.offset += numberOfCharacters
<span class="linenr">109: </span>  pos.line += linesCount
<span class="linenr">110: </span>  pos.column =
<span class=
"linenr">111: </span>    lastNewLinePos === -<span class=
"org-highlight-numbers-number">1</span>
<span class=
"linenr">112: </span>      ? pos.column + numberOfCharacters
<span class=
"linenr">113: </span>      : numberOfCharacters - lastNewLinePos
<span class="linenr">114: </span>
<span class="linenr">115: </span>  <span class=
"org-keyword">return</span> pos
<span class="linenr">116: </span>}
<span class="linenr">117: </span>
<span class="linenr">118: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advancePositionWithClone</span>(
<span class="linenr">119: </span>  <span class=
"org-variable-name">pos</span>,
<span class="linenr">120: </span>  <span class=
"org-variable-name">source</span>,
<span class=
"linenr">121: </span>  numberOfCharacters = source.length
<span class="linenr">122: </span>) {
<span class="linenr">123: </span>  <span class=
"org-keyword">return</span> advancePositionWithMutation(
<span class="linenr">124: </span>    extend({}, pos),
<span class="linenr">125: </span>    source,
<span class="linenr">126: </span>    numberOfCharacters
<span class="linenr">127: </span>  )
<span class="linenr">128: </span>}
<span class="linenr">129: </span>
<span class="linenr">130: </span>
<span class="linenr">131: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advanceBy</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">numberOfCharacters</span>) {
<span class="linenr">132: </span>  <span class=
"org-keyword">const</span> { source } = context
<span class=
"linenr">133: </span>  advancePositionWithMutation(context, source, numberOfCharacters)
<span class=
"linenr">134: </span>  context.source = source.slice(numberOfCharacters)
<span class="linenr">135: </span>}
<span class="linenr">136: </span>
<span class="linenr">137: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advanceSpaces</span>(<span class=
"org-variable-name">context</span>) {
<span class="linenr">138: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[\t\r\n\f ]+/</span>.exec(context.source)
<span class="linenr">139: </span>  <span class=
"org-keyword">if</span> (match) {
<span class=
"linenr">140: </span>    advanceBy(context, match[<span class=
"org-highlight-numbers-number">0</span>].length)
<span class="linenr">141: </span>  }
<span class="linenr">142: </span>}
<span class="linenr">143: </span>
<span class="linenr">144: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getNewPosition</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">start</span>, <span class=
"org-variable-name">numberOfCharacters</span>) {
<span class="linenr">145: </span>  <span class=
"org-keyword">return</span> advancePositionWithClone(
<span class="linenr">146: </span>    start,
<span class=
"linenr">147: </span>    context.originalSource.slice(start.offset, numberOfCharacters),
<span class="linenr">148: </span>    numberOfCharacters
<span class="linenr">149: </span>  )
<span class="linenr">150: </span>}
<span class="linenr">151: </span>
<span class="linenr">152: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">emitError</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">code</span>, <span class=
"org-variable-name">offset</span>, <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">getCursor</span>(<span class=
"org-variable-name">context</span>)) {
<span class="linenr">153: </span>  <span class=
"org-keyword">if</span> (offset) {
<span class="linenr">154: </span>    loc.offset += offset
<span class="linenr">155: </span>    loc.column += offset
<span class="linenr">156: </span>  }
<span class="linenr">157: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ignore...</span>
<span class="linenr">158: </span>}
<span class="linenr">159: </span>
<span class="linenr">160: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isEnd</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">mode</span>, <span class=
"org-variable-name">ancestors</span>) {
<span class="linenr">161: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">s</span> = context.source
<span class="linenr">162: </span>
<span class="linenr">163: </span>  <span class=
"org-keyword">switch</span> (mode) {
<span class="linenr">164: </span>    <span class=
"org-keyword">case</span> TextModes.DATA:
<span class="linenr">165: </span>      <span class=
"org-keyword">if</span> (startsWith(s, <span class=
"org-string">'&lt;/'</span>)) {
<span class="linenr">166: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO:</span></span></span><span class=
"org-comment"> probably bad performance</span>
<span class="linenr">167: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = ancestors.length - <span class=
"org-highlight-numbers-number">1</span>; i &gt;= <span class=
"org-highlight-numbers-number">0</span>; --i) {
<span class="linenr">168: </span>          <span class=
"org-keyword">if</span> (startsWithEndTagOpen(s, ancestors[i].tag)) {
<span class="linenr">169: </span>            <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">170: </span>          }
<span class="linenr">171: </span>        }
<span class="linenr">172: </span>      }
<span class="linenr">173: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">174: </span>
<span class="linenr">175: </span>    <span class=
"org-keyword">case</span> TextModes.RCDATA:
<span class="linenr">176: </span>    <span class=
"org-keyword">case</span> TextModes.RAWTEXT: {
<span class="linenr">177: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr">178: </span>      <span class=
"org-keyword">if</span> (parent &amp;& startsWithEndTagOpen(s, parent.tag)) {
<span class="linenr">179: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">180: </span>      }
<span class="linenr">181: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">182: </span>    }
<span class="linenr">183: </span>
<span class="linenr">184: </span>    <span class=
"org-keyword">case</span> TextModes.CDATA:
<span class="linenr">185: </span>      <span class=
"org-keyword">if</span> (startsWith(s, <span class=
"org-string">']]&gt;'</span>)) {
<span class="linenr">186: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">187: </span>      }
<span class="linenr">188: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">189: </span>  }
<span class="linenr">190: </span>
<span class="linenr">191: </span>  <span class=
"org-keyword">return</span> !s
<span class="linenr">192: </span>}
<span class="linenr">193: </span>
<span class="linenr">194: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">startsWithEndTagOpen</span>(<span class=
"org-variable-name">source</span>, <span class=
"org-variable-name">tag</span>) {
<span class="linenr">195: </span>  <span class=
"org-keyword">return</span> (
<span class=
"linenr">196: </span>    startsWith(source, <span class="org-string">'&lt;/'</span>) &amp;&
<span class="linenr">197: </span>    source.slice(<span class=
"org-highlight-numbers-number">2</span>, <span class=
"org-highlight-numbers-number">2</span> + tag.length).toLowerCase() === tag.toLowerCase() &amp;&
<span class=
"linenr">198: </span>    /[\t\r\n\f /&gt;]/.test(source[<span class="org-highlight-numbers-number">2</span> + tag.length] || <span class="org-string">'&gt;'</span>)
<span class="linenr">199: </span>  )
<span class="linenr">200: </span>}
<span class="linenr">201: </span>
<span class="linenr">202: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">cacheStringFunction</span> = (fn) =&gt; {
<span class="linenr">203: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">cache</span> = Object.create(<span class=
"org-constant">null</span>)
<span class="linenr">204: </span>  <span class=
"org-keyword">return</span> ((str) =&gt; {
<span class="linenr">205: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hit</span> = cache[str]
<span class="linenr">206: </span>    <span class=
"org-keyword">return</span> hit || (cache[str] = fn(str))
<span class="linenr">207: </span>  })
<span class="linenr">208: </span>}
<span class="linenr">209: </span>
<span class="linenr">210: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">camelizeRE</span> = <span class=
"org-string">/-(\w)/</span>g
<span class="linenr">211: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">camelize</span> = cacheStringFunction((str) =&gt; {
<span class="linenr">212: </span>  <span class=
"org-keyword">return</span> str.replace(camelizeRE, (_, c) =&gt; (c ? c.toUpperCase() : <span class="org-string">''</span>))
<span class="linenr">213: </span>})
<span class="linenr">214: </span>
<span class="linenr">215: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hyphenateRE</span> = <span class=
"org-string">/\B([A-Z])/</span>g
<span class="linenr">216: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hyphenate</span> = cacheStringFunction((str) =&gt;
<span class=
"linenr">217: </span>  str.replace(hyphenateRE, <span class=
"org-string">'-$1'</span>).toLowerCase()
<span class="linenr">218: </span>)
<span class="linenr">219: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">capitalize</span> = cacheStringFunction(
<span class=
"linenr">220: </span>  (str) =&gt; str.charAt(<span class=
"org-highlight-numbers-number">0</span>).toUpperCase() + str.slice(<span class="org-highlight-numbers-number">1</span>)
<span class="linenr">221: </span>)
<span class="linenr">222: </span>
<span class="linenr">223: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isBuiltInType</span> = (tag, expected) =&gt; tag === expected || tag === hyphenate(expected)
<span class="linenr">224: </span>
<span class="linenr">225: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isCoreComponent</span>(<span class=
"org-variable-name">tag</span>) {
<span class="linenr">226: </span>  <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'Teleport'</span>)) {
<span class="linenr">227: </span>    <span class=
"org-keyword">return</span> TELEPORT
<span class="linenr">228: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'Suspense'</span>)) {
<span class="linenr">229: </span>    <span class=
"org-keyword">return</span> SUSPENSE
<span class="linenr">230: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'KeepAlive'</span>)) {
<span class="linenr">231: </span>    <span class=
"org-keyword">return</span> KEEP_ALIVE
<span class="linenr">232: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'BaseTransition'</span>)) {
<span class="linenr">233: </span>    <span class=
"org-keyword">return</span> BASE_TRANSITION
<span class="linenr">234: </span>  }
<span class="linenr">235: </span>}
<span class="linenr">236: </span>
<span class="linenr">237: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSpecialTemplateDirective</span> = <span class="org-comment-delimiter">/*</span><span class="org-comment">#__PURE__</span><span class="org-comment-delimiter">*/</span> makeMap(
<span class="linenr">238: </span>  <span class=
"org-string">`if,else,else-if,for,slot`</span>
<span class="linenr">239: </span>)
<span class="linenr">240: </span>
<span class="linenr">241: </span>&lt;&lt;isComponent&gt;&gt;
<span class="linenr">242: </span>&lt;&lt;pushNode&gt;&gt;
<span class="linenr">243: </span>
<span class="linenr">244: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getVNodeHelper</span>(<span class=
"org-variable-name">ssr</span>, <span class=
"org-variable-name">isComponent</span>) {
<span class="linenr">245: </span>  <span class=
"org-keyword">return</span> ssr || isComponent ? CREATE_VNODE : CREATE_ELEMENT_VNODE
<span class="linenr">246: </span>}
<span class="linenr">247: </span>
<span class="linenr">248: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getVNodeBlockHelper</span>(<span class=
"org-variable-name">ssr</span>, <span class=
"org-variable-name">isComponent</span>) {
<span class="linenr">249: </span>  <span class=
"org-keyword">return</span> ssr || isComponent ? CREATE_BLOCK : CREATE_ELEMENT_BLOCK
<span class="linenr">250: </span>}
<span class="linenr">251: </span>
<span class="linenr">252: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isSingleElementRoot</span>(<span class=
"org-variable-name">root</span>, <span class=
"org-variable-name">child</span>) {
<span class="linenr">253: </span>  <span class=
"org-keyword">const</span> { children } = root
<span class="linenr">254: </span>  <span class=
"org-keyword">return</span> (
<span class=
"linenr">255: </span>    children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;&
<span class=
"linenr">256: </span>    child.type === NodeTypes.ELEMENT &amp;&
<span class="linenr">257: </span>    !isSlotOutlet(child)
<span class="linenr">258: </span>  )
<span class="linenr">259: </span>}
<span class="linenr">260: </span>
<span class="linenr">261: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isSlotOutlet</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">262: </span>  <span class=
"org-keyword">return</span> node.type === NodeTypes.ELEMENT &amp;& node.tagType === ElementTypes.SLOT
<span class="linenr">263: </span>}
<span class="linenr">264: </span>
<span class="linenr">265: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">findDir</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">name</span>, <span class=
"org-variable-name">allowEmpty</span> = <span class=
"org-constant">false</span>) {
<span class="linenr">266: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">267: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">268: </span>    <span class=
"org-keyword">if</span> (
<span class=
"linenr">269: </span>      p.type === NodeTypes.DIRECTIVE &amp;&
<span class="linenr">270: </span>      (allowEmpty || p.exp) &amp;&
<span class=
"linenr">271: </span>      (isString(name) ? p.name === name : name.test(p.name))
<span class="linenr">272: </span>    ) {
<span class="linenr">273: </span>      <span class=
"org-keyword">return</span> p
<span class="linenr">274: </span>    }
<span class="linenr">275: </span>  }
<span class="linenr">276: </span>}
<span class="linenr">277: </span>
<span class="linenr">278: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">findProp</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">name</span>, <span class=
"org-variable-name">dynamicOnly</span> = <span class=
"org-constant">false</span>, <span class=
"org-variable-name">allowEmpty</span> = <span class=
"org-constant">false</span>) {
<span class="linenr">279: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">280: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">281: </span>    <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">282: </span>      <span class=
"org-keyword">if</span> (dynamicOnly) <span class=
"org-keyword">continue</span>
<span class="linenr">283: </span>      <span class=
"org-keyword">if</span> (p.name === name &amp;& (p.value || allowEmpty)) {
<span class="linenr">284: </span>        <span class=
"org-keyword">return</span> p
<span class="linenr">285: </span>      }
<span class="linenr">286: </span>    } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class="linenr">287: </span>      p.name === <span class=
"org-string">'bind'</span> &amp;&
<span class="linenr">288: </span>      (p.exp || allowEmpty) &amp;&
<span class="linenr">289: </span>      isStaticArgOf(p.arg, name)
<span class="linenr">290: </span>    ) {
<span class="linenr">291: </span>      <span class=
"org-keyword">return</span> p
<span class="linenr">292: </span>    }
<span class="linenr">293: </span>  }
<span class="linenr">294: </span>}
<span class="linenr">295: </span>
<span class="linenr">296: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStaticExp</span> = (p) =&gt; p.type === NodeTypes.SIMPLE_EXPRESSION &amp;& p.isStatic
<span class="linenr">297: </span>
<span class="linenr">298: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isStaticArgOf</span>(<span class=
"org-variable-name">arg</span>, <span class=
"org-variable-name">name</span>) {
<span class="linenr">299: </span>  <span class=
"org-keyword">return</span> !!(arg &amp;& isStaticExp(arg) &amp;& arg.content === name)
<span class="linenr">300: </span>}
<span class="linenr">301: </span>
<span class="linenr">302: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isVSlot</span>(<span class=
"org-variable-name">p</span>) {
<span class="linenr">303: </span>  <span class=
"org-keyword">return</span> p.type === NodeTypes.DIRECTIVE &amp;& p.name === <span class="org-string">'slot'</span>
<span class="linenr">304: </span>}
<span class="linenr">305: </span>
<span class="linenr">306: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getMemoedVNodeCall</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">307: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.JS_CALL_EXPRESSION &amp;& node.callee === WITH_MEMO) {
<span class="linenr">308: </span>    <span class=
"org-keyword">return</span> node.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">1</span>].returns
<span class="linenr">309: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">310: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr">311: </span>  }
<span class="linenr">312: </span>}
<span class="linenr">313: </span>
<span class="linenr">314: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getInnerRange</span>(<span class=
"org-variable-name">loc</span>, <span class=
"org-variable-name">offset</span>, <span class=
"org-variable-name">length</span>) {
<span class="linenr">315: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">source</span> = loc.source.slice(offset, offset + length)
<span class="linenr">316: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">newLoc</span> = {
<span class="linenr">317: </span>    source,
<span class=
"linenr">318: </span>    start: advancePositionWithClone(loc.start, loc.source, offset),
<span class="linenr">319: </span>    end: loc.end
<span class="linenr">320: </span>  }
<span class="linenr">321: </span>
<span class="linenr">322: </span>  <span class=
"org-keyword">if</span> (length != <span class=
"org-constant">null</span>) {
<span class=
"linenr">323: </span>    newLoc.end = advancePositionWithClone(
<span class="linenr">324: </span>      loc.start,
<span class="linenr">325: </span>      loc.source,
<span class="linenr">326: </span>      offset + length
<span class="linenr">327: </span>    )
<span class="linenr">328: </span>  }
<span class="linenr">329: </span>
<span class="linenr">330: </span>  <span class=
"org-keyword">return</span> newLoc
<span class="linenr">331: </span>}
<span class="linenr">332: </span>
<span class="linenr">333: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">toValidAssetId</span>(<span class=
"org-variable-name">name</span>, <span class=
"org-variable-name">type</span>) {
<span class="linenr">334: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">see issue#4422, we need adding identifier on validAssetId if variable `name` has specific character</span>
<span class="linenr">335: </span>  <span class=
"org-keyword">return</span> <span class=
"org-string">`_${type}_${name.replace(/[^\w]/g, (searchValue, replaceValue) =&gt; {</span>
<span class="linenr">336: </span><span class=
"org-string">    return searchValue === '-' ? '_' : name.charCodeAt(replaceValue).toString()</span>
<span class="linenr">337: </span><span class=
"org-string">  })}`</span>
<span class="linenr">338: </span>}
<span class="linenr">339: </span>
</pre>
          </div>
          <p>检查是不是组件类型：</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org6643c2f"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">isComponent</span>(<span class=
            "org-variable-name">tag</span>, <span class=
            "org-variable-name">props</span>, <span class=
            "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">options</span> = context.options
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (options.isCustomElement(tag)) {
<span class="linenr"> 4: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr"> 5: </span>  }
<span class="linenr"> 6: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr"> 7: </span>    tag === <span class=
"org-string">'component'</span> ||
<span class="linenr"> 8: </span>    /^[A-Z]/.test(tag) ||
<span class="linenr"> 9: </span>    isCoreComponent(tag) ||
<span class=
"linenr">10: </span>    (options.isBuiltInComponent &amp;& options.isBuiltInComponent(tag)) ||
<span class=
"linenr">11: </span>    (options.isNativeTag &amp;& !options.isNativeTag(tag))
<span class="linenr">12: </span>  ) {
<span class="linenr">13: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">14: </span>  }
<span class="linenr">15: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">at this point the tag should be a native tag, but check for potential "is"</span>
<span class="linenr">16: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">casting</span>
<span class="linenr">17: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; props.length; i++) {
<span class="linenr">18: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = props[i]
<span class="linenr">19: </span>    <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">20: </span>      <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'is'</span> &amp;& p.value) {
<span class="linenr">21: </span>        <span class=
"org-keyword">if</span> (p.value.content.startsWith(<span class=
"org-string">'vue:'</span>)) {
<span class="linenr">22: </span>          <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">23: </span>        }
<span class="linenr">24: </span>      }
<span class="linenr">25: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">26: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">directive</span>
<span class="linenr">27: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-is (</span><span class="org-comment"><span class=
"org-bold"><span class=
"org-warning">TODO</span></span></span><span class=
"org-comment"> Deprecate)</span>
<span class="linenr">28: </span>      <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'is'</span>) {
<span class="linenr">29: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">30: </span>      }
<span class="linenr">31: </span>    }
<span class="linenr">32: </span>  }
<span class="linenr">33: </span>}
</pre>
          </div>
          <p>合并相邻的两个文本节点:</p>
          <div class="org-src-container">
            <pre class="src src-js" id="orgd7ffb0a"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">pushNode</span>(<span class=
            "org-variable-name">nodes</span>, <span class=
            "org-variable-name">node</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.TEXT) {
<span class="linenr"> 3: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prev</span> = last(nodes)
<span class="linenr"> 4: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Merge if both this and the previous node are text and those are</span>
<span class="linenr"> 5: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">consecutive. This happens for cases like "a &lt; b".</span>
<span class="linenr"> 6: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr"> 7: </span>      prev &amp;&
<span class=
"linenr"> 8: </span>      prev.type === NodeTypes.TEXT &amp;&
<span class=
"linenr"> 9: </span>      prev.loc.end.offset === node.loc.start.offset
<span class="linenr">10: </span>    ) {
<span class="linenr">11: </span>      prev.content += node.content
<span class="linenr">12: </span>      prev.loc.end = node.loc.end
<span class=
"linenr">13: </span>      prev.loc.source += node.loc.source
<span class="linenr">14: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">15: </span>    }
<span class="linenr">16: </span>  }
<span class="linenr">17: </span>
<span class="linenr">18: </span>  nodes.push(node)
<span class="linenr">19: </span>}
</pre>
          </div>
        </details><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">runtimeHelpers used in transform
            phase</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="org640db7b"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">FRAGMENT</span> = Symbol(__DEV__ ? <span class=
            "org-string">`Fragment`</span> : <span class=
            "org-string">``</span>)
<span class="linenr"> 2: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TELEPORT</span> = Symbol(__DEV__ ? <span class=
"org-string">`Teleport`</span> : <span class=
"org-string">``</span>)
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">SUSPENSE</span> = Symbol(__DEV__ ? <span class=
"org-string">`Suspense`</span> : <span class=
"org-string">``</span>)
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">KEEP_ALIVE</span> = Symbol(__DEV__ ? <span class="org-string">`KeepAlive`</span> : <span class="org-string">``</span>)
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">BASE_TRANSITION</span> = Symbol(__DEV__ ? <span class="org-string">`BaseTransition`</span> : <span class="org-string">``</span>)
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">OPEN_BLOCK</span> = Symbol(__DEV__ ? <span class="org-string">`openBlock`</span> : <span class="org-string">``</span>)
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_BLOCK</span> = Symbol(__DEV__ ? <span class="org-string">`createBlock`</span> : <span class="org-string">``</span>)
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_ELEMENT_BLOCK</span> = Symbol(__DEV__ ? <span class="org-string">`createElementBlock`</span> : <span class="org-string">``</span>)
<span class="linenr"> 9: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_VNODE</span> = Symbol(__DEV__ ? <span class="org-string">`createVNode`</span> : <span class="org-string">``</span>)
<span class="linenr">10: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_ELEMENT_VNODE</span> = Symbol(__DEV__ ? <span class="org-string">`createElementVNode`</span> : <span class="org-string">``</span>)
<span class="linenr">11: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_COMMENT</span> = Symbol(__DEV__ ? <span class="org-string">`createCommentVNode`</span> : <span class="org-string">``</span>)
<span class="linenr">12: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_TEXT</span> = Symbol(__DEV__ ? <span class="org-string">`createTextVNode`</span> : <span class="org-string">``</span>)
<span class="linenr">13: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_STATIC</span> = Symbol(__DEV__ ? <span class="org-string">`createStaticVNode`</span> : <span class="org-string">``</span>)
<span class="linenr">14: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">RESOLVE_COMPONENT</span> = Symbol(__DEV__ ? <span class="org-string">`resolveComponent`</span> : <span class="org-string">``</span>)
<span class="linenr">15: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">RESOLVE_DYNAMIC_COMPONENT</span> = Symbol(
<span class="linenr">16: </span>  __DEV__ ? <span class=
"org-string">`resolveDynamicComponent`</span> : <span class=
"org-string">``</span>
<span class="linenr">17: </span>)
<span class="linenr">18: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">RESOLVE_DIRECTIVE</span> = Symbol(__DEV__ ? <span class="org-string">`resolveDirective`</span> : <span class="org-string">``</span>)
<span class="linenr">19: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">RESOLVE_FILTER</span> = Symbol(__DEV__ ? <span class="org-string">`resolveFilter`</span> : <span class="org-string">``</span>)
<span class="linenr">20: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">WITH_DIRECTIVES</span> = Symbol(__DEV__ ? <span class="org-string">`withDirectives`</span> : <span class="org-string">``</span>)
<span class="linenr">21: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">RENDER_LIST</span> = Symbol(__DEV__ ? <span class="org-string">`renderList`</span> : <span class="org-string">``</span>)
<span class="linenr">22: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">RENDER_SLOT</span> = Symbol(__DEV__ ? <span class="org-string">`renderSlot`</span> : <span class="org-string">``</span>)
<span class="linenr">23: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CREATE_SLOTS</span> = Symbol(__DEV__ ? <span class="org-string">`createSlots`</span> : <span class="org-string">``</span>)
<span class="linenr">24: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TO_DISPLAY_STRING</span> = Symbol(__DEV__ ? <span class="org-string">`toDisplayString`</span> : <span class="org-string">``</span>)
<span class="linenr">25: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">MERGE_PROPS</span> = Symbol(__DEV__ ? <span class="org-string">`mergeProps`</span> : <span class="org-string">``</span>)
<span class="linenr">26: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NORMALIZE_CLASS</span> = Symbol(__DEV__ ? <span class="org-string">`normalizeClass`</span> : <span class="org-string">``</span>)
<span class="linenr">27: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NORMALIZE_STYLE</span> = Symbol(__DEV__ ? <span class="org-string">`normalizeStyle`</span> : <span class="org-string">``</span>)
<span class="linenr">28: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NORMALIZE_PROPS</span> = Symbol(__DEV__ ? <span class="org-string">`normalizeProps`</span> : <span class="org-string">``</span>)
<span class="linenr">29: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">GUARD_REACTIVE_PROPS</span> = Symbol(__DEV__ ? <span class="org-string">`guardReactiveProps`</span> : <span class="org-string">``</span>)
<span class="linenr">30: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TO_HANDLERS</span> = Symbol(__DEV__ ? <span class="org-string">`toHandlers`</span> : <span class="org-string">``</span>)
<span class="linenr">31: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CAMELIZE</span> = Symbol(__DEV__ ? <span class=
"org-string">`camelize`</span> : <span class=
"org-string">``</span>)
<span class="linenr">32: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">CAPITALIZE</span> = Symbol(__DEV__ ? <span class="org-string">`capitalize`</span> : <span class="org-string">``</span>)
<span class="linenr">33: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TO_HANDLER_KEY</span> = Symbol(__DEV__ ? <span class="org-string">`toHandlerKey`</span> : <span class="org-string">``</span>)
<span class="linenr">34: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">SET_BLOCK_TRACKING</span> = Symbol(__DEV__ ? <span class="org-string">`setBlockTracking`</span> : <span class="org-string">``</span>)
<span class="linenr">35: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">PUSH_SCOPE_ID</span> = Symbol(__DEV__ ? <span class="org-string">`pushScopeId`</span> : <span class="org-string">``</span>)
<span class="linenr">36: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">POP_SCOPE_ID</span> = Symbol(__DEV__ ? <span class="org-string">`popScopeId`</span> : <span class="org-string">``</span>)
<span class="linenr">37: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">WITH_CTX</span> = Symbol(__DEV__ ? <span class=
"org-string">`withCtx`</span> : <span class="org-string">``</span>)
<span class="linenr">38: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">UNREF</span> = Symbol(__DEV__ ? <span class=
"org-string">`unref`</span> : <span class="org-string">``</span>)
<span class="linenr">39: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">IS_REF</span> = Symbol(__DEV__ ? <span class=
"org-string">`isRef`</span> : <span class="org-string">``</span>)
<span class="linenr">40: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">WITH_MEMO</span> = Symbol(__DEV__ ? <span class="org-string">`withMemo`</span> : <span class="org-string">``</span>)
<span class="linenr">41: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">IS_MEMO_SAME</span> = Symbol(__DEV__ ? <span class="org-string">`isMemoSame`</span> : <span class="org-string">``</span>)
<span class="linenr">42: </span>
<span class="linenr">43: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Name mapping for runtime helpers that need to be imported from 'vue' in</span>
<span class="linenr">44: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generated code. Make sure these are correctly exported in the runtime!</span>
<span class="linenr">45: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Using `any` here because TS doesn't allow symbols as index type.</span>
<span class="linenr">46: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">helperNameMap</span> = {
<span class="linenr">47: </span>  [FRAGMENT]: <span class=
"org-string">`Fragment`</span>,
<span class="linenr">48: </span>  [TELEPORT]: <span class=
"org-string">`Teleport`</span>,
<span class="linenr">49: </span>  [SUSPENSE]: <span class=
"org-string">`Suspense`</span>,
<span class="linenr">50: </span>  [KEEP_ALIVE]: <span class=
"org-string">`KeepAlive`</span>,
<span class="linenr">51: </span>  [BASE_TRANSITION]: <span class=
"org-string">`BaseTransition`</span>,
<span class="linenr">52: </span>  [OPEN_BLOCK]: <span class=
"org-string">`openBlock`</span>,
<span class="linenr">53: </span>  [CREATE_BLOCK]: <span class=
"org-string">`createBlock`</span>,
<span class=
"linenr">54: </span>  [CREATE_ELEMENT_BLOCK]: <span class=
"org-string">`createElementBlock`</span>,
<span class="linenr">55: </span>  [CREATE_VNODE]: <span class=
"org-string">`createVNode`</span>,
<span class=
"linenr">56: </span>  [CREATE_ELEMENT_VNODE]: <span class=
"org-string">`createElementVNode`</span>,
<span class="linenr">57: </span>  [CREATE_COMMENT]: <span class=
"org-string">`createCommentVNode`</span>,
<span class="linenr">58: </span>  [CREATE_TEXT]: <span class=
"org-string">`createTextVNode`</span>,
<span class="linenr">59: </span>  [CREATE_STATIC]: <span class=
"org-string">`createStaticVNode`</span>,
<span class="linenr">60: </span>  [RESOLVE_COMPONENT]: <span class=
"org-string">`resolveComponent`</span>,
<span class=
"linenr">61: </span>  [RESOLVE_DYNAMIC_COMPONENT]: <span class=
"org-string">`resolveDynamicComponent`</span>,
<span class="linenr">62: </span>  [RESOLVE_DIRECTIVE]: <span class=
"org-string">`resolveDirective`</span>,
<span class="linenr">63: </span>  [RESOLVE_FILTER]: <span class=
"org-string">`resolveFilter`</span>,
<span class="linenr">64: </span>  [WITH_DIRECTIVES]: <span class=
"org-string">`withDirectives`</span>,
<span class="linenr">65: </span>  [RENDER_LIST]: <span class=
"org-string">`renderList`</span>,
<span class="linenr">66: </span>  [RENDER_SLOT]: <span class=
"org-string">`renderSlot`</span>,
<span class="linenr">67: </span>  [CREATE_SLOTS]: <span class=
"org-string">`createSlots`</span>,
<span class="linenr">68: </span>  [TO_DISPLAY_STRING]: <span class=
"org-string">`toDisplayString`</span>,
<span class="linenr">69: </span>  [MERGE_PROPS]: <span class=
"org-string">`mergeProps`</span>,
<span class="linenr">70: </span>  [NORMALIZE_CLASS]: <span class=
"org-string">`normalizeClass`</span>,
<span class="linenr">71: </span>  [NORMALIZE_STYLE]: <span class=
"org-string">`normalizeStyle`</span>,
<span class="linenr">72: </span>  [NORMALIZE_PROPS]: <span class=
"org-string">`normalizeProps`</span>,
<span class=
"linenr">73: </span>  [GUARD_REACTIVE_PROPS]: <span class=
"org-string">`guardReactiveProps`</span>,
<span class="linenr">74: </span>  [TO_HANDLERS]: <span class=
"org-string">`toHandlers`</span>,
<span class="linenr">75: </span>  [CAMELIZE]: <span class=
"org-string">`camelize`</span>,
<span class="linenr">76: </span>  [CAPITALIZE]: <span class=
"org-string">`capitalize`</span>,
<span class="linenr">77: </span>  [TO_HANDLER_KEY]: <span class=
"org-string">`toHandlerKey`</span>,
<span class=
"linenr">78: </span>  [SET_BLOCK_TRACKING]: <span class="org-string">`setBlockTracking`</span>,
<span class="linenr">79: </span>  [PUSH_SCOPE_ID]: <span class=
"org-string">`pushScopeId`</span>,
<span class="linenr">80: </span>  [POP_SCOPE_ID]: <span class=
"org-string">`popScopeId`</span>,
<span class="linenr">81: </span>  [WITH_CTX]: <span class=
"org-string">`withCtx`</span>,
<span class="linenr">82: </span>  [UNREF]: <span class=
"org-string">`unref`</span>,
<span class="linenr">83: </span>  [IS_REF]: <span class=
"org-string">`isRef`</span>,
<span class="linenr">84: </span>  [WITH_MEMO]: <span class=
"org-string">`withMemo`</span>,
<span class="linenr">85: </span>  [IS_MEMO_SAME]: <span class=
"org-string">`isMemoSame`</span>
<span class="linenr">86: </span>}
<span class="linenr">87: </span>
<span class="linenr">88: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">registerRuntimeHelpers</span>(<span class=
"org-variable-name">helpers</span>) {
<span class=
"linenr">89: </span>  Object.getOwnPropertySymbols(helpers).forEach(s =&gt; {
<span class="linenr">90: </span>    helperNameMap[s] = helpers[s]
<span class="linenr">91: </span>  })
<span class="linenr">92: </span>}
<span class="linenr">93: </span>
</pre>
          </div>
        </details><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">patchFlags</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="org9b40242"><span class=
            "linenr">  1: </span><span class="org-doc">/**</span>
<span class="linenr">  2: </span><span class=
"org-doc"> * Patch flags are optimization hints generated by the compiler.</span>
<span class="linenr">  3: </span><span class=
"org-doc"> * when a block with dynamicChildren is encountered during diff, the algorithm</span>
<span class="linenr">  4: </span><span class=
"org-doc"> * enters "optimized mode". In this mode, we know that the vdom is produced by</span>
<span class="linenr">  5: </span><span class=
"org-doc"> * a render function generated by the compiler, so the algorithm only needs to</span>
<span class="linenr">  6: </span><span class=
"org-doc"> * handle updates explicitly marked by these patch flags.</span>
<span class="linenr">  7: </span><span class="org-doc"> *</span>
<span class="linenr">  8: </span><span class=
"org-doc"> * Patch flags can be combined using the | bitwise operator and can be checked</span>
<span class="linenr">  9: </span><span class=
"org-doc"> * using the & operator, e.g.</span>
<span class="linenr"> 10: </span><span class="org-doc"> *</span>
<span class="linenr"> 11: </span><span class=
"org-doc"> * ```js</span>
<span class="linenr"> 12: </span><span class=
"org-doc"> * const flag = TEXT | CLASS</span>
<span class="linenr"> 13: </span><span class=
"org-doc"> * if (flag & TEXT) { ... }</span>
<span class="linenr"> 14: </span><span class=
"org-doc"> * ```</span>
<span class="linenr"> 15: </span><span class="org-doc"> *</span>
<span class="linenr"> 16: </span><span class=
"org-doc"> * Check the `patchElement` function in '../../runtime-core/src/renderer.ts' to see how the</span>
<span class="linenr"> 17: </span><span class=
"org-doc"> * flags are handled during diff.</span>
<span class="linenr"> 18: </span><span class="org-doc"> */</span>
<span class="linenr"> 19: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">PatchFlags</span> = {
<span class="linenr"> 20: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 21: </span><span class=
"org-doc">   * Indicates an element with dynamic textContent (children fast path)</span>
<span class="linenr"> 22: </span><span class="org-doc">   */</span>
<span class="linenr"> 23: </span>  TEXT: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 24: </span>
<span class="linenr"> 25: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 26: </span><span class=
"org-doc">   * Indicates an element with dynamic class binding.</span>
<span class="linenr"> 27: </span><span class="org-doc">   */</span>
<span class="linenr"> 28: </span>  CLASS: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 29: </span>
<span class="linenr"> 30: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 31: </span><span class=
"org-doc">   * Indicates an element with dynamic style</span>
<span class="linenr"> 32: </span><span class=
"org-doc">   * The compiler pre-compiles static string styles into static objects</span>
<span class="linenr"> 33: </span><span class=
"org-doc">   * + detects and hoists inline static objects</span>
<span class="linenr"> 34: </span><span class=
"org-doc">   * e.g. `style="color: red"` and `:style="{ color: 'red' }"` both get hoisted</span>
<span class="linenr"> 35: </span><span class=
"org-doc">   * as:</span>
<span class="linenr"> 36: </span><span class=
"org-doc">   * ```js</span>
<span class="linenr"> 37: </span><span class=
"org-doc">   * const style = { color: 'red' }</span>
<span class="linenr"> 38: </span><span class=
"org-doc">   * render() { return e('div', { style }) }</span>
<span class="linenr"> 39: </span><span class=
"org-doc">   * ```</span>
<span class="linenr"> 40: </span><span class="org-doc">   */</span>
<span class="linenr"> 41: </span>  STYLE: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 42: </span>
<span class="linenr"> 43: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 44: </span><span class=
"org-doc">   * Indicates an element that has non-class/style dynamic props.</span>
<span class="linenr"> 45: </span><span class=
"org-doc">   * Can also be on a component that has any dynamic props (includes</span>
<span class="linenr"> 46: </span><span class=
"org-doc">   * class/style). when this flag is present, the vnode also has a dynamicProps</span>
<span class="linenr"> 47: </span><span class=
"org-doc">   * array that contains the keys of the props that may change so the runtime</span>
<span class="linenr"> 48: </span><span class=
"org-doc">   * can diff them faster (without having to worry about removed props)</span>
<span class="linenr"> 49: </span><span class="org-doc">   */</span>
<span class="linenr"> 50: </span>  PROPS: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">3</span>,
<span class="linenr"> 51: </span>
<span class="linenr"> 52: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 53: </span><span class=
"org-doc">   * Indicates an element with props with dynamic keys. When keys change, a full</span>
<span class="linenr"> 54: </span><span class=
"org-doc">   * diff is always needed to remove the old key. This flag is mutually</span>
<span class="linenr"> 55: </span><span class=
"org-doc">   * exclusive with CLASS, STYLE and PROPS.</span>
<span class="linenr"> 56: </span><span class="org-doc">   */</span>
<span class="linenr"> 57: </span>  FULL_PROPS: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">4</span>,
<span class="linenr"> 58: </span>
<span class="linenr"> 59: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 60: </span><span class=
"org-doc">   * Indicates an element with event listeners (which need to be attached</span>
<span class="linenr"> 61: </span><span class=
"org-doc">   * during hydration)</span>
<span class="linenr"> 62: </span><span class="org-doc">   */</span>
<span class="linenr"> 63: </span>  HYDRATE_EVENTS: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">5</span>,
<span class="linenr"> 64: </span>
<span class="linenr"> 65: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 66: </span><span class=
"org-doc">   * Indicates a fragment whose children order doesn't change.</span>
<span class="linenr"> 67: </span><span class="org-doc">   */</span>
<span class="linenr"> 68: </span>  STABLE_FRAGMENT: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">6</span>,
<span class="linenr"> 69: </span>
<span class="linenr"> 70: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 71: </span><span class=
"org-doc">   * Indicates a fragment with keyed or partially keyed children</span>
<span class="linenr"> 72: </span><span class="org-doc">   */</span>
<span class="linenr"> 73: </span>  KEYED_FRAGMENT: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">7</span>,
<span class="linenr"> 74: </span>
<span class="linenr"> 75: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 76: </span><span class=
"org-doc">   * Indicates a fragment with unkeyed children.</span>
<span class="linenr"> 77: </span><span class="org-doc">   */</span>
<span class="linenr"> 78: </span>  UNKEYED_FRAGMENT: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">8</span>,
<span class="linenr"> 79: </span>
<span class="linenr"> 80: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 81: </span><span class=
"org-doc">   * Indicates an element that only needs non-props patching, e.g. ref or</span>
<span class="linenr"> 82: </span><span class=
"org-doc">   * directives (onVnodeXXX hooks). since every patched vnode checks for refs</span>
<span class="linenr"> 83: </span><span class=
"org-doc">   * and onVnodeXXX hooks, it simply marks the vnode so that a parent block</span>
<span class="linenr"> 84: </span><span class=
"org-doc">   * will track it.</span>
<span class="linenr"> 85: </span><span class="org-doc">   */</span>
<span class="linenr"> 86: </span>  NEED_PATCH: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">9</span>,
<span class="linenr"> 87: </span>
<span class="linenr"> 88: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 89: </span><span class=
"org-doc">   * Indicates a component with dynamic slots (e.g. slot that references a v-for</span>
<span class="linenr"> 90: </span><span class=
"org-doc">   * iterated value, or dynamic slot names).</span>
<span class="linenr"> 91: </span><span class=
"org-doc">   * Components with this flag are always force updated.</span>
<span class="linenr"> 92: </span><span class="org-doc">   */</span>
<span class="linenr"> 93: </span>  DYNAMIC_SLOTS: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">10</span>,
<span class="linenr"> 94: </span>
<span class="linenr"> 95: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 96: </span><span class=
"org-doc">   * Indicates a fragment that was created only because the user has placed</span>
<span class="linenr"> 97: </span><span class=
"org-doc">   * comments at the root level of a template. This is a dev-only flag since</span>
<span class="linenr"> 98: </span><span class=
"org-doc">   * comments are stripped in production.</span>
<span class="linenr"> 99: </span><span class="org-doc">   */</span>
<span class="linenr">100: </span>  DEV_ROOT_FRAGMENT: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">11</span>,
<span class="linenr">101: </span>
<span class="linenr">102: </span>  <span class="org-doc">/**</span>
<span class="linenr">103: </span><span class=
"org-doc">   * SPECIAL FLAGS -------------------------------------------------------------</span>
<span class="linenr">104: </span><span class=
"org-doc">   * Special flags are negative integers. They are never matched against using</span>
<span class="linenr">105: </span><span class=
"org-doc">   * bitwise operators (bitwise matching should only happen in branches where</span>
<span class="linenr">106: </span><span class=
"org-doc">   * patchFlag &gt; 0), and are mutually exclusive. When checking for a special</span>
<span class="linenr">107: </span><span class=
"org-doc">   * flag, simply check patchFlag === FLAG.</span>
<span class="linenr">108: </span><span class="org-doc">   */</span>
<span class="linenr">109: </span>
<span class="linenr">110: </span>  <span class="org-doc">/**</span>
<span class="linenr">111: </span><span class=
"org-doc">   * Indicates a hoisted static vnode. This is a hint for hydration to skip</span>
<span class="linenr">112: </span><span class=
"org-doc">   * the entire sub tree since static content never needs to be updated.</span>
<span class="linenr">113: </span><span class="org-doc">   */</span>
<span class="linenr">114: </span>  HOISTED: -<span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">115: </span>  <span class="org-doc">/**</span>
<span class="linenr">116: </span><span class=
"org-doc">   * A special flag that indicates that the diffing algorithm should bail out</span>
<span class="linenr">117: </span><span class=
"org-doc">   * of optimized mode. For example, on block fragments created by renderSlot()</span>
<span class="linenr">118: </span><span class=
"org-doc">   * when encountering non-compiler generated slots (i.e. manually written</span>
<span class="linenr">119: </span><span class=
"org-doc">   * render functions, which should always be fully diffed)</span>
<span class="linenr">120: </span><span class=
"org-doc">   * OR manually cloneVNodes</span>
<span class="linenr">121: </span><span class="org-doc">   */</span>
<span class="linenr">122: </span>  BAIL: -<span class=
"org-highlight-numbers-number">2</span>
<span class="linenr">123: </span>}
<span class="linenr">124: </span>
<span class="linenr">125: </span><span class="org-doc">/**</span>
<span class="linenr">126: </span><span class=
"org-doc"> * dev only flag -&gt; name mapping</span>
<span class="linenr">127: </span><span class="org-doc"> */</span>
<span class="linenr">128: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">PatchFlagNames</span> = {
<span class="linenr">129: </span>  [PatchFlags.TEXT]: <span class=
"org-string">`TEXT`</span>,
<span class="linenr">130: </span>  [PatchFlags.CLASS]: <span class=
"org-string">`CLASS`</span>,
<span class="linenr">131: </span>  [PatchFlags.STYLE]: <span class=
"org-string">`STYLE`</span>,
<span class="linenr">132: </span>  [PatchFlags.PROPS]: <span class=
"org-string">`PROPS`</span>,
<span class=
"linenr">133: </span>  [PatchFlags.FULL_PROPS]: <span class=
"org-string">`FULL_PROPS`</span>,
<span class=
"linenr">134: </span>  [PatchFlags.HYDRATE_EVENTS]: <span class=
"org-string">`HYDRATE_EVENTS`</span>,
<span class=
"linenr">135: </span>  [PatchFlags.STABLE_FRAGMENT]: <span class=
"org-string">`STABLE_FRAGMENT`</span>,
<span class=
"linenr">136: </span>  [PatchFlags.KEYED_FRAGMENT]: <span class=
"org-string">`KEYED_FRAGMENT`</span>,
<span class=
"linenr">137: </span>  [PatchFlags.UNKEYED_FRAGMENT]: <span class=
"org-string">`UNKEYED_FRAGMENT`</span>,
<span class=
"linenr">138: </span>  [PatchFlags.NEED_PATCH]: <span class=
"org-string">`NEED_PATCH`</span>,
<span class=
"linenr">139: </span>  [PatchFlags.DYNAMIC_SLOTS]: <span class=
"org-string">`DYNAMIC_SLOTS`</span>,
<span class=
"linenr">140: </span>  [PatchFlags.DEV_ROOT_FRAGMENT]: <span class=
"org-string">`DEV_ROOT_FRAGMENT`</span>,
<span class=
"linenr">141: </span>  [PatchFlags.HOISTED]: <span class=
"org-string">`HOISTED`</span>,
<span class="linenr">142: </span>  [PatchFlags.BAIL]: <span class=
"org-string">`BAIL`</span>
<span class="linenr">143: </span>}
<span class="linenr">144: </span>
</pre>
          </div>
        </details><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">injectProp</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="org9ba8899"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">propsHelperSet</span> = <span class=
            "org-keyword">new</span> <span class=
            "org-type">Set</span>([NORMALIZE_PROPS, GUARD_REACTIVE_PROPS])
<span class="linenr">  2: </span>
<span class="linenr">  3: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getUnnormalizedProps</span>(<span class=
"org-variable-name">props</span>, <span class=
"org-variable-name">callPath</span> = []) {
<span class="linenr">  4: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr">  5: </span>    props &amp;&
<span class="linenr">  6: </span>    !isString(props) &amp;&
<span class=
"linenr">  7: </span>    props.type === NodeTypes.JS_CALL_EXPRESSION
<span class="linenr">  8: </span>  ) {
<span class="linenr">  9: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">callee</span> = props.callee
<span class="linenr"> 10: </span>    <span class=
"org-keyword">if</span> (!isString(callee) &amp;& propsHelperSet.has(callee)) {
<span class="linenr"> 11: </span>      <span class=
"org-keyword">return</span> getUnnormalizedProps(
<span class="linenr"> 12: </span>        props.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">0</span>],
<span class="linenr"> 13: </span>        callPath.concat(props)
<span class="linenr"> 14: </span>      )
<span class="linenr"> 15: </span>    }
<span class="linenr"> 16: </span>  }
<span class="linenr"> 17: </span>  <span class=
"org-keyword">return</span> [props, callPath]
<span class="linenr"> 18: </span>}
<span class="linenr"> 19: </span>
<span class="linenr"> 20: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">injectProp</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">prop</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr"> 21: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">propsWithInjection</span>
<span class="linenr"> 22: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 23: </span><span class=
"org-doc">   * 1. mergeProps(...)</span>
<span class="linenr"> 24: </span><span class=
"org-doc">   * 2. toHandlers(...)</span>
<span class="linenr"> 25: </span><span class=
"org-doc">   * 3. normalizeProps(...)</span>
<span class="linenr"> 26: </span><span class=
"org-doc">   * 4. normalizeProps(guardReactiveProps(...))</span>
<span class="linenr"> 27: </span><span class="org-doc">   *</span>
<span class="linenr"> 28: </span><span class=
"org-doc">   * we need to get the real props before normalization</span>
<span class="linenr"> 29: </span><span class="org-doc">   */</span>
<span class="linenr"> 30: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">props</span> =
<span class=
"linenr"> 31: </span>    node.type === NodeTypes.VNODE_CALL ? node.props : node.<span class="org-constant">arguments</span>[<span class="org-highlight-numbers-number">2</span>]
<span class="linenr"> 32: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">callPath</span> = []
<span class="linenr"> 33: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">parentCall</span>
<span class="linenr"> 34: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr"> 35: </span>    props &amp;&
<span class="linenr"> 36: </span>    !isString(props) &amp;&
<span class=
"linenr"> 37: </span>    props.type === NodeTypes.JS_CALL_EXPRESSION
<span class="linenr"> 38: </span>  ) {
<span class="linenr"> 39: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ret</span> = getUnnormalizedProps(props)
<span class="linenr"> 40: </span>    props = ret[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 41: </span>    callPath = ret[<span class=
"org-highlight-numbers-number">1</span>]
<span class=
"linenr"> 42: </span>    parentCall = callPath[callPath.length - <span class="org-highlight-numbers-number">1</span>]
<span class="linenr"> 43: </span>  }
<span class="linenr"> 44: </span>
<span class="linenr"> 45: </span>  <span class=
"org-keyword">if</span> (props == <span class=
"org-constant">null</span> || isString(props)) {
<span class=
"linenr"> 46: </span>    propsWithInjection = createObjectExpression([prop])
<span class="linenr"> 47: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (props.type === NodeTypes.JS_CALL_EXPRESSION) {
<span class="linenr"> 48: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">merged props... add ours</span>
<span class="linenr"> 49: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">only inject key to object literal if it's the first argument so that</span>
<span class="linenr"> 50: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if doesn't override user provided keys</span>
<span class="linenr"> 51: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">first</span> = props.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">0</span>] | JSChildNode
<span class="linenr"> 52: </span>    <span class=
"org-keyword">if</span> (!isString(first) &amp;& first.type === NodeTypes.JS_OBJECT_EXPRESSION) {
<span class=
"linenr"> 53: </span>      first.properties.unshift(prop)
<span class="linenr"> 54: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 55: </span>      <span class=
"org-keyword">if</span> (props.callee === TO_HANDLERS) {
<span class="linenr"> 56: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#2366</span>
<span class=
"linenr"> 57: </span>        propsWithInjection = createCallExpression(context.helper(MERGE_PROPS), [
<span class=
"linenr"> 58: </span>          createObjectExpression([prop]),
<span class="linenr"> 59: </span>          props
<span class="linenr"> 60: </span>        ])
<span class="linenr"> 61: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr"> 62: </span>        props.<span class=
"org-constant">arguments</span>.unshift(createObjectExpression([prop]))
<span class="linenr"> 63: </span>      }
<span class="linenr"> 64: </span>    }
<span class=
"linenr"> 65: </span>    !propsWithInjection &amp;& (propsWithInjection = props)
<span class="linenr"> 66: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (props.type === NodeTypes.JS_OBJECT_EXPRESSION) {
<span class="linenr"> 67: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">alreadyExists</span> = <span class=
"org-constant">false</span>
<span class="linenr"> 68: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check existing key to avoid overriding user provided keys</span>
<span class="linenr"> 69: </span>    <span class=
"org-keyword">if</span> (prop.key.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr"> 70: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">propKeyName</span> = prop.key.content
<span class=
"linenr"> 71: </span>      alreadyExists = props.properties.some(
<span class="linenr"> 72: </span>        p =&gt;
<span class=
"linenr"> 73: </span>          p.key.type === NodeTypes.SIMPLE_EXPRESSION &amp;&
<span class=
"linenr"> 74: </span>          p.key.content === propKeyName
<span class="linenr"> 75: </span>      )
<span class="linenr"> 76: </span>    }
<span class="linenr"> 77: </span>    <span class=
"org-keyword">if</span> (!alreadyExists) {
<span class=
"linenr"> 78: </span>      props.properties.unshift(prop)
<span class="linenr"> 79: </span>    }
<span class="linenr"> 80: </span>    propsWithInjection = props
<span class="linenr"> 81: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr"> 82: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single v-bind with expression, return a merged replacement</span>
<span class=
"linenr"> 83: </span>    propsWithInjection = createCallExpression(context.helper(MERGE_PROPS), [
<span class=
"linenr"> 84: </span>      createObjectExpression([prop]),
<span class="linenr"> 85: </span>      props
<span class="linenr"> 86: </span>    ])
<span class="linenr"> 87: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in the case of nested helper call, e.g. `normalizeProps(guardReactiveProps(props))`,</span>
<span class="linenr"> 88: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">it will be rewritten as `normalizeProps(mergeProps({ key: 0 }, props))`,</span>
<span class="linenr"> 89: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the `guardReactiveProps` will no longer be needed</span>
<span class="linenr"> 90: </span>    <span class=
"org-keyword">if</span> (parentCall &amp;& parentCall.callee === GUARD_REACTIVE_PROPS) {
<span class=
"linenr"> 91: </span>      parentCall = callPath[callPath.length - <span class="org-highlight-numbers-number">2</span>]
<span class="linenr"> 92: </span>    }
<span class="linenr"> 93: </span>  }
<span class="linenr"> 94: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.VNODE_CALL) {
<span class="linenr"> 95: </span>    <span class=
"org-keyword">if</span> (parentCall) {
<span class="linenr"> 96: </span>      parentCall.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">0</span>] = propsWithInjection
<span class="linenr"> 97: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 98: </span>      node.props = propsWithInjection
<span class="linenr"> 99: </span>    }
<span class="linenr">100: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">101: </span>    <span class=
"org-keyword">if</span> (parentCall) {
<span class="linenr">102: </span>      parentCall.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">0</span>] = propsWithInjection
<span class="linenr">103: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">104: </span>      node.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">2</span>] = propsWithInjection
<span class="linenr">105: </span>    }
<span class="linenr">106: </span>  }
<span class="linenr">107: </span>}
</pre>
          </div>
        </details><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">BindingTypes</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="org9f714d6"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">BindingTypes</span> = {
<span class="linenr"> 2: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 3: </span><span class=
"org-doc">   * returned from data()</span>
<span class="linenr"> 4: </span><span class="org-doc">   */</span>
<span class="linenr"> 5: </span>  DATA: <span class=
"org-string">'data'</span>,
<span class="linenr"> 6: </span>  <span class="org-doc">/**</span>
<span class="linenr"> 7: </span><span class=
"org-doc">   * declared as a prop</span>
<span class="linenr"> 8: </span><span class="org-doc">   */</span>
<span class="linenr"> 9: </span>  PROPS: <span class=
"org-string">'props'</span>,
<span class="linenr">10: </span>  <span class="org-doc">/**</span>
<span class="linenr">11: </span><span class=
"org-doc">   * a local alias of a `&lt;script setup&gt;` destructured prop.</span>
<span class="linenr">12: </span><span class=
"org-doc">   * the original is stored in __propsAliases of the bindingMetadata object.</span>
<span class="linenr">13: </span><span class="org-doc">   */</span>
<span class="linenr">14: </span>  PROPS_ALIASED: <span class=
"org-string">'props-aliased'</span>,
<span class="linenr">15: </span>  <span class="org-doc">/**</span>
<span class="linenr">16: </span><span class=
"org-doc">   * a let binding (may or may not be a ref)</span>
<span class="linenr">17: </span><span class="org-doc">   */</span>
<span class="linenr">18: </span>  SETUP_LET: <span class=
"org-string">'setup-let'</span>,
<span class="linenr">19: </span>  <span class="org-doc">/**</span>
<span class="linenr">20: </span><span class=
"org-doc">   * a const binding that can never be a ref.</span>
<span class="linenr">21: </span><span class=
"org-doc">   * these bindings don't need `unref()` calls when processed in inlined</span>
<span class="linenr">22: </span><span class=
"org-doc">   * template expressions.</span>
<span class="linenr">23: </span><span class="org-doc">   */</span>
<span class="linenr">24: </span>  SETUP_CONST: <span class=
"org-string">'setup-const'</span>,
<span class="linenr">25: </span>  <span class="org-doc">/**</span>
<span class="linenr">26: </span><span class=
"org-doc">   * a const binding that may be a ref.</span>
<span class="linenr">27: </span><span class="org-doc">   */</span>
<span class="linenr">28: </span>  SETUP_MAYBE_REF: <span class=
"org-string">'setup-maybe-ref'</span>,
<span class="linenr">29: </span>  <span class="org-doc">/**</span>
<span class="linenr">30: </span><span class=
"org-doc">   * bindings that are guaranteed to be refs</span>
<span class="linenr">31: </span><span class="org-doc">   */</span>
<span class="linenr">32: </span>  SETUP_REF: <span class=
"org-string">'setup-ref'</span>,
<span class="linenr">33: </span>  <span class="org-doc">/**</span>
<span class="linenr">34: </span><span class=
"org-doc">   * declared by other options, e.g. computed, inject</span>
<span class="linenr">35: </span><span class="org-doc">   */</span>
<span class="linenr">36: </span>  OPTIONS: <span class=
"org-string">'options'</span>
<span class="linenr">37: </span>}
</pre>
          </div>
        </details><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">babelUtils</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="orgfd6463d"><span class=
            "linenr">  1: </span>&lt;&lt;estree-walker&gt;&gt;
<span class="linenr">  2: </span>
<span class="linenr">  3: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isInDestructureAssignment</span>(
<span class="linenr">  4: </span>  <span class=
"org-variable-name">parent</span>,
<span class="linenr">  5: </span>  parentStack
<span class="linenr">  6: </span>) {
<span class="linenr">  7: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr">  8: </span>    parent &amp;&
<span class="linenr">  9: </span>    (parent.type === <span class=
"org-string">'ObjectProperty'</span> || parent.type === <span class="org-string">'ArrayPattern'</span>)
<span class="linenr"> 10: </span>  ) {
<span class="linenr"> 11: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = parentStack.length
<span class="linenr"> 12: </span>    <span class=
"org-keyword">while</span> (i--) {
<span class="linenr"> 13: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = parentStack[i]
<span class="linenr"> 14: </span>      <span class=
"org-keyword">if</span> (p.type === <span class=
"org-string">'AssignmentExpression'</span>) {
<span class="linenr"> 15: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr"> 16: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (p.type !== <span class=
"org-string">'ObjectProperty'</span> &amp;& !p.type.endsWith(<span class="org-string">'Pattern'</span>)) {
<span class="linenr"> 17: </span>        <span class=
"org-keyword">break</span>
<span class="linenr"> 18: </span>      }
<span class="linenr"> 19: </span>    }
<span class="linenr"> 20: </span>  }
<span class="linenr"> 21: </span>  <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr"> 22: </span>}
<span class="linenr"> 23: </span>
<span class="linenr"> 24: </span>
<span class="linenr"> 25: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">walkIdentifiers</span>(
<span class="linenr"> 26: </span>  <span class=
"org-variable-name">root</span>,
<span class="linenr"> 27: </span>  <span class=
"org-variable-name">onIdentifier</span>,
<span class="linenr"> 28: </span>  includeAll = <span class=
"org-constant">false</span>,
<span class="linenr"> 29: </span>  parentStack = [],
<span class=
"linenr"> 30: </span>  knownIds = Object.create(<span class=
"org-constant">null</span>)
<span class="linenr"> 31: </span>) {
<span class="linenr"> 32: </span>  <span class=
"org-keyword">if</span> (__BROWSER__) {
<span class="linenr"> 33: </span>    <span class=
"org-keyword">return</span>
<span class="linenr"> 34: </span>  }
<span class="linenr"> 35: </span>
<span class="linenr"> 36: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rootExp</span> =
<span class="linenr"> 37: </span>    root.type === <span class=
"org-string">'Program'</span> &amp;&
<span class="linenr"> 38: </span>    root.body[<span class=
"org-highlight-numbers-number">0</span>].type === <span class=
"org-string">'ExpressionStatement'</span> &amp;&
<span class="linenr"> 39: </span>    root.body[<span class=
"org-highlight-numbers-number">0</span>].expression
<span class="linenr"> 40: </span>
<span class="linenr"> 41: </span>  walk(root, {
<span class="linenr"> 42: </span>    enter(node, parent) {
<span class=
"linenr"> 43: </span>      parent &amp;& parentStack.push(parent)
<span class="linenr"> 44: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr"> 45: </span>        parent &amp;&
<span class=
"linenr"> 46: </span>        parent.type.startsWith(<span class=
"org-string">'TS'</span>) &amp;&
<span class=
"linenr"> 47: </span>        parent.type !== <span class=
"org-string">'TSAsExpression'</span> &amp;&
<span class=
"linenr"> 48: </span>        parent.type !== <span class=
"org-string">'TSNonNullExpression'</span> &amp;&
<span class=
"linenr"> 49: </span>        parent.type !== <span class=
"org-string">'TSTypeAssertion'</span>
<span class="linenr"> 50: </span>      ) {
<span class="linenr"> 51: </span>        <span class=
"org-keyword">return</span> <span class=
"org-constant">this</span>.skip()
<span class="linenr"> 52: </span>      }
<span class="linenr"> 53: </span>      <span class=
"org-keyword">if</span> (node.type === <span class=
"org-string">'Identifier'</span>) {
<span class="linenr"> 54: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isLocal</span> = !!knownIds[node.name]
<span class="linenr"> 55: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isRefed</span> = isReferencedIdentifier(node, parent, parentStack)
<span class="linenr"> 56: </span>        <span class=
"org-keyword">if</span> (includeAll || (isRefed &amp;& !isLocal)) {
<span class=
"linenr"> 57: </span>          onIdentifier(node, parent, parentStack, isRefed, isLocal)
<span class="linenr"> 58: </span>        }
<span class="linenr"> 59: </span>      } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class="linenr"> 60: </span>        node.type === <span class=
"org-string">'ObjectProperty'</span> &amp;&
<span class=
"linenr"> 61: </span>        parent.type === <span class=
"org-string">'ObjectPattern'</span>
<span class="linenr"> 62: </span>      ) {
<span class="linenr"> 63: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mark property in destructure pattern</span>
<span class=
"linenr"> 64: </span>        node.inPattern = <span class=
"org-constant">true</span>
<span class="linenr"> 65: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isFunctionType(node)) {
<span class="linenr"> 66: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">walk function expressions and add its arguments to known identifiers</span>
<span class="linenr"> 67: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so that we don't prefix them</span>
<span class=
"linenr"> 68: </span>        walkFunctionParams(node, id =&gt; markScopeIdentifier(node, id, knownIds))
<span class="linenr"> 69: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.type === <span class=
"org-string">'BlockStatement'</span>) {
<span class="linenr"> 70: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#3445 record block-level local variables</span>
<span class=
"linenr"> 71: </span>        walkBlockDeclarations(node, id =&gt;
<span class=
"linenr"> 72: </span>          markScopeIdentifier(node, id, knownIds)
<span class="linenr"> 73: </span>        )
<span class="linenr"> 74: </span>      }
<span class="linenr"> 75: </span>    },
<span class="linenr"> 76: </span>    leave(node, parent) {
<span class=
"linenr"> 77: </span>      parent &amp;& parentStack.pop()
<span class="linenr"> 78: </span>      <span class=
"org-keyword">if</span> (node !== rootExp &amp;& node.scopeIds) {
<span class="linenr"> 79: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">id</span> <span class=
"org-keyword">of</span> node.scopeIds) {
<span class="linenr"> 80: </span>          knownIds[id]--
<span class="linenr"> 81: </span>          <span class=
"org-keyword">if</span> (knownIds[id] === <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr"> 82: </span>            <span class=
"org-keyword">delete</span> knownIds[id]
<span class="linenr"> 83: </span>          }
<span class="linenr"> 84: </span>        }
<span class="linenr"> 85: </span>      }
<span class="linenr"> 86: </span>    }
<span class="linenr"> 87: </span>  })
<span class="linenr"> 88: </span>}
<span class="linenr"> 89: </span>
<span class="linenr"> 90: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isReferencedIdentifier</span>(
<span class="linenr"> 91: </span>  <span class=
"org-variable-name">id</span>,
<span class="linenr"> 92: </span>  <span class=
"org-variable-name">parent</span>,
<span class="linenr"> 93: </span>  parentStack
<span class="linenr"> 94: </span>) {
<span class="linenr"> 95: </span>  <span class=
"org-keyword">if</span> (__BROWSER__) {
<span class="linenr"> 96: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr"> 97: </span>  }
<span class="linenr"> 98: </span>
<span class="linenr"> 99: </span>  <span class=
"org-keyword">if</span> (!parent) {
<span class="linenr">100: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">101: </span>  }
<span class="linenr">102: </span>
<span class="linenr">103: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">is a special keyword but parsed as identifier</span>
<span class="linenr">104: </span>  <span class=
"org-keyword">if</span> (id.name === <span class=
"org-string">'arguments'</span>) {
<span class="linenr">105: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">106: </span>  }
<span class="linenr">107: </span>
<span class="linenr">108: </span>  <span class=
"org-keyword">if</span> (isReferenced(id, parent)) {
<span class="linenr">109: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">110: </span>  }
<span class="linenr">111: </span>
<span class="linenr">112: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">babel's isReferenced check returns false for ids being assigned to, so we</span>
<span class="linenr">113: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">need to cover those cases here</span>
<span class="linenr">114: </span>  <span class=
"org-keyword">switch</span> (parent.type) {
<span class="linenr">115: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'AssignmentExpression'</span>:
<span class="linenr">116: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'AssignmentPattern'</span>:
<span class="linenr">117: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">118: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ObjectPattern'</span>:
<span class="linenr">119: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ArrayPattern'</span>:
<span class="linenr">120: </span>      <span class=
"org-keyword">return</span> isInDestructureAssignment(parent, parentStack)
<span class="linenr">121: </span>  }
<span class="linenr">122: </span>
<span class="linenr">123: </span>  <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">124: </span>}
<span class="linenr">125: </span>
<span class="linenr">126: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isInDestructureAssignment</span>(
<span class="linenr">127: </span>  <span class=
"org-variable-name">parent</span>,
<span class="linenr">128: </span>  parentStack
<span class="linenr">129: </span>) {
<span class="linenr">130: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr">131: </span>    parent &amp;&
<span class="linenr">132: </span>    (parent.type === <span class=
"org-string">'ObjectProperty'</span> || parent.type === <span class="org-string">'ArrayPattern'</span>)
<span class="linenr">133: </span>  ) {
<span class="linenr">134: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = parentStack.length
<span class="linenr">135: </span>    <span class=
"org-keyword">while</span> (i--) {
<span class="linenr">136: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = parentStack[i]
<span class="linenr">137: </span>      <span class=
"org-keyword">if</span> (p.type === <span class=
"org-string">'AssignmentExpression'</span>) {
<span class="linenr">138: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">139: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (p.type !== <span class=
"org-string">'ObjectProperty'</span> &amp;& !p.type.endsWith(<span class="org-string">'Pattern'</span>)) {
<span class="linenr">140: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">141: </span>      }
<span class="linenr">142: </span>    }
<span class="linenr">143: </span>  }
<span class="linenr">144: </span>  <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">145: </span>}
<span class="linenr">146: </span>
<span class="linenr">147: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">walkFunctionParams</span>(
<span class="linenr">148: </span>  <span class=
"org-variable-name">node</span>,
<span class="linenr">149: </span>  onIdent
<span class="linenr">150: </span>) {
<span class="linenr">151: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> <span class=
"org-keyword">of</span> node.params) {
<span class="linenr">152: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">id</span> <span class=
"org-keyword">of</span> extractIdentifiers(p)) {
<span class="linenr">153: </span>      onIdent(id)
<span class="linenr">154: </span>    }
<span class="linenr">155: </span>  }
<span class="linenr">156: </span>}
<span class="linenr">157: </span>
<span class="linenr">158: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">walkBlockDeclarations</span>(
<span class="linenr">159: </span>  <span class=
"org-variable-name">block</span>,
<span class="linenr">160: </span>  onIdent
<span class="linenr">161: </span>) {
<span class="linenr">162: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">stmt</span> <span class=
"org-keyword">of</span> block.body) {
<span class="linenr">163: </span>    <span class=
"org-keyword">if</span> (stmt.type === <span class=
"org-string">'VariableDeclaration'</span>) {
<span class="linenr">164: </span>      <span class=
"org-keyword">if</span> (stmt.declare) <span class=
"org-keyword">continue</span>
<span class="linenr">165: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">decl</span> <span class=
"org-keyword">of</span> stmt.declarations) {
<span class="linenr">166: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">id</span> <span class=
"org-keyword">of</span> extractIdentifiers(decl.id)) {
<span class="linenr">167: </span>          onIdent(id)
<span class="linenr">168: </span>        }
<span class="linenr">169: </span>      }
<span class="linenr">170: </span>    } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class="linenr">171: </span>      stmt.type === <span class=
"org-string">'FunctionDeclaration'</span> ||
<span class="linenr">172: </span>      stmt.type === <span class=
"org-string">'ClassDeclaration'</span>
<span class="linenr">173: </span>    ) {
<span class="linenr">174: </span>      <span class=
"org-keyword">if</span> (stmt.declare || !stmt.id) <span class=
"org-keyword">continue</span>
<span class="linenr">175: </span>      onIdent(stmt.id)
<span class="linenr">176: </span>    }
<span class="linenr">177: </span>  }
<span class="linenr">178: </span>}
<span class="linenr">179: </span>
<span class="linenr">180: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">extractIdentifiers</span>(
<span class="linenr">181: </span>  <span class=
"org-variable-name">param</span>,
<span class="linenr">182: </span>  nodes = []
<span class="linenr">183: </span>) {
<span class="linenr">184: </span>  <span class=
"org-keyword">switch</span> (param.type) {
<span class="linenr">185: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'Identifier'</span>:
<span class="linenr">186: </span>      nodes.push(param)
<span class="linenr">187: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">188: </span>
<span class="linenr">189: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'MemberExpression'</span>:
<span class="linenr">190: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">object</span> = param
<span class="linenr">191: </span>      <span class=
"org-keyword">while</span> (object.type === <span class=
"org-string">'MemberExpression'</span>) {
<span class="linenr">192: </span>        object = object.object
<span class="linenr">193: </span>      }
<span class="linenr">194: </span>      nodes.push(object)
<span class="linenr">195: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">196: </span>
<span class="linenr">197: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ObjectPattern'</span>:
<span class="linenr">198: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">prop</span> <span class=
"org-keyword">of</span> param.properties) {
<span class="linenr">199: </span>        <span class=
"org-keyword">if</span> (prop.type === <span class=
"org-string">'RestElement'</span>) {
<span class=
"linenr">200: </span>          extractIdentifiers(prop.argument, nodes)
<span class="linenr">201: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">202: </span>          extractIdentifiers(prop.value, nodes)
<span class="linenr">203: </span>        }
<span class="linenr">204: </span>      }
<span class="linenr">205: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">206: </span>
<span class="linenr">207: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ArrayPattern'</span>:
<span class=
"linenr">208: </span>      param.elements.forEach(element =&gt; {
<span class="linenr">209: </span>        <span class=
"org-keyword">if</span> (element) extractIdentifiers(element, nodes)
<span class="linenr">210: </span>      })
<span class="linenr">211: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">212: </span>
<span class="linenr">213: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'RestElement'</span>:
<span class=
"linenr">214: </span>      extractIdentifiers(param.argument, nodes)
<span class="linenr">215: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">216: </span>
<span class="linenr">217: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'AssignmentPattern'</span>:
<span class=
"linenr">218: </span>      extractIdentifiers(param.left, nodes)
<span class="linenr">219: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">220: </span>  }
<span class="linenr">221: </span>
<span class="linenr">222: </span>  <span class=
"org-keyword">return</span> nodes
<span class="linenr">223: </span>}
<span class="linenr">224: </span>
<span class="linenr">225: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">markScopeIdentifier</span>(
<span class="linenr">226: </span>  <span class=
"org-variable-name">node</span>,
<span class="linenr">227: </span>  <span class=
"org-variable-name">child</span>,
<span class="linenr">228: </span>  knownIds
<span class="linenr">229: </span>) {
<span class="linenr">230: </span>  <span class=
"org-keyword">const</span> { name } = child
<span class="linenr">231: </span>  <span class=
"org-keyword">if</span> (node.scopeIds &amp;& node.scopeIds.has(name)) {
<span class="linenr">232: </span>    <span class=
"org-keyword">return</span>
<span class="linenr">233: </span>  }
<span class="linenr">234: </span>  <span class=
"org-keyword">if</span> (name <span class=
"org-keyword">in</span> knownIds) {
<span class="linenr">235: </span>    knownIds[name]++
<span class="linenr">236: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">237: </span>    knownIds[name] = <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">238: </span>  }
<span class=
"linenr">239: </span>  ;(node.scopeIds || (node.scopeIds = <span class="org-keyword">new</span> <span class="org-type">Set</span>())).add(name)
<span class="linenr">240: </span>}
<span class="linenr">241: </span>
<span class="linenr">242: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isFunctionType</span> = (node) =&gt; {
<span class="linenr">243: </span>  <span class=
"org-keyword">return</span> <span class=
"org-string">/Function(?:Expression|Declaration)$|Method$/</span>.test(node.type)
<span class="linenr">244: </span>}
<span class="linenr">245: </span>
<span class="linenr">246: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStaticProperty</span> = (node) =&gt;
<span class="linenr">247: </span>  node &amp;&
<span class="linenr">248: </span>  (node.type === <span class=
"org-string">'ObjectProperty'</span> || node.type === <span class=
"org-string">'ObjectMethod'</span>) &amp;&
<span class="linenr">249: </span>  !node.computed
<span class="linenr">250: </span>
<span class="linenr">251: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStaticPropertyKey</span> = (node, parent) =&gt; isStaticProperty(parent) &amp;& parent.key === node
<span class="linenr">252: </span>
<span class="linenr">253: </span><span class="org-doc">/**</span>
<span class="linenr">254: </span><span class=
"org-doc"> * Copied from https://github.com/babel/babel/blob/main/packages/babel-types/src/validators/isReferenced.ts</span>
<span class="linenr">255: </span><span class=
"org-doc"> * To avoid runtime dependency on @babel/types (which includes process references)</span>
<span class="linenr">256: </span><span class=
"org-doc"> * This file should not change very often in babel but we may need to keep it</span>
<span class="linenr">257: </span><span class=
"org-doc"> * up-to-date from time to time.</span>
<span class="linenr">258: </span><span class="org-doc"> *</span>
<span class="linenr">259: </span><span class=
"org-doc"> * https://github.com/babel/babel/blob/main/LICENSE</span>
<span class="linenr">260: </span><span class="org-doc"> *</span>
<span class="linenr">261: </span><span class="org-doc"> */</span>
<span class="linenr">262: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isReferenced</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">parent</span>, <span class=
"org-variable-name">grandparent</span>) {
<span class="linenr">263: </span>  <span class=
"org-keyword">switch</span> (parent.type) {
<span class="linenr">264: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: PARENT[NODE]</span>
<span class="linenr">265: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: NODE.child</span>
<span class="linenr">266: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: parent.NODE</span>
<span class="linenr">267: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'MemberExpression'</span>:
<span class="linenr">268: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'OptionalMemberExpression'</span>:
<span class="linenr">269: </span>      <span class=
"org-keyword">if</span> (parent.property === node) {
<span class="linenr">270: </span>        <span class=
"org-keyword">return</span> !!parent.computed
<span class="linenr">271: </span>      }
<span class="linenr">272: </span>      <span class=
"org-keyword">return</span> parent.object === node
<span class="linenr">273: </span>
<span class="linenr">274: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'JSXMemberExpression'</span>:
<span class="linenr">275: </span>      <span class=
"org-keyword">return</span> parent.object === node
<span class="linenr">276: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: let NODE = init;</span>
<span class="linenr">277: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: let id = NODE;</span>
<span class="linenr">278: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'VariableDeclarator'</span>:
<span class="linenr">279: </span>      <span class=
"org-keyword">return</span> parent.init === node
<span class="linenr">280: </span>
<span class="linenr">281: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: () =&gt; NODE</span>
<span class="linenr">282: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: (NODE) =&gt; {}</span>
<span class="linenr">283: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ArrowFunctionExpression'</span>:
<span class="linenr">284: </span>      <span class=
"org-keyword">return</span> parent.body === node
<span class="linenr">285: </span>
<span class="linenr">286: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class { #NODE; }</span>
<span class="linenr">287: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class { get #NODE() {} }</span>
<span class="linenr">288: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class { #NODE() {} }</span>
<span class="linenr">289: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class { fn() { return this.#NODE; } }</span>
<span class="linenr">290: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'PrivateName'</span>:
<span class="linenr">291: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">292: </span>
<span class="linenr">293: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class { NODE() {} }</span>
<span class="linenr">294: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: class { [NODE]() {} }</span>
<span class="linenr">295: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class { foo(NODE) {} }</span>
<span class="linenr">296: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ClassMethod'</span>:
<span class="linenr">297: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ClassPrivateMethod'</span>:
<span class="linenr">298: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ObjectMethod'</span>:
<span class="linenr">299: </span>      <span class=
"org-keyword">if</span> (parent.key === node) {
<span class="linenr">300: </span>        <span class=
"org-keyword">return</span> !!parent.computed
<span class="linenr">301: </span>      }
<span class="linenr">302: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">303: </span>
<span class="linenr">304: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: { [NODE]: "" }</span>
<span class="linenr">305: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: { NODE: "" }</span>
<span class="linenr">306: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">depends: { NODE }</span>
<span class="linenr">307: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">depends: { key: NODE }</span>
<span class="linenr">308: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ObjectProperty'</span>:
<span class="linenr">309: </span>      <span class=
"org-keyword">if</span> (parent.key === node) {
<span class="linenr">310: </span>        <span class=
"org-keyword">return</span> !!parent.computed
<span class="linenr">311: </span>      }
<span class="linenr">312: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">parent.value === node</span>
<span class="linenr">313: </span>      <span class=
"org-keyword">return</span> !grandparent || grandparent.type !== <span class="org-string">'ObjectPattern'</span>
<span class="linenr">314: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class { NODE = value; }</span>
<span class="linenr">315: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: class { [NODE] = value; }</span>
<span class="linenr">316: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: class { key = NODE; }</span>
<span class="linenr">317: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ClassProperty'</span>:
<span class="linenr">318: </span>      <span class=
"org-keyword">if</span> (parent.key === node) {
<span class="linenr">319: </span>        <span class=
"org-keyword">return</span> !!parent.computed
<span class="linenr">320: </span>      }
<span class="linenr">321: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">322: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ClassPrivateProperty'</span>:
<span class="linenr">323: </span>      <span class=
"org-keyword">return</span> parent.key !== node
<span class="linenr">324: </span>
<span class="linenr">325: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: class NODE {}</span>
<span class="linenr">326: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: class Foo extends NODE {}</span>
<span class="linenr">327: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ClassDeclaration'</span>:
<span class="linenr">328: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ClassExpression'</span>:
<span class="linenr">329: </span>      <span class=
"org-keyword">return</span> parent.superClass === node
<span class="linenr">330: </span>
<span class="linenr">331: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: left = NODE;</span>
<span class="linenr">332: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: NODE = right;</span>
<span class="linenr">333: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'AssignmentExpression'</span>:
<span class="linenr">334: </span>      <span class=
"org-keyword">return</span> parent.right === node
<span class="linenr">335: </span>
<span class="linenr">336: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: [NODE = foo] = [];</span>
<span class="linenr">337: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: [foo = NODE] = [];</span>
<span class="linenr">338: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'AssignmentPattern'</span>:
<span class="linenr">339: </span>      <span class=
"org-keyword">return</span> parent.right === node
<span class="linenr">340: </span>
<span class="linenr">341: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: NODE: for (;;) {}</span>
<span class="linenr">342: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'LabeledStatement'</span>:
<span class="linenr">343: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">344: </span>
<span class="linenr">345: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: try {} catch (NODE) {}</span>
<span class="linenr">346: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'CatchClause'</span>:
<span class="linenr">347: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">348: </span>
<span class="linenr">349: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: function foo(...NODE) {}</span>
<span class="linenr">350: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'RestElement'</span>:
<span class="linenr">351: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">352: </span>
<span class="linenr">353: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'BreakStatement'</span>:
<span class="linenr">354: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ContinueStatement'</span>:
<span class="linenr">355: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">356: </span>
<span class="linenr">357: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: function NODE() {}</span>
<span class="linenr">358: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: function foo(NODE) {}</span>
<span class="linenr">359: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'FunctionDeclaration'</span>:
<span class="linenr">360: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'FunctionExpression'</span>:
<span class="linenr">361: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">362: </span>
<span class="linenr">363: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: export NODE from "foo";</span>
<span class="linenr">364: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: export * as NODE from "foo";</span>
<span class="linenr">365: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ExportNamespaceSpecifier'</span>:
<span class="linenr">366: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ExportDefaultSpecifier'</span>:
<span class="linenr">367: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">368: </span>
<span class="linenr">369: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: export { foo as NODE };</span>
<span class="linenr">370: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: export { NODE as foo };</span>
<span class="linenr">371: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: export { NODE as foo } from "foo";</span>
<span class="linenr">372: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ExportSpecifier'</span>:
<span class="linenr">373: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">@ts-expect-error</span>
<span class="linenr">374: </span>      <span class=
"org-keyword">if</span> (grandparent?.source) {
<span class="linenr">375: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">376: </span>      }
<span class="linenr">377: </span>      <span class=
"org-keyword">return</span> parent.local === node
<span class="linenr">378: </span>
<span class="linenr">379: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: import NODE from "foo";</span>
<span class="linenr">380: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: import * as NODE from "foo";</span>
<span class="linenr">381: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: import { NODE as foo } from "foo";</span>
<span class="linenr">382: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: import { foo as NODE } from "foo";</span>
<span class="linenr">383: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: import NODE from "bar";</span>
<span class="linenr">384: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ImportDefaultSpecifier'</span>:
<span class="linenr">385: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ImportNamespaceSpecifier'</span>:
<span class="linenr">386: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ImportSpecifier'</span>:
<span class="linenr">387: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">388: </span>
<span class="linenr">389: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: import "foo" assert { NODE: "json" }</span>
<span class="linenr">390: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ImportAttribute'</span>:
<span class="linenr">391: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">392: </span>
<span class="linenr">393: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: &lt;div NODE="foo" /&gt;</span>
<span class="linenr">394: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'JSXAttribute'</span>:
<span class="linenr">395: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">396: </span>
<span class="linenr">397: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: [NODE] = [];</span>
<span class="linenr">398: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: ({ NODE }) = [];</span>
<span class="linenr">399: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ObjectPattern'</span>:
<span class="linenr">400: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ArrayPattern'</span>:
<span class="linenr">401: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">402: </span>
<span class="linenr">403: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: new.NODE</span>
<span class="linenr">404: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: NODE.target</span>
<span class="linenr">405: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'MetaProperty'</span>:
<span class="linenr">406: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">407: </span>
<span class="linenr">408: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: type X = { someProperty: NODE }</span>
<span class="linenr">409: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: type X = { NODE: OtherType }</span>
<span class="linenr">410: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'ObjectTypeProperty'</span>:
<span class="linenr">411: </span>      <span class=
"org-keyword">return</span> parent.key !== node
<span class="linenr">412: </span>
<span class="linenr">413: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: enum X { Foo = NODE }</span>
<span class="linenr">414: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: enum X { NODE }</span>
<span class="linenr">415: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'TSEnumMember'</span>:
<span class="linenr">416: </span>      <span class=
"org-keyword">return</span> parent.id !== node
<span class="linenr">417: </span>
<span class="linenr">418: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">yes: { [NODE]: value }</span>
<span class="linenr">419: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no: { NODE: value }</span>
<span class="linenr">420: </span>    <span class=
"org-keyword">case</span> <span class=
"org-string">'TSPropertySignature'</span>:
<span class="linenr">421: </span>      <span class=
"org-keyword">if</span> (parent.key === node) {
<span class="linenr">422: </span>        <span class=
"org-keyword">return</span> !!parent.computed
<span class="linenr">423: </span>      }
<span class="linenr">424: </span>
<span class="linenr">425: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">426: </span>  }
<span class="linenr">427: </span>
<span class="linenr">428: </span>  <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">429: </span>}
<span class="linenr">430: </span>
</pre>
          </div>
        </details>
      </div>
      <div id="outline-container-org7b61d4c" class="outline-3">
        <h3 id="org7b61d4c"><span class=
        "section-number-3">1.1.</span> babel utils</h3>
        <div class="outline-text-3" id="text-1-1">
          <p>递归遍历 AST 树。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org01f7dc2"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">class</span> WalkerBase {
<span class="linenr">  2: </span>  constructor() {
<span class="linenr">  3: </span>    <span class=
"org-doc">/** @type {boolean} */</span>
<span class="linenr">  4: </span>    <span class=
"org-constant">this</span>.should_skip = <span class=
"org-constant">false</span>
<span class="linenr">  5: </span>
<span class="linenr">  6: </span>    <span class=
"org-doc">/** @type {boolean} */</span>
<span class="linenr">  7: </span>    <span class=
"org-constant">this</span>.should_remove = <span class=
"org-constant">false</span>
<span class="linenr">  8: </span>
<span class="linenr">  9: </span>    <span class=
"org-doc">/** @type {BaseNode | null} */</span>
<span class="linenr"> 10: </span>    <span class=
"org-constant">this</span>.replacement = <span class=
"org-constant">null</span>
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span>    <span class=
"org-doc">/** @type {WalkerContext} */</span>
<span class="linenr"> 13: </span>    <span class=
"org-constant">this</span>.context = {
<span class="linenr"> 14: </span>      skip: () =&gt; (<span class=
"org-constant">this</span>.should_skip = <span class=
"org-constant">true</span>),
<span class=
"linenr"> 15: </span>      remove: () =&gt; (<span class=
"org-constant">this</span>.should_remove = <span class=
"org-constant">true</span>),
<span class=
"linenr"> 16: </span>      replace: (node) =&gt; (<span class=
"org-constant">this</span>.replacement = node)
<span class="linenr"> 17: </span>    }
<span class="linenr"> 18: </span>  }
<span class="linenr"> 19: </span>
<span class=
"linenr"> 20: </span>  replace(parent, prop, index, node) {
<span class="linenr"> 21: </span>    <span class=
"org-keyword">if</span> (parent) {
<span class="linenr"> 22: </span>      <span class=
"org-keyword">if</span> (index !== <span class=
"org-constant">null</span>) {
<span class="linenr"> 23: </span>        parent[prop][index] = node
<span class="linenr"> 24: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr"> 25: </span>        parent[prop] = node
<span class="linenr"> 26: </span>      }
<span class="linenr"> 27: </span>    }
<span class="linenr"> 28: </span>  }
<span class="linenr"> 29: </span>
<span class="linenr"> 30: </span>  remove(parent, prop, index) {
<span class="linenr"> 31: </span>    <span class=
"org-keyword">if</span> (parent) {
<span class="linenr"> 32: </span>      <span class=
"org-keyword">if</span> (index !== <span class=
"org-constant">null</span>) {
<span class=
"linenr"> 33: </span>        parent[prop].splice(index, <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 34: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr"> 35: </span>        <span class=
"org-keyword">delete</span> parent[prop]
<span class="linenr"> 36: </span>      }
<span class="linenr"> 37: </span>    }
<span class="linenr"> 38: </span>  }
<span class="linenr"> 39: </span>}
<span class="linenr"> 40: </span>
<span class="linenr"> 41: </span><span class=
"org-keyword">class</span> SyncWalker <span class=
"org-keyword">extends</span> WalkerBase {
<span class="linenr"> 42: </span>
<span class="linenr"> 43: </span>  constructor(enter, leave) {
<span class="linenr"> 44: </span>    <span class=
"org-keyword">super</span>()
<span class="linenr"> 45: </span>
<span class="linenr"> 46: </span>    <span class=
"org-doc">/** @type {SyncHandler} */</span>
<span class="linenr"> 47: </span>    <span class=
"org-constant">this</span>.enter = enter
<span class="linenr"> 48: </span>
<span class="linenr"> 49: </span>    <span class=
"org-doc">/** @type {SyncHandler} */</span>
<span class="linenr"> 50: </span>    <span class=
"org-constant">this</span>.leave = leave
<span class="linenr"> 51: </span>  }
<span class="linenr"> 52: </span>
<span class=
"linenr"> 53: </span>  visit(node, parent, prop, index) {
<span class="linenr"> 54: </span>    <span class=
"org-keyword">if</span> (node) {
<span class="linenr"> 55: </span>      <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.enter) {
<span class="linenr"> 56: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_should_skip</span> = <span class=
"org-constant">this</span>.should_skip
<span class="linenr"> 57: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_should_remove</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr"> 58: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_replacement</span> = <span class=
"org-constant">this</span>.replacement
<span class="linenr"> 59: </span>        <span class=
"org-constant">this</span>.should_skip = <span class=
"org-constant">false</span>
<span class="linenr"> 60: </span>        <span class=
"org-constant">this</span>.should_remove = <span class=
"org-constant">false</span>
<span class="linenr"> 61: </span>        <span class=
"org-constant">this</span>.replacement = <span class=
"org-constant">null</span>
<span class="linenr"> 62: </span>
<span class="linenr"> 63: </span>        <span class=
"org-constant">this</span>.enter.call(<span class=
"org-constant">this</span>.context, node, parent, prop, index)
<span class="linenr"> 64: </span>
<span class="linenr"> 65: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.replacement) {
<span class="linenr"> 66: </span>          node = <span class=
"org-constant">this</span>.replacement
<span class="linenr"> 67: </span>          <span class=
"org-constant">this</span>.replace(parent, prop, index, node)
<span class="linenr"> 68: </span>        }
<span class="linenr"> 69: </span>
<span class="linenr"> 70: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.should_remove) {
<span class="linenr"> 71: </span>          <span class=
"org-constant">this</span>.remove(parent, prop, index)
<span class="linenr"> 72: </span>        }
<span class="linenr"> 73: </span>
<span class="linenr"> 74: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">skipped</span> = <span class=
"org-constant">this</span>.should_skip
<span class="linenr"> 75: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">removed</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr"> 76: </span>
<span class="linenr"> 77: </span>        <span class=
"org-constant">this</span>.should_skip = _should_skip
<span class="linenr"> 78: </span>        <span class=
"org-constant">this</span>.should_remove = _should_remove
<span class="linenr"> 79: </span>        <span class=
"org-constant">this</span>.replacement = _replacement
<span class="linenr"> 80: </span>
<span class="linenr"> 81: </span>        <span class=
"org-keyword">if</span> (skipped) <span class=
"org-keyword">return</span> node
<span class="linenr"> 82: </span>        <span class=
"org-keyword">if</span> (removed) <span class=
"org-keyword">return</span> <span class="org-constant">null</span>
<span class="linenr"> 83: </span>      }
<span class="linenr"> 84: </span>
<span class="linenr"> 85: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> <span class=
"org-keyword">in</span> node) {
<span class="linenr"> 86: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">value</span> = node[key]
<span class="linenr"> 87: </span>
<span class="linenr"> 88: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-keyword">typeof</span> value !== <span class=
"org-string">'object'</span>) {
<span class="linenr"> 89: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr"> 90: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (Array.isArray(value)) {
<span class="linenr"> 91: </span>          <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; value.length; i += <span class="org-highlight-numbers-number">1</span>) {
<span class="linenr"> 92: </span>            <span class=
"org-keyword">if</span> (value[i] !== <span class=
"org-constant">null</span> &amp;& <span class=
"org-keyword">typeof</span> value[i].type === <span class=
"org-string">'string'</span>) {
<span class="linenr"> 93: </span>              <span class=
"org-keyword">if</span> (!<span class=
"org-constant">this</span>.visit(value[i], node, key, i)) {
<span class="linenr"> 94: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">removed</span>
<span class="linenr"> 95: </span>                i--
<span class="linenr"> 96: </span>              }
<span class="linenr"> 97: </span>            }
<span class="linenr"> 98: </span>          }
<span class="linenr"> 99: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (value !== <span class=
"org-constant">null</span> &amp;& <span class=
"org-keyword">typeof</span> value.type === <span class=
"org-string">'string'</span>) {
<span class="linenr">100: </span>          <span class=
"org-constant">this</span>.visit(value, node, key, <span class=
"org-constant">null</span>)
<span class="linenr">101: </span>        }
<span class="linenr">102: </span>      }
<span class="linenr">103: </span>
<span class="linenr">104: </span>      <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.leave) {
<span class="linenr">105: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_replacement</span> = <span class=
"org-constant">this</span>.replacement
<span class="linenr">106: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_should_remove</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr">107: </span>        <span class=
"org-constant">this</span>.replacement = <span class=
"org-constant">null</span>
<span class="linenr">108: </span>        <span class=
"org-constant">this</span>.should_remove = <span class=
"org-constant">false</span>
<span class="linenr">109: </span>
<span class="linenr">110: </span>        <span class=
"org-constant">this</span>.leave.call(<span class=
"org-constant">this</span>.context, node, parent, prop, index)
<span class="linenr">111: </span>
<span class="linenr">112: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.replacement) {
<span class="linenr">113: </span>          node = <span class=
"org-constant">this</span>.replacement
<span class="linenr">114: </span>          <span class=
"org-constant">this</span>.replace(parent, prop, index, node)
<span class="linenr">115: </span>        }
<span class="linenr">116: </span>
<span class="linenr">117: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.should_remove) {
<span class="linenr">118: </span>          <span class=
"org-constant">this</span>.remove(parent, prop, index)
<span class="linenr">119: </span>        }
<span class="linenr">120: </span>
<span class="linenr">121: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">removed</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr">122: </span>
<span class="linenr">123: </span>        <span class=
"org-constant">this</span>.replacement = _replacement
<span class="linenr">124: </span>        <span class=
"org-constant">this</span>.should_remove = _should_remove
<span class="linenr">125: </span>
<span class="linenr">126: </span>        <span class=
"org-keyword">if</span> (removed) <span class=
"org-keyword">return</span> <span class="org-constant">null</span>
<span class="linenr">127: </span>      }
<span class="linenr">128: </span>    }
<span class="linenr">129: </span>
<span class="linenr">130: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr">131: </span>  }
<span class="linenr">132: </span>}
<span class="linenr">133: </span>
<span class="linenr">134: </span><span class=
"org-keyword">class</span> AsyncWalker <span class=
"org-keyword">extends</span> WalkerBase {
<span class="linenr">135: </span>
<span class="linenr">136: </span>  constructor(enter, leave) {
<span class="linenr">137: </span>    <span class=
"org-keyword">super</span>()
<span class="linenr">138: </span>
<span class="linenr">139: </span>    <span class=
"org-doc">/** @type {AsyncHandler} */</span>
<span class="linenr">140: </span>    <span class=
"org-constant">this</span>.enter = enter
<span class="linenr">141: </span>
<span class="linenr">142: </span>    <span class=
"org-doc">/** @type {AsyncHandler} */</span>
<span class="linenr">143: </span>    <span class=
"org-constant">this</span>.leave = leave
<span class="linenr">144: </span>  }
<span class="linenr">145: </span>
<span class="linenr">146: </span>  <span class=
"org-keyword">async</span> visit(node, parent, prop, index) {
<span class="linenr">147: </span>    <span class=
"org-keyword">if</span> (node) {
<span class="linenr">148: </span>      <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.enter) {
<span class="linenr">149: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_should_skip</span> = <span class=
"org-constant">this</span>.should_skip
<span class="linenr">150: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_should_remove</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr">151: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_replacement</span> = <span class=
"org-constant">this</span>.replacement
<span class="linenr">152: </span>        <span class=
"org-constant">this</span>.should_skip = <span class=
"org-constant">false</span>
<span class="linenr">153: </span>        <span class=
"org-constant">this</span>.should_remove = <span class=
"org-constant">false</span>
<span class="linenr">154: </span>        <span class=
"org-constant">this</span>.replacement = <span class=
"org-constant">null</span>
<span class="linenr">155: </span>
<span class="linenr">156: </span>        <span class=
"org-keyword">await</span> <span class=
"org-constant">this</span>.enter.call(<span class=
"org-constant">this</span>.context, node, parent, prop, index)
<span class="linenr">157: </span>
<span class="linenr">158: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.replacement) {
<span class="linenr">159: </span>          node = <span class=
"org-constant">this</span>.replacement
<span class="linenr">160: </span>          <span class=
"org-constant">this</span>.replace(parent, prop, index, node)
<span class="linenr">161: </span>        }
<span class="linenr">162: </span>
<span class="linenr">163: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.should_remove) {
<span class="linenr">164: </span>          <span class=
"org-constant">this</span>.remove(parent, prop, index)
<span class="linenr">165: </span>        }
<span class="linenr">166: </span>
<span class="linenr">167: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">skipped</span> = <span class=
"org-constant">this</span>.should_skip
<span class="linenr">168: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">removed</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr">169: </span>
<span class="linenr">170: </span>        <span class=
"org-constant">this</span>.should_skip = _should_skip
<span class="linenr">171: </span>        <span class=
"org-constant">this</span>.should_remove = _should_remove
<span class="linenr">172: </span>        <span class=
"org-constant">this</span>.replacement = _replacement
<span class="linenr">173: </span>
<span class="linenr">174: </span>        <span class=
"org-keyword">if</span> (skipped) <span class=
"org-keyword">return</span> node
<span class="linenr">175: </span>        <span class=
"org-keyword">if</span> (removed) <span class=
"org-keyword">return</span> <span class="org-constant">null</span>
<span class="linenr">176: </span>      }
<span class="linenr">177: </span>
<span class="linenr">178: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> <span class=
"org-keyword">in</span> node) {
<span class="linenr">179: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">value</span> = node[key]
<span class="linenr">180: </span>
<span class="linenr">181: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-keyword">typeof</span> value !== <span class=
"org-string">'object'</span>) {
<span class="linenr">182: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">183: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (Array.isArray(value)) {
<span class="linenr">184: </span>          <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; value.length; i += <span class="org-highlight-numbers-number">1</span>) {
<span class="linenr">185: </span>            <span class=
"org-keyword">if</span> (value[i] !== <span class=
"org-constant">null</span> &amp;& <span class=
"org-keyword">typeof</span> value[i].type === <span class=
"org-string">'string'</span>) {
<span class="linenr">186: </span>              <span class=
"org-keyword">if</span> (!(<span class=
"org-keyword">await</span> <span class=
"org-constant">this</span>.visit(value[i], node, key, i))) {
<span class="linenr">187: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">removed</span>
<span class="linenr">188: </span>                i--
<span class="linenr">189: </span>              }
<span class="linenr">190: </span>            }
<span class="linenr">191: </span>          }
<span class="linenr">192: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (value !== <span class=
"org-constant">null</span> &amp;& <span class=
"org-keyword">typeof</span> value.type === <span class=
"org-string">'string'</span>) {
<span class="linenr">193: </span>          <span class=
"org-keyword">await</span> <span class=
"org-constant">this</span>.visit(value, node, key, <span class=
"org-constant">null</span>)
<span class="linenr">194: </span>        }
<span class="linenr">195: </span>      }
<span class="linenr">196: </span>
<span class="linenr">197: </span>      <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.leave) {
<span class="linenr">198: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_replacement</span> = <span class=
"org-constant">this</span>.replacement
<span class="linenr">199: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">_should_remove</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr">200: </span>        <span class=
"org-constant">this</span>.replacement = <span class=
"org-constant">null</span>
<span class="linenr">201: </span>        <span class=
"org-constant">this</span>.should_remove = <span class=
"org-constant">false</span>
<span class="linenr">202: </span>
<span class="linenr">203: </span>        <span class=
"org-keyword">await</span> <span class=
"org-constant">this</span>.leave.call(<span class=
"org-constant">this</span>.context, node, parent, prop, index)
<span class="linenr">204: </span>
<span class="linenr">205: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.replacement) {
<span class="linenr">206: </span>          node = <span class=
"org-constant">this</span>.replacement
<span class="linenr">207: </span>          <span class=
"org-constant">this</span>.replace(parent, prop, index, node)
<span class="linenr">208: </span>        }
<span class="linenr">209: </span>
<span class="linenr">210: </span>        <span class=
"org-keyword">if</span> (<span class=
"org-constant">this</span>.should_remove) {
<span class="linenr">211: </span>          <span class=
"org-constant">this</span>.remove(parent, prop, index)
<span class="linenr">212: </span>        }
<span class="linenr">213: </span>
<span class="linenr">214: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">removed</span> = <span class=
"org-constant">this</span>.should_remove
<span class="linenr">215: </span>
<span class="linenr">216: </span>        <span class=
"org-constant">this</span>.replacement = _replacement
<span class="linenr">217: </span>        <span class=
"org-constant">this</span>.should_remove = _should_remove
<span class="linenr">218: </span>
<span class="linenr">219: </span>        <span class=
"org-keyword">if</span> (removed) <span class=
"org-keyword">return</span> <span class="org-constant">null</span>
<span class="linenr">220: </span>      }
<span class="linenr">221: </span>    }
<span class="linenr">222: </span>
<span class="linenr">223: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr">224: </span>  }
<span class="linenr">225: </span>}
<span class="linenr">226: </span>
<span class="linenr">227: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">walk</span>(<span class=
"org-variable-name">ast</span>, { <span class=
"org-variable-name">enter</span>, <span class=
"org-variable-name">leave</span> }) {
<span class="linenr">228: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">instance</span> = <span class=
"org-keyword">new</span> <span class=
"org-type">SyncWalker</span>(enter, leave)
<span class="linenr">229: </span>  <span class=
"org-keyword">return</span> instance.visit(ast, <span class=
"org-constant">null</span>)
<span class="linenr">230: </span>}
<span class="linenr">231: </span>
<span class="linenr">232: </span><span class=
"org-keyword">async</span> <span class=
"org-keyword">function</span> asyncWalk(<span class=
"org-variable-name">ast</span>, { <span class=
"org-variable-name">enter</span>, <span class=
"org-variable-name">leave</span> }) {
<span class="linenr">233: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">instance</span> = <span class=
"org-keyword">new</span> <span class=
"org-type">AsyncWalker</span>(enter, leave)
<span class="linenr">234: </span>  <span class=
"org-keyword">return</span> <span class=
"org-keyword">await</span> instance.visit(ast, <span class=
"org-constant">null</span>)
<span class="linenr">235: </span>}
<span class="linenr">236: </span>
</pre>
          </div>
        </div>
      </div>
    </div>
    <div id="outline-container-cc-ast-parser" class="outline-2">
      <h2 id="cc-ast-parser"><span class=
      "section-number-2">2.</span> ast parser</h2>
      <div class="outline-text-2" id="text-cc-ast-parser">
        <a href=
        "../assets/img/vue3/compiler-core/compiler-core-parser.svg"
        data-fancybox="gallery" data-caption="Preview"><img src=
        "../assets/img/vue3/compiler-core/compiler-core-parser.svg"></a>
        <p>解析器包含以下函数：</p>
        <table id="org941c81c">
          <colgroup>
            <col class="org-left">
            <col class="org-left">
          </colgroup>
          <thead>
            <tr>
              <th scope="col" class="org-left">Function</th>
              <th scope="col" class="org-left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="org-left">
                <a href="#org69772c9">baseParse()</a>
              </td>
              <td class="org-left">entry function</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org2861090">parseChildren()</a>
              </td>
              <td class="org-left">parse children nodes</td>
            </tr>
            <tr>
              <td class="org-left">&nbsp;</td>
              <td class="org-left">parse <code>CDATA</code> type
              content</td>
            </tr>
            <tr>
              <td class="org-left">&nbsp;</td>
              <td class="org-left">parse comment node</td>
            </tr>
            <tr>
              <td class="org-left">&nbsp;</td>
              <td class="org-left">parse <code>&lt;!...&gt;</code>
              or <code>&lt;?...&gt;</code> comment</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org7aaf5f4">parseElement()</a>
              </td>
              <td class="org-left">parse normal HTML
              element/component nodes</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#orgf609657">parseTag()</a>
              </td>
              <td class="org-left">parse normal HTML
              tag(<code>&lt;div id=a&gt;</code>) nodes</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#orgca7478f">parseAttributes()</a>
              </td>
              <td class="org-left">parse tag attribute(eg.
              <code>&lt;div foo="100"/&gt;</code>)</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org0845247">parseAttribute()</a>
              </td>
              <td class="org-left">parse tag attribute.</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#orge5eca97">parseAttributeValue()</a>
              </td>
              <td class="org-left">parse tag attribute value</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org88fd8d1">parseText()</a>
              </td>
              <td class="org-left">parse pure text node</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org502d769">parseTextData()</a>
              </td>
              <td class="org-left">parse text node value</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="outline-container-org0e41166" class="outline-3">
        <h3 id="org0e41166"><span class=
        "section-number-3">2.1.</span> baseParse()</h3>
        <div class="outline-text-3" id="text-2-1">
          <div class="org-src-container">
            <pre class="src src-js" id="org69772c9"><span class=
            "linenr"> 1: </span>&lt;&lt;createParserContext&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;createRoot&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;parseChildren&gt;&gt;
<span class="linenr"> 4: </span>&lt;&lt;parseElement&gt;&gt;
<span class="linenr"> 5: </span>&lt;&lt;parseTag&gt;&gt;
<span class="linenr"> 6: </span>&lt;&lt;parseText&gt;&gt;
<span class="linenr"> 7: </span>&lt;&lt;parseTextData&gt;&gt;
<span class="linenr"> 8: </span>&lt;&lt;parseInterpolation&gt;&gt;
<span class="linenr"> 9: </span>&lt;&lt;parseAttributes&gt;&gt;
<span class="linenr">10: </span>&lt;&lt;parseAttribute&gt;&gt;
<span class="linenr">11: </span>&lt;&lt;parseAttributeValue&gt;&gt;
<span class="linenr">12: </span>
<span class="linenr">13: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">baseParse</span>(<span class=
"org-variable-name">content</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr">14: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = createParserContext(content, options)
<span class="linenr">15: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">16: </span>  <span class=
"org-keyword">return</span> createRoot(
<span class=
"linenr">17: </span>    parseChildren(context, TextModes.DATA, []),
<span class="linenr">18: </span>    getSelection(context, start)
<span class="linenr">19: </span>  )
<span class="linenr">20: </span>}
</pre>
          </div>
          <ul class="org-ul">
            <li>一个 app 下只会有一个 parser context 上下文</li>
            <li>一个 app 只有一个 root 节点，由 <a href=
            "#org58429ed">createRoot()</a> 创建
            </li>
            <li>parser 从 <a href="#org2861090">parseChildren()</a>
            解析第一个子节点开始
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org7f2072a" class="outline-3">
        <h3 id="org7f2072a"><span class=
        "section-number-3">2.2.</span> createParserContext()</h3>
        <div class="outline-text-3" id="text-2-2">
          <p>创建 parser 上下文结构对象：</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org458ad39"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">createParserContext</span>(<span class=
            "org-variable-name">content</span>, <span class=
            "org-variable-name">rawOptions</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">options</span> = extend({}, defaultParserOptions)
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">let</span> <span class="org-variable-name">key</span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">for</span> (key <span class=
"org-keyword">in</span> rawOptions) {
<span class="linenr"> 6: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">@ts-ignore</span>
<span class="linenr"> 7: </span>    options[key] =
<span class=
"linenr"> 8: </span>      rawOptions[key] === <span class=
"org-constant">undefined</span>
<span class="linenr"> 9: </span>        ? defaultParserOptions[key]
<span class="linenr">10: </span>        : rawOptions[key]
<span class="linenr">11: </span>  }
<span class="linenr">12: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">13: </span>    options,
<span class="linenr">14: </span>    column: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">15: </span>    line: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">16: </span>    offset: <span class=
"org-highlight-numbers-number">0</span>,
<span id="coderef-context-originalSource" class=
"coderef-off"><span class=
"linenr">17: </span>    originalSource: content,</span>
<span id="coderef-context-source" class="coderef-off"><span class=
"linenr">18: </span>    source: content,</span>
<span class="linenr">19: </span>    inPre: <span class=
"org-constant">false</span>,
<span class="linenr">20: </span>    inVPre: <span class=
"org-constant">false</span>,
<span class="linenr">21: </span>    onWarn: options.onWarn
<span class="linenr">22: </span>  }
<span class="linenr">23: </span>}
</pre>
          </div>
          <p>column, line, offset 表示解析光标停留的位置，这个可以用来调试过程中遇到错误时能
          精准给出发生异常的行和列号。</p>
          <p><code>inPre</code> 和 <code>inVPre</code> 是表示模板是不是在
          <code>&lt;pre/&gt;</code> 标签或者 <code>&lt;div
          v-pre&gt;</code> 指令中。</p>
          <p><a href="#coderef-context-originalSource" class=
          "coderef" onmouseover=
          "CodeHighlightOn(this, 'coderef-context-originalSource');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-originalSource');">
          originalSource</a>: 解析之前的原始模板，如： <code>&lt;div
          id="test"/&gt;</code></p>
          <p><a href="#coderef-context-source" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-context-source');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-source');">source</a>:
          解析当下的模板，解析一点会丢弃一点，如： <code>id="test"/&gt;</code> 这个是
          <a href="#coderef-context-originalSource" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-context-originalSource');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-originalSource');">
          originalSource</a> 解析出开始标签名 <code>div</code>
          之后剩下的(一个一个字符的解构)。</p>
        </div>
      </div>
      <div id="outline-container-org98d9f89" class="outline-3">
        <h3 id="org98d9f89"><span class=
        "section-number-3">2.3.</span> parseChildren()</h3>
        <div class="outline-text-3" id="text-2-3">
          <p>这个是 parser 阶段的解析入口函数， root -&gt; children &lt;-&gt;
          children 递归调用解析 AST 。</p>
          <p>通过节点或标签的类型决定调用哪些 <a href="#org941c81c">parse 函数</a>
          去解析它们。</p>
          <p><span style=
          "color:red;">TIP:这里只保留了正常使用情况下的代码异常处理和边界情况都省略掉了</span></p>
          <div class="org-src-container">
            <pre class="src src-js" id="org2861090"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseChildren</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">mode</span>, <span class=
            "org-variable-name">ancestors</span>) {
<span class="linenr">  2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr">  3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = parent ? parent.ns : Namespaces.HTML
<span class="linenr">  4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nodes</span> = [] <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">-&gt; ancestors</span>
<span class="linenr">  5: </span>
<span class="linenr">  6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. while -&gt; isEnd ? 游标不断往前走直接所以 source 都解析完成</span>
<span class="linenr">  7: </span>  <span class=
"org-keyword">while</span> (!isEnd(context, mode, ancestors)) {
<span class="linenr">  8: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">s</span> = context.source
<span class="linenr">  9: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">node</span> = <span class=
"org-constant">undefined</span>
<span class="linenr"> 10: </span>
<span class="linenr"> 11: </span>    <span class=
"org-keyword">if</span> (mode === TextModes.DATA || mode === TextModes.RCDATA) {
<span class="linenr"> 12: </span>      <span class=
"org-keyword">if</span> (!context.inVPre &amp;& startsWith(s, context.options.delimiters[<span class="org-highlight-numbers-number">0</span>])) {
<span class="linenr"> 13: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">'{{' 插值开始</span>
<span class=
"linenr"> 14: </span>        node = parseInterpolation(context, mode)
<span class="linenr"> 15: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (mode === TextModes.DATA &amp;& s[<span class="org-highlight-numbers-number">0</span>] === <span class="org-string">'&lt;'</span>) {
<span class="linenr"> 16: </span>        <span class=
"org-keyword">if</span> (s[<span class=
"org-highlight-numbers-number">1</span>] === <span class=
"org-string">'/'</span>) {
<span class="linenr"> 17: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">结束标签</span>
<span class="linenr"> 18: </span>          <span class=
"org-keyword">if</span> (<span class=
"org-string">/[a-z]/</span>i.test(s[<span class=
"org-highlight-numbers-number">2</span>])) {
<span class="linenr"> 19: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">异常结束，如：`&lt;div&gt;some text&lt;a`</span>
<span class=
"linenr"> 20: </span>            emitError(context, <span class=
"org-string">'X_INVALID_END_TAG'</span>)
<span class=
"linenr"> 21: </span>            parseTag(context, TagType.End, parent)
<span class="linenr"> 22: </span>            <span class=
"org-keyword">continue</span>
<span class="linenr"> 23: </span>          }
<span class="linenr"> 24: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (<span class=
"org-string">/[a-z]/</span>i.test(s[<span class=
"org-highlight-numbers-number">1</span>])) {
<span class="linenr"> 25: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">正常的开始标签</span>
<span class=
"linenr"> 26: </span>          node = parseElement(context, ancestors)
<span class="linenr"> 27: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2.x &lt;template&gt; 无指令兼容，这里就不实现了，重点关注 3.x 的代码</span>
<span class="linenr"> 28: </span>        }
<span class="linenr"> 29: </span>      }
<span class="linenr"> 30: </span>    }
<span class="linenr"> 31: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">以上都不是，说明应该是纯文本节点</span>
<span class="linenr"> 32: </span>    <span class=
"org-keyword">if</span> (!node) {
<span class=
"linenr"> 33: </span>      node = parseText(context, mode)
<span class="linenr"> 34: </span>    }
<span class="linenr"> 35: </span>
<span class="linenr"> 36: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">用 pushNode 在其中合并相邻的文本节点</span>
<span class="linenr"> 37: </span>    <span class=
"org-keyword">if</span> (isArray(node)) {
<span class="linenr"> 38: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.length; i++) {
<span class="linenr"> 39: </span>        pushNode(nodes, node[i])
<span class="linenr"> 40: </span>      }
<span class="linenr"> 41: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 42: </span>      pushNode(nodes, node)
<span class="linenr"> 43: </span>    }
<span class="linenr"> 44: </span>  }
<span class="linenr"> 45: </span>
<span class="linenr"> 46: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 合并相邻文本节点，空格处理，会将多个空格合并成一个空格</span>
<span class="linenr"> 47: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">removedWhitespace</span> = <span class=
"org-constant">false</span>
<span class="linenr"> 48: </span>  <span class=
"org-keyword">if</span> (mode !== TextModes.RAWTEXT &amp;& mode !== TextModes.RCDATA) {
<span class=
"linenr"> 49: </span>    removedWhitespace = _removeWhitespace(nodes, context)
<span class="linenr"> 50: </span>  }
<span class="linenr"> 51: </span>
<span class="linenr"> 52: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. 最后返回解析后的节点树</span>
<span class="linenr"> 53: </span>  <span class=
"org-keyword">return</span> removedWhitespace ? nodes.filter(Boolean) : nodes
<span class="linenr"> 54: </span>}
<span class="linenr"> 55: </span>
<span class="linenr"> 56: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">_removeWhitespace</span>(<span class=
"org-variable-name">nodes</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr"> 57: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">removedWhitespace</span> = <span class=
"org-constant">false</span>
<span class="linenr"> 58: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">可以通过选项来指定是不是保留空格，否则多余的会合并成一个</span>
<span class="linenr"> 59: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">shouldCondense</span> = context.options.whitespace !== <span class="org-string">'preserve'</span>
<span class="linenr"> 60: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; nodes.length; i++) {
<span class="linenr"> 61: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">node</span> = nodes[i]
<span class="linenr"> 62: </span>    <span class=
"org-keyword">if</span> (!context.inPre &amp;& node.type === NodeTypes.TEXT) {
<span class="linenr"> 63: </span>      <span class=
"org-keyword">if</span> (!<span class=
"org-string">/[^\t\r\n\f]/</span>.test(node.content)) {
<span class="linenr"> 64: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prev</span> = nodes[i - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 65: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">next</span> = nodes[i + <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 66: </span>
<span class="linenr"> 67: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr"> 68: </span>          !prev ||
<span class="linenr"> 69: </span>            !next ||
<span class=
"linenr"> 70: </span>            (shouldCondense &amp;& (
<span class=
"linenr"> 71: </span>              prev.type === NodeTypes.COMMENT || next.type === NodeTypes.COMMENT || (
<span class=
"linenr"> 72: </span>                prev.type === NodeTypes.ELEMENT &amp;& next.type === NodeTypes.ELEMENT &amp;& <span class="org-string">/[\r\n]/</span>.test(node.content)
<span class="linenr"> 73: </span>              )
<span class="linenr"> 74: </span>            ))
<span class="linenr"> 75: </span>        ) {
<span class=
"linenr"> 76: </span>          removedWhitespace = <span class=
"org-constant">true</span>
<span class="linenr"> 77: </span>          nodes[i] = <span class=
"org-constant">null</span>
<span class="linenr"> 78: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr"> 79: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">合并成一个</span>
<span class=
"linenr"> 80: </span>          node.content = <span class=
"org-string">' '</span>
<span class="linenr"> 81: </span>        }
<span class="linenr"> 82: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (shouldCondense) {
<span class="linenr"> 83: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">保留空格</span>
<span class=
"linenr"> 84: </span>        node.content = node.content.replace(<span class="org-string">/[\t\r\n\f]+/</span>g, <span class="org-string">' '</span>)
<span class="linenr"> 85: </span>      }
<span class="linenr"> 86: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.type === NodeTypes.COMMENT &amp;& !context.options.comments) {
<span class="linenr"> 87: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">可以通过配置删除注释节点</span>
<span class=
"linenr"> 88: </span>      removedWhitespace = <span class=
"org-constant">true</span>
<span class="linenr"> 89: </span>      nodes[i] = <span class=
"org-constant">null</span>
<span class="linenr"> 90: </span>    }
<span class="linenr"> 91: </span>  }
<span class="linenr"> 92: </span>
<span class="linenr"> 93: </span>  <span class=
"org-keyword">if</span> (context.inPre &amp;& parent &amp;& context.options.isPreTag(parent.tag)) {
<span class="linenr"> 94: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">删除 &lt;pre&gt; 中的第一行的空行</span>
<span class="linenr"> 95: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">first</span> = nodes[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 96: </span>    <span class=
"org-keyword">if</span> (first &amp;& first.type === NodeTypes.TEXT) {
<span class=
"linenr"> 97: </span>      first.content = first.content.replace(<span class="org-string">/^\r?\n/</span>, <span class="org-string">''</span>)
<span class="linenr"> 98: </span>    }
<span class="linenr"> 99: </span>  }
<span class="linenr">100: </span>
<span class="linenr">101: </span>  <span class=
"org-keyword">return</span> removedWhitespace
<span class="linenr">102: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org07e1abe" class="outline-3">
        <h3 id="org07e1abe"><span class=
        "section-number-3">2.4.</span> parseText()</h3>
        <div class="outline-text-3" id="text-2-4">
          <p>文本解析函数。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org88fd8d1"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseText</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">mode</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endTokens</span> = mode === TextModes.CDATA ? [<span class="org-string">']]&gt;'</span>] : [<span class="org-string">'&lt;'</span>, context.options.delimiters[<span class="org-highlight-numbers-number">0</span>]]
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">endIndex</span> = context.source.length
<span class="linenr"> 5: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; endTokens.length; i++) {
<span class="linenr"> 6: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">index</span> = context.source.indexOf(endTokens[i], <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 7: </span>    <span class=
"org-keyword">if</span> (index !== -<span class=
"org-highlight-numbers-number">1</span> &amp;& endIndex &gt; index) {
<span class="linenr"> 8: </span>      endIndex = index
<span class="linenr"> 9: </span>    }
<span class="linenr">10: </span>  }
<span class="linenr">11: </span>
<span class="linenr">12: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">13: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">content</span> = parseTextData(context, endIndex, mode)
<span class="linenr">14: </span>
<span class="linenr">15: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">16: </span>    type: NodeTypes.TEXT,
<span class="linenr">17: </span>    content,
<span class=
"linenr">18: </span>    loc: getSelection(context, start)
<span class="linenr">19: </span>  }
<span class="linenr">20: </span>}
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some text'</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>logEnd(<span class=
"org-string">'ROOT AST'</span>)
<span class="linenr">7: </span>log(ast)
<span class="linenr">8: </span>logEnd(<span class=
"org-string">'TEXT AST'</span>)
<span class="linenr">9: </span>log(text)
</pre>
          </div>
          <pre class="example" id="orgad2732b">
--------- ROOT AST ---------
{
  type: 0,
  children: [ { type: 2, content: 'some text', loc: [Object] } ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'some text'
  }
}
--------- TEXT AST ---------
{
  type: 2,
  content: 'some text',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'some text'
  }
}
undefined
</pre>
        </div>
      </div>
      <div id="outline-container-org9ef9bcc" class="outline-3">
        <h3 id="org9ef9bcc"><span class=
        "section-number-3">2.5.</span> parseTextData()</h3>
        <div class="outline-text-3" id="text-2-5">
          <p>根据 <a href="#org88fd8d1">parseText()</a>
          中解析出来的文本长度取出文本内容，这里会将 <a href="#coderef-html-entities"
          class="coderef" onmouseover=
          "CodeHighlightOn(this, 'coderef-html-entities');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-html-entities');">HTML
          entities</a> 进行转换。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org502d769"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseTextData</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">length</span>, <span class=
            "org-variable-name">mode</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawText</span> = context.source.slice(<span class="org-highlight-numbers-number">0</span>, length)
<span class="linenr"> 3: </span>  advanceBy(context, length)
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">不含HTML entities</span>
<span class="linenr"> 6: </span>  <span class=
"org-keyword">if</span> (mode === TextModes.RAWTEXT || mode === TextModes.CDATA || !rawText.includes(<span class="org-string">'&amp;'</span>)) {
<span class="linenr"> 7: </span>    <span class=
"org-keyword">return</span> rawText
<span class="linenr"> 8: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr"> 9: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将 &amp;gt; -&gt; `&gt;`, &amp;lt; -&gt; `&lt;`, &amp;amp; -&gt; `&amp;`, &amp;apos; -&gt; `'`, &amp;quot; -&gt; `"`</span>
<span class="linenr">10: </span>    <span class=
"org-keyword">return</span> context.options.decodeEntities(rawText, mode === TextModes.ATTRIBUTE_VALUE)
<span class="linenr">11: </span>  }
<span class="linenr">12: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org355cd37" class="outline-3">
        <h3 id="org355cd37"><span class=
        "section-number-3">2.6.</span> parseInterpolation()</h3>
        <div class="outline-text-3" id="text-2-6">
          <p>插值解析(<code>{{...}}</code>)，根据 <code>{{</code> 和
          <code>}}</code> 的位置索引找到它们中间的内容，去掉前后多余的空 格之后得到具体的插值内容。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="orgc1cd0fc"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseInterpolation</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">mode</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> [<span class=
"org-variable-name">open</span>, <span class=
"org-variable-name">close</span>] = context.options.delimiters
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如： source = "{{ a + b }}"</span>
<span class="linenr"> 5: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">closeIndex = indexOf("}}", "{{".length) = 9</span>
<span class="linenr"> 6: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">closeIndex</span> = context.source.indexOf(close, open.length)
<span class="linenr"> 7: </span>  <span class=
"org-keyword">if</span> (closeIndex === -<span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr"> 8: </span>    emitError(context, <span class=
"org-string">'X_MISSING_INTERPOLATION_END'</span>)
<span class="linenr"> 9: </span>    <span class=
"org-keyword">return</span> <span class=
"org-constant">undefined</span>
<span class="linenr">10: </span>  }
<span class="linenr">11: </span>
<span class="linenr">12: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">13: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&gt;&gt; 2 -&gt; " a + b }}"</span>
<span class="linenr">14: </span>  advanceBy(context, open.length)
<span class="linenr">15: </span>
<span class="linenr">16: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">{ line, column, offset }</span>
<span class="linenr">17: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">innerStart</span> = getCursor(context)
<span class="linenr">18: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">innerEnd</span> = getCursor(context)
<span class="linenr">19: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">9 - '{{'.length = 7</span>
<span class="linenr">20: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawContentLength</span> = closeIndex - open.length
<span class="linenr">21: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">" a + b }}".slice(0, 7) =&gt; " a + b "</span>
<span class="linenr">22: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawContent</span> = context.source.slice(<span class="org-highlight-numbers-number">0</span>, rawContentLength)
<span class="linenr">23: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">preTrimContent</span> = parseTextData(context, rawContentLength, mode)
<span class="linenr">24: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">" a + b " =&gt; "a + b"</span>
<span class="linenr">25: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">content</span> = preTrimContent.trim()
<span class="linenr">26: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">startOffset</span> = preTrimContent.indexOf(content)
<span class="linenr">27: </span>  <span class=
"org-keyword">if</span> (startOffset &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">28: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">处理换行问题</span>
<span class=
"linenr">29: </span>    advancePositionWithMutation(innerStart, rawContent, startOffset)
<span class="linenr">30: </span>  }
<span class="linenr">31: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endOffset</span> = rawContentLength - (preTrimContent.length - content.length - startOffset)
<span class=
"linenr">32: </span>  advancePositionWithMutation(innerEnd, rawContent, endOffset)
<span class="linenr">33: </span>  advanceBy(context, close.length)
<span class="linenr">34: </span>
<span class="linenr">35: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">36: </span>    type: NodeTypes.INTERPOLATION,
<span class="linenr">37: </span>    content: {
<span class=
"linenr">38: </span>      type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr">39: </span>      isStatic: <span class=
"org-constant">false</span>,
<span class="linenr">40: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Set `isConstant` to false by default and will decide in transformExpression</span>
<span class=
"linenr">41: </span>      constType: ConstantTypes.NOT_CONSTANT,
<span class="linenr">42: </span>      content,
<span class=
"linenr">43: </span>      loc: getSelection(context, innerStart, innerEnd)
<span class="linenr">44: </span>    },
<span class=
"linenr">45: </span>    loc: getSelection(context, start)
<span class="linenr">46: </span>  }
<span class="linenr">47: </span>}
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some {{ foo + bar }} text'</span>)
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 6: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1 -&gt; interpolation</span>
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">inter</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text2</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 9: </span>
<span class="linenr">10: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">11: </span>logg(<span class=
"org-string">'Text1'</span>, text1)
<span class="linenr">12: </span>logg(<span class=
"org-string">'INTERPOLATION'</span>, inter)
<span class="linenr">13: </span>logg(<span class=
"org-string">'Text2'</span>, text2)
</pre>
            </div>
            <pre class="example" id="org3c3fef7">
--------- AST ---------
{
  type: 0,
  children: [
    { type: 2, content: 'some ', loc: [Object] },
    { type: 5, content: [Object], loc: [Object] },
    { type: 2, content: ' text', loc: [Object] }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 26, line: 1, offset: 25 },
    source: 'some {{ foo + bar }} text'
  }
}
--------- Text1 ---------
{
  type: 2,
  content: 'some ',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: 'some '
  }
}
--------- INTERPOLATION ---------
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    constType: 0,
    content: 'foo + bar',
    loc: { start: [Object], end: [Object], source: 'foo + bar' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 21, line: 1, offset: 20 },
    source: '{{ foo + bar }}'
  }
}
--------- Text2 ---------
{
  type: 2,
  content: ' text',
  loc: {
    start: { column: 21, line: 1, offset: 20 },
    end: { column: 26, line: 1, offset: 25 },
    source: ' text'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing-with-&lt;</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some {{ a &lt; b &amp;& c &gt; d }} text'</span>)
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 6: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1 -&gt; interpolation</span>
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">inter</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text2</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 9: </span>
<span class="linenr">10: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">11: </span>logg(<span class=
"org-string">'Text1'</span>, text1)
<span class="linenr">12: </span>logg(<span class=
"org-string">'INTERPOLATION'</span>, inter)
<span class="linenr">13: </span>logg(<span class=
"org-string">'Text2'</span>, text2)
</pre>
            </div>
            <pre class="example" id="org660ea16">
--------- AST ---------
{
  type: 0,
  children: [
    { type: 2, content: 'some ', loc: [Object] },
    { type: 5, content: [Object], loc: [Object] },
    { type: 2, content: ' text', loc: [Object] }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 31, line: 1, offset: 30 },
    source: 'some {{ a &lt; b &amp;& c &gt; d }} text'
  }
}
--------- Text1 ---------
{
  type: 2,
  content: 'some ',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: 'some '
  }
}
--------- INTERPOLATION ---------
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    constType: 0,
    content: 'a &lt; b &amp;& c &gt; d',
    loc: { start: [Object], end: [Object], source: 'a &lt; b &amp;& c &gt; d' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 26, line: 1, offset: 25 },
    source: '{{ a &lt; b &amp;& c &gt; d }}'
  }
}
--------- Text2 ---------
{
  type: 2,
  content: ' text',
  loc: {
    start: { column: 26, line: 1, offset: 25 },
    end: { column: 31, line: 1, offset: 30 },
    source: ' text'
  }
}
undefined
</pre>
          </details>
        </div>
      </div>
      <div id="outline-container-org816f7bb" class="outline-3">
        <h3 id="org816f7bb"><span class=
        "section-number-3">2.7.</span> parseElement()</h3>
        <div class="outline-text-3" id="text-2-7">
          <div class="org-src-container">
            <pre class="src src-js" id="org7aaf5f4"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseElement</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">ancestors</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr"> 3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. 解析出开始标签</span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = parseTag(context, TagType.Start, parent)
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">自闭合的标签： &lt;div/&gt;</span>
<span class="linenr"> 7: </span>  <span class=
"org-keyword">if</span> (element.isSelfClosing || context.options.isVoidTag(element.tag)) {
<span class="linenr"> 8: </span>    <span class=
"org-keyword">return</span> element
<span class="linenr"> 9: </span>  }
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">children</span>
<span class="linenr">12: </span>  ancestors.push(element)
<span class="linenr">13: </span>
<span class="linenr">14: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">mode</span> = context.options.getTextMode(element, parent)
<span class="linenr">15: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">递归解析子节点</span>
<span class="linenr">16: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">children</span> = parseChildren(context, mode, ancestors)
<span class="linenr">17: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">解析完出栈 [root, parent1, parent2, ...] 代表层级</span>
<span class="linenr">18: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;root&gt;&lt;parent1&gt;&lt;parent2&gt;&lt;/parent&gt;&lt;parent1&gt;&lt;/root&gt; -&gt; 解析过程中通过</span>
<span class="linenr">19: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ancestors 来维护这个层级关系</span>
<span class="linenr">20: </span>  ancestors.pop()
<span class="linenr">21: </span>
<span class="linenr">22: </span>  element.children = children
<span class="linenr">23: </span>
<span class="linenr">24: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 解析结束标签</span>
<span class="linenr">25: </span>  <span class=
"org-keyword">if</span> (startsWithEndTagOpen(context.source, element.tag)) {
<span class=
"linenr">26: </span>    parseTag(context, TagType.End, parent)
<span class="linenr">27: </span>  }
<span class="linenr">28: </span>
<span class="linenr">29: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">更新解析后节点在源码中的位置信息</span>
<span class=
"linenr">30: </span>  element.loc = getSelection(context, element.loc.start)
<span class="linenr">31: </span>
<span class="linenr">32: </span>  <span class=
"org-keyword">return</span> element
<span class="linenr">33: </span>}
</pre>
          </div><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some &lt;span&gt;text&lt;/span&gt;'</span>)
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">span</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text2</span> = span.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">10: </span>logg(<span class=
"org-string">'text1'</span>, text1)
<span class="linenr">11: </span>logg(<span class=
"org-string">'span'</span>, span)
<span class="linenr">12: </span>logg(<span class=
"org-string">'text2'</span>, text2)
</pre>
            </div>
            <pre class="example" id="orge9f6d82">
--------- AST ---------
{
  type: 0,
  children: [
    { type: 2, content: 'some ', loc: [Object] },
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 23, line: 1, offset: 22 },
    source: 'some &lt;span&gt;text&lt;/span&gt;'
  }
}
--------- text1 ---------
{
  type: 2,
  content: 'some ',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: 'some '
  }
}
--------- span ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [ { type: 2, content: 'text', loc: [Object] } ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 23, line: 1, offset: 22 },
    source: '&lt;span&gt;text&lt;/span&gt;'
  },
  codegenNode: undefined
}
--------- text2 ---------
{
  type: 2,
  content: 'text',
  loc: {
    start: { column: 12, line: 1, offset: 11 },
    end: { column: 16, line: 1, offset: 15 },
    source: 'text'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing self closing</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div/&gt;after'</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">7: </span>
<span class="linenr">8: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">9: </span>logg(<span class=
"org-string">'text'</span>, text)
</pre>
            </div>
            <pre class="example" id="orgae52adc">
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 7, line: 1, offset: 6 },
    source: '&lt;div/&gt;'
  },
  codegenNode: undefined
}
--------- text ---------
{
  type: 2,
  content: 'after',
  loc: {
    start: { column: 7, line: 1, offset: 6 },
    end: { column: 12, line: 1, offset: 11 },
    source: 'after'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing void element by
              isVoidElement</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;img&gt;after'</span>, {
<span class=
"linenr"> 4: </span>  isVoidTag: tag =&gt; tag === <span class=
"org-string">'img'</span>
<span class="linenr"> 5: </span>})
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 9: </span>
<span class="linenr">10: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">11: </span>logg(<span class=
"org-string">'text'</span>, text)
</pre>
            </div>
            <pre class="example" id="orgbccd09f">
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'img',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: '&lt;img&gt;'
  },
  codegenNode: undefined
}
--------- text ---------
{
  type: 2,
  content: 'after',
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 11, line: 1, offset: 10 },
    source: 'after'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing slot</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;slot&gt;&lt;/slot&gt;&lt;Comp&gt;&lt;/Comp&gt;`</span>)
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">slot</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">comp</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'slot'</span>, slot)
<span class="linenr">10: </span>logg(<span class=
"org-string">'comp'</span>, comp)
</pre>
            </div>
            <pre class="example" id="orgdd676d5">
--------- slot ---------
{
  type: 1,
  ns: 0,
  tag: 'slot',
  tagType: 2,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 14, line: 1, offset: 13 },
    source: '&lt;slot&gt;&lt;/slot&gt;'
  },
  codegenNode: undefined
}
--------- comp ---------
{
  type: 1,
  ns: 0,
  tag: 'Comp',
  tagType: 1,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 14, line: 1, offset: 13 },
    end: { column: 27, line: 1, offset: 26 },
    source: '&lt;Comp&gt;&lt;/Comp&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details>
        </div>
      </div>
      <div id="outline-container-org63235c0" class="outline-3">
        <h3 id="org63235c0"><span class=
        "section-number-3">2.8.</span> parseTag()</h3>
        <div class="outline-text-3" id="text-2-8">
          <div class="org-src-container">
            <pre class="src src-js" id="orgf609657"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseTag</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">type</span>, <span class=
            "org-variable-name">parent</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. 开始标签</span>
<span class="linenr"> 3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 4: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">合法标签的正则匹配</span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/</span>i.exec(context.source)
<span class="linenr"> 6: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">tag</span> = match[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 7: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = context.options.getNamespace(tag, parent)
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">游标前进标签名长度的位置，如： &lt;div id="foo"&gt; -&gt; ` id="foo"&gt;`</span>
<span class=
"linenr">10: </span>  advanceBy(context, match[<span class=
"org-highlight-numbers-number">0</span>].length)
<span class="linenr">11: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">空格处理</span>
<span class="linenr">12: </span>  advanceSpaces(context)
<span class="linenr">13: </span>
<span class="linenr">14: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">parse attributes</span>
<span class="linenr">15: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">props</span> = parseAttributes(context, type)
<span class="linenr">16: </span>
<span class="linenr">17: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span><span class=
"org-comment"> v-pre 检测</span>
<span class="linenr">18: </span>
<span class="linenr">19: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 闭合标签</span>
<span class="linenr">20: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isSelfClosing</span> = <span class=
"org-constant">false</span>
<span class="linenr">21: </span>  <span class=
"org-keyword">if</span> (context.source.length === <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">22: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">非法情况, ignore</span>
<span class="linenr">23: </span>  } <span class=
"org-keyword">else</span> {
<span class=
"linenr">24: </span>    isSelfClosing = startsWith(context.source, <span class="org-string">'/&gt;'</span>)
<span class=
"linenr">25: </span>    advanceBy(context, isSelfClosing ? <span class="org-highlight-numbers-number">2</span> : <span class="org-highlight-numbers-number">1</span>)
<span class="linenr">26: </span>  }
<span class="linenr">27: </span>
<span class="linenr">28: </span>  <span class=
"org-keyword">if</span> (type === TagType.End) {
<span class="linenr">29: </span>    <span class=
"org-keyword">return</span>
<span class="linenr">30: </span>  }
<span class="linenr">31: </span>
<span class="linenr">32: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. 分析出标签的类型</span>
<span class="linenr">33: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">tagType</span> = ElementTypes.ELEMENT
<span class="linenr">34: </span>  <span class=
"org-keyword">if</span> (!context.inVPre) {
<span class="linenr">35: </span>    <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'slot'</span>) {
<span class="linenr">36: </span>      tagType = ElementTypes.SLOT
<span class="linenr">37: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'template'</span>) {
<span class="linenr">38: </span>      <span class=
"org-keyword">if</span> (props.some(p =&gt; p.type === NodeTypes.DIRECTIVE &amp;& isSpecialTemplateDirective(p.name))) {
<span class=
"linenr">39: </span>        tagType = ElementTypes.TEMPLATE
<span class="linenr">40: </span>      }
<span class="linenr">41: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isComponent(tag, props, context)) {
<span class=
"linenr">42: </span>      tagType = ElementTypes.COMPONENT
<span class="linenr">43: </span>    }
<span class="linenr">44: </span>  }
<span class="linenr">45: </span>
<span class="linenr">46: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">47: </span>    type: NodeTypes.ELEMENT,
<span class="linenr">48: </span>    ns,
<span class="linenr">49: </span>    tag,
<span class="linenr">50: </span>    tagType,
<span class="linenr">51: </span>    props,
<span class="linenr">52: </span>    isSelfClosing,
<span class="linenr">53: </span>    children: [],
<span class=
"linenr">54: </span>    loc: getSelection(context, start),
<span class="linenr">55: </span>    codegenNode: <span class=
"org-constant">undefined</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">在 transform 阶段生成的产物</span>
<span class="linenr">56: </span>  }
<span class="linenr">57: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-orgf134308" class="outline-3">
        <h3 id="orgf134308"><span class=
        "section-number-3">2.9.</span> parseAttributes()</h3>
        <div class="outline-text-3" id="text-2-9">
          <div class="org-src-container">
            <pre class="src src-js" id="orgca7478f"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseAttributes</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">type</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = []
<span class="linenr"> 3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">用 set 避免重复属性</span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">attributeNames</span> = <span class=
"org-keyword">new</span> <span class="org-type">Set</span>()
<span class="linenr"> 5: </span>  <span class=
"org-keyword">while</span> (
<span class=
"linenr"> 6: </span>    context.source.length &gt; <span class=
"org-highlight-numbers-number">0</span> &amp;&
<span class=
"linenr"> 7: </span>      !startsWith(context.source, <span class=
"org-string">'&gt;'</span>) &amp;&
<span class=
"linenr"> 8: </span>      !startsWith(context.source, <span class=
"org-string">'/&gt;'</span>)
<span class="linenr"> 9: </span>  ) {
<span class="linenr">10: </span>
<span class="linenr">11: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">一些非法检测, ignore</span>
<span class="linenr">12: </span>
<span class="linenr">13: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">attr</span> = parseAttribute(context, attributeNames)
<span class="linenr">14: </span>
<span class="linenr">15: </span>    logg(<span class=
"org-string">'ATTR'</span>, attr)
<span class="linenr">16: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">去掉 class 之间多余的空格，如： `foo   bar  ` -&gt; `foo bar`</span>
<span class="linenr">17: </span>    <span class=
"org-keyword">if</span> (attr.type === NodeTypes.ATTRIBUTE &amp;&
<span id="coderef-remove-class-whitespace" class=
"coderef-off"><span class=
"linenr">18: </span>       attr.value &amp;& attr.name === <span class="org-string">'class'</span>) {</span>
<span class=
"linenr">19: </span>      attr.value.content = attr.value.content.replace(<span class="org-string">/\s+/</span>g, <span class="org-string">' '</span>).trim()
<span class="linenr">20: </span>    }
<span class="linenr">21: </span>
<span class="linenr">22: </span>    <span class=
"org-keyword">if</span> (type === TagType.Start) {
<span class="linenr">23: </span>      props.push(attr)
<span class="linenr">24: </span>    }
<span class="linenr">25: </span>
<span class="linenr">26: </span>    advanceSpaces(context)
<span class="linenr">27: </span>  }
<span class="linenr">28: </span>
<span class="linenr">29: </span>  <span class=
"org-keyword">return</span> props
<span class="linenr">30: </span>}
</pre>
          </div><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing v-if directive</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;template v-if="ok"&gt;&lt;/template&gt;`</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>
<span class="linenr">7: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">8: </span>logg(<span class=
"org-string">'element'</span>, element)
</pre>
            </div>
            <pre class="example" id="org516d4e8">
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 20, line: 1, offset: 19 },
    source: 'v-if="ok"'
  }
}
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'template',
      tagType: 3,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 32, line: 1, offset: 31 },
    source: '&lt;template v-if="ok"&gt;&lt;/template&gt;'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'template',
  tagType: 3,
  props: [
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 32, line: 1, offset: 31 },
    source: '&lt;template v-if="ok"&gt;&lt;/template&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing template without
              directives</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;template&gt;&lt;/template&gt;`</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>
<span class="linenr">7: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">8: </span>logg(<span class=
"org-string">'element'</span>, element)
</pre>
            </div>
            <pre class="example" id="orgf03ea4b">
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'template',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: '&lt;template&gt;&lt;/template&gt;'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'template',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: '&lt;template&gt;&lt;/template&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing without value</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div id&gt;&lt;/div&gt;"</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>
<span class="linenr">7: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">8: </span>logg(<span class=
"org-string">'element'</span>, element)
</pre>
            </div>
            <pre class="example" id="org77fa31d">
--------- ATTR ---------
{
  type: 6,
  name: 'id',
  value: undefined,
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 8, line: 1, offset: 7 },
    source: 'id'
  }
}
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 15, line: 1, offset: 14 },
    source: '&lt;div id&gt;&lt;/div&gt;'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [ { type: 6, name: 'id', value: undefined, loc: [Object] } ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 15, line: 1, offset: 14 },
    source: '&lt;div id&gt;&lt;/div&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing multiple attributes</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div id=a class="c" inert style=\'\'&gt;'</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = element.props
<span class="linenr">7: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">8: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">9: </span>logg(<span class=
"org-string">'props'</span>, props)
</pre>
            </div>
            <pre class="example" id="orga38724e">
--------- ATTR ---------
{
  type: 6,
  name: 'id',
  value: {
    type: 2,
    content: 'a',
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'id=a'
  }
}
--------- ATTR ---------
{
  type: 6,
  name: 'class',
  value: {
    type: 2,
    content: 'c',
    loc: { start: [Object], end: [Object], source: '"c"' }
  },
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 20, line: 1, offset: 19 },
    source: 'class="c"'
  }
}
--------- ATTR ---------
{
  type: 6,
  name: 'inert',
  value: undefined,
  loc: {
    start: { column: 21, line: 1, offset: 20 },
    end: { column: 26, line: 1, offset: 25 },
    source: 'inert'
  }
}
--------- ATTR ---------
{
  type: 6,
  name: 'style',
  value: {
    type: 2,
    content: '',
    loc: { start: [Object], end: [Object], source: "''" }
  },
  loc: {
    start: { column: 27, line: 1, offset: 26 },
    end: { column: 35, line: 1, offset: 34 },
    source: "style=''"
  }
}
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 36, line: 1, offset: 35 },
    source: `&lt;div id=a class="c" inert style=''&gt;`
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    { type: 6, name: 'id', value: [Object], loc: [Object] },
    { type: 6, name: 'class', value: [Object], loc: [Object] },
    { type: 6, name: 'inert', value: undefined, loc: [Object] },
    { type: 6, name: 'style', value: [Object], loc: [Object] }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 36, line: 1, offset: 35 },
    source: `&lt;div id=a class="c" inert style=''&gt;`
  },
  codegenNode: undefined
}
--------- props ---------
[
  {
    type: 6,
    name: 'id',
    value: { type: 2, content: 'a', loc: [Object] },
    loc: { start: [Object], end: [Object], source: 'id=a' }
  },
  {
    type: 6,
    name: 'class',
    value: { type: 2, content: 'c', loc: [Object] },
    loc: { start: [Object], end: [Object], source: 'class="c"' }
  },
  {
    type: 6,
    name: 'inert',
    value: undefined,
    loc: { start: [Object], end: [Object], source: 'inert' }
  },
  {
    type: 6,
    name: 'style',
    value: { type: 2, content: '', loc: [Object] },
    loc: { start: [Object], end: [Object], source: "style=''" }
  }
]
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing class attribute ignore
              whitespace</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div class=" \n\t c \t\n "&gt;&lt;/div&gt;'</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>
<span class="linenr">6: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">7: </span>logg(<span class=
"org-string">'props'</span>, element.props)
</pre>
            </div>
            <pre class="example" id="org2d042a3">
--------- ATTR ---------
{
  type: 6,
  name: 'class',
  value: {
    type: 2,
    content: ' \n\t c \t\n ',
    loc: { start: [Object], end: [Object], source: '" \n\t c \t\n "' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 3, line: 3, offset: 22 },
    source: 'class=" \n\t c \t\n "'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [ { type: 6, name: 'class', value: [Object], loc: [Object] } ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 3, offset: 29 },
    source: '&lt;div class=" \n\t c \t\n "&gt;&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- props ---------
[
  {
    type: 6,
    name: 'class',
    value: { type: 2, content: 'c', loc: [Object] },
    loc: { start: [Object], end: [Object], source: 'class=" \n\t c \t\n "' }
  }
]
undefined
</pre>
            <p>对于 class 值中空格的处理在这 <a href=
            "#orgca7478f">parseAttributes</a> 中 <a href=
            "#coderef-remove-class-whitespace" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-remove-class-whitespace');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-remove-class-whitespace');">
            18</a>。</p>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with argument</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div v-on:click /&gt;'</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">7: </span>logg(<span class=
"org-string">'props'</span>, element.props)
<span class="linenr">8: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="orgcbe0364">
parseAttribute| match=v-on:click,on,click,
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 16, line: 1, offset: 15 },
    source: 'v-on:click'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: '&lt;div v-on:click /&gt;'
  },
  codegenNode: undefined
}
--------- props ---------
[
  {
    type: 7,
    name: 'on',
    exp: undefined,
    arg: {
      type: 4,
      content: 'click',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-on:click' }
  }
]
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 16, line: 1, offset: 15 },
    source: 'v-on:click'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with dynamic
              argument</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div v-on:[event] /&gt;"</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">7: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="org3a0e13d">
parseAttribute| match=v-on:[event],on,[event],
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'event',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[event]' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 18, line: 1, offset: 17 },
    source: 'v-on:[event]'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 21, line: 1, offset: 20 },
    source: '&lt;div v-on:[event] /&gt;'
  },
  codegenNode: undefined
}
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'event',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[event]' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 18, line: 1, offset: 17 },
    source: 'v-on:[event]'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with argument and
              modifiers</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div v-on:click.enter.exact /&gt;"</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">7: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="org00cd92e">
parseAttribute| match=v-on:click.enter.exact,on,click,.enter.exact
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [ 'enter', 'exact' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 28, line: 1, offset: 27 },
    source: 'v-on:click.enter.exact'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;div v-on:click.enter.exact /&gt;'
  },
  codegenNode: undefined
}
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [ 'enter', 'exact' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 28, line: 1, offset: 27 },
    source: 'v-on:click.enter.exact'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with dynamic argument and
              modifiers and shorthand</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr">2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">3: </span>
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div v-on:[a.b].camel :a=b /&gt;"</span>)
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">7: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="orgfd8aa7c">
parseAttribute| match=v-on:[a.b].camel,on,[a.b],.camel
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'a.b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[a.b]' }
  },
  modifiers: [ 'camel' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 22, line: 1, offset: 21 },
    source: 'v-on:[a.b].camel'
  }
}
parseAttribute| match=:a,,a,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'b' }
  },
  arg: {
    type: 4,
    content: 'a',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  modifiers: [],
  loc: {
    start: { column: 23, line: 1, offset: 22 },
    end: { column: 27, line: 1, offset: 26 },
    source: ':a=b'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 30, line: 1, offset: 29 },
    source: '&lt;div v-on:[a.b].camel :a=b /&gt;'
  },
  codegenNode: undefined
}
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'a.b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[a.b]' }
  },
  modifiers: [ 'camel' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 22, line: 1, offset: 21 },
    source: 'v-on:[a.b].camel'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing complex scenario</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`</span>
<span class="linenr"> 5: </span><span class=
"org-string">&lt;div</span>
<span class="linenr"> 6: </span><span class=
"org-string">  v-bind:a="b"</span>
<span class="linenr"> 7: </span><span class=
"org-string">  v-bind:[c.d]="e"</span>
<span class="linenr"> 8: </span><span class=
"org-string">  :f="g"</span>
<span class="linenr"> 9: </span><span class=
"org-string">  v-on:[h.i].camel</span>
<span class="linenr">10: </span><span class=
"org-string">  v-on:click.camel.exact="j"</span>
<span class="linenr">11: </span><span class=
"org-string">  @keyup.enter.prevent="k"</span>
<span class="linenr">12: </span><span class=
"org-string">  v-if="l &gt; m"</span>
<span class="linenr">13: </span><span class=
"org-string">  .n=o</span>
<span class="linenr">14: </span><span class=
"org-string">  :p.sync=q</span>
<span class="linenr">15: </span><span class=
"org-string">&gt;&lt;/div&gt;</span>
<span class="linenr">16: </span><span class=
"org-string">&lt;Comp1 #a="{ b }"/&gt;</span>
<span class="linenr">17: </span><span class=
"org-string">&lt;Comp2 v-slot:foo.bar="{ a }"/&gt;</span>
<span class="linenr">18: </span><span class="org-string">`</span>)
<span class="linenr">19: </span>
<span class="linenr">20: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">div</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">21: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">comp1</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">22: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">comp2</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr">23: </span>
<span class="linenr">24: </span>logg(<span class=
"org-string">'div'</span>, div)
<span class="linenr">25: </span>logg(<span class=
"org-string">'div-props'</span>, div.props)
<span class="linenr">26: </span>logg(<span class=
"org-string">'comp1'</span>, comp1)
<span class="linenr">27: </span>logg(<span class=
"org-string">'comp1-slot'</span>, comp1.props)
<span class="linenr">28: </span>logg(<span class=
"org-string">'comp2'</span>, comp2)
<span class="linenr">29: </span>logg(<span class=
"org-string">'comp2-slot'</span>, comp2.props)
</pre>
            </div>
            <pre class="example" id="org6db9aa9">
parseAttribute| match=v-bind:a,bind,a,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'b' }
  },
  arg: {
    type: 4,
    content: 'a',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  modifiers: [],
  loc: {
    start: { column: 3, line: 3, offset: 8 },
    end: { column: 15, line: 3, offset: 20 },
    source: 'v-bind:a="b"'
  }
}
parseAttribute| match=v-bind:[c.d],bind,[c.d],
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'e',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'e' }
  },
  arg: {
    type: 4,
    content: 'c.d',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[c.d]' }
  },
  modifiers: [],
  loc: {
    start: { column: 3, line: 4, offset: 23 },
    end: { column: 19, line: 4, offset: 39 },
    source: 'v-bind:[c.d]="e"'
  }
}
parseAttribute| match=:f,,f,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'g',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'g' }
  },
  arg: {
    type: 4,
    content: 'f',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'f' }
  },
  modifiers: [],
  loc: {
    start: { column: 3, line: 5, offset: 42 },
    end: { column: 9, line: 5, offset: 48 },
    source: ':f="g"'
  }
}
parseAttribute| match=v-on:[h.i].camel,on,[h.i],.camel
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'h.i',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[h.i]' }
  },
  modifiers: [ 'camel' ],
  loc: {
    start: { column: 3, line: 6, offset: 51 },
    end: { column: 19, line: 6, offset: 67 },
    source: 'v-on:[h.i].camel'
  }
}
parseAttribute| match=v-on:click.camel.exact,on,click,.camel.exact
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: {
    type: 4,
    content: 'j',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'j' }
  },
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [ 'camel', 'exact' ],
  loc: {
    start: { column: 3, line: 7, offset: 70 },
    end: { column: 29, line: 7, offset: 96 },
    source: 'v-on:click.camel.exact="j"'
  }
}
parseAttribute| match=@keyup.enter.prevent,,keyup,.enter.prevent
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: {
    type: 4,
    content: 'k',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'k' }
  },
  arg: {
    type: 4,
    content: 'keyup',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'keyup' }
  },
  modifiers: [ 'enter', 'prevent' ],
  loc: {
    start: { column: 3, line: 8, offset: 99 },
    end: { column: 27, line: 8, offset: 123 },
    source: '@keyup.enter.prevent="k"'
  }
}
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'l &gt; m',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'l &gt; m' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 3, line: 9, offset: 126 },
    end: { column: 15, line: 9, offset: 138 },
    source: 'v-if="l &gt; m"'
  }
}
parseAttribute| match=.n,,n,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'o',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'o' }
  },
  arg: {
    type: 4,
    content: 'n',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'n' }
  },
  modifiers: [ 'prop' ],
  loc: {
    start: { column: 3, line: 10, offset: 141 },
    end: { column: 7, line: 10, offset: 145 },
    source: '.n=o'
  }
}
parseAttribute| match=:p.sync,,p,.sync
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'q',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'q' }
  },
  arg: {
    type: 4,
    content: 'p',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'p' }
  },
  modifiers: [ 'sync' ],
  loc: {
    start: { column: 3, line: 11, offset: 148 },
    end: { column: 12, line: 11, offset: 157 },
    source: ':p.sync=q'
  }
}
parseAttribute| match=#a,,a,
--------- ATTR ---------
{
  type: 7,
  name: 'slot',
  exp: {
    type: 4,
    content: '{ b }',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '{ b }' }
  },
  arg: {
    type: 4,
    content: 'a',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  modifiers: [],
  loc: {
    start: { column: 8, line: 13, offset: 173 },
    end: { column: 18, line: 13, offset: 183 },
    source: '#a="{ b }"'
  }
}
parseAttribute| match=v-slot:foo.bar,slot,foo,.bar
--------- ATTR ---------
{
  type: 7,
  name: 'slot',
  exp: {
    type: 4,
    content: '{ a }',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '{ a }' }
  },
  arg: {
    type: 4,
    content: 'foo.bar',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'foo.bar' }
  },
  modifiers: [ 'bar' ],
  loc: {
    start: { column: 8, line: 14, offset: 193 },
    end: { column: 30, line: 14, offset: 215 },
    source: 'v-slot:foo.bar="{ a }"'
  }
}
--------- div ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'on',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'on',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 2, offset: 1 },
    end: { column: 8, line: 12, offset: 165 },
    source: '&lt;div\n' +
      '  v-bind:a="b"\n' +
      '  v-bind:[c.d]="e"\n' +
      '  :f="g"\n' +
      '  v-on:[h.i].camel\n' +
      '  v-on:click.camel.exact="j"\n' +
      '  @keyup.enter.prevent="k"\n' +
      '  v-if="l &gt; m"\n' +
      '  .n=o\n' +
      '  :p.sync=q\n' +
      '&gt;&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- div-props ---------
[
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'b',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'a',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-bind:a="b"' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'e',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'c.d',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-bind:[c.d]="e"' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'g',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'f',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: ':f="g"' }
  },
  {
    type: 7,
    name: 'on',
    exp: undefined,
    arg: {
      type: 4,
      content: 'h.i',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    modifiers: [ 'camel' ],
    loc: { start: [Object], end: [Object], source: 'v-on:[h.i].camel' }
  },
  {
    type: 7,
    name: 'on',
    exp: {
      type: 4,
      content: 'j',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'click',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'camel', 'exact' ],
    loc: {
      start: [Object],
      end: [Object],
      source: 'v-on:click.camel.exact="j"'
    }
  },
  {
    type: 7,
    name: 'on',
    exp: {
      type: 4,
      content: 'k',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'keyup',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'enter', 'prevent' ],
    loc: {
      start: [Object],
      end: [Object],
      source: '@keyup.enter.prevent="k"'
    }
  },
  {
    type: 7,
    name: 'if',
    exp: {
      type: 4,
      content: 'l &gt; m',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: undefined,
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-if="l &gt; m"' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'o',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'n',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'prop' ],
    loc: { start: [Object], end: [Object], source: '.n=o' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'q',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'p',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'sync' ],
    loc: { start: [Object], end: [Object], source: ':p.sync=q' }
  }
]
--------- comp1 ---------
{
  type: 1,
  ns: 0,
  tag: 'Comp1',
  tagType: 1,
  props: [
    {
      type: 7,
      name: 'slot',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 13, offset: 166 },
    end: { column: 20, line: 13, offset: 185 },
    source: '&lt;Comp1 #a="{ b }"/&gt;'
  },
  codegenNode: undefined
}
--------- comp1-slot ---------
[
  {
    type: 7,
    name: 'slot',
    exp: {
      type: 4,
      content: '{ b }',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'a',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: '#a="{ b }"' }
  }
]
--------- comp2 ---------
{
  type: 1,
  ns: 0,
  tag: 'Comp2',
  tagType: 1,
  props: [
    {
      type: 7,
      name: 'slot',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 14, offset: 186 },
    end: { column: 32, line: 14, offset: 217 },
    source: '&lt;Comp2 v-slot:foo.bar="{ a }"/&gt;'
  },
  codegenNode: undefined
}
--------- comp2-slot ---------
[
  {
    type: 7,
    name: 'slot',
    exp: {
      type: 4,
      content: '{ a }',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'foo.bar',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'bar' ],
    loc: {
      start: [Object],
      end: [Object],
      source: 'v-slot:foo.bar="{ a }"'
    }
  }
]
undefined
</pre>
          </details>
        </div>
        <div id="outline-container-org2f68db3" class="outline-4">
          <h4 id="org2f68db3"><span class=
          "section-number-4">2.9.1.</span> parseAttribute</h4>
          <div class="outline-text-4" id="text-2-9-1">
            <div class="org-src-container">
              <pre class="src src-js" id="org0845247"><span class=
              "linenr">  1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">parseAttribute</span>(<span class=
              "org-variable-name">context</span>, <span class=
              "org-variable-name">nameSet</span>) {
<span class="linenr">  2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">  3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</span>.exec(context.source)
<span class="linenr">  4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> = match[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">  5: </span>
<span class="linenr">  6: </span>  nameSet.add(name)
<span class="linenr">  7: </span>
<span class="linenr">  8: </span>  advanceBy(context, name.length)
<span class="linenr">  9: </span>
<span class="linenr"> 10: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">value</span> = <span class=
"org-constant">undefined</span>
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span>  <span class=
"org-keyword">if</span> (<span class=
"org-string">/^[\t\r\n\f ]*=/</span>.test(context.source)) {
<span class="linenr"> 13: </span>    advanceSpaces(context)
<span class=
"linenr"> 14: </span>    advanceBy(context, <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 15: </span>    advanceSpaces(context)
<span class=
"linenr"> 16: </span>    value = parseAttributeValue(context)
<span class="linenr"> 17: </span>  }
<span class="linenr"> 18: </span>
<span class="linenr"> 19: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = getSelection(context, start)
<span class="linenr"> 20: </span>
<span class="linenr"> 21: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on(@), v-bind(:), v-if, v-else, v-slot(#) 指令</span>
<span class="linenr"> 22: </span>  <span class=
"org-keyword">if</span> (!context.inVPre &amp;& <span class=
"org-string">/^(v-[A-Za-z0-9-]|:|\.|@|#)/</span>.test(name)) {
<span class="linenr"> 23: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/(?:^v-([a-z0-9-]+))?(?:(?::|^\.|^@|^#)(\[[^\]]+\]|[^\.]+))?(.+)?$/</span>i.exec(name)
<span class="linenr"> 24: </span>
<span class="linenr"> 25: </span>    log(<span class=
"org-string">`parseAttribute| match=${match}`</span>)
<span class="linenr"> 26: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isPropShorthand</span> = startsWith(name, <span class="org-string">'.'</span>)
<span class="linenr"> 27: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">dirName</span> =
<span class="linenr"> 28: </span>        match[<span class=
"org-highlight-numbers-number">1</span>] ||
<span class=
"linenr"> 29: </span>        (isPropShorthand || startsWith(name, <span class="org-string">':'</span>)
<span class="linenr"> 30: </span>         ? <span class=
"org-string">'bind'</span>
<span class=
"linenr"> 31: </span>         : startsWith(name, <span class=
"org-string">'@'</span>)
<span class="linenr"> 32: </span>        ? <span class=
"org-string">'on'</span>
<span class="linenr"> 33: </span>        : <span class=
"org-string">'slot'</span>)
<span class="linenr"> 34: </span>    <span class=
"org-keyword">let</span> <span class="org-variable-name">arg</span>
<span class="linenr"> 35: </span>
<span class="linenr"> 36: </span>    <span class=
"org-keyword">if</span> (match[<span class=
"org-highlight-numbers-number">2</span>]) {
<span class="linenr"> 37: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSlot</span> = dirName === <span class=
"org-string">'slot'</span>
<span class="linenr"> 38: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">startOffset</span> = name.lastIndexOf(match[<span class="org-highlight-numbers-number">2</span>])
<span class="linenr"> 39: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = getSelection(
<span class="linenr"> 40: </span>        context,
<span class=
"linenr"> 41: </span>        getNewPosition(context, start, startOffset),
<span class="linenr"> 42: </span>        getNewPosition(
<span class="linenr"> 43: </span>          context,
<span class="linenr"> 44: </span>          start,
<span class=
"linenr"> 45: </span>          startOffset + match[<span class=
"org-highlight-numbers-number">2</span>].length + ((isSlot &amp;& match[<span class="org-highlight-numbers-number">3</span>]) || <span class="org-string">''</span>).length
<span class="linenr"> 46: </span>        )
<span class="linenr"> 47: </span>      )
<span class="linenr"> 48: </span>
<span class="linenr"> 49: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">content</span> = match[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 50: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isStatic</span> = <span class=
"org-constant">true</span>
<span class="linenr"> 51: </span>
<span class="linenr"> 52: </span>      <span class=
"org-keyword">if</span> (content.startsWith(<span class=
"org-string">'['</span>)) {
<span class="linenr"> 53: </span>        isStatic = <span class=
"org-constant">false</span>
<span class="linenr"> 54: </span>
<span class=
"linenr"> 55: </span>        content = content.slice(<span class=
"org-highlight-numbers-number">1</span>, content.length - <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 56: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isSlot){
<span class=
"linenr"> 57: </span>        content += match[<span class=
"org-highlight-numbers-number">3</span>] || <span class=
"org-string">''</span>
<span class="linenr"> 58: </span>      }
<span class="linenr"> 59: </span>
<span class="linenr"> 60: </span>      arg = {
<span class=
"linenr"> 61: </span>        type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 62: </span>        content,
<span class="linenr"> 63: </span>        isStatic,
<span class="linenr"> 64: </span>        constType: isStatic
<span class=
"linenr"> 65: </span>          ? ConstantTypes.CAN_STRINGIFY
<span class=
"linenr"> 66: </span>          : ConstantTypes.NOT_CONSTANT,
<span class="linenr"> 67: </span>        loc
<span class="linenr"> 68: </span>      }
<span class="linenr"> 69: </span>    }
<span class="linenr"> 70: </span>
<span class="linenr"> 71: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">quoted: `foo="bar"`, not quoted: `foo=bar`</span>
<span class="linenr"> 72: </span>    <span class=
"org-keyword">if</span> (value &amp;& value.isQuoted) {
<span class="linenr"> 73: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">valueLoc</span> = value.loc
<span class="linenr"> 74: </span>      valueLoc.start.offset++
<span class="linenr"> 75: </span>      valueLoc.start.column++
<span class=
"linenr"> 76: </span>      valueLoc.end = advancePositionWithClone(valueLoc.start, value.content)
<span class=
"linenr"> 77: </span>      valueLoc.source = valueLoc.source.slice(<span class="org-highlight-numbers-number">1</span>, -<span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 78: </span>    }
<span class="linenr"> 79: </span>
<span class="linenr"> 80: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">修饰符 v-bind.number="foo" =&gt; '.number' =&gt; ['number']</span>
<span class="linenr"> 81: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifiers</span> = match[<span class=
"org-highlight-numbers-number">3</span>] ? match[<span class=
"org-highlight-numbers-number">3</span>].slice(<span class=
"org-highlight-numbers-number">1</span>).split(<span class=
"org-string">'.'</span>) : []
<span class="linenr"> 82: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`&lt;div foo.prop="bar"&gt;` 如果不加 `.prop` 这个会被解析到 `$attrs` 中</span>
<span class="linenr"> 83: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如果加了 `.prop` 则会被解析到 `$props` 中去</span>
<span class="linenr"> 84: </span>    <span class=
"org-keyword">if</span> (isPropShorthand) {
<span class="linenr"> 85: </span>      modifiers.push(<span class=
"org-string">'prop'</span>)
<span class="linenr"> 86: </span>    }
<span class="linenr"> 87: </span>
<span class="linenr"> 88: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr"> 89: </span>      type: NodeTypes.DIRECTIVE,
<span class="linenr"> 90: </span>      name: dirName,
<span class="linenr"> 91: </span>      exp: value &amp;& {
<span class=
"linenr"> 92: </span>        type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 93: </span>        content: value.content,
<span class="linenr"> 94: </span>        isStatic: <span class=
"org-constant">false</span>,
<span class="linenr"> 95: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Treat as non-constant by default. This can be potentially set to</span>
<span class="linenr"> 96: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">other values by `transformExpression` to make it eligible for hoisting.</span>
<span class=
"linenr"> 97: </span>        constType: ConstantTypes.NOT_CONSTANT,
<span class="linenr"> 98: </span>        loc: value.loc
<span class="linenr"> 99: </span>      },
<span class="linenr">100: </span>      arg,
<span class="linenr">101: </span>      modifiers,
<span class="linenr">102: </span>      loc
<span class="linenr">103: </span>    }
<span class="linenr">104: </span>  }
<span class="linenr">105: </span>
<span class="linenr">106: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">107: </span>    type: NodeTypes.ATTRIBUTE,
<span class="linenr">108: </span>    name,
<span class="linenr">109: </span>    value: value &amp;& {
<span class="linenr">110: </span>      type: NodeTypes.TEXT,
<span class="linenr">111: </span>      content: value.content,
<span class="linenr">112: </span>      loc: value.loc
<span class="linenr">113: </span>    },
<span class="linenr">114: </span>    loc
<span class="linenr">115: </span>  }
<span class="linenr">116: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org5b077c4" class="outline-4">
          <h4 id="org5b077c4"><span class=
          "section-number-4">2.9.2.</span> parseAttributeValue</h4>
          <div class="outline-text-4" id="text-2-9-2">
            <p>解析属性的值，区分是不是有引号，如果有引号直接使用引号来计算出值，如是没有引号则 使用
            <code>/^[^\t\t\n\f &gt;]+/</code> 正则来匹配。</p>
            <div class="org-src-container">
              <pre class="src src-js" id="orge5eca97"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">parseAttributeValue</span>(<span class=
              "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 3: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">content</span>
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">quote</span> = context.source[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">value 分两种情况，可以用引号包起来也可以不使用引号</span>
<span class="linenr"> 7: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`&lt;div foo="value"&gt;` 或 `&lt;div foo=value&gt;`</span>
<span class="linenr"> 8: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isQuoted</span> = quote === <span class=
"org-string">`"`</span> || quote === <span class=
"org-string">`'`</span>
<span class="linenr"> 9: </span>  <span class=
"org-keyword">if</span> (isQuoted) {
<span class="linenr">10: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Quoted value.</span>
<span class="linenr">11: </span>    advanceBy(context, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr">12: </span>
<span class="linenr">13: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endIndex</span> = context.source.indexOf(quote)
<span class="linenr">14: </span>    <span class=
"org-keyword">if</span> (endIndex === -<span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">15: </span>      content = parseTextData(
<span class="linenr">16: </span>        context,
<span class="linenr">17: </span>        context.source.length,
<span class="linenr">18: </span>        TextModes.ATTRIBUTE_VALUE
<span class="linenr">19: </span>      )
<span class="linenr">20: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">21: </span>      content = parseTextData(context, endIndex, TextModes.ATTRIBUTE_VALUE)
<span class=
"linenr">22: </span>      advanceBy(context, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr">23: </span>    }
<span class="linenr">24: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">25: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Unquoted</span>
<span class="linenr">26: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[^\t\r\n\f &gt;]+/</span>.exec(context.source)
<span class="linenr">27: </span>    <span class=
"org-keyword">if</span> (!match) {
<span class="linenr">28: </span>      <span class=
"org-keyword">return</span> <span class=
"org-constant">undefined</span>
<span class="linenr">29: </span>    }
<span class=
"linenr">30: </span>    content = parseTextData(context, match[<span class="org-highlight-numbers-number">0</span>].length, TextModes.ATTRIBUTE_VALUE)
<span class="linenr">31: </span>  }
<span class="linenr">32: </span>
<span class="linenr">33: </span>  <span class=
"org-keyword">return</span> { content, isQuoted, loc: getSelection(context, start) }
<span class="linenr">34: </span>}
</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="outline-container-cc-transform" class="outline-2">
      <h2 id="cc-transform"><span class=
      "section-number-2">3.</span> transform</h2>
      <div class="outline-text-2" id="text-cc-transform">
        <p>transform 阶段是将 阶段生成的 AST 树进行加工处理，主要是针对不同的组 件类型和各种指令。</p>
      </div>
      <div id="outline-container-org7022c27" class="outline-3">
        <h3 id="org7022c27"><span class=
        "section-number-3">3.1.</span> transform()</h3>
        <div class="outline-text-3" id="text-3-1">
          <div class="org-src-container">
            <pre class="src src-js" id="orgfffd072"><span class=
            "linenr"> 1: </span>&lt;&lt;createTransformContext&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;traverseNode&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;traverseChildren&gt;&gt;
<span class="linenr"> 4: </span>&lt;&lt;hoists&gt;&gt;
<span class="linenr"> 5: </span>&lt;&lt;createRootCodegen&gt;&gt;
<span class=
"linenr"> 6: </span>&lt;&lt;createStructuralDirectiveTransform&gt;&gt;
<span class="linenr"> 7: </span>&lt;&lt;transform-plugins&gt;&gt;
<span class="linenr"> 8: </span>&lt;&lt;ast-creators&gt;&gt;
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">transform</span>(<span class=
"org-variable-name">root</span>, <span class=
"org-variable-name">options</span>) {
<span class="linenr">11: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">transform 上下文</span>
<span class="linenr">12: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = createTransformContext(root, options)
<span class="linenr">13: </span>
<span class="linenr">14: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">递归遍历整个 ast root 树，最终为每颗子树生成 codegenNode</span>
<span class="linenr">15: </span>  traverseNode(root, context)
<span class="linenr">16: </span>
<span class="linenr">17: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">静态提升处理</span>
<span class="linenr">18: </span>  <span class=
"org-keyword">if</span> (options.hoistStatic) {
<span class="linenr">19: </span>    hoistStatic(root, context)
<span class="linenr">20: </span>  }
<span class="linenr">21: </span>
<span class="linenr">22: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">创建 root codegenNode 代码</span>
<span class="linenr">23: </span>  <span class=
"org-keyword">if</span> (!options.ssr) {
<span class=
"linenr">24: </span>    createRootCodegen(root, context)
<span class="linenr">25: </span>  }
<span class="linenr">26: </span>
<span class="linenr">27: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">finalize meta information</span>
<span class=
"linenr">28: </span>  root.helpers = [...context.helpers.keys()]
<span class=
"linenr">29: </span>  root.components = [...context.components]
<span class=
"linenr">30: </span>  root.directives = [...context.directives]
<span class="linenr">31: </span>  root.imports = context.imports
<span class="linenr">32: </span>  root.hoists = context.hoists
<span class="linenr">33: </span>  root.temps = context.temps
<span class="linenr">34: </span>  root.cached = context.cached
<span class="linenr">35: </span>}
</pre>
          </div>
          <p>其实到 <a href="#org6c912ca">createVNodeCall()</a> 实现之后，
          transform 的主体逻辑就基本完成了，但是这个时 候还并不能使用，是因为 <a href=
          "#coderef-context-nodeTransforms" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-context-nodeTransforms');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-nodeTransforms');">
          context.nodeTransforms</a> 里此时还没内容，也就没法处理类型
          <code>v-if,v-for,...</code> 等等指令系统，这些指令都需要特殊相对应的
          transform 函数来处理，这 些函数在 <a href=
          "https://github.com/vuejs/core/blob/main/packages/compiler-core/src/transforms/">
          core/transforms at main · vuejs/core</a> 下。</p>
          <p>那这个 <a href="#coderef-context-nodeTransforms" class=
          "coderef" onmouseover=
          "CodeHighlightOn(this, 'coderef-context-nodeTransforms');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-nodeTransforms');">
          context.nodeTransforms</a> 填充是在哪里呢(到调用 transform 的地方去
          找-&gt; <a href=
          "https://github.com/vuejs/core/blob/main/packages/compiler-core/src/compile.ts">
          core/compile.ts at main · vuejs/core</a>, 因为这个包被调用都是通过
          <code>compile()</code> 函 数调用的)？</p>
          <p>所以这里加上这部分代码 -&gt; <a href=
          "#orgf238359">baseCompile()</a>, 另外下面
          <code>transformXxx</code> 函数的实现会根据 官方测试用例(<a href=
          "https://github.com/vuejs/core/blob/main/packages/compiler-core/__tests__/transform.spec.ts">core/transform.spec.ts
          at main · vuejs/core</a>)用到时候一个个来实现 ()。</p>
          <div class="tip" id="orgec6fbd3">
            <p>所有的 <code>transformXxxx</code>
            开头的函数目的都是通过匹配到对应类型的元素/组件，然后返回一 个加工处理该 VNode
            结构的函数，这些返回的函数会被按照一定顺序统一收集到一个数组 中，然后会在当前 AST
            树被遍历结束之后，以加入时的逆序出来顺序执行(类似栈操作，收 集时入栈，执行时按出栈顺序执行。)</p>
          </div>
        </div>
      </div>
      <div id="outline-container-orge41bf94" class="outline-3">
        <h3 id="orge41bf94"><span class=
        "section-number-3">3.2.</span>
        createTransformContext()</h3>
        <div class="outline-text-3" id="text-3-2">
          <p>transform 上下文内容有点多，后面用到时再单独说明。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="orge295ca2"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">createTransformContext</span>(
<span class="linenr">  2: </span>  <span class=
"org-variable-name">root</span>,
<span class="linenr">  3: </span>  {
<span class="linenr">  4: </span>    filename = <span class=
"org-string">''</span>,
<span class=
"linenr">  5: </span>    prefixIdentifiers = <span class=
"org-constant">false</span>,
<span class="linenr">  6: </span>    hoistStatic = <span class=
"org-constant">false</span>,
<span class="linenr">  7: </span>    cacheHandlers = <span class=
"org-constant">false</span>,
<span class="linenr">  8: </span>    nodeTransforms = [],
<span class="linenr">  9: </span>    directiveTransforms = {},
<span class="linenr"> 10: </span>    transformHoist = <span class=
"org-constant">null</span>,
<span class="linenr"> 11: </span>    isBuiltInComponent = NOOP,
<span class="linenr"> 12: </span>    isCustomElement = NOOP,
<span class="linenr"> 13: </span>    expressionPlugins = [],
<span class="linenr"> 14: </span>    scopeId = <span class=
"org-constant">null</span>,
<span class="linenr"> 15: </span>    slotted = <span class=
"org-constant">true</span>,
<span class="linenr"> 16: </span>    ssr = <span class=
"org-constant">false</span>,
<span class="linenr"> 17: </span>    inSSR = <span class=
"org-constant">false</span>,
<span class="linenr"> 18: </span>    ssrCssVars = <span class=
"org-string">``</span>,
<span class="linenr"> 19: </span>    bindingMetadata = EMPTY_OBJ,
<span class="linenr"> 20: </span>    inline = <span class=
"org-constant">false</span>,
<span class="linenr"> 21: </span>    isTS = <span class=
"org-constant">false</span>,
<span class="linenr"> 22: </span>    onError = defaultOnError,
<span class="linenr"> 23: </span>    onWarn = defaultOnWarn,
<span class="linenr"> 24: </span>    compatConfig
<span class="linenr"> 25: </span>  }
<span class="linenr"> 26: </span>) {
<span class="linenr"> 27: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nameMatch</span> = filename.replace(<span class="org-string">/\?.*$/</span>, <span class="org-string">''</span>).match(<span class="org-string">/([^/\\]+)\.\w+$/</span>)
<span class="linenr"> 28: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = {
<span class="linenr"> 29: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">options</span>
<span class=
"linenr"> 30: </span>    selfName: nameMatch &amp;& capitalize(camelize(nameMatch[<span class="org-highlight-numbers-number">1</span>])),
<span class="linenr"> 31: </span>    prefixIdentifiers,
<span class="linenr"> 32: </span>    hoistStatic,
<span class="linenr"> 33: </span>    cacheHandlers,
<span id="coderef-context-nodeTransforms" class=
"coderef-off"><span class=
"linenr"> 34: </span>    nodeTransforms,</span>
<span id="coderef-context-directiveTransforms" class=
"coderef-off"><span class=
"linenr"> 35: </span>    directiveTransforms,</span>
<span class="linenr"> 36: </span>    transformHoist,
<span class="linenr"> 37: </span>    isBuiltInComponent,
<span class="linenr"> 38: </span>    isCustomElement,
<span class="linenr"> 39: </span>    expressionPlugins,
<span class="linenr"> 40: </span>    scopeId,
<span class="linenr"> 41: </span>    slotted,
<span class="linenr"> 42: </span>    ssr,
<span class="linenr"> 43: </span>    inSSR,
<span class="linenr"> 44: </span>    ssrCssVars,
<span class="linenr"> 45: </span>    bindingMetadata,
<span class="linenr"> 46: </span>    inline,
<span class="linenr"> 47: </span>    isTS,
<span class="linenr"> 48: </span>    onError,
<span class="linenr"> 49: </span>    onWarn,
<span class="linenr"> 50: </span>    compatConfig,
<span class="linenr"> 51: </span>
<span class="linenr"> 52: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">state</span>
<span class="linenr"> 53: </span>    root,
<span class="linenr"> 54: </span>    helpers: <span class=
"org-keyword">new</span> <span class="org-type">Map</span>(),
<span class="linenr"> 55: </span>    components: <span class=
"org-keyword">new</span> <span class="org-type">Set</span>(),
<span class="linenr"> 56: </span>    directives: <span class=
"org-keyword">new</span> <span class="org-type">Set</span>(),
<span class="linenr"> 57: </span>    hoists: [],
<span class="linenr"> 58: </span>    imports: [],
<span class="linenr"> 59: </span>    constantCache: <span class=
"org-keyword">new</span> <span class="org-type">Map</span>(),
<span class="linenr"> 60: </span>    temps: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 61: </span>    cached: <span class=
"org-highlight-numbers-number">0</span>,
<span class=
"linenr"> 62: </span>    identifiers: Object.create(<span class=
"org-constant">null</span>),
<span class="linenr"> 63: </span>    scopes: { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">记录下面四个指令的嵌套层次</span>
<span class="linenr"> 64: </span>      vFor: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 65: </span>      vSlot: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 66: </span>      vPre: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 67: </span>      vOnce: <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 68: </span>    },
<span class="linenr"> 69: </span>    parent: <span class=
"org-constant">null</span>,
<span class="linenr"> 70: </span>    currentNode: root,
<span class="linenr"> 71: </span>    childIndex: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 72: </span>    inVOnce: <span class=
"org-constant">false</span>,
<span class="linenr"> 73: </span>
<span class="linenr"> 74: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">methods</span>
<span id="coderef-context-helper" class="coderef-off"><span class=
"linenr"> 75: </span>    helper(name) {</span>
<span class="linenr"> 76: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">count</span> = context.helpers.get(name) || <span class="org-highlight-numbers-number">0</span>
<span class=
"linenr"> 77: </span>      context.helpers.set(name, count + <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 78: </span>      <span class=
"org-keyword">return</span> name
<span class="linenr"> 79: </span>    },
<span id="coderef-context-removeHelper" class=
"coderef-off"><span class=
"linenr"> 80: </span>    removeHelper(name) {</span>
<span class="linenr"> 81: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">count</span> = context.helpers.get(name)
<span class="linenr"> 82: </span>      <span class=
"org-keyword">if</span> (count) {
<span class="linenr"> 83: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">currentCount</span> = count - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr"> 84: </span>        <span class=
"org-keyword">if</span> (!currentCount) {
<span class=
"linenr"> 85: </span>          context.helpers.<span class=
"org-keyword">delete</span>(name)
<span class="linenr"> 86: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 87: </span>          context.helpers.set(name, currentCount)
<span class="linenr"> 88: </span>        }
<span class="linenr"> 89: </span>      }
<span class="linenr"> 90: </span>    },
<span id="coderef-context-helperString" class=
"coderef-off"><span class=
"linenr"> 91: </span>    helperString(name) {</span>
<span class="linenr"> 92: </span>      <span class=
"org-keyword">return</span> <span class=
"org-string">`_${helperNameMap[context.helper(name)]}`</span>
<span class="linenr"> 93: </span>    },
<span id="coderef-context-replaceNode" class=
"coderef-off"><span class=
"linenr"> 94: </span>    replaceNode(node) {</span>
<span class=
"linenr"> 95: </span>      context.parent.children[context.childIndex] = context.currentNode = node
<span class="linenr"> 96: </span>    },
<span id="coderef-context-removeNode" class=
"coderef-off"><span class=
"linenr"> 97: </span>    removeNode(node) {</span>
<span class="linenr"> 98: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">list</span> = context.parent.children
<span class="linenr"> 99: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">removalIndex</span> = node
<span class="linenr">100: </span>        ? list.indexOf(node)
<span class="linenr">101: </span>        : context.currentNode
<span class="linenr">102: </span>        ? context.childIndex
<span class="linenr">103: </span>        : -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">104: </span>
<span class="linenr">105: </span>      <span class=
"org-keyword">if</span> (!node || node === context.currentNode) {
<span class="linenr">106: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">current node removed</span>
<span class=
"linenr">107: </span>        context.currentNode = <span class=
"org-constant">null</span>
<span class="linenr">108: </span>        context.onNodeRemoved()
<span class="linenr">109: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">110: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">sibling node removed</span>
<span class="linenr">111: </span>        <span class=
"org-keyword">if</span> (context.childIndex &gt; removalIndex) {
<span class="linenr">112: </span>          context.childIndex--
<span class="linenr">113: </span>          context.onNodeRemoved()
<span class="linenr">114: </span>        }
<span class="linenr">115: </span>      }
<span class=
"linenr">116: </span>      context.parent.children.splice(removalIndex, <span class="org-highlight-numbers-number">1</span>)
<span class="linenr">117: </span>    },
<span class="linenr">118: </span>    onNodeRemoved: () =&gt; {},
<span class="linenr">119: </span>    addIdentifiers(exp) {
<span class="linenr">120: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">identifier tracking only happens in non-browser builds.</span>
<span class="linenr">121: </span>      <span class=
"org-keyword">if</span> (!__BROWSER__) {
<span class="linenr">122: </span>        <span class=
"org-keyword">if</span> (isString(exp)) {
<span class="linenr">123: </span>          addId(exp)
<span class="linenr">124: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.identifiers) {
<span class=
"linenr">125: </span>          exp.identifiers.forEach(addId)
<span class="linenr">126: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">127: </span>          addId(exp.content)
<span class="linenr">128: </span>        }
<span class="linenr">129: </span>      }
<span class="linenr">130: </span>    },
<span class="linenr">131: </span>    removeIdentifiers(exp) {
<span class="linenr">132: </span>      <span class=
"org-keyword">if</span> (!__BROWSER__) {
<span class="linenr">133: </span>        <span class=
"org-keyword">if</span> (isString(exp)) {
<span class="linenr">134: </span>          removeId(exp)
<span class="linenr">135: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.identifiers) {
<span class=
"linenr">136: </span>          exp.identifiers.forEach(removeId)
<span class="linenr">137: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">138: </span>          removeId(exp.content)
<span class="linenr">139: </span>        }
<span class="linenr">140: </span>      }
<span class="linenr">141: </span>    },
<span id="coderef-context-hoist" class="coderef-off"><span class=
"linenr">142: </span>    hoist(exp) {</span>
<span class="linenr">143: </span>      <span class=
"org-keyword">if</span> (isString(exp)) exp = createSimpleExpression(exp)
<span class="linenr">144: </span>      context.hoists.push(exp)
<span class="linenr">145: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">identifier</span> = createSimpleExpression(
<span class="linenr">146: </span>        <span class=
"org-string">`_hoisted_${context.hoists.length}`</span>,
<span class="linenr">147: </span>        <span class=
"org-constant">false</span>,
<span class="linenr">148: </span>        exp.loc,
<span class="linenr">149: </span>        ConstantTypes.CAN_HOIST
<span class="linenr">150: </span>      )
<span class="linenr">151: </span>      identifier.hoisted = exp
<span class="linenr">152: </span>      <span class=
"org-keyword">return</span> identifier
<span class="linenr">153: </span>    },
<span class=
"linenr">154: </span>    cache(exp, isVNode = <span class=
"org-constant">false</span>) {
<span class="linenr">155: </span>      <span class=
"org-keyword">return</span> createCacheExpression(context.cached++, exp, isVNode)
<span class="linenr">156: </span>    }
<span class="linenr">157: </span>  }
<span class="linenr">158: </span>
<span class="linenr">159: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">addId</span>(<span class=
"org-variable-name">id</span>) {
<span class="linenr">160: </span>    <span class=
"org-keyword">const</span> { identifiers } = context
<span class="linenr">161: </span>    <span class=
"org-keyword">if</span> (identifiers[id] === <span class=
"org-constant">undefined</span>) {
<span class=
"linenr">162: </span>      identifiers[id] = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">163: </span>    }
<span class="linenr">164: </span>    identifiers[id]++
<span class="linenr">165: </span>  }
<span class="linenr">166: </span>
<span class="linenr">167: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">removeId</span>(<span class=
"org-variable-name">id</span>) {
<span class="linenr">168: </span>    context.identifiers[id]--
<span class="linenr">169: </span>  }
<span class="linenr">170: </span>
<span class="linenr">171: </span>  <span class=
"org-keyword">return</span> context
<span class="linenr">172: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org2147436" class="outline-3">
        <h3 id="org2147436"><span class=
        "section-number-3">3.3.</span> traverseNode()</h3>
        <div class="outline-text-3" id="text-3-3">
          <p>遍历 ast root 树。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="orgd4efbfe"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">traverseNode</span>(<span class=
            "org-variable-name">node</span>, <span class=
            "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">记录当前正在处理的节点</span>
<span class="linenr"> 3: </span>  context.currentNode = node
<span class="linenr"> 4: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">对节点转换时使用到的插件(外部可通过这个来修改某个指令)</span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">const</span> { nodeTransforms } = context
<span class="linenr"> 6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">递归遍历结束，回溯时调用的函数列表</span>
<span class="linenr"> 7: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">也就是这个函数最后执行的函数，当一颗树遍历完成执行的函数</span>
<span class="linenr"> 8: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">随后的 for 循环是用来收集这些函数的</span>
<span id="coderef-traverseNode-exitFns" class=
"coderef-off"><span class="linenr"> 9: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exitFns</span> = []</span>
<span class="linenr">10: </span>
<span class="linenr">11: </span>  logg(<span class=
"org-string">'traverseNode'</span>, node)
<span id="coderef-traverseNode-for-nodeTransforms" class=
"coderef-off"><span class="linenr">12: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; nodeTransforms.length; i++) {</span>
<span class="linenr">13: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = nodeTransforms[i](node, context)
<span class="linenr">14: </span>    <span class=
"org-keyword">if</span> (onExit) {
<span class="linenr">15: </span>      <span class=
"org-keyword">if</span> (isArray(onExit)) {
<span class="linenr">16: </span>        exitFns.push(...onExit)
<span class="linenr">17: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">18: </span>        exitFns.push(onExit)
<span class="linenr">19: </span>      }
<span class="linenr">20: </span>    }
<span class="linenr">21: </span>    <span class=
"org-keyword">if</span> (!context.currentNode) {
<span class="linenr">22: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node was removed</span>
<span class="linenr">23: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">24: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">25: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node may have been replaced</span>
<span class="linenr">26: </span>      node = context.currentNode
<span class="linenr">27: </span>    }
<span class="linenr">28: </span>  }
<span class="linenr">29: </span>
<span class="linenr">30: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">根据节点类型来分别处理，这里忽略注释</span>
<span class="linenr">31: </span>  <span class=
"org-keyword">switch</span> (node.type) {
<span class="linenr">32: </span>    <span class=
"org-keyword">case</span> NodeTypes.INTERPOLATION:
<span class="linenr">33: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no need to traverse, but we need to inject toString helper</span>
<span class="linenr">34: </span>      <span class=
"org-keyword">if</span> (!context.ssr) {
<span class=
"linenr">35: </span>        context.helper(TO_DISPLAY_STRING)
<span class="linenr">36: </span>      }
<span class="linenr">37: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">38: </span>
<span class="linenr">39: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for container types, further traverse downwards</span>
<span class="linenr">40: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">处理 if...else if...else 分支</span>
<span class="linenr">41: </span>    <span class=
"org-keyword">case</span> NodeTypes.IF:
<span class="linenr">42: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.branches.length; i++) {
<span class=
"linenr">43: </span>        traverseNode(node.branches[i], context)
<span class="linenr">44: </span>      }
<span class="linenr">45: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">46: </span>    <span class=
"org-keyword">case</span> NodeTypes.IF_BRANCH: <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">else..if</span>
<span class="linenr">47: </span>    <span class=
"org-keyword">case</span> NodeTypes.FOR: <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for</span>
<span class="linenr">48: </span>    <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr">49: </span>    <span class=
"org-keyword">case</span> NodeTypes.ROOT:
<span class=
"linenr">50: </span>      traverseChildren(node, context)
<span class="linenr">51: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">52: </span>  }
<span class="linenr">53: </span>
<span class="linenr">54: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">收集完成，执行这些收集到的函数，作用到当前节点上</span>
<span class="linenr">55: </span>  context.currentNode = node
<span class="linenr">56: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = exitFns.length
<span class="linenr">57: </span>  <span class=
"org-keyword">while</span> (i--) {
<span id="coderef-traverseNode-exec-exitFns" class=
"coderef-off"><span class=
"linenr">58: </span>    exitFns[i]()</span>
<span class="linenr">59: </span>  }
<span class="linenr">60: </span>}
<span class="linenr">61: </span>
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org11ca908" class="outline-3">
        <h3 id="org11ca908"><span class=
        "section-number-3">3.4.</span> traverseChildren()</h3>
        <div class="outline-text-3" id="text-3-4">
          <div class="org-src-container">
            <pre class="src src-js" id="org5c31bec"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">traverseChildren</span>(<span class=
            "org-variable-name">parent</span>, <span class=
            "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nodeRemoved</span> = () =&gt; {
<span class="linenr"> 4: </span>    i--
<span class="linenr"> 5: </span>  }
<span class="linenr"> 6: </span>  <span class=
"org-keyword">for</span> (; i &lt; parent.children.length; i++) {
<span class="linenr"> 7: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = parent.children[i]
<span class="linenr"> 8: </span>    <span class=
"org-keyword">if</span> (isString(child)) <span class=
"org-keyword">continue</span>
<span class="linenr"> 9: </span>    context.parent = parent
<span class="linenr">10: </span>    context.childIndex = i
<span class=
"linenr">11: </span>    context.onNodeRemoved = nodeRemoved
<span class="linenr">12: </span>    traverseNode(child, context)
<span class="linenr">13: </span>  }
<span class="linenr">14: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org567a84c" class="outline-3">
        <h3 id="org567a84c"><span class=
        "section-number-3">3.5.</span> hoistStatic()</h3>
        <div class="outline-text-3" id="text-3-5">
          <div class="org-src-container">
            <pre class="src src-js" id="orgf49f1b8"><span class=
            "linenr">1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">hoistStatic</span>() {}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-orgf19f686" class="outline-3">
        <h3 id="orgf19f686"><span class=
        "section-number-3">3.6.</span> createRootCodegen()</h3>
        <div class="outline-text-3" id="text-3-6">
          <div class="org-src-container">
            <pre class="src src-js" id="orgde1809c"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">createRootCodegen</span>(<span class=
            "org-variable-name">root</span>, <span class=
            "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> { helper } = context
<span class="linenr"> 3: </span>  <span class=
"org-keyword">const</span> { children } = root
<span class="linenr"> 4: </span>  logg(<span class=
"org-string">'createRootCodegen'</span>, <span class=
"org-string">`children=${children.length}, 只有一个用 block, 多个用Fragment`</span>)
<span class="linenr"> 5: </span>  <span class=
"org-keyword">if</span> (children.length === <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr"> 6: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 7: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if the single child is an element, turn it into a block.</span>
<span class="linenr"> 8: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如果只有一个根元素，如： &lt;template&gt;&lt;div&gt;...&lt;/div&gt;&lt;/template&gt;</span>
<span class="linenr"> 9: </span>    <span class=
"org-keyword">if</span> (isSingleElementRoot(root, child) &amp;& child.codegenNode) {
<span class="linenr">10: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single element root is never hoisted so codegenNode will never be</span>
<span class="linenr">11: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">SimpleExpressionNode</span>
<span class="linenr">12: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = child.codegenNode
<span class="linenr">13: </span>      <span class=
"org-keyword">if</span> (codegenNode.type === NodeTypes.VNODE_CALL) {
<span class=
"linenr">14: </span>        makeBlock(codegenNode, context)
<span class="linenr">15: </span>      }
<span class=
"linenr">16: </span>      root.codegenNode = codegenNode
<span class="linenr">17: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">18: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- single &lt;slot/&gt;, IfNode, ForNode: already blocks.</span>
<span class="linenr">19: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- single text node: always patched.</span>
<span class="linenr">20: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">root codegen falls through via genNode()</span>
<span class="linenr">21: </span>      root.codegenNode = child
<span class="linenr">22: </span>    }
<span class="linenr">23: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (children.length &gt; <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">24: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">root 下有多个节点时，使用 fragment block，3.x 特性，2.x中是不支持多个元素的</span>
<span class="linenr">25: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = PatchFlags.STABLE_FRAGMENT
<span class="linenr">26: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlagText</span> = PatchFlagNames[PatchFlags.STABLE_FRAGMENT]
<span class="linenr">27: </span>
<span class=
"linenr">28: </span>    root.codegenNode = createVNodeCall(
<span class="linenr">29: </span>      context,
<span class="linenr">30: </span>      helper(FRAGMENT),
<span class="linenr">31: </span>      <span class=
"org-constant">undefined</span>,
<span class="linenr">32: </span>      root.children,
<span class=
"linenr">33: </span>      patchFlag + (__DEV__ ? <span class=
"org-string">` /* ${patchFlagText} */`</span> : <span class=
"org-string">``</span>),
<span class="linenr">34: </span>      <span class=
"org-constant">undefined</span>,
<span class="linenr">35: </span>      <span class=
"org-constant">undefined</span>,
<span class="linenr">36: </span>      <span class=
"org-constant">true</span>,
<span class="linenr">37: </span>      <span class=
"org-constant">undefined</span>,
<span class="linenr">38: </span>      <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isComponent</span><span class=
"org-comment-delimiter"> */</span>
<span class="linenr">39: </span>    )
<span class="linenr">40: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">41: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no children = noop. codegen will return null.</span>
<span class="linenr">42: </span>  }
<span class="linenr">43: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org20b6e44" class="outline-3">
        <h3 id="org20b6e44"><span class=
        "section-number-3">3.7.</span>
        createStructuralDirectiveTransform()</h3>
        <div class="outline-text-3" id="text-3-7">
          <div class="org-src-container">
            <pre class="src src-js" id="org608e9e2"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">createStructuralDirectiveTransform</span>(<span class="org-variable-name">name</span>, <span class="org-variable-name">fn</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">正则就用 test 方法，字符串直接比较</span>
<span class="linenr"> 3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">matches</span> = isString(name)
<span class="linenr"> 4: </span>    ? (n) =&gt; n === name
<span class="linenr"> 5: </span>    : (n) =&gt; name.test(n)
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span>  logg(<span class=
"org-string">'createStructuralDirectiveTransform'</span>, <span class="org-string">`name=${name}, matches=${matches}`</span>)
<span class="linenr"> 8: </span>  <span class=
"org-keyword">return</span> (node, context) =&gt; {
<span class="linenr"> 9: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT) {
<span class="linenr">10: </span>      <span class=
"org-keyword">const</span> { props } = node
<span class="linenr">11: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-slot 指令特殊处理，代码在 vSlot.ts 中，所以这里跳过它</span>
<span class="linenr">12: </span>      <span class=
"org-keyword">if</span> (node.tagType === ElementTypes.TEMPLATE &amp;& props.some(isVSlot)) {
<span class="linenr">13: </span>        <span class=
"org-keyword">return</span>
<span class="linenr">14: </span>      }
<span class="linenr">15: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exitFns</span> = []
<span class="linenr">16: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; props.length; i++) {
<span class="linenr">17: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prop</span> = props[i]
<span class="linenr">18: </span>        <span class=
"org-keyword">if</span> (prop.type === NodeTypes.DIRECTIVE &amp;& matches(prop.name)) {
<span class="linenr">19: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">structural directives are removed to avoid infinite recursion</span>
<span class="linenr">20: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also we remove them *before* applying so that it can further</span>
<span class="linenr">21: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">traverse itself in case it moves the node around</span>
<span class=
"linenr">22: </span>          props.splice(i, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr">23: </span>          i--
<span class="linenr">24: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = fn(node, prop, context)
<span class="linenr">25: </span>          <span class=
"org-keyword">if</span> (onExit) exitFns.push(onExit)
<span class="linenr">26: </span>        }
<span class="linenr">27: </span>      }
<span class="linenr">28: </span>      <span class=
"org-keyword">return</span> exitFns
<span class="linenr">29: </span>    }
<span class="linenr">30: </span>  }
<span class="linenr">31: </span>}
<span class="linenr">32: </span>
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-transform-testing" class=
      "outline-3">
        <h3 id="transform-testing"><span class=
        "section-number-3">3.8.</span> Testing</h3>
        <div class="outline-text-3" id="text-transform-testing">
          <div class="org-src-container">
            <pre class="src src-js" id="orgf42573e"><span class=
            "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;transform&gt;&gt;
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">transformWithCodegen</span>(<span class=
"org-variable-name">template</span>) {
<span class="linenr"> 6: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(template)
<span class="linenr"> 7: </span>  transform(ast, {
<span class="linenr"> 8: </span>    nodeTransforms: [
<span class="linenr"> 9: </span>      transformIf,
<span class="linenr">10: </span>      transformElement
<span class="linenr">11: </span>    ]
<span class="linenr">12: </span>  })
<span class="linenr">13: </span>
<span class="linenr">14: </span>  <span class=
"org-keyword">return</span> ast
<span class="linenr">15: </span>}
<span class="linenr">16: </span>
<span class="linenr">17: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">parseWithIfTransform</span>(
<span class="linenr">18: </span>  <span class=
"org-variable-name">template</span>,
<span class="linenr">19: </span>  options = {},
<span class="linenr">20: </span>  returnIndex = <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">21: </span>  childrenLen = <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">22: </span>) {
<span class="linenr">23: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(template, options)
<span class="linenr">24: </span>  transform(ast, {
<span class=
"linenr">25: </span>    nodeTransforms: [transformIf, transformSlotOutlet, transformElement],
<span class="linenr">26: </span>    ...options
<span class="linenr">27: </span>  })
<span class="linenr">28: </span>  <span class=
"org-keyword">if</span> (!options.onError) {
<span class="linenr">29: </span>    logg(<span class=
"org-string">`parseWithIfTransform| ast.children.length=${childrenLen}`</span>, )
<span class="linenr">30: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; childrenLen; i++) {
<span class="linenr">31: </span>      logg(<span class=
"org-string">`parseWithIfTransform| NodeTypes.IF=${NodeTypes.IF}`</span>,
<span class="linenr">32: </span>          <span class=
"org-string">`ast.children[${i}].type=${ast.children[i].type}`</span>)
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>  }
<span class="linenr">35: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">36: </span>    root: ast,
<span class="linenr">37: </span>    node: ast.children[returnIndex]
<span class="linenr">38: </span>  }
<span class="linenr">39: </span>}
</pre>
          </div><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js" id="org264f262"><span class=
              "linenr"> 1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;div&gt;hello {{ world }}&lt;/div&gt;`</span>)
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">calls</span> = []
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">plugin</span> = (node, context) =&gt; {
<span class=
"linenr"> 6: </span>  calls.push([node, { ...context }])
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>transform(ast, {
<span class="linenr">10: </span>  nodeTransforms: [plugin]
<span class="linenr">11: </span>})
<span class="linenr">12: </span>
<span class="linenr">13: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">div</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">14: </span>log(<span class=
"org-string">`calls.length=${calls.length}`</span>)
<span class=
"linenr">15: </span>calls.forEach((call, i) =&gt; logg(<span class=
"org-string">`call - ${i}`</span>, call))
</pre>
            </div>
            <pre class="example" id="orgc731059">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 29, line: 1, offset: 28 },
    source: '&lt;div&gt;hello {{ world }}&lt;/div&gt;'
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [
    { type: 2, content: 'hello ', loc: [Object] },
    { type: 5, content: [Object], loc: [Object] }
  ],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 29, line: 1, offset: 28 },
    source: '&lt;div&gt;hello {{ world }}&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- traverseNode ---------
{
  type: 2,
  content: 'hello ',
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 12, line: 1, offset: 11 },
    source: 'hello '
  }
}
--------- traverseNode ---------
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    constType: 0,
    content: 'world',
    loc: { start: [Object], end: [Object], source: 'world' }
  },
  loc: {
    start: { column: 12, line: 1, offset: 11 },
    end: { column: 23, line: 1, offset: 22 },
    source: '{{ world }}'
  }
}
--------- createRootCodegen ---------
children=1, 只有一个用 block, 多个用Fragment
calls.length=4
--------- call - 0 ---------
[
  {
    type: 0,
    children: [ [Object] ],
    helpers: [ Symbol(toDisplayString) ],
    components: [],
    directives: [],
    hoists: [],
    imports: [],
    cached: 0,
    temps: 0,
    codegenNode: {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    },
    loc: {
      start: [Object],
      end: [Object],
      source: '&lt;div&gt;hello {{ world }}&lt;/div&gt;'
    }
  },
  {
    selfName: null,
    prefixIdentifiers: false,
    hoistStatic: false,
    cacheHandlers: false,
    nodeTransforms: [ [Function: plugin] ],
    directiveTransforms: {},
    transformHoist: null,
    isBuiltInComponent: [Function: NOOP],
    isCustomElement: [Function: NOOP],
    expressionPlugins: [],
    scopeId: null,
    slotted: true,
    ssr: false,
    inSSR: false,
    ssrCssVars: '',
    bindingMetadata: {},
    inline: false,
    isTS: false,
    onError: [Function: defaultOnError],
    onWarn: [Function: defaultOnWarn],
    compatConfig: undefined,
    root: {
      type: 0,
      children: [Array],
      helpers: [Array],
      components: [],
      directives: [],
      hoists: [],
      imports: [],
      cached: 0,
      temps: 0,
      codegenNode: [Object],
      loc: [Object]
    },
    helpers: Map(1) { Symbol(toDisplayString) =&gt; 1 },
    components: Set(0) {},
    directives: Set(0) {},
    hoists: [],
    imports: [],
    constantCache: Map(0) {},
    temps: 0,
    cached: 0,
    identifiers: [Object: null prototype] {},
    scopes: { vFor: 0, vSlot: 0, vPre: 0, vOnce: 0 },
    parent: null,
    currentNode: {
      type: 0,
      children: [Array],
      helpers: [Array],
      components: [],
      directives: [],
      hoists: [],
      imports: [],
      cached: 0,
      temps: 0,
      codegenNode: [Object],
      loc: [Object]
    },
    childIndex: 0,
    inVOnce: false,
    helper: [Function: helper],
    removeHelper: [Function: removeHelper],
    helperString: [Function: helperString],
    replaceNode: [Function: replaceNode],
    removeNode: [Function: removeNode],
    onNodeRemoved: [Function: onNodeRemoved],
    addIdentifiers: [Function: addIdentifiers],
    removeIdentifiers: [Function: removeIdentifiers],
    hoist: [Function: hoist],
    cache: [Function: cache]
  }
]
--------- call - 1 ---------
[
  {
    type: 1,
    ns: 0,
    tag: 'div',
    tagType: 0,
    props: [],
    isSelfClosing: false,
    children: [ [Object], [Object] ],
    loc: {
      start: [Object],
      end: [Object],
      source: '&lt;div&gt;hello {{ world }}&lt;/div&gt;'
    },
    codegenNode: undefined
  },
  {
    selfName: null,
    prefixIdentifiers: false,
    hoistStatic: false,
    cacheHandlers: false,
    nodeTransforms: [ [Function: plugin] ],
    directiveTransforms: {},
    transformHoist: null,
    isBuiltInComponent: [Function: NOOP],
    isCustomElement: [Function: NOOP],
    expressionPlugins: [],
    scopeId: null,
    slotted: true,
    ssr: false,
    inSSR: false,
    ssrCssVars: '',
    bindingMetadata: {},
    inline: false,
    isTS: false,
    onError: [Function: defaultOnError],
    onWarn: [Function: defaultOnWarn],
    compatConfig: undefined,
    root: {
      type: 0,
      children: [Array],
      helpers: [Array],
      components: [],
      directives: [],
      hoists: [],
      imports: [],
      cached: 0,
      temps: 0,
      codegenNode: [Object],
      loc: [Object]
    },
    helpers: Map(1) { Symbol(toDisplayString) =&gt; 1 },
    components: Set(0) {},
    directives: Set(0) {},
    hoists: [],
    imports: [],
    constantCache: Map(0) {},
    temps: 0,
    cached: 0,
    identifiers: [Object: null prototype] {},
    scopes: { vFor: 0, vSlot: 0, vPre: 0, vOnce: 0 },
    parent: {
      type: 0,
      children: [Array],
      helpers: [Array],
      components: [],
      directives: [],
      hoists: [],
      imports: [],
      cached: 0,
      temps: 0,
      codegenNode: [Object],
      loc: [Object]
    },
    currentNode: {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    },
    childIndex: 0,
    inVOnce: false,
    helper: [Function: helper],
    removeHelper: [Function: removeHelper],
    helperString: [Function: helperString],
    replaceNode: [Function: replaceNode],
    removeNode: [Function: removeNode],
    onNodeRemoved: [Function: nodeRemoved],
    addIdentifiers: [Function: addIdentifiers],
    removeIdentifiers: [Function: removeIdentifiers],
    hoist: [Function: hoist],
    cache: [Function: cache]
  }
]
--------- call - 2 ---------
[
  {
    type: 2,
    content: 'hello ',
    loc: { start: [Object], end: [Object], source: 'hello ' }
  },
  {
    selfName: null,
    prefixIdentifiers: false,
    hoistStatic: false,
    cacheHandlers: false,
    nodeTransforms: [ [Function: plugin] ],
    directiveTransforms: {},
    transformHoist: null,
    isBuiltInComponent: [Function: NOOP],
    isCustomElement: [Function: NOOP],
    expressionPlugins: [],
    scopeId: null,
    slotted: true,
    ssr: false,
    inSSR: false,
    ssrCssVars: '',
    bindingMetadata: {},
    inline: false,
    isTS: false,
    onError: [Function: defaultOnError],
    onWarn: [Function: defaultOnWarn],
    compatConfig: undefined,
    root: {
      type: 0,
      children: [Array],
      helpers: [Array],
      components: [],
      directives: [],
      hoists: [],
      imports: [],
      cached: 0,
      temps: 0,
      codegenNode: [Object],
      loc: [Object]
    },
    helpers: Map(1) { Symbol(toDisplayString) =&gt; 1 },
    components: Set(0) {},
    directives: Set(0) {},
    hoists: [],
    imports: [],
    constantCache: Map(0) {},
    temps: 0,
    cached: 0,
    identifiers: [Object: null prototype] {},
    scopes: { vFor: 0, vSlot: 0, vPre: 0, vOnce: 0 },
    parent: {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    },
    currentNode: { type: 2, content: 'hello ', loc: [Object] },
    childIndex: 0,
    inVOnce: false,
    helper: [Function: helper],
    removeHelper: [Function: removeHelper],
    helperString: [Function: helperString],
    replaceNode: [Function: replaceNode],
    removeNode: [Function: removeNode],
    onNodeRemoved: [Function: nodeRemoved],
    addIdentifiers: [Function: addIdentifiers],
    removeIdentifiers: [Function: removeIdentifiers],
    hoist: [Function: hoist],
    cache: [Function: cache]
  }
]
--------- call - 3 ---------
[
  {
    type: 5,
    content: {
      type: 4,
      isStatic: false,
      constType: 0,
      content: 'world',
      loc: [Object]
    },
    loc: { start: [Object], end: [Object], source: '{{ world }}' }
  },
  {
    selfName: null,
    prefixIdentifiers: false,
    hoistStatic: false,
    cacheHandlers: false,
    nodeTransforms: [ [Function: plugin] ],
    directiveTransforms: {},
    transformHoist: null,
    isBuiltInComponent: [Function: NOOP],
    isCustomElement: [Function: NOOP],
    expressionPlugins: [],
    scopeId: null,
    slotted: true,
    ssr: false,
    inSSR: false,
    ssrCssVars: '',
    bindingMetadata: {},
    inline: false,
    isTS: false,
    onError: [Function: defaultOnError],
    onWarn: [Function: defaultOnWarn],
    compatConfig: undefined,
    root: {
      type: 0,
      children: [Array],
      helpers: [Array],
      components: [],
      directives: [],
      hoists: [],
      imports: [],
      cached: 0,
      temps: 0,
      codegenNode: [Object],
      loc: [Object]
    },
    helpers: Map(1) { Symbol(toDisplayString) =&gt; 1 },
    components: Set(0) {},
    directives: Set(0) {},
    hoists: [],
    imports: [],
    constantCache: Map(0) {},
    temps: 0,
    cached: 0,
    identifiers: [Object: null prototype] {},
    scopes: { vFor: 0, vSlot: 0, vPre: 0, vOnce: 0 },
    parent: {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    },
    currentNode: { type: 5, content: [Object], loc: [Object] },
    childIndex: 1,
    inVOnce: false,
    helper: [Function: helper],
    removeHelper: [Function: removeHelper],
    helperString: [Function: helperString],
    replaceNode: [Function: replaceNode],
    removeNode: [Function: removeNode],
    onNodeRemoved: [Function: nodeRemoved],
    addIdentifiers: [Function: addIdentifiers],
    removeIdentifiers: [Function: removeIdentifiers],
    hoist: [Function: hoist],
    cache: [Function: cache]
  }
]
undefined
</pre>
            <p>上面是完整的结构输出，精简之后：</p>
            <p><span style="color:cyan;">calls[0]</span> -&gt;
            <code>[ ast, { parent: null, currentNode: ast }]</code>
            根节点，所以 <code>parent=null</code></p>
            <p><span style="color:cyan;">calls[1]</span> -&gt;
            <code>[ div, { parent: ast, currentNode: div }]</code>
            对应 div 节点，它的 parent 其实就是 root</p>
            <p><span style="color:cyan;">calls[2]</span> -&gt;
            <code>[ div.children[0], { parent: div, currentNode:
            div.children[0] }]</code>, div 的第一个文本子节点
            <code>hello</code></p>
            <p><span style="color:cyan;">calls[3]</span> -&gt;
            <code>[ div.children[1], { parent: div, currentNode:
            div.children[1] }]</code>, div 的第二个插值子节点 <code>{{ world
            }}</code></p>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing context.replaceNode</font></strong>
            </summary>
            <p><a href="#coderef-context-replaceNode" class=
            "coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-context-replaceNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-context-replaceNode');">
            replaceNode</a></p>
            <div class="org-src-container">
              <pre class="src src-js" id="orgf0372db"><span class=
              "linenr"> 1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;div/&gt;&lt;span/&gt;`</span>)
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">n</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">plugin</span> = (node, context) =&gt; {
<span class="linenr"> 7: </span>  logg(<span class=
"org-string">`plugin - replaceNode - ${++n}`</span>, <span class=
"org-string">`node.tag=${node.tag},node.type=${node.type}`</span>)
<span class="linenr"> 8: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT &amp;& node.tag ===  <span class="org-string">'div'</span>) {
<span class=
"linenr"> 9: </span>    context.replaceNode(Object.assign({}, node, {
<span class="linenr">10: </span>      tag: <span class=
"org-string">'p'</span>,
<span class="linenr">11: </span>      children: [{
<span class="linenr">12: </span>        type: NodeTypes.TEXT,
<span class="linenr">13: </span>        content: <span class=
"org-string">'hello'</span>,
<span class="linenr">14: </span>        isEmpty: <span class=
"org-constant">false</span>
<span class="linenr">15: </span>      }]
<span class="linenr">16: </span>    }))
<span class="linenr">17: </span>  }
<span class="linenr">18: </span>}
<span class="linenr">19: </span>
<span class="linenr">20: </span>transform(ast, {
<span class="linenr">21: </span>  nodeTransforms: [plugin]
<span class="linenr">22: </span>})
<span class="linenr">23: </span>
<span class="linenr">24: </span>logg(<span class=
"org-string">'ast.children.length'</span>, ast.children.length)
<span class="linenr">25: </span>logg(<span class=
"org-string">'new element'</span>, ast.children[<span class=
"org-highlight-numbers-number">0</span>])
<span class="linenr">26: </span>logg(<span class=
"org-string">'called times'</span>, <span class=
"org-string">`n = ${n}`</span>)
<span class="linenr">27: </span>logg(<span class=
"org-string">"children[0]"</span>, ast.children[<span class=
"org-highlight-numbers-number">0</span>])
<span class="linenr">28: </span>logg(<span class=
"org-string">"children[1]"</span>, ast.children[<span class=
"org-highlight-numbers-number">1</span>])
</pre>
            </div>
            <pre class="example" id="org85e0c86">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    },
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 14, line: 1, offset: 13 },
    source: '&lt;div/&gt;&lt;span/&gt;'
  }
}
--------- plugin - replaceNode - 1 ---------
node.tag=undefined,node.type=0
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 7, line: 1, offset: 6 },
    source: '&lt;div/&gt;'
  },
  codegenNode: undefined
}
--------- plugin - replaceNode - 2 ---------
node.tag=div,node.type=1
--------- traverseNode ---------
{ type: 2, content: 'hello', isEmpty: false }
--------- plugin - replaceNode - 3 ---------
node.tag=undefined,node.type=2
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 7, line: 1, offset: 6 },
    end: { column: 14, line: 1, offset: 13 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- plugin - replaceNode - 4 ---------
node.tag=span,node.type=1
--------- createRootCodegen ---------
children=2, 只有一个用 block, 多个用Fragment
--------- ast.children.length ---------
2
--------- new element ---------
{
  type: 1,
  ns: 0,
  tag: 'p',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [ { type: 2, content: 'hello', isEmpty: false } ],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 7, line: 1, offset: 6 },
    source: '&lt;div/&gt;'
  },
  codegenNode: undefined
}
--------- called times ---------
n = 4
--------- children[0] ---------
{
  type: 1,
  ns: 0,
  tag: 'p',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [ { type: 2, content: 'hello', isEmpty: false } ],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 7, line: 1, offset: 6 },
    source: '&lt;div/&gt;'
  },
  codegenNode: undefined
}
--------- children[1] ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 7, line: 1, offset: 6 },
    end: { column: 14, line: 1, offset: 13 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing context.removeNode</font></strong>
            </summary>
            <p><a href="#coderef-context-removeNode" class=
            "coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-context-removeNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-context-removeNode');">
            removeNode</a></p>
            <div class="org-src-container">
              <pre class="src src-js" id="org18a5104"><span class=
              "linenr"> 1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;span/&gt;&lt;div&gt;hello&lt;/div&gt;&lt;span/&gt;`</span>)
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">c1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">c2</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">c3</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">childCount</span> = ast.children.length
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>logg(<span class=
"org-string">`child count: ${childCount}`</span>)
<span class="linenr">10: </span>logg(<span class=
"org-string">'c1'</span>, c1)
<span class="linenr">11: </span>logg(<span class=
"org-string">'c2'</span>, c2)
<span class="linenr">12: </span>logg(<span class=
"org-string">'c3'</span>, c3)
<span class="linenr">13: </span>logg(<span class=
"org-string">'after'</span>)
<span class="linenr">14: </span>
<span class="linenr">15: </span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">n</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">16: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">plugin</span> = (node, context) =&gt; {
<span class="linenr">17: </span>  logg(<span class=
"org-string">`plugin - removeNode - ${++n}`</span>, <span class=
"org-string">`node.tag=${node.tag},node.type=${node.type}`</span>)
<span class="linenr">18: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT &amp;& node.tag ===  <span class="org-string">'div'</span>) {
<span class="linenr">19: </span>    context.removeNode()
<span class="linenr">20: </span>  }
<span class="linenr">21: </span>}
<span class="linenr">22: </span>
<span class="linenr">23: </span>transform(ast, {
<span class="linenr">24: </span>  nodeTransforms: [plugin]
<span class="linenr">25: </span>})
<span class="linenr">26: </span>
<span class="linenr">27: </span>logg(<span class=
"org-string">'ast.children.length'</span>, ast.children.length)
<span class="linenr">28: </span>logg(<span class=
"org-string">'called times'</span>, <span class=
"org-string">`n = ${n}`</span>)
<span class="linenr">29: </span>logg(<span class=
"org-string">`children[0] ===  c1 ? ${ast.children[0] ===  c1}`</span>)
<span class="linenr">30: </span>logg(<span class=
"org-string">`children[1] ===  c3 ? ${ast.children[1] ===  c3}`</span>)
<span class="linenr">31: </span>logg(<span class=
"org-string">"children[0]"</span>, ast.children[<span class=
"org-highlight-numbers-number">0</span>])
<span class="linenr">32: </span>logg(<span class=
"org-string">"children[1]"</span>, ast.children[<span class=
"org-highlight-numbers-number">1</span>])
<span class="linenr">33: </span>logg(<span class=
"org-string">"children[2]"</span>, ast.children[<span class=
"org-highlight-numbers-number">2</span>])
</pre>
            </div>
            <pre class="example" id="org1ee46ba">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
--------- child count: 3 ---------
--------- c1 ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- c2 ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [ { type: 2, content: 'hello', loc: [Object] } ],
  loc: {
    start: { column: 8, line: 1, offset: 7 },
    end: { column: 24, line: 1, offset: 23 },
    source: '&lt;div&gt;hello&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- c3 ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- after ---------
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    },
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    },
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;span/&gt;&lt;div&gt;hello&lt;/div&gt;&lt;span/&gt;'
  }
}
--------- plugin - removeNode - 1 ---------
node.tag=undefined,node.type=0
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- plugin - removeNode - 2 ---------
node.tag=span,node.type=1
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [ { type: 2, content: 'hello', loc: [Object] } ],
  loc: {
    start: { column: 8, line: 1, offset: 7 },
    end: { column: 24, line: 1, offset: 23 },
    source: '&lt;div&gt;hello&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- plugin - removeNode - 3 ---------
node.tag=div,node.type=1
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- plugin - removeNode - 4 ---------
node.tag=span,node.type=1
--------- createRootCodegen ---------
children=2, 只有一个用 block, 多个用Fragment
--------- ast.children.length ---------
2
--------- called times ---------
n = 4
--------- children[0] ===  c1 ? true ---------
--------- children[1] ===  c3 ? true ---------
--------- children[0] ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- children[1] ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- children[2] ---------
undefined
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing context.removeNode next
              sibling</font></strong>
            </summary>
            <p><a href="#coderef-context-removeNode" class=
            "coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-context-removeNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-context-removeNode');">
            removeNode</a></p>
            <div class="org-src-container">
              <pre class="src src-js" id="orgeec4b27"><span class=
              "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;transform&gt;&gt;
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;span/&gt;&lt;div&gt;hello&lt;/div&gt;&lt;span/&gt;`</span>)
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">c1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">c2</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">c3</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 9: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">childCount</span> = ast.children.length
<span class="linenr">10: </span>
<span class="linenr">11: </span>logg(<span class=
"org-string">`child count: ${childCount}`</span>)
<span class="linenr">12: </span>logg(<span class=
"org-string">'c1'</span>, c1)
<span class="linenr">13: </span>logg(<span class=
"org-string">'c2'</span>, c2)
<span class="linenr">14: </span>logg(<span class=
"org-string">'c3'</span>, c3)
<span class="linenr">15: </span>logg(<span class=
"org-string">'after'</span>)
<span class="linenr">16: </span>
<span class="linenr">17: </span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">n</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">18: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">plugin</span> = (node, context) =&gt; {
<span class="linenr">19: </span>  logg(<span class=
"org-string">`plugin - removeNode - ${++n}`</span>, <span class=
"org-string">`node.tag=${node.tag},node.type=${node.type}`</span>)
<span class="linenr">20: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT &amp;& node.tag ===  <span class="org-string">'div'</span>) {
<span class="linenr">21: </span>    context.removeNode()
<span class="linenr">22: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">删除相邻节点，div在删除之前是 children[1] 删除之后它相邻的</span>
<span class="linenr">23: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">span 就成了 children[1]</span>
<span class=
"linenr">24: </span>    context.removeNode(context.parent.children[<span class="org-highlight-numbers-number">1</span>])
<span class="linenr">25: </span>  }
<span class="linenr">26: </span>}
<span class="linenr">27: </span>
<span class="linenr">28: </span>transform(ast, {
<span class="linenr">29: </span>  nodeTransforms: [plugin]
<span class="linenr">30: </span>})
<span class="linenr">31: </span>
<span class="linenr">32: </span>logg(<span class=
"org-string">'ast.children.length'</span>, ast.children.length)
<span class="linenr">33: </span>logg(<span class=
"org-string">'called times'</span>, <span class=
"org-string">`n = ${n}`</span>)
<span class="linenr">34: </span>logg(<span class=
"org-string">`children[0] ===  c1 ? ${ast.children[0] ===  c1}`</span>)
<span class="linenr">35: </span>logg(<span class=
"org-string">`children[1] ===  c3 ? ${ast.children[1] ===  c3}`</span>)
<span class="linenr">36: </span>logg(<span class=
"org-string">"children[0]"</span>, ast.children[<span class=
"org-highlight-numbers-number">0</span>])
<span class="linenr">37: </span>logg(<span class=
"org-string">"children[1]"</span>, ast.children[<span class=
"org-highlight-numbers-number">1</span>])
<span class="linenr">38: </span>logg(<span class=
"org-string">"children[2]"</span>, ast.children[<span class=
"org-highlight-numbers-number">2</span>])
</pre>
            </div>
            <pre class="example" id="orgeb3ae3f">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
--------- child count: 3 ---------
--------- c1 ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- c2 ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [ { type: 2, content: 'hello', loc: [Object] } ],
  loc: {
    start: { column: 8, line: 1, offset: 7 },
    end: { column: 24, line: 1, offset: 23 },
    source: '&lt;div&gt;hello&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- c3 ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 24, line: 1, offset: 23 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- after ---------
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    },
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    },
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;span/&gt;&lt;div&gt;hello&lt;/div&gt;&lt;span/&gt;'
  }
}
--------- plugin - removeNode - 1 ---------
node.tag=undefined,node.type=0
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- plugin - removeNode - 2 ---------
node.tag=span,node.type=1
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [ { type: 2, content: 'hello', loc: [Object] } ],
  loc: {
    start: { column: 8, line: 1, offset: 7 },
    end: { column: 24, line: 1, offset: 23 },
    source: '&lt;div&gt;hello&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- plugin - removeNode - 3 ---------
node.tag=div,node.type=1
--------- createRootCodegen ---------
children=1, 只有一个用 block, 多个用Fragment
--------- ast.children.length ---------
1
--------- called times ---------
n = 3
--------- children[0] ===  c1 ? true ---------
--------- children[1] ===  c3 ? false ---------
--------- children[0] ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 8, line: 1, offset: 7 },
    source: '&lt;span/&gt;'
  },
  codegenNode: undefined
}
--------- children[1] ---------
undefined
--------- children[2] ---------
undefined
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing hoist TODO</font></strong>
            </summary>
          </details>
        </div>
      </div>
      <div id="outline-container-org1e2155b" class="outline-3">
        <h3 id="org1e2155b"><span class=
        "section-number-3">3.9.</span> transform plugins</h3>
        <div class="outline-text-3" id="text-3-9">
          <p>transform 阶段遍历过程中使用到的一些 <code>transformXxx</code>
          函数。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org2913ac4"><span class=
            "linenr"> 1: </span>&lt;&lt;makeBlock&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;trackSlotScopes&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;trackVForSlotScopes&gt;&gt;
<span class="linenr"> 4: </span>&lt;&lt;transformText&gt;&gt;
<span class="linenr"> 5: </span>&lt;&lt;transformElement&gt;&gt;
<span class="linenr"> 6: </span>&lt;&lt;transformExpression&gt;&gt;
<span class="linenr"> 7: </span>&lt;&lt;transformIf&gt;&gt;
<span class="linenr"> 8: </span>&lt;&lt;transformFor&gt;&gt;
<span class="linenr"> 9: </span>&lt;&lt;transformOnce&gt;&gt;
<span class="linenr">10: </span>&lt;&lt;transformMemo&gt;&gt;
<span class="linenr">11: </span>&lt;&lt;transformOn&gt;&gt;
<span class="linenr">12: </span>&lt;&lt;transformModel&gt;&gt;
<span class="linenr">13: </span>&lt;&lt;transformSlotOutlet&gt;&gt;
<span class="linenr">14: </span>&lt;&lt;processExpression&gt;&gt;
</pre>
          </div>
          <div class="tip" id="org22f9d2e">
            <p>下面每个章节都是按照实现顺序排列，如： transformIf -&gt;
            tranformSlotOutlet -&gt; …, 因为它们之间可能会有一定的依赖关系。</p>
          </div>
        </div>
        <div id="outline-container-org2292739" class="outline-4">
          <h4 id="org2292739"><span class=
          "section-number-4">3.9.1.</span> makeBlock()</h4>
          <div class="outline-text-4" id="text-3-9-1">
            <div class="org-src-container">
              <pre class="src src-js" id="org40af30c"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">makeBlock</span>(<span class=
              "org-variable-name">node</span>, { <span class=
              "org-variable-name">helper</span>, <span class=
              "org-variable-name">removeHelper</span>, <span class=
              "org-variable-name">inSSR</span> }) {
<span class="linenr">2: </span>  <span class=
"org-keyword">if</span> (!node.isBlock) {
<span class="linenr">3: </span>    node.isBlock = <span class=
"org-constant">true</span>
<span class=
"linenr">4: </span>    removeHelper(getVNodeHelper(inSSR, node.isComponent))
<span class="linenr">5: </span>    helper(OPEN_BLOCK)
<span class=
"linenr">6: </span>    helper(getVNodeBlockHelper(inSSR, node.isComponent))
<span class="linenr">7: </span>  }
<span class="linenr">8: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org345dea5" class="outline-4">
          <h4 id="org345dea5"><span class=
          "section-number-4">3.9.2.</span> transformIf()</h4>
          <div class="outline-text-4" id="text-3-9-2">
            <p>对于 <code>v-if|else|else-if</code> 指令在 <a href=
            "#orgfffd072">transform()</a> 阶段，转换收集
            <code>transformXxx</code> 函数过程中， 会先针对指令进行处理，比如：
            <code>v-else</code>, <code>v-else-if</code> 指令的组件会被解析到
            <code>v-if</code> 节点的 <code>node.branches[]</code>
            分支数组里面之后被删除，这些都是在收集 <code>transformXxx</code> 之前需要完成
            的。</p>
            <div class="important" id="org490d9af">
              <p>这里的处理步骤：</p>
              <ol class="org-ol">
                <li>
                  <p>先找到 <code>v-if</code> 分支，创建一个
                  <code>NodeTypes.IF</code> 类型结点，并用这个新建的去替换
                  (<a href="#coderef-context-replaceNode" class=
                  "coderef" onmouseover=
                  "CodeHighlightOn(this, 'coderef-context-replaceNode');"
                  onmouseout=
                  "CodeHighlightOff(this, 'coderef-context-replaceNode');">replaceNode()</a>)掉
                  <code>v-if</code> 这个结点</p>
                  <div class="org-src-container">
                    <pre class="src src-typescript">    <span class=
                    "org-keyword">const</span> <span class=
                    "org-variable-name">ifNode</span>: <span class=
                    "org-type">IfNode</span> = <span class=
                    "org-rainbow-delimiters-depth-1">{</span>
      <span class="org-keyword">type</span>: <span class=
"org-type">NodeTypes.IF</span>,
      loc: node.loc,
      branches: <span class=
"org-rainbow-delimiters-depth-2">[</span>branch<span class=
"org-rainbow-delimiters-depth-2">]</span>
    <span class="org-rainbow-delimiters-depth-1">}</span>
</pre>
                  </div>
                </li>
                <li>
                  <p>如果是 <code>v-else-*</code> 分支，则需要先找到 <b>1</b>
                  步中的 <code>v-if</code> 分支，也就是它的依赖分支。然
                  后直接将当前分支从主树中删除，放到 <code>ifNode.branches</code>
                  中，然后手动执行一次 <a href=
                  "#orgd4efbfe">traverseNode()</a> 再直接执行
                  <code>onExit=prcessCodegen(sibling, branch,
                  false)</code> 返回的 <a href=
                  "#coderef-processIf-onExit" class="coderef"
                  onmouseover=
                  "CodeHighlightOn(this, 'coderef-processIf-onExit');"
                  onmouseout=
                  "CodeHighlightOff(this, 'coderef-processIf-onExit');">
                  onExit</a> 函数，去解析出该分支的 <code>codegenNode</code>
                  ，这个 onExit 函数其实就是 中这部分代码 <a href=
                  "#coderef-transformIf-exitFn-start" class=
                  "coderef" onmouseover=
                  "CodeHighlightOn(this, 'coderef-transformIf-exitFn-start');"
                  onmouseout=
                  "CodeHighlightOff(this, 'coderef-transformIf-exitFn-start');">
                  25</a>到<a href="#coderef-transformIf-exitFn-end"
                  class="coderef" onmouseover=
                  "CodeHighlightOn(this, 'coderef-transformIf-exitFn-end');"
                  onmouseout=
                  "CodeHighlightOff(this, 'coderef-transformIf-exitFn-end');">40</a>
                  。</p>
                  <p>注意看下面代码(<a href=
                  "#org228b440">processIf()</a>:<a href=
                  "#coderef-processIf-IF-start" class="coderef"
                  onmouseover=
                  "CodeHighlightOn(this, 'coderef-processIf-IF-start');"
                  onmouseout=
                  "CodeHighlightOff(this, 'coderef-processIf-IF-start');">47</a>~<a href="#coderef-processIf-IF-end"
                  class="coderef" onmouseover=
                  "CodeHighlightOn(this, 'coderef-processIf-IF-end');"
                  onmouseout=
                  "CodeHighlightOff(this, 'coderef-processIf-IF-end');">61</a>):</p>
                  <div class="org-src-container">
                    <pre class="src src-js">    <span class=
                    "org-keyword">if</span> (sibling &amp;& sibling.type === NodeTypes.IF) {
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">这里会将原本的结点删除，而是用新组装的 if 结构(包含else-if, else 分支的结构，node.branches[...])</span>
        context.removeNode()
        <span class="org-keyword">const</span> <span class=
"org-variable-name">branch</span> = createIfBranch(node, dir)
        sibling.branches.push(branch)

        <span class="org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = processCodegen &amp;& processCodegen(sibling, branch, <span class="org-constant">false</span>)
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">这里需要手动触发一次遍历，因为上面将原本的分支节点从原来的节点树中删除了</span>
        traverseNode(branch, context)
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">回溯结束后执行收集到的 transformXxx 函数</span>
        <span class="org-keyword">if</span> (onExit) onExit()
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">make sure to reset currentNode after traversal to indicate this</span>
        <span class="org-comment-delimiter">// </span><span class=
"org-comment">node has been removed.</span>
        context.currentNode = <span class=
"org-constant">null</span>
      }
      <span class="org-keyword">break</span>
    }
</pre>
                  </div>
                </li>
                <li>最后记得 <code>context.currentNode = null</code> 标记
                <code>v-else-*</code> 分支已经被删除了。</li>
              </ol>
            </div>
            <p>包括 <a href="#org6b61c41">v-for</a> 指令都需要经过 <a href=
            "#org608e9e2">createStructuralDirectiveTransform()</a>
            函数封装一层 之后， 返回对应的 <code>transformXxx</code> 函数。</p>
            <div class="org-src-container">
              <pre class="src src-js" id="orge073826"><span class=
              "linenr"> 1: </span>&lt;&lt;processIf&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;createIfBranch&gt;&gt;
<span class=
"linenr"> 3: </span>&lt;&lt;createCodegenNodeForBranch&gt;&gt;
<span class=
"linenr"> 4: </span>&lt;&lt;createChildrenCodegenNode&gt;&gt;
<span class="linenr"> 5: </span>&lt;&lt;isSameKey&gt;&gt;
<span class="linenr"> 6: </span>&lt;&lt;getParentCondition&gt;&gt;
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformIf</span> = createStructuralDirectiveTransform(
<span class="linenr"> 9: </span>  <span class=
"org-string">/^(if|else|else-if)$/</span>,
<span class="linenr">10: </span>  (node, dir, context) =&gt; {
<span class="linenr">11: </span>    <span class=
"org-keyword">return</span> processIf(node, dir, context, (ifNode, branch, isRoot) =&gt; {
<span class="linenr">12: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">siblings</span> = context.parent.children
<span class="linenr">13: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if...else if...else 都处于同级渲染</span>
<span class="linenr">14: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = siblings.indexOf(ifNode)
<span class="linenr">15: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">key</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">16: </span>      <span class=
"org-keyword">while</span> (i-- &gt;= <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">17: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">sibling</span> = siblings[i]
<span class="linenr">18: </span>        <span class=
"org-keyword">if</span> (sibling &amp;& sibling.type === NodeTypes.IF) {
<span class=
"linenr">19: </span>          key += sibling.branches.length
<span class="linenr">20: </span>        }
<span class="linenr">21: </span>      }
<span class="linenr">22: </span>
<span class="linenr">23: </span>      logg(<span class=
"org-string">'transformIf'</span>, ifNode, { isRoot, branch })
<span class="linenr">24: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">退出时的回调，当所有 children 被遍历转换完成时被调用生成 codegenNode</span>
<span id="coderef-transformIf-exitFn-start" class=
"coderef-off"><span class="linenr">25: </span>      <span class=
"org-keyword">return</span> () =&gt; {</span>
<span class="linenr">26: </span>        <span class=
"org-keyword">if</span> (isRoot) { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-if</span>
<span class=
"linenr">27: </span>          ifNode.codegenNode = createCodegenNodeForBranch(
<span class="linenr">28: </span>            branch, key, context
<span class="linenr">29: </span>          )
<span class="linenr">30: </span>          logg(<span class=
"org-string">'transformIf - isRoot - v-if'</span>, ifNode)
<span class="linenr">31: </span>        } <span class=
"org-keyword">else</span> { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-else, v-else-if</span>
<span class="linenr">32: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将 v-else-* 分枝挂到 v-if 节点下面</span>
<span class="linenr">33: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parentCondition</span> = getParentCondition(ifNode.codegenNode)
<span class=
"linenr">34: </span>          parentCondition.alternate = createCodegenNodeForBranch(
<span class=
"linenr">35: </span>            branch, key + ifNode.branches.length - <span class="org-highlight-numbers-number">1</span>,
<span class="linenr">36: </span>            context
<span class="linenr">37: </span>          )
<span class="linenr">38: </span>          logg(<span class=
"org-string">'transformIf - v-else-*'</span>, ifNode)
<span class="linenr">39: </span>        }
<span id="coderef-transformIf-exitFn-end" class=
"coderef-off"><span class="linenr">40: </span>      }</span>
<span class="linenr">41: </span>
<span class="linenr">42: </span>    })
<span class="linenr">43: </span>  }
<span class="linenr">44: </span>)
</pre>
            </div>
            <p>流程图：</p><a href=
            "../assets/img/vue3plus/d/transform-v-if.svg"
            data-fancybox="gallery" data-caption=
            "Preview"><img src="../assets/img/vue3plus/d/transform-v-if.svg"></a>
            <p>文字描述：</p>
            <p><code>&lt;div v-if="foo" /&gt;&lt;p v-else-if="bar"
            /&gt;&lt;span v-else /&gt;</code></p>
            <p>代码过程(省略部分解析流程，主要突出 <code>v-if,v-else-*</code>
            指令解析)：</p>
            <p><a href="#orgfffd072">transform()</a> -&gt; <a href=
            "#orgd4efbfe">traverseNode()</a> -&gt; <a href=
            "#orge073826">transformIf()</a> -&gt; <a href=
            "#coderef-traverseNode-exitFns" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-traverseNode-exitFns');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-traverseNode-exitFns');">
            exitFns[&lt;transformIf&gt;]​</a> -&gt; …</p>
            <p><a href="#orge073826">transformIf()</a> -&gt;
            <a href="#org228b440">processIf()</a> -&gt; 新建 <a href=
            "#coderef-processIf-ifNode" class="coderef"
            onmouseover="CodeHighlightOn(this, 'coderef-processIf-ifNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-ifNode');">NodeTypes.IF#ifNode</a>
            -&gt; 替换 <a href="#coderef-processIf-replaceNode"
            class="coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-processIf-replaceNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-replaceNode');">
            div#v-if</a> -&gt; push
            <code>ifNode.branches[&lt;div#v-if&gt;]</code></p>
            <p><code>p#v-else-if</code> -&gt; 从 <a href=
            "#coderef-processIf-removeNode" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-processIf-removeNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-removeNode');">
            root ast</a> 中删除 -&gt; push <a href=
            "#coderef-processIf-push-branch" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-processIf-push-branch');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-push-branch');">
            ifNode.branches[&lt;div#v-if&gt;,
            &lt;p#v-else-if&gt;</a>] -&gt; 重新 <a href=
            "#orgd4efbfe">traverseNode(&lt;p#v-else-if&gt;)</a>
            -&gt; 生成 <a href="#coderef-processIf-onExit" class=
            "coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-processIf-onExit');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-onExit');">codegeNode</a></p>
            <p><code>span#v-else</code> -&gt; 从 <a href=
            "#coderef-processIf-removeNode" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-processIf-removeNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-removeNode');">
            root ast</a> 中删除 -&gt; push <a href=
            "#coderef-processIf-push-branch" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-processIf-push-branch');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-push-branch');">
            ifNode.branches[&lt;div#v-if&gt;, &lt;p#v-else-if&gt;,
            &lt;span#v-else&gt;]​</a> -&gt; 重新 <a href=
            "#orgd4efbfe">traverseNode(&lt;span#v-else&gt;)</a>
            -&gt; 生成 <a href="#coderef-processIf-onExit" class=
            "coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-processIf-onExit');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-processIf-onExit');">codegeNode</a></p>
            <p>最后退出收集过程，退出 <a href=
            "#coderef-traverseNode-for-nodeTransforms" class=
            "coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-traverseNode-for-nodeTransforms');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-traverseNode-for-nodeTransforms');">
            for#exitFns</a> 循环执行收集到的 <a href=
            "#coderef-traverseNode-exec-exitFns" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-traverseNode-exec-exitFns');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-traverseNode-exec-exitFns');">
            exitFns&lt;fn for ifNode&gt;</a>, <a href=
            "#orge073826">tranformIf:processCodegen</a>:<a href=
            "#coderef-transformIf-exitFn-start" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-transformIf-exitFn-start');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-transformIf-exitFn-start');">25</a>~<a href="#coderef-transformIf-exitFn-end"
            class="coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-transformIf-exitFn-end');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-transformIf-exitFn-end');">40</a></p>
            <p><span style="color:red;">Testing</span></p><br>
            <details class="code-details" style=
            "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
              <summary>
                <strong><font face="Courier" size="3" color=
                "red">Testing v-if</font></strong>
              </summary>
              <div style=
              "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
                <h3></h3>
                <p><span style="color:red;">BUG1</span>:</p>
                <p>TypeError: Cannot read properties of undefined
                (reading ’type’)</p>
                <p>at getMemoedVNodeCall
                (/Users/gcl/tmp/test/transform.js:468:12)</p>
                <p>at createChildrenCodegenNode
                (/Users/gcl/tmp/test/transform.js:2532:23)</p>
                <ol class="org-ol">
                  <li>是因为没有实现 <a href=
                  "#org389b397">transformElement()</a> 导致
                  <code>div.codegenNode</code> 是
                  <code>undefined</code>
                  </li>
                </ol>
              </div>
              <div class="org-src-container">
                <pre class="src src-js" id="orgd57c9ec"><span class=
                "linenr">1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = transformWithCodegen(<span class=
"org-string">"&lt;div v-if='ok' /&gt;"</span>)
<span class="linenr">4: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">5: </span>logg(<span class=
"org-string">'root.codgenNode'</span>, ast.codegenNode)
<span class="linenr">6: </span>logg(<span class=
"org-string">'div.codgenNode'</span>, ast.children[<span class=
"org-highlight-numbers-number">0</span>].codegenNode)
</pre>
              </div>
              <pre class="example" id="orgea372ad">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 15, line: 1, offset: 14 },
    source: "v-if='ok'"
  }
}
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [Array],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  },
  codegenNode: undefined
}
--------- processIf - node - dir ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  },
  codegenNode: undefined
}
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 15, line: 1, offset: 14 },
    source: "v-if='ok'"
  }
}
--------- transformIf ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ]
}
{
  isRoot: true,
  branch: {
    type: 10,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='ok' /&gt;" },
    condition: {
      type: 4,
      content: 'ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    children: [ [Object] ],
    userKey: undefined
  }
}
--------- traverseNode ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  },
  condition: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  userKey: undefined
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  },
  codegenNode: undefined
}
--------- transformIf - isRoot - v-if ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- createRootCodegen ---------
children=1, 只有一个用 block, 多个用Fragment
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 9,
      loc: [Object],
      branches: [Array],
      codegenNode: [Object]
    }
  ],
  helpers: [
    Symbol(openBlock),
    Symbol(createElementBlock),
    Symbol(createCommentVNode)
  ],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 9,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='ok' /&gt;" },
    branches: [ [Object] ],
    codegenNode: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  }
}
--------- root.codgenNode ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 18, line: 1, offset: 17 },
    source: "&lt;div v-if='ok' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- div.codgenNode ---------
{
  type: 19,
  test: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  consequent: {
    type: 13,
    tag: '"div"',
    props: { type: 15, loc: [Object], properties: [Array] },
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    isComponent: false,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='ok' /&gt;" }
  },
  alternate: {
    type: 14,
    loc: { source: '', start: [Object], end: [Object] },
    callee: Symbol(createCommentVNode),
    arguments: [ '"v-if"', 'true' ]
  },
  newline: true,
  loc: {
    source: '',
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  }
}
undefined
</pre>
              <p>对于 v-if 节点会生成如下 codegenNode:</p>
              <div class="org-src-container">
                <pre class="src src-js"> codegenNode: {
    type: <span class="org-highlight-numbers-number">19</span>,
    test: {
      type: <span class="org-highlight-numbers-number">4</span>,
      content: <span class="org-string">'ok'</span>,
      isStatic: <span class="org-constant">false</span>,
      constType: <span class=
"org-highlight-numbers-number">0</span>,
      loc: [Object]
    },
    consequent: {
      type: <span class="org-highlight-numbers-number">13</span>,
      tag: <span class="org-string">'"div"'</span>,
      props: [Object],
      children: <span class="org-constant">undefined</span>,
      patchFlag: <span class="org-constant">undefined</span>,
      dynamicProps: <span class="org-constant">undefined</span>,
      directives: <span class="org-constant">undefined</span>,
      isBlock: <span class="org-constant">true</span>,
      disableTracking: <span class="org-constant">false</span>,
      isComponent: <span class="org-constant">false</span>,
      loc: [Object]
    },
    alternate: {
      type: <span class="org-highlight-numbers-number">14</span>,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      <span class="org-constant">arguments</span>: [Array]
    },
    newline: <span class="org-constant">true</span>,
    loc: { source: <span class=
"org-string">''</span>, start: [Object], end: [Object] }
  }
</pre>
              </div>
              <p><span style="color:pink;">test</span> 是
              <code>v-if="ok"</code> 的值解析出来的结构</p>
              <p><span style="color:pink;">consequent</span> 是
              <code>ok</code> 值为真值时渲染的主分支节点(即 <code>div</code>)</p>
              <p><span style="color:pink;">alternate</span> 是
              <code>v-else-if, v-else</code> 分支，这里因为只有
              <code>v-if</code> 所以是一个默认的注释 节点(如果有
              <code>v-else-if</code> 分支它的结构会是 <code>alternate: {
              ..., alternate: {...} }</code> 嵌套 模式，如后面多分支的
              <code>v-if</code> <a href=
              "#org8df2527">测试用例</a>)。</p>
            </details><br>
            <details class="code-details" style=
            "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
              <summary>
                <strong><font face="Courier" size="3" color=
                "red">Testing v-ifs</font></strong>
              </summary>
              <div class="org-src-container">
                <pre class="src src-js" id="org8df2527"><span class=
                "linenr"> 1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = transformWithCodegen(<span class=
"org-string">"&lt;div v-if='foo' /&gt;&lt;span v-else-if='bar' /&gt;&lt;p v-else /&gt;"</span>)
<span class="linenr"> 4: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr"> 5: </span>logg(<span class=
"org-string">'root.codgenNode'</span>, ast.codegenNode)
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">div</span> = ast.codegenNode.codegenNode
<span class="linenr"> 7: </span>logg(<span class=
"org-string">'div.codegenNode - div#v-if'</span>, div)
<span class="linenr"> 8: </span>logg(<span class=
"org-string">'div.codegenNode.test - div#foo'</span>, div.test)
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'div.codegenNode.consequent - div#v-if'</span>, div.consequent)
<span class="linenr">10: </span>logg(<span class=
"org-string">'div.codegenNode.alternate - span'</span>, div.alternate)
<span class="linenr">11: </span>logg(<span class=
"org-string">'div.codegenNode.alternate.test - span#bar'</span>, div.alternate.test)
<span class="linenr">12: </span>logg(<span class=
"org-string">'div.codegenNode.alternate.consequent - span#v-else-if'</span>, div.alternate.consequent)
<span class="linenr">13: </span>logg(<span class=
"org-string">'div.codegenNode.alternate.alternate - p#v-else'</span>, div.alternate.alternate)
</pre>
              </div>
              <pre class="example" id="org2407563">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'foo',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'foo' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 16, line: 1, offset: 15 },
    source: "v-if='foo'"
  }
}
parseAttribute| match=v-else-if,else-if,,
--------- ATTR ---------
{
  type: 7,
  name: 'else-if',
  exp: {
    type: 4,
    content: 'bar',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'bar' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 25, line: 1, offset: 24 },
    end: { column: 40, line: 1, offset: 39 },
    source: "v-else-if='bar'"
  }
}
parseAttribute| match=v-else,else,,
--------- ATTR ---------
{
  type: 7,
  name: 'else',
  exp: undefined,
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 46, line: 1, offset: 45 },
    end: { column: 52, line: 1, offset: 51 },
    source: 'v-else'
  }
}
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [Array],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    },
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [Array],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    },
    {
      type: 1,
      ns: 0,
      tag: 'p',
      tagType: 0,
      props: [Array],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 55, line: 1, offset: 54 },
    source: "&lt;div v-if='foo' /&gt;&lt;span v-else-if='bar' /&gt;&lt;p v-else /&gt;"
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  codegenNode: undefined
}
--------- processIf - node - dir ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  codegenNode: undefined
}
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'foo',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'foo' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 16, line: 1, offset: 15 },
    source: "v-if='foo'"
  }
}
--------- transformIf ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ]
}
{
  isRoot: true,
  branch: {
    type: 10,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='foo' /&gt;" },
    condition: {
      type: 4,
      content: 'foo',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    children: [ [Object] ],
    userKey: undefined
  }
}
--------- traverseNode ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  condition: {
    type: 4,
    content: 'foo',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'foo' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  userKey: undefined
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  codegenNode: undefined
}
--------- transformIf - isRoot - v-if ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'foo',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'else-if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 19, line: 1, offset: 18 },
    end: { column: 43, line: 1, offset: 42 },
    source: "&lt;span v-else-if='bar' /&gt;"
  },
  codegenNode: undefined
}
--------- processIf - node - dir ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 19, line: 1, offset: 18 },
    end: { column: 43, line: 1, offset: 42 },
    source: "&lt;span v-else-if='bar' /&gt;"
  },
  codegenNode: undefined
}
{
  type: 7,
  name: 'else-if',
  exp: {
    type: 4,
    content: 'bar',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'bar' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 25, line: 1, offset: 24 },
    end: { column: 40, line: 1, offset: 39 },
    source: "v-else-if='bar'"
  }
}
--------- transformIf ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'foo',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
{
  isRoot: false,
  branch: {
    type: 10,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;span v-else-if='bar' /&gt;"
    },
    condition: {
      type: 4,
      content: 'bar',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    children: [ [Object] ],
    userKey: undefined
  }
}
--------- traverseNode ---------
{
  type: 10,
  loc: {
    start: { column: 19, line: 1, offset: 18 },
    end: { column: 43, line: 1, offset: 42 },
    source: "&lt;span v-else-if='bar' /&gt;"
  },
  condition: {
    type: 4,
    content: 'bar',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'bar' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  userKey: undefined
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 19, line: 1, offset: 18 },
    end: { column: 43, line: 1, offset: 42 },
    source: "&lt;span v-else-if='bar' /&gt;"
  },
  codegenNode: undefined
}
--------- transformIf - v-else-* ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'foo',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'p',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'else',
      exp: undefined,
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 43, line: 1, offset: 42 },
    end: { column: 55, line: 1, offset: 54 },
    source: '&lt;p v-else /&gt;'
  },
  codegenNode: undefined
}
--------- processIf - node - dir ---------
{
  type: 1,
  ns: 0,
  tag: 'p',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 43, line: 1, offset: 42 },
    end: { column: 55, line: 1, offset: 54 },
    source: '&lt;p v-else /&gt;'
  },
  codegenNode: undefined
}
{
  type: 7,
  name: 'else',
  exp: undefined,
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 46, line: 1, offset: 45 },
    end: { column: 52, line: 1, offset: 51 },
    source: 'v-else'
  }
}
--------- transformIf ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: undefined,
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'foo',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
{
  isRoot: false,
  branch: {
    type: 10,
    loc: { start: [Object], end: [Object], source: '&lt;p v-else /&gt;' },
    condition: undefined,
    children: [ [Object] ],
    userKey: undefined
  }
}
--------- traverseNode ---------
{
  type: 10,
  loc: {
    start: { column: 43, line: 1, offset: 42 },
    end: { column: 55, line: 1, offset: 54 },
    source: '&lt;p v-else /&gt;'
  },
  condition: undefined,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'p',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  userKey: undefined
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'p',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 43, line: 1, offset: 42 },
    end: { column: 55, line: 1, offset: 54 },
    source: '&lt;p v-else /&gt;'
  },
  codegenNode: undefined
}
--------- transformIf - v-else-* ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: undefined,
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'foo',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- createRootCodegen ---------
children=1, 只有一个用 block, 多个用Fragment
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 9,
      loc: [Object],
      branches: [Array],
      codegenNode: [Object]
    }
  ],
  helpers: [
    Symbol(openBlock),
    Symbol(createElementBlock),
    Symbol(createCommentVNode)
  ],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 9,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='foo' /&gt;" },
    branches: [ [Object], [Object], [Object] ],
    codegenNode: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 55, line: 1, offset: 54 },
    source: "&lt;div v-if='foo' /&gt;&lt;span v-else-if='bar' /&gt;&lt;p v-else /&gt;"
  }
}
--------- root.codgenNode ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    },
    {
      type: 10,
      loc: [Object],
      condition: undefined,
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'foo',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- div.codegenNode - div#v-if ---------
{
  type: 19,
  test: {
    type: 4,
    content: 'foo',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'foo' }
  },
  consequent: {
    type: 13,
    tag: '"div"',
    props: { type: 15, loc: [Object], properties: [Array] },
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    isComponent: false,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='foo' /&gt;" }
  },
  alternate: {
    type: 19,
    test: {
      type: 4,
      content: 'bar',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"span"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 13,
      tag: '"p"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  },
  newline: true,
  loc: {
    source: '',
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  }
}
--------- div.codegenNode.test - div#foo ---------
{
  type: 4,
  content: 'foo',
  isStatic: false,
  constType: 0,
  loc: {
    start: { column: 12, line: 1, offset: 11 },
    end: { column: 15, line: 1, offset: 14 },
    source: 'foo'
  }
}
--------- div.codegenNode.consequent - div#v-if ---------
{
  type: 13,
  tag: '"div"',
  props: {
    type: 15,
    loc: { source: '', start: [Object], end: [Object] },
    properties: [ [Object] ]
  },
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  isComponent: false,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: "&lt;div v-if='foo' /&gt;"
  }
}
--------- div.codegenNode.alternate - span ---------
{
  type: 19,
  test: {
    type: 4,
    content: 'bar',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'bar' }
  },
  consequent: {
    type: 13,
    tag: '"span"',
    props: { type: 15, loc: [Object], properties: [Array] },
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    isComponent: false,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;span v-else-if='bar' /&gt;"
    }
  },
  alternate: {
    type: 13,
    tag: '"p"',
    props: { type: 15, loc: [Object], properties: [Array] },
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    isComponent: false,
    loc: { start: [Object], end: [Object], source: '&lt;p v-else /&gt;' }
  },
  newline: true,
  loc: {
    source: '',
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  }
}
--------- div.codegenNode.alternate.test - span#bar ---------
{
  type: 4,
  content: 'bar',
  isStatic: false,
  constType: 0,
  loc: {
    start: { column: 36, line: 1, offset: 35 },
    end: { column: 39, line: 1, offset: 38 },
    source: 'bar'
  }
}
--------- div.codegenNode.alternate.consequent - span#v-else-if ---------
{
  type: 13,
  tag: '"span"',
  props: {
    type: 15,
    loc: { source: '', start: [Object], end: [Object] },
    properties: [ [Object] ]
  },
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  isComponent: false,
  loc: {
    start: { column: 19, line: 1, offset: 18 },
    end: { column: 43, line: 1, offset: 42 },
    source: "&lt;span v-else-if='bar' /&gt;"
  }
}
--------- div.codegenNode.alternate.alternate - p#v-else ---------
{
  type: 13,
  tag: '"p"',
  props: {
    type: 15,
    loc: { source: '', start: [Object], end: [Object] },
    properties: [ [Object] ]
  },
  children: undefined,
  patchFlag: undefined,
  dynamicProps: undefined,
  directives: undefined,
  isBlock: true,
  disableTracking: false,
  isComponent: false,
  loc: {
    start: { column: 43, line: 1, offset: 42 },
    end: { column: 55, line: 1, offset: 54 },
    source: '&lt;p v-else /&gt;'
  }
}
undefined
</pre>
            </details><br>
            <details class="code-details" style=
            "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
              <summary>
                <strong><font face="Courier" size="3" color=
                "red">Testing v-if with template</font></strong>
              </summary>
              <div class="org-src-container">
                <pre class="src src-js" id="org4b1e0bf"><span class=
                "linenr"> 1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span>logOff()
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> { node, root } = parseWithIfTransform(<span class="org-string">"&lt;template v-if='ok'&gt;&lt;div/&gt;hello&lt;p/&gt;&lt;/template&gt;"</span>)
<span class="linenr"> 5: </span>logOn()
<span class="linenr"> 6: </span>logg(<span class=
"org-string">'root ast'</span>, root)
<span class="linenr"> 7: </span>logg(<span class=
"org-string">`node.type=${node.type}, NodeTypes.IF=${NodeTypes.IF}`</span>)
<span class="linenr"> 8: </span>logg(<span class=
"org-string">`node.branches.length=${node.branches.length}`</span>)
<span class="linenr"> 9: </span>logg(<span class=
"org-string">`node.branches[0]`</span>, node.branches[<span class=
"org-highlight-numbers-number">0</span>])
<span class="linenr">10: </span>logg(<span class=
"org-string">`node.branches[0].children.length=${node.branches[0].children.length}`</span>)
<span class="linenr">11: </span>node.branches[<span class=
"org-highlight-numbers-number">0</span>].children.forEach(( child, i ) =&gt; {
<span class="linenr">12: </span>  logg(<span class=
"org-string">`node.branches[0].children[${i}]`</span>, child)
<span class="linenr">13: </span>})
<span class="linenr">14: </span>
</pre>
              </div>
              <pre class="example" id="org70a2df0">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
--------- root ast ---------
{
  type: 0,
  children: [
    {
      type: 9,
      loc: [Object],
      branches: [Array],
      codegenNode: [Object]
    }
  ],
  helpers: [
    Symbol(createElementVNode),
    Symbol(Fragment),
    Symbol(openBlock),
    Symbol(createElementBlock),
    Symbol(createCommentVNode)
  ],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 9,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;template v-if='ok'&gt;&lt;div/&gt;hello&lt;p/&gt;&lt;/template&gt;"
    },
    branches: [ [Object] ],
    codegenNode: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 47, line: 1, offset: 46 },
    source: "&lt;template v-if='ok'&gt;&lt;div/&gt;hello&lt;p/&gt;&lt;/template&gt;"
  }
}
--------- node.type=9, NodeTypes.IF=9 ---------
--------- node.branches.length=1 ---------
--------- node.branches[0] ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 47, line: 1, offset: 46 },
    source: "&lt;template v-if='ok'&gt;&lt;div/&gt;hello&lt;p/&gt;&lt;/template&gt;"
  },
  condition: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: [Object]
    },
    { type: 2, content: 'hello', loc: [Object] },
    {
      type: 1,
      ns: 0,
      tag: 'p',
      tagType: 0,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: [Object]
    }
  ],
  userKey: undefined
}
--------- node.branches[0].children.length=3 ---------
--------- node.branches[0].children[0] ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 21, line: 1, offset: 20 },
    end: { column: 27, line: 1, offset: 26 },
    source: '&lt;div/&gt;'
  },
  codegenNode: {
    type: 13,
    tag: '"div"',
    props: undefined,
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: false,
    disableTracking: false,
    isComponent: false,
    loc: { start: [Object], end: [Object], source: '&lt;div/&gt;' }
  }
}
--------- node.branches[0].children[1] ---------
{
  type: 2,
  content: 'hello',
  loc: {
    start: { column: 27, line: 1, offset: 26 },
    end: { column: 32, line: 1, offset: 31 },
    source: 'hello'
  }
}
--------- node.branches[0].children[2] ---------
{
  type: 1,
  ns: 0,
  tag: 'p',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 32, line: 1, offset: 31 },
    end: { column: 36, line: 1, offset: 35 },
    source: '&lt;p/&gt;'
  },
  codegenNode: {
    type: 13,
    tag: '"p"',
    props: undefined,
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: false,
    disableTracking: false,
    isComponent: false,
    loc: { start: [Object], end: [Object], source: '&lt;p/&gt;' }
  }
}
undefined
</pre>
            </details><br>
            <details class="code-details" style=
            "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
              <summary>
                <strong><font face="Courier" size="3" color=
                "red">Testing v-if with component</font></strong>
              </summary>
              <div class="org-src-container">
                <pre class="src src-js" id="org93ac9b7"><span class=
                "linenr"> 1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> { node, root } = parseWithIfTransform(<span class="org-string">"&lt;Component v-if='ok'&gt;&lt;/Component&gt;"</span>)
<span class="linenr"> 4: </span>logg(<span class=
"org-string">'root ast'</span>, root)
<span class="linenr"> 5: </span>logg(<span class=
"org-string">`node.type=${node.type}, NodeTypes.IF=${NodeTypes.IF}`</span>)
<span class="linenr"> 6: </span>logg(<span class=
"org-string">`node.branches.length=${node.branches.length}`</span>)
<span class="linenr"> 7: </span>logg(<span class=
"org-string">`node.branches[0]`</span>, node.branches[<span class=
"org-highlight-numbers-number">0</span>])
<span class="linenr"> 8: </span>logg(<span class=
"org-string">`node.branches[0].children.length=${node.branches[0].children.length}`</span>)
<span class="linenr"> 9: </span>node.branches[<span class=
"org-highlight-numbers-number">0</span>].children.forEach(( child, i ) =&gt; {
<span class="linenr">10: </span>  logg(<span class=
"org-string">`node.branches[0].children[${i}]`</span>, child)
<span class="linenr">11: </span>})
<span class="linenr">12: </span>
</pre>
              </div>
              <pre class="example" id="org43d20d6">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 12, line: 1, offset: 11 },
    end: { column: 21, line: 1, offset: 20 },
    source: "v-if='ok'"
  }
}
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'Component',
      tagType: 1,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'Component',
  tagType: 1,
  props: [
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  codegenNode: undefined
}
--------- processIf - node - dir ---------
{
  type: 1,
  ns: 0,
  tag: 'Component',
  tagType: 1,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  codegenNode: undefined
}
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 12, line: 1, offset: 11 },
    end: { column: 21, line: 1, offset: 20 },
    source: "v-if='ok'"
  }
}
--------- transformIf ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ]
}
{
  isRoot: true,
  branch: {
    type: 10,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
    },
    condition: {
      type: 4,
      content: 'ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    children: [ [Object] ],
    userKey: undefined
  }
}
--------- traverseNode ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  condition: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'Component',
      tagType: 1,
      props: [],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  userKey: undefined
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'Component',
  tagType: 1,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  codegenNode: undefined
}
--------- transformIf - isRoot - v-if ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '_component_Component',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: true,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- createRootCodegen ---------
children=1, 只有一个用 block, 多个用Fragment
--------- parseWithIfTransform| ast.children.length=1 ---------
--------- parseWithIfTransform| NodeTypes.IF=9 ---------
ast.children[0].type=9
--------- root ast ---------
{
  type: 0,
  children: [
    {
      type: 9,
      loc: [Object],
      branches: [Array],
      codegenNode: [Object]
    }
  ],
  helpers: [
    Symbol(resolveComponent),
    Symbol(openBlock),
    Symbol(createBlock),
    Symbol(createCommentVNode)
  ],
  components: [ 'Component' ],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 9,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
    },
    branches: [ [Object] ],
    codegenNode: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  }
}
--------- node.type=9, NodeTypes.IF=9 ---------
--------- node.branches.length=1 ---------
--------- node.branches[0] ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  condition: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'Component',
      tagType: 1,
      props: [],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: [Object]
    }
  ],
  userKey: undefined
}
--------- node.branches[0].children.length=1 ---------
--------- node.branches[0].children[0] ---------
{
  type: 1,
  ns: 0,
  tag: 'Component',
  tagType: 1,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 34, line: 1, offset: 33 },
    source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
  },
  codegenNode: {
    type: 13,
    tag: '_component_Component',
    props: { type: 15, loc: [Object], properties: [Array] },
    children: undefined,
    patchFlag: undefined,
    dynamicProps: undefined,
    directives: undefined,
    isBlock: true,
    disableTracking: false,
    isComponent: true,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;Component v-if='ok'&gt;&lt;/Component&gt;"
    }
  }
}
undefined
</pre>
            </details><br>
            <details class="code-details" style=
            "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
              <summary>
                <strong><font face="Courier" size="3" color=
                "red">Testing should prefix v-if
                condition</font></strong>
              </summary>
              <p>将表达式内容( <code>content:'ok'</code> )加上
              <code>content:'_ctx.ok'</code></p>
              <div class="org-src-container">
                <pre class="src src-js" id="orga72d388"><span class=
                "linenr">1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> { node, root } = parseWithIfTransform(<span class="org-string">"&lt;div v-if='ok'&gt;&lt;/div&gt;"</span>, {prefixIdentifiers: <span class="org-constant">true</span>})
<span class="linenr">4: </span>logg(<span class=
"org-string">'root ast'</span>, root)
<span class="linenr">5: </span>logg(<span class=
"org-string">`node.type=${node.type}, NodeTypes.IF=${NodeTypes.IF}`</span>)
<span class="linenr">6: </span>logg(<span class=
"org-string">`node.branches.length=${node.branches.length}`</span>)
<span class="linenr">7: </span>logg(<span class=
"org-string">`node.branches[0]`</span>, node.branches[<span class=
"org-highlight-numbers-number">0</span>])
<span class="linenr">8: </span>logg(<span class=
"org-string">`node.branches[0].condition`</span>, node.branches[<span class="org-highlight-numbers-number">0</span>].condition)
</pre>
              </div>
              <pre class="example" id="orgb125313">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 15, line: 1, offset: 14 },
    source: "v-if='ok'"
  }
}
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  },
  codegenNode: undefined
}
--------- processIf - node - dir ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  },
  codegenNode: undefined
}
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 15, line: 1, offset: 14 },
    source: "v-if='ok'"
  }
}
--------- transformIf ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ]
}
{
  isRoot: true,
  branch: {
    type: 10,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='ok'&gt;&lt;/div&gt;" },
    condition: {
      type: 4,
      content: '_ctx.ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    children: [ [Object] ],
    userKey: undefined
  }
}
--------- traverseNode ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  },
  condition: {
    type: 4,
    content: '_ctx.ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  userKey: undefined
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  },
  codegenNode: undefined
}
--------- transformIf - isRoot - v-if ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: '_ctx.ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 13,
      tag: '"div"',
      props: [Object],
      children: undefined,
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- createRootCodegen ---------
children=1, 只有一个用 block, 多个用Fragment
--------- parseWithIfTransform| ast.children.length=1 ---------
--------- parseWithIfTransform| NodeTypes.IF=9 ---------
ast.children[0].type=9
--------- root ast ---------
{
  type: 0,
  children: [
    {
      type: 9,
      loc: [Object],
      branches: [Array],
      codegenNode: [Object]
    }
  ],
  helpers: [
    Symbol(openBlock),
    Symbol(createElementBlock),
    Symbol(createCommentVNode)
  ],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 9,
    loc: { start: [Object], end: [Object], source: "&lt;div v-if='ok'&gt;&lt;/div&gt;" },
    branches: [ [Object] ],
    codegenNode: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  }
}
--------- node.type=9, NodeTypes.IF=9 ---------
--------- node.branches.length=1 ---------
--------- node.branches[0] ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: "&lt;div v-if='ok'&gt;&lt;/div&gt;"
  },
  condition: {
    type: 4,
    content: '_ctx.ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: [Object]
    }
  ],
  userKey: undefined
}
--------- node.branches[0].condition ---------
{
  type: 4,
  content: '_ctx.ok',
  isStatic: false,
  constType: 0,
  loc: {
    start: { column: 12, line: 1, offset: 11 },
    end: { column: 14, line: 1, offset: 13 },
    source: 'ok'
  }
}
undefined
</pre>
            </details>
          </div>
          <ol class="org-ol">
            <li>
              <a id="org9e5567a"></a>processIf()<br>
              <div class="outline-text-5" id="text-3-9-2-1">
                <p>初始化 <code>v-if</code> process 函数，
                <code>processIf</code> 函数里面会针对 <code>v-if</code>
                节点甚至它的兄弟节点做 一系列操作，比如将下一个是 <code>v-else</code>
                的兄弟节点删除移到自己的 <code>branches[]</code> 里面。</p>
                <div class="org-src-container">
                  <pre class="src src-js" id=
                  "org228b440"><span class=
                  "linenr"> 1: </span><span class=
                  "org-keyword">function</span> <span class=
                  "org-function-name">processIf</span>(<span class=
                  "org-variable-name">node</span>, <span class=
                  "org-variable-name">dir</span>, <span class=
                  "org-variable-name">context</span>, <span class=
                  "org-variable-name">processCodegen</span>) {
<span class="linenr"> 2: </span>  logg(<span class=
"org-string">'processIf - node - dir'</span>, node, dir)
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr"> 4: </span>    dir.name !== <span class=
"org-string">'else'</span> &amp;&
<span class=
"linenr"> 5: </span>    (!dir.exp || !dir.exp.content.trim())
<span class="linenr"> 6: </span>  ) {
<span class="linenr"> 7: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = dir.exp ? dir.exp.loc : node.loc
<span class="linenr"> 8: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;div v-if&gt;&lt;/div&gt; 没有指令值的情况，默认值为 true</span>
<span class=
"linenr"> 9: </span>    dir.exp = createSimpleExpression(<span class="org-string">`true`</span>, <span class="org-constant">false</span>, loc)
<span class="linenr">10: </span>  }
<span class="linenr">11: </span>
<span class="linenr">12: </span>  <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers &amp;& dir.exp) {
<span class="linenr">13: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dir.exp can only be simple expression because vIf transform is applied</span>
<span class="linenr">14: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">before expression transform.</span>
<span class=
"linenr">15: </span>    dir.exp = processExpression(dir.exp, context)
<span class="linenr">16: </span>  }
<span class="linenr">17: </span>
<span class="linenr">18: </span>  <span class=
"org-keyword">if</span> (dir.name === <span class=
"org-string">'if'</span>) { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-if</span>
<span class="linenr">19: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">branch</span> = createIfBranch(node, dir)
<span id="coderef-processIf-ifNode" class=
"coderef-off"><span class="linenr">20: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ifNode</span> = {</span>
<span class="linenr">21: </span>      type: NodeTypes.IF,
<span class="linenr">22: </span>      loc: node.loc,
<span id="coderef-processIf-branches" class=
"coderef-off"><span class=
"linenr">23: </span>      branches: [branch]</span>
<span class="linenr">24: </span>    }
<span id="coderef-processIf-replaceNode" class=
"coderef-off"><span class=
"linenr">25: </span>    context.replaceNode(ifNode)</span>
<span class="linenr">26: </span>    <span class=
"org-keyword">if</span> (processCodegen) {
<span class="linenr">27: </span>      <span class=
"org-keyword">return</span> processCodegen(ifNode, branch, <span class="org-constant">true</span>)
<span class="linenr">28: </span>    }
<span class="linenr">29: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">30: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">locate the adjacent v-if</span>
<span class="linenr">31: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">siblings</span> = context.parent.children
<span class="linenr">32: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">comments</span> = []
<span class="linenr">33: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = siblings.indexOf(node)
<span class="linenr">34: </span>    <span class=
"org-keyword">while</span> (i-- &gt;= -<span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">35: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">sibling</span> = siblings[i]
<span class="linenr">36: </span>
<span class="linenr">37: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">空行，空文本</span>
<span class="linenr">38: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">39: </span>        sibling &amp;&
<span class=
"linenr">40: </span>        sibling.type === NodeTypes.TEXT &amp;&
<span class=
"linenr">41: </span>        !sibling.content.trim().length
<span class="linenr">42: </span>      ) {
<span class="linenr">43: </span>        context.removeNode(sibling)
<span class="linenr">44: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">45: </span>      }
<span class="linenr">46: </span>
<span id="coderef-processIf-IF-start" class=
"coderef-off"><span class="linenr">47: </span>      <span class=
"org-keyword">if</span> (sibling &amp;& sibling.type === NodeTypes.IF) {</span>
<span class="linenr">48: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里会将原本的结点删除，而是用新组装的 if 结构(包含else-if, else 分支的结构，node.branches[...])</span>
<span id="coderef-processIf-removeNode" class=
"coderef-off"><span class=
"linenr">49: </span>        context.removeNode()</span>
<span class="linenr">50: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">branch</span> = createIfBranch(node, dir)
<span id="coderef-processIf-push-branch" class=
"coderef-off"><span class=
"linenr">51: </span>        sibling.branches.push(branch)</span>
<span class="linenr">52: </span>
<span id="coderef-processIf-onExit" class=
"coderef-off"><span class="linenr">53: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = processCodegen &amp;& processCodegen(sibling, branch, <span class="org-constant">false</span>)</span>
<span class="linenr">54: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里需要手动触发一次遍历，因为上面将原本的分支节点从原来的节点树中删除了</span>
<span class=
"linenr">55: </span>        traverseNode(branch, context)
<span class="linenr">56: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">回溯结束后执行收集到的 transformXxx 函数</span>
<span class="linenr">57: </span>        <span class=
"org-keyword">if</span> (onExit) onExit()
<span class="linenr">58: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">make sure to reset currentNode after traversal to indicate this</span>
<span class="linenr">59: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node has been removed.</span>
<span class=
"linenr">60: </span>        context.currentNode = <span class=
"org-constant">null</span>
<span id="coderef-processIf-IF-end" class=
"coderef-off"><span class="linenr">61: </span>      }</span>
<span class="linenr">62: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">63: </span>    }
<span class="linenr">64: </span>  }
<span class="linenr">65: </span>}
</pre>
                </div>
                <p>其中 <a href="#coderef-processIf-branches" class=
                "coderef" onmouseover=
                "CodeHighlightOn(this, 'coderef-processIf-branches');"
                onmouseout=
                "CodeHighlightOff(this, 'coderef-processIf-branches');">
                branches</a> 保存着所有 <code>v-else</code>,
                <code>v-else-if</code> 分支节点，这里其实是创建了一个默认的
                分支节点(注释结点)，因为 <code>v-if</code> 系列指令在 render
                函数中是以三元运算符(<code>?:</code>)形式存在 的，所以 if
                后面必须要有一个分支，即 <code>condition ? node1 : node2</code>
                中的 node2 必须是 个有效的值，才能正常使用 <code>?:</code> 运算符。</p>
              </div>
            </li>
            <li>
              <a id="org2dcffcb"></a>processExpression()<br>
              <div class="outline-text-5" id="text-3-9-2-2">
                <div class="org-src-container">
                  <pre class="src src-js" id=
                  "orged5b85d"><span class=
                  "linenr">  1: </span><span class=
                  "org-comment-delimiter">// </span><span class=
                  "org-comment">Important: since this function uses Node.js only dependencies, it should</span>
<span class="linenr">  2: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">always be used with a leading !__BROWSER__ check so that it can be</span>
<span class="linenr">  3: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">tree-shaken from the browser build.</span>
<span class="linenr">  4: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">processExpression</span>(
<span class="linenr">  5: </span>  <span class=
"org-variable-name">node</span>,
<span class="linenr">  6: </span>  <span class=
"org-variable-name">context</span>,
<span class="linenr">  7: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">some expressions like v-slot props & v-for aliases should be parsed as</span>
<span class="linenr">  8: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">function params</span>
<span class="linenr">  9: </span>  asParams = <span class=
"org-constant">false</span>,
<span class="linenr"> 10: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on handler values may contain multiple statements</span>
<span class="linenr"> 11: </span>  asRawStatements = <span class=
"org-constant">false</span>,
<span class=
"linenr"> 12: </span>  localVars = Object.create(context.identifiers)
<span class="linenr"> 13: </span>) {
<span class="linenr"> 14: </span>  <span class=
"org-keyword">if</span> (__BROWSER__) {
<span class="linenr"> 15: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr"> 16: </span>  }
<span class="linenr"> 17: </span>
<span class="linenr"> 18: </span>  <span class=
"org-keyword">if</span> (!context.prefixIdentifiers || !node.content.trim()) {
<span class="linenr"> 19: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr"> 20: </span>  }
<span class="linenr"> 21: </span>
<span class="linenr"> 22: </span>  <span class=
"org-keyword">const</span> { inline, bindingMetadata } = context
<span class="linenr"> 23: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rewriteIdentifier</span> = (raw, parent, id) =&gt; {
<span class="linenr"> 24: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">type</span> = hasOwn(bindingMetadata, raw) &amp;& bindingMetadata[raw]
<span class="linenr"> 25: </span>    <span class=
"org-keyword">if</span> (inline) {
<span class="linenr"> 26: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x = y</span>
<span class="linenr"> 27: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isAssignmentLVal</span> =
<span class=
"linenr"> 28: </span>        parent &amp;& parent.type === <span class="org-string">'AssignmentExpression'</span> &amp;& parent.left === id
<span class="linenr"> 29: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x++</span>
<span class="linenr"> 30: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isUpdateArg</span> =
<span class=
"linenr"> 31: </span>        parent &amp;& parent.type === <span class="org-string">'UpdateExpression'</span> &amp;& parent.argument === id
<span class="linenr"> 32: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">({ x } = y)</span>
<span class="linenr"> 33: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDestructureAssignment</span> =
<span class=
"linenr"> 34: </span>        parent &amp;& isInDestructureAssignment(parent, parentStack)
<span class="linenr"> 35: </span>
<span class="linenr"> 36: </span>      <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_CONST || localVars[raw]) {
<span class="linenr"> 37: </span>        <span class=
"org-keyword">return</span> raw
<span class="linenr"> 38: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_REF) {
<span class="linenr"> 39: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`${raw}.value`</span>
<span class="linenr"> 40: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_MAYBE_REF) {
<span class="linenr"> 41: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">const binding that may or may not be ref</span>
<span class="linenr"> 42: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if it's not a ref, then assignments don't make sense -</span>
<span class="linenr"> 43: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so we ignore the non-ref assignment case and generate code</span>
<span class="linenr"> 44: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">that assumes the value to be a ref for more efficiency</span>
<span class="linenr"> 45: </span>        <span class=
"org-keyword">return</span> isAssignmentLVal || isUpdateArg || isDestructureAssignment
<span class="linenr"> 46: </span>          ? <span class=
"org-string">`${raw}.value`</span>
<span class="linenr"> 47: </span>          : <span class=
"org-string">`${context.helperString(UNREF)}(${raw})`</span>
<span class="linenr"> 48: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_LET) {
<span class="linenr"> 49: </span>        <span class=
"org-keyword">if</span> (isAssignmentLVal) {
<span class="linenr"> 50: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding.</span>
<span class="linenr"> 51: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this is a bit more tricky as we need to cover the case where</span>
<span class="linenr"> 52: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let is a local non-ref value, and we need to replicate the</span>
<span class="linenr"> 53: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">right hand side value.</span>
<span class="linenr"> 54: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x = y --&gt; isRef(x) ? x.value = y : x = y</span>
<span class="linenr"> 55: </span>          <span class=
"org-keyword">const</span> { right: rVal, operator } = parent
<span class="linenr"> 56: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rExp</span> = rawExp.slice(rVal.start - <span class="org-highlight-numbers-number">1</span>, rVal.end - <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 57: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rExpString</span> = stringifyExpression(
<span class="linenr"> 58: </span>            processExpression(
<span class=
"linenr"> 59: </span>              createSimpleExpression(rExp, <span class="org-constant">false</span>),
<span class="linenr"> 60: </span>              context,
<span class="linenr"> 61: </span>              <span class=
"org-constant">false</span>,
<span class="linenr"> 62: </span>              <span class=
"org-constant">false</span>,
<span class="linenr"> 63: </span>              knownIds
<span class="linenr"> 64: </span>            )
<span class="linenr"> 65: </span>          )
<span class="linenr"> 66: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(IS_REF)}(${raw})${``} ? ${raw}.value ${operator} ${rExpString} : ${raw}`</span>
<span class="linenr"> 67: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isUpdateArg) {
<span class="linenr"> 68: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">make id replace parent in the code range so the raw update operator</span>
<span class="linenr"> 69: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">is removed</span>
<span class="linenr"> 70: </span>          id.start = parent.start
<span class="linenr"> 71: </span>          id.end = parent.end
<span class="linenr"> 72: </span>          <span class=
"org-keyword">const</span> { prefix: isPrefix, operator } = parent
<span class="linenr"> 73: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prefix</span> = isPrefix ? operator : <span class="org-string">``</span>
<span class="linenr"> 74: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">postfix</span> = isPrefix ? <span class=
"org-string">``</span> : operator
<span class="linenr"> 75: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding.</span>
<span class="linenr"> 76: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x++ --&gt; isRef(a) ? a.value++ : a++</span>
<span class="linenr"> 77: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(IS_REF)}(${raw})${``} ? ${prefix}${raw}.value${postfix} : ${prefix}${raw}${postfix}`</span>
<span class="linenr"> 78: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isDestructureAssignment) {
<span class="linenr"> 79: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span>
<span class="linenr"> 80: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding in a destructure assignment - it's very tricky to</span>
<span class="linenr"> 81: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">handle both possible cases here without altering the original</span>
<span class="linenr"> 82: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">structure of the code, so we just assume it's not a ref here</span>
<span class="linenr"> 83: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for now</span>
<span class="linenr"> 84: </span>          <span class=
"org-keyword">return</span> raw
<span class="linenr"> 85: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr"> 86: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(UNREF)}(${raw})`</span>
<span class="linenr"> 87: </span>        }
<span class="linenr"> 88: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS) {
<span class="linenr"> 89: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">use __props which is generated by compileScript so in ts mode</span>
<span class="linenr"> 90: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">it gets correct type</span>
<span class="linenr"> 91: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`__props.${raw}`</span>
<span class="linenr"> 92: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS_ALIASED) {
<span class="linenr"> 93: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">prop with a different local alias (from defineProps() destructure)</span>
<span class="linenr"> 94: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`__props.${bindingMetadata.__propsAliases[raw]}`</span>
<span class="linenr"> 95: </span>      }
<span class="linenr"> 96: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 97: </span>      <span class=
"org-keyword">if</span> (type &amp;& type.startsWith(<span class=
"org-string">'setup'</span>)) {
<span class="linenr"> 98: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">setup bindings in non-inline mode</span>
<span class="linenr"> 99: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`$setup.${raw}`</span>
<span class="linenr">100: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS_ALIASED) {
<span class="linenr">101: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`$props.${bindingMetadata.__propsAliases[raw]}`</span>
<span class="linenr">102: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type) {
<span class="linenr">103: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`$${type}.${raw}`</span>
<span class="linenr">104: </span>      }
<span class="linenr">105: </span>    }
<span class="linenr">106: </span>
<span class="linenr">107: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fallback to ctx</span>
<span class="linenr">108: </span>    <span class=
"org-keyword">return</span> <span class=
"org-string">`_ctx.${raw}`</span>
<span class="linenr">109: </span>  }
<span class="linenr">110: </span>
<span class="linenr">111: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fast path if expression is a simple identifier.</span>
<span class="linenr">112: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawExp</span> = node.content
<span class="linenr">113: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail constant on parens (function invocation) and dot (member access)</span>
<span class="linenr">114: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bailConstant</span> = rawExp.indexOf(<span class="org-string">`(`</span>) &gt; -<span class="org-highlight-numbers-number">1</span> || rawExp.indexOf(<span class="org-string">'.'</span>) &gt; <span class="org-highlight-numbers-number">0</span>
<span class="linenr">115: </span>
<span class="linenr">116: </span>  <span class=
"org-keyword">if</span> (isSimpleIdentifier(rawExp)) {
<span class="linenr">117: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isScopeVarReference</span> = context.identifiers[rawExp]
<span class="linenr">118: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isAllowedGlobal</span> = isGloballyWhitelisted(rawExp)
<span class="linenr">119: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isLiteral</span> = isLiteralWhitelisted(rawExp)
<span class="linenr">120: </span>    <span class=
"org-keyword">if</span> (!asParams &amp;& !isScopeVarReference &amp;& !isAllowedGlobal &amp;& !isLiteral) {
<span class="linenr">121: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">const bindings exposed from setup can be skipped for patching but</span>
<span class="linenr">122: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">cannot be hoisted to module scope</span>
<span class="linenr">123: </span>      <span class=
"org-keyword">if</span> (bindingMetadata[node.content] === BindingTypes.SETUP_CONST) {
<span class=
"linenr">124: </span>        node.constType = ConstantTypes.CAN_SKIP_PATCH
<span class="linenr">125: </span>      }
<span class=
"linenr">126: </span>      node.content = rewriteIdentifier(rawExp)
<span class="linenr">127: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!isScopeVarReference) {
<span class="linenr">128: </span>      <span class=
"org-keyword">if</span> (isLiteral) {
<span class=
"linenr">129: </span>        node.constType = ConstantTypes.CAN_STRINGIFY
<span class="linenr">130: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">131: </span>        node.constType = ConstantTypes.CAN_HOIST
<span class="linenr">132: </span>      }
<span class="linenr">133: </span>    }
<span class="linenr">134: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr">135: </span>  }
<span class="linenr">136: </span>
<span class="linenr">137: </span>  <span class=
"org-keyword">let</span> <span class="org-variable-name">ast</span>
<span class="linenr">138: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">exp needs to be parsed differently:</span>
<span class="linenr">139: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Multiple inline statements (v-on, with presence of `;`): parse as raw</span>
<span class="linenr">140: </span>  <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">exp, but make sure to pad with spaces for consistent ranges</span>
<span class="linenr">141: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. Expressions: wrap with parens (for e.g. object expressions)</span>
<span class="linenr">142: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. Function arguments (v-for, v-slot): place in a function argument position</span>
<span class="linenr">143: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">source</span> = asRawStatements
<span class="linenr">144: </span>    ? <span class=
"org-string">` ${rawExp} `</span>
<span class="linenr">145: </span>    : <span class=
"org-string">`(${rawExp})${asParams ? `</span>=&gt;{}<span class=
"org-string">` : ``}`</span>
<span class="linenr">146: </span>  <span class=
"org-keyword">try</span> {
<span class=
"linenr">147: </span>    ast = babelParser.parse(source, {
<span class=
"linenr">148: </span>      plugins: context.expressionPlugins
<span class="linenr">149: </span>    }).program
<span class="linenr">150: </span>  } <span class=
"org-keyword">catch</span> (e) {
<span class="linenr">151: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr">152: </span>  }
<span class="linenr">153: </span>
<span class="linenr">154: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ids</span>= []
<span class="linenr">155: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parentStack</span> = []
<span class="linenr">156: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">knownIds</span> = Object.create(context.identifiers)
<span class="linenr">157: </span>
<span class="linenr">158: </span>  walkIdentifiers(
<span class="linenr">159: </span>    ast,
<span class=
"linenr">160: </span>    (node, parent, _, isReferenced, isLocal) =&gt; {
<span class="linenr">161: </span>      <span class=
"org-keyword">if</span> (isStaticPropertyKey(node, parent)) {
<span class="linenr">162: </span>        <span class=
"org-keyword">return</span>
<span class="linenr">163: </span>      }
<span class="linenr">164: </span>
<span class="linenr">165: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needPrefix</span> = isReferenced &amp;& canPrefix(node)
<span class="linenr">166: </span>      <span class=
"org-keyword">if</span> (needPrefix &amp;& !isLocal) {
<span class="linenr">167: </span>        <span class=
"org-keyword">if</span> (isStaticProperty(parent) &amp;& parent.shorthand) {
<span class="linenr">168: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">property shorthand like { foo }, we need to add the key since</span>
<span class="linenr">169: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we rewrite the value</span>
<span class=
"linenr">170: </span>          node.prefix = <span class=
"org-string">`${node.name}: `</span>
<span class="linenr">171: </span>        }
<span class=
"linenr">172: </span>        node.name = rewriteIdentifier(node.name, parent, node)
<span class="linenr">173: </span>        ids.push(node)
<span class="linenr">174: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">175: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">The identifier is considered constant unless it's pointing to a</span>
<span class="linenr">176: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">local scope variable (a v-for alias, or a v-slot prop)</span>
<span class="linenr">177: </span>        <span class=
"org-keyword">if</span> (!(needPrefix &amp;& isLocal) &amp;& !bailConstant) {
<span class=
"linenr">178: </span>          node.isConstant = <span class=
"org-constant">true</span>
<span class="linenr">179: </span>        }
<span class="linenr">180: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also generate sub-expressions for other identifiers for better</span>
<span class="linenr">181: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">source map support. (except for property keys which are static)</span>
<span class="linenr">182: </span>        ids.push(node)
<span class="linenr">183: </span>      }
<span class="linenr">184: </span>    },
<span class="linenr">185: </span>    <span class=
"org-constant">true</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">invoke on ALL identifiers</span>
<span class="linenr">186: </span>    parentStack,
<span class="linenr">187: </span>    knownIds
<span class="linenr">188: </span>  )
<span class="linenr">189: </span>
<span class="linenr">190: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">We break up the compound expression into an array of strings and sub</span>
<span class="linenr">191: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">expressions (for identifiers that have been prefixed). In codegen, if</span>
<span class="linenr">192: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">an ExpressionNode has the `.children` property, it will be used instead of</span>
<span class="linenr">193: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`.content`.</span>
<span class="linenr">194: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">children</span> = []
<span class=
"linenr">195: </span>  ids.sort((a, b) =&gt; a.start - b.start)
<span class="linenr">196: </span>  ids.forEach((id, i) =&gt; {
<span class="linenr">197: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">range is offset by -1 due to the wrapping parens when parsed</span>
<span class="linenr">198: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = id.start - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">199: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">end</span> = id.end - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">200: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">last</span> = ids[i - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">201: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">leadingText</span> = rawExp.slice(last ? last.end - <span class="org-highlight-numbers-number">1</span> : <span class="org-highlight-numbers-number">0</span>, start)
<span class="linenr">202: </span>    <span class=
"org-keyword">if</span> (leadingText.length || id.prefix) {
<span class=
"linenr">203: </span>      children.push(leadingText + (id.prefix || <span class="org-string">``</span>))
<span class="linenr">204: </span>    }
<span class="linenr">205: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">source</span> = rawExp.slice(start, end)
<span class="linenr">206: </span>    children.push(
<span class="linenr">207: </span>      createSimpleExpression(
<span class="linenr">208: </span>        id.name,
<span class="linenr">209: </span>        <span class=
"org-constant">false</span>,
<span class="linenr">210: </span>        {
<span class="linenr">211: </span>          source,
<span class=
"linenr">212: </span>          start: advancePositionWithClone(node.loc.start, source, start),
<span class=
"linenr">213: </span>          end: advancePositionWithClone(node.loc.start, source, end)
<span class="linenr">214: </span>        },
<span class=
"linenr">215: </span>        id.isConstant ? ConstantTypes.CAN_STRINGIFY : ConstantTypes.NOT_CONSTANT
<span class="linenr">216: </span>      )
<span class="linenr">217: </span>    )
<span class="linenr">218: </span>    <span class=
"org-keyword">if</span> (i === ids.length - <span class=
"org-highlight-numbers-number">1</span> &amp;& end &lt; rawExp.length) {
<span class=
"linenr">219: </span>      children.push(rawExp.slice(end))
<span class="linenr">220: </span>    }
<span class="linenr">221: </span>  })
<span class="linenr">222: </span>
<span class="linenr">223: </span>  <span class=
"org-keyword">let</span> <span class="org-variable-name">ret</span>
<span class="linenr">224: </span>  <span class=
"org-keyword">if</span> (children.length) {
<span class=
"linenr">225: </span>    ret = createCompoundExpression(children, node.loc)
<span class="linenr">226: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">227: </span>    ret = node
<span class="linenr">228: </span>    ret.constType = bailConstant
<span class="linenr">229: </span>      ? ConstantTypes.NOT_CONSTANT
<span class=
"linenr">230: </span>      : ConstantTypes.CAN_STRINGIFY
<span class="linenr">231: </span>  }
<span class=
"linenr">232: </span>  ret.identifiers = Object.keys(knownIds)
<span class="linenr">233: </span>  <span class=
"org-keyword">return</span> ret
<span class="linenr">234: </span>}
<span class="linenr">235: </span>
<span class="linenr">236: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">canPrefix</span>(<span class=
"org-variable-name">id</span>) {
<span class="linenr">237: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip whitelisted globals</span>
<span class="linenr">238: </span>  <span class=
"org-keyword">if</span> (isGloballyWhitelisted(id.name)) {
<span class="linenr">239: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">240: </span>  }
<span class="linenr">241: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">special case for webpack compilation</span>
<span class="linenr">242: </span>  <span class=
"org-keyword">if</span> (id.name === <span class=
"org-string">'require'</span>) {
<span class="linenr">243: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">244: </span>  }
<span class="linenr">245: </span>  <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">246: </span>}
<span class="linenr">247: </span>
<span class="linenr">248: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyExpression</span>(<span class=
"org-variable-name">exp</span>){
<span class="linenr">249: </span>  <span class=
"org-keyword">if</span> (isString(exp)) {
<span class="linenr">250: </span>    <span class=
"org-keyword">return</span> exp
<span class="linenr">251: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">252: </span>    <span class=
"org-keyword">return</span> exp.content
<span class="linenr">253: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">254: </span>    <span class=
"org-keyword">return</span> exp.children.map(stringifyExpression).join(<span class="org-string">''</span>)
<span class="linenr">255: </span>  }
<span class="linenr">256: </span>}
<span class="linenr">257: </span>
</pre>
                </div>
              </div>
            </li>
            <li>
              <a id="orgafe859f"></a>getParentCondition()<br>
              <div class="outline-text-5" id="text-3-9-2-3">
                <div class="org-src-container">
                  <pre class="src src-js" id=
                  "org0f8d89e"><span class=
                  "linenr"> 1: </span><span class=
                  "org-keyword">function</span> <span class=
                  "org-function-name">getParentCondition</span>(<span class=
                  "org-variable-name">node</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">while</span> (<span class=
"org-constant">true</span>) {
<span class="linenr"> 3: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.JS_CONDITIONAL_EXPRESSION) {
<span class="linenr"> 4: </span>      <span class=
"org-keyword">if</span> (node.alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION) {
<span class="linenr"> 5: </span>        node = node.alternate
<span class="linenr"> 6: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr"> 7: </span>        <span class=
"org-keyword">return</span> node
<span class="linenr"> 8: </span>      }
<span class="linenr"> 9: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.type === NodeTypes.JS_CACHE_EXPRESSION) {
<span class="linenr">10: </span>      node = node.value
<span class="linenr">11: </span>    }
<span class="linenr">12: </span>  }
<span class="linenr">13: </span>}
<span class="linenr">14: </span>
</pre>
                </div>
              </div>
            </li>
            <li>
              <a id="orgc407ba6"></a>createIfBranch()<br>
              <div class="outline-text-5" id="text-3-9-2-4">
                <div class="org-src-container">
                  <pre class="src src-js" id=
                  "org6e7f75d"><span class=
                  "linenr"> 1: </span><span class=
                  "org-keyword">function</span> <span class=
                  "org-function-name">createIfBranch</span>(<span class=
                  "org-variable-name">node</span>, <span class=
                  "org-variable-name">dir</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr"> 3: </span>    type: NodeTypes.IF_BRANCH,
<span class="linenr"> 4: </span>    loc: node.loc,
<span class=
"linenr"> 5: </span>    condition: dir.name === <span class=
"org-string">'else'</span> ? <span class=
"org-constant">undefined</span> : dir.exp,
<span class="linenr"> 6: </span>    children:
<span class=
"linenr"> 7: </span>      node.tagType === ElementTypes.TEMPLATE &amp;& !findDir(node, <span class="org-string">'for'</span>)
<span class="linenr"> 8: </span>        ? node.children
<span class="linenr"> 9: </span>        : [node],
<span class=
"linenr">10: </span>    userKey: findProp(node, <span class=
"org-string">`key`</span>)
<span class="linenr">11: </span>  }
<span class="linenr">12: </span>}
</pre>
                </div>
              </div>
            </li>
            <li>
              <a id=
              "org7eb82d2"></a>createCodegenNodeForBranch()<br>
              <div class="outline-text-5" id="text-3-9-2-5">
                <div class="org-src-container">
                  <pre class="src src-js" id=
                  "orgad631f0"><span class=
                  "linenr"> 1: </span><span class=
                  "org-keyword">function</span> <span class=
                  "org-function-name">createCodegenNodeForBranch</span>(<span class=
                  "org-variable-name">branch</span>, <span class=
                  "org-variable-name">keyIndex</span>, <span class=
                  "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">if</span> (branch.condition) {
<span class="linenr"> 3: </span>    <span class=
"org-keyword">return</span> createConditionalExpression(
<span class="linenr"> 4: </span>      branch.condition,
<span class=
"linenr"> 5: </span>      createChildrenCodegenNode(branch, keyIndex, context),
<span class="linenr"> 6: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里是考虑到只有 v-if 的情况，因为 v-if 指令最后都会被解析成三目运算符形式</span>
<span class="linenr"> 7: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如： &lt;div v-if="foo"/&gt;&lt;div v-else/&gt; =&gt; foo ? ... : ...</span>
<span class="linenr"> 8: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如： &lt;div v-if="foo"/&gt;&lt;div v-else-if="bar"/&gt;&lt;div v-else/&gt; =&gt; foo ? ... : bar ? ... : ...</span>
<span class="linenr"> 9: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">所以必需得要有一个 v-else，如果没有的话就相当于是 `foo ? ...` 这样的语句是不合法的</span>
<span class="linenr">10: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">因此这里在判断没有 v-else 分支的情况时默认给它创建了个注释节点</span>
<span class=
"linenr">11: </span>      createCallExpression(context.helper(CREATE_COMMENT), [
<span class="linenr">12: </span>        __DEV__ ? <span class=
"org-string">'"v-if"'</span> : <span class=
"org-string">'""'</span>,
<span class="linenr">13: </span>        <span class=
"org-string">'true'</span>
<span class="linenr">14: </span>      ])
<span class="linenr">15: </span>    )
<span class="linenr">16: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">17: </span>    <span class=
"org-keyword">return</span> createChildrenCodegenNode(branch, keyIndex, context)
<span class="linenr">18: </span>  }
<span class="linenr">19: </span>}
</pre>
                </div>
              </div>
            </li>
            <li>
              <a id=
              "org34aa05f"></a>createChildrenCodegenNode()<br>
              <div class="outline-text-5" id="text-3-9-2-6">
                <div class="org-src-container">
                  <pre class="src src-js" id=
                  "orgf4ae18a"><span class=
                  "linenr"> 1: </span><span class=
                  "org-keyword">function</span> <span class=
                  "org-function-name">createChildrenCodegenNode</span>(<span class=
                  "org-variable-name">branch</span>, <span class=
                  "org-variable-name">keyIndex</span>, <span class=
                  "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> { helper } = context
<span class="linenr"> 3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyProperty</span> = createObjectProperty(
<span class="linenr"> 4: </span>    <span class=
"org-string">`key`</span>,
<span class="linenr"> 5: </span>    createSimpleExpression(
<span class="linenr"> 6: </span>      <span class=
"org-string">`${keyIndex}`</span>,
<span class="linenr"> 7: </span>      <span class=
"org-constant">false</span>,
<span class="linenr"> 8: </span>      locStub,
<span class="linenr"> 9: </span>      ConstantTypes.CAN_HOIST
<span class="linenr">10: </span>    )
<span class="linenr">11: </span>  )
<span class="linenr">12: </span>  <span class=
"org-keyword">const</span> { children } = branch
<span class="linenr">13: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">firstChild</span> = children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">14: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needFragmentWrapper</span> =
<span class=
"linenr">15: </span>    children.length !== <span class="org-highlight-numbers-number">1</span> || firstChild.type !== NodeTypes.ELEMENT
<span class="linenr">16: </span>  <span class=
"org-keyword">if</span> (needFragmentWrapper) {
<span class="linenr">17: </span>    <span class=
"org-keyword">if</span> (children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;& firstChild.type === NodeTypes.FOR) {
<span class="linenr">18: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">optimize away nested fragments when child is a ForNode</span>
<span class="linenr">19: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">vnodeCall</span> = firstChild.codegenNode
<span class=
"linenr">20: </span>      injectProp(vnodeCall, keyProperty, context)
<span class="linenr">21: </span>      <span class=
"org-keyword">return</span> vnodeCall
<span class="linenr">22: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">23: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = PatchFlags.STABLE_FRAGMENT
<span class="linenr">24: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlagText</span> = PatchFlagNames[PatchFlags.STABLE_FRAGMENT]
<span class="linenr">25: </span>
<span class="linenr">26: </span>      <span class=
"org-keyword">return</span> createVNodeCall(
<span class="linenr">27: </span>        context,
<span class="linenr">28: </span>        helper(FRAGMENT),
<span class=
"linenr">29: </span>        createObjectExpression([keyProperty]),
<span class="linenr">30: </span>        children,
<span class=
"linenr">31: </span>        patchFlag + (__DEV__ ? <span class=
"org-string">` /* ${patchFlagText} */`</span> : <span class=
"org-string">``</span>),
<span class="linenr">32: </span>        <span class=
"org-constant">undefined</span>,
<span class="linenr">33: </span>        <span class=
"org-constant">undefined</span>,
<span class="linenr">34: </span>        <span class=
"org-constant">true</span>,
<span class="linenr">35: </span>        <span class=
"org-constant">false</span>,
<span class="linenr">36: </span>        <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isComponent</span><span class=
"org-comment-delimiter"> */</span>,
<span class="linenr">37: </span>        branch.loc
<span class="linenr">38: </span>      )
<span class="linenr">39: </span>    }
<span class="linenr">40: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">41: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ret</span> = firstChild.codegenNode
<span class="linenr">42: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">vnodeCall</span> = getMemoedVNodeCall(ret)
<span class="linenr">43: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Change createVNode to createBlock.</span>
<span class="linenr">44: </span>    <span class=
"org-keyword">if</span> (vnodeCall.type === NodeTypes.VNODE_CALL) {
<span class="linenr">45: </span>      makeBlock(vnodeCall, context)
<span class="linenr">46: </span>    }
<span class="linenr">47: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inject branch key</span>
<span class=
"linenr">48: </span>    injectProp(vnodeCall, keyProperty, context)
<span class="linenr">49: </span>    <span class=
"org-keyword">return</span> ret
<span class="linenr">50: </span>  }
<span class="linenr">51: </span>}
</pre>
                </div>
              </div>
            </li>
            <li>
              <a id="org88e4338"></a>isSameKey()<br>
              <div class="outline-text-5" id="text-3-9-2-7">
                <div class="org-src-container">
                  <pre class="src src-js" id=
                  "orgf0927ab"><span class=
                  "linenr"> 1: </span><span class=
                  "org-keyword">function</span> <span class=
                  "org-function-name">isSameKey</span>(<span class=
                  "org-variable-name">a</span>, <span class=
                  "org-variable-name">b</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">if</span> (!a || a.type !== b.type) {
<span class="linenr"> 3: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr"> 4: </span>  }
<span class="linenr"> 5: </span>  <span class=
"org-keyword">if</span> (a.type === NodeTypes.ATTRIBUTE) {
<span class="linenr"> 6: </span>    <span class=
"org-keyword">if</span> (a.value.content !== b.value.content) {
<span class="linenr"> 7: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr"> 8: </span>    }
<span class="linenr"> 9: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">10: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">directive</span>
<span class="linenr">11: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> = a.exp
<span class="linenr">12: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">branchExp</span> = b.exp
<span class="linenr">13: </span>    <span class=
"org-keyword">if</span> (exp.type !== branchExp.type) {
<span class="linenr">14: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">15: </span>    }
<span class="linenr">16: </span>    <span class=
"org-keyword">if</span> (
<span class=
"linenr">17: </span>      exp.type !== NodeTypes.SIMPLE_EXPRESSION ||
<span class=
"linenr">18: </span>      exp.isStatic !== branchExp.isStatic ||
<span class=
"linenr">19: </span>      exp.content !== branchExp.content
<span class="linenr">20: </span>    ) {
<span class="linenr">21: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">22: </span>    }
<span class="linenr">23: </span>  }
<span class="linenr">24: </span>  <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">25: </span>}
</pre>
                </div>
              </div>
            </li>
          </ol>
        </div>
        <div id="outline-container-org8911660" class="outline-4">
          <h4 id="org8911660"><span class=
          "section-number-4">3.9.3.</span>
          transformSlotOutlet()</h4>
          <div class="outline-text-4" id="text-3-9-3">
            <p>处理 <code>&lt;slot/&gt;</code> 插槽。</p>
            <div class="org-src-container">
              <pre class="src src-js" id="org0ca42d1"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">const</span> <span class=
              "org-variable-name">transformSlotOutlet</span> = (node, context) =&gt; {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">if</span> (isSlotOutlet(node)) { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;slot/&gt;</span>
<span class="linenr"> 3: </span>    <span class=
"org-keyword">const</span> { children, loc } = node
<span class="linenr"> 4: </span>    <span class=
"org-keyword">const</span> { slotName, slotProps } = processSlotOutlet(node, context)
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotArgs</span> = [
<span class=
"linenr"> 7: </span>      context.prefixIdentifiers ? <span class=
"org-string">`_ctx.$slots`</span> : <span class=
"org-string">`$slots`</span>,
<span class="linenr"> 8: </span>      slotName,
<span class="linenr"> 9: </span>      <span class=
"org-string">'{}'</span>, <span class=
"org-comment-delimiter">//  </span><span class=
"org-comment">props</span>
<span class="linenr">10: </span>      <span class=
"org-string">'undefined'</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">children</span>
<span class="linenr">11: </span>      <span class=
"org-string">'true'</span>
<span class="linenr">12: </span>    ]
<span class="linenr">13: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">expectedLen</span> = <span class=
"org-highlight-numbers-number">2</span>
<span class="linenr">14: </span>
<span class="linenr">15: </span>    <span class=
"org-keyword">if</span> (slotProps) {
<span class="linenr">16: </span>      slotArgs[<span class=
"org-highlight-numbers-number">2</span>] = slotProps
<span class="linenr">17: </span>      expectedLen = <span class=
"org-highlight-numbers-number">3</span>
<span class="linenr">18: </span>    }
<span class="linenr">19: </span>
<span class="linenr">20: </span>    <span class=
"org-keyword">if</span> (children.length) {
<span class="linenr">21: </span>      slotArgs[<span class=
"org-highlight-numbers-number">3</span>] = createFunctionExpression([], children, <span class="org-constant">false</span>, <span class="org-constant">false</span>, loc)
<span class="linenr">22: </span>      expectedLen = <span class=
"org-highlight-numbers-number">4</span>
<span class="linenr">23: </span>    }
<span class="linenr">24: </span>
<span class="linenr">25: </span>    <span class=
"org-keyword">if</span> (context.scopeId &amp;& !context.slotted) {
<span class="linenr">26: </span>      expectedLen = <span class=
"org-highlight-numbers-number">5</span>
<span class="linenr">27: </span>    }
<span class=
"linenr">28: </span>    slotArgs.splice(expectedLen) <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">remove unused arguments</span>
<span class="linenr">29: </span>
<span class="linenr">30: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">-&gt; renderSlot($slots, slotName, props, children, true)</span>
<span class=
"linenr">31: </span>    node.codegenNode = createCallExpression(
<span class=
"linenr">32: </span>      context.helper(RENDER_SLOT), <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">renderSlot</span>
<span class="linenr">33: </span>      slotArgs,
<span class="linenr">34: </span>      loc
<span class="linenr">35: </span>    )
<span class="linenr">36: </span>  }
<span class="linenr">37: </span>}
<span class="linenr">38: </span>
<span class="linenr">39: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">processSlotOutlet</span>(
<span class="linenr">40: </span>  <span class=
"org-variable-name">node</span>,
<span class="linenr">41: </span>  context
<span class="linenr">42: </span>) {
<span class="linenr">43: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">slotName</span> = <span class=
"org-string">`"default"`</span>
<span class="linenr">44: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">slotProps</span> = <span class=
"org-constant">undefined</span>
<span class="linenr">45: </span>
<span class="linenr">46: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nonNameProps</span> = [] <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">无名插槽</span>
<span class="linenr">47: </span>  logg(<span class=
"org-string">`processSlotOutlet| props.length = ${node.props.length}`</span>)
<span class="linenr">48: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">49: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">50: </span>    logg(<span class=
"org-string">`processSlotOutlet| props[${i}]`</span>, p)
<span class="linenr">51: </span>    <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE) { <span class="org-comment-delimiter">// </span><span class="org-comment">静态 &lt;slot name="xxx"/&gt;</span>
<span class="linenr">52: </span>      <span class=
"org-keyword">if</span> (p.value) {
<span class="linenr">53: </span>        <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'name'</span>) {
<span class=
"linenr">54: </span>          slotName = JSON.stringify(p.value.content)
<span class="linenr">55: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">56: </span>          p.name = camelize(p.name)
<span class="linenr">57: </span>          nonNameProps.push(p)
<span class="linenr">58: </span>        }
<span class="linenr">59: </span>      }
<span class="linenr">60: </span>    } <span class=
"org-keyword">else</span> { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">动态 &lt;slot :name="xxx"/&gt;</span>
<span class="linenr">61: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">动态插槽 &lt;slot v-bind:name="slotName"/&gt;</span>
<span class="linenr">62: </span>      <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'bind'</span> &amp;& isStaticArgOf(p.arg, <span class=
"org-string">'name'</span>)) {
<span class="linenr">63: </span>        <span class=
"org-keyword">if</span> (p.exp) slotName = p.exp
<span class="linenr">64: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">65: </span>        <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'bind'</span> &amp;& p.arg &amp;& isStaticExp(p.arg)) {
<span class=
"linenr">66: </span>          p.arg.content = camelize(p.arg.content)
<span class="linenr">67: </span>        }
<span class="linenr">68: </span>        nonNameProps.push(p)
<span class="linenr">69: </span>      }
<span class="linenr">70: </span>    }
<span class="linenr">71: </span>  }
<span class="linenr">72: </span>
<span class="linenr">73: </span>  logg(<span class=
"org-string">`processSlotOutlet| nonNameProps.length=${nonNameProps.length}`</span>)
<span class="linenr">74: </span>  <span class=
"org-keyword">if</span> (nonNameProps.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">75: </span>    <span class=
"org-keyword">const</span> { props, directives } = buildProps(node, context, nonNameProps)
<span class="linenr">76: </span>    slotProps = props
<span class="linenr">77: </span>
<span class="linenr">78: </span>    <span class=
"org-keyword">if</span> (directives.length) {
<span class="linenr">79: </span>      logg(<span class=
"org-string">'[ERROR] X_V_SLOT_UNEXPECTED_DIRECTIVE_ON_SLOT_OUTLET'</span>)
<span class="linenr">80: </span>    }
<span class="linenr">81: </span>  }
<span class="linenr">82: </span>
<span class="linenr">83: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">84: </span>    slotName,
<span class="linenr">85: </span>    slotProps
<span class="linenr">86: </span>  }
<span class="linenr">87: </span>}
</pre>
            </div>
            <p><span style="color:red;">Testing</span></p><br>
            <details class="code-details" style=
            "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
              <summary>
                <strong><font face="Courier" size="3" color=
                "red">Testing v-if with slot</font></strong>
              </summary>
              <div class="org-src-container">
                <pre class="src src-js" id="org73078fe"><span class=
                "linenr">1: </span>&lt;&lt;transform-testing-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> { node, root } = parseWithIfTransform(<span class="org-string">"&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"</span>)
<span class="linenr">4: </span>logg(<span class=
"org-string">'root ast'</span>, root)
<span class="linenr">5: </span>logg(<span class=
"org-string">`node.type=${node.type}, NodeTypes.IF=${NodeTypes.IF}`</span>)
<span class="linenr">6: </span>logg(<span class=
"org-string">`node.codegenNode`</span>, node.codegenNode)
<span class="linenr">7: </span>logg(<span class=
"org-string">`node.codegenNode.consequent`</span>, node.codegenNode.consequent)
</pre>
              </div>
              <pre class="example" id="orgf03b52a">
--------- createStructuralDirectiveTransform ---------
name=/^(if|else|else-if)$/, matches=(n) =&gt; name.test(n)
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 20, line: 1, offset: 19 },
    source: "v-if='ok'"
  }
}
--------- traverseNode ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'template',
      tagType: 3,
      props: [Array],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 39, line: 1, offset: 38 },
    source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
  }
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'template',
  tagType: 3,
  props: [
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: false,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'slot',
      tagType: 2,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 39, line: 1, offset: 38 },
    source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
  },
  codegenNode: undefined
}
--------- processIf - node - dir ---------
{
  type: 1,
  ns: 0,
  tag: 'template',
  tagType: 3,
  props: [],
  isSelfClosing: false,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'slot',
      tagType: 2,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 39, line: 1, offset: 38 },
    source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
  },
  codegenNode: undefined
}
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 20, line: 1, offset: 19 },
    source: "v-if='ok'"
  }
}
--------- transformIf ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 39, line: 1, offset: 38 },
    source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ]
}
{
  isRoot: true,
  branch: {
    type: 10,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
    },
    condition: {
      type: 4,
      content: 'ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    children: [ [Object] ],
    userKey: undefined
  }
}
--------- traverseNode ---------
{
  type: 10,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 39, line: 1, offset: 38 },
    source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
  },
  condition: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'slot',
      tagType: 2,
      props: [],
      isSelfClosing: true,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  userKey: undefined
}
--------- traverseNode ---------
{
  type: 1,
  ns: 0,
  tag: 'slot',
  tagType: 2,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 21, line: 1, offset: 20 },
    end: { column: 28, line: 1, offset: 27 },
    source: '&lt;slot/&gt;'
  },
  codegenNode: undefined
}
--------- processSlotOutlet| props.length = 0 ---------
--------- processSlotOutlet| nonNameProps.length=0 ---------
--------- transformIf - isRoot - v-if ---------
{
  type: 9,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 39, line: 1, offset: 38 },
    source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
  },
  branches: [
    {
      type: 10,
      loc: [Object],
      condition: [Object],
      children: [Array],
      userKey: undefined
    }
  ],
  codegenNode: {
    type: 19,
    test: {
      type: 4,
      content: 'ok',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    consequent: {
      type: 14,
      loc: [Object],
      callee: Symbol(renderSlot),
      arguments: [Array]
    },
    alternate: {
      type: 14,
      loc: [Object],
      callee: Symbol(createCommentVNode),
      arguments: [Array]
    },
    newline: true,
    loc: { source: '', start: [Object], end: [Object] }
  }
}
--------- createRootCodegen ---------
children=1, 只有一个用 block, 多个用Fragment
--------- parseWithIfTransform| ast.children.length=1 ---------
--------- parseWithIfTransform| NodeTypes.IF=9 ---------
ast.children[0].type=9
--------- root ast ---------
{
  type: 0,
  children: [
    {
      type: 9,
      loc: [Object],
      branches: [Array],
      codegenNode: [Object]
    }
  ],
  helpers: [ Symbol(renderSlot), Symbol(createCommentVNode) ],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: {
    type: 9,
    loc: {
      start: [Object],
      end: [Object],
      source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
    },
    branches: [ [Object] ],
    codegenNode: {
      type: 19,
      test: [Object],
      consequent: [Object],
      alternate: [Object],
      newline: true,
      loc: [Object]
    }
  },
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 39, line: 1, offset: 38 },
    source: "&lt;template v-if='ok'&gt;&lt;slot/&gt;&lt;/template&gt;"
  }
}
--------- node.type=9, NodeTypes.IF=9 ---------
--------- node.codegenNode ---------
{
  type: 19,
  test: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  consequent: {
    type: 14,
    loc: { start: [Object], end: [Object], source: '&lt;slot/&gt;' },
    callee: Symbol(renderSlot),
    arguments: [ '$slots', '"default"', [Object] ]
  },
  alternate: {
    type: 14,
    loc: { source: '', start: [Object], end: [Object] },
    callee: Symbol(createCommentVNode),
    arguments: [ '"v-if"', 'true' ]
  },
  newline: true,
  loc: {
    source: '',
    start: { line: 1, column: 1, offset: 0 },
    end: { line: 1, column: 1, offset: 0 }
  }
}
--------- node.codegenNode.consequent ---------
{
  type: 14,
  loc: {
    start: { column: 21, line: 1, offset: 20 },
    end: { column: 28, line: 1, offset: 27 },
    source: '&lt;slot/&gt;'
  },
  callee: Symbol(renderSlot),
  arguments: [
    '$slots',
    '"default"',
    { type: 15, loc: [Object], properties: [Array] }
  ]
}
undefined
</pre>
            </details>
          </div>
        </div>
        <div id="outline-container-org385e800" class="outline-4">
          <h4 id="org385e800"><span class=
          "section-number-4">3.9.4.</span> trackSlotScopes()</h4>
          <div class="outline-text-4" id="text-3-9-4">
            <div class="org-src-container">
              <pre class="src src-js" id="org286e367"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">trackSlotScopes</span>() {}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgf1bd16f" class="outline-4">
          <h4 id="orgf1bd16f"><span class=
          "section-number-4">3.9.5.</span>
          trackVForSlotScopes()</h4>
          <div class="outline-text-4" id="text-3-9-5">
            <div class="org-src-container">
              <pre class="src src-js" id="org647a8ca"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">trackVForSlotScopes</span>() {}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgf947eb5" class="outline-4">
          <h4 id="orgf947eb5"><span class=
          "section-number-4">3.9.6.</span> transformText()</h4>
          <div class="outline-text-4" id="text-3-9-6">
            <div class="org-src-container">
              <pre class="src src-js" id="orgfa261f3"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">transformText</span>() {}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org15df7d8" class="outline-4">
          <h4 id="org15df7d8"><span class=
          "section-number-4">3.9.7.</span> transformElement()</h4>
          <div class="outline-text-4" id="text-3-9-7">
            <div class="org-src-container">
              <pre class="src src-js" id="org389b397"><span class=
              "linenr">  1: </span><span class=
              "org-comment-delimiter">// </span><span class=
              "org-comment">some directive transforms (e.g. v-model) may return a symbol for runtime</span>
<span class="linenr">  2: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">import, which should be used instead of a resolveDirective call.</span>
<span class="linenr">  3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">directiveImportMap</span> = <span class=
"org-keyword">new</span> <span class="org-type">WeakMap</span>()
<span class="linenr">  4: </span>
<span class="linenr">  5: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generate a JavaScript AST for this element's codegen</span>
<span class="linenr">  6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformElement</span> = (node, context) =&gt; {
<span class="linenr">  7: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">perform the work on exit, after all child expressions have been</span>
<span class="linenr">  8: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">processed and merged.</span>
<span class="linenr">  9: </span>  <span class=
"org-keyword">return</span> <span class=
"org-keyword">function</span> postTransformElement() {
<span class="linenr"> 10: </span>    node = context.currentNode
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr"> 13: </span>      !(
<span class=
"linenr"> 14: </span>        node.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr"> 15: </span>        (node.tagType === ElementTypes.ELEMENT ||
<span class=
"linenr"> 16: </span>          node.tagType === ElementTypes.COMPONENT)
<span class="linenr"> 17: </span>      )
<span class="linenr"> 18: </span>    ) {
<span class="linenr"> 19: </span>      <span class=
"org-keyword">return</span>
<span class="linenr"> 20: </span>    }
<span class="linenr"> 21: </span>
<span class="linenr"> 22: </span>    <span class=
"org-keyword">const</span> { tag, props } = node
<span class="linenr"> 23: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isComponent</span> = node.tagType === ElementTypes.COMPONENT
<span class="linenr"> 24: </span>
<span class="linenr"> 25: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">The goal of the transform is to create a codegenNode implementing the</span>
<span class="linenr"> 26: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">VNodeCall interface.</span>
<span class="linenr"> 27: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeTag</span> = isComponent
<span class=
"linenr"> 28: </span>      ? resolveComponentType(node, context)
<span class="linenr"> 29: </span>      : <span class=
"org-string">`"${tag}"`</span>
<span class="linenr"> 30: </span>
<span class="linenr"> 31: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDynamicComponent</span> =
<span class=
"linenr"> 32: </span>      isObject(vnodeTag) &amp;& vnodeTag.callee === RESOLVE_DYNAMIC_COMPONENT
<span class="linenr"> 33: </span>
<span class="linenr"> 34: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeProps</span>
<span class="linenr"> 35: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeChildren</span>
<span class="linenr"> 36: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodePatchFlag</span>
<span class="linenr"> 37: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 38: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeDynamicProps</span>
<span class="linenr"> 39: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">dynamicPropNames</span>
<span class="linenr"> 40: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeDirectives</span>
<span class="linenr"> 41: </span>
<span class="linenr"> 42: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">shouldUseBlock</span> =
<span class="linenr"> 43: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dynamic component may resolve to plain elements</span>
<span class="linenr"> 44: </span>      isDynamicComponent ||
<span class="linenr"> 45: </span>      vnodeTag === TELEPORT ||
<span class="linenr"> 46: </span>      vnodeTag === SUSPENSE ||
<span class="linenr"> 47: </span>      (!isComponent &amp;&
<span class="linenr"> 48: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;svg&gt; and &lt;foreignObject&gt; must be forced into blocks so that block</span>
<span class="linenr"> 49: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">updates inside get proper isSVG flag at runtime. (#639, #643)</span>
<span class="linenr"> 50: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">This is technically web-specific, but splitting the logic out of core</span>
<span class="linenr"> 51: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">leads to too much unnecessary complexity.</span>
<span class="linenr"> 52: </span>        (tag === <span class=
"org-string">'svg'</span> || tag === <span class=
"org-string">'foreignObject'</span>))
<span class="linenr"> 53: </span>
<span class="linenr"> 54: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">props</span>
<span class="linenr"> 55: </span>    <span class=
"org-keyword">if</span> (props.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr"> 56: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">propsBuildResult</span> = buildProps(node, context)
<span class=
"linenr"> 57: </span>      vnodeProps = propsBuildResult.props
<span class=
"linenr"> 58: </span>      patchFlag = propsBuildResult.patchFlag
<span class=
"linenr"> 59: </span>      dynamicPropNames = propsBuildResult.dynamicPropNames
<span class="linenr"> 60: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">directives</span> = propsBuildResult.directives
<span class="linenr"> 61: </span>      vnodeDirectives =
<span class=
"linenr"> 62: </span>        directives &amp;& directives.length
<span class=
"linenr"> 63: </span>          ? (createArrayExpression(
<span class=
"linenr"> 64: </span>              directives.map(dir =&gt; buildDirectiveArgs(dir, context))
<span class="linenr"> 65: </span>            ))
<span class="linenr"> 66: </span>          : <span class=
"org-constant">undefined</span>
<span class="linenr"> 67: </span>
<span class="linenr"> 68: </span>      <span class=
"org-keyword">if</span> (propsBuildResult.shouldUseBlock) {
<span class=
"linenr"> 69: </span>        shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr"> 70: </span>      }
<span class="linenr"> 71: </span>    }
<span class="linenr"> 72: </span>
<span class="linenr"> 73: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">children</span>
<span class="linenr"> 74: </span>    <span class=
"org-keyword">if</span> (node.children.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr"> 75: </span>      <span class=
"org-keyword">if</span> (vnodeTag === KEEP_ALIVE) {
<span class="linenr"> 76: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Although a built-in component, we compile KeepAlive with raw children</span>
<span class="linenr"> 77: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">instead of slot functions so that it can be used inside Transition</span>
<span class="linenr"> 78: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">or other Transition-wrapping HOCs.</span>
<span class="linenr"> 79: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">To ensure correct updates with block optimizations, we need to:</span>
<span class="linenr"> 80: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Force keep-alive into a block. This avoids its children being</span>
<span class="linenr"> 81: </span>        <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">collected by a parent block.</span>
<span class=
"linenr"> 82: </span>        shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr"> 83: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. Force keep-alive to always be updated, since it uses raw children.</span>
<span class=
"linenr"> 84: </span>        patchFlag |= PatchFlags.DYNAMIC_SLOTS
<span class="linenr"> 85: </span>      }
<span class="linenr"> 86: </span>
<span class="linenr"> 87: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">shouldBuildAsSlots</span> =
<span class="linenr"> 88: </span>        isComponent &amp;&
<span class="linenr"> 89: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Teleport is not a real component and has dedicated runtime handling</span>
<span class=
"linenr"> 90: </span>        vnodeTag !== TELEPORT &amp;&
<span class="linenr"> 91: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">explained above.</span>
<span class="linenr"> 92: </span>        vnodeTag !== KEEP_ALIVE
<span class="linenr"> 93: </span>
<span class="linenr"> 94: </span>      <span class=
"org-keyword">if</span> (shouldBuildAsSlots) {
<span class="linenr"> 95: </span>        <span class=
"org-keyword">const</span> { slots, hasDynamicSlots } = buildSlots(node, context)
<span class="linenr"> 96: </span>        vnodeChildren = slots
<span class="linenr"> 97: </span>        <span class=
"org-keyword">if</span> (hasDynamicSlots) {
<span class=
"linenr"> 98: </span>          patchFlag |= PatchFlags.DYNAMIC_SLOTS
<span class="linenr"> 99: </span>        }
<span class="linenr">100: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;& vnodeTag !== TELEPORT) {
<span class="linenr">101: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = node.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">102: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">type</span> = child.type
<span class="linenr">103: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check for dynamic text children</span>
<span class="linenr">104: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasDynamicTextChild</span> =
<span class=
"linenr">105: </span>          type === NodeTypes.INTERPOLATION ||
<span class=
"linenr">106: </span>          type === NodeTypes.COMPOUND_EXPRESSION
<span class="linenr">107: </span>        <span class=
"org-keyword">if</span> (
<span class=
"linenr">108: </span>          hasDynamicTextChild &amp;&
<span class=
"linenr">109: </span>          getConstantType(child, context) === ConstantTypes.NOT_CONSTANT
<span class="linenr">110: </span>        ) {
<span class=
"linenr">111: </span>          patchFlag |= PatchFlags.TEXT
<span class="linenr">112: </span>        }
<span class="linenr">113: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">pass directly if the only child is a text node</span>
<span class="linenr">114: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(plain / interpolation / expression)</span>
<span class="linenr">115: </span>        <span class=
"org-keyword">if</span> (hasDynamicTextChild || type === NodeTypes.TEXT) {
<span class="linenr">116: </span>          vnodeChildren = child
<span class="linenr">117: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">118: </span>          vnodeChildren = node.children
<span class="linenr">119: </span>        }
<span class="linenr">120: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">121: </span>        vnodeChildren = node.children
<span class="linenr">122: </span>      }
<span class="linenr">123: </span>    }
<span class="linenr">124: </span>
<span class="linenr">125: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag & dynamicPropNames</span>
<span class="linenr">126: </span>    <span class=
"org-keyword">if</span> (patchFlag !== <span class=
"org-highlight-numbers-number">0</span>) {
<span class=
"linenr">127: </span>      vnodePatchFlag = String(patchFlag)
<span class="linenr">128: </span>      <span class=
"org-keyword">if</span> (dynamicPropNames &amp;& dynamicPropNames.length) {
<span class=
"linenr">129: </span>        vnodeDynamicProps = stringifyDynamicPropNames(dynamicPropNames)
<span class="linenr">130: </span>      }
<span class="linenr">131: </span>    }
<span class="linenr">132: </span>
<span class=
"linenr">133: </span>    node.codegenNode = createVNodeCall(
<span class="linenr">134: </span>      context,
<span class="linenr">135: </span>      vnodeTag,
<span class="linenr">136: </span>      vnodeProps,
<span class="linenr">137: </span>      vnodeChildren,
<span class="linenr">138: </span>      vnodePatchFlag,
<span class="linenr">139: </span>      vnodeDynamicProps,
<span class="linenr">140: </span>      vnodeDirectives,
<span class="linenr">141: </span>      !!shouldUseBlock,
<span class="linenr">142: </span>      <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">disableTracking</span><span class=
"org-comment-delimiter"> */</span>,
<span class="linenr">143: </span>      isComponent,
<span class="linenr">144: </span>      node.loc
<span class="linenr">145: </span>    )
<span class="linenr">146: </span>  }
<span class="linenr">147: </span>}
<span class="linenr">148: </span>
<span class="linenr">149: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">resolveComponentType</span>(
<span class="linenr">150: </span>  <span class=
"org-variable-name">node</span>,
<span class="linenr">151: </span>  <span class=
"org-variable-name">context</span>,
<span class="linenr">152: </span>  ssr = <span class=
"org-constant">false</span>
<span class="linenr">153: </span>) {
<span class="linenr">154: </span>  <span class=
"org-keyword">let</span> { tag } = node
<span class="linenr">155: </span>
<span class="linenr">156: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. dynamic component</span>
<span class="linenr">157: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isExplicitDynamic</span> = isComponentTag(tag)
<span class="linenr">158: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isProp</span> = findProp(node, <span class=
"org-string">'is'</span>)
<span class="linenr">159: </span>  <span class=
"org-keyword">if</span> (isProp) {
<span class="linenr">160: </span>    <span class=
"org-keyword">if</span> (isExplicitDynamic ) {
<span class="linenr">161: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> =
<span class=
"linenr">162: </span>        isProp.type === NodeTypes.ATTRIBUTE
<span class=
"linenr">163: </span>          ? isProp.value &amp;& createSimpleExpression(isProp.value.content, <span class="org-constant">true</span>)
<span class="linenr">164: </span>          : isProp.exp
<span class="linenr">165: </span>      <span class=
"org-keyword">if</span> (exp) {
<span class="linenr">166: </span>        <span class=
"org-keyword">return</span> createCallExpression(context.helper(RESOLVE_DYNAMIC_COMPONENT), [
<span class="linenr">167: </span>          exp
<span class="linenr">168: </span>        ])
<span class="linenr">169: </span>      }
<span class="linenr">170: </span>    } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class=
"linenr">171: </span>      isProp.type === NodeTypes.ATTRIBUTE &amp;&
<span class=
"linenr">172: </span>      isProp.value.content.startsWith(<span class="org-string">'vue:'</span>)
<span class="linenr">173: </span>    ) {
<span class="linenr">174: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;button is="vue:xxx"&gt;</span>
<span class="linenr">175: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if not &lt;component&gt;, only is value that starts with "vue:" will be</span>
<span class="linenr">176: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">treated as component by the parse phase and reach here, unless it's</span>
<span class="linenr">177: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">compat mode where all is values are considered components</span>
<span class=
"linenr">178: </span>      tag = isProp.value.content.slice(<span class="org-highlight-numbers-number">4</span>)
<span class="linenr">179: </span>    }
<span class="linenr">180: </span>  }
<span class="linenr">181: </span>
<span class="linenr">182: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1.5 v-is (</span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO:</span></span></span><span class=
"org-comment"> Deprecate)</span>
<span class="linenr">183: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDir</span> = !isExplicitDynamic &amp;& findDir(node, <span class="org-string">'is'</span>)
<span class="linenr">184: </span>  <span class=
"org-keyword">if</span> (isDir &amp;& isDir.exp) {
<span class="linenr">185: </span>    <span class=
"org-keyword">return</span> createCallExpression(context.helper(RESOLVE_DYNAMIC_COMPONENT), [
<span class="linenr">186: </span>      isDir.exp
<span class="linenr">187: </span>    ])
<span class="linenr">188: </span>  }
<span class="linenr">189: </span>
<span class="linenr">190: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. built-in components (Teleport, Transition, KeepAlive, Suspense...)</span>
<span class="linenr">191: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">builtIn</span> = isCoreComponent(tag) || context.isBuiltInComponent(tag)
<span class="linenr">192: </span>  <span class=
"org-keyword">if</span> (builtIn) {
<span class="linenr">193: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">built-ins are simply fallthroughs / have special handling during ssr</span>
<span class="linenr">194: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so we don't need to import their runtime equivalents</span>
<span class="linenr">195: </span>    <span class=
"org-keyword">if</span> (!ssr) context.helper(builtIn)
<span class="linenr">196: </span>    <span class=
"org-keyword">return</span> builtIn
<span class="linenr">197: </span>  }
<span class="linenr">198: </span>
<span class="linenr">199: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. user component (from setup bindings)</span>
<span class="linenr">200: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this is skipped in browser build since browser builds do not perform</span>
<span class="linenr">201: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">binding analysis.</span>
<span class="linenr">202: </span>  <span class=
"org-keyword">if</span> (!__BROWSER__) {
<span class="linenr">203: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromSetup</span> = resolveSetupReference(tag, context)
<span class="linenr">204: </span>    <span class=
"org-keyword">if</span> (fromSetup) {
<span class="linenr">205: </span>      <span class=
"org-keyword">return</span> fromSetup
<span class="linenr">206: </span>    }
<span class="linenr">207: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dotIndex</span> = tag.indexOf(<span class=
"org-string">'.'</span>)
<span class="linenr">208: </span>    <span class=
"org-keyword">if</span> (dotIndex &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">209: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = resolveSetupReference(tag.slice(<span class="org-highlight-numbers-number">0</span>, dotIndex), context)
<span class="linenr">210: </span>      <span class=
"org-keyword">if</span> (ns) {
<span class="linenr">211: </span>        <span class=
"org-keyword">return</span> ns + tag.slice(dotIndex)
<span class="linenr">212: </span>      }
<span class="linenr">213: </span>    }
<span class="linenr">214: </span>  }
<span class="linenr">215: </span>
<span class="linenr">216: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">4. Self referencing component (inferred from filename)</span>
<span class="linenr">217: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr">218: </span>    !__BROWSER__ &amp;&
<span class="linenr">219: </span>    context.selfName &amp;&
<span class=
"linenr">220: </span>    capitalize(camelize(tag)) === context.selfName
<span class="linenr">221: </span>  ) {
<span class=
"linenr">222: </span>    context.helper(RESOLVE_COMPONENT)
<span class="linenr">223: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">codegen.ts has special check for __self postfix when generating</span>
<span class="linenr">224: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">component imports, which will pass additional `maybeSelfReference` flag</span>
<span class="linenr">225: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to `resolveComponent`.</span>
<span class=
"linenr">226: </span>    context.components.add(tag + <span class=
"org-string">`__self`</span>)
<span class="linenr">227: </span>    <span class=
"org-keyword">return</span> toValidAssetId(tag, <span class=
"org-string">`component`</span>)
<span class="linenr">228: </span>  }
<span class="linenr">229: </span>
<span class="linenr">230: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">5. user component (resolve)</span>
<span class=
"linenr">231: </span>  context.helper(RESOLVE_COMPONENT)
<span class="linenr">232: </span>  context.components.add(tag)
<span class="linenr">233: </span>  <span class=
"org-keyword">return</span> toValidAssetId(tag, <span class=
"org-string">`component`</span>)
<span class="linenr">234: </span>}
<span class="linenr">235: </span>
<span class="linenr">236: </span>
<span class="linenr">237: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">resolveSetupReference</span>(<span class=
"org-variable-name">name</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">238: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bindings</span> = context.bindingMetadata
<span class="linenr">239: </span>  <span class=
"org-keyword">if</span> (!bindings || bindings.__isScriptSetup === <span class="org-constant">false</span>) {
<span class="linenr">240: </span>    <span class=
"org-keyword">return</span>
<span class="linenr">241: </span>  }
<span class="linenr">242: </span>
<span class="linenr">243: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">camelName</span> = camelize(name)
<span class="linenr">244: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">PascalName</span> = capitalize(camelName)
<span class="linenr">245: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">checkType</span> = (type) =&gt; {
<span class="linenr">246: </span>    <span class=
"org-keyword">if</span> (bindings[name] === type) {
<span class="linenr">247: </span>      <span class=
"org-keyword">return</span> name
<span class="linenr">248: </span>    }
<span class="linenr">249: </span>    <span class=
"org-keyword">if</span> (bindings[camelName] === type) {
<span class="linenr">250: </span>      <span class=
"org-keyword">return</span> camelName
<span class="linenr">251: </span>    }
<span class="linenr">252: </span>    <span class=
"org-keyword">if</span> (bindings[PascalName] === type) {
<span class="linenr">253: </span>      <span class=
"org-keyword">return</span> PascalName
<span class="linenr">254: </span>    }
<span class="linenr">255: </span>  }
<span class="linenr">256: </span>
<span class="linenr">257: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromConst</span> = checkType(BindingTypes.SETUP_CONST)
<span class="linenr">258: </span>  <span class=
"org-keyword">if</span> (fromConst) {
<span class="linenr">259: </span>    <span class=
"org-keyword">return</span> context.inline
<span class="linenr">260: </span>      ? <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in inline mode, const setup bindings (e.g. imports) can be used as-is</span>
<span class="linenr">261: </span>        fromConst
<span class="linenr">262: </span>      : <span class=
"org-string">`$setup[${JSON.stringify(fromConst)}]`</span>
<span class="linenr">263: </span>  }
<span class="linenr">264: </span>
<span class="linenr">265: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromMaybeRef</span> =
<span class=
"linenr">266: </span>    checkType(BindingTypes.SETUP_LET) ||
<span class=
"linenr">267: </span>    checkType(BindingTypes.SETUP_REF) ||
<span class=
"linenr">268: </span>    checkType(BindingTypes.SETUP_MAYBE_REF)
<span class="linenr">269: </span>  <span class=
"org-keyword">if</span> (fromMaybeRef) {
<span class="linenr">270: </span>    <span class=
"org-keyword">return</span> context.inline
<span class="linenr">271: </span>      ? <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">setup scope bindings that may be refs need to be unrefed</span>
<span class="linenr">272: </span>        <span class=
"org-string">`${context.helperString(UNREF)}(${fromMaybeRef})`</span>
<span class="linenr">273: </span>      : <span class=
"org-string">`$setup[${JSON.stringify(fromMaybeRef)}]`</span>
<span class="linenr">274: </span>  }
<span class="linenr">275: </span>}
<span class="linenr">276: </span>
<span class="linenr">277: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">buildProps</span>(
<span class="linenr">278: </span>  <span class=
"org-variable-name">node</span>,
<span class="linenr">279: </span>  <span class=
"org-variable-name">context</span>,
<span class="linenr">280: </span>  props = node.props,
<span class="linenr">281: </span>  ssr = <span class=
"org-constant">false</span>
<span class="linenr">282: </span>) {
<span class="linenr">283: </span>  <span class=
"org-keyword">const</span> { tag, loc: elementLoc, children } = node
<span class="linenr">284: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isComponent</span> = node.tagType === ElementTypes.COMPONENT
<span class="linenr">285: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">properties</span> = []
<span class="linenr">286: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">mergeArgs</span> = []
<span class="linenr">287: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">runtimeDirectives</span> = []
<span class="linenr">288: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasChildren</span> = children.length &gt; <span class="org-highlight-numbers-number">0</span>
<span class="linenr">289: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">shouldUseBlock</span> = <span class=
"org-constant">false</span>
<span class="linenr">290: </span>
<span class="linenr">291: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag analysis</span>
<span class="linenr">292: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">293: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasRef</span> = <span class=
"org-constant">false</span>
<span class="linenr">294: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasClassBinding</span> = <span class=
"org-constant">false</span>
<span class="linenr">295: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasStyleBinding</span> = <span class=
"org-constant">false</span>
<span class="linenr">296: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasHydrationEventBinding</span> = <span class=
"org-constant">false</span>
<span class="linenr">297: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasDynamicKeys</span> = <span class=
"org-constant">false</span>
<span class="linenr">298: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasVnodeHook</span> = <span class=
"org-constant">false</span>
<span class="linenr">299: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dynamicPropNames</span> = []
<span class="linenr">300: </span>
<span class="linenr">301: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">analyzePatchFlag</span> = ({ key, value }) =&gt; {
<span class="linenr">302: </span>    <span class=
"org-keyword">if</span> (isStaticExp(key)) {
<span class="linenr">303: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> = key.content
<span class="linenr">304: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isEventHandler</span> = isOn(name)
<span class="linenr">305: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">306: </span>        !isComponent &amp;&
<span class="linenr">307: </span>        isEventHandler &amp;&
<span class="linenr">308: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">omit the flag for click handlers because hydration gives click</span>
<span class="linenr">309: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dedicated fast path.</span>
<span class=
"linenr">310: </span>        name.toLowerCase() !== <span class=
"org-string">'onclick'</span> &amp;&
<span class="linenr">311: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">omit v-model handlers</span>
<span class="linenr">312: </span>        name !== <span class=
"org-string">'onUpdate:modelValue'</span> &amp;&
<span class="linenr">313: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">omit onVnodeXXX hooks</span>
<span class="linenr">314: </span>        !isReservedProp(name)
<span class="linenr">315: </span>      ) {
<span class=
"linenr">316: </span>        hasHydrationEventBinding = <span class="org-constant">true</span>
<span class="linenr">317: </span>      }
<span class="linenr">318: </span>
<span class="linenr">319: </span>      <span class=
"org-keyword">if</span> (isEventHandler &amp;& isReservedProp(name)) {
<span class=
"linenr">320: </span>        hasVnodeHook = <span class="org-constant">true</span>
<span class="linenr">321: </span>      }
<span class="linenr">322: </span>
<span class="linenr">323: </span>      <span class=
"org-keyword">if</span> (
<span class=
"linenr">324: </span>        value.type === NodeTypes.JS_CACHE_EXPRESSION ||
<span class=
"linenr">325: </span>        ((value.type === NodeTypes.SIMPLE_EXPRESSION ||
<span class=
"linenr">326: </span>          value.type === NodeTypes.COMPOUND_EXPRESSION) &amp;&
<span class=
"linenr">327: </span>          getConstantType(value, context) &gt; <span class="org-highlight-numbers-number">0</span>)
<span class="linenr">328: </span>      ) {
<span class="linenr">329: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip if the prop is a cached handler or has constant value</span>
<span class="linenr">330: </span>        <span class=
"org-keyword">return</span>
<span class="linenr">331: </span>      }
<span class="linenr">332: </span>
<span class="linenr">333: </span>      <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'ref'</span>) {
<span class="linenr">334: </span>        hasRef = <span class=
"org-constant">true</span>
<span class="linenr">335: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'class'</span>) {
<span class=
"linenr">336: </span>        hasClassBinding = <span class=
"org-constant">true</span>
<span class="linenr">337: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'style'</span>) {
<span class=
"linenr">338: </span>        hasStyleBinding = <span class=
"org-constant">true</span>
<span class="linenr">339: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (name !== <span class=
"org-string">'key'</span> &amp;& !dynamicPropNames.includes(name)) {
<span class=
"linenr">340: </span>        dynamicPropNames.push(name)
<span class="linenr">341: </span>      }
<span class="linenr">342: </span>
<span class="linenr">343: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">treat the dynamic class and style binding of the component as dynamic props</span>
<span class="linenr">344: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">345: </span>        isComponent &amp;&
<span class="linenr">346: </span>        (name === <span class=
"org-string">'class'</span> || name === <span class=
"org-string">'style'</span>) &amp;&
<span class=
"linenr">347: </span>        !dynamicPropNames.includes(name)
<span class="linenr">348: </span>      ) {
<span class=
"linenr">349: </span>        dynamicPropNames.push(name)
<span class="linenr">350: </span>      }
<span class="linenr">351: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">352: </span>      hasDynamicKeys = <span class="org-constant">true</span>
<span class="linenr">353: </span>    }
<span class="linenr">354: </span>  }
<span class="linenr">355: </span>
<span class="linenr">356: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; props.length; i++) {
<span class="linenr">357: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">static attribute</span>
<span class="linenr">358: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prop</span> = props[i]
<span class="linenr">359: </span>    <span class=
"org-keyword">if</span> (prop.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">360: </span>      <span class=
"org-keyword">const</span> { loc, name, value } = prop
<span class="linenr">361: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isStatic</span> = <span class=
"org-constant">true</span>
<span class="linenr">362: </span>      <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'ref'</span>) {
<span class="linenr">363: </span>        hasRef = <span class=
"org-constant">true</span>
<span class="linenr">364: </span>        <span class=
"org-keyword">if</span> (context.scopes.vFor &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">365: </span>          properties.push(
<span class="linenr">366: </span>            createObjectProperty(
<span class=
"linenr">367: </span>              createSimpleExpression(<span class="org-string">'ref_for'</span>, <span class="org-constant">true</span>),
<span class=
"linenr">368: </span>              createSimpleExpression(<span class="org-string">'true'</span>)
<span class="linenr">369: </span>            )
<span class="linenr">370: </span>          )
<span class="linenr">371: </span>        }
<span class="linenr">372: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in inline mode there is no setupState object, so we can't use string</span>
<span class="linenr">373: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">keys to set the ref. Instead, we need to transform it to pass the</span>
<span class="linenr">374: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">actual ref instead.</span>
<span class="linenr">375: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">376: </span>          !__BROWSER__ &amp;&
<span class="linenr">377: </span>          value &amp;&
<span class="linenr">378: </span>          context.inline &amp;&
<span class=
"linenr">379: </span>          context.bindingMetadata[value.content]
<span class="linenr">380: </span>        ) {
<span class="linenr">381: </span>          isStatic = <span class=
"org-constant">false</span>
<span class="linenr">382: </span>          properties.push(
<span class="linenr">383: </span>            createObjectProperty(
<span class=
"linenr">384: </span>              createSimpleExpression(<span class="org-string">'ref_key'</span>, <span class="org-constant">true</span>),
<span class=
"linenr">385: </span>              createSimpleExpression(value.content, <span class="org-constant">true</span>, value.loc)
<span class="linenr">386: </span>            )
<span class="linenr">387: </span>          )
<span class="linenr">388: </span>        }
<span class="linenr">389: </span>      }
<span class="linenr">390: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip is on &lt;component&gt;, or is="vue:xxx"</span>
<span class="linenr">391: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">392: </span>        name === <span class=
"org-string">'is'</span> &amp;&
<span class="linenr">393: </span>        (isComponentTag(tag) ||
<span class=
"linenr">394: </span>          (value &amp;& value.content.startsWith(<span class="org-string">'vue:'</span>)))
<span class="linenr">395: </span>      ) {
<span class="linenr">396: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">397: </span>      }
<span class="linenr">398: </span>      properties.push(
<span class="linenr">399: </span>        createObjectProperty(
<span class="linenr">400: </span>          createSimpleExpression(
<span class="linenr">401: </span>            name,
<span class="linenr">402: </span>            <span class=
"org-constant">true</span>,
<span class=
"linenr">403: </span>            getInnerRange(loc, <span class=
"org-highlight-numbers-number">0</span>, name.length)
<span class="linenr">404: </span>          ),
<span class="linenr">405: </span>          createSimpleExpression(
<span class=
"linenr">406: </span>            value ? value.content : <span class="org-string">''</span>,
<span class="linenr">407: </span>            isStatic,
<span class=
"linenr">408: </span>            value ? value.loc : loc
<span class="linenr">409: </span>          )
<span class="linenr">410: </span>        )
<span class="linenr">411: </span>      )
<span class="linenr">412: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">413: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">directives</span>
<span class="linenr">414: </span>      <span class=
"org-keyword">const</span> { name, arg, exp, loc } = prop
<span class="linenr">415: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isVBind</span> = name === <span class=
"org-string">'bind'</span>
<span class="linenr">416: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isVOn</span> = name === <span class=
"org-string">'on'</span>
<span class="linenr">417: </span>
<span class="linenr">418: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-slot - it is handled by its dedicated transform.</span>
<span class="linenr">419: </span>      <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'slot'</span>) {
<span class="linenr">420: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">421: </span>      }
<span class="linenr">422: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-once/v-memo - they are handled by dedicated transforms.</span>
<span class="linenr">423: </span>      <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'once'</span> || name === <span class=
"org-string">'memo'</span>) {
<span class="linenr">424: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">425: </span>      }
<span class="linenr">426: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-is and :is on &lt;component&gt;</span>
<span class="linenr">427: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">428: </span>        name === <span class=
"org-string">'is'</span> ||
<span class="linenr">429: </span>        (isVBind &amp;&
<span class=
"linenr">430: </span>          isStaticArgOf(arg, <span class=
"org-string">'is'</span>) &amp;&
<span class="linenr">431: </span>          isComponentTag(tag))
<span class="linenr">432: </span>      ) {
<span class="linenr">433: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">434: </span>      }
<span class="linenr">435: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-on in SSR compilation</span>
<span class="linenr">436: </span>      <span class=
"org-keyword">if</span> (isVOn &amp;& ssr) {
<span class="linenr">437: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">438: </span>      }
<span class="linenr">439: </span>
<span class="linenr">440: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">441: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#938: elements with dynamic keys should be forced into blocks</span>
<span class=
"linenr">442: </span>        (isVBind &amp;& isStaticArgOf(arg, <span class="org-string">'key'</span>)) ||
<span class="linenr">443: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inline before-update hooks need to force block so that it is invoked</span>
<span class="linenr">444: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">before children</span>
<span class=
"linenr">445: </span>        (isVOn &amp;& hasChildren &amp;& isStaticArgOf(arg, <span class="org-string">'vue:before-update'</span>))
<span class="linenr">446: </span>      ) {
<span class=
"linenr">447: </span>        shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr">448: </span>      }
<span class="linenr">449: </span>
<span class="linenr">450: </span>      <span class=
"org-keyword">if</span> (isVBind &amp;& isStaticArgOf(arg, <span class="org-string">'ref'</span>) &amp;& context.scopes.vFor &gt; <span class="org-highlight-numbers-number">0</span>) {
<span class="linenr">451: </span>        properties.push(
<span class="linenr">452: </span>          createObjectProperty(
<span class=
"linenr">453: </span>            createSimpleExpression(<span class="org-string">'ref_for'</span>, <span class="org-constant">true</span>),
<span class=
"linenr">454: </span>            createSimpleExpression(<span class="org-string">'true'</span>)
<span class="linenr">455: </span>          )
<span class="linenr">456: </span>        )
<span class="linenr">457: </span>      }
<span class="linenr">458: </span>
<span class="linenr">459: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">special case for v-bind and v-on with no argument</span>
<span class="linenr">460: </span>      <span class=
"org-keyword">if</span> (!arg &amp;& (isVBind || isVOn)) {
<span class=
"linenr">461: </span>        hasDynamicKeys = <span class=
"org-constant">true</span>
<span class="linenr">462: </span>        <span class=
"org-keyword">if</span> (exp) {
<span class="linenr">463: </span>          <span class=
"org-keyword">if</span> (properties.length) {
<span class="linenr">464: </span>            mergeArgs.push(
<span class=
"linenr">465: </span>              createObjectExpression(dedupeProperties(properties), elementLoc)
<span class="linenr">466: </span>            )
<span class="linenr">467: </span>            properties = []
<span class="linenr">468: </span>          }
<span class="linenr">469: </span>          <span class=
"org-keyword">if</span> (isVBind) {
<span class="linenr">470: </span>            mergeArgs.push(exp)
<span class="linenr">471: </span>          } <span class=
"org-keyword">else</span> {
<span class="linenr">472: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on="obj" -&gt; toHandlers(obj)</span>
<span class="linenr">473: </span>            mergeArgs.push({
<span class=
"linenr">474: </span>              type: NodeTypes.JS_CALL_EXPRESSION,
<span class="linenr">475: </span>              loc,
<span class=
"linenr">476: </span>              callee: context.helper(TO_HANDLERS),
<span class="linenr">477: </span>              <span class=
"org-constant">arguments</span>: [exp]
<span class="linenr">478: </span>            })
<span class="linenr">479: </span>          }
<span class="linenr">480: </span>        }
<span class="linenr">481: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">482: </span>      }
<span class="linenr">483: </span>
<span class="linenr">484: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">directiveTransform</span> = context.directiveTransforms[name]
<span class="linenr">485: </span>      <span class=
"org-keyword">if</span> (directiveTransform) {
<span class="linenr">486: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">has built-in directive transform.</span>
<span class="linenr">487: </span>        <span class=
"org-keyword">const</span> { props, needRuntime } = directiveTransform(prop, node, context)
<span class=
"linenr">488: </span>        !ssr &amp;& props.forEach(analyzePatchFlag)
<span class="linenr">489: </span>        properties.push(...props)
<span class="linenr">490: </span>        <span class=
"org-keyword">if</span> (needRuntime) {
<span class=
"linenr">491: </span>          runtimeDirectives.push(prop)
<span class="linenr">492: </span>          <span class=
"org-keyword">if</span> (isSymbol(needRuntime)) {
<span class=
"linenr">493: </span>            directiveImportMap.set(prop, needRuntime)
<span class="linenr">494: </span>          }
<span class="linenr">495: </span>        }
<span class="linenr">496: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!isBuiltInDirective(name)) {
<span class="linenr">497: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no built-in transform, this is a user custom directive.</span>
<span class=
"linenr">498: </span>        runtimeDirectives.push(prop)
<span class="linenr">499: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">custom dirs may use beforeUpdate so they need to force blocks</span>
<span class="linenr">500: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to ensure before-update gets called before children update</span>
<span class="linenr">501: </span>        <span class=
"org-keyword">if</span> (hasChildren) {
<span class=
"linenr">502: </span>          shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr">503: </span>        }
<span class="linenr">504: </span>      }
<span class="linenr">505: </span>    }
<span class="linenr">506: </span>  }
<span class="linenr">507: </span>
<span class="linenr">508: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">propsExpression</span> = <span class=
"org-constant">undefined</span>
<span class="linenr">509: </span>
<span class="linenr">510: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">has v-bind="object" or v-on="object", wrap with mergeProps</span>
<span class="linenr">511: </span>  <span class=
"org-keyword">if</span> (mergeArgs.length) {
<span class="linenr">512: </span>    <span class=
"org-keyword">if</span> (properties.length) {
<span class="linenr">513: </span>      mergeArgs.push(
<span class=
"linenr">514: </span>        createObjectExpression(dedupeProperties(properties), elementLoc)
<span class="linenr">515: </span>      )
<span class="linenr">516: </span>    }
<span class="linenr">517: </span>    <span class=
"org-keyword">if</span> (mergeArgs.length &gt; <span class=
"org-highlight-numbers-number">1</span>) {
<span class=
"linenr">518: </span>      propsExpression = createCallExpression(
<span class=
"linenr">519: </span>        context.helper(MERGE_PROPS),
<span class="linenr">520: </span>        mergeArgs,
<span class="linenr">521: </span>        elementLoc
<span class="linenr">522: </span>      )
<span class="linenr">523: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">524: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single v-bind with nothing else - no need for a mergeProps call</span>
<span class=
"linenr">525: </span>      propsExpression = mergeArgs[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">526: </span>    }
<span class="linenr">527: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (properties.length) {
<span class=
"linenr">528: </span>    propsExpression = createObjectExpression(
<span class=
"linenr">529: </span>      dedupeProperties(properties),
<span class="linenr">530: </span>      elementLoc
<span class="linenr">531: </span>    )
<span class="linenr">532: </span>  }
<span class="linenr">533: </span>
<span class="linenr">534: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag analysis</span>
<span class="linenr">535: </span>  <span class=
"org-keyword">if</span> (hasDynamicKeys) {
<span class=
"linenr">536: </span>    patchFlag |= PatchFlags.FULL_PROPS
<span class="linenr">537: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">538: </span>    <span class=
"org-keyword">if</span> (hasClassBinding &amp;& !isComponent) {
<span class=
"linenr">539: </span>      patchFlag |= PatchFlags.CLASS
<span class="linenr">540: </span>    }
<span class="linenr">541: </span>    <span class=
"org-keyword">if</span> (hasStyleBinding &amp;& !isComponent) {
<span class=
"linenr">542: </span>      patchFlag |= PatchFlags.STYLE
<span class="linenr">543: </span>    }
<span class="linenr">544: </span>    <span class=
"org-keyword">if</span> (dynamicPropNames.length) {
<span class=
"linenr">545: </span>      patchFlag |= PatchFlags.PROPS
<span class="linenr">546: </span>    }
<span class="linenr">547: </span>    <span class=
"org-keyword">if</span> (hasHydrationEventBinding) {
<span class=
"linenr">548: </span>      patchFlag |= PatchFlags.HYDRATE_EVENTS
<span class="linenr">549: </span>    }
<span class="linenr">550: </span>  }
<span class="linenr">551: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr">552: </span>    !shouldUseBlock &amp;&
<span class="linenr">553: </span>    (patchFlag === <span class=
"org-highlight-numbers-number">0</span> || patchFlag === PatchFlags.HYDRATE_EVENTS) &amp;&
<span class=
"linenr">554: </span>    (hasRef || hasVnodeHook || runtimeDirectives.length &gt; <span class="org-highlight-numbers-number">0</span>)
<span class="linenr">555: </span>  ) {
<span class=
"linenr">556: </span>    patchFlag |= PatchFlags.NEED_PATCH
<span class="linenr">557: </span>  }
<span class="linenr">558: </span>
<span class="linenr">559: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">pre-normalize props, SSR is skipped for now</span>
<span class="linenr">560: </span>  <span class=
"org-keyword">if</span> (!context.inSSR &amp;& propsExpression) {
<span class="linenr">561: </span>    <span class=
"org-keyword">switch</span> (propsExpression.type) {
<span class="linenr">562: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_OBJECT_EXPRESSION:
<span class="linenr">563: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">means that there is no v-bind,</span>
<span class="linenr">564: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">but still need to deal with dynamic key binding</span>
<span class="linenr">565: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">classKeyIndex</span> = -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">566: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">styleKeyIndex</span> = -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">567: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasDynamicKey</span> = <span class=
"org-constant">false</span>
<span class="linenr">568: </span>
<span class="linenr">569: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; propsExpression.properties.length; i++) {
<span class="linenr">570: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> = propsExpression.properties[i].key
<span class="linenr">571: </span>          <span class=
"org-keyword">if</span> (isStaticExp(key)) {
<span class="linenr">572: </span>            <span class=
"org-keyword">if</span> (key.content === <span class=
"org-string">'class'</span>) {
<span class="linenr">573: </span>              classKeyIndex = i
<span class="linenr">574: </span>            } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (key.content === <span class=
"org-string">'style'</span>) {
<span class="linenr">575: </span>              styleKeyIndex = i
<span class="linenr">576: </span>            }
<span class="linenr">577: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!key.isHandlerKey) {
<span class=
"linenr">578: </span>            hasDynamicKey = <span class=
"org-constant">true</span>
<span class="linenr">579: </span>          }
<span class="linenr">580: </span>        }
<span class="linenr">581: </span>
<span class="linenr">582: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">classProp</span> = propsExpression.properties[classKeyIndex]
<span class="linenr">583: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">styleProp</span> = propsExpression.properties[styleKeyIndex]
<span class="linenr">584: </span>
<span class="linenr">585: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no dynamic key</span>
<span class="linenr">586: </span>        <span class=
"org-keyword">if</span> (!hasDynamicKey) {
<span class="linenr">587: </span>          <span class=
"org-keyword">if</span> (classProp &amp;& !isStaticExp(classProp.value)) {
<span class=
"linenr">588: </span>            classProp.value = createCallExpression(
<span class=
"linenr">589: </span>              context.helper(NORMALIZE_CLASS),
<span class="linenr">590: </span>              [classProp.value]
<span class="linenr">591: </span>            )
<span class="linenr">592: </span>          }
<span class="linenr">593: </span>          <span class=
"org-keyword">if</span> (
<span class="linenr">594: </span>            styleProp &amp;&
<span class=
"linenr">595: </span>            !isStaticExp(styleProp.value) &amp;&
<span class="linenr">596: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the static style is compiled into an object,</span>
<span class="linenr">597: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so use `hasStyleBinding` to ensure that it is a dynamic style binding</span>
<span class="linenr">598: </span>            (hasStyleBinding ||
<span class="linenr">599: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-bind:style and style both exist,</span>
<span class="linenr">600: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-bind:style with static literal object</span>
<span class=
"linenr">601: </span>              styleProp.value.type === NodeTypes.JS_ARRAY_EXPRESSION)
<span class="linenr">602: </span>          ) {
<span class=
"linenr">603: </span>            styleProp.value = createCallExpression(
<span class=
"linenr">604: </span>              context.helper(NORMALIZE_STYLE),
<span class="linenr">605: </span>              [styleProp.value]
<span class="linenr">606: </span>            )
<span class="linenr">607: </span>          }
<span class="linenr">608: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">609: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dynamic key binding, wrap with `normalizeProps`</span>
<span class=
"linenr">610: </span>          propsExpression = createCallExpression(
<span class=
"linenr">611: </span>            context.helper(NORMALIZE_PROPS),
<span class="linenr">612: </span>            [propsExpression]
<span class="linenr">613: </span>          )
<span class="linenr">614: </span>        }
<span class="linenr">615: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">616: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_CALL_EXPRESSION:
<span class="linenr">617: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mergeProps call, do nothing</span>
<span class="linenr">618: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">619: </span>      <span class=
"org-keyword">default</span>:
<span class="linenr">620: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single v-bind</span>
<span class=
"linenr">621: </span>        propsExpression = createCallExpression(
<span class=
"linenr">622: </span>          context.helper(NORMALIZE_PROPS),
<span class="linenr">623: </span>          [
<span class=
"linenr">624: </span>            createCallExpression(context.helper(GUARD_REACTIVE_PROPS), [
<span class="linenr">625: </span>              propsExpression
<span class="linenr">626: </span>            ])
<span class="linenr">627: </span>          ]
<span class="linenr">628: </span>        )
<span class="linenr">629: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">630: </span>    }
<span class="linenr">631: </span>  }
<span class="linenr">632: </span>
<span class="linenr">633: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">634: </span>    props: propsExpression,
<span class="linenr">635: </span>    directives: runtimeDirectives,
<span class="linenr">636: </span>    patchFlag,
<span class="linenr">637: </span>    dynamicPropNames,
<span class="linenr">638: </span>    shouldUseBlock
<span class="linenr">639: </span>  }
<span class="linenr">640: </span>}
<span class="linenr">641: </span>
<span class="linenr">642: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Dedupe props in an object literal.</span>
<span class="linenr">643: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Literal duplicated attributes would have been warned during the parse phase,</span>
<span class="linenr">644: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">however, it's possible to encounter duplicated `onXXX` handlers with different</span>
<span class="linenr">645: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">modifiers. We also need to merge static and dynamic class / style attributes.</span>
<span class="linenr">646: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- onXXX handlers / style: merge into array</span>
<span class="linenr">647: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- class: merge into single expression with concatenation</span>
<span class="linenr">648: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">dedupeProperties</span>(<span class=
"org-variable-name">properties</span>) {
<span class="linenr">649: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">knownProps</span> = <span class=
"org-keyword">new</span> <span class="org-type">Map</span>()
<span class="linenr">650: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">deduped</span> = []
<span class="linenr">651: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; properties.length; i++) {
<span class="linenr">652: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prop</span> = properties[i]
<span class="linenr">653: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dynamic keys are always allowed</span>
<span class="linenr">654: </span>    <span class=
"org-keyword">if</span> (prop.key.type === NodeTypes.COMPOUND_EXPRESSION || !prop.key.isStatic) {
<span class="linenr">655: </span>      deduped.push(prop)
<span class="linenr">656: </span>      <span class=
"org-keyword">continue</span>
<span class="linenr">657: </span>    }
<span class="linenr">658: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> = prop.key.content
<span class="linenr">659: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">existing</span> = knownProps.get(name)
<span class="linenr">660: </span>    <span class=
"org-keyword">if</span> (existing) {
<span class="linenr">661: </span>      <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'style'</span> || name === <span class=
"org-string">'class'</span> || isOn(name)) {
<span class=
"linenr">662: </span>        mergeAsArray(existing, prop)
<span class="linenr">663: </span>      }
<span class="linenr">664: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">unexpected duplicate, should have emitted error during parse</span>
<span class="linenr">665: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">666: </span>      knownProps.set(name, prop)
<span class="linenr">667: </span>      deduped.push(prop)
<span class="linenr">668: </span>    }
<span class="linenr">669: </span>  }
<span class="linenr">670: </span>  <span class=
"org-keyword">return</span> deduped
<span class="linenr">671: </span>}
<span class="linenr">672: </span>
<span class="linenr">673: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">mergeAsArray</span>(<span class=
"org-variable-name">existing</span>, <span class=
"org-variable-name">incoming</span>) {
<span class="linenr">674: </span>  <span class=
"org-keyword">if</span> (existing.value.type === NodeTypes.JS_ARRAY_EXPRESSION) {
<span class=
"linenr">675: </span>    existing.value.elements.push(incoming.value)
<span class="linenr">676: </span>  } <span class=
"org-keyword">else</span> {
<span class=
"linenr">677: </span>    existing.value = createArrayExpression(
<span class=
"linenr">678: </span>      [existing.value, incoming.value],
<span class="linenr">679: </span>      existing.loc
<span class="linenr">680: </span>    )
<span class="linenr">681: </span>  }
<span class="linenr">682: </span>}
<span class="linenr">683: </span>
<span class="linenr">684: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">buildDirectiveArgs</span>(
<span class="linenr">685: </span>  <span class=
"org-variable-name">dir</span>,
<span class="linenr">686: </span>  context
<span class="linenr">687: </span>) {
<span class="linenr">688: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dirArgs</span> = []
<span class="linenr">689: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">runtime</span> = directiveImportMap.get(dir)
<span class="linenr">690: </span>  <span class=
"org-keyword">if</span> (runtime) {
<span class="linenr">691: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">built-in directive with runtime</span>
<span class=
"linenr">692: </span>    dirArgs.push(context.helperString(runtime))
<span class="linenr">693: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">694: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">user directive.</span>
<span class="linenr">695: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">see if we have directives exposed via &lt;script setup&gt;</span>
<span class="linenr">696: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromSetup</span> =
<span class=
"linenr">697: </span>      !__BROWSER__ &amp;& resolveSetupReference(<span class="org-string">'v-'</span> + dir.name, context)
<span class="linenr">698: </span>    <span class=
"org-keyword">if</span> (fromSetup) {
<span class="linenr">699: </span>      dirArgs.push(fromSetup)
<span class="linenr">700: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">701: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inject statement for resolving directive</span>
<span class=
"linenr">702: </span>      context.helper(RESOLVE_DIRECTIVE)
<span class=
"linenr">703: </span>      context.directives.add(dir.name)
<span class=
"linenr">704: </span>      dirArgs.push(toValidAssetId(dir.name, <span class="org-string">`directive`</span>))
<span class="linenr">705: </span>    }
<span class="linenr">706: </span>  }
<span class="linenr">707: </span>  <span class=
"org-keyword">const</span> { loc } = dir
<span class="linenr">708: </span>  <span class=
"org-keyword">if</span> (dir.exp) dirArgs.push(dir.exp)
<span class="linenr">709: </span>  <span class=
"org-keyword">if</span> (dir.arg) {
<span class="linenr">710: </span>    <span class=
"org-keyword">if</span> (!dir.exp) {
<span class="linenr">711: </span>      dirArgs.push(<span class=
"org-string">`void 0`</span>)
<span class="linenr">712: </span>    }
<span class="linenr">713: </span>    dirArgs.push(dir.arg)
<span class="linenr">714: </span>  }
<span class="linenr">715: </span>  <span class=
"org-keyword">if</span> (Object.keys(dir.modifiers).length) {
<span class="linenr">716: </span>    <span class=
"org-keyword">if</span> (!dir.arg) {
<span class="linenr">717: </span>      <span class=
"org-keyword">if</span> (!dir.exp) {
<span class="linenr">718: </span>        dirArgs.push(<span class=
"org-string">`void 0`</span>)
<span class="linenr">719: </span>      }
<span class="linenr">720: </span>      dirArgs.push(<span class=
"org-string">`void 0`</span>)
<span class="linenr">721: </span>    }
<span class="linenr">722: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">trueExpression</span> = createSimpleExpression(<span class="org-string">`true`</span>, <span class="org-constant">false</span>, loc)
<span class="linenr">723: </span>    dirArgs.push(
<span class="linenr">724: </span>      createObjectExpression(
<span class=
"linenr">725: </span>        dir.modifiers.map(modifier =&gt;
<span class=
"linenr">726: </span>          createObjectProperty(modifier, trueExpression)
<span class="linenr">727: </span>        ),
<span class="linenr">728: </span>        loc
<span class="linenr">729: </span>      )
<span class="linenr">730: </span>    )
<span class="linenr">731: </span>  }
<span class="linenr">732: </span>  <span class=
"org-keyword">return</span> createArrayExpression(dirArgs, dir.loc)
<span class="linenr">733: </span>}
<span class="linenr">734: </span>
<span class="linenr">735: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyDynamicPropNames</span>(<span class=
"org-variable-name">props</span>) {
<span class="linenr">736: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">propsNamesString</span> = <span class=
"org-string">`[`</span>
<span class="linenr">737: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>, <span class=
"org-variable-name">l</span> = props.length; i &lt; l; i++) {
<span class=
"linenr">738: </span>    propsNamesString += JSON.stringify(props[i])
<span class="linenr">739: </span>    <span class=
"org-keyword">if</span> (i &lt; l - <span class=
"org-highlight-numbers-number">1</span>) propsNamesString += <span class="org-string">', '</span>
<span class="linenr">740: </span>  }
<span class="linenr">741: </span>  <span class=
"org-keyword">return</span> propsNamesString + <span class=
"org-string">`]`</span>
<span class="linenr">742: </span>}
<span class="linenr">743: </span>
<span class="linenr">744: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isComponentTag</span>(<span class=
"org-variable-name">tag</span>) {
<span class="linenr">745: </span>  <span class=
"org-keyword">return</span> tag === <span class=
"org-string">'component'</span> || tag === <span class=
"org-string">'Component'</span>
<span class="linenr">746: </span>}
<span class="linenr">747: </span>
<span class="linenr">748: </span>
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org748ce73" class="outline-4">
          <h4 id="org748ce73"><span class=
          "section-number-4">3.9.8.</span>
          transformExpression()</h4>
          <div class="outline-text-4" id="text-3-9-8">
            <div class="org-src-container">
              <pre class="src src-js" id="org1e1eb77"><span class=
              "linenr">1: </span><span class=
              "org-keyword">const</span> <span class=
              "org-variable-name">isLiteralWhitelisted</span> = <span class=
              "org-comment-delimiter">/*</span><span class=
              "org-comment">#__PURE__</span><span class=
              "org-comment-delimiter">*/</span> makeMap(<span class=
              "org-string">'true,false,null,this'</span>)
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">transformExpression</span>() {}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org8efbb9e" class="outline-4">
          <h4 id="org8efbb9e"><span class=
          "section-number-4">3.9.9.</span> transformFor()</h4>
          <div class="outline-text-4" id="text-3-9-9">
            <div class="org-src-container">
              <pre class="src src-js" id="org6b61c41"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">transformFor</span>() {}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org3c30456" class="outline-4">
          <h4 id="org3c30456"><span class=
          "section-number-4">3.9.10.</span> transformOnce()</h4>
          <div class="outline-text-4" id="text-3-9-10">
            <div class="org-src-container">
              <pre class="src src-js" id="orgea3d954"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">transformOnce</span>() {}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org3961cdc" class="outline-4">
          <h4 id="org3961cdc"><span class=
          "section-number-4">3.9.11.</span> transformMemo()</h4>
          <div class="outline-text-4" id="text-3-9-11">
            <div class="org-src-container">
              <pre class="src src-js" id="orgcb11e65"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">transformMemo</span>() {}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orga621827" class="outline-4">
          <h4 id="orga621827"><span class=
          "section-number-4">3.9.12.</span> transformOn()</h4>
          <div class="outline-text-4" id="text-3-9-12">
            <p>v-on
            表达式正则(<code>/^\s*([\w$_]+|(async\s*)?\([^)]*?\))\s*=&gt;|^\s*(async\s+)?function(?:\s+[\w$]+)?\s*\(/</code>)：</p><a href="../assets/img/vue3plus/d/v-on-exp-handler-re.svg"
            data-fancybox="gallery" data-caption=
            "Preview"><img src="../assets/img/vue3plus/d/v-on-exp-handler-re.svg"></a>
            <div class="org-src-container">
              <pre class="src src-js" id="orgb6496b0"><span class=
              "linenr">  1: </span><span class=
              "org-comment-delimiter">// </span><span class=
              "org-comment">函数表达式正则, @click="fnExp"</span>
<span class="linenr">  2: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">fnExpRE</span> =
<span class="linenr">  3: </span>  <span class=
"org-string">/^\s*([\w$_]+|(async\s*)?\([^)]*?\))\s*=&gt;|^\s*(async\s+)?function(?:\s+[\w$]+)?\s*\(/</span>
<span class="linenr">  4: </span>
<span class="linenr">  5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformOn</span> = (
<span class="linenr">  6: </span>  dir,
<span class="linenr">  7: </span>  node,
<span class="linenr">  8: </span>  context,
<span class="linenr">  9: </span>  augmentor
<span class="linenr"> 10: </span>) =&gt; {
<span class="linenr"> 11: </span>  <span class=
"org-keyword">const</span> { loc, modifiers, arg } = dir
<span class="linenr"> 12: </span>
<span class="linenr"> 13: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">eventName</span>
<span class="linenr"> 14: </span>  <span class=
"org-keyword">if</span> (arg.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr"> 15: </span>    <span class=
"org-keyword">if</span> (arg.isStatic) {
<span class="linenr"> 16: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">rawName</span> = arg.content
<span class="linenr"> 17: </span>
<span class="linenr"> 18: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将事件名转成驼峰式</span>
<span class=
"linenr"> 19: </span>      eventName = createSimpleExpression(
<span class=
"linenr"> 20: </span>        toHandlerKey(camelize(rawName)),
<span class="linenr"> 21: </span>        <span class=
"org-constant">true</span>,
<span class="linenr"> 22: </span>        arg.loc
<span class="linenr"> 23: </span>      )
<span class="linenr"> 24: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 25: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#2388 toHandlerKey 将事件名转成 onXxx, 如：eventName -&gt; onEventName</span>
<span class=
"linenr"> 26: </span>      eventName = createCompoundExpression([
<span class="linenr"> 27: </span>        <span class=
"org-string">`${context.helperString(TO_HANDLER_KEY)}(`</span>,
<span class="linenr"> 28: </span>        arg,
<span class="linenr"> 29: </span>        <span class=
"org-string">`)`</span>
<span class="linenr"> 30: </span>      ])
<span class="linenr"> 31: </span>    }
<span class="linenr"> 32: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr"> 33: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">already a compound expression.</span>
<span class="linenr"> 34: </span>
<span class="linenr"> 35: </span>    eventName = arg
<span class=
"linenr"> 36: </span>    eventName.children.unshift(<span class=
"org-string">`${context.helperString(TO_HANDLER_KEY)}(`</span>)
<span class=
"linenr"> 37: </span>    eventName.children.push(<span class=
"org-string">`)`</span>)
<span class="linenr"> 38: </span>  }
<span class="linenr"> 39: </span>
<span class="linenr"> 40: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">handler processing, 事件表达式内容</span>
<span class="linenr"> 41: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">exp</span> = dir.exp
<span class="linenr"> 42: </span>  <span class=
"org-keyword">if</span> (exp &amp;& !exp.content.trim()) {
<span class="linenr"> 43: </span>    exp = <span class=
"org-constant">undefined</span>
<span class="linenr"> 44: </span>  }
<span class="linenr"> 45: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">事件处理函数缓存</span>
<span class="linenr"> 46: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">shouldCache</span> = context.cacheHandlers &amp;& !exp &amp;& !context.inVOnce
<span class="linenr"> 47: </span>  <span class=
"org-keyword">if</span> (exp) {
<span class="linenr"> 48: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isMemberExp</span> = isMemberExpression(exp.content, context)
<span class="linenr"> 49: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isInlineStatement</span> = !(isMemberExp || fnExpRE.test(exp.content))
<span class="linenr"> 50: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasMultipleStatements</span> = exp.content.includes(<span class="org-string">`;`</span>)
<span class="linenr"> 51: </span>
<span class="linenr"> 52: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">process the expression since it's been skipped</span>
<span class="linenr"> 53: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr"> 54: </span>      isInlineStatement &amp;& context.addIdentifiers(<span class="org-string">`$event`</span>)
<span class=
"linenr"> 55: </span>      exp = dir.exp = processExpression(
<span class="linenr"> 56: </span>        exp,
<span class="linenr"> 57: </span>        context,
<span class="linenr"> 58: </span>        <span class=
"org-constant">false</span>,
<span class="linenr"> 59: </span>        hasMultipleStatements
<span class="linenr"> 60: </span>      )
<span class=
"linenr"> 61: </span>      isInlineStatement &amp;& context.removeIdentifiers(<span class="org-string">`$event`</span>)
<span class="linenr"> 62: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">with scope analysis, the function is hoistable if it has no reference</span>
<span class="linenr"> 63: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to scope variables.</span>
<span class="linenr"> 64: </span>      shouldCache =
<span class=
"linenr"> 65: </span>        context.cacheHandlers &amp;&
<span class="linenr"> 66: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">unnecessary to cache inside v-once</span>
<span class="linenr"> 67: </span>        !context.inVOnce &amp;&
<span class="linenr"> 68: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">runtime constants don't need to be cached</span>
<span class="linenr"> 69: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(this is analyzed by compileScript in SFC &lt;script setup&gt;)</span>
<span class=
"linenr"> 70: </span>        !(exp.type === NodeTypes.SIMPLE_EXPRESSION &amp;& exp.constType &gt; <span class="org-highlight-numbers-number">0</span>) &amp;&
<span class="linenr"> 71: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#1541 bail if this is a member exp handler passed to a component -</span>
<span class="linenr"> 72: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we need to use the original function to preserve arity,</span>
<span class="linenr"> 73: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">e.g. &lt;transition&gt; relies on checking cb.length to determine</span>
<span class="linenr"> 74: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">transition end handling. Inline function is ok since its arity</span>
<span class="linenr"> 75: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">is preserved even when cached.</span>
<span class=
"linenr"> 76: </span>        !(isMemberExp &amp;& node.tagType === ElementTypes.COMPONENT) &amp;&
<span class="linenr"> 77: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail if the function references closure variables (v-for, v-slot)</span>
<span class="linenr"> 78: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">it must be passed fresh to avoid stale values.</span>
<span class=
"linenr"> 79: </span>        !hasScopeRef(exp, context.identifiers)
<span class="linenr"> 80: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">If the expression is optimizable and is a member expression pointing</span>
<span class="linenr"> 81: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to a function, turn it into invocation (and wrap in an arrow function</span>
<span class="linenr"> 82: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">below) so that it always accesses the latest value when called - thus</span>
<span class="linenr"> 83: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">avoiding the need to be patched.</span>
<span class="linenr"> 84: </span>      <span class=
"org-keyword">if</span> (shouldCache &amp;& isMemberExp) {
<span class="linenr"> 85: </span>        <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class=
"linenr"> 86: </span>          exp.content = <span class=
"org-string">`${exp.content} &amp;& ${exp.content}(...args)`</span>
<span class="linenr"> 87: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 88: </span>          exp.children = [...exp.children, <span class="org-string">` &amp;& `</span>, ...exp.children, <span class="org-string">`(...args)`</span>]
<span class="linenr"> 89: </span>        }
<span class="linenr"> 90: </span>      }
<span class="linenr"> 91: </span>    }
<span class="linenr"> 92: </span>
<span class="linenr"> 93: </span>    <span class=
"org-keyword">if</span> (isInlineStatement || (shouldCache &amp;& isMemberExp)) {
<span class="linenr"> 94: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">wrap inline statement in a function expression</span>
<span class="linenr"> 95: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">($event) =&gt; statement</span>
<span class="linenr"> 96: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(...args) =&gt; { statement1;statement2 }</span>
<span class=
"linenr"> 97: </span>      exp = createCompoundExpression([
<span class="linenr"> 98: </span>        <span class=
"org-string">`${</span>
<span class="linenr"> 99: </span><span class=
"org-string">          isInlineStatement</span>
<span class="linenr">100: </span><span class=
"org-string">            ? `</span>$event<span class=
"org-string">`</span>
<span class="linenr">101: </span><span class=
"org-string">            : `</span>(...args)<span class=
"org-string">`</span>
<span class="linenr">102: </span><span class=
"org-string">        } =&gt; ${hasMultipleStatements ? `</span>{<span class="org-string">` : `</span>(<span class="org-string">`}`</span>,
<span class="linenr">103: </span>        exp,
<span class=
"linenr">104: </span>        hasMultipleStatements ? <span class=
"org-string">`}`</span> : <span class="org-string">`)`</span>
<span class="linenr">105: </span>      ])
<span class="linenr">106: </span>    }
<span class="linenr">107: </span>  }
<span class="linenr">108: </span>
<span class="linenr">109: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ret</span> = {
<span class="linenr">110: </span>    props: [
<span class="linenr">111: </span>      createObjectProperty(
<span class="linenr">112: </span>        eventName,
<span class=
"linenr">113: </span>        exp || createSimpleExpression(<span class="org-string">`() =&gt; {}`</span>, <span class="org-constant">false</span>, loc)
<span class="linenr">114: </span>      )
<span class="linenr">115: </span>    ]
<span class="linenr">116: </span>  }
<span class="linenr">117: </span>
<span class="linenr">118: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">apply extended compiler augmentor</span>
<span class="linenr">119: </span>  <span class=
"org-keyword">if</span> (augmentor) {
<span class="linenr">120: </span>    ret = augmentor(ret)
<span class="linenr">121: </span>  }
<span class="linenr">122: </span>
<span class="linenr">123: </span>  <span class=
"org-keyword">if</span> (shouldCache) {
<span class="linenr">124: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">cache handlers so that it's always the same handler being passed down.</span>
<span class="linenr">125: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this avoids unnecessary re-renders when users use inline handlers on</span>
<span class="linenr">126: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">components.</span>
<span class="linenr">127: </span>    ret.props[<span class=
"org-highlight-numbers-number">0</span>].value = context.cache(ret.props[<span class="org-highlight-numbers-number">0</span>].value)
<span class="linenr">128: </span>  }
<span class="linenr">129: </span>
<span class="linenr">130: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mark the key as handler for props normalization check</span>
<span class=
"linenr">131: </span>  ret.props.forEach(p =&gt; (p.key.isHandlerKey = <span class="org-constant">true</span>))
<span class="linenr">132: </span>  <span class=
"org-keyword">return</span> ret
<span class="linenr">133: </span>}
</pre>
            </div>
            <p><span style="color:red;">Testing</span></p><br>
            <details class="code-details" style=
            "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
              <summary>
                <strong><font face="Courier" size="3" color=
                "red">Testing v-on</font></strong>
              </summary>
              <div class="org-src-container">
                <pre class="src src-js" id="org631fd70"><span class=
                "linenr">1: </span>
</pre>
              </div>
            </details>
          </div>
        </div>
        <div id="outline-container-orgcf9d93c" class="outline-4">
          <h4 id="orgcf9d93c"><span class=
          "section-number-4">3.9.13.</span> transformModel()</h4>
          <div class="outline-text-4" id="text-3-9-13">
            <div class="org-src-container">
              <pre class="src src-js" id="org66e5cf6"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">transformModel</span>() {}
</pre>
            </div>
          </div>
        </div>
      </div>
      <div id="outline-container-org424fb09" class="outline-3">
        <h3 id="org424fb09"><span class=
        "section-number-3">3.10.</span> codegenNode creators</h3>
        <div class="outline-text-3" id="text-3-10">
          <p>这一节包含了所有用到的 <code>createXxx</code> 函数，这类函数是用来创建节点的
          <code>codegenNode</code> 结构 的，每一种语法都会自己对应的创建函数，如：
          <code>v-if</code> 的分支节点就需要用到 <a href=
          "#org0f6bce1">createConditionalExpression()</a>, <a href=
          "#orga5a0481">createCallExpression()</a>。</p>
          <p>这类函数并不复杂，只是返回不同类型和内容的一个对象。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org7f5bdc8"><span class=
            "linenr"> 1: </span>&lt;&lt;createRoot&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;createVNodeCall&gt;&gt;
<span class=
"linenr"> 3: </span>&lt;&lt;createArrayExpression&gt;&gt;
<span class=
"linenr"> 4: </span>&lt;&lt;createObjectExpression&gt;&gt;
<span class=
"linenr"> 5: </span>&lt;&lt;createObjectProperty&gt;&gt;
<span class=
"linenr"> 6: </span>&lt;&lt;createSimpleExpression&gt;&gt;
<span class="linenr"> 7: </span>&lt;&lt;createInterpolation&gt;&gt;
<span class=
"linenr"> 8: </span>&lt;&lt;createCompoundExpression&gt;&gt;
<span class=
"linenr"> 9: </span>&lt;&lt;createCallExpression&gt;&gt;
<span class=
"linenr">10: </span>&lt;&lt;createFunctionExpression&gt;&gt;
<span class=
"linenr">11: </span>&lt;&lt;createConditionalExpression&gt;&gt;
<span class=
"linenr">12: </span>&lt;&lt;createCacheExpression&gt;&gt;
<span class=
"linenr">13: </span>&lt;&lt;createBlockStatement&gt;&gt;
<span class=
"linenr">14: </span>&lt;&lt;createTemplateLiteral&gt;&gt;
<span class="linenr">15: </span>&lt;&lt;createIfStatement&gt;&gt;
<span class=
"linenr">16: </span>&lt;&lt;createAssignmentExpression&gt;&gt;
<span class=
"linenr">17: </span>&lt;&lt;createSequenceExpression&gt;&gt;
<span class=
"linenr">18: </span>&lt;&lt;createReturnStatement&gt;&gt;
</pre>
          </div>
        </div>
        <div id="outline-container-org7f6cbd5" class="outline-4">
          <h4 id="org7f6cbd5"><span class=
          "section-number-4">3.10.1.</span> createRoot()</h4>
          <div class="outline-text-4" id="text-3-10-1">
            <p>返回一个根节点结构：</p>
            <div class="org-src-container">
              <pre class="src src-js" id="org58429ed"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createRoot</span>(<span class=
              "org-variable-name">children</span>, <span class=
              "org-variable-name">loc</span> = <span class=
              "org-variable-name">locStub</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr"> 3: </span>    type: NodeTypes.ROOT,
<span id="coderef-root-children" class="coderef-off"><span class=
"linenr"> 4: </span>    children,</span>
<span class="linenr"> 5: </span>    helpers: [],
<span id="coderef-root-components" class="coderef-off"><span class=
"linenr"> 6: </span>    components: [],</span>
<span id="coderef-root-directives" class="coderef-off"><span class=
"linenr"> 7: </span>    directives: [],</span>
<span id="coderef-root-hoists" class="coderef-off"><span class=
"linenr"> 8: </span>    hoists: [],</span>
<span id="coderef-root-imports" class="coderef-off"><span class=
"linenr"> 9: </span>    imports: [],</span>
<span class="linenr">10: </span>    cached: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">11: </span>    temps: <span class=
"org-highlight-numbers-number">0</span>,
<span id="coderef-root-codegenNode" class=
"coderef-off"><span class="linenr">12: </span>    codegenNode: <span class="org-constant">undefined</span>,</span>
<span class="linenr">13: </span>    loc
<span class="linenr">14: </span>  }
<span class="linenr">15: </span>}
</pre>
            </div>
            <p><a href="#coderef-root-children" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-root-children');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-root-children');">children</a>
            根节点下的子节点 AST 结构容器</p>
            <p><a href="#coderef-root-components" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-root-components');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-root-components');">components</a>
            引用的所有组件列表</p>
            <p><a href="#coderef-root-directives" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-root-directives');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-root-directives');">directives</a>
            解析后的指令结构</p>
            <p><a href="#coderef-root-hoists" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-root-hoists');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-root-hoists');">hoists</a>
            静态提升的节点，这个是不会发生变化的节点，如：纯文本节点，无 prop 无动态 children
            的节点(不会发生的变化的都会被提升到 render 函数之外)。</p>
            <p><a href="#coderef-root-imports" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-root-imports');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-root-imports');">imports</a>
            引入的一引动依赖仓库</p>
            <p><a href="#coderef-root-codegenNode" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-root-codegenNode');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-root-codegenNode');">codegenNode</a>
            经过 ast parse -&gt; transform -&gt; codegen
            之后生成的伪码字符串，这个就 是最后用来产生 render 函数的内容。</p>
          </div>
        </div>
        <div id="outline-container-orgb23bce9" class="outline-4">
          <h4 id="orgb23bce9"><span class=
          "section-number-4">3.10.2.</span> createVNodeCall()</h4>
          <div class="outline-text-4" id="text-3-10-2">
            <p>这里开始是创建 codegenNode 的入口函数，这部分代码主要是在 <a href=
            "https://github.com/vuejs/core/blob/main/packages/compiler-core/src/ast.ts">
            core/ast.ts at main · vuejs/core</a> 中且都是以
            <code>createXxx</code> 开头的函数，根据不同类型创建不同的 codgenNode
            。</p>
            <div class="org-src-container">
              <pre class="src src-js" id="org6c912ca"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createVNodeCall</span>(
<span class="linenr"> 2: </span>  <span class=
"org-variable-name">context</span>,
<span class="linenr"> 3: </span>  <span class=
"org-variable-name">tag</span>,
<span class="linenr"> 4: </span>  <span class=
"org-variable-name">props</span>,
<span class="linenr"> 5: </span>  <span class=
"org-variable-name">children</span>,
<span class="linenr"> 6: </span>  <span class=
"org-variable-name">patchFlag</span>,
<span class="linenr"> 7: </span>  <span class=
"org-variable-name">dynamicProps</span>,
<span class="linenr"> 8: </span>  <span class=
"org-variable-name">directives</span>,
<span class="linenr"> 9: </span>  isBlock = <span class=
"org-constant">false</span>,
<span class="linenr">10: </span>  disableTracking = <span class=
"org-constant">false</span>,
<span class="linenr">11: </span>  isComponent = <span class=
"org-constant">false</span>,
<span class="linenr">12: </span>  loc = locStub
<span class="linenr">13: </span>) {
<span class="linenr">14: </span>  <span class=
"org-keyword">if</span> (context) {
<span class="linenr">15: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">单个子节点用 block</span>
<span class="linenr">16: </span>    <span class=
"org-keyword">if</span> (isBlock) {
<span id="coderef-createVNodeCall-helper" class=
"coderef-off"><span class=
"linenr">17: </span>      context.helper(OPEN_BLOCK)</span>
<span class=
"linenr">18: </span>      context.helper(getVNodeBlockHelper(context.inSSR, isComponent))
<span class="linenr">19: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">20: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">多个节节点用 fragment</span>
<span class=
"linenr">21: </span>      context.helper(getVNodeHelper(context.inSSR, isComponent))
<span class="linenr">22: </span>    }
<span class="linenr">23: </span>    <span class=
"org-keyword">if</span> (directives) {
<span class=
"linenr">24: </span>      context.helper(WITH_DIRECTIVES)
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>  }
<span class="linenr">27: </span>
<span class="linenr">28: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">29: </span>    type: NodeTypes.VNODE_CALL,
<span class="linenr">30: </span>    tag,
<span class="linenr">31: </span>    props,
<span class="linenr">32: </span>    children,
<span class="linenr">33: </span>    patchFlag,
<span class="linenr">34: </span>    dynamicProps,
<span class="linenr">35: </span>    directives,
<span class="linenr">36: </span>    isBlock,
<span class="linenr">37: </span>    disableTracking,
<span class="linenr">38: </span>    isComponent,
<span class="linenr">39: </span>    loc
<span class="linenr">40: </span>  }
<span class="linenr">41: </span>}
</pre>
            </div>
            <p>这个函数<a href="#coderef-createVNodeCall-helper" class=
            "coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-createVNodeCall-helper');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-createVNodeCall-helper');">17</a>中使用到了上下文中的<a href="#coderef-context-helper"
            class="coderef" onmouseover=
            "CodeHighlightOn(this, 'coderef-context-helper');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-context-helper');">context.helper</a>
            函数，这个函 数的目的其实很简单，就是生成 api 名字(<a href=
            "https://github.com/vuejs/core/blob/main/packages/compiler-core/src/runtimeHelpers.ts">core/runtimeHelpers.ts
            at main · vuejs/core</a>)。</p>
            <p>比如：这个用到两个创建元素/组件类型 api: block 和 vnode，分别是</p>
            <p><code>CREATE_BLOCK</code> ,
            <code>CREATE_VNODE</code> 它们在生成后的 render 函数中体现在</p>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">render</span>() {
  <span class=
"org-keyword">const</span> { createBlock: <span class="org-variable-name">_createBlock</span>, createVNode: <span class="org-variable-name">_createVNode</span> } = Vue
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">...</span>
}
</pre>
            </div>
            <p>后面的别名是在 <a href="#cc-codegen">codegen</a>
            阶段生成具体代码时增加的。</p>
          </div>
        </div>
        <div id="outline-container-org680a18f" class="outline-4">
          <h4 id="org680a18f"><span class=
          "section-number-4">3.10.3.</span>
          createArrayExpression()</h4>
          <div class="outline-text-4" id="text-3-10-3">
            <div class="org-src-container">
              <pre class="src src-js" id="orgf090c51"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createArrayExpression</span>(<span class=
              "org-variable-name">elements</span>, <span class=
              "org-variable-name">loc</span> = <span class=
              "org-variable-name">locStub</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_ARRAY_EXPRESSION,
<span class="linenr">4: </span>    loc,
<span class="linenr">5: </span>    elements
<span class="linenr">6: </span>  }
<span class="linenr">7: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org49b9b95" class="outline-4">
          <h4 id="org49b9b95"><span class=
          "section-number-4">3.10.4.</span>
          createObjectExpression()</h4>
          <div class="outline-text-4" id="text-3-10-4">
            <div class="org-src-container">
              <pre class="src src-js" id="org68c612f"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createObjectExpression</span>(<span class=
              "org-variable-name">properties</span>, <span class=
              "org-variable-name">loc</span> = <span class=
              "org-variable-name">locStub</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_OBJECT_EXPRESSION,
<span class="linenr">4: </span>    loc,
<span class="linenr">5: </span>    properties
<span class="linenr">6: </span>  }
<span class="linenr">7: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org98186e9" class="outline-4">
          <h4 id="org98186e9"><span class=
          "section-number-4">3.10.5.</span>
          createObjectProperty()</h4>
          <div class="outline-text-4" id="text-3-10-5">
            <div class="org-src-container">
              <pre class="src src-js" id="orgbceb81f"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createObjectProperty</span>(<span class=
              "org-variable-name">key</span>, <span class=
              "org-variable-name">value</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">3: </span>    type: NodeTypes.JS_PROPERTY,
<span class="linenr">4: </span>    loc: locStub,
<span class=
"linenr">5: </span>    key: isString(key) ? createSimpleExpression(key, <span class="org-constant">true</span>) : key,
<span class="linenr">6: </span>    value
<span class="linenr">7: </span>  }
<span class="linenr">8: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org0705d20" class="outline-4">
          <h4 id="org0705d20"><span class=
          "section-number-4">3.10.6.</span>
          createSimpleExpression()</h4>
          <div class="outline-text-4" id="text-3-10-6">
            <div class="org-src-container">
              <pre class="src src-js" id="orgdee5607"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createSimpleExpression</span>(
<span class="linenr"> 2: </span>  <span class=
"org-variable-name">content</span>,
<span class="linenr"> 3: </span>  isStatic = <span class=
"org-constant">false</span>,
<span class="linenr"> 4: </span>  loc  = locStub,
<span class=
"linenr"> 5: </span>  constType = ConstantTypes.NOT_CONSTANT
<span class="linenr"> 6: </span>) {
<span class="linenr"> 7: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr"> 8: </span>    type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 9: </span>    loc,
<span class="linenr">10: </span>    content,
<span class="linenr">11: </span>    isStatic,
<span class=
"linenr">12: </span>    constType: isStatic ? ConstantTypes.CAN_STRINGIFY : constType
<span class="linenr">13: </span>  }
<span class="linenr">14: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgba06049" class="outline-4">
          <h4 id="orgba06049"><span class=
          "section-number-4">3.10.7.</span>
          createInterpolation()</h4>
          <div class="outline-text-4" id="text-3-10-7">
            <div class="org-src-container">
              <pre class="src src-js" id="org46875b7"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createInterpolation</span>(<span class=
              "org-variable-name">content</span>, <span class=
              "org-variable-name">loc</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">3: </span>    type: NodeTypes.INTERPOLATION,
<span class="linenr">4: </span>    loc,
<span class="linenr">5: </span>    content: isString(content)
<span class=
"linenr">6: </span>      ? createSimpleExpression(content, <span class="org-constant">false</span>, loc)
<span class="linenr">7: </span>      : content
<span class="linenr">8: </span>  }
<span class="linenr">9: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org5316836" class="outline-4">
          <h4 id="org5316836"><span class=
          "section-number-4">3.10.8.</span>
          createCompoundExpression()</h4>
          <div class="outline-text-4" id="text-3-10-8">
            <div class="org-src-container">
              <pre class="src src-js" id="org00940be"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createCompoundExpression</span>(<span class=
              "org-variable-name">children</span>, <span class=
              "org-variable-name">loc</span> = <span class=
              "org-variable-name">locStub</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.COMPOUND_EXPRESSION,
<span class="linenr">4: </span>    loc,
<span class="linenr">5: </span>    children
<span class="linenr">6: </span>  }
<span class="linenr">7: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org7df99a3" class="outline-4">
          <h4 id="org7df99a3"><span class=
          "section-number-4">3.10.9.</span>
          createCallExpression()</h4>
          <div class="outline-text-4" id="text-3-10-9">
            <div class="org-src-container">
              <pre class="src src-js" id="orga5a0481"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createCallExpression</span>(<span class=
              "org-variable-name">callee</span>, <span class=
              "org-variable-name">args</span> = [], <span class=
              "org-variable-name">loc</span> = <span class=
              "org-variable-name">locStub</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_CALL_EXPRESSION,
<span class="linenr">4: </span>    loc,
<span class="linenr">5: </span>    callee,
<span class="linenr">6: </span>    <span class=
"org-constant">arguments</span>: args
<span class="linenr">7: </span>  }
<span class="linenr">8: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgdf64175" class="outline-4">
          <h4 id="orgdf64175"><span class=
          "section-number-4">3.10.10.</span>
          createFunctionExpression()</h4>
          <div class="outline-text-4" id="text-3-10-10">
            <div class="org-src-container">
              <pre class="src src-js" id="org11bf827"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createFunctionExpression</span>(
<span class="linenr"> 2: </span>  <span class=
"org-variable-name">params</span>,
<span class="linenr"> 3: </span>  returns = <span class=
"org-constant">undefined</span>,
<span class="linenr"> 4: </span>  newline = <span class=
"org-constant">false</span>,
<span class="linenr"> 5: </span>  isSlot = <span class=
"org-constant">false</span>,
<span class="linenr"> 6: </span>  loc = locStub
<span class="linenr"> 7: </span>) {
<span class="linenr"> 8: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr"> 9: </span>    type: NodeTypes.JS_FUNCTION_EXPRESSION,
<span class="linenr">10: </span>    params,
<span class="linenr">11: </span>    returns,
<span class="linenr">12: </span>    newline,
<span class="linenr">13: </span>    isSlot,
<span class="linenr">14: </span>    loc
<span class="linenr">15: </span>  }
<span class="linenr">16: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org1814eff" class="outline-4">
          <h4 id="org1814eff"><span class=
          "section-number-4">3.10.11.</span>
          createConditionalExpression()</h4>
          <div class="outline-text-4" id="text-3-10-11">
            <p>生成条件语句(<a href="#orge073826">v-if</a> 指令)：
            <code>test ? consequent : alternate</code></p>
            <p>如果有 v-else-if 时候， alternate 结构会是个完整的
            <code>JS_CONDITIONAL_EXPRESSION</code> ， 即：
            <code>alternate: { test, consequent, alternate,
            ...}</code> 的一个嵌套结构，所以：</p>
            <p><code>test ? consequent : test1 ? consequent1 :
            alternate</code></p>
            <p>如： <code>&lt;div v-if="bar"/&gt;&lt;span
            v-else-if="foo"/&gt;&lt;p v-else/&gt;</code></p>
            <p>对应： <code>bar ? div : foo ? span : p</code></p>
            <div class="org-src-container">
              <pre class="src src-js" id="org0f6bce1"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createConditionalExpression</span>(
<span class="linenr"> 2: </span>  <span class=
"org-variable-name">test</span>,
<span class="linenr"> 3: </span>  <span class=
"org-variable-name">consequent</span>,
<span class="linenr"> 4: </span>  <span class=
"org-variable-name">alternate</span>,
<span class="linenr"> 5: </span>  newline = <span class=
"org-constant">true</span>
<span class="linenr"> 6: </span>) {
<span class="linenr"> 7: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr"> 8: </span>    type: NodeTypes.JS_CONDITIONAL_EXPRESSION,
<span class="linenr"> 9: </span>    test,
<span class="linenr">10: </span>    consequent,
<span class="linenr">11: </span>    alternate,
<span class="linenr">12: </span>    newline,
<span class="linenr">13: </span>    loc: locStub
<span class="linenr">14: </span>  }
<span class="linenr">15: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgae99f7d" class="outline-4">
          <h4 id="orgae99f7d"><span class=
          "section-number-4">3.10.12.</span>
          createCacheExpression()</h4>
          <div class="outline-text-4" id="text-3-10-12">
            <div class="org-src-container">
              <pre class="src src-js" id="org0614f82"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createCacheExpression</span>(
<span class="linenr"> 2: </span>  <span class=
"org-variable-name">index</span>,
<span class="linenr"> 3: </span>  <span class=
"org-variable-name">value</span>,
<span class="linenr"> 4: </span>  isVNode = <span class=
"org-constant">false</span>
<span class="linenr"> 5: </span>) {
<span class="linenr"> 6: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr"> 7: </span>    type: NodeTypes.JS_CACHE_EXPRESSION,
<span class="linenr"> 8: </span>    index,
<span class="linenr"> 9: </span>    value,
<span class="linenr">10: </span>    isVNode,
<span class="linenr">11: </span>    loc: locStub
<span class="linenr">12: </span>  }
<span class="linenr">13: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgded71e6" class="outline-4">
          <h4 id="orgded71e6"><span class=
          "section-number-4">3.10.13.</span>
          createBlockStatement()</h4>
          <div class="outline-text-4" id="text-3-10-13">
            <div class="org-src-container">
              <pre class="src src-js" id="orga5b22dd"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createBlockStatement</span>(<span class=
              "org-variable-name">body</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_BLOCK_STATEMENT,
<span class="linenr">4: </span>    body,
<span class="linenr">5: </span>    loc: locStub
<span class="linenr">6: </span>  }
<span class="linenr">7: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org5f217d6" class="outline-4">
          <h4 id="org5f217d6"><span class=
          "section-number-4">3.10.14.</span>
          createTemplateLiteral()</h4>
          <div class="outline-text-4" id="text-3-10-14">
            <div class="org-src-container">
              <pre class="src src-js" id="org3dfaa8f"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createTemplateLiteral</span>(<span class=
              "org-variable-name">elements</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_TEMPLATE_LITERAL,
<span class="linenr">4: </span>    elements,
<span class="linenr">5: </span>    loc: locStub
<span class="linenr">6: </span>  }
<span class="linenr">7: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org88bcd79" class="outline-4">
          <h4 id="org88bcd79"><span class=
          "section-number-4">3.10.15.</span>
          createIfStatement()</h4>
          <div class="outline-text-4" id="text-3-10-15">
            <div class="org-src-container">
              <pre class="src src-js" id="org0113300"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createIfStatement</span>(<span class=
              "org-variable-name">test</span>, <span class=
              "org-variable-name">consequent</span>, <span class=
              "org-variable-name">alternate</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">3: </span>    type: NodeTypes.JS_IF_STATEMENT,
<span class="linenr">4: </span>    test,
<span class="linenr">5: </span>    consequent,
<span class="linenr">6: </span>    alternate,
<span class="linenr">7: </span>    loc: locStub
<span class="linenr">8: </span>  }
<span class="linenr">9: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgda00b78" class="outline-4">
          <h4 id="orgda00b78"><span class=
          "section-number-4">3.10.16.</span>
          createAssignmentExpression()</h4>
          <div class="outline-text-4" id="text-3-10-16">
            <div class="org-src-container">
              <pre class="src src-js" id="org97ff89d"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createAssignmentExpression</span>(<span class=
              "org-variable-name">left</span>, <span class=
              "org-variable-name">right</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_ASSIGNMENT_EXPRESSION,
<span class="linenr">4: </span>    left,
<span class="linenr">5: </span>    right,
<span class="linenr">6: </span>    loc: locStub
<span class="linenr">7: </span>  }
<span class="linenr">8: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgd100f56" class="outline-4">
          <h4 id="orgd100f56"><span class=
          "section-number-4">3.10.17.</span>
          createSequenceExpression()</h4>
          <div class="outline-text-4" id="text-3-10-17">
            <div class="org-src-container">
              <pre class="src src-js" id="orgd53f938"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createSequenceExpression</span>(<span class=
              "org-variable-name">expressions</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_SEQUENCE_EXPRESSION,
<span class="linenr">4: </span>    expressions,
<span class="linenr">5: </span>    loc: locStub
<span class="linenr">6: </span>  }
<span class="linenr">7: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orge337313" class="outline-4">
          <h4 id="orge337313"><span class=
          "section-number-4">3.10.18.</span>
          createReturnStatement()</h4>
          <div class="outline-text-4" id="text-3-10-18">
            <div class="org-src-container">
              <pre class="src src-js" id="orgd22b4fc"><span class=
              "linenr">1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">createReturnStatement</span>(<span class=
              "org-variable-name">returns</span>) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> {
<span class=
"linenr">3: </span>    type: NodeTypes.JS_RETURN_STATEMENT,
<span class="linenr">4: </span>    returns,
<span class="linenr">5: </span>    loc: locStub
<span class="linenr">6: </span>  }
<span class="linenr">7: </span>}
</pre>
            </div>
          </div>
        </div>
      </div>
      <div id="outline-container-org4b3e461" class="outline-3">
        <h3 id="org4b3e461"><span class=
        "section-number-3">3.11.</span> hoists</h3>
        <div class="outline-text-3" id="text-3-11">
          <div class="org-src-container">
            <pre class="src src-js" id="org13a2e22"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">hoistStatic</span>(<span class=
            "org-variable-name">root</span>, <span class=
            "org-variable-name">context</span>) {
<span class="linenr">  2: </span>  _walk(
<span class="linenr">  3: </span>    root,
<span class="linenr">  4: </span>    context,
<span class="linenr">  5: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Root node is unfortunately non-hoistable due to potential parent</span>
<span class="linenr">  6: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fallthrough attributes.</span>
<span class=
"linenr">  7: </span>    isSingleElementRoot(root, root.children[<span class="org-highlight-numbers-number">0</span>])
<span class="linenr">  8: </span>  )
<span class="linenr">  9: </span>}
<span class="linenr"> 10: </span>
<span class="linenr"> 11: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isSingleElementRoot</span>(
<span class="linenr"> 12: </span>  <span class=
"org-variable-name">root</span>,
<span class="linenr"> 13: </span>  child
<span class="linenr"> 14: </span>) {
<span class="linenr"> 15: </span>  <span class=
"org-keyword">const</span> { children } = root
<span class="linenr"> 16: </span>  <span class=
"org-keyword">return</span> (
<span class=
"linenr"> 17: </span>    children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;&
<span class=
"linenr"> 18: </span>    child.type === NodeTypes.ELEMENT &amp;&
<span class="linenr"> 19: </span>    !isSlotOutlet(child)
<span class="linenr"> 20: </span>  )
<span class="linenr"> 21: </span>}
<span class="linenr"> 22: </span>
<span class="linenr"> 23: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">_walk</span>(
<span class="linenr"> 24: </span>  <span class=
"org-variable-name">node</span>,
<span class="linenr"> 25: </span>  <span class=
"org-variable-name">context</span>,
<span class="linenr"> 26: </span>  doNotHoistNode = <span class=
"org-constant">false</span>
<span class="linenr"> 27: </span>) {
<span class="linenr"> 28: </span>  <span class=
"org-keyword">const</span> { children } = node
<span class="linenr"> 29: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">originalCount</span> = children.length
<span class="linenr"> 30: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hoistedCount</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 31: </span>
<span class="linenr"> 32: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; children.length; i++) {
<span class="linenr"> 33: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[i]
<span class="linenr"> 34: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">only plain elements & text calls are eligible for hoisting.</span>
<span class="linenr"> 35: </span>    <span class=
"org-keyword">if</span> (
<span class=
"linenr"> 36: </span>      child.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr"> 37: </span>      child.tagType === ElementTypes.ELEMENT
<span class="linenr"> 38: </span>    ) {
<span class="linenr"> 39: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">constantType</span> = doNotHoistNode
<span class=
"linenr"> 40: </span>        ? ConstantTypes.NOT_CONSTANT
<span class=
"linenr"> 41: </span>        : getConstantType(child, context)
<span class="linenr"> 42: </span>      <span class=
"org-keyword">if</span> (constantType &gt; ConstantTypes.NOT_CONSTANT) {
<span class="linenr"> 43: </span>        <span class=
"org-keyword">if</span> (constantType &gt;= ConstantTypes.CAN_HOIST) {
<span class=
"linenr"> 44: </span>          child.codegenNode.patchFlag =
<span class=
"linenr"> 45: </span>            PatchFlags.HOISTED + (__DEV__ ? <span class="org-string">` /* HOISTED */`</span> : <span class="org-string">``</span>)
<span class=
"linenr"> 46: </span>          child.codegenNode = context.hoist(child.codegenNode)
<span class="linenr"> 47: </span>          hoistedCount++
<span class="linenr"> 48: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr"> 49: </span>        }
<span class="linenr"> 50: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr"> 51: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node may contain dynamic children, but its props may be eligible for</span>
<span class="linenr"> 52: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">hoisting.</span>
<span class="linenr"> 53: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = child.codegenNode
<span class="linenr"> 54: </span>        <span class=
"org-keyword">if</span> (codegenNode.type === NodeTypes.VNODE_CALL) {
<span class="linenr"> 55: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">flag</span> = getPatchFlag(codegenNode)
<span class="linenr"> 56: </span>          <span class=
"org-keyword">if</span> (
<span class="linenr"> 57: </span>            (!flag ||
<span class=
"linenr"> 58: </span>              flag === PatchFlags.NEED_PATCH ||
<span class=
"linenr"> 59: </span>              flag === PatchFlags.TEXT) &amp;&
<span class=
"linenr"> 60: </span>            getGeneratedPropsConstantType(child, context) &gt;=
<span class=
"linenr"> 61: </span>              ConstantTypes.CAN_HOIST
<span class="linenr"> 62: </span>          ) {
<span class="linenr"> 63: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = getNodeProps(child)
<span class="linenr"> 64: </span>            <span class=
"org-keyword">if</span> (props) {
<span class=
"linenr"> 65: </span>              codegenNode.props = context.hoist(props)
<span class="linenr"> 66: </span>            }
<span class="linenr"> 67: </span>          }
<span class="linenr"> 68: </span>          <span class=
"org-keyword">if</span> (codegenNode.dynamicProps) {
<span class=
"linenr"> 69: </span>            codegenNode.dynamicProps = context.hoist(codegenNode.dynamicProps)
<span class="linenr"> 70: </span>          }
<span class="linenr"> 71: </span>        }
<span class="linenr"> 72: </span>      }
<span class="linenr"> 73: </span>    } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class=
"linenr"> 74: </span>      child.type === NodeTypes.TEXT_CALL &amp;&
<span class=
"linenr"> 75: </span>      getConstantType(child.content, context) &gt;= ConstantTypes.CAN_HOIST
<span class="linenr"> 76: </span>    ) {
<span class=
"linenr"> 77: </span>      child.codegenNode = context.hoist(child.codegenNode)
<span class="linenr"> 78: </span>      hoistedCount++
<span class="linenr"> 79: </span>    }
<span class="linenr"> 80: </span>
<span class="linenr"> 81: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">walk further</span>
<span class="linenr"> 82: </span>    <span class=
"org-keyword">if</span> (child.type === NodeTypes.ELEMENT) {
<span class="linenr"> 83: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isComponent</span> = child.tagType === ElementTypes.COMPONENT
<span class="linenr"> 84: </span>      <span class=
"org-keyword">if</span> (isComponent) {
<span class="linenr"> 85: </span>        context.scopes.vSlot++
<span class="linenr"> 86: </span>      }
<span class="linenr"> 87: </span>      walk(child, context)
<span class="linenr"> 88: </span>      <span class=
"org-keyword">if</span> (isComponent) {
<span class="linenr"> 89: </span>        context.scopes.vSlot--
<span class="linenr"> 90: </span>      }
<span class="linenr"> 91: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (child.type === NodeTypes.FOR) {
<span class="linenr"> 92: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Do not hoist v-for single child because it has to be a block</span>
<span class=
"linenr"> 93: </span>      walk(child, context, child.children.length === <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 94: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (child.type === NodeTypes.IF) {
<span class="linenr"> 95: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; child.branches.length; i++) {
<span class="linenr"> 96: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Do not hoist v-if single child because it has to be a block</span>
<span class="linenr"> 97: </span>        walk(
<span class="linenr"> 98: </span>          child.branches[i],
<span class="linenr"> 99: </span>          context,
<span class=
"linenr">100: </span>          child.branches[i].children.length === <span class="org-highlight-numbers-number">1</span>
<span class="linenr">101: </span>        )
<span class="linenr">102: </span>      }
<span class="linenr">103: </span>    }
<span class="linenr">104: </span>  }
<span class="linenr">105: </span>
<span class="linenr">106: </span>  <span class=
"org-keyword">if</span> (hoistedCount &amp;& context.transformHoist) {
<span class=
"linenr">107: </span>    context.transformHoist(children, context, node)
<span class="linenr">108: </span>  }
<span class="linenr">109: </span>
<span class="linenr">110: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">all children were hoisted - the entire children array is hoistable.</span>
<span class="linenr">111: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr">112: </span>    hoistedCount &amp;&
<span class=
"linenr">113: </span>    hoistedCount === originalCount &amp;&
<span class=
"linenr">114: </span>    node.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr">115: </span>    node.tagType === ElementTypes.ELEMENT &amp;&
<span class="linenr">116: </span>    node.codegenNode &amp;&
<span class=
"linenr">117: </span>    node.codegenNode.type === NodeTypes.VNODE_CALL &amp;&
<span class=
"linenr">118: </span>    isArray(node.codegenNode.children)
<span class="linenr">119: </span>  ) {
<span class=
"linenr">120: </span>    node.codegenNode.children = context.hoist(
<span class=
"linenr">121: </span>      createArrayExpression(node.codegenNode.children)
<span class="linenr">122: </span>    )
<span class="linenr">123: </span>  }
<span class="linenr">124: </span>}
<span class="linenr">125: </span>
<span class="linenr">126: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getConstantType</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">127: </span>  <span class=
"org-keyword">const</span> { constantCache } = context
<span class="linenr">128: </span>  <span class=
"org-keyword">switch</span> (node.type) {
<span class="linenr">129: </span>    <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr">130: </span>      <span class=
"org-keyword">if</span> (node.tagType !== ElementTypes.ELEMENT) {
<span class="linenr">131: </span>        <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">132: </span>      }
<span class="linenr">133: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">cached</span> = constantCache.get(node)
<span class="linenr">134: </span>      <span class=
"org-keyword">if</span> (cached !== <span class=
"org-constant">undefined</span>) {
<span class="linenr">135: </span>        <span class=
"org-keyword">return</span> cached
<span class="linenr">136: </span>      }
<span class="linenr">137: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = node.codegenNode
<span class="linenr">138: </span>      <span class=
"org-keyword">if</span> (codegenNode.type !== NodeTypes.VNODE_CALL) {
<span class="linenr">139: </span>        <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">140: </span>      }
<span class="linenr">141: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">142: </span>        codegenNode.isBlock &amp;&
<span class="linenr">143: </span>        node.tag !== <span class=
"org-string">'svg'</span> &amp;&
<span class="linenr">144: </span>        node.tag !== <span class=
"org-string">'foreignObject'</span>
<span class="linenr">145: </span>      ) {
<span class="linenr">146: </span>        <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">147: </span>      }
<span class="linenr">148: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">flag</span> = getPatchFlag(codegenNode)
<span class="linenr">149: </span>      <span class=
"org-keyword">if</span> (!flag) {
<span class="linenr">150: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">returnType</span> = ConstantTypes.CAN_STRINGIFY
<span class="linenr">151: </span>
<span class="linenr">152: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Element itself has no patch flag. However we still need to check:</span>
<span class="linenr">153: </span>
<span class="linenr">154: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Even for a node with no patch flag, it is possible for it to contain</span>
<span class="linenr">155: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">non-hoistable expressions that refers to scope variables, e.g. compiler</span>
<span class="linenr">156: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">injected keys or cached event handlers. Therefore we need to always</span>
<span class="linenr">157: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check the codegenNode's props to be sure.</span>
<span class="linenr">158: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">generatedPropsType</span> = getGeneratedPropsConstantType(node, context)
<span class="linenr">159: </span>        <span class=
"org-keyword">if</span> (generatedPropsType === ConstantTypes.NOT_CONSTANT) {
<span class=
"linenr">160: </span>          constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr">161: </span>          <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">162: </span>        }
<span class="linenr">163: </span>        <span class=
"org-keyword">if</span> (generatedPropsType &lt; returnType) {
<span class=
"linenr">164: </span>          returnType = generatedPropsType
<span class="linenr">165: </span>        }
<span class="linenr">166: </span>
<span class="linenr">167: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. its children.</span>
<span class="linenr">168: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class="linenr">169: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">childType</span> = getConstantType(node.children[i], context)
<span class="linenr">170: </span>          <span class=
"org-keyword">if</span> (childType === ConstantTypes.NOT_CONSTANT) {
<span class=
"linenr">171: </span>            constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr">172: </span>            <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">173: </span>          }
<span class="linenr">174: </span>          <span class=
"org-keyword">if</span> (childType &lt; returnType) {
<span class="linenr">175: </span>            returnType = childType
<span class="linenr">176: </span>          }
<span class="linenr">177: </span>        }
<span class="linenr">178: </span>
<span class="linenr">179: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. if the type is not already CAN_SKIP_PATCH which is the lowest non-0</span>
<span class="linenr">180: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">type, check if any of the props can cause the type to be lowered</span>
<span class="linenr">181: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we can skip can_patch because it's guaranteed by the absence of a</span>
<span class="linenr">182: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag.</span>
<span class="linenr">183: </span>        <span class=
"org-keyword">if</span> (returnType &gt; ConstantTypes.CAN_SKIP_PATCH) {
<span class="linenr">184: </span>          <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">185: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">186: </span>            <span class=
"org-keyword">if</span> (p.type === NodeTypes.DIRECTIVE &amp;& p.name === <span class="org-string">'bind'</span> &amp;& p.exp) {
<span class="linenr">187: </span>              <span class=
"org-keyword">const</span> <span class=
"org-variable-name">expType</span> = getConstantType(p.exp, context)
<span class="linenr">188: </span>              <span class=
"org-keyword">if</span> (expType === ConstantTypes.NOT_CONSTANT) {
<span class=
"linenr">189: </span>                constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr">190: </span>                <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">191: </span>              }
<span class="linenr">192: </span>              <span class=
"org-keyword">if</span> (expType &lt; returnType) {
<span class=
"linenr">193: </span>                returnType = expType
<span class="linenr">194: </span>              }
<span class="linenr">195: </span>            }
<span class="linenr">196: </span>          }
<span class="linenr">197: </span>        }
<span class="linenr">198: </span>
<span class="linenr">199: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">only svg/foreignObject could be block here, however if they are</span>
<span class="linenr">200: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">static then they don't need to be blocks since there will be no</span>
<span class="linenr">201: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">nested updates.</span>
<span class="linenr">202: </span>        <span class=
"org-keyword">if</span> (codegenNode.isBlock) {
<span class=
"linenr">203: </span>          context.removeHelper(OPEN_BLOCK)
<span class="linenr">204: </span>          context.removeHelper(
<span class=
"linenr">205: </span>            getVNodeBlockHelper(context.inSSR, codegenNode.isComponent)
<span class="linenr">206: </span>          )
<span class=
"linenr">207: </span>          codegenNode.isBlock = <span class=
"org-constant">false</span>
<span class=
"linenr">208: </span>          context.helper(getVNodeHelper(context.inSSR, codegenNode.isComponent))
<span class="linenr">209: </span>        }
<span class="linenr">210: </span>
<span class=
"linenr">211: </span>        constantCache.set(node, returnType)
<span class="linenr">212: </span>        <span class=
"org-keyword">return</span> returnType
<span class="linenr">213: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">214: </span>        constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr">215: </span>        <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">216: </span>      }
<span class="linenr">217: </span>    <span class=
"org-keyword">case</span> NodeTypes.TEXT:
<span class="linenr">218: </span>    <span class=
"org-keyword">case</span> NodeTypes.COMMENT:
<span class="linenr">219: </span>      <span class=
"org-keyword">return</span> ConstantTypes.CAN_STRINGIFY
<span class="linenr">220: </span>    <span class=
"org-keyword">case</span> NodeTypes.IF:
<span class="linenr">221: </span>    <span class=
"org-keyword">case</span> NodeTypes.FOR:
<span class="linenr">222: </span>    <span class=
"org-keyword">case</span> NodeTypes.IF_BRANCH:
<span class="linenr">223: </span>      <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">224: </span>    <span class=
"org-keyword">case</span> NodeTypes.INTERPOLATION:
<span class="linenr">225: </span>    <span class=
"org-keyword">case</span> NodeTypes.TEXT_CALL:
<span class="linenr">226: </span>      <span class=
"org-keyword">return</span> getConstantType(node.content, context)
<span class="linenr">227: </span>    <span class=
"org-keyword">case</span> NodeTypes.SIMPLE_EXPRESSION:
<span class="linenr">228: </span>      <span class=
"org-keyword">return</span> node.constType
<span class="linenr">229: </span>    <span class=
"org-keyword">case</span> NodeTypes.COMPOUND_EXPRESSION:
<span class="linenr">230: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">returnType</span> = ConstantTypes.CAN_STRINGIFY
<span class="linenr">231: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class="linenr">232: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = node.children[i]
<span class="linenr">233: </span>        <span class=
"org-keyword">if</span> (isString(child) || isSymbol(child)) {
<span class="linenr">234: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">235: </span>        }
<span class="linenr">236: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">childType</span> = getConstantType(child, context)
<span class="linenr">237: </span>        <span class=
"org-keyword">if</span> (childType === ConstantTypes.NOT_CONSTANT) {
<span class="linenr">238: </span>          <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">239: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (childType &lt; returnType) {
<span class="linenr">240: </span>          returnType = childType
<span class="linenr">241: </span>        }
<span class="linenr">242: </span>      }
<span class="linenr">243: </span>      <span class=
"org-keyword">return</span> returnType
<span class="linenr">244: </span>    <span class=
"org-keyword">default</span>:
<span class="linenr">245: </span>      <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">246: </span>  }
<span class="linenr">247: </span>}
<span class="linenr">248: </span>
<span class="linenr">249: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">allowHoistedHelperSet</span> = <span class=
"org-keyword">new</span> <span class="org-type">Set</span>([
<span class="linenr">250: </span>  NORMALIZE_CLASS,
<span class="linenr">251: </span>  NORMALIZE_STYLE,
<span class="linenr">252: </span>  NORMALIZE_PROPS,
<span class="linenr">253: </span>  GUARD_REACTIVE_PROPS
<span class="linenr">254: </span>])
<span class="linenr">255: </span>
<span class="linenr">256: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getConstantTypeOfHelperCall</span>(<span class=
"org-variable-name">value</span>, <span class=
"org-variable-name">context</span>){
<span class="linenr">257: </span>  <span class=
"org-keyword">if</span> (
<span class=
"linenr">258: </span>    value.type === NodeTypes.JS_CALL_EXPRESSION &amp;&
<span class="linenr">259: </span>    !isString(value.callee) &amp;&
<span class=
"linenr">260: </span>    allowHoistedHelperSet.has(value.callee)
<span class="linenr">261: </span>  ) {
<span class="linenr">262: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">arg</span> = value.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">263: </span>    <span class=
"org-keyword">if</span> (arg.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">264: </span>      <span class=
"org-keyword">return</span> getConstantType(arg, context)
<span class="linenr">265: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (arg.type === NodeTypes.JS_CALL_EXPRESSION) {
<span class="linenr">266: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in the case of nested helper call, e.g. `normalizeProps(guardReactiveProps(exp))`</span>
<span class="linenr">267: </span>      <span class=
"org-keyword">return</span> getConstantTypeOfHelperCall(arg, context)
<span class="linenr">268: </span>    }
<span class="linenr">269: </span>  }
<span class="linenr">270: </span>  <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">271: </span>}
<span class="linenr">272: </span>
<span class="linenr">273: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getGeneratedPropsConstantType</span>(<span class="org-variable-name">node</span>, <span class="org-variable-name">context</span>) {
<span class="linenr">274: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">returnType</span> = ConstantTypes.CAN_STRINGIFY
<span class="linenr">275: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = getNodeProps(node)
<span class="linenr">276: </span>  <span class=
"org-keyword">if</span> (props &amp;& props.type === NodeTypes.JS_OBJECT_EXPRESSION) {
<span class="linenr">277: </span>    <span class=
"org-keyword">const</span> { properties } = props
<span class="linenr">278: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; properties.length; i++) {
<span class="linenr">279: </span>      <span class=
"org-keyword">const</span> { key, value } = properties[i]
<span class="linenr">280: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyType</span> = getConstantType(key, context)
<span class="linenr">281: </span>      <span class=
"org-keyword">if</span> (keyType === ConstantTypes.NOT_CONSTANT) {
<span class="linenr">282: </span>        <span class=
"org-keyword">return</span> keyType
<span class="linenr">283: </span>      }
<span class="linenr">284: </span>      <span class=
"org-keyword">if</span> (keyType &lt; returnType) {
<span class="linenr">285: </span>        returnType = keyType
<span class="linenr">286: </span>      }
<span class="linenr">287: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">valueType</span>
<span class="linenr">288: </span>      <span class=
"org-keyword">if</span> (value.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class=
"linenr">289: </span>        valueType = getConstantType(value, context)
<span class="linenr">290: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (value.type === NodeTypes.JS_CALL_EXPRESSION) {
<span class="linenr">291: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">some helper calls can be hoisted,</span>
<span class="linenr">292: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">such as the `normalizeProps` generated by the compiler for pre-normalize class,</span>
<span class="linenr">293: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in this case we need to respect the ConstantType of the helper's arguments</span>
<span class=
"linenr">294: </span>        valueType = getConstantTypeOfHelperCall(value, context)
<span class="linenr">295: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">296: </span>        valueType = ConstantTypes.NOT_CONSTANT
<span class="linenr">297: </span>      }
<span class="linenr">298: </span>      <span class=
"org-keyword">if</span> (valueType === ConstantTypes.NOT_CONSTANT) {
<span class="linenr">299: </span>        <span class=
"org-keyword">return</span> valueType
<span class="linenr">300: </span>      }
<span class="linenr">301: </span>      <span class=
"org-keyword">if</span> (valueType &lt; returnType) {
<span class="linenr">302: </span>        returnType = valueType
<span class="linenr">303: </span>      }
<span class="linenr">304: </span>    }
<span class="linenr">305: </span>  }
<span class="linenr">306: </span>  <span class=
"org-keyword">return</span> returnType
<span class="linenr">307: </span>}
<span class="linenr">308: </span>
<span class="linenr">309: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getNodeProps</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">310: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = node.codegenNode
<span class="linenr">311: </span>  <span class=
"org-keyword">if</span> (codegenNode.type === NodeTypes.VNODE_CALL) {
<span class="linenr">312: </span>    <span class=
"org-keyword">return</span> codegenNode.props
<span class="linenr">313: </span>  }
<span class="linenr">314: </span>}
<span class="linenr">315: </span>
<span class="linenr">316: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getPatchFlag</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">317: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">flag</span> = node.patchFlag
<span class="linenr">318: </span>  <span class=
"org-keyword">return</span> flag ? parseInt(flag, <span class=
"org-highlight-numbers-number">10</span>) : <span class=
"org-constant">undefined</span>
<span class="linenr">319: </span>}
<span class="linenr">320: </span>
</pre>
          </div>
        </div>
      </div>
    </div>
    <div id="outline-container-cc-codegen" class="outline-2">
      <h2 id="cc-codegen"><span class="section-number-2">4.</span>
      codegen</h2>
      <div class="outline-text-2" id="text-cc-codegen"></div>
    </div>
    <div id="outline-container-cc-compile" class="outline-2">
      <h2 id="cc-compile"><span class="section-number-2">5.</span>
      compile</h2>
      <div class="outline-text-2" id="text-cc-compile">
        <p>结合 ast parser -&gt; transform -&gt; codegen 使用 compile
        函数将 SFC 编译成 render 函 数。</p>
        <p>完整版：</p>
        <div class="org-src-container">
          <pre class="src src-js" id="orgf238359"><span class=
          "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;transform&gt;&gt;
<span class=
"linenr"> 4: </span>&lt;&lt;getBaseTransformPreset&gt;&gt;
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">baseCompile</span>(<span class=
"org-variable-name">template</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr"> 7: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isModuleMode</span> = options.mode === <span class="org-string">'module'</span>
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = isString(template) ? baseParse(tempalte, options) : template
<span class="linenr">10: </span>  <span class=
"org-keyword">const</span> [<span class=
"org-variable-name">nodeTransforms</span>, <span class=
"org-variable-name">directiveTransforms</span>] = getBaseTransformPreset(prefixIdentifiers)
<span class="linenr">11: </span>
<span class="linenr">12: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prefixIdentifiers</span> =
<span class=
"linenr">13: </span>    !__BROWSER__ &amp;& (options.prefixIdentifiers === <span class="org-constant">true</span> || isModuleMode)
<span class="linenr">14: </span>
<span class="linenr">15: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">转换出每个节点的 codegenNode</span>
<span class="linenr">16: </span>  transform(
<span class="linenr">17: </span>    ast,
<span class="linenr">18: </span>    extend({}, options, {
<span class="linenr">19: </span>      prefixIdentifiers,
<span class="linenr">20: </span>      nodeTransforms: [
<span class="linenr">21: </span>        ...nodeTransforms,
<span class=
"linenr">22: </span>        ...(options.nodeTransforms || []) <span class="org-comment-delimiter">// </span><span class="org-comment">user transforms</span>
<span class="linenr">23: </span>      ],
<span class="linenr">24: </span>      directiveTransforms: extend(
<span class="linenr">25: </span>        {},
<span class="linenr">26: </span>        directiveTransforms,
<span class=
"linenr">27: </span>        options.directiveTransforms || {} <span class="org-comment-delimiter">// </span><span class="org-comment">user transforms</span>
<span class="linenr">28: </span>      )
<span class="linenr">29: </span>    })
<span class="linenr">30: </span>  )
<span class="linenr">31: </span>
<span class="linenr">32: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span><span class=
"org-comment"> codegen phase</span>
<span class="linenr">33: </span>  <span class=
"org-keyword">return</span> ast
<span class="linenr">34: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">生成 codegen</span>
<span class="linenr">35: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">return generate(ast, extend({}, options, { prefixIdentifiers }))</span>
<span class="linenr">36: </span>}
</pre>
        </div>
      </div>
      <div id="outline-container-org3110601" class="outline-3">
        <h3 id="org3110601"><span class=
        "section-number-3">5.1.</span>
        getBaseTransformPreset()</h3>
        <div class="outline-text-3" id="text-5-1">
          <div class="org-src-container">
            <pre class="src src-js" id="org474a373"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">getBaseTransformPreset</span>(<span class=
            "org-variable-name">prefixIdentifiers</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">return</span> [
<span class="linenr"> 3: </span>    [
<span class="linenr"> 4: </span>      transformOnce,
<span class="linenr"> 5: </span>      transformIf,
<span class="linenr"> 6: </span>      transformMemo,
<span class="linenr"> 7: </span>      transformFor,
<span class=
"linenr"> 8: </span>      ...(!__BROWSER__ &amp;& prefixIdentifiers
<span class="linenr"> 9: </span>        ? [
<span class="linenr">10: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">order is important</span>
<span class="linenr">11: </span>            trackVForSlotScopes,
<span class="linenr">12: </span>            transformExpression
<span class="linenr">13: </span>          ]
<span class=
"linenr">14: </span>        : __BROWSER__ &amp;& __DEV__
<span class="linenr">15: </span>        ? [transformExpression]
<span class="linenr">16: </span>        : []),
<span class="linenr">17: </span>      transformSlotOutlet,
<span class="linenr">18: </span>      transformElement,
<span class="linenr">19: </span>      trackSlotScopes,
<span class="linenr">20: </span>      transformText
<span class="linenr">21: </span>    ],
<span class="linenr">22: </span>    {
<span class="linenr">23: </span>      on: transformOn,
<span class="linenr">24: </span>      bind: transformBind,
<span class="linenr">25: </span>      model: transformModel
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>  ]
<span class="linenr">28: </span>}
</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Zhicheng Lee</p>
    <p class="date">Created: 2022-04-22 Fri 17:23</p>
  </div>
</body>
</html>
