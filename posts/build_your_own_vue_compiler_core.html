<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-04-19 Tue 16:06 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>build your own vue compiler-core</title>
  <meta name="author" content="Zhicheng Lee">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <link rel="icon" type="image/png" sizes="48x48" href=
  "/favicon.ico">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <link rel="stylesheet" href="/assets/js/fancybox/fancybox.css"
  type="text/css" media="screen">
  <script type="text/javascript" src=
  "/assets/js/fancybox/fancybox.umd.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/apps.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="vue">
  <meta name="tags" content="compiler-core">
  <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;
        
          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster.bundle.min.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster-sideTip-punk.min.css">
  <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
  </script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster.bundle.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster-scrollableTip.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/tooltips.js"></script>
  <style>
           abbr {color: red;}
        
           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
  </style>
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">build your own vue compiler-core</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#org780da90">1. Global variables</a>
          </li>
          <li>
            <a href="#orgb53a32a">2. ast parser</a>
            <ul>
              <li>
                <a href="#org2f8b977">2.1. baseParse()</a>
              </li>
              <li>
                <a href="#org245dd88">2.2.
                createParserContext()</a>
              </li>
              <li>
                <a href="#orgaa5c1cc">2.3. createRoot()</a>
              </li>
              <li>
                <a href="#org1f40ee3">2.4. parseChildren()</a>
              </li>
              <li>
                <a href="#org7cba011">2.5. parseText()</a>
              </li>
              <li>
                <a href="#orgf696153">2.6. parseTextData()</a>
              </li>
              <li>
                <a href="#org7c42387">2.7. parseInterpolation()</a>
              </li>
              <li>
                <a href="#org7b7e14d">2.8. parseElement()</a>
              </li>
              <li>
                <a href="#org3df6624">2.9. parseTag()</a>
              </li>
              <li>
                <a href="#orgc1becec">2.10. parseAttributes</a>
                <ul>
                  <li>
                    <a href="#orge0a06e4">2.10.1.
                    parseAttribute</a>
                  </li>
                  <li>
                    <a href="#org4a9c702">2.10.2.
                    parseAttributeValue</a>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orgb23549d">3. transform</a>
          </li>
          <li>
            <a href="#org3f26f53">4. codegen</a>
          </li>
        </ul>
      </div>
    </div>
    <p><a href="/"><img src=
    "https://img.shields.io/badge/GCCLL-Homepage-green?logo=gnu-emacs"></a></p>
    <div style=
    "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <h3>Vue3 Compiler-core</h3>
      <p>vue3 编译器核心模块 -&gt; <a href=
      "https://github.com/vuejs/core/blob/main/packages/compiler-core/src/index.ts">
      core/index.ts at main · vuejs/core</a></p>
      <p><span style=
      "color:green;">该模块主要实现将SFC文件编译成render函数，其实主要包含三个阶段</span></p>
      <ol class="org-ol">
        <li>ast parser 阶段, 将 SFC 中的 <code>&lt;template&gt;</code>
        编译成 AST(抽象语法树)；</li>
        <li>transform 阶段，对 ast 的加工处理，比如：处理
        <code>for/if/on/bind</code> 等指令；</li>
        <li>codegen 阶段，根据 ast 生成代码字符串，然后用 <code>new
        Function(code)</code> 生成 <code>render</code> 函数；</li>
      </ol>
      <p>旧博客中的相关文章：</p>
      <p><a href=
      "https://www.cheng92.com/vue/vue3-source-code-compiler-core-parse_ts/">
      Vue3.0 源码系列（二）编译器核心 - Compiler core 1: parse.ts -
      若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue3-source-code-compiler-core-ast_ts/">
      Vue3.0 源码系列（二）编译器核心 - Compiler core 2: ast.ts - 若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue3-source-code-compiler-core-compile_ts/">
      Vue3.0 源码系列（二）编译器核心 - Compiler core 3: compile.ts -
      若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-house-cc/">Vue3
      源码头脑风暴之☞compiler-core - 若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-compiler-core-parser/">
      Vue3 源码头脑风暴之 2 ☞compiler-core - ast parser - 若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-compiler-core-transform-generate/">
      Vue3 源码头脑风暴之 3 ☞compiler-core - transform + codegen -
      若叶知秋</a></p>
    </div><br>
    <div id="outline-container-org780da90" class="outline-2">
      <h2 id="org780da90"><span class="section-number-2">1.</span>
      Global variables</h2>
      <div class="outline-text-2" id="text-1">
        <p>与实际逻辑没什么关联的变量和函数。</p>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">全局变量</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="orgcefa63c"><span class=
            "linenr">  1: </span>
<span class="linenr">  2: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">The default decoder only provides escapes for characters reserved as part of</span>
<span class="linenr">  3: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the template syntax, and is only used if the custom renderer did not provide</span>
<span class="linenr">  4: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">a platform-specific decoder.</span>
<span class="linenr">  5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">decodeRE</span> = <span class=
"org-string">/&amp;(gt|lt|amp|apos|quot);/</span>g
<span id="coderef-html-entities" class="coderef-off"><span class=
"linenr">  6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">decodeMap</span> = {</span>
<span class="linenr">  7: </span>  gt: <span class=
"org-string">'&gt;'</span>,
<span class="linenr">  8: </span>  lt: <span class=
"org-string">'&lt;'</span>,
<span class="linenr">  9: </span>  amp: <span class=
"org-string">'&amp;'</span>,
<span class="linenr"> 10: </span>  apos: <span class=
"org-string">"'"</span>,
<span class="linenr"> 11: </span>  quot: <span class=
"org-string">'"'</span>
<span class="linenr"> 12: </span>}
<span class="linenr"> 13: </span>
<span class="linenr"> 14: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NO</span> = () =&gt; <span class=
"org-constant">false</span>
<span class="linenr"> 15: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">locStub</span> = {
<span class="linenr"> 16: </span>  source: <span class=
"org-string">''</span>,
<span class="linenr"> 17: </span>  start: { line: <span class=
"org-highlight-numbers-number">1</span>, column: <span class=
"org-highlight-numbers-number">1</span>, offset: <span class=
"org-highlight-numbers-number">0</span> },
<span class="linenr"> 18: </span>  end: { line: <span class=
"org-highlight-numbers-number">1</span>, column: <span class=
"org-highlight-numbers-number">1</span>, offset: <span class=
"org-highlight-numbers-number">0</span> }
<span class="linenr"> 19: </span>}
<span class="linenr"> 20: </span>
<span class="linenr"> 21: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ConstantTypes</span> = {
<span class="linenr"> 22: </span>  NOT_CONSTANT: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 23: </span>  CAN_SKIP_PATCH: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 24: </span>  CAN_HOIST: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 25: </span>  CAN_STRINGIFY: <span class=
"org-highlight-numbers-number">3</span>
<span class="linenr"> 26: </span>}
<span class="linenr"> 27: </span>
<span class="linenr"> 28: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ElementTypes</span> = {
<span class="linenr"> 29: </span>  ELEMENT: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 30: </span>  COMPONENT: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 31: </span>  SLOT: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 32: </span>  TEMPLATE: <span class=
"org-highlight-numbers-number">3</span>
<span class="linenr"> 33: </span>}
<span class="linenr"> 34: </span>
<span class="linenr"> 35: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">Namespaces</span> = {
<span class="linenr"> 36: </span>  HTML: <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 37: </span>}
<span class="linenr"> 38: </span>
<span class="linenr"> 39: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">NodeTypes</span> = {
<span class="linenr"> 40: </span>  ROOT: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 41: </span>  ELEMENT: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 42: </span>  TEXT: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 43: </span>  COMMENT: <span class=
"org-highlight-numbers-number">3</span>,
<span class="linenr"> 44: </span>  SIMPLE_EXPRESSION: <span class=
"org-highlight-numbers-number">4</span>,
<span class="linenr"> 45: </span>  INTERPOLATION: <span class=
"org-highlight-numbers-number">5</span>,
<span class="linenr"> 46: </span>  ATTRIBUTE: <span class=
"org-highlight-numbers-number">6</span>,
<span class="linenr"> 47: </span>  DIRECTIVE: <span class=
"org-highlight-numbers-number">7</span>,
<span class="linenr"> 48: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">containers</span>
<span class=
"linenr"> 49: </span>  COMPOUND_EXPRESSION: <span class="org-highlight-numbers-number">8</span>,
<span class="linenr"> 50: </span>  IF: <span class=
"org-highlight-numbers-number">9</span>,
<span class="linenr"> 51: </span>  IF_BRANCH: <span class=
"org-highlight-numbers-number">10</span>,
<span class="linenr"> 52: </span>  FOR: <span class=
"org-highlight-numbers-number">11</span>,
<span class="linenr"> 53: </span>  TEXT_CALL: <span class=
"org-highlight-numbers-number">12</span>,
<span class="linenr"> 54: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">codegen</span>
<span class="linenr"> 55: </span>  VNODE_CALL: <span class=
"org-highlight-numbers-number">13</span>,
<span class="linenr"> 56: </span>  JS_CALL_EXPRESSION: <span class=
"org-highlight-numbers-number">14</span>,
<span class=
"linenr"> 57: </span>  JS_OBJECT_EXPRESSION: <span class=
"org-highlight-numbers-number">15</span>,
<span class="linenr"> 58: </span>  JS_PROPERTY: <span class=
"org-highlight-numbers-number">16</span>,
<span class=
"linenr"> 59: </span>  JS_ARRAY_EXPRESSION: <span class="org-highlight-numbers-number">17</span>,
<span class=
"linenr"> 60: </span>  JS_FUNCTION_EXPRESSION: <span class=
"org-highlight-numbers-number">18</span>,
<span class=
"linenr"> 61: </span>  JS_CONDITIONAL_EXPRESSION: <span class=
"org-highlight-numbers-number">19</span>,
<span class=
"linenr"> 62: </span>  JS_CACHE_EXPRESSION: <span class="org-highlight-numbers-number">20</span>,
<span class="linenr"> 63: </span>
<span class="linenr"> 64: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ssr codegen</span>
<span class="linenr"> 65: </span>  JS_BLOCK_STATEMENT: <span class=
"org-highlight-numbers-number">21</span>,
<span class=
"linenr"> 66: </span>  JS_TEMPLATE_LITERAL: <span class="org-highlight-numbers-number">22</span>,
<span class="linenr"> 67: </span>  JS_IF_STATEMENT: <span class=
"org-highlight-numbers-number">23</span>,
<span class=
"linenr"> 68: </span>  JS_ASSIGNMENT_EXPRESSION: <span class=
"org-highlight-numbers-number">24</span>,
<span class=
"linenr"> 69: </span>  JS_SEQUENCE_EXPRESSION: <span class=
"org-highlight-numbers-number">25</span>,
<span class=
"linenr"> 70: </span>  JS_RETURN_STATEMENT: <span class="org-highlight-numbers-number">26</span>
<span class="linenr"> 71: </span>}
<span class="linenr"> 72: </span>
<span class="linenr"> 73: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">__DEV__</span> = <span class=
"org-constant">true</span>
<span class="linenr"> 74: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">defaultParserOptions</span> = {
<span class="linenr"> 75: </span>  delimiters: [<span class=
"org-string">`{{`</span>, <span class="org-string">`}}`</span>],
<span class=
"linenr"> 76: </span>  getNamespace: () =&gt; Namespaces.HTML,
<span class=
"linenr"> 77: </span>  getTextMode: () =&gt; TextModes.DATA,
<span class="linenr"> 78: </span>  isVoidTag: NO,
<span class="linenr"> 79: </span>  isPreTag: NO,
<span class="linenr"> 80: </span>  isCustomElement: NO,
<span class=
"linenr"> 81: </span>  decodeEntities: (rawText) =&gt; rawText.replace(decodeRE, (_, p1) =&gt; decodeMap[p1]),
<span class="linenr"> 82: </span>  onError: defaultOnError,
<span class="linenr"> 83: </span>  onWarn: defaultOnWarn,
<span class="linenr"> 84: </span>  comments: __DEV__
<span class="linenr"> 85: </span>}
<span class="linenr"> 86: </span>
<span class="linenr"> 87: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TagType</span> = {
<span class="linenr"> 88: </span>  Start: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 89: </span>  End: <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr"> 90: </span>}
<span class="linenr"> 91: </span>
<span class="linenr"> 92: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">TextModes</span> = {
<span class="linenr"> 93: </span>  DATA: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 94: </span>  RCDATA: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr"> 95: </span>  RAWTEXT: <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr"> 96: </span>  CDATA: <span class=
"org-highlight-numbers-number">3</span>,
<span class="linenr"> 97: </span>  ATTRIBUTE_VALUE: <span class=
"org-highlight-numbers-number">4</span>
<span class="linenr"> 98: </span>}
<span class="linenr"> 99: </span>
<span class="linenr">100: </span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">debugOn</span> = <span class=
"org-constant">true</span>
<span class="linenr">101: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">log</span> = (fn, message) =&gt; {
<span class="linenr">102: </span>  <span class=
"org-keyword">if</span> (debugOn) {
<span class="linenr">103: </span>    <span class=
"org-keyword">if</span> (message === <span class=
"org-constant">undefined</span>) {
<span class="linenr">104: </span>      console.log(fn)
<span class="linenr">105: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">106: </span>      console.log(<span class=
"org-string">`[${fn}] ${message}`</span>)
<span class="linenr">107: </span>    }
<span class="linenr">108: </span>  }
<span class="linenr">109: </span>}
<span class="linenr">110: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">logEnd</span> = (hint = <span class=
"org-string">"END"</span>) =&gt; console.log(<span class=
"org-string">`--------- ${hint} ---------`</span>)
<span class="linenr">111: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">logg</span> = ( hint, msg ) =&gt; ( logEnd(hint), log(msg) )
<span class="linenr">112: </span>
<span class="linenr">113: </span>&lt;&lt;glovalFns&gt;&gt;
</pre>
          </div>
        </details><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "green">Global Functions</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="orgefc941b"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">extend</span> = Object.assign
<span class="linenr">  2: </span>
<span class="linenr">  3: </span>
<span class="linenr">  4: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">defaultOnError</span>(<span class=
"org-variable-name">error</span>) {
<span class="linenr">  5: </span>  <span class=
"org-keyword">throw</span> error
<span class="linenr">  6: </span>}
<span class="linenr">  7: </span>
<span class="linenr">  8: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">defaultOnWarn</span>(<span class=
"org-variable-name">msg</span>) {
<span class=
"linenr">  9: </span>  __DEV__ &amp;& console.warn(<span class=
"org-string">`[Vue warn] ${msg.message}`</span>)
<span class="linenr"> 10: </span>}
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">makeMap</span>(<span class=
"org-variable-name">str</span>, <span class=
"org-variable-name">expectsLowerCase</span>) {
<span class="linenr"> 13: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">map</span> = Object.create(<span class=
"org-constant">null</span>)
<span class="linenr"> 14: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">list</span> = str.split(<span class=
"org-string">','</span>)
<span class="linenr"> 15: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; list.length; i++) {
<span class="linenr"> 16: </span>    map[list[i]] = <span class=
"org-constant">true</span>
<span class="linenr"> 17: </span>  }
<span class="linenr"> 18: </span>  <span class=
"org-keyword">return</span> expectsLowerCase ? val =&gt; !!map[val.toLowerCase()] : val =&gt; !!map[val]
<span class="linenr"> 19: </span>}
<span class="linenr"> 20: </span>
<span class="linenr"> 21: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasOwnProperty</span> = Object.<span class=
"org-constant">prototype</span>.hasOwnProperty
<span class="linenr"> 22: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasOwn</span> = (val, key) =&gt; hasOwnProperty.call(val, key)
<span class="linenr"> 23: </span>
<span class="linenr"> 24: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isArray</span> = Array.isArray
<span class="linenr"> 25: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isMap</span> = (val) =&gt; toTypeString(val) === <span class="org-string">'[object Map]'</span>
<span class="linenr"> 26: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSet</span> = (val) =&gt; toTypeString(val) === <span class="org-string">'[object Set]'</span>
<span class="linenr"> 27: </span>
<span class="linenr"> 28: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDate</span> = (val) =&gt; val <span class=
"org-keyword">instanceof</span> <span class="org-type">Date</span>
<span class="linenr"> 29: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isFunction</span> = (val) =&gt; <span class=
"org-keyword">typeof</span> val === <span class=
"org-string">'function'</span>
<span class="linenr"> 30: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isString</span> = (val) =&gt; <span class=
"org-keyword">typeof</span> val === <span class=
"org-string">'string'</span>
<span class="linenr"> 31: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSymbol</span> = (val) =&gt; <span class=
"org-keyword">typeof</span> val === <span class=
"org-string">'symbol'</span>
<span class="linenr"> 32: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isObject</span> = (val) =&gt; val !== <span class="org-constant">null</span> &amp;& <span class="org-keyword">typeof</span> val === <span class="org-string">'object'</span>
<span class="linenr"> 33: </span>
<span class="linenr"> 34: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isPromise</span> = (val) =&gt; {
<span class="linenr"> 35: </span>  <span class=
"org-keyword">return</span> isObject(val) &amp;& isFunction(val.then) &amp;& isFunction(val.<span class="org-keyword">catch</span>)
<span class="linenr"> 36: </span>}
<span class="linenr"> 37: </span>
<span class="linenr"> 38: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">objectToString</span> = Object.<span class=
"org-constant">prototype</span>.toString
<span class="linenr"> 39: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">toTypeString</span> = (value) =&gt; objectToString.call(value)
<span class="linenr"> 40: </span>
<span class="linenr"> 41: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">toRawType</span> = (value) =&gt; {
<span class="linenr"> 42: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">extract "RawType" from strings like "[object RawType]"</span>
<span class="linenr"> 43: </span>  <span class=
"org-keyword">return</span> toTypeString(value).slice(<span class=
"org-highlight-numbers-number">8</span>, -<span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr"> 44: </span>}
<span class="linenr"> 45: </span>
<span class="linenr"> 46: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isPlainObject</span> = (val) =&gt; toTypeString(val) === <span class="org-string">'[object Object]'</span>
<span class="linenr"> 47: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isIntegerKey</span> = (key) =&gt;
<span class="linenr"> 48: </span>  isString(key) &amp;&
<span class="linenr"> 49: </span>  key !== <span class=
"org-string">'NaN'</span> &amp;&
<span class="linenr"> 50: </span>  key[<span class=
"org-highlight-numbers-number">0</span>] !== <span class=
"org-string">'-'</span> &amp;&
<span class="linenr"> 51: </span>  <span class=
"org-string">''</span> + parseInt(key, <span class=
"org-highlight-numbers-number">10</span>) === key
<span class="linenr"> 52: </span>
<span class="linenr"> 53: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isReservedProp</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr"> 54: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the leading comma is intentional so empty string "" is also included</span>
<span class="linenr"> 55: </span>  <span class=
"org-string">',key,ref,ref_for,ref_key,'</span> +
<span class="linenr"> 56: </span>    <span class=
"org-string">'onVnodeBeforeMount,onVnodeMounted,'</span> +
<span class="linenr"> 57: </span>    <span class=
"org-string">'onVnodeBeforeUpdate,onVnodeUpdated,'</span> +
<span class="linenr"> 58: </span>    <span class=
"org-string">'onVnodeBeforeUnmount,onVnodeUnmounted'</span>
<span class="linenr"> 59: </span>)
<span class="linenr"> 60: </span>
<span class="linenr"> 61: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isBuiltInDirective</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr"> 62: </span>  <span class=
"org-string">'bind,cloak,else-if,else,for,html,if,model,on,once,pre,show,slot,text,memo'</span>
<span class="linenr"> 63: </span>)
<span class="linenr"> 64: </span>
<span class="linenr"> 65: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getCursor</span>(<span class=
"org-variable-name">context</span>) {
<span class="linenr"> 66: </span>  <span class=
"org-keyword">const</span> { column, line, offset } = context
<span class="linenr"> 67: </span>  <span class=
"org-keyword">return</span> { column, line, offset }
<span class="linenr"> 68: </span>}
<span class="linenr"> 69: </span>
<span class="linenr"> 70: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getSelection</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">start</span>, <span class=
"org-variable-name">end</span>) {
<span class="linenr"> 71: </span>  end = end || getCursor(context)
<span class="linenr"> 72: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr"> 73: </span>    start,
<span class="linenr"> 74: </span>    end,
<span class=
"linenr"> 75: </span>    source: context.originalSource.slice(start.offset, end.offset)
<span class="linenr"> 76: </span>  }
<span class="linenr"> 77: </span>}
<span class="linenr"> 78: </span>
<span class="linenr"> 79: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">last</span>(<span class=
"org-variable-name">xs</span>) {
<span class="linenr"> 80: </span>  <span class=
"org-keyword">return</span> xs[xs.length - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 81: </span>}
<span class="linenr"> 82: </span>
<span class="linenr"> 83: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">startsWith</span>(<span class=
"org-variable-name">source</span>, <span class=
"org-variable-name">searchString</span>) {
<span class="linenr"> 84: </span>  <span class=
"org-keyword">return</span> source.startsWith(searchString)
<span class="linenr"> 85: </span>}
<span class="linenr"> 86: </span>
<span class="linenr"> 87: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advancePositionWithMutation</span>(<span class=
"org-variable-name">pos</span>, <span class=
"org-variable-name">source</span>, <span class=
"org-variable-name">numberOfCharacters</span> = <span class=
"org-variable-name">source</span>.<span class=
"org-variable-name">length</span>) {
<span class="linenr"> 88: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">linesCount</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 89: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">lastNewLinePos</span> = -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr"> 90: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; numberOfCharacters; i++) {
<span class="linenr"> 91: </span>    <span class=
"org-keyword">if</span> (source.charCodeAt(i) === <span class=
"org-highlight-numbers-number">10</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">newline char code</span><span class=
"org-comment-delimiter"> */</span>) {
<span class="linenr"> 92: </span>      linesCount++
<span class="linenr"> 93: </span>      lastNewLinePos = i
<span class="linenr"> 94: </span>    }
<span class="linenr"> 95: </span>  }
<span class="linenr"> 96: </span>
<span class="linenr"> 97: </span>  pos.offset += numberOfCharacters
<span class="linenr"> 98: </span>  pos.line += linesCount
<span class="linenr"> 99: </span>  pos.column =
<span class=
"linenr">100: </span>    lastNewLinePos === -<span class=
"org-highlight-numbers-number">1</span>
<span class=
"linenr">101: </span>      ? pos.column + numberOfCharacters
<span class=
"linenr">102: </span>      : numberOfCharacters - lastNewLinePos
<span class="linenr">103: </span>
<span class="linenr">104: </span>  <span class=
"org-keyword">return</span> pos
<span class="linenr">105: </span>}
<span class="linenr">106: </span>
<span class="linenr">107: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advancePositionWithClone</span>(
<span class="linenr">108: </span>  <span class=
"org-variable-name">pos</span>,
<span class="linenr">109: </span>  <span class=
"org-variable-name">source</span>,
<span class=
"linenr">110: </span>  numberOfCharacters = source.length
<span class="linenr">111: </span>) {
<span class="linenr">112: </span>  <span class=
"org-keyword">return</span> advancePositionWithMutation(
<span class="linenr">113: </span>    extend({}, pos),
<span class="linenr">114: </span>    source,
<span class="linenr">115: </span>    numberOfCharacters
<span class="linenr">116: </span>  )
<span class="linenr">117: </span>}
<span class="linenr">118: </span>
<span class="linenr">119: </span>
<span class="linenr">120: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advanceBy</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">numberOfCharacters</span>) {
<span class="linenr">121: </span>  <span class=
"org-keyword">const</span> { source } = context
<span class=
"linenr">122: </span>  advancePositionWithMutation(context, source, numberOfCharacters)
<span class=
"linenr">123: </span>  context.source = source.slice(numberOfCharacters)
<span class="linenr">124: </span>}
<span class="linenr">125: </span>
<span class="linenr">126: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">advanceSpaces</span>(<span class=
"org-variable-name">context</span>) {
<span class="linenr">127: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[\t\r\n\f ]+/</span>.exec(context.source)
<span class="linenr">128: </span>  <span class=
"org-keyword">if</span> (match) {
<span class=
"linenr">129: </span>    advanceBy(context, match[<span class=
"org-highlight-numbers-number">0</span>].length)
<span class="linenr">130: </span>  }
<span class="linenr">131: </span>}
<span class="linenr">132: </span>
<span class="linenr">133: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">getNewPosition</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">start</span>, <span class=
"org-variable-name">numberOfCharacters</span>) {
<span class="linenr">134: </span>  <span class=
"org-keyword">return</span> advancePositionWithClone(
<span class="linenr">135: </span>    start,
<span class=
"linenr">136: </span>    context.originalSource.slice(start.offset, numberOfCharacters),
<span class="linenr">137: </span>    numberOfCharacters
<span class="linenr">138: </span>  )
<span class="linenr">139: </span>}
<span class="linenr">140: </span>
<span class="linenr">141: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">emitError</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">code</span>, <span class=
"org-variable-name">offset</span>, <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">getCursor</span>(<span class=
"org-variable-name">context</span>)) {
<span class="linenr">142: </span>  <span class=
"org-keyword">if</span> (offset) {
<span class="linenr">143: </span>    loc.offset += offset
<span class="linenr">144: </span>    loc.column += offset
<span class="linenr">145: </span>  }
<span class="linenr">146: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ignore...</span>
<span class="linenr">147: </span>}
<span class="linenr">148: </span>
<span class="linenr">149: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isEnd</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">mode</span>, <span class=
"org-variable-name">ancestors</span>) {
<span class="linenr">150: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">s</span> = context.source
<span class="linenr">151: </span>
<span class="linenr">152: </span>  <span class=
"org-keyword">switch</span> (mode) {
<span class="linenr">153: </span>    <span class=
"org-keyword">case</span> TextModes.DATA:
<span class="linenr">154: </span>      <span class=
"org-keyword">if</span> (startsWith(s, <span class=
"org-string">'&lt;/'</span>)) {
<span class="linenr">155: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO:</span></span></span><span class=
"org-comment"> probably bad performance</span>
<span class="linenr">156: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = ancestors.length - <span class=
"org-highlight-numbers-number">1</span>; i &gt;= <span class=
"org-highlight-numbers-number">0</span>; --i) {
<span class="linenr">157: </span>          <span class=
"org-keyword">if</span> (startsWithEndTagOpen(s, ancestors[i].tag)) {
<span class="linenr">158: </span>            <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">159: </span>          }
<span class="linenr">160: </span>        }
<span class="linenr">161: </span>      }
<span class="linenr">162: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">163: </span>
<span class="linenr">164: </span>    <span class=
"org-keyword">case</span> TextModes.RCDATA:
<span class="linenr">165: </span>    <span class=
"org-keyword">case</span> TextModes.RAWTEXT: {
<span class="linenr">166: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr">167: </span>      <span class=
"org-keyword">if</span> (parent &amp;& startsWithEndTagOpen(s, parent.tag)) {
<span class="linenr">168: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">169: </span>      }
<span class="linenr">170: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">171: </span>    }
<span class="linenr">172: </span>
<span class="linenr">173: </span>    <span class=
"org-keyword">case</span> TextModes.CDATA:
<span class="linenr">174: </span>      <span class=
"org-keyword">if</span> (startsWith(s, <span class=
"org-string">']]&gt;'</span>)) {
<span class="linenr">175: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">176: </span>      }
<span class="linenr">177: </span>      <span class=
"org-keyword">break</span>
<span class="linenr">178: </span>  }
<span class="linenr">179: </span>
<span class="linenr">180: </span>  <span class=
"org-keyword">return</span> !s
<span class="linenr">181: </span>}
<span class="linenr">182: </span>
<span class="linenr">183: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">startsWithEndTagOpen</span>(<span class=
"org-variable-name">source</span>, <span class=
"org-variable-name">tag</span>) {
<span class="linenr">184: </span>  <span class=
"org-keyword">return</span> (
<span class=
"linenr">185: </span>    startsWith(source, <span class="org-string">'&lt;/'</span>) &amp;&
<span class="linenr">186: </span>    source.slice(<span class=
"org-highlight-numbers-number">2</span>, <span class=
"org-highlight-numbers-number">2</span> + tag.length).toLowerCase() === tag.toLowerCase() &amp;&
<span class=
"linenr">187: </span>    /[\t\r\n\f /&gt;]/.test(source[<span class="org-highlight-numbers-number">2</span> + tag.length] || <span class="org-string">'&gt;'</span>)
<span class="linenr">188: </span>  )
<span class="linenr">189: </span>}
<span class="linenr">190: </span>
<span class="linenr">191: </span>
<span class="linenr">192: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">cacheStringFunction</span> = (fn) =&gt; {
<span class="linenr">193: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">cache</span> = Object.create(<span class=
"org-constant">null</span>)
<span class="linenr">194: </span>  <span class=
"org-keyword">return</span> ((str) =&gt; {
<span class="linenr">195: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hit</span> = cache[str]
<span class="linenr">196: </span>    <span class=
"org-keyword">return</span> hit || (cache[str] = fn(str))
<span class="linenr">197: </span>  })
<span class="linenr">198: </span>}
<span class="linenr">199: </span>
<span class="linenr">200: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">camelizeRE</span> = <span class=
"org-string">/-(\w)/</span>g
<span class="linenr">201: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">camelize</span> = cacheStringFunction((str) =&gt; {
<span class="linenr">202: </span>  <span class=
"org-keyword">return</span> str.replace(camelizeRE, (_, c) =&gt; (c ? c.toUpperCase() : <span class="org-string">''</span>))
<span class="linenr">203: </span>})
<span class="linenr">204: </span>
<span class="linenr">205: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hyphenateRE</span> = <span class=
"org-string">/\B([A-Z])/</span>g
<span class="linenr">206: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">hyphenate</span> = cacheStringFunction((str) =&gt;
<span class=
"linenr">207: </span>  str.replace(hyphenateRE, <span class=
"org-string">'-$1'</span>).toLowerCase()
<span class="linenr">208: </span>)
<span class="linenr">209: </span>
<span class="linenr">210: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isBuiltInType</span> = (tag, expected) =&gt; tag === expected || tag === hyphenate(expected)
<span class="linenr">211: </span>
<span class="linenr">212: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">isCoreComponent</span>(<span class=
"org-variable-name">tag</span>) {
<span class="linenr">213: </span>  <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'Teleport'</span>)) {
<span class="linenr">214: </span>    <span class=
"org-keyword">return</span> TELEPORT
<span class="linenr">215: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'Suspense'</span>)) {
<span class="linenr">216: </span>    <span class=
"org-keyword">return</span> SUSPENSE
<span class="linenr">217: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'KeepAlive'</span>)) {
<span class="linenr">218: </span>    <span class=
"org-keyword">return</span> KEEP_ALIVE
<span class="linenr">219: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isBuiltInType(tag, <span class=
"org-string">'BaseTransition'</span>)) {
<span class="linenr">220: </span>    <span class=
"org-keyword">return</span> BASE_TRANSITION
<span class="linenr">221: </span>  }
<span class="linenr">222: </span>}
<span class="linenr">223: </span>
<span class="linenr">224: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSpecialTemplateDirective</span> = <span class="org-comment-delimiter">/*</span><span class="org-comment">#__PURE__</span><span class="org-comment-delimiter">*/</span> makeMap(
<span class="linenr">225: </span>  <span class=
"org-string">`if,else,else-if,for,slot`</span>
<span class="linenr">226: </span>)
<span class="linenr">227: </span>
<span class="linenr">228: </span>&lt;&lt;isComponent&gt;&gt;
<span class="linenr">229: </span>&lt;&lt;pushNode&gt;&gt;
<span class="linenr">230: </span>
</pre>
          </div>
          <p>检查是不是组件类型：</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org34c809c"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">isComponent</span>(<span class=
            "org-variable-name">tag</span>, <span class=
            "org-variable-name">props</span>, <span class=
            "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">options</span> = context.options
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (options.isCustomElement(tag)) {
<span class="linenr"> 4: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr"> 5: </span>  }
<span class="linenr"> 6: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr"> 7: </span>    tag === <span class=
"org-string">'component'</span> ||
<span class="linenr"> 8: </span>    /^[A-Z]/.test(tag) ||
<span class="linenr"> 9: </span>    isCoreComponent(tag) ||
<span class=
"linenr">10: </span>    (options.isBuiltInComponent &amp;& options.isBuiltInComponent(tag)) ||
<span class=
"linenr">11: </span>    (options.isNativeTag &amp;& !options.isNativeTag(tag))
<span class="linenr">12: </span>  ) {
<span class="linenr">13: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">14: </span>  }
<span class="linenr">15: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">at this point the tag should be a native tag, but check for potential "is"</span>
<span class="linenr">16: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">casting</span>
<span class="linenr">17: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; props.length; i++) {
<span class="linenr">18: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = props[i]
<span class="linenr">19: </span>    <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">20: </span>      <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'is'</span> &amp;& p.value) {
<span class="linenr">21: </span>        <span class=
"org-keyword">if</span> (p.value.content.startsWith(<span class=
"org-string">'vue:'</span>)) {
<span class="linenr">22: </span>          <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">23: </span>        }
<span class="linenr">24: </span>      }
<span class="linenr">25: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">26: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">directive</span>
<span class="linenr">27: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-is (</span><span class="org-comment"><span class=
"org-bold"><span class=
"org-warning">TODO</span></span></span><span class=
"org-comment"> Deprecate)</span>
<span class="linenr">28: </span>      <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'is'</span>) {
<span class="linenr">29: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">30: </span>      }
<span class="linenr">31: </span>    }
<span class="linenr">32: </span>  }
<span class="linenr">33: </span>}
</pre>
          </div>
          <p>合并相邻的两个文本节点:</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org671ee78"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">pushNode</span>(<span class=
            "org-variable-name">nodes</span>, <span class=
            "org-variable-name">node</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.TEXT) {
<span class="linenr"> 3: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prev</span> = last(nodes)
<span class="linenr"> 4: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Merge if both this and the previous node are text and those are</span>
<span class="linenr"> 5: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">consecutive. This happens for cases like "a &lt; b".</span>
<span class="linenr"> 6: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr"> 7: </span>      prev &amp;&
<span class=
"linenr"> 8: </span>      prev.type === NodeTypes.TEXT &amp;&
<span class=
"linenr"> 9: </span>      prev.loc.end.offset === node.loc.start.offset
<span class="linenr">10: </span>    ) {
<span class="linenr">11: </span>      prev.content += node.content
<span class="linenr">12: </span>      prev.loc.end = node.loc.end
<span class=
"linenr">13: </span>      prev.loc.source += node.loc.source
<span class="linenr">14: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">15: </span>    }
<span class="linenr">16: </span>  }
<span class="linenr">17: </span>
<span class="linenr">18: </span>  nodes.push(node)
<span class="linenr">19: </span>}
</pre>
          </div>
        </details>
        <p>全局变量准备就绪，下面可以开始了~~~</p>
      </div>
    </div>
    <div id="outline-container-orgb53a32a" class="outline-2">
      <h2 id="orgb53a32a"><span class="section-number-2">2.</span>
      ast parser</h2>
      <div class="outline-text-2" id="text-2">
        <a href=
        "../assets/img/vue3/compiler-core/compiler-core-parser.svg"
        data-fancybox="gallery" data-caption="Preview"><img src=
        "../assets/img/vue3/compiler-core/compiler-core-parser.svg"></a>
        <p>解析器包含以下函数：</p>
        <table id="org176d4a3">
          <colgroup>
            <col class="org-left">
            <col class="org-left">
          </colgroup>
          <thead>
            <tr>
              <th scope="col" class="org-left">Function</th>
              <th scope="col" class="org-left">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="org-left">
                <a href="#org1a7addc">baseParse()</a>
              </td>
              <td class="org-left">entry function</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org412c7e4">parseChildren()</a>
              </td>
              <td class="org-left">parse children nodes</td>
            </tr>
            <tr>
              <td class="org-left">&nbsp;</td>
              <td class="org-left">parse <code>CDATA</code> type
              content</td>
            </tr>
            <tr>
              <td class="org-left">&nbsp;</td>
              <td class="org-left">parse comment node</td>
            </tr>
            <tr>
              <td class="org-left">&nbsp;</td>
              <td class="org-left">parse <code>&lt;!...&gt;</code>
              or <code>&lt;?...&gt;</code> comment</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org0f5530a">parseElement()</a>
              </td>
              <td class="org-left">parse normal HTML
              element/component nodes</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org9189e8b">parseTag()</a>
              </td>
              <td class="org-left">parse normal HTML
              tag(<code>&lt;div id=a&gt;</code>) nodes</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org1384098">parseAttributes()</a>
              </td>
              <td class="org-left">parse tag attribute(eg.
              <code>&lt;div foo="100"/&gt;</code>)</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#orgd046b91">parseAttribute()</a>
              </td>
              <td class="org-left">parse tag attribute.</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#orgd846d41">parseAttributeValue()</a>
              </td>
              <td class="org-left">parse tag attribute value</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org61d0f7e">parseText()</a>
              </td>
              <td class="org-left">parse pure text node</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org8d46b59">parseTextData()</a>
              </td>
              <td class="org-left">parse text node value</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="outline-container-org2f8b977" class="outline-3">
        <h3 id="org2f8b977"><span class=
        "section-number-3">2.1.</span> baseParse()</h3>
        <div class="outline-text-3" id="text-2-1">
          <div class="org-src-container">
            <pre class="src src-js" id="org1a7addc"><span class=
            "linenr"> 1: </span>&lt;&lt;globalVars&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;createParserContext&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;createRoot&gt;&gt;
<span class="linenr"> 4: </span>&lt;&lt;parseChildren&gt;&gt;
<span class="linenr"> 5: </span>&lt;&lt;parseElement&gt;&gt;
<span class="linenr"> 6: </span>&lt;&lt;parseTag&gt;&gt;
<span class="linenr"> 7: </span>&lt;&lt;parseText&gt;&gt;
<span class="linenr"> 8: </span>&lt;&lt;parseTextData&gt;&gt;
<span class="linenr"> 9: </span>&lt;&lt;parseInterpolation&gt;&gt;
<span class="linenr">10: </span>&lt;&lt;parseAttributes&gt;&gt;
<span class="linenr">11: </span>&lt;&lt;parseAttribute&gt;&gt;
<span class="linenr">12: </span>&lt;&lt;parseAttributeValue&gt;&gt;
<span class="linenr">13: </span>
<span class="linenr">14: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">baseParse</span>(<span class=
"org-variable-name">content</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr">15: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = createParserContext(content, options)
<span class="linenr">16: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">17: </span>  <span class=
"org-keyword">return</span> createRoot(
<span class=
"linenr">18: </span>    parseChildren(context, TextModes.DATA, []),
<span class="linenr">19: </span>    getSelection(context, start)
<span class="linenr">20: </span>  )
<span class="linenr">21: </span>}
</pre>
          </div>
          <ul class="org-ul">
            <li>一个 app 下只会有一个 parser context 上下文</li>
            <li>一个 app 只有一个 root 节点，由 <a href=
            "#org6f5e757">createRoot()</a> 创建
            </li>
            <li>parser 从 <a href="#org412c7e4">parseChildren()</a>
            解析第一个子节点开始
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org245dd88" class="outline-3">
        <h3 id="org245dd88"><span class=
        "section-number-3">2.2.</span> createParserContext()</h3>
        <div class="outline-text-3" id="text-2-2">
          <p>创建 parser 上下文结构对象：</p>
          <div class="org-src-container">
            <pre class="src src-js" id="orge54e7e8"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">createParserContext</span>(<span class=
            "org-variable-name">content</span>, <span class=
            "org-variable-name">rawOptions</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">options</span> = extend({}, defaultParserOptions)
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">let</span> <span class="org-variable-name">key</span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">for</span> (key <span class=
"org-keyword">in</span> rawOptions) {
<span class="linenr"> 6: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">@ts-ignore</span>
<span class="linenr"> 7: </span>    options[key] =
<span class=
"linenr"> 8: </span>      rawOptions[key] === <span class=
"org-constant">undefined</span>
<span class="linenr"> 9: </span>        ? defaultParserOptions[key]
<span class="linenr">10: </span>        : rawOptions[key]
<span class="linenr">11: </span>  }
<span class="linenr">12: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">13: </span>    options,
<span class="linenr">14: </span>    column: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">15: </span>    line: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">16: </span>    offset: <span class=
"org-highlight-numbers-number">0</span>,
<span id="coderef-context-originalSource" class=
"coderef-off"><span class=
"linenr">17: </span>    originalSource: content,</span>
<span id="coderef-context-source" class="coderef-off"><span class=
"linenr">18: </span>    source: content,</span>
<span class="linenr">19: </span>    inPre: <span class=
"org-constant">false</span>,
<span class="linenr">20: </span>    inVPre: <span class=
"org-constant">false</span>,
<span class="linenr">21: </span>    onWarn: options.onWarn
<span class="linenr">22: </span>  }
<span class="linenr">23: </span>}
</pre>
          </div>
          <p>column, line, offset 表示解析光标停留的位置，这个可以用来调试过程中遇到错误时能
          精准给出发生异常的行和列号。</p>
          <p><code>inPre</code> 和 <code>inVPre</code> 是表示模板是不是在
          <code>&lt;pre/&gt;</code> 标签或者 <code>&lt;div
          v-pre&gt;</code> 指令中。</p>
          <p><a href="#coderef-context-originalSource" class=
          "coderef" onmouseover=
          "CodeHighlightOn(this, 'coderef-context-originalSource');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-originalSource');">
          originalSource</a>: 解析之前的原始模板，如： <code>&lt;div
          id="test"/&gt;</code></p>
          <p><a href="#coderef-context-source" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-context-source');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-source');">source</a>:
          解析当下的模板，解析一点会丢弃一点，如： <code>id="test"/&gt;</code> 这个是
          <a href="#coderef-context-originalSource" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-context-originalSource');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-context-originalSource');">
          originalSource</a> 解析出开始标签名 <code>div</code>
          之后剩下的(一个一个字符的解构)。</p>
        </div>
      </div>
      <div id="outline-container-orgaa5c1cc" class="outline-3">
        <h3 id="orgaa5c1cc"><span class=
        "section-number-3">2.3.</span> createRoot()</h3>
        <div class="outline-text-3" id="text-2-3">
          <p>返回一个根节点结构：</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org6f5e757"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">createRoot</span>(<span class=
            "org-variable-name">children</span>, <span class=
            "org-variable-name">loc</span> = <span class=
            "org-variable-name">locStub</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr"> 3: </span>    type: NodeTypes.ROOT,
<span id="coderef-root-children" class="coderef-off"><span class=
"linenr"> 4: </span>    children,</span>
<span class="linenr"> 5: </span>    helpers: [],
<span id="coderef-root-components" class="coderef-off"><span class=
"linenr"> 6: </span>    components: [],</span>
<span id="coderef-root-directives" class="coderef-off"><span class=
"linenr"> 7: </span>    directives: [],</span>
<span id="coderef-root-hoists" class="coderef-off"><span class=
"linenr"> 8: </span>    hoists: [],</span>
<span id="coderef-root-imports" class="coderef-off"><span class=
"linenr"> 9: </span>    imports: [],</span>
<span class="linenr">10: </span>    cached: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">11: </span>    temps: <span class=
"org-highlight-numbers-number">0</span>,
<span id="coderef-root-codegenNode" class=
"coderef-off"><span class="linenr">12: </span>    codegenNode: <span class="org-constant">undefined</span>,</span>
<span class="linenr">13: </span>    loc
<span class="linenr">14: </span>  }
<span class="linenr">15: </span>}
</pre>
          </div>
          <p><a href="#coderef-root-children" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-root-children');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-root-children');">children</a>
          根节点下的子节点 AST 结构容器</p>
          <p><a href="#coderef-root-components" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-root-components');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-root-components');">components</a>
          引用的所有组件列表</p>
          <p><a href="#coderef-root-directives" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-root-directives');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-root-directives');">directives</a>
          解析后的指令结构</p>
          <p><a href="#coderef-root-hoists" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-root-hoists');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-root-hoists');">hoists</a>
          静态提升的节点，这个是不会发生变化的节点，如：纯文本节点，无 prop 无动态 children
          的节点(不会发生的变化的都会被提升到 render 函数之外)。</p>
          <p><a href="#coderef-root-imports" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-root-imports');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-root-imports');">imports</a>
          引入的一引动依赖仓库</p>
          <p><a href="#coderef-root-codegenNode" class="coderef"
          onmouseover=
          "CodeHighlightOn(this, 'coderef-root-codegenNode');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-root-codegenNode');">codegenNode</a>
          经过 ast parse -&gt; transform -&gt; codegen 之后生成的伪码字符串，这个就
          是最后用来产生 render 函数的内容。</p>
        </div>
      </div>
      <div id="outline-container-org1f40ee3" class="outline-3">
        <h3 id="org1f40ee3"><span class=
        "section-number-3">2.4.</span> parseChildren()</h3>
        <div class="outline-text-3" id="text-2-4">
          <p>这个是 parser 阶段的解析入口函数， root -&gt; children &lt;-&gt;
          children 递归调用解析 AST 。</p>
          <p>通过节点或标签的类型决定调用哪些 <a href="#org176d4a3">parse 函数</a>
          去解析它们。</p>
          <p><span style=
          "color:red;">TIP:这里只保留了正常使用情况下的代码异常处理和边界情况都省略掉了</span></p>
          <div class="org-src-container">
            <pre class="src src-js" id="org412c7e4"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseChildren</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">mode</span>, <span class=
            "org-variable-name">ancestors</span>) {
<span class="linenr">  2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr">  3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = parent ? parent.ns : Namespaces.HTML
<span class="linenr">  4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nodes</span> = [] <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">-&gt; ancestors</span>
<span class="linenr">  5: </span>
<span class="linenr">  6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. while -&gt; isEnd ? 游标不断往前走直接所以 source 都解析完成</span>
<span class="linenr">  7: </span>  <span class=
"org-keyword">while</span> (!isEnd(context, mode, ancestors)) {
<span class="linenr">  8: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">s</span> = context.source
<span class="linenr">  9: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">node</span> = <span class=
"org-constant">undefined</span>
<span class="linenr"> 10: </span>
<span class="linenr"> 11: </span>    <span class=
"org-keyword">if</span> (mode === TextModes.DATA || mode === TextModes.RCDATA) {
<span class="linenr"> 12: </span>      <span class=
"org-keyword">if</span> (!context.inVPre &amp;& startsWith(s, context.options.delimiters[<span class="org-highlight-numbers-number">0</span>])) {
<span class="linenr"> 13: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">'{{' 插值开始</span>
<span class=
"linenr"> 14: </span>        node = parseInterpolation(context, mode)
<span class="linenr"> 15: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (mode === TextModes.DATA &amp;& s[<span class="org-highlight-numbers-number">0</span>] === <span class="org-string">'&lt;'</span>) {
<span class="linenr"> 16: </span>        <span class=
"org-keyword">if</span> (s[<span class=
"org-highlight-numbers-number">1</span>] === <span class=
"org-string">'/'</span>) {
<span class="linenr"> 17: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">结束标签</span>
<span class="linenr"> 18: </span>          <span class=
"org-keyword">if</span> (<span class=
"org-string">/[a-z]/</span>i.test(s[<span class=
"org-highlight-numbers-number">2</span>])) {
<span class="linenr"> 19: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">异常结束，如：`&lt;div&gt;some text&lt;a`</span>
<span class=
"linenr"> 20: </span>            emitError(context, <span class=
"org-string">'X_INVALID_END_TAG'</span>)
<span class=
"linenr"> 21: </span>            parseTag(context, TagType.End, parent)
<span class="linenr"> 22: </span>            <span class=
"org-keyword">continue</span>
<span class="linenr"> 23: </span>          }
<span class="linenr"> 24: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (<span class=
"org-string">/[a-z]/</span>i.test(s[<span class=
"org-highlight-numbers-number">1</span>])) {
<span class="linenr"> 25: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">正常的开始标签</span>
<span class=
"linenr"> 26: </span>          node = parseElement(context, ancestors)
<span class="linenr"> 27: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2.x &lt;template&gt; 无指令兼容，这里就不实现了，重点关注 3.x 的代码</span>
<span class="linenr"> 28: </span>        }
<span class="linenr"> 29: </span>      }
<span class="linenr"> 30: </span>    }
<span class="linenr"> 31: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">以上都不是，说明应该是纯文本节点</span>
<span class="linenr"> 32: </span>    <span class=
"org-keyword">if</span> (!node) {
<span class=
"linenr"> 33: </span>      node = parseText(context, mode)
<span class="linenr"> 34: </span>    }
<span class="linenr"> 35: </span>
<span class="linenr"> 36: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">用 pushNode 在其中合并相邻的文本节点</span>
<span class="linenr"> 37: </span>    <span class=
"org-keyword">if</span> (isArray(node)) {
<span class="linenr"> 38: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.length; i++) {
<span class="linenr"> 39: </span>        pushNode(nodes, node[i])
<span class="linenr"> 40: </span>      }
<span class="linenr"> 41: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 42: </span>      pushNode(nodes, node)
<span class="linenr"> 43: </span>    }
<span class="linenr"> 44: </span>  }
<span class="linenr"> 45: </span>
<span class="linenr"> 46: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 合并相邻文本节点，空格处理，会将多个空格合并成一个空格</span>
<span class="linenr"> 47: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">removedWhitespace</span> = <span class=
"org-constant">false</span>
<span class="linenr"> 48: </span>  <span class=
"org-keyword">if</span> (mode !== TextModes.RAWTEXT &amp;& mode !== TextModes.RCDATA) {
<span class=
"linenr"> 49: </span>    removedWhitespace = _removeWhitespace(nodes, context)
<span class="linenr"> 50: </span>  }
<span class="linenr"> 51: </span>
<span class="linenr"> 52: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. 最后返回解析后的节点树</span>
<span class="linenr"> 53: </span>  <span class=
"org-keyword">return</span> removedWhitespace ? nodes.filter(Boolean) : nodes
<span class="linenr"> 54: </span>}
<span class="linenr"> 55: </span>
<span class="linenr"> 56: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">_removeWhitespace</span>(<span class=
"org-variable-name">nodes</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr"> 57: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">removedWhitespace</span> = <span class=
"org-constant">false</span>
<span class="linenr"> 58: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">可以通过选项来指定是不是保留空格，否则多余的会合并成一个</span>
<span class="linenr"> 59: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">shouldCondense</span> = context.options.whitespace !== <span class="org-string">'preserve'</span>
<span class="linenr"> 60: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; nodes.length; i++) {
<span class="linenr"> 61: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">node</span> = nodes[i]
<span class="linenr"> 62: </span>    <span class=
"org-keyword">if</span> (!context.inPre &amp;& node.type === NodeTypes.TEXT) {
<span class="linenr"> 63: </span>      <span class=
"org-keyword">if</span> (!<span class=
"org-string">/[^\t\r\n\f]/</span>.test(node.content)) {
<span class="linenr"> 64: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prev</span> = nodes[i - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 65: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">next</span> = nodes[i + <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 66: </span>
<span class="linenr"> 67: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr"> 68: </span>          !prev ||
<span class="linenr"> 69: </span>            !next ||
<span class=
"linenr"> 70: </span>            (shouldCondense &amp;& (
<span class=
"linenr"> 71: </span>              prev.type === NodeTypes.COMMENT || next.type === NodeTypes.COMMENT || (
<span class=
"linenr"> 72: </span>                prev.type === NodeTypes.ELEMENT &amp;& next.type === NodeTypes.ELEMENT &amp;& <span class="org-string">/[\r\n]/</span>.test(node.content)
<span class="linenr"> 73: </span>              )
<span class="linenr"> 74: </span>            ))
<span class="linenr"> 75: </span>        ) {
<span class=
"linenr"> 76: </span>          removedWhitespace = <span class=
"org-constant">true</span>
<span class="linenr"> 77: </span>          nodes[i] = <span class=
"org-constant">null</span>
<span class="linenr"> 78: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr"> 79: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">合并成一个</span>
<span class=
"linenr"> 80: </span>          node.content = <span class=
"org-string">' '</span>
<span class="linenr"> 81: </span>        }
<span class="linenr"> 82: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (shouldCondense) {
<span class="linenr"> 83: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">保留空格</span>
<span class=
"linenr"> 84: </span>        node.content = node.content.replace(<span class="org-string">/[\t\r\n\f]+/</span>g, <span class="org-string">' '</span>)
<span class="linenr"> 85: </span>      }
<span class="linenr"> 86: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.type === NodeTypes.COMMENT &amp;& !context.options.comments) {
<span class="linenr"> 87: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">可以通过配置删除注释节点</span>
<span class=
"linenr"> 88: </span>      removedWhitespace = <span class=
"org-constant">true</span>
<span class="linenr"> 89: </span>      nodes[i] = <span class=
"org-constant">null</span>
<span class="linenr"> 90: </span>    }
<span class="linenr"> 91: </span>  }
<span class="linenr"> 92: </span>
<span class="linenr"> 93: </span>  <span class=
"org-keyword">if</span> (context.inPre &amp;& parent &amp;& context.options.isPreTag(parent.tag)) {
<span class="linenr"> 94: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">删除 &lt;pre&gt; 中的第一行的空行</span>
<span class="linenr"> 95: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">first</span> = nodes[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 96: </span>    <span class=
"org-keyword">if</span> (first &amp;& first.type === NodeTypes.TEXT) {
<span class=
"linenr"> 97: </span>      first.content = first.content.replace(<span class="org-string">/^\r?\n/</span>, <span class="org-string">''</span>)
<span class="linenr"> 98: </span>    }
<span class="linenr"> 99: </span>  }
<span class="linenr">100: </span>
<span class="linenr">101: </span>  <span class=
"org-keyword">return</span> removedWhitespace
<span class="linenr">102: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org7cba011" class="outline-3">
        <h3 id="org7cba011"><span class=
        "section-number-3">2.5.</span> parseText()</h3>
        <div class="outline-text-3" id="text-2-5">
          <p>文本解析函数。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org61d0f7e"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseText</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">mode</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endTokens</span> = mode === TextModes.CDATA ? [<span class="org-string">']]&gt;'</span>] : [<span class="org-string">'&lt;'</span>, context.options.delimiters[<span class="org-highlight-numbers-number">0</span>]]
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">endIndex</span> = context.source.length
<span class="linenr"> 5: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; endTokens.length; i++) {
<span class="linenr"> 6: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">index</span> = context.source.indexOf(endTokens[i], <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 7: </span>    <span class=
"org-keyword">if</span> (index !== -<span class=
"org-highlight-numbers-number">1</span> &amp;& endIndex &gt; index) {
<span class="linenr"> 8: </span>      endIndex = index
<span class="linenr"> 9: </span>    }
<span class="linenr">10: </span>  }
<span class="linenr">11: </span>
<span class="linenr">12: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">13: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">content</span> = parseTextData(context, endIndex, mode)
<span class="linenr">14: </span>
<span class="linenr">15: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">16: </span>    type: NodeTypes.TEXT,
<span class="linenr">17: </span>    content,
<span class=
"linenr">18: </span>    loc: getSelection(context, start)
<span class="linenr">19: </span>  }
<span class="linenr">20: </span>}
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some text'</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>logEnd(<span class=
"org-string">'ROOT AST'</span>)
<span class="linenr">6: </span>log(ast)
<span class="linenr">7: </span>logEnd(<span class=
"org-string">'TEXT AST'</span>)
<span class="linenr">8: </span>log(text)
</pre>
          </div>
          <pre class="example" id="org517ead2">
--------- ROOT AST ---------
{
  type: 0,
  children: [ { type: 2, content: 'some text', loc: [Object] } ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'some text'
  }
}
--------- TEXT AST ---------
{
  type: 2,
  content: 'some text',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'some text'
  }
}
undefined
</pre>
        </div>
      </div>
      <div id="outline-container-orgf696153" class="outline-3">
        <h3 id="orgf696153"><span class=
        "section-number-3">2.6.</span> parseTextData()</h3>
        <div class="outline-text-3" id="text-2-6">
          <p>根据 <a href="#org61d0f7e">parseText()</a>
          中解析出来的文本长度取出文本内容，这里会将 <a href="#coderef-html-entities"
          class="coderef" onmouseover=
          "CodeHighlightOn(this, 'coderef-html-entities');"
          onmouseout=
          "CodeHighlightOff(this, 'coderef-html-entities');">HTML
          entities</a> 进行转换。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org8d46b59"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseTextData</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">length</span>, <span class=
            "org-variable-name">mode</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawText</span> = context.source.slice(<span class="org-highlight-numbers-number">0</span>, length)
<span class="linenr"> 3: </span>  advanceBy(context, length)
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">不含HTML entities</span>
<span class="linenr"> 6: </span>  <span class=
"org-keyword">if</span> (mode === TextModes.RAWTEXT || mode === TextModes.CDATA || !rawText.includes(<span class="org-string">'&amp;'</span>)) {
<span class="linenr"> 7: </span>    <span class=
"org-keyword">return</span> rawText
<span class="linenr"> 8: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr"> 9: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将 &amp;gt; -&gt; `&gt;`, &amp;lt; -&gt; `&lt;`, &amp;amp; -&gt; `&amp;`, &amp;apos; -&gt; `'`, &amp;quot; -&gt; `"`</span>
<span class="linenr">10: </span>    <span class=
"org-keyword">return</span> context.options.decodeEntities(rawText, mode === TextModes.ATTRIBUTE_VALUE)
<span class="linenr">11: </span>  }
<span class="linenr">12: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org7c42387" class="outline-3">
        <h3 id="org7c42387"><span class=
        "section-number-3">2.7.</span> parseInterpolation()</h3>
        <div class="outline-text-3" id="text-2-7">
          <p>插值解析(<code>{{...}}</code>)，根据 <code>{{</code> 和
          <code>}}</code> 的位置索引找到它们中间的内容，去掉前后多余的空 格之后得到具体的插值内容。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org67d3440"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseInterpolation</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">mode</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> [<span class=
"org-variable-name">open</span>, <span class=
"org-variable-name">close</span>] = context.options.delimiters
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如： source = "{{ a + b }}"</span>
<span class="linenr"> 5: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">closeIndex = indexOf("}}", "{{".length) = 9</span>
<span class="linenr"> 6: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">closeIndex</span> = context.source.indexOf(close, open.length)
<span class="linenr"> 7: </span>  <span class=
"org-keyword">if</span> (closeIndex === -<span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr"> 8: </span>    emitError(context, <span class=
"org-string">'X_MISSING_INTERPOLATION_END'</span>)
<span class="linenr"> 9: </span>    <span class=
"org-keyword">return</span> <span class=
"org-constant">undefined</span>
<span class="linenr">10: </span>  }
<span class="linenr">11: </span>
<span class="linenr">12: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">13: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&gt;&gt; 2 -&gt; " a + b }}"</span>
<span class="linenr">14: </span>  advanceBy(context, open.length)
<span class="linenr">15: </span>
<span class="linenr">16: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">{ line, column, offset }</span>
<span class="linenr">17: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">innerStart</span> = getCursor(context)
<span class="linenr">18: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">innerEnd</span> = getCursor(context)
<span class="linenr">19: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">9 - '{{'.length = 7</span>
<span class="linenr">20: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawContentLength</span> = closeIndex - open.length
<span class="linenr">21: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">" a + b }}".slice(0, 7) =&gt; " a + b "</span>
<span class="linenr">22: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawContent</span> = context.source.slice(<span class="org-highlight-numbers-number">0</span>, rawContentLength)
<span class="linenr">23: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">preTrimContent</span> = parseTextData(context, rawContentLength, mode)
<span class="linenr">24: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">" a + b " =&gt; "a + b"</span>
<span class="linenr">25: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">content</span> = preTrimContent.trim()
<span class="linenr">26: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">startOffset</span> = preTrimContent.indexOf(content)
<span class="linenr">27: </span>  <span class=
"org-keyword">if</span> (startOffset &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">28: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">处理换行问题</span>
<span class=
"linenr">29: </span>    advancePositionWithMutation(innerStart, rawContent, startOffset)
<span class="linenr">30: </span>  }
<span class="linenr">31: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endOffset</span> = rawContentLength - (preTrimContent.length - content.length - startOffset)
<span class=
"linenr">32: </span>  advancePositionWithMutation(innerEnd, rawContent, endOffset)
<span class="linenr">33: </span>  advanceBy(context, close.length)
<span class="linenr">34: </span>
<span class="linenr">35: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">36: </span>    type: NodeTypes.INTERPOLATION,
<span class="linenr">37: </span>    content: {
<span class=
"linenr">38: </span>      type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr">39: </span>      isStatic: <span class=
"org-constant">false</span>,
<span class="linenr">40: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Set `isConstant` to false by default and will decide in transformExpression</span>
<span class=
"linenr">41: </span>      constType: ConstantTypes.NOT_CONSTANT,
<span class="linenr">42: </span>      content,
<span class=
"linenr">43: </span>      loc: getSelection(context, innerStart, innerEnd)
<span class="linenr">44: </span>    },
<span class=
"linenr">45: </span>    loc: getSelection(context, start)
<span class="linenr">46: </span>  }
<span class="linenr">47: </span>}
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some {{ foo + bar }} text'</span>)
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 5: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1 -&gt; interpolation</span>
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">inter</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text2</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">10: </span>logg(<span class=
"org-string">'Text1'</span>, text1)
<span class="linenr">11: </span>logg(<span class=
"org-string">'INTERPOLATION'</span>, inter)
<span class="linenr">12: </span>logg(<span class=
"org-string">'Text2'</span>, text2)
</pre>
            </div>
            <pre class="example" id="org22f24af">
--------- AST ---------
{
  type: 0,
  children: [
    { type: 2, content: 'some ', loc: [Object] },
    { type: 5, content: [Object], loc: [Object] },
    { type: 2, content: ' text', loc: [Object] }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 26, line: 1, offset: 25 },
    source: 'some {{ foo + bar }} text'
  }
}
--------- Text1 ---------
{
  type: 2,
  content: 'some ',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: 'some '
  }
}
--------- INTERPOLATION ---------
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    constType: 0,
    content: 'foo + bar',
    loc: { start: [Object], end: [Object], source: 'foo + bar' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 21, line: 1, offset: 20 },
    source: '{{ foo + bar }}'
  }
}
--------- Text2 ---------
{
  type: 2,
  content: ' text',
  loc: {
    start: { column: 21, line: 1, offset: 20 },
    end: { column: 26, line: 1, offset: 25 },
    source: ' text'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing-with-&lt;</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some {{ a &lt; b &amp;& c &gt; d }} text'</span>)
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 5: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1 -&gt; interpolation</span>
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">inter</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text2</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">10: </span>logg(<span class=
"org-string">'Text1'</span>, text1)
<span class="linenr">11: </span>logg(<span class=
"org-string">'INTERPOLATION'</span>, inter)
<span class="linenr">12: </span>logg(<span class=
"org-string">'Text2'</span>, text2)
</pre>
            </div>
            <pre class="example" id="orga2d5dec">
--------- AST ---------
{
  type: 0,
  children: [
    { type: 2, content: 'some ', loc: [Object] },
    { type: 5, content: [Object], loc: [Object] },
    { type: 2, content: ' text', loc: [Object] }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 31, line: 1, offset: 30 },
    source: 'some {{ a &lt; b &amp;& c &gt; d }} text'
  }
}
--------- Text1 ---------
{
  type: 2,
  content: 'some ',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: 'some '
  }
}
--------- INTERPOLATION ---------
{
  type: 5,
  content: {
    type: 4,
    isStatic: false,
    constType: 0,
    content: 'a &lt; b &amp;& c &gt; d',
    loc: { start: [Object], end: [Object], source: 'a &lt; b &amp;& c &gt; d' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 26, line: 1, offset: 25 },
    source: '{{ a &lt; b &amp;& c &gt; d }}'
  }
}
--------- Text2 ---------
{
  type: 2,
  content: ' text',
  loc: {
    start: { column: 26, line: 1, offset: 25 },
    end: { column: 31, line: 1, offset: 30 },
    source: ' text'
  }
}
undefined
</pre>
          </details>
        </div>
      </div>
      <div id="outline-container-org7b7e14d" class="outline-3">
        <h3 id="org7b7e14d"><span class=
        "section-number-3">2.8.</span> parseElement()</h3>
        <div class="outline-text-3" id="text-2-8">
          <div class="org-src-container">
            <pre class="src src-js" id="org0f5530a"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseElement</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">ancestors</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr"> 3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. 解析出开始标签</span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = parseTag(context, TagType.Start, parent)
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">自闭合的标签： &lt;div/&gt;</span>
<span class="linenr"> 7: </span>  <span class=
"org-keyword">if</span> (element.isSelfClosing || context.options.isVoidTag(element.tag)) {
<span class="linenr"> 8: </span>    <span class=
"org-keyword">return</span> element
<span class="linenr"> 9: </span>  }
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">children</span>
<span class="linenr">12: </span>  ancestors.push(element)
<span class="linenr">13: </span>
<span class="linenr">14: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">mode</span> = context.options.getTextMode(element, parent)
<span class="linenr">15: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">递归解析子节点</span>
<span class="linenr">16: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">children</span> = parseChildren(context, mode, ancestors)
<span class="linenr">17: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">解析完出栈 [root, parent1, parent2, ...] 代表层级</span>
<span class="linenr">18: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;root&gt;&lt;parent1&gt;&lt;parent2&gt;&lt;/parent&gt;&lt;parent1&gt;&lt;/root&gt; -&gt; 解析过程中通过</span>
<span class="linenr">19: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ancestors 来维护这个层级关系</span>
<span class="linenr">20: </span>  ancestors.pop()
<span class="linenr">21: </span>
<span class="linenr">22: </span>  element.children = children
<span class="linenr">23: </span>
<span class="linenr">24: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 解析结束标签</span>
<span class="linenr">25: </span>  <span class=
"org-keyword">if</span> (startsWithEndTagOpen(context.source, element.tag)) {
<span class=
"linenr">26: </span>    parseTag(context, TagType.End, parent)
<span class="linenr">27: </span>  }
<span class="linenr">28: </span>
<span class="linenr">29: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">更新解析后节点在源码中的位置信息</span>
<span class=
"linenr">30: </span>  element.loc = getSelection(context, element.loc.start)
<span class="linenr">31: </span>
<span class="linenr">32: </span>  <span class=
"org-keyword">return</span> element
<span class="linenr">33: </span>}
</pre>
          </div><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'some &lt;span&gt;text&lt;/span&gt;'</span>)
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text1</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">span</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text2</span> = span.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'text1'</span>, text1)
<span class="linenr">10: </span>logg(<span class=
"org-string">'span'</span>, span)
<span class="linenr">11: </span>logg(<span class=
"org-string">'text2'</span>, text2)
</pre>
            </div>
            <pre class="example" id="org001ae94">
--------- AST ---------
{
  type: 0,
  children: [
    { type: 2, content: 'some ', loc: [Object] },
    {
      type: 1,
      ns: 0,
      tag: 'span',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [Array],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 23, line: 1, offset: 22 },
    source: 'some &lt;span&gt;text&lt;/span&gt;'
  }
}
--------- text1 ---------
{
  type: 2,
  content: 'some ',
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: 'some '
  }
}
--------- span ---------
{
  type: 1,
  ns: 0,
  tag: 'span',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [ { type: 2, content: 'text', loc: [Object] } ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 23, line: 1, offset: 22 },
    source: '&lt;span&gt;text&lt;/span&gt;'
  },
  codegenNode: undefined
}
--------- text2 ---------
{
  type: 2,
  content: 'text',
  loc: {
    start: { column: 12, line: 1, offset: 11 },
    end: { column: 16, line: 1, offset: 15 },
    source: 'text'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing self closing</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div/&gt;after'</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">6: </span>
<span class="linenr">7: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">8: </span>logg(<span class=
"org-string">'text'</span>, text)
</pre>
            </div>
            <pre class="example" id="org21bfbf1">
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 7, line: 1, offset: 6 },
    source: '&lt;div/&gt;'
  },
  codegenNode: undefined
}
--------- text ---------
{
  type: 2,
  content: 'after',
  loc: {
    start: { column: 7, line: 1, offset: 6 },
    end: { column: 12, line: 1, offset: 11 },
    source: 'after'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing void element by
              isVoidElement</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 2: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;img&gt;after'</span>, {
<span class=
"linenr"> 3: </span>  isVoidTag: tag =&gt; tag === <span class=
"org-string">'img'</span>
<span class="linenr"> 4: </span>})
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">text</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">10: </span>logg(<span class=
"org-string">'text'</span>, text)
</pre>
            </div>
            <pre class="example" id="org8ccd08d">
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'img',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 6, line: 1, offset: 5 },
    source: '&lt;img&gt;'
  },
  codegenNode: undefined
}
--------- text ---------
{
  type: 2,
  content: 'after',
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 11, line: 1, offset: 10 },
    source: 'after'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing slot</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;slot&gt;&lt;/slot&gt;&lt;Comp&gt;&lt;/Comp&gt;`</span>)
<span class="linenr">4: </span>
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">slot</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">6: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">comp</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">7: </span>
<span class="linenr">8: </span>logg(<span class=
"org-string">'slot'</span>, slot)
<span class="linenr">9: </span>logg(<span class=
"org-string">'comp'</span>, comp)
</pre>
            </div>
            <pre class="example" id="org51ed97d">
--------- slot ---------
{
  type: 1,
  ns: 0,
  tag: 'slot',
  tagType: 2,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 14, line: 1, offset: 13 },
    source: '&lt;slot&gt;&lt;/slot&gt;'
  },
  codegenNode: undefined
}
--------- comp ---------
{
  type: 1,
  ns: 0,
  tag: 'Comp',
  tagType: 1,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 14, line: 1, offset: 13 },
    end: { column: 27, line: 1, offset: 26 },
    source: '&lt;Comp&gt;&lt;/Comp&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details>
        </div>
      </div>
      <div id="outline-container-org3df6624" class="outline-3">
        <h3 id="org3df6624"><span class=
        "section-number-3">2.9.</span> parseTag()</h3>
        <div class="outline-text-3" id="text-2-9">
          <div class="org-src-container">
            <pre class="src src-js" id="org9189e8b"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseTag</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">type</span>, <span class=
            "org-variable-name">parent</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. 开始标签</span>
<span class="linenr"> 3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 4: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">合法标签的正则匹配</span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/</span>i.exec(context.source)
<span class="linenr"> 6: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">tag</span> = match[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 7: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = context.options.getNamespace(tag, parent)
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">游标前进标签名长度的位置，如： &lt;div id="foo"&gt; -&gt; ` id="foo"&gt;`</span>
<span class=
"linenr">10: </span>  advanceBy(context, match[<span class=
"org-highlight-numbers-number">0</span>].length)
<span class="linenr">11: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">空格处理</span>
<span class="linenr">12: </span>  advanceSpaces(context)
<span class="linenr">13: </span>
<span class="linenr">14: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">parse attributes</span>
<span class="linenr">15: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">props</span> = parseAttributes(context, type)
<span class="linenr">16: </span>
<span class="linenr">17: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span><span class=
"org-comment"> v-pre 检测</span>
<span class="linenr">18: </span>
<span class="linenr">19: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 闭合标签</span>
<span class="linenr">20: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isSelfClosing</span> = <span class=
"org-constant">false</span>
<span class="linenr">21: </span>  <span class=
"org-keyword">if</span> (context.source.length === <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">22: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">非法情况, ignore</span>
<span class="linenr">23: </span>  } <span class=
"org-keyword">else</span> {
<span class=
"linenr">24: </span>    isSelfClosing = startsWith(context.source, <span class="org-string">'/&gt;'</span>)
<span class=
"linenr">25: </span>    advanceBy(context, isSelfClosing ? <span class="org-highlight-numbers-number">2</span> : <span class="org-highlight-numbers-number">1</span>)
<span class="linenr">26: </span>  }
<span class="linenr">27: </span>
<span class="linenr">28: </span>  <span class=
"org-keyword">if</span> (type === TagType.End) {
<span class="linenr">29: </span>    <span class=
"org-keyword">return</span>
<span class="linenr">30: </span>  }
<span class="linenr">31: </span>
<span class="linenr">32: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. 分析出标签的类型</span>
<span class="linenr">33: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">tagType</span> = ElementTypes.ELEMENT
<span class="linenr">34: </span>  <span class=
"org-keyword">if</span> (!context.inVPre) {
<span class="linenr">35: </span>    <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'slot'</span>) {
<span class="linenr">36: </span>      tagType = ElementTypes.SLOT
<span class="linenr">37: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'template'</span>) {
<span class="linenr">38: </span>      <span class=
"org-keyword">if</span> (props.some(p =&gt; p.type === NodeTypes.DIRECTIVE &amp;& isSpecialTemplateDirective(p.name))) {
<span class=
"linenr">39: </span>        tagType = ElementTypes.TEMPLATE
<span class="linenr">40: </span>      }
<span class="linenr">41: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isComponent(tag, props, context)) {
<span class=
"linenr">42: </span>      tagType = ElementTypes.COMPONENT
<span class="linenr">43: </span>    }
<span class="linenr">44: </span>  }
<span class="linenr">45: </span>
<span class="linenr">46: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">47: </span>    type: NodeTypes.ELEMENT,
<span class="linenr">48: </span>    ns,
<span class="linenr">49: </span>    tag,
<span class="linenr">50: </span>    tagType,
<span class="linenr">51: </span>    props,
<span class="linenr">52: </span>    isSelfClosing,
<span class="linenr">53: </span>    children: [],
<span class=
"linenr">54: </span>    loc: getSelection(context, start),
<span class="linenr">55: </span>    codegenNode: <span class=
"org-constant">undefined</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">在 transform 阶段生成的产物</span>
<span class="linenr">56: </span>  }
<span class="linenr">57: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-orgc1becec" class="outline-3">
        <h3 id="orgc1becec"><span class=
        "section-number-3">2.10.</span> parseAttributes</h3>
        <div class="outline-text-3" id="text-2-10">
          <div class="org-src-container">
            <pre class="src src-js" id="org1384098"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">parseAttributes</span>(<span class=
            "org-variable-name">context</span>, <span class=
            "org-variable-name">type</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = []
<span class="linenr"> 3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">用 set 避免重复属性</span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">attributeNames</span> = <span class=
"org-keyword">new</span> <span class="org-type">Set</span>()
<span class="linenr"> 5: </span>  <span class=
"org-keyword">while</span> (
<span class=
"linenr"> 6: </span>    context.source.length &gt; <span class=
"org-highlight-numbers-number">0</span> &amp;&
<span class=
"linenr"> 7: </span>      !startsWith(context.source, <span class=
"org-string">'&gt;'</span>) &amp;&
<span class=
"linenr"> 8: </span>      !startsWith(context.source, <span class=
"org-string">'/&gt;'</span>)
<span class="linenr"> 9: </span>  ) {
<span class="linenr">10: </span>
<span class="linenr">11: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">一些非法检测, ignore</span>
<span class="linenr">12: </span>
<span class="linenr">13: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">attr</span> = parseAttribute(context, attributeNames)
<span class="linenr">14: </span>
<span class="linenr">15: </span>    logg(<span class=
"org-string">'ATTR'</span>, attr)
<span class="linenr">16: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">去掉 class 之间多余的空格，如： `foo   bar  ` -&gt; `foo bar`</span>
<span class="linenr">17: </span>    <span class=
"org-keyword">if</span> (attr.type === NodeTypes.ATTRIBUTE &amp;&
<span id="coderef-remove-class-whitespace" class=
"coderef-off"><span class=
"linenr">18: </span>       attr.value &amp;& attr.name === <span class="org-string">'class'</span>) {</span>
<span class=
"linenr">19: </span>      attr.value.content = attr.value.content.replace(<span class="org-string">/\s+/</span>g, <span class="org-string">' '</span>).trim()
<span class="linenr">20: </span>    }
<span class="linenr">21: </span>
<span class="linenr">22: </span>    <span class=
"org-keyword">if</span> (type === TagType.Start) {
<span class="linenr">23: </span>      props.push(attr)
<span class="linenr">24: </span>    }
<span class="linenr">25: </span>
<span class="linenr">26: </span>    advanceSpaces(context)
<span class="linenr">27: </span>  }
<span class="linenr">28: </span>
<span class="linenr">29: </span>  <span class=
"org-keyword">return</span> props
<span class="linenr">30: </span>}
</pre>
          </div><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing v-if directive</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;template v-if="ok"&gt;&lt;/template&gt;`</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>
<span class="linenr">6: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">7: </span>logg(<span class=
"org-string">'element'</span>, element)
</pre>
            </div>
            <pre class="example" id="org194f2c4">
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'ok',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'ok' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 20, line: 1, offset: 19 },
    source: 'v-if="ok"'
  }
}
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'template',
      tagType: 3,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 32, line: 1, offset: 31 },
    source: '&lt;template v-if="ok"&gt;&lt;/template&gt;'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'template',
  tagType: 3,
  props: [
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 32, line: 1, offset: 31 },
    source: '&lt;template v-if="ok"&gt;&lt;/template&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing template without
              directives</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`&lt;template&gt;&lt;/template&gt;`</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>
<span class="linenr">6: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">7: </span>logg(<span class=
"org-string">'element'</span>, element)
</pre>
            </div>
            <pre class="example" id="orgc097b42">
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'template',
      tagType: 0,
      props: [],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: '&lt;template&gt;&lt;/template&gt;'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'template',
  tagType: 0,
  props: [],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 22, line: 1, offset: 21 },
    source: '&lt;template&gt;&lt;/template&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing without value</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div id&gt;&lt;/div&gt;"</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>
<span class="linenr">6: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">7: </span>logg(<span class=
"org-string">'element'</span>, element)
</pre>
            </div>
            <pre class="example" id="org75401f4">
--------- ATTR ---------
{
  type: 6,
  name: 'id',
  value: undefined,
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 8, line: 1, offset: 7 },
    source: 'id'
  }
}
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 15, line: 1, offset: 14 },
    source: '&lt;div id&gt;&lt;/div&gt;'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [ { type: 6, name: 'id', value: undefined, loc: [Object] } ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 15, line: 1, offset: 14 },
    source: '&lt;div id&gt;&lt;/div&gt;'
  },
  codegenNode: undefined
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing multiple attributes</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div id=a class="c" inert style=\'\'&gt;'</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = element.props
<span class="linenr">6: </span>logg(<span class=
"org-string">'AST'</span>, ast)
<span class="linenr">7: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">8: </span>logg(<span class=
"org-string">'props'</span>, props)
</pre>
            </div>
            <pre class="example" id="orgc62d71e">
--------- ATTR ---------
{
  type: 6,
  name: 'id',
  value: {
    type: 2,
    content: 'a',
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 10, line: 1, offset: 9 },
    source: 'id=a'
  }
}
--------- ATTR ---------
{
  type: 6,
  name: 'class',
  value: {
    type: 2,
    content: 'c',
    loc: { start: [Object], end: [Object], source: '"c"' }
  },
  loc: {
    start: { column: 11, line: 1, offset: 10 },
    end: { column: 20, line: 1, offset: 19 },
    source: 'class="c"'
  }
}
--------- ATTR ---------
{
  type: 6,
  name: 'inert',
  value: undefined,
  loc: {
    start: { column: 21, line: 1, offset: 20 },
    end: { column: 26, line: 1, offset: 25 },
    source: 'inert'
  }
}
--------- ATTR ---------
{
  type: 6,
  name: 'style',
  value: {
    type: 2,
    content: '',
    loc: { start: [Object], end: [Object], source: "''" }
  },
  loc: {
    start: { column: 27, line: 1, offset: 26 },
    end: { column: 35, line: 1, offset: 34 },
    source: "style=''"
  }
}
--------- AST ---------
{
  type: 0,
  children: [
    {
      type: 1,
      ns: 0,
      tag: 'div',
      tagType: 0,
      props: [Array],
      isSelfClosing: false,
      children: [],
      loc: [Object],
      codegenNode: undefined
    }
  ],
  helpers: [],
  components: [],
  directives: [],
  hoists: [],
  imports: [],
  cached: 0,
  temps: 0,
  codegenNode: undefined,
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 36, line: 1, offset: 35 },
    source: `&lt;div id=a class="c" inert style=''&gt;`
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    { type: 6, name: 'id', value: [Object], loc: [Object] },
    { type: 6, name: 'class', value: [Object], loc: [Object] },
    { type: 6, name: 'inert', value: undefined, loc: [Object] },
    { type: 6, name: 'style', value: [Object], loc: [Object] }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 36, line: 1, offset: 35 },
    source: `&lt;div id=a class="c" inert style=''&gt;`
  },
  codegenNode: undefined
}
--------- props ---------
[
  {
    type: 6,
    name: 'id',
    value: { type: 2, content: 'a', loc: [Object] },
    loc: { start: [Object], end: [Object], source: 'id=a' }
  },
  {
    type: 6,
    name: 'class',
    value: { type: 2, content: 'c', loc: [Object] },
    loc: { start: [Object], end: [Object], source: 'class="c"' }
  },
  {
    type: 6,
    name: 'inert',
    value: undefined,
    loc: { start: [Object], end: [Object], source: 'inert' }
  },
  {
    type: 6,
    name: 'style',
    value: { type: 2, content: '', loc: [Object] },
    loc: { start: [Object], end: [Object], source: "style=''" }
  }
]
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing class attribute ignore
              whitespace</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div class=" \n\t c \t\n "&gt;&lt;/div&gt;'</span>)
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">4: </span>
<span class="linenr">5: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">6: </span>logg(<span class=
"org-string">'props'</span>, element.props)
</pre>
            </div>
            <pre class="example" id="orge209408">
--------- ATTR ---------
{
  type: 6,
  name: 'class',
  value: {
    type: 2,
    content: ' \n\t c \t\n ',
    loc: { start: [Object], end: [Object], source: '" \n\t c \t\n "' }
  },
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 3, line: 3, offset: 22 },
    source: 'class=" \n\t c \t\n "'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [ { type: 6, name: 'class', value: [Object], loc: [Object] } ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 10, line: 3, offset: 29 },
    source: '&lt;div class=" \n\t c \t\n "&gt;&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- props ---------
[
  {
    type: 6,
    name: 'class',
    value: { type: 2, content: 'c', loc: [Object] },
    loc: { start: [Object], end: [Object], source: 'class=" \n\t c \t\n "' }
  }
]
undefined
</pre>
            <p>对于 class 值中空格的处理在这 <a href=
            "#org1384098">parseAttributes</a> 中 <a href=
            "#coderef-remove-class-whitespace" class="coderef"
            onmouseover=
            "CodeHighlightOn(this, 'coderef-remove-class-whitespace');"
            onmouseout=
            "CodeHighlightOff(this, 'coderef-remove-class-whitespace');">
            18</a>。</p>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with argument</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">'&lt;div v-on:click /&gt;'</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">6: </span>logg(<span class=
"org-string">'props'</span>, element.props)
<span class="linenr">7: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="org69dec6e">
parseAttribute| match=v-on:click,on,click,
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 16, line: 1, offset: 15 },
    source: 'v-on:click'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 19, line: 1, offset: 18 },
    source: '&lt;div v-on:click /&gt;'
  },
  codegenNode: undefined
}
--------- props ---------
[
  {
    type: 7,
    name: 'on',
    exp: undefined,
    arg: {
      type: 4,
      content: 'click',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-on:click' }
  }
]
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 16, line: 1, offset: 15 },
    source: 'v-on:click'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with dynamic
              argument</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div v-on:[event] /&gt;"</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">6: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="org00099ec">
parseAttribute| match=v-on:[event],on,[event],
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'event',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[event]' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 18, line: 1, offset: 17 },
    source: 'v-on:[event]'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 21, line: 1, offset: 20 },
    source: '&lt;div v-on:[event] /&gt;'
  },
  codegenNode: undefined
}
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'event',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[event]' }
  },
  modifiers: [],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 18, line: 1, offset: 17 },
    source: 'v-on:[event]'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with argument and
              modifiers</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div v-on:click.enter.exact /&gt;"</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">6: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="org83add09">
parseAttribute| match=v-on:click.enter.exact,on,click,.enter.exact
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [ 'enter', 'exact' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 28, line: 1, offset: 27 },
    source: 'v-on:click.enter.exact'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 31, line: 1, offset: 30 },
    source: '&lt;div v-on:click.enter.exact /&gt;'
  },
  codegenNode: undefined
}
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [ 'enter', 'exact' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 28, line: 1, offset: 27 },
    source: 'v-on:click.enter.exact'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing directive with dynamic argument and
              modifiers and shorthand</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">"&lt;div v-on:[a.b].camel :a=b /&gt;"</span>)
<span class="linenr">4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">5: </span>logg(<span class=
"org-string">'element'</span>, element)
<span class="linenr">6: </span>logg(<span class=
"org-string">'directive'</span>, element.props[<span class=
"org-highlight-numbers-number">0</span>])
</pre>
            </div>
            <pre class="example" id="org015ee73">
parseAttribute| match=v-on:[a.b].camel,on,[a.b],.camel
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'a.b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[a.b]' }
  },
  modifiers: [ 'camel' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 22, line: 1, offset: 21 },
    source: 'v-on:[a.b].camel'
  }
}
parseAttribute| match=:a,,a,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'b' }
  },
  arg: {
    type: 4,
    content: 'a',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  modifiers: [],
  loc: {
    start: { column: 23, line: 1, offset: 22 },
    end: { column: 27, line: 1, offset: 26 },
    source: ':a=b'
  }
}
--------- element ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 1, offset: 0 },
    end: { column: 30, line: 1, offset: 29 },
    source: '&lt;div v-on:[a.b].camel :a=b /&gt;'
  },
  codegenNode: undefined
}
--------- directive ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'a.b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[a.b]' }
  },
  modifiers: [ 'camel' ],
  loc: {
    start: { column: 6, line: 1, offset: 5 },
    end: { column: 22, line: 1, offset: 21 },
    source: 'v-on:[a.b].camel'
  }
}
undefined
</pre>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">Testing complex scenario</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;baseParse&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = baseParse(<span class=
"org-string">`</span>
<span class="linenr"> 4: </span><span class=
"org-string">&lt;div</span>
<span class="linenr"> 5: </span><span class=
"org-string">  v-bind:a="b"</span>
<span class="linenr"> 6: </span><span class=
"org-string">  v-bind:[c.d]="e"</span>
<span class="linenr"> 7: </span><span class=
"org-string">  :f="g"</span>
<span class="linenr"> 8: </span><span class=
"org-string">  v-on:[h.i].camel</span>
<span class="linenr"> 9: </span><span class=
"org-string">  v-on:click.camel.exact="j"</span>
<span class="linenr">10: </span><span class=
"org-string">  @keyup.enter.prevent="k"</span>
<span class="linenr">11: </span><span class=
"org-string">  v-if="l &gt; m"</span>
<span class="linenr">12: </span><span class=
"org-string">  .n=o</span>
<span class="linenr">13: </span><span class=
"org-string">  :p.sync=q</span>
<span class="linenr">14: </span><span class=
"org-string">&gt;&lt;/div&gt;</span>
<span class="linenr">15: </span><span class=
"org-string">&lt;Comp1 #a="{ b }"/&gt;</span>
<span class="linenr">16: </span><span class=
"org-string">&lt;Comp2 v-slot:foo.bar="{ a }"/&gt;</span>
<span class="linenr">17: </span><span class="org-string">`</span>)
<span class="linenr">18: </span>
<span class="linenr">19: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">div</span> = ast.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">20: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">comp1</span> = ast.children[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">21: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">comp2</span> = ast.children[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr">22: </span>
<span class="linenr">23: </span>logg(<span class=
"org-string">'div'</span>, div)
<span class="linenr">24: </span>logg(<span class=
"org-string">'div-props'</span>, div.props)
<span class="linenr">25: </span>logg(<span class=
"org-string">'comp1'</span>, comp1)
<span class="linenr">26: </span>logg(<span class=
"org-string">'comp1-slot'</span>, comp1.props)
<span class="linenr">27: </span>logg(<span class=
"org-string">'comp2'</span>, comp2)
<span class="linenr">28: </span>logg(<span class=
"org-string">'comp2-slot'</span>, comp2.props)
</pre>
            </div>
            <pre class="example" id="orgb2c5536">
parseAttribute| match=v-bind:a,bind,a,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'b',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'b' }
  },
  arg: {
    type: 4,
    content: 'a',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  modifiers: [],
  loc: {
    start: { column: 3, line: 3, offset: 8 },
    end: { column: 15, line: 3, offset: 20 },
    source: 'v-bind:a="b"'
  }
}
parseAttribute| match=v-bind:[c.d],bind,[c.d],
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'e',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'e' }
  },
  arg: {
    type: 4,
    content: 'c.d',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[c.d]' }
  },
  modifiers: [],
  loc: {
    start: { column: 3, line: 4, offset: 23 },
    end: { column: 19, line: 4, offset: 39 },
    source: 'v-bind:[c.d]="e"'
  }
}
parseAttribute| match=:f,,f,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'g',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'g' }
  },
  arg: {
    type: 4,
    content: 'f',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'f' }
  },
  modifiers: [],
  loc: {
    start: { column: 3, line: 5, offset: 42 },
    end: { column: 9, line: 5, offset: 48 },
    source: ':f="g"'
  }
}
parseAttribute| match=v-on:[h.i].camel,on,[h.i],.camel
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: undefined,
  arg: {
    type: 4,
    content: 'h.i',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '[h.i]' }
  },
  modifiers: [ 'camel' ],
  loc: {
    start: { column: 3, line: 6, offset: 51 },
    end: { column: 19, line: 6, offset: 67 },
    source: 'v-on:[h.i].camel'
  }
}
parseAttribute| match=v-on:click.camel.exact,on,click,.camel.exact
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: {
    type: 4,
    content: 'j',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'j' }
  },
  arg: {
    type: 4,
    content: 'click',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'click' }
  },
  modifiers: [ 'camel', 'exact' ],
  loc: {
    start: { column: 3, line: 7, offset: 70 },
    end: { column: 29, line: 7, offset: 96 },
    source: 'v-on:click.camel.exact="j"'
  }
}
parseAttribute| match=@keyup.enter.prevent,,keyup,.enter.prevent
--------- ATTR ---------
{
  type: 7,
  name: 'on',
  exp: {
    type: 4,
    content: 'k',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'k' }
  },
  arg: {
    type: 4,
    content: 'keyup',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'keyup' }
  },
  modifiers: [ 'enter', 'prevent' ],
  loc: {
    start: { column: 3, line: 8, offset: 99 },
    end: { column: 27, line: 8, offset: 123 },
    source: '@keyup.enter.prevent="k"'
  }
}
parseAttribute| match=v-if,if,,
--------- ATTR ---------
{
  type: 7,
  name: 'if',
  exp: {
    type: 4,
    content: 'l &gt; m',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'l &gt; m' }
  },
  arg: undefined,
  modifiers: [],
  loc: {
    start: { column: 3, line: 9, offset: 126 },
    end: { column: 15, line: 9, offset: 138 },
    source: 'v-if="l &gt; m"'
  }
}
parseAttribute| match=.n,,n,
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'o',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'o' }
  },
  arg: {
    type: 4,
    content: 'n',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'n' }
  },
  modifiers: [ 'prop' ],
  loc: {
    start: { column: 3, line: 10, offset: 141 },
    end: { column: 7, line: 10, offset: 145 },
    source: '.n=o'
  }
}
parseAttribute| match=:p.sync,,p,.sync
--------- ATTR ---------
{
  type: 7,
  name: 'bind',
  exp: {
    type: 4,
    content: 'q',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: 'q' }
  },
  arg: {
    type: 4,
    content: 'p',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'p' }
  },
  modifiers: [ 'sync' ],
  loc: {
    start: { column: 3, line: 11, offset: 148 },
    end: { column: 12, line: 11, offset: 157 },
    source: ':p.sync=q'
  }
}
parseAttribute| match=#a,,a,
--------- ATTR ---------
{
  type: 7,
  name: 'slot',
  exp: {
    type: 4,
    content: '{ b }',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '{ b }' }
  },
  arg: {
    type: 4,
    content: 'a',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'a' }
  },
  modifiers: [],
  loc: {
    start: { column: 8, line: 13, offset: 173 },
    end: { column: 18, line: 13, offset: 183 },
    source: '#a="{ b }"'
  }
}
parseAttribute| match=v-slot:foo.bar,slot,foo,.bar
--------- ATTR ---------
{
  type: 7,
  name: 'slot',
  exp: {
    type: 4,
    content: '{ a }',
    isStatic: false,
    constType: 0,
    loc: { start: [Object], end: [Object], source: '{ a }' }
  },
  arg: {
    type: 4,
    content: 'foo.bar',
    isStatic: true,
    constType: 3,
    loc: { start: [Object], end: [Object], source: 'foo.bar' }
  },
  modifiers: [ 'bar' ],
  loc: {
    start: { column: 8, line: 14, offset: 193 },
    end: { column: 30, line: 14, offset: 215 },
    source: 'v-slot:foo.bar="{ a }"'
  }
}
--------- div ---------
{
  type: 1,
  ns: 0,
  tag: 'div',
  tagType: 0,
  props: [
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'on',
      exp: undefined,
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'on',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'on',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'if',
      exp: [Object],
      arg: undefined,
      modifiers: [],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    },
    {
      type: 7,
      name: 'bind',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    }
  ],
  isSelfClosing: false,
  children: [],
  loc: {
    start: { column: 1, line: 2, offset: 1 },
    end: { column: 8, line: 12, offset: 165 },
    source: '&lt;div\n' +
      '  v-bind:a="b"\n' +
      '  v-bind:[c.d]="e"\n' +
      '  :f="g"\n' +
      '  v-on:[h.i].camel\n' +
      '  v-on:click.camel.exact="j"\n' +
      '  @keyup.enter.prevent="k"\n' +
      '  v-if="l &gt; m"\n' +
      '  .n=o\n' +
      '  :p.sync=q\n' +
      '&gt;&lt;/div&gt;'
  },
  codegenNode: undefined
}
--------- div-props ---------
[
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'b',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'a',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-bind:a="b"' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'e',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'c.d',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-bind:[c.d]="e"' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'g',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'f',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: ':f="g"' }
  },
  {
    type: 7,
    name: 'on',
    exp: undefined,
    arg: {
      type: 4,
      content: 'h.i',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    modifiers: [ 'camel' ],
    loc: { start: [Object], end: [Object], source: 'v-on:[h.i].camel' }
  },
  {
    type: 7,
    name: 'on',
    exp: {
      type: 4,
      content: 'j',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'click',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'camel', 'exact' ],
    loc: {
      start: [Object],
      end: [Object],
      source: 'v-on:click.camel.exact="j"'
    }
  },
  {
    type: 7,
    name: 'on',
    exp: {
      type: 4,
      content: 'k',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'keyup',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'enter', 'prevent' ],
    loc: {
      start: [Object],
      end: [Object],
      source: '@keyup.enter.prevent="k"'
    }
  },
  {
    type: 7,
    name: 'if',
    exp: {
      type: 4,
      content: 'l &gt; m',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: undefined,
    modifiers: [],
    loc: { start: [Object], end: [Object], source: 'v-if="l &gt; m"' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'o',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'n',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'prop' ],
    loc: { start: [Object], end: [Object], source: '.n=o' }
  },
  {
    type: 7,
    name: 'bind',
    exp: {
      type: 4,
      content: 'q',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'p',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'sync' ],
    loc: { start: [Object], end: [Object], source: ':p.sync=q' }
  }
]
--------- comp1 ---------
{
  type: 1,
  ns: 0,
  tag: 'Comp1',
  tagType: 1,
  props: [
    {
      type: 7,
      name: 'slot',
      exp: [Object],
      arg: [Object],
      modifiers: [],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 13, offset: 166 },
    end: { column: 20, line: 13, offset: 185 },
    source: '&lt;Comp1 #a="{ b }"/&gt;'
  },
  codegenNode: undefined
}
--------- comp1-slot ---------
[
  {
    type: 7,
    name: 'slot',
    exp: {
      type: 4,
      content: '{ b }',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'a',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [],
    loc: { start: [Object], end: [Object], source: '#a="{ b }"' }
  }
]
--------- comp2 ---------
{
  type: 1,
  ns: 0,
  tag: 'Comp2',
  tagType: 1,
  props: [
    {
      type: 7,
      name: 'slot',
      exp: [Object],
      arg: [Object],
      modifiers: [Array],
      loc: [Object]
    }
  ],
  isSelfClosing: true,
  children: [],
  loc: {
    start: { column: 1, line: 14, offset: 186 },
    end: { column: 32, line: 14, offset: 217 },
    source: '&lt;Comp2 v-slot:foo.bar="{ a }"/&gt;'
  },
  codegenNode: undefined
}
--------- comp2-slot ---------
[
  {
    type: 7,
    name: 'slot',
    exp: {
      type: 4,
      content: '{ a }',
      isStatic: false,
      constType: 0,
      loc: [Object]
    },
    arg: {
      type: 4,
      content: 'foo.bar',
      isStatic: true,
      constType: 3,
      loc: [Object]
    },
    modifiers: [ 'bar' ],
    loc: {
      start: [Object],
      end: [Object],
      source: 'v-slot:foo.bar="{ a }"'
    }
  }
]
undefined
</pre>
          </details>
        </div>
        <div id="outline-container-orge0a06e4" class="outline-4">
          <h4 id="orge0a06e4"><span class=
          "section-number-4">2.10.1.</span> parseAttribute</h4>
          <div class="outline-text-4" id="text-2-10-1">
            <div class="org-src-container">
              <pre class="src src-js" id="orgd046b91"><span class=
              "linenr">  1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">parseAttribute</span>(<span class=
              "org-variable-name">context</span>, <span class=
              "org-variable-name">nameSet</span>) {
<span class="linenr">  2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr">  3: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</span>.exec(context.source)
<span class="linenr">  4: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> = match[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">  5: </span>
<span class="linenr">  6: </span>  nameSet.add(name)
<span class="linenr">  7: </span>
<span class="linenr">  8: </span>  advanceBy(context, name.length)
<span class="linenr">  9: </span>
<span class="linenr"> 10: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">value</span> = <span class=
"org-constant">undefined</span>
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span>  <span class=
"org-keyword">if</span> (<span class=
"org-string">/^[\t\r\n\f ]*=/</span>.test(context.source)) {
<span class="linenr"> 13: </span>    advanceSpaces(context)
<span class=
"linenr"> 14: </span>    advanceBy(context, <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 15: </span>    advanceSpaces(context)
<span class=
"linenr"> 16: </span>    value = parseAttributeValue(context)
<span class="linenr"> 17: </span>  }
<span class="linenr"> 18: </span>
<span class="linenr"> 19: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = getSelection(context, start)
<span class="linenr"> 20: </span>
<span class="linenr"> 21: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on(@), v-bind(:), v-if, v-else, v-slot(#) 指令</span>
<span class="linenr"> 22: </span>  <span class=
"org-keyword">if</span> (!context.inVPre &amp;& <span class=
"org-string">/^(v-[A-Za-z0-9-]|:|\.|@|#)/</span>.test(name)) {
<span class="linenr"> 23: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/(?:^v-([a-z0-9-]+))?(?:(?::|^\.|^@|^#)(\[[^\]]+\]|[^\.]+))?(.+)?$/</span>i.exec(name)
<span class="linenr"> 24: </span>
<span class="linenr"> 25: </span>    log(<span class=
"org-string">`parseAttribute| match=${match}`</span>)
<span class="linenr"> 26: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isPropShorthand</span> = startsWith(name, <span class="org-string">'.'</span>)
<span class="linenr"> 27: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">dirName</span> =
<span class="linenr"> 28: </span>        match[<span class=
"org-highlight-numbers-number">1</span>] ||
<span class=
"linenr"> 29: </span>        (isPropShorthand || startsWith(name, <span class="org-string">':'</span>)
<span class="linenr"> 30: </span>         ? <span class=
"org-string">'bind'</span>
<span class=
"linenr"> 31: </span>         : startsWith(name, <span class=
"org-string">'@'</span>)
<span class="linenr"> 32: </span>        ? <span class=
"org-string">'on'</span>
<span class="linenr"> 33: </span>        : <span class=
"org-string">'slot'</span>)
<span class="linenr"> 34: </span>    <span class=
"org-keyword">let</span> <span class="org-variable-name">arg</span>
<span class="linenr"> 35: </span>
<span class="linenr"> 36: </span>    <span class=
"org-keyword">if</span> (match[<span class=
"org-highlight-numbers-number">2</span>]) {
<span class="linenr"> 37: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSlot</span> = dirName === <span class=
"org-string">'slot'</span>
<span class="linenr"> 38: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">startOffset</span> = name.lastIndexOf(match[<span class="org-highlight-numbers-number">2</span>])
<span class="linenr"> 39: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = getSelection(
<span class="linenr"> 40: </span>        context,
<span class=
"linenr"> 41: </span>        getNewPosition(context, start, startOffset),
<span class="linenr"> 42: </span>        getNewPosition(
<span class="linenr"> 43: </span>          context,
<span class="linenr"> 44: </span>          start,
<span class=
"linenr"> 45: </span>          startOffset + match[<span class=
"org-highlight-numbers-number">2</span>].length + ((isSlot &amp;& match[<span class="org-highlight-numbers-number">3</span>]) || <span class="org-string">''</span>).length
<span class="linenr"> 46: </span>        )
<span class="linenr"> 47: </span>      )
<span class="linenr"> 48: </span>
<span class="linenr"> 49: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">content</span> = match[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 50: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isStatic</span> = <span class=
"org-constant">true</span>
<span class="linenr"> 51: </span>
<span class="linenr"> 52: </span>      <span class=
"org-keyword">if</span> (content.startsWith(<span class=
"org-string">'['</span>)) {
<span class="linenr"> 53: </span>        isStatic = <span class=
"org-constant">false</span>
<span class="linenr"> 54: </span>
<span class=
"linenr"> 55: </span>        content = content.slice(<span class=
"org-highlight-numbers-number">1</span>, content.length - <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 56: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isSlot){
<span class=
"linenr"> 57: </span>        content += match[<span class=
"org-highlight-numbers-number">3</span>] || <span class=
"org-string">''</span>
<span class="linenr"> 58: </span>      }
<span class="linenr"> 59: </span>
<span class="linenr"> 60: </span>      arg = {
<span class=
"linenr"> 61: </span>        type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 62: </span>        content,
<span class="linenr"> 63: </span>        isStatic,
<span class="linenr"> 64: </span>        constType: isStatic
<span class=
"linenr"> 65: </span>          ? ConstantTypes.CAN_STRINGIFY
<span class=
"linenr"> 66: </span>          : ConstantTypes.NOT_CONSTANT,
<span class="linenr"> 67: </span>        loc
<span class="linenr"> 68: </span>      }
<span class="linenr"> 69: </span>    }
<span class="linenr"> 70: </span>
<span class="linenr"> 71: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">quoted: `foo="bar"`, not quoted: `foo=bar`</span>
<span class="linenr"> 72: </span>    <span class=
"org-keyword">if</span> (value &amp;& value.isQuoted) {
<span class="linenr"> 73: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">valueLoc</span> = value.loc
<span class="linenr"> 74: </span>      valueLoc.start.offset++
<span class="linenr"> 75: </span>      valueLoc.start.column++
<span class=
"linenr"> 76: </span>      valueLoc.end = advancePositionWithClone(valueLoc.start, value.content)
<span class=
"linenr"> 77: </span>      valueLoc.source = valueLoc.source.slice(<span class="org-highlight-numbers-number">1</span>, -<span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 78: </span>    }
<span class="linenr"> 79: </span>
<span class="linenr"> 80: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">修饰符 v-bind.number="foo" =&gt; '.number' =&gt; ['number']</span>
<span class="linenr"> 81: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifiers</span> = match[<span class=
"org-highlight-numbers-number">3</span>] ? match[<span class=
"org-highlight-numbers-number">3</span>].slice(<span class=
"org-highlight-numbers-number">1</span>).split(<span class=
"org-string">'.'</span>) : []
<span class="linenr"> 82: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`&lt;div foo.prop="bar"&gt;` 如果不加 `.prop` 这个会被解析到 `$attrs` 中</span>
<span class="linenr"> 83: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如果加了 `.prop` 则会被解析到 `$props` 中去</span>
<span class="linenr"> 84: </span>    <span class=
"org-keyword">if</span> (isPropShorthand) {
<span class="linenr"> 85: </span>      modifiers.push(<span class=
"org-string">'prop'</span>)
<span class="linenr"> 86: </span>    }
<span class="linenr"> 87: </span>
<span class="linenr"> 88: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr"> 89: </span>      type: NodeTypes.DIRECTIVE,
<span class="linenr"> 90: </span>      name: dirName,
<span class="linenr"> 91: </span>      exp: value &amp;& {
<span class=
"linenr"> 92: </span>        type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 93: </span>        content: value.content,
<span class="linenr"> 94: </span>        isStatic: <span class=
"org-constant">false</span>,
<span class="linenr"> 95: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Treat as non-constant by default. This can be potentially set to</span>
<span class="linenr"> 96: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">other values by `transformExpression` to make it eligible for hoisting.</span>
<span class=
"linenr"> 97: </span>        constType: ConstantTypes.NOT_CONSTANT,
<span class="linenr"> 98: </span>        loc: value.loc
<span class="linenr"> 99: </span>      },
<span class="linenr">100: </span>      arg,
<span class="linenr">101: </span>      modifiers,
<span class="linenr">102: </span>      loc
<span class="linenr">103: </span>    }
<span class="linenr">104: </span>  }
<span class="linenr">105: </span>
<span class="linenr">106: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">107: </span>    type: NodeTypes.ATTRIBUTE,
<span class="linenr">108: </span>    name,
<span class="linenr">109: </span>    value: value &amp;& {
<span class="linenr">110: </span>      type: NodeTypes.TEXT,
<span class="linenr">111: </span>      content: value.content,
<span class="linenr">112: </span>      loc: value.loc
<span class="linenr">113: </span>    },
<span class="linenr">114: </span>    loc
<span class="linenr">115: </span>  }
<span class="linenr">116: </span>}
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org4a9c702" class="outline-4">
          <h4 id="org4a9c702"><span class=
          "section-number-4">2.10.2.</span>
          parseAttributeValue</h4>
          <div class="outline-text-4" id="text-2-10-2">
            <p>解析属性的值，区分是不是有引号，如果有引号直接使用引号来计算出值，如是没有引号则 使用
            <code>/^[^\t\t\n\f &gt;]+/</code> 正则来匹配。</p>
            <div class="org-src-container">
              <pre class="src src-js" id="orgd846d41"><span class=
              "linenr"> 1: </span><span class=
              "org-keyword">function</span> <span class=
              "org-function-name">parseAttributeValue</span>(<span class=
              "org-variable-name">context</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 3: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">content</span>
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">quote</span> = context.source[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">value 分两种情况，可以用引号包起来也可以不使用引号</span>
<span class="linenr"> 7: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`&lt;div foo="value"&gt;` 或 `&lt;div foo=value&gt;`</span>
<span class="linenr"> 8: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isQuoted</span> = quote === <span class=
"org-string">`"`</span> || quote === <span class=
"org-string">`'`</span>
<span class="linenr"> 9: </span>  <span class=
"org-keyword">if</span> (isQuoted) {
<span class="linenr">10: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Quoted value.</span>
<span class="linenr">11: </span>    advanceBy(context, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr">12: </span>
<span class="linenr">13: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endIndex</span> = context.source.indexOf(quote)
<span class="linenr">14: </span>    <span class=
"org-keyword">if</span> (endIndex === -<span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">15: </span>      content = parseTextData(
<span class="linenr">16: </span>        context,
<span class="linenr">17: </span>        context.source.length,
<span class="linenr">18: </span>        TextModes.ATTRIBUTE_VALUE
<span class="linenr">19: </span>      )
<span class="linenr">20: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">21: </span>      content = parseTextData(context, endIndex, TextModes.ATTRIBUTE_VALUE)
<span class=
"linenr">22: </span>      advanceBy(context, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr">23: </span>    }
<span class="linenr">24: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">25: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Unquoted</span>
<span class="linenr">26: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[^\t\r\n\f &gt;]+/</span>.exec(context.source)
<span class="linenr">27: </span>    <span class=
"org-keyword">if</span> (!match) {
<span class="linenr">28: </span>      <span class=
"org-keyword">return</span> <span class=
"org-constant">undefined</span>
<span class="linenr">29: </span>    }
<span class=
"linenr">30: </span>    content = parseTextData(context, match[<span class="org-highlight-numbers-number">0</span>].length, TextModes.ATTRIBUTE_VALUE)
<span class="linenr">31: </span>  }
<span class="linenr">32: </span>
<span class="linenr">33: </span>  <span class=
"org-keyword">return</span> { content, isQuoted, loc: getSelection(context, start) }
<span class="linenr">34: </span>}
</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="outline-container-orgb23549d" class="outline-2">
      <h2 id="orgb23549d"><span class="section-number-2">3.</span>
      transform</h2>
    </div>
    <div id="outline-container-org3f26f53" class="outline-2">
      <h2 id="org3f26f53"><span class="section-number-2">4.</span>
      codegen</h2>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Zhicheng Lee</p>
    <p class="date">Created: 2022-04-19 Tue 16:06</p>
  </div>
</body>
</html>
