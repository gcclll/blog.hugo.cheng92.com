<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-05-05 Thu 15:25 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>build your own vue compiler-dom</title>
  <meta name="author" content="Zhicheng Lee">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <link rel="icon" type="image/png" sizes="48x48" href=
  "/favicon.ico">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <link rel="stylesheet" href="/assets/js/fancybox/fancybox.css"
  type="text/css" media="screen">
  <script type="text/javascript" src=
  "/assets/js/fancybox/fancybox.umd.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/apps.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="vue">
  <meta name="tags" content="compiler-dom">
  <meta name="createdAt" content="2022-04-27 14:49:00">
  <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;
        
          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster.bundle.min.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster-sideTip-punk.min.css">
  <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
  </script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster.bundle.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster-scrollableTip.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/tooltips.js"></script>
  <style>
           abbr {color: red;}
        
           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
  </style>
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">build your own vue compiler-dom</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#org1b608bd">1. APIs</a>
          </li>
          <li>
            <a href="#org8137a12">2. transforms</a>
            <ul>
              <li>
                <a href="#orgd77600a">2.1. style</a>
              </li>
              <li>
                <a href="#org9e1ea19">2.2. v-html</a>
              </li>
              <li>
                <a href="#org643a510">2.3. v-text</a>
              </li>
              <li>
                <a href="#org032264e">2.4. v-model</a>
              </li>
              <li>
                <a href="#org9c909f9">2.5. v-on</a>
              </li>
              <li>
                <a href="#orgdbe7e18">2.6. v-show</a>
              </li>
              <li>
                <a href="#org8fb1bee">2.7. stringifyStatic</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org7cef3c2">3. compile()</a>
          </li>
          <li>
            <a href="#orgf5b54fb">4. parse</a>
          </li>
          <li>
            <a href="#org5ae5b01">5. testing</a>
          </li>
        </ul>
      </div>
    </div>
    <p><a href="/"><img src=
    "https://img.shields.io/badge/GCCLL-Homepage-green?logo=gnu-emacs"></a></p>
    <div style=
    "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <h3>Vue3 compiler-dom</h3>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-compiler-dom/">Vue3
      源码头脑风暴之 4 ☞compiler-dom - 若叶知秋</a></p>
      <p>文章最后有交互式的<a href="#orge076d3f">测试方法</a>，可输入想看的模板得到对应的
      render 函数和 AST 。</p>
    </div>
    <p>引入 global variables 和 <a href=
    "../../../../.gclrc/org/roam/build_your_own_vue_compiler_core.html#ID-5eff117f-92ba-490a-ba9c-e5f59e0cbe47">
    build your own vue compiler-core</a> 中的代码。</p><br>
    <details class="code-details" style=
    "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <summary>
        <strong><font face="Courier" size="3" color=
        "green">compiler-core 代码</font></strong>
      </summary>
      <p><a href=
      "https://blog.cheng92.com/posts/build_your_own_vue_compiler_core.html">
      build your own vue compiler-core</a></p>
      <p>#+include ../assets/tests/globalVars.js src js -n -r</p>
      <p>#+include ../assets/tests/globalVarsDom.js src js -n
      -r</p>
      <div class="org-src-container">
        <pre class="src src-js" id="org09ab438"><span class=
        "linenr">   1: </span>  <span class=
        "org-keyword">function</span> <span class=
        "org-function-name">createParserContext</span>(<span class=
        "org-variable-name">content</span>, <span class=
        "org-variable-name">rawOptions</span>) {
<span class="linenr">   2: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">options</span> = extend({}, defaultParserOptions)
<span class="linenr">   3: </span>  
<span class="linenr">   4: </span>    <span class=
"org-keyword">let</span> <span class="org-variable-name">key</span>
<span class="linenr">   5: </span>    <span class=
"org-keyword">for</span> (key <span class=
"org-keyword">in</span> rawOptions) {
<span class="linenr">   6: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">@ts-ignore</span>
<span class="linenr">   7: </span>      options[key] =
<span class=
"linenr">   8: </span>        rawOptions[key] === <span class=
"org-constant">undefined</span>
<span class=
"linenr">   9: </span>          ? defaultParserOptions[key]
<span class="linenr">  10: </span>          : rawOptions[key]
<span class="linenr">  11: </span>    }
<span class="linenr">  12: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">  13: </span>      options,
<span class="linenr">  14: </span>      column: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">  15: </span>      line: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">  16: </span>      offset: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">  17: </span>      originalSource: content,
<span class="linenr">  18: </span>      source: content,
<span class="linenr">  19: </span>      inPre: <span class=
"org-constant">false</span>,
<span class="linenr">  20: </span>      inVPre: <span class=
"org-constant">false</span>,
<span class="linenr">  21: </span>      onWarn: options.onWarn
<span class="linenr">  22: </span>    }
<span class="linenr">  23: </span>  }
<span class="linenr">  24: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createRoot</span>(<span class=
"org-variable-name">children</span>, <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">locStub</span>) {
<span class="linenr">  25: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">  26: </span>      type: NodeTypes.ROOT,
<span class="linenr">  27: </span>      children,
<span class="linenr">  28: </span>      helpers: [],
<span class="linenr">  29: </span>      components: [],
<span class="linenr">  30: </span>      directives: [],
<span class="linenr">  31: </span>      hoists: [],
<span class="linenr">  32: </span>      imports: [],
<span class="linenr">  33: </span>      cached: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">  34: </span>      temps: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">  35: </span>      codegenNode: <span class=
"org-constant">undefined</span>,
<span class="linenr">  36: </span>      loc
<span class="linenr">  37: </span>    }
<span class="linenr">  38: </span>  }
<span class="linenr">  39: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseChildren</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">mode</span>, <span class=
"org-variable-name">ancestors</span>) {
<span class="linenr">  40: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr">  41: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = parent ? parent.ns : Namespaces.HTML
<span class="linenr">  42: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nodes</span> = [] <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">-&gt; ancestors</span>
<span class="linenr">  43: </span>  
<span class="linenr">  44: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. while -&gt; isEnd ? 游标不断往前走直接所以 source 都解析完成</span>
<span class="linenr">  45: </span>    <span class=
"org-keyword">while</span> (!isEnd(context, mode, ancestors)) {
<span class="linenr">  46: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">s</span> = context.source
<span class="linenr">  47: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">node</span> = <span class=
"org-constant">undefined</span>
<span class="linenr">  48: </span>  
<span class="linenr">  49: </span>      <span class=
"org-keyword">if</span> (mode === TextModes.DATA || mode === TextModes.RCDATA) {
<span class="linenr">  50: </span>        <span class=
"org-keyword">if</span> (!context.inVPre &amp;& startsWith(s, context.options.delimiters[<span class="org-highlight-numbers-number">0</span>])) {
<span class="linenr">  51: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">'{{' 插值开始</span>
<span class=
"linenr">  52: </span>          node = parseInterpolation(context, mode)
<span class="linenr">  53: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (mode === TextModes.DATA &amp;& s[<span class="org-highlight-numbers-number">0</span>] === <span class="org-string">'&lt;'</span>) {
<span class="linenr">  54: </span>          <span class=
"org-keyword">if</span> (s[<span class=
"org-highlight-numbers-number">1</span>] === <span class=
"org-string">'/'</span>) {
<span class="linenr">  55: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">结束标签</span>
<span class="linenr">  56: </span>            <span class=
"org-keyword">if</span> (<span class=
"org-string">/[a-z]/</span>i.test(s[<span class=
"org-highlight-numbers-number">2</span>])) {
<span class="linenr">  57: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">异常结束，如：`&lt;div&gt;some text&lt;a`</span>
<span class=
"linenr">  58: </span>              emitError(context, <span class=
"org-string">'X_INVALID_END_TAG'</span>)
<span class=
"linenr">  59: </span>              parseTag(context, TagType.End, parent)
<span class="linenr">  60: </span>              <span class=
"org-keyword">continue</span>
<span class="linenr">  61: </span>            }
<span class="linenr">  62: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (<span class=
"org-string">/[a-z]/</span>i.test(s[<span class=
"org-highlight-numbers-number">1</span>])) {
<span class="linenr">  63: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">正常的开始标签</span>
<span class=
"linenr">  64: </span>            node = parseElement(context, ancestors)
<span class="linenr">  65: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2.x &lt;template&gt; 无指令兼容，这里就不实现了，重点关注 3.x 的代码</span>
<span class="linenr">  66: </span>          }
<span class="linenr">  67: </span>        }
<span class="linenr">  68: </span>      }
<span class="linenr">  69: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">以上都不是，说明应该是纯文本节点</span>
<span class="linenr">  70: </span>      <span class=
"org-keyword">if</span> (!node) {
<span class=
"linenr">  71: </span>        node = parseText(context, mode)
<span class="linenr">  72: </span>      }
<span class="linenr">  73: </span>  
<span class="linenr">  74: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">用 pushNode 在其中合并相邻的文本节点</span>
<span class="linenr">  75: </span>      <span class=
"org-keyword">if</span> (isArray(node)) {
<span class="linenr">  76: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.length; i++) {
<span class=
"linenr">  77: </span>          pushNode(nodes, node[i])
<span class="linenr">  78: </span>        }
<span class="linenr">  79: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">  80: </span>        pushNode(nodes, node)
<span class="linenr">  81: </span>      }
<span class="linenr">  82: </span>    }
<span class="linenr">  83: </span>  
<span class="linenr">  84: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 合并相邻文本节点，空格处理，会将多个空格合并成一个空格</span>
<span class="linenr">  85: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">removedWhitespace</span> = <span class=
"org-constant">false</span>
<span class="linenr">  86: </span>    <span class=
"org-keyword">if</span> (mode !== TextModes.RAWTEXT &amp;& mode !== TextModes.RCDATA) {
<span class=
"linenr">  87: </span>      removedWhitespace = _removeWhitespace(nodes, context)
<span class="linenr">  88: </span>    }
<span class="linenr">  89: </span>  
<span class="linenr">  90: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. 最后返回解析后的节点树</span>
<span class="linenr">  91: </span>    <span class=
"org-keyword">return</span> removedWhitespace ? nodes.filter(Boolean) : nodes
<span class="linenr">  92: </span>  }
<span class="linenr">  93: </span>  
<span class="linenr">  94: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">_removeWhitespace</span>(<span class=
"org-variable-name">nodes</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">  95: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">removedWhitespace</span> = <span class=
"org-constant">false</span>
<span class="linenr">  96: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">可以通过选项来指定是不是保留空格，否则多余的会合并成一个</span>
<span class="linenr">  97: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">shouldCondense</span> = context.options.whitespace !== <span class="org-string">'preserve'</span>
<span class="linenr">  98: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; nodes.length; i++) {
<span class="linenr">  99: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">node</span> = nodes[i]
<span class="linenr"> 100: </span>      <span class=
"org-keyword">if</span> (!context.inPre &amp;& node.type === NodeTypes.TEXT) {
<span class="linenr"> 101: </span>        <span class=
"org-keyword">if</span> (!<span class=
"org-string">/[^\t\r\n\f]/</span>.test(node.content)) {
<span class="linenr"> 102: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prev</span> = nodes[i - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 103: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">next</span> = nodes[i + <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 104: </span>  
<span class="linenr"> 105: </span>          <span class=
"org-keyword">if</span> (
<span class="linenr"> 106: </span>            !prev ||
<span class="linenr"> 107: </span>              !next ||
<span class=
"linenr"> 108: </span>              (shouldCondense &amp;& (
<span class=
"linenr"> 109: </span>                prev.type === NodeTypes.COMMENT || next.type === NodeTypes.COMMENT || (
<span class=
"linenr"> 110: </span>                  prev.type === NodeTypes.ELEMENT &amp;& next.type === NodeTypes.ELEMENT &amp;& <span class="org-string">/[\r\n]/</span>.test(node.content)
<span class="linenr"> 111: </span>                )
<span class="linenr"> 112: </span>              ))
<span class="linenr"> 113: </span>          ) {
<span class=
"linenr"> 114: </span>            removedWhitespace = <span class=
"org-constant">true</span>
<span class=
"linenr"> 115: </span>            nodes[i] = <span class=
"org-constant">null</span>
<span class="linenr"> 116: </span>          } <span class=
"org-keyword">else</span> {
<span class="linenr"> 117: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">合并成一个</span>
<span class=
"linenr"> 118: </span>            node.content = <span class=
"org-string">' '</span>
<span class="linenr"> 119: </span>          }
<span class="linenr"> 120: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (shouldCondense) {
<span class="linenr"> 121: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">保留空格</span>
<span class=
"linenr"> 122: </span>          node.content = node.content.replace(<span class="org-string">/[\t\r\n\f]+/</span>g, <span class="org-string">' '</span>)
<span class="linenr"> 123: </span>        }
<span class="linenr"> 124: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.type === NodeTypes.COMMENT &amp;& !context.options.comments) {
<span class="linenr"> 125: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">可以通过配置删除注释节点</span>
<span class=
"linenr"> 126: </span>        removedWhitespace = <span class=
"org-constant">true</span>
<span class="linenr"> 127: </span>        nodes[i] = <span class=
"org-constant">null</span>
<span class="linenr"> 128: </span>      }
<span class="linenr"> 129: </span>    }
<span class="linenr"> 130: </span>  
<span class="linenr"> 131: </span>    <span class=
"org-keyword">if</span> (context.inPre &amp;& parent &amp;& context.options.isPreTag(parent.tag)) {
<span class="linenr"> 132: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">删除 &lt;pre&gt; 中的第一行的空行</span>
<span class="linenr"> 133: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">first</span> = nodes[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 134: </span>      <span class=
"org-keyword">if</span> (first &amp;& first.type === NodeTypes.TEXT) {
<span class=
"linenr"> 135: </span>        first.content = first.content.replace(<span class="org-string">/^\r?\n/</span>, <span class="org-string">''</span>)
<span class="linenr"> 136: </span>      }
<span class="linenr"> 137: </span>    }
<span class="linenr"> 138: </span>  
<span class="linenr"> 139: </span>    <span class=
"org-keyword">return</span> removedWhitespace
<span class="linenr"> 140: </span>  }
<span class="linenr"> 141: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseElement</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">ancestors</span>) {
<span class="linenr"> 142: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parent</span> = last(ancestors)
<span class="linenr"> 143: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. 解析出开始标签</span>
<span class="linenr"> 144: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">element</span> = parseTag(context, TagType.Start, parent)
<span class="linenr"> 145: </span>  
<span class="linenr"> 146: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">自闭合的标签： &lt;div/&gt;</span>
<span class="linenr"> 147: </span>    <span class=
"org-keyword">if</span> (element.isSelfClosing || context.options.isVoidTag(element.tag)) {
<span class="linenr"> 148: </span>      <span class=
"org-keyword">return</span> element
<span class="linenr"> 149: </span>    }
<span class="linenr"> 150: </span>  
<span class="linenr"> 151: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">children</span>
<span class="linenr"> 152: </span>    ancestors.push(element)
<span class="linenr"> 153: </span>  
<span class="linenr"> 154: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">mode</span> = context.options.getTextMode(element, parent)
<span class="linenr"> 155: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">递归解析子节点</span>
<span class="linenr"> 156: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">children</span> = parseChildren(context, mode, ancestors)
<span class="linenr"> 157: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">解析完出栈 [root, parent1, parent2, ...] 代表层级</span>
<span class="linenr"> 158: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;root&gt;&lt;parent1&gt;&lt;parent2&gt;&lt;/parent&gt;&lt;parent1&gt;&lt;/root&gt; -&gt; 解析过程中通过</span>
<span class="linenr"> 159: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ancestors 来维护这个层级关系</span>
<span class="linenr"> 160: </span>    ancestors.pop()
<span class="linenr"> 161: </span>  
<span class="linenr"> 162: </span>    element.children = children
<span class="linenr"> 163: </span>  
<span class="linenr"> 164: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 解析结束标签</span>
<span class="linenr"> 165: </span>    <span class=
"org-keyword">if</span> (startsWithEndTagOpen(context.source, element.tag)) {
<span class=
"linenr"> 166: </span>      parseTag(context, TagType.End, parent)
<span class="linenr"> 167: </span>    }
<span class="linenr"> 168: </span>  
<span class="linenr"> 169: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">更新解析后节点在源码中的位置信息</span>
<span class=
"linenr"> 170: </span>    element.loc = getSelection(context, element.loc.start)
<span class="linenr"> 171: </span>  
<span class="linenr"> 172: </span>    <span class=
"org-keyword">return</span> element
<span class="linenr"> 173: </span>  }
<span class="linenr"> 174: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseTag</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">type</span>, <span class=
"org-variable-name">parent</span>) {
<span class="linenr"> 175: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. 开始标签</span>
<span class="linenr"> 176: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 177: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">合法标签的正则匹配</span>
<span class="linenr"> 178: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^&lt;\/?([a-z][^\t\r\n\f /&gt;]*)/</span>i.exec(context.source)
<span class="linenr"> 179: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">tag</span> = match[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 180: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = context.options.getNamespace(tag, parent)
<span class="linenr"> 181: </span>  
<span class="linenr"> 182: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">游标前进标签名长度的位置，如： &lt;div id="foo"&gt; -&gt; ` id="foo"&gt;`</span>
<span class=
"linenr"> 183: </span>    advanceBy(context, match[<span class=
"org-highlight-numbers-number">0</span>].length)
<span class="linenr"> 184: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">空格处理</span>
<span class="linenr"> 185: </span>    advanceSpaces(context)
<span class="linenr"> 186: </span>  
<span class="linenr"> 187: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">parse attributes</span>
<span class="linenr"> 188: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">props</span> = parseAttributes(context, type)
<span class="linenr"> 189: </span>  
<span class="linenr"> 190: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span><span class=
"org-comment"> v-pre 检测</span>
<span class="linenr"> 191: </span>  
<span class="linenr"> 192: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. 闭合标签</span>
<span class="linenr"> 193: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isSelfClosing</span> = <span class=
"org-constant">false</span>
<span class="linenr"> 194: </span>    <span class=
"org-keyword">if</span> (context.source.length === <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr"> 195: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">非法情况, ignore</span>
<span class="linenr"> 196: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 197: </span>      isSelfClosing = startsWith(context.source, <span class="org-string">'/&gt;'</span>)
<span class=
"linenr"> 198: </span>      advanceBy(context, isSelfClosing ? <span class="org-highlight-numbers-number">2</span> : <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 199: </span>    }
<span class="linenr"> 200: </span>  
<span class="linenr"> 201: </span>    <span class=
"org-keyword">if</span> (type === TagType.End) {
<span class="linenr"> 202: </span>      <span class=
"org-keyword">return</span>
<span class="linenr"> 203: </span>    }
<span class="linenr"> 204: </span>  
<span class="linenr"> 205: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. 分析出标签的类型</span>
<span class="linenr"> 206: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">tagType</span> = ElementTypes.ELEMENT
<span class="linenr"> 207: </span>    <span class=
"org-keyword">if</span> (!context.inVPre) {
<span class="linenr"> 208: </span>      <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'slot'</span>) {
<span class=
"linenr"> 209: </span>        tagType = ElementTypes.SLOT
<span class="linenr"> 210: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'template'</span>) {
<span class="linenr"> 211: </span>        <span class=
"org-keyword">if</span> (props.some(p =&gt; p.type === NodeTypes.DIRECTIVE &amp;& isSpecialTemplateDirective(p.name))) {
<span class=
"linenr"> 212: </span>          tagType = ElementTypes.TEMPLATE
<span class="linenr"> 213: </span>        }
<span class="linenr"> 214: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isComponent(tag, props, context)) {
<span class=
"linenr"> 215: </span>        tagType = ElementTypes.COMPONENT
<span class="linenr"> 216: </span>      }
<span class="linenr"> 217: </span>    }
<span class="linenr"> 218: </span>  
<span class="linenr"> 219: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr"> 220: </span>      type: NodeTypes.ELEMENT,
<span class="linenr"> 221: </span>      ns,
<span class="linenr"> 222: </span>      tag,
<span class="linenr"> 223: </span>      tagType,
<span class="linenr"> 224: </span>      props,
<span class="linenr"> 225: </span>      isSelfClosing,
<span class="linenr"> 226: </span>      children: [],
<span class=
"linenr"> 227: </span>      loc: getSelection(context, start),
<span class="linenr"> 228: </span>      codegenNode: <span class=
"org-constant">undefined</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">在 transform 阶段生成的产物</span>
<span class="linenr"> 229: </span>    }
<span class="linenr"> 230: </span>  }
<span class="linenr"> 231: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseText</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">mode</span>) {
<span class="linenr"> 232: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endTokens</span> = mode === TextModes.CDATA ? [<span class="org-string">']]&gt;'</span>] : [<span class="org-string">'&lt;'</span>, context.options.delimiters[<span class="org-highlight-numbers-number">0</span>]]
<span class="linenr"> 233: </span>  
<span class="linenr"> 234: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">endIndex</span> = context.source.length
<span class="linenr"> 235: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; endTokens.length; i++) {
<span class="linenr"> 236: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">index</span> = context.source.indexOf(endTokens[i], <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 237: </span>      <span class=
"org-keyword">if</span> (index !== -<span class=
"org-highlight-numbers-number">1</span> &amp;& endIndex &gt; index) {
<span class="linenr"> 238: </span>        endIndex = index
<span class="linenr"> 239: </span>      }
<span class="linenr"> 240: </span>    }
<span class="linenr"> 241: </span>  
<span class="linenr"> 242: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 243: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">content</span> = parseTextData(context, endIndex, mode)
<span class="linenr"> 244: </span>  
<span class="linenr"> 245: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr"> 246: </span>      type: NodeTypes.TEXT,
<span class="linenr"> 247: </span>      content,
<span class=
"linenr"> 248: </span>      loc: getSelection(context, start)
<span class="linenr"> 249: </span>    }
<span class="linenr"> 250: </span>  }
<span class="linenr"> 251: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseTextData</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">length</span>, <span class=
"org-variable-name">mode</span>) {
<span class="linenr"> 252: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawText</span> = context.source.slice(<span class="org-highlight-numbers-number">0</span>, length)
<span class="linenr"> 253: </span>    advanceBy(context, length)
<span class="linenr"> 254: </span>  
<span class="linenr"> 255: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">不含HTML entities</span>
<span class="linenr"> 256: </span>    <span class=
"org-keyword">if</span> (mode === TextModes.RAWTEXT || mode === TextModes.CDATA || !rawText.includes(<span class="org-string">'&amp;'</span>)) {
<span class="linenr"> 257: </span>      <span class=
"org-keyword">return</span> rawText
<span class="linenr"> 258: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 259: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将 &amp;gt; -&gt; `&gt;`, &amp;lt; -&gt; `&lt;`, &amp;amp; -&gt; `&amp;`, &amp;apos; -&gt; `'`, &amp;quot; -&gt; `"`</span>
<span class="linenr"> 260: </span>      <span class=
"org-keyword">return</span> context.options.decodeEntities(rawText, mode === TextModes.ATTRIBUTE_VALUE)
<span class="linenr"> 261: </span>    }
<span class="linenr"> 262: </span>  }
<span class="linenr"> 263: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseInterpolation</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">mode</span>) {
<span class="linenr"> 264: </span>    <span class=
"org-keyword">const</span> [<span class=
"org-variable-name">open</span>, <span class=
"org-variable-name">close</span>] = context.options.delimiters
<span class="linenr"> 265: </span>  
<span class="linenr"> 266: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如： source = "{{ a + b }}"</span>
<span class="linenr"> 267: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">closeIndex = indexOf("}}", "{{".length) = 9</span>
<span class="linenr"> 268: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">closeIndex</span> = context.source.indexOf(close, open.length)
<span class="linenr"> 269: </span>    <span class=
"org-keyword">if</span> (closeIndex === -<span class=
"org-highlight-numbers-number">1</span>) {
<span class=
"linenr"> 270: </span>      emitError(context, <span class=
"org-string">'X_MISSING_INTERPOLATION_END'</span>)
<span class="linenr"> 271: </span>      <span class=
"org-keyword">return</span> <span class=
"org-constant">undefined</span>
<span class="linenr"> 272: </span>    }
<span class="linenr"> 273: </span>  
<span class="linenr"> 274: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 275: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&gt;&gt; 2 -&gt; " a + b }}"</span>
<span class=
"linenr"> 276: </span>    advanceBy(context, open.length)
<span class="linenr"> 277: </span>  
<span class="linenr"> 278: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">{ line, column, offset }</span>
<span class="linenr"> 279: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">innerStart</span> = getCursor(context)
<span class="linenr"> 280: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">innerEnd</span> = getCursor(context)
<span class="linenr"> 281: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">9 - '{{'.length = 7</span>
<span class="linenr"> 282: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawContentLength</span> = closeIndex - open.length
<span class="linenr"> 283: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">" a + b }}".slice(0, 7) =&gt; " a + b "</span>
<span class="linenr"> 284: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawContent</span> = context.source.slice(<span class="org-highlight-numbers-number">0</span>, rawContentLength)
<span class="linenr"> 285: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">preTrimContent</span> = parseTextData(context, rawContentLength, mode)
<span class="linenr"> 286: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">" a + b " =&gt; "a + b"</span>
<span class="linenr"> 287: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">content</span> = preTrimContent.trim()
<span class="linenr"> 288: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">startOffset</span> = preTrimContent.indexOf(content)
<span class="linenr"> 289: </span>    <span class=
"org-keyword">if</span> (startOffset &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr"> 290: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">处理换行问题</span>
<span class=
"linenr"> 291: </span>      advancePositionWithMutation(innerStart, rawContent, startOffset)
<span class="linenr"> 292: </span>    }
<span class="linenr"> 293: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endOffset</span> = rawContentLength - (preTrimContent.length - content.length - startOffset)
<span class=
"linenr"> 294: </span>    advancePositionWithMutation(innerEnd, rawContent, endOffset)
<span class=
"linenr"> 295: </span>    advanceBy(context, close.length)
<span class="linenr"> 296: </span>  
<span class="linenr"> 297: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr"> 298: </span>      type: NodeTypes.INTERPOLATION,
<span class="linenr"> 299: </span>      content: {
<span class=
"linenr"> 300: </span>        type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 301: </span>        isStatic: <span class=
"org-constant">false</span>,
<span class="linenr"> 302: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Set `isConstant` to false by default and will decide in transformExpression</span>
<span class=
"linenr"> 303: </span>        constType: ConstantTypes.NOT_CONSTANT,
<span class="linenr"> 304: </span>        content,
<span class=
"linenr"> 305: </span>        loc: getSelection(context, innerStart, innerEnd)
<span class="linenr"> 306: </span>      },
<span class=
"linenr"> 307: </span>      loc: getSelection(context, start)
<span class="linenr"> 308: </span>    }
<span class="linenr"> 309: </span>  }
<span class="linenr"> 310: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseAttributes</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">type</span>) {
<span class="linenr"> 311: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = []
<span class="linenr"> 312: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">用 set 避免重复属性</span>
<span class="linenr"> 313: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">attributeNames</span> = <span class=
"org-keyword">new</span> <span class="org-type">Set</span>()
<span class="linenr"> 314: </span>    <span class=
"org-keyword">while</span> (
<span class=
"linenr"> 315: </span>      context.source.length &gt; <span class=
"org-highlight-numbers-number">0</span> &amp;&
<span class=
"linenr"> 316: </span>        !startsWith(context.source, <span class="org-string">'&gt;'</span>) &amp;&
<span class=
"linenr"> 317: </span>        !startsWith(context.source, <span class="org-string">'/&gt;'</span>)
<span class="linenr"> 318: </span>    ) {
<span class="linenr"> 319: </span>  
<span class="linenr"> 320: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">一些非法检测, ignore</span>
<span class="linenr"> 321: </span>  
<span class="linenr"> 322: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">attr</span> = parseAttribute(context, attributeNames)
<span class="linenr"> 323: </span>  
<span class="linenr"> 324: </span>      logg(<span class=
"org-string">'ATTR'</span>, attr)
<span class="linenr"> 325: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">去掉 class 之间多余的空格，如： `foo   bar  ` -&gt; `foo bar`</span>
<span class="linenr"> 326: </span>      <span class=
"org-keyword">if</span> (attr.type === NodeTypes.ATTRIBUTE &amp;&
<span class=
"linenr"> 327: </span>         attr.value &amp;& attr.name === <span class="org-string">'class'</span>) {
<span class=
"linenr"> 328: </span>        attr.value.content = attr.value.content.replace(<span class="org-string">/\s+/</span>g, <span class="org-string">' '</span>).trim()
<span class="linenr"> 329: </span>      }
<span class="linenr"> 330: </span>  
<span class="linenr"> 331: </span>      <span class=
"org-keyword">if</span> (type === TagType.Start) {
<span class="linenr"> 332: </span>        props.push(attr)
<span class="linenr"> 333: </span>      }
<span class="linenr"> 334: </span>  
<span class="linenr"> 335: </span>      advanceSpaces(context)
<span class="linenr"> 336: </span>    }
<span class="linenr"> 337: </span>  
<span class="linenr"> 338: </span>    <span class=
"org-keyword">return</span> props
<span class="linenr"> 339: </span>  }
<span class="linenr"> 340: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseAttribute</span>(<span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">nameSet</span>) {
<span class="linenr"> 341: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 342: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[^\t\r\n\f /&gt;][^\t\r\n\f /&gt;=]*/</span>.exec(context.source)
<span class="linenr"> 343: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> = match[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 344: </span>  
<span class="linenr"> 345: </span>    nameSet.add(name)
<span class="linenr"> 346: </span>  
<span class=
"linenr"> 347: </span>    advanceBy(context, name.length)
<span class="linenr"> 348: </span>  
<span class="linenr"> 349: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">value</span> = <span class=
"org-constant">undefined</span>
<span class="linenr"> 350: </span>  
<span class="linenr"> 351: </span>    <span class=
"org-keyword">if</span> (<span class=
"org-string">/^[\t\r\n\f ]*=/</span>.test(context.source)) {
<span class="linenr"> 352: </span>      advanceSpaces(context)
<span class=
"linenr"> 353: </span>      advanceBy(context, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr"> 354: </span>      advanceSpaces(context)
<span class=
"linenr"> 355: </span>      value = parseAttributeValue(context)
<span class="linenr"> 356: </span>    }
<span class="linenr"> 357: </span>  
<span class="linenr"> 358: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = getSelection(context, start)
<span class="linenr"> 359: </span>  
<span class="linenr"> 360: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on(@), v-bind(:), v-if, v-else, v-slot(#) 指令</span>
<span class="linenr"> 361: </span>    <span class=
"org-keyword">if</span> (!context.inVPre &amp;& <span class=
"org-string">/^(v-[A-Za-z0-9-]|:|\.|@|#)/</span>.test(name)) {
<span class="linenr"> 362: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/(?:^v-([a-z0-9-]+))?(?:(?::|^\.|^@|^#)(\[[^\]]+\]|[^\.]+))?(.+)?$/</span>i.exec(name)
<span class="linenr"> 363: </span>  
<span class="linenr"> 364: </span>      log(<span class=
"org-string">`parseAttribute| match=${match}`</span>)
<span class="linenr"> 365: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isPropShorthand</span> = startsWith(name, <span class="org-string">'.'</span>)
<span class="linenr"> 366: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">dirName</span> =
<span class="linenr"> 367: </span>          match[<span class=
"org-highlight-numbers-number">1</span>] ||
<span class=
"linenr"> 368: </span>          (isPropShorthand || startsWith(name, <span class="org-string">':'</span>)
<span class="linenr"> 369: </span>           ? <span class=
"org-string">'bind'</span>
<span class=
"linenr"> 370: </span>           : startsWith(name, <span class=
"org-string">'@'</span>)
<span class="linenr"> 371: </span>          ? <span class=
"org-string">'on'</span>
<span class="linenr"> 372: </span>          : <span class=
"org-string">'slot'</span>)
<span class="linenr"> 373: </span>      <span class=
"org-keyword">let</span> <span class="org-variable-name">arg</span>
<span class="linenr"> 374: </span>  
<span class="linenr"> 375: </span>      <span class=
"org-keyword">if</span> (match[<span class=
"org-highlight-numbers-number">2</span>]) {
<span class="linenr"> 376: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSlot</span> = dirName === <span class=
"org-string">'slot'</span>
<span class="linenr"> 377: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">startOffset</span> = name.lastIndexOf(match[<span class="org-highlight-numbers-number">2</span>])
<span class="linenr"> 378: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = getSelection(
<span class="linenr"> 379: </span>          context,
<span class=
"linenr"> 380: </span>          getNewPosition(context, start, startOffset),
<span class="linenr"> 381: </span>          getNewPosition(
<span class="linenr"> 382: </span>            context,
<span class="linenr"> 383: </span>            start,
<span class=
"linenr"> 384: </span>            startOffset + match[<span class=
"org-highlight-numbers-number">2</span>].length + ((isSlot &amp;& match[<span class="org-highlight-numbers-number">3</span>]) || <span class="org-string">''</span>).length
<span class="linenr"> 385: </span>          )
<span class="linenr"> 386: </span>        )
<span class="linenr"> 387: </span>  
<span class="linenr"> 388: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">content</span> = match[<span class=
"org-highlight-numbers-number">2</span>]
<span class="linenr"> 389: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isStatic</span> = <span class=
"org-constant">true</span>
<span class="linenr"> 390: </span>  
<span class="linenr"> 391: </span>        <span class=
"org-keyword">if</span> (content.startsWith(<span class=
"org-string">'['</span>)) {
<span class="linenr"> 392: </span>          isStatic = <span class=
"org-constant">false</span>
<span class="linenr"> 393: </span>  
<span class=
"linenr"> 394: </span>          content = content.slice(<span class="org-highlight-numbers-number">1</span>, content.length - <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 395: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isSlot){
<span class=
"linenr"> 396: </span>          content += match[<span class=
"org-highlight-numbers-number">3</span>] || <span class=
"org-string">''</span>
<span class="linenr"> 397: </span>        }
<span class="linenr"> 398: </span>  
<span class="linenr"> 399: </span>        arg = {
<span class=
"linenr"> 400: </span>          type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 401: </span>          content,
<span class="linenr"> 402: </span>          isStatic,
<span class="linenr"> 403: </span>          constType: isStatic
<span class=
"linenr"> 404: </span>            ? ConstantTypes.CAN_STRINGIFY
<span class=
"linenr"> 405: </span>            : ConstantTypes.NOT_CONSTANT,
<span class="linenr"> 406: </span>          loc
<span class="linenr"> 407: </span>        }
<span class="linenr"> 408: </span>      }
<span class="linenr"> 409: </span>  
<span class="linenr"> 410: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">quoted: `foo="bar"`, not quoted: `foo=bar`</span>
<span class="linenr"> 411: </span>      <span class=
"org-keyword">if</span> (value &amp;& value.isQuoted) {
<span class="linenr"> 412: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">valueLoc</span> = value.loc
<span class="linenr"> 413: </span>        valueLoc.start.offset++
<span class="linenr"> 414: </span>        valueLoc.start.column++
<span class=
"linenr"> 415: </span>        valueLoc.end = advancePositionWithClone(valueLoc.start, value.content)
<span class=
"linenr"> 416: </span>        valueLoc.source = valueLoc.source.slice(<span class="org-highlight-numbers-number">1</span>, -<span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 417: </span>      }
<span class="linenr"> 418: </span>  
<span class="linenr"> 419: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">修饰符 v-bind.number="foo" =&gt; '.number' =&gt; ['number']</span>
<span class="linenr"> 420: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifiers</span> = match[<span class=
"org-highlight-numbers-number">3</span>] ? match[<span class=
"org-highlight-numbers-number">3</span>].slice(<span class=
"org-highlight-numbers-number">1</span>).split(<span class=
"org-string">'.'</span>) : []
<span class="linenr"> 421: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`&lt;div foo.prop="bar"&gt;` 如果不加 `.prop` 这个会被解析到 `$attrs` 中</span>
<span class="linenr"> 422: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如果加了 `.prop` 则会被解析到 `$props` 中去</span>
<span class="linenr"> 423: </span>      <span class=
"org-keyword">if</span> (isPropShorthand) {
<span class=
"linenr"> 424: </span>        modifiers.push(<span class=
"org-string">'prop'</span>)
<span class="linenr"> 425: </span>      }
<span class="linenr"> 426: </span>  
<span class="linenr"> 427: </span>      <span class=
"org-keyword">return</span> {
<span class=
"linenr"> 428: </span>        type: NodeTypes.DIRECTIVE,
<span class="linenr"> 429: </span>        name: dirName,
<span class="linenr"> 430: </span>        exp: value &amp;& {
<span class=
"linenr"> 431: </span>          type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr"> 432: </span>          content: value.content,
<span class="linenr"> 433: </span>          isStatic: <span class=
"org-constant">false</span>,
<span class="linenr"> 434: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Treat as non-constant by default. This can be potentially set to</span>
<span class="linenr"> 435: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">other values by `transformExpression` to make it eligible for hoisting.</span>
<span class=
"linenr"> 436: </span>          constType: ConstantTypes.NOT_CONSTANT,
<span class="linenr"> 437: </span>          loc: value.loc
<span class="linenr"> 438: </span>        },
<span class="linenr"> 439: </span>        arg,
<span class="linenr"> 440: </span>        modifiers,
<span class="linenr"> 441: </span>        loc
<span class="linenr"> 442: </span>      }
<span class="linenr"> 443: </span>    }
<span class="linenr"> 444: </span>  
<span class="linenr"> 445: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr"> 446: </span>      type: NodeTypes.ATTRIBUTE,
<span class="linenr"> 447: </span>      name,
<span class="linenr"> 448: </span>      value: value &amp;& {
<span class="linenr"> 449: </span>        type: NodeTypes.TEXT,
<span class="linenr"> 450: </span>        content: value.content,
<span class="linenr"> 451: </span>        loc: value.loc
<span class="linenr"> 452: </span>      },
<span class="linenr"> 453: </span>      loc
<span class="linenr"> 454: </span>    }
<span class="linenr"> 455: </span>  }
<span class="linenr"> 456: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseAttributeValue</span>(<span class=
"org-variable-name">context</span>) {
<span class="linenr"> 457: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 458: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">content</span>
<span class="linenr"> 459: </span>  
<span class="linenr"> 460: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">quote</span> = context.source[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 461: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">value 分两种情况，可以用引号包起来也可以不使用引号</span>
<span class="linenr"> 462: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`&lt;div foo="value"&gt;` 或 `&lt;div foo=value&gt;`</span>
<span class="linenr"> 463: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isQuoted</span> = quote === <span class=
"org-string">`"`</span> || quote === <span class=
"org-string">`'`</span>
<span class="linenr"> 464: </span>    <span class=
"org-keyword">if</span> (isQuoted) {
<span class="linenr"> 465: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Quoted value.</span>
<span class=
"linenr"> 466: </span>      advanceBy(context, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr"> 467: </span>  
<span class="linenr"> 468: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">endIndex</span> = context.source.indexOf(quote)
<span class="linenr"> 469: </span>      <span class=
"org-keyword">if</span> (endIndex === -<span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr"> 470: </span>        content = parseTextData(
<span class="linenr"> 471: </span>          context,
<span class="linenr"> 472: </span>          context.source.length,
<span class=
"linenr"> 473: </span>          TextModes.ATTRIBUTE_VALUE
<span class="linenr"> 474: </span>        )
<span class="linenr"> 475: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 476: </span>        content = parseTextData(context, endIndex, TextModes.ATTRIBUTE_VALUE)
<span class=
"linenr"> 477: </span>        advanceBy(context, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr"> 478: </span>      }
<span class="linenr"> 479: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 480: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Unquoted</span>
<span class="linenr"> 481: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">match</span> = <span class=
"org-string">/^[^\t\r\n\f &gt;]+/</span>.exec(context.source)
<span class="linenr"> 482: </span>      <span class=
"org-keyword">if</span> (!match) {
<span class="linenr"> 483: </span>        <span class=
"org-keyword">return</span> <span class=
"org-constant">undefined</span>
<span class="linenr"> 484: </span>      }
<span class=
"linenr"> 485: </span>      content = parseTextData(context, match[<span class="org-highlight-numbers-number">0</span>].length, TextModes.ATTRIBUTE_VALUE)
<span class="linenr"> 486: </span>    }
<span class="linenr"> 487: </span>  
<span class="linenr"> 488: </span>    <span class=
"org-keyword">return</span> { content, isQuoted, loc: getSelection(context, start) }
<span class="linenr"> 489: </span>  }
<span class="linenr"> 490: </span>  
<span class="linenr"> 491: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">baseParse</span>(<span class=
"org-variable-name">content</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr"> 492: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = createParserContext(content, options)
<span class="linenr"> 493: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = getCursor(context)
<span class="linenr"> 494: </span>    <span class=
"org-keyword">return</span> createRoot(
<span class=
"linenr"> 495: </span>      parseChildren(context, TextModes.DATA, []),
<span class=
"linenr"> 496: </span>      getSelection(context, start)
<span class="linenr"> 497: </span>    )
<span class="linenr"> 498: </span>  }
<span class="linenr"> 499: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createTransformContext</span>(
<span class="linenr"> 500: </span>    <span class=
"org-variable-name">root</span>,
<span class="linenr"> 501: </span>    {
<span class="linenr"> 502: </span>      filename = <span class=
"org-string">''</span>,
<span class=
"linenr"> 503: </span>      prefixIdentifiers = <span class=
"org-constant">false</span>,
<span class="linenr"> 504: </span>      hoistStatic = <span class=
"org-constant">false</span>,
<span class=
"linenr"> 505: </span>      cacheHandlers = <span class="org-constant">false</span>,
<span class="linenr"> 506: </span>      nodeTransforms = [],
<span class="linenr"> 507: </span>      directiveTransforms = {},
<span class=
"linenr"> 508: </span>      transformHoist = <span class=
"org-constant">null</span>,
<span class="linenr"> 509: </span>      isBuiltInComponent = NOOP,
<span class="linenr"> 510: </span>      isCustomElement = NOOP,
<span class="linenr"> 511: </span>      expressionPlugins = [],
<span class="linenr"> 512: </span>      scopeId = <span class=
"org-constant">null</span>,
<span class="linenr"> 513: </span>      slotted = <span class=
"org-constant">true</span>,
<span class="linenr"> 514: </span>      ssr = <span class=
"org-constant">false</span>,
<span class="linenr"> 515: </span>      inSSR = <span class=
"org-constant">false</span>,
<span class="linenr"> 516: </span>      ssrCssVars = <span class=
"org-string">``</span>,
<span class=
"linenr"> 517: </span>      bindingMetadata = EMPTY_OBJ,
<span class="linenr"> 518: </span>      inline = <span class=
"org-constant">false</span>,
<span class="linenr"> 519: </span>      isTS = <span class=
"org-constant">false</span>,
<span class="linenr"> 520: </span>      onError = defaultOnError,
<span class="linenr"> 521: </span>      onWarn = defaultOnWarn,
<span class="linenr"> 522: </span>      compatConfig
<span class="linenr"> 523: </span>    }
<span class="linenr"> 524: </span>  ) {
<span class="linenr"> 525: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nameMatch</span> = filename.replace(<span class="org-string">/\?.*$/</span>, <span class="org-string">''</span>).match(<span class="org-string">/([^/\\]+)\.\w+$/</span>)
<span class="linenr"> 526: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = {
<span class="linenr"> 527: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">options</span>
<span class=
"linenr"> 528: </span>      selfName: nameMatch &amp;& capitalize(camelize(nameMatch[<span class="org-highlight-numbers-number">1</span>])),
<span class="linenr"> 529: </span>      prefixIdentifiers,
<span class="linenr"> 530: </span>      hoistStatic,
<span class="linenr"> 531: </span>      cacheHandlers,
<span class="linenr"> 532: </span>      nodeTransforms,
<span class="linenr"> 533: </span>      directiveTransforms,
<span class="linenr"> 534: </span>      transformHoist,
<span class="linenr"> 535: </span>      isBuiltInComponent,
<span class="linenr"> 536: </span>      isCustomElement,
<span class="linenr"> 537: </span>      expressionPlugins,
<span class="linenr"> 538: </span>      scopeId,
<span class="linenr"> 539: </span>      slotted,
<span class="linenr"> 540: </span>      ssr,
<span class="linenr"> 541: </span>      inSSR,
<span class="linenr"> 542: </span>      ssrCssVars,
<span class="linenr"> 543: </span>      bindingMetadata,
<span class="linenr"> 544: </span>      inline,
<span class="linenr"> 545: </span>      isTS,
<span class="linenr"> 546: </span>      onError,
<span class="linenr"> 547: </span>      onWarn,
<span class="linenr"> 548: </span>      compatConfig,
<span class="linenr"> 549: </span>  
<span class="linenr"> 550: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">state</span>
<span class="linenr"> 551: </span>      root,
<span class="linenr"> 552: </span>      helpers: <span class=
"org-keyword">new</span> <span class="org-type">Map</span>(),
<span class="linenr"> 553: </span>      components: <span class=
"org-keyword">new</span> <span class="org-type">Set</span>(),
<span class="linenr"> 554: </span>      directives: <span class=
"org-keyword">new</span> <span class="org-type">Set</span>(),
<span class="linenr"> 555: </span>      hoists: [],
<span class="linenr"> 556: </span>      imports: [],
<span class="linenr"> 557: </span>      constantCache: <span class=
"org-keyword">new</span> <span class="org-type">Map</span>(),
<span class="linenr"> 558: </span>      temps: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 559: </span>      cached: <span class=
"org-highlight-numbers-number">0</span>,
<span class=
"linenr"> 560: </span>      identifiers: Object.create(<span class=
"org-constant">null</span>),
<span class="linenr"> 561: </span>      scopes: { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">记录下面四个指令的嵌套层次</span>
<span class="linenr"> 562: </span>        vFor: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 563: </span>        vSlot: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 564: </span>        vPre: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 565: </span>        vOnce: <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 566: </span>      },
<span class="linenr"> 567: </span>      parent: <span class=
"org-constant">null</span>,
<span class="linenr"> 568: </span>      currentNode: root,
<span class="linenr"> 569: </span>      childIndex: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr"> 570: </span>      inVOnce: <span class=
"org-constant">false</span>,
<span class="linenr"> 571: </span>  
<span class="linenr"> 572: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">methods</span>
<span class="linenr"> 573: </span>      helper(name) {
<span class="linenr"> 574: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">count</span> = context.helpers.get(name) || <span class="org-highlight-numbers-number">0</span>
<span class=
"linenr"> 575: </span>        context.helpers.set(name, count + <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 576: </span>        <span class=
"org-keyword">return</span> name
<span class="linenr"> 577: </span>      },
<span class="linenr"> 578: </span>      removeHelper(name) {
<span class="linenr"> 579: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">count</span> = context.helpers.get(name)
<span class="linenr"> 580: </span>        <span class=
"org-keyword">if</span> (count) {
<span class="linenr"> 581: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">currentCount</span> = count - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr"> 582: </span>          <span class=
"org-keyword">if</span> (!currentCount) {
<span class=
"linenr"> 583: </span>            context.helpers.<span class=
"org-keyword">delete</span>(name)
<span class="linenr"> 584: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 585: </span>            context.helpers.set(name, currentCount)
<span class="linenr"> 586: </span>          }
<span class="linenr"> 587: </span>        }
<span class="linenr"> 588: </span>      },
<span class="linenr"> 589: </span>      helperString(name) {
<span class="linenr"> 590: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`_${helperNameMap[context.helper(name)]}`</span>
<span class="linenr"> 591: </span>      },
<span class="linenr"> 592: </span>      replaceNode(node) {
<span class=
"linenr"> 593: </span>        context.parent.children[context.childIndex] = context.currentNode = node
<span class="linenr"> 594: </span>      },
<span class="linenr"> 595: </span>      removeNode(node) {
<span class="linenr"> 596: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">list</span> = context.parent.children
<span class="linenr"> 597: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">removalIndex</span> = node
<span class="linenr"> 598: </span>          ? list.indexOf(node)
<span class="linenr"> 599: </span>          : context.currentNode
<span class="linenr"> 600: </span>          ? context.childIndex
<span class="linenr"> 601: </span>          : -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr"> 602: </span>  
<span class="linenr"> 603: </span>        <span class=
"org-keyword">if</span> (!node || node === context.currentNode) {
<span class="linenr"> 604: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">current node removed</span>
<span class=
"linenr"> 605: </span>          context.currentNode = <span class=
"org-constant">null</span>
<span class="linenr"> 606: </span>          context.onNodeRemoved()
<span class="linenr"> 607: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr"> 608: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">sibling node removed</span>
<span class="linenr"> 609: </span>          <span class=
"org-keyword">if</span> (context.childIndex &gt; removalIndex) {
<span class="linenr"> 610: </span>            context.childIndex--
<span class=
"linenr"> 611: </span>            context.onNodeRemoved()
<span class="linenr"> 612: </span>          }
<span class="linenr"> 613: </span>        }
<span class=
"linenr"> 614: </span>        context.parent.children.splice(removalIndex, <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 615: </span>      },
<span class="linenr"> 616: </span>      onNodeRemoved: () =&gt; {},
<span class="linenr"> 617: </span>      addIdentifiers(exp) {
<span class="linenr"> 618: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">identifier tracking only happens in non-browser builds.</span>
<span class="linenr"> 619: </span>        <span class=
"org-keyword">if</span> (!__BROWSER__) {
<span class="linenr"> 620: </span>          <span class=
"org-keyword">if</span> (isString(exp)) {
<span class="linenr"> 621: </span>            addId(exp)
<span class="linenr"> 622: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.identifiers) {
<span class=
"linenr"> 623: </span>            exp.identifiers.forEach(addId)
<span class="linenr"> 624: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr"> 625: </span>            addId(exp.content)
<span class="linenr"> 626: </span>          }
<span class="linenr"> 627: </span>        }
<span class="linenr"> 628: </span>      },
<span class="linenr"> 629: </span>      removeIdentifiers(exp) {
<span class="linenr"> 630: </span>        <span class=
"org-keyword">if</span> (!__BROWSER__) {
<span class="linenr"> 631: </span>          <span class=
"org-keyword">if</span> (isString(exp)) {
<span class="linenr"> 632: </span>            removeId(exp)
<span class="linenr"> 633: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.identifiers) {
<span class=
"linenr"> 634: </span>            exp.identifiers.forEach(removeId)
<span class="linenr"> 635: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr"> 636: </span>            removeId(exp.content)
<span class="linenr"> 637: </span>          }
<span class="linenr"> 638: </span>        }
<span class="linenr"> 639: </span>      },
<span class="linenr"> 640: </span>      hoist(exp) {
<span class="linenr"> 641: </span>        <span class=
"org-keyword">if</span> (isString(exp)) exp = createSimpleExpression(exp)
<span class="linenr"> 642: </span>        context.hoists.push(exp)
<span class="linenr"> 643: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">identifier</span> = createSimpleExpression(
<span class="linenr"> 644: </span>          <span class=
"org-string">`_hoisted_${context.hoists.length}`</span>,
<span class="linenr"> 645: </span>          <span class=
"org-constant">false</span>,
<span class="linenr"> 646: </span>          exp.loc,
<span class="linenr"> 647: </span>          ConstantTypes.CAN_HOIST
<span class="linenr"> 648: </span>        )
<span class="linenr"> 649: </span>        identifier.hoisted = exp
<span class="linenr"> 650: </span>        <span class=
"org-keyword">return</span> identifier
<span class="linenr"> 651: </span>      },
<span class=
"linenr"> 652: </span>      cache(exp, isVNode = <span class=
"org-constant">false</span>) {
<span class="linenr"> 653: </span>        <span class=
"org-keyword">return</span> createCacheExpression(context.cached++, exp, isVNode)
<span class="linenr"> 654: </span>      }
<span class="linenr"> 655: </span>    }
<span class="linenr"> 656: </span>  
<span class="linenr"> 657: </span>    <span class=
"org-keyword">function</span> <span class=
"org-function-name">addId</span>(<span class=
"org-variable-name">id</span>) {
<span class="linenr"> 658: </span>      <span class=
"org-keyword">const</span> { identifiers } = context
<span class="linenr"> 659: </span>      <span class=
"org-keyword">if</span> (identifiers[id] === <span class=
"org-constant">undefined</span>) {
<span class=
"linenr"> 660: </span>        identifiers[id] = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 661: </span>      }
<span class="linenr"> 662: </span>      identifiers[id]++
<span class="linenr"> 663: </span>    }
<span class="linenr"> 664: </span>  
<span class="linenr"> 665: </span>    <span class=
"org-keyword">function</span> <span class=
"org-function-name">removeId</span>(<span class=
"org-variable-name">id</span>) {
<span class="linenr"> 666: </span>      context.identifiers[id]--
<span class="linenr"> 667: </span>    }
<span class="linenr"> 668: </span>  
<span class="linenr"> 669: </span>    <span class=
"org-keyword">return</span> context
<span class="linenr"> 670: </span>  }
<span class="linenr"> 671: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">traverseNode</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr"> 672: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">记录当前正在处理的节点</span>
<span class="linenr"> 673: </span>    context.currentNode = node
<span class="linenr"> 674: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">对节点转换时使用到的插件(外部可通过这个来修改某个指令)</span>
<span class="linenr"> 675: </span>    <span class=
"org-keyword">const</span> { nodeTransforms } = context
<span class="linenr"> 676: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">递归遍历结束，回溯时调用的函数列表</span>
<span class="linenr"> 677: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">也就是这个函数最后执行的函数，当一颗树遍历完成执行的函数</span>
<span class="linenr"> 678: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">随后的 for 循环是用来收集这些函数的</span>
<span class="linenr"> 679: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exitFns</span> = []
<span class="linenr"> 680: </span>  
<span class="linenr"> 681: </span>    logg(<span class=
"org-string">'traverseNode'</span>, node)
<span class="linenr"> 682: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; nodeTransforms.length; i++) {
<span class="linenr"> 683: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = nodeTransforms[i](node, context)
<span class="linenr"> 684: </span>      <span class=
"org-keyword">if</span> (onExit) {
<span class="linenr"> 685: </span>        <span class=
"org-keyword">if</span> (isArray(onExit)) {
<span class="linenr"> 686: </span>          exitFns.push(...onExit)
<span class="linenr"> 687: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr"> 688: </span>          exitFns.push(onExit)
<span class="linenr"> 689: </span>        }
<span class="linenr"> 690: </span>      }
<span class="linenr"> 691: </span>      <span class=
"org-keyword">if</span> (!context.currentNode) {
<span class="linenr"> 692: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node was removed</span>
<span class="linenr"> 693: </span>        <span class=
"org-keyword">return</span>
<span class="linenr"> 694: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr"> 695: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node may have been replaced</span>
<span class=
"linenr"> 696: </span>        node = context.currentNode
<span class="linenr"> 697: </span>      }
<span class="linenr"> 698: </span>    }
<span class="linenr"> 699: </span>  
<span class="linenr"> 700: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">根据节点类型来分别处理，这里忽略注释</span>
<span class="linenr"> 701: </span>    <span class=
"org-keyword">switch</span> (node.type) {
<span class="linenr"> 702: </span>      <span class=
"org-keyword">case</span> NodeTypes.INTERPOLATION:
<span class="linenr"> 703: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no need to traverse, but we need to inject toString helper</span>
<span class="linenr"> 704: </span>        <span class=
"org-keyword">if</span> (!context.ssr) {
<span class=
"linenr"> 705: </span>          context.helper(TO_DISPLAY_STRING)
<span class="linenr"> 706: </span>        }
<span class="linenr"> 707: </span>        <span class=
"org-keyword">break</span>
<span class="linenr"> 708: </span>  
<span class="linenr"> 709: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for container types, further traverse downwards</span>
<span class="linenr"> 710: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">处理 if...else if...else 分支</span>
<span class="linenr"> 711: </span>      <span class=
"org-keyword">case</span> NodeTypes.IF:
<span class="linenr"> 712: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.branches.length; i++) {
<span class=
"linenr"> 713: </span>          traverseNode(node.branches[i], context)
<span class="linenr"> 714: </span>        }
<span class="linenr"> 715: </span>        <span class=
"org-keyword">break</span>
<span class="linenr"> 716: </span>      <span class=
"org-keyword">case</span> NodeTypes.IF_BRANCH: <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">else..if</span>
<span class="linenr"> 717: </span>      <span class=
"org-keyword">case</span> NodeTypes.FOR: <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for</span>
<span class="linenr"> 718: </span>      <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr"> 719: </span>      <span class=
"org-keyword">case</span> NodeTypes.ROOT:
<span class=
"linenr"> 720: </span>        traverseChildren(node, context)
<span class="linenr"> 721: </span>        <span class=
"org-keyword">break</span>
<span class="linenr"> 722: </span>    }
<span class="linenr"> 723: </span>  
<span class="linenr"> 724: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">收集完成，执行这些收集到的函数，作用到当前节点上</span>
<span class="linenr"> 725: </span>    context.currentNode = node
<span class="linenr"> 726: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = exitFns.length
<span class="linenr"> 727: </span>    <span class=
"org-keyword">while</span> (i--) {
<span class="linenr"> 728: </span>      exitFns[i]()
<span class="linenr"> 729: </span>    }
<span class="linenr"> 730: </span>  }
<span class="linenr"> 731: </span>  
<span class="linenr"> 732: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">traverseChildren</span>(<span class=
"org-variable-name">parent</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr"> 733: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 734: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nodeRemoved</span> = () =&gt; {
<span class="linenr"> 735: </span>      i--
<span class="linenr"> 736: </span>    }
<span class="linenr"> 737: </span>    <span class=
"org-keyword">for</span> (; i &lt; parent.children.length; i++) {
<span class="linenr"> 738: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = parent.children[i]
<span class="linenr"> 739: </span>      <span class=
"org-keyword">if</span> (isString(child)) <span class=
"org-keyword">continue</span>
<span class="linenr"> 740: </span>      context.parent = parent
<span class="linenr"> 741: </span>      context.childIndex = i
<span class=
"linenr"> 742: </span>      context.onNodeRemoved = nodeRemoved
<span class=
"linenr"> 743: </span>      traverseNode(child, context)
<span class="linenr"> 744: </span>    }
<span class="linenr"> 745: </span>  }
<span class="linenr"> 746: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">hoistStatic</span>(<span class=
"org-variable-name">root</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr"> 747: </span>    _walk(
<span class="linenr"> 748: </span>      root,
<span class="linenr"> 749: </span>      context,
<span class="linenr"> 750: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Root node is unfortunately non-hoistable due to potential parent</span>
<span class="linenr"> 751: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fallthrough attributes.</span>
<span class=
"linenr"> 752: </span>      isSingleElementRoot(root, root.children[<span class="org-highlight-numbers-number">0</span>])
<span class="linenr"> 753: </span>    )
<span class="linenr"> 754: </span>  }
<span class="linenr"> 755: </span>  
<span class="linenr"> 756: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">isSingleElementRoot</span>(
<span class="linenr"> 757: </span>    <span class=
"org-variable-name">root</span>,
<span class="linenr"> 758: </span>    child
<span class="linenr"> 759: </span>  ) {
<span class="linenr"> 760: </span>    <span class=
"org-keyword">const</span> { children } = root
<span class="linenr"> 761: </span>    <span class=
"org-keyword">return</span> (
<span class=
"linenr"> 762: </span>      children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;&
<span class=
"linenr"> 763: </span>      child.type === NodeTypes.ELEMENT &amp;&
<span class="linenr"> 764: </span>      !isSlotOutlet(child)
<span class="linenr"> 765: </span>    )
<span class="linenr"> 766: </span>  }
<span class="linenr"> 767: </span>  
<span class="linenr"> 768: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">_walk</span>(
<span class="linenr"> 769: </span>    <span class=
"org-variable-name">node</span>,
<span class="linenr"> 770: </span>    <span class=
"org-variable-name">context</span>,
<span class="linenr"> 771: </span>    doNotHoistNode = <span class=
"org-constant">false</span>
<span class="linenr"> 772: </span>  ) {
<span class="linenr"> 773: </span>    <span class=
"org-keyword">const</span> { children } = node
<span class="linenr"> 774: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">originalCount</span> = children.length
<span class="linenr"> 775: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hoistedCount</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 776: </span>  
<span class="linenr"> 777: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; children.length; i++) {
<span class="linenr"> 778: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[i]
<span class="linenr"> 779: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">only plain elements & text calls are eligible for hoisting.</span>
<span class="linenr"> 780: </span>      <span class=
"org-keyword">if</span> (
<span class=
"linenr"> 781: </span>        child.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr"> 782: </span>        child.tagType === ElementTypes.ELEMENT
<span class="linenr"> 783: </span>      ) {
<span class="linenr"> 784: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">constantType</span> = doNotHoistNode
<span class=
"linenr"> 785: </span>          ? ConstantTypes.NOT_CONSTANT
<span class=
"linenr"> 786: </span>          : getConstantType(child, context)
<span class="linenr"> 787: </span>        <span class=
"org-keyword">if</span> (constantType &gt; ConstantTypes.NOT_CONSTANT) {
<span class="linenr"> 788: </span>          <span class=
"org-keyword">if</span> (constantType &gt;= ConstantTypes.CAN_HOIST) {
<span class=
"linenr"> 789: </span>            child.codegenNode.patchFlag =
<span class=
"linenr"> 790: </span>              PatchFlags.HOISTED + (__DEV__ ? <span class="org-string">` /* HOISTED */`</span> : <span class="org-string">``</span>)
<span class=
"linenr"> 791: </span>            child.codegenNode = context.hoist(child.codegenNode)
<span class="linenr"> 792: </span>            hoistedCount++
<span class="linenr"> 793: </span>            <span class=
"org-keyword">continue</span>
<span class="linenr"> 794: </span>          }
<span class="linenr"> 795: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr"> 796: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node may contain dynamic children, but its props may be eligible for</span>
<span class="linenr"> 797: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">hoisting.</span>
<span class="linenr"> 798: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = child.codegenNode
<span class="linenr"> 799: </span>          <span class=
"org-keyword">if</span> (codegenNode.type === NodeTypes.VNODE_CALL) {
<span class="linenr"> 800: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">flag</span> = getPatchFlag(codegenNode)
<span class="linenr"> 801: </span>            <span class=
"org-keyword">if</span> (
<span class="linenr"> 802: </span>              (!flag ||
<span class=
"linenr"> 803: </span>                flag === PatchFlags.NEED_PATCH ||
<span class=
"linenr"> 804: </span>                flag === PatchFlags.TEXT) &amp;&
<span class=
"linenr"> 805: </span>              getGeneratedPropsConstantType(child, context) &gt;=
<span class=
"linenr"> 806: </span>                ConstantTypes.CAN_HOIST
<span class="linenr"> 807: </span>            ) {
<span class="linenr"> 808: </span>              <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = getNodeProps(child)
<span class="linenr"> 809: </span>              <span class=
"org-keyword">if</span> (props) {
<span class=
"linenr"> 810: </span>                codegenNode.props = context.hoist(props)
<span class="linenr"> 811: </span>              }
<span class="linenr"> 812: </span>            }
<span class="linenr"> 813: </span>            <span class=
"org-keyword">if</span> (codegenNode.dynamicProps) {
<span class=
"linenr"> 814: </span>              codegenNode.dynamicProps = context.hoist(codegenNode.dynamicProps)
<span class="linenr"> 815: </span>            }
<span class="linenr"> 816: </span>          }
<span class="linenr"> 817: </span>        }
<span class="linenr"> 818: </span>      } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class=
"linenr"> 819: </span>        child.type === NodeTypes.TEXT_CALL &amp;&
<span class=
"linenr"> 820: </span>        getConstantType(child.content, context) &gt;= ConstantTypes.CAN_HOIST
<span class="linenr"> 821: </span>      ) {
<span class=
"linenr"> 822: </span>        child.codegenNode = context.hoist(child.codegenNode)
<span class="linenr"> 823: </span>        hoistedCount++
<span class="linenr"> 824: </span>      }
<span class="linenr"> 825: </span>  
<span class="linenr"> 826: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">walk further</span>
<span class="linenr"> 827: </span>      <span class=
"org-keyword">if</span> (child.type === NodeTypes.ELEMENT) {
<span class="linenr"> 828: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isComponent</span> = child.tagType === ElementTypes.COMPONENT
<span class="linenr"> 829: </span>        <span class=
"org-keyword">if</span> (isComponent) {
<span class="linenr"> 830: </span>          context.scopes.vSlot++
<span class="linenr"> 831: </span>        }
<span class="linenr"> 832: </span>        _walk(child, context)
<span class="linenr"> 833: </span>        <span class=
"org-keyword">if</span> (isComponent) {
<span class="linenr"> 834: </span>          context.scopes.vSlot--
<span class="linenr"> 835: </span>        }
<span class="linenr"> 836: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (child.type === NodeTypes.FOR) {
<span class="linenr"> 837: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Do not hoist v-for single child because it has to be a block</span>
<span class=
"linenr"> 838: </span>        _walk(child, context, child.children.length === <span class="org-highlight-numbers-number">1</span>)
<span class="linenr"> 839: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (child.type === NodeTypes.IF) {
<span class="linenr"> 840: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; child.branches.length; i++) {
<span class="linenr"> 841: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Do not hoist v-if single child because it has to be a block</span>
<span class="linenr"> 842: </span>          _walk(
<span class="linenr"> 843: </span>            child.branches[i],
<span class="linenr"> 844: </span>            context,
<span class=
"linenr"> 845: </span>            child.branches[i].children.length === <span class="org-highlight-numbers-number">1</span>
<span class="linenr"> 846: </span>          )
<span class="linenr"> 847: </span>        }
<span class="linenr"> 848: </span>      }
<span class="linenr"> 849: </span>    }
<span class="linenr"> 850: </span>  
<span class="linenr"> 851: </span>    <span class=
"org-keyword">if</span> (hoistedCount &amp;& context.transformHoist) {
<span class="linenr"> 852: </span>      logg(<span class=
"org-string">`hoist walk -&gt; transformHoist, hoistedCount = ${hoistedCount}`</span>)
<span class=
"linenr"> 853: </span>      context.transformHoist(children, context, node)
<span class="linenr"> 854: </span>    }
<span class="linenr"> 855: </span>  
<span class="linenr"> 856: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">all children were hoisted - the entire children array is hoistable.</span>
<span class="linenr"> 857: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr"> 858: </span>      hoistedCount &amp;&
<span class=
"linenr"> 859: </span>      hoistedCount === originalCount &amp;&
<span class=
"linenr"> 860: </span>      node.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr"> 861: </span>      node.tagType === ElementTypes.ELEMENT &amp;&
<span class="linenr"> 862: </span>      node.codegenNode &amp;&
<span class=
"linenr"> 863: </span>      node.codegenNode.type === NodeTypes.VNODE_CALL &amp;&
<span class=
"linenr"> 864: </span>      isArray(node.codegenNode.children)
<span class="linenr"> 865: </span>    ) {
<span class=
"linenr"> 866: </span>      node.codegenNode.children = context.hoist(
<span class=
"linenr"> 867: </span>        createArrayExpression(node.codegenNode.children)
<span class="linenr"> 868: </span>      )
<span class="linenr"> 869: </span>    }
<span class="linenr"> 870: </span>  }
<span class="linenr"> 871: </span>  
<span class="linenr"> 872: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getConstantType</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr"> 873: </span>    <span class=
"org-keyword">const</span> { constantCache } = context
<span class="linenr"> 874: </span>    <span class=
"org-keyword">switch</span> (node.type) {
<span class="linenr"> 875: </span>      <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr"> 876: </span>        <span class=
"org-keyword">if</span> (node.tagType !== ElementTypes.ELEMENT) {
<span class="linenr"> 877: </span>          <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 878: </span>        }
<span class="linenr"> 879: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">cached</span> = constantCache.get(node)
<span class="linenr"> 880: </span>        <span class=
"org-keyword">if</span> (cached !== <span class=
"org-constant">undefined</span>) {
<span class="linenr"> 881: </span>          <span class=
"org-keyword">return</span> cached
<span class="linenr"> 882: </span>        }
<span class="linenr"> 883: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = node.codegenNode
<span class="linenr"> 884: </span>        <span class=
"org-keyword">if</span> (codegenNode.type !== NodeTypes.VNODE_CALL) {
<span class="linenr"> 885: </span>          <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 886: </span>        }
<span class="linenr"> 887: </span>        <span class=
"org-keyword">if</span> (
<span class=
"linenr"> 888: </span>          codegenNode.isBlock &amp;&
<span class=
"linenr"> 889: </span>          node.tag !== <span class=
"org-string">'svg'</span> &amp;&
<span class=
"linenr"> 890: </span>          node.tag !== <span class=
"org-string">'foreignObject'</span>
<span class="linenr"> 891: </span>        ) {
<span class="linenr"> 892: </span>          <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 893: </span>        }
<span class="linenr"> 894: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">flag</span> = getPatchFlag(codegenNode)
<span class="linenr"> 895: </span>        <span class=
"org-keyword">if</span> (!flag) {
<span class="linenr"> 896: </span>          <span class=
"org-keyword">let</span> <span class=
"org-variable-name">returnType</span> = ConstantTypes.CAN_STRINGIFY
<span class="linenr"> 897: </span>  
<span class="linenr"> 898: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Element itself has no patch flag. However we still need to check:</span>
<span class="linenr"> 899: </span>  
<span class="linenr"> 900: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Even for a node with no patch flag, it is possible for it to contain</span>
<span class="linenr"> 901: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">non-hoistable expressions that refers to scope variables, e.g. compiler</span>
<span class="linenr"> 902: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">injected keys or cached event handlers. Therefore we need to always</span>
<span class="linenr"> 903: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check the codegenNode's props to be sure.</span>
<span class="linenr"> 904: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">generatedPropsType</span> = getGeneratedPropsConstantType(node, context)
<span class="linenr"> 905: </span>          <span class=
"org-keyword">if</span> (generatedPropsType === ConstantTypes.NOT_CONSTANT) {
<span class=
"linenr"> 906: </span>            constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr"> 907: </span>            <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 908: </span>          }
<span class="linenr"> 909: </span>          <span class=
"org-keyword">if</span> (generatedPropsType &lt; returnType) {
<span class=
"linenr"> 910: </span>            returnType = generatedPropsType
<span class="linenr"> 911: </span>          }
<span class="linenr"> 912: </span>  
<span class="linenr"> 913: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. its children.</span>
<span class="linenr"> 914: </span>          <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class="linenr"> 915: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">childType</span> = getConstantType(node.children[i], context)
<span class="linenr"> 916: </span>            <span class=
"org-keyword">if</span> (childType === ConstantTypes.NOT_CONSTANT) {
<span class=
"linenr"> 917: </span>              constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr"> 918: </span>              <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 919: </span>            }
<span class="linenr"> 920: </span>            <span class=
"org-keyword">if</span> (childType &lt; returnType) {
<span class=
"linenr"> 921: </span>              returnType = childType
<span class="linenr"> 922: </span>            }
<span class="linenr"> 923: </span>          }
<span class="linenr"> 924: </span>  
<span class="linenr"> 925: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. if the type is not already CAN_SKIP_PATCH which is the lowest non-0</span>
<span class="linenr"> 926: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">type, check if any of the props can cause the type to be lowered</span>
<span class="linenr"> 927: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we can skip can_patch because it's guaranteed by the absence of a</span>
<span class="linenr"> 928: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag.</span>
<span class="linenr"> 929: </span>          <span class=
"org-keyword">if</span> (returnType &gt; ConstantTypes.CAN_SKIP_PATCH) {
<span class="linenr"> 930: </span>            <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr"> 931: </span>              <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr"> 932: </span>              <span class=
"org-keyword">if</span> (p.type === NodeTypes.DIRECTIVE &amp;& p.name === <span class="org-string">'bind'</span> &amp;& p.exp) {
<span class="linenr"> 933: </span>                <span class=
"org-keyword">const</span> <span class=
"org-variable-name">expType</span> = getConstantType(p.exp, context)
<span class="linenr"> 934: </span>                <span class=
"org-keyword">if</span> (expType === ConstantTypes.NOT_CONSTANT) {
<span class=
"linenr"> 935: </span>                  constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr"> 936: </span>                  <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 937: </span>                }
<span class="linenr"> 938: </span>                <span class=
"org-keyword">if</span> (expType &lt; returnType) {
<span class=
"linenr"> 939: </span>                  returnType = expType
<span class="linenr"> 940: </span>                }
<span class="linenr"> 941: </span>              }
<span class="linenr"> 942: </span>            }
<span class="linenr"> 943: </span>          }
<span class="linenr"> 944: </span>  
<span class="linenr"> 945: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">only svg/foreignObject could be block here, however if they are</span>
<span class="linenr"> 946: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">static then they don't need to be blocks since there will be no</span>
<span class="linenr"> 947: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">nested updates.</span>
<span class="linenr"> 948: </span>          <span class=
"org-keyword">if</span> (codegenNode.isBlock) {
<span class=
"linenr"> 949: </span>            context.removeHelper(OPEN_BLOCK)
<span class="linenr"> 950: </span>            context.removeHelper(
<span class=
"linenr"> 951: </span>              getVNodeBlockHelper(context.inSSR, codegenNode.isComponent)
<span class="linenr"> 952: </span>            )
<span class=
"linenr"> 953: </span>            codegenNode.isBlock = <span class="org-constant">false</span>
<span class=
"linenr"> 954: </span>            context.helper(getVNodeHelper(context.inSSR, codegenNode.isComponent))
<span class="linenr"> 955: </span>          }
<span class="linenr"> 956: </span>  
<span class=
"linenr"> 957: </span>          constantCache.set(node, returnType)
<span class="linenr"> 958: </span>          <span class=
"org-keyword">return</span> returnType
<span class="linenr"> 959: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 960: </span>          constantCache.set(node, ConstantTypes.NOT_CONSTANT)
<span class="linenr"> 961: </span>          <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 962: </span>        }
<span class="linenr"> 963: </span>      <span class=
"org-keyword">case</span> NodeTypes.TEXT:
<span class="linenr"> 964: </span>      <span class=
"org-keyword">case</span> NodeTypes.COMMENT:
<span class="linenr"> 965: </span>        <span class=
"org-keyword">return</span> ConstantTypes.CAN_STRINGIFY
<span class="linenr"> 966: </span>      <span class=
"org-keyword">case</span> NodeTypes.IF:
<span class="linenr"> 967: </span>      <span class=
"org-keyword">case</span> NodeTypes.FOR:
<span class="linenr"> 968: </span>      <span class=
"org-keyword">case</span> NodeTypes.IF_BRANCH:
<span class="linenr"> 969: </span>        <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 970: </span>      <span class=
"org-keyword">case</span> NodeTypes.INTERPOLATION:
<span class="linenr"> 971: </span>      <span class=
"org-keyword">case</span> NodeTypes.TEXT_CALL:
<span class="linenr"> 972: </span>        <span class=
"org-keyword">return</span> getConstantType(node.content, context)
<span class="linenr"> 973: </span>      <span class=
"org-keyword">case</span> NodeTypes.SIMPLE_EXPRESSION:
<span class="linenr"> 974: </span>        <span class=
"org-keyword">return</span> node.constType
<span class="linenr"> 975: </span>      <span class=
"org-keyword">case</span> NodeTypes.COMPOUND_EXPRESSION:
<span class="linenr"> 976: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">returnType</span> = ConstantTypes.CAN_STRINGIFY
<span class="linenr"> 977: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class="linenr"> 978: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = node.children[i]
<span class="linenr"> 979: </span>          <span class=
"org-keyword">if</span> (isString(child) || isSymbol(child)) {
<span class="linenr"> 980: </span>            <span class=
"org-keyword">continue</span>
<span class="linenr"> 981: </span>          }
<span class="linenr"> 982: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">childType</span> = getConstantType(child, context)
<span class="linenr"> 983: </span>          <span class=
"org-keyword">if</span> (childType === ConstantTypes.NOT_CONSTANT) {
<span class="linenr"> 984: </span>            <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 985: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (childType &lt; returnType) {
<span class=
"linenr"> 986: </span>            returnType = childType
<span class="linenr"> 987: </span>          }
<span class="linenr"> 988: </span>        }
<span class="linenr"> 989: </span>        <span class=
"org-keyword">return</span> returnType
<span class="linenr"> 990: </span>      <span class=
"org-keyword">default</span>:
<span class="linenr"> 991: </span>        <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr"> 992: </span>    }
<span class="linenr"> 993: </span>  }
<span class="linenr"> 994: </span>  
<span class="linenr"> 995: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">allowHoistedHelperSet</span> = <span class=
"org-keyword">new</span> <span class="org-type">Set</span>([
<span class="linenr"> 996: </span>    NORMALIZE_CLASS,
<span class="linenr"> 997: </span>    NORMALIZE_STYLE,
<span class="linenr"> 998: </span>    NORMALIZE_PROPS,
<span class="linenr"> 999: </span>    GUARD_REACTIVE_PROPS
<span class="linenr">1000: </span>  ])
<span class="linenr">1001: </span>  
<span class="linenr">1002: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getConstantTypeOfHelperCall</span>(<span class=
"org-variable-name">value</span>, <span class=
"org-variable-name">context</span>){
<span class="linenr">1003: </span>    <span class=
"org-keyword">if</span> (
<span class=
"linenr">1004: </span>      value.type === NodeTypes.JS_CALL_EXPRESSION &amp;&
<span class=
"linenr">1005: </span>      !isString(value.callee) &amp;&
<span class=
"linenr">1006: </span>      allowHoistedHelperSet.has(value.callee)
<span class="linenr">1007: </span>    ) {
<span class="linenr">1008: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">arg</span> = value.<span class=
"org-constant">arguments</span>[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">1009: </span>      <span class=
"org-keyword">if</span> (arg.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">1010: </span>        <span class=
"org-keyword">return</span> getConstantType(arg, context)
<span class="linenr">1011: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (arg.type === NodeTypes.JS_CALL_EXPRESSION) {
<span class="linenr">1012: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in the case of nested helper call, e.g. `normalizeProps(guardReactiveProps(exp))`</span>
<span class="linenr">1013: </span>        <span class=
"org-keyword">return</span> getConstantTypeOfHelperCall(arg, context)
<span class="linenr">1014: </span>      }
<span class="linenr">1015: </span>    }
<span class="linenr">1016: </span>    <span class=
"org-keyword">return</span> ConstantTypes.NOT_CONSTANT
<span class="linenr">1017: </span>  }
<span class="linenr">1018: </span>  
<span class="linenr">1019: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getGeneratedPropsConstantType</span>(<span class="org-variable-name">node</span>, <span class="org-variable-name">context</span>) {
<span class="linenr">1020: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">returnType</span> = ConstantTypes.CAN_STRINGIFY
<span class="linenr">1021: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = getNodeProps(node)
<span class="linenr">1022: </span>    <span class=
"org-keyword">if</span> (props &amp;& props.type === NodeTypes.JS_OBJECT_EXPRESSION) {
<span class="linenr">1023: </span>      <span class=
"org-keyword">const</span> { properties } = props
<span class="linenr">1024: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; properties.length; i++) {
<span class="linenr">1025: </span>        <span class=
"org-keyword">const</span> { key, value } = properties[i]
<span class="linenr">1026: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyType</span> = getConstantType(key, context)
<span class="linenr">1027: </span>        <span class=
"org-keyword">if</span> (keyType === ConstantTypes.NOT_CONSTANT) {
<span class="linenr">1028: </span>          <span class=
"org-keyword">return</span> keyType
<span class="linenr">1029: </span>        }
<span class="linenr">1030: </span>        <span class=
"org-keyword">if</span> (keyType &lt; returnType) {
<span class="linenr">1031: </span>          returnType = keyType
<span class="linenr">1032: </span>        }
<span class="linenr">1033: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">valueType</span>
<span class="linenr">1034: </span>        <span class=
"org-keyword">if</span> (value.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class=
"linenr">1035: </span>          valueType = getConstantType(value, context)
<span class="linenr">1036: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (value.type === NodeTypes.JS_CALL_EXPRESSION) {
<span class="linenr">1037: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">some helper calls can be hoisted,</span>
<span class="linenr">1038: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">such as the `normalizeProps` generated by the compiler for pre-normalize class,</span>
<span class="linenr">1039: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in this case we need to respect the ConstantType of the helper's arguments</span>
<span class=
"linenr">1040: </span>          valueType = getConstantTypeOfHelperCall(value, context)
<span class="linenr">1041: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">1042: </span>          valueType = ConstantTypes.NOT_CONSTANT
<span class="linenr">1043: </span>        }
<span class="linenr">1044: </span>        <span class=
"org-keyword">if</span> (valueType === ConstantTypes.NOT_CONSTANT) {
<span class="linenr">1045: </span>          <span class=
"org-keyword">return</span> valueType
<span class="linenr">1046: </span>        }
<span class="linenr">1047: </span>        <span class=
"org-keyword">if</span> (valueType &lt; returnType) {
<span class="linenr">1048: </span>          returnType = valueType
<span class="linenr">1049: </span>        }
<span class="linenr">1050: </span>      }
<span class="linenr">1051: </span>    }
<span class="linenr">1052: </span>    <span class=
"org-keyword">return</span> returnType
<span class="linenr">1053: </span>  }
<span class="linenr">1054: </span>  
<span class="linenr">1055: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getNodeProps</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">1056: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = node.codegenNode
<span class="linenr">1057: </span>    <span class=
"org-keyword">if</span> (codegenNode.type === NodeTypes.VNODE_CALL) {
<span class="linenr">1058: </span>      <span class=
"org-keyword">return</span> codegenNode.props
<span class="linenr">1059: </span>    }
<span class="linenr">1060: </span>  }
<span class="linenr">1061: </span>  
<span class="linenr">1062: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getPatchFlag</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">1063: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">flag</span> = node.patchFlag
<span class="linenr">1064: </span>    <span class=
"org-keyword">return</span> flag ? parseInt(flag, <span class=
"org-highlight-numbers-number">10</span>) : <span class=
"org-constant">undefined</span>
<span class="linenr">1065: </span>  }
<span class="linenr">1066: </span>  
<span class="linenr">1067: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createRootCodegen</span>(<span class=
"org-variable-name">root</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">1068: </span>    <span class=
"org-keyword">const</span> { helper } = context
<span class="linenr">1069: </span>    <span class=
"org-keyword">const</span> { children } = root
<span class="linenr">1070: </span>    logg(<span class=
"org-string">'createRootCodegen'</span>, <span class=
"org-string">`children=${children.length}, 只有一个用 block, 多个用Fragment`</span>)
<span class="linenr">1071: </span>    <span class=
"org-keyword">if</span> (children.length === <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">1072: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">1073: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if the single child is an element, turn it into a block.</span>
<span class="linenr">1074: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如果只有一个根元素，如： &lt;template&gt;&lt;div&gt;...&lt;/div&gt;&lt;/template&gt;</span>
<span class="linenr">1075: </span>      <span class=
"org-keyword">if</span> (isSingleElementRoot(root, child) &amp;& child.codegenNode) {
<span class="linenr">1076: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single element root is never hoisted so codegenNode will never be</span>
<span class="linenr">1077: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">SimpleExpressionNode</span>
<span class="linenr">1078: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = child.codegenNode
<span class="linenr">1079: </span>        <span class=
"org-keyword">if</span> (codegenNode.type === NodeTypes.VNODE_CALL) {
<span class=
"linenr">1080: </span>          makeBlock(codegenNode, context)
<span class="linenr">1081: </span>        }
<span class=
"linenr">1082: </span>        root.codegenNode = codegenNode
<span class="linenr">1083: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">1084: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- single &lt;slot/&gt;, IfNode, ForNode: already blocks.</span>
<span class="linenr">1085: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- single text node: always patched.</span>
<span class="linenr">1086: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">root codegen falls through via genNode()</span>
<span class="linenr">1087: </span>        root.codegenNode = child
<span class="linenr">1088: </span>      }
<span class="linenr">1089: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (children.length &gt; <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">1090: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">root 下有多个节点时，使用 fragment block，3.x 特性，2.x中是不支持多个元素的</span>
<span class="linenr">1091: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = PatchFlags.STABLE_FRAGMENT
<span class="linenr">1092: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlagText</span> = PatchFlagNames[PatchFlags.STABLE_FRAGMENT]
<span class="linenr">1093: </span>  
<span class=
"linenr">1094: </span>      root.codegenNode = createVNodeCall(
<span class="linenr">1095: </span>        context,
<span class="linenr">1096: </span>        helper(FRAGMENT),
<span class="linenr">1097: </span>        <span class=
"org-constant">undefined</span>,
<span class="linenr">1098: </span>        root.children,
<span class=
"linenr">1099: </span>        patchFlag + (__DEV__ ? <span class=
"org-string">` /* ${patchFlagText} */`</span> : <span class=
"org-string">``</span>),
<span class="linenr">1100: </span>        <span class=
"org-constant">undefined</span>,
<span class="linenr">1101: </span>        <span class=
"org-constant">undefined</span>,
<span class="linenr">1102: </span>        <span class=
"org-constant">true</span>,
<span class="linenr">1103: </span>        <span class=
"org-constant">undefined</span>,
<span class="linenr">1104: </span>        <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isComponent</span><span class=
"org-comment-delimiter"> */</span>
<span class="linenr">1105: </span>      )
<span class="linenr">1106: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">1107: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no children = noop. codegen will return null.</span>
<span class="linenr">1108: </span>    }
<span class="linenr">1109: </span>  }
<span class="linenr">1110: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createStructuralDirectiveTransform</span>(<span class="org-variable-name">name</span>, <span class="org-variable-name">fn</span>) {
<span class="linenr">1111: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">正则就用 test 方法，字符串直接比较</span>
<span class="linenr">1112: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">matches</span> = isString(name)
<span class="linenr">1113: </span>      ? (n) =&gt; n === name
<span class="linenr">1114: </span>      : (n) =&gt; name.test(n)
<span class="linenr">1115: </span>  
<span class="linenr">1116: </span>    logg(<span class=
"org-string">'createStructuralDirectiveTransform'</span>, <span class="org-string">`name=${name}, matches=${matches}`</span>)
<span class="linenr">1117: </span>    <span class=
"org-keyword">return</span> (node, context) =&gt; {
<span class="linenr">1118: </span>      <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT) {
<span class="linenr">1119: </span>        <span class=
"org-keyword">const</span> { props } = node
<span class="linenr">1120: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-slot 指令特殊处理，代码在 vSlot.ts 中，所以这里跳过它</span>
<span class="linenr">1121: </span>        <span class=
"org-keyword">if</span> (node.tagType === ElementTypes.TEMPLATE &amp;& props.some(isVSlot)) {
<span class="linenr">1122: </span>          <span class=
"org-keyword">return</span>
<span class="linenr">1123: </span>        }
<span class="linenr">1124: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exitFns</span> = []
<span class="linenr">1125: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; props.length; i++) {
<span class="linenr">1126: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prop</span> = props[i]
<span class="linenr">1127: </span>          <span class=
"org-keyword">if</span> (prop.type === NodeTypes.DIRECTIVE &amp;& matches(prop.name)) {
<span class="linenr">1128: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">structural directives are removed to avoid infinite recursion</span>
<span class="linenr">1129: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also we remove them *before* applying so that it can further</span>
<span class="linenr">1130: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">traverse itself in case it moves the node around</span>
<span class=
"linenr">1131: </span>            props.splice(i, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr">1132: </span>            i--
<span class="linenr">1133: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = fn(node, prop, context)
<span class="linenr">1134: </span>            <span class=
"org-keyword">if</span> (onExit) exitFns.push(onExit)
<span class="linenr">1135: </span>          }
<span class="linenr">1136: </span>        }
<span class="linenr">1137: </span>        <span class=
"org-keyword">return</span> exitFns
<span class="linenr">1138: </span>      }
<span class="linenr">1139: </span>    }
<span class="linenr">1140: </span>  }
<span class="linenr">1141: </span>  
<span class="linenr">1142: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getBaseTransformPreset</span>(<span class=
"org-variable-name">prefixIdentifiers</span>) {
<span class="linenr">1143: </span>    <span class=
"org-keyword">return</span> [
<span class="linenr">1144: </span>      [
<span class="linenr">1145: </span>        transformOnce,
<span class="linenr">1146: </span>        transformIf,
<span class="linenr">1147: </span>        transformMemo,
<span class="linenr">1148: </span>        transformFor,
<span class=
"linenr">1149: </span>        ...(!__BROWSER__ &amp;& prefixIdentifiers
<span class="linenr">1150: </span>          ? [
<span class="linenr">1151: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">order is important</span>
<span class=
"linenr">1152: </span>              trackVForSlotScopes,
<span class="linenr">1153: </span>              transformExpression
<span class="linenr">1154: </span>            ]
<span class=
"linenr">1155: </span>          : __BROWSER__ &amp;& __DEV__
<span class="linenr">1156: </span>          ? [transformExpression]
<span class="linenr">1157: </span>          : []),
<span class="linenr">1158: </span>        transformSlotOutlet,
<span class="linenr">1159: </span>        transformElement,
<span class="linenr">1160: </span>        trackSlotScopes,
<span class="linenr">1161: </span>        transformText
<span class="linenr">1162: </span>      ],
<span class="linenr">1163: </span>      {
<span class="linenr">1164: </span>        on: transformOn,
<span class="linenr">1165: </span>        bind: transformBind,
<span class="linenr">1166: </span>        model: transformModel
<span class="linenr">1167: </span>      }
<span class="linenr">1168: </span>    ]
<span class="linenr">1169: </span>  }
<span class="linenr">1170: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">makeBlock</span>(<span class=
"org-variable-name">node</span>, { <span class=
"org-variable-name">helper</span>, <span class=
"org-variable-name">removeHelper</span>, <span class=
"org-variable-name">inSSR</span> }) {
<span class="linenr">1171: </span>    <span class=
"org-keyword">if</span> (!node.isBlock) {
<span class="linenr">1172: </span>      node.isBlock = <span class=
"org-constant">true</span>
<span class=
"linenr">1173: </span>      removeHelper(getVNodeHelper(inSSR, node.isComponent))
<span class="linenr">1174: </span>      helper(OPEN_BLOCK)
<span class=
"linenr">1175: </span>      helper(getVNodeBlockHelper(inSSR, node.isComponent))
<span class="linenr">1176: </span>    }
<span class="linenr">1177: </span>  }
<span class="linenr">1178: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">defaultFallback</span> = createSimpleExpression(<span class="org-string">`undefined`</span>, <span class="org-constant">false</span>)
<span class="linenr">1179: </span>  
<span class="linenr">1180: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">A NodeTransform that:</span>
<span class="linenr">1181: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Tracks scope identifiers for scoped slots so that they don't get prefixed</span>
<span class="linenr">1182: </span>  <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">by transformExpression. This is only applied in non-browser builds with</span>
<span class="linenr">1183: </span>  <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">{ prefixIdentifiers: true }.</span>
<span class="linenr">1184: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. Track v-slot depths so that we know a slot is inside another slot.</span>
<span class="linenr">1185: </span>  <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">Note the exit callback is executed before buildSlots() on the same node,</span>
<span class="linenr">1186: </span>  <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">so only nested slots see positive numbers.</span>
<span class="linenr">1187: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">trackSlotScopes</span> = (node, context) =&gt; {
<span class="linenr">1188: </span>    <span class=
"org-keyword">if</span> (
<span class=
"linenr">1189: </span>      node.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr">1190: </span>      (node.tagType === ElementTypes.COMPONENT ||
<span class=
"linenr">1191: </span>        node.tagType === ElementTypes.TEMPLATE)
<span class="linenr">1192: </span>    ) {
<span class="linenr">1193: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">We are only checking non-empty v-slot here</span>
<span class="linenr">1194: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">since we only care about slots that introduce scope variables.</span>
<span class="linenr">1195: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">vSlot</span> = findDir(node, <span class=
"org-string">'slot'</span>)
<span class="linenr">1196: </span>      <span class=
"org-keyword">if</span> (vSlot) {
<span class="linenr">1197: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotProps</span> = vSlot.exp
<span class="linenr">1198: </span>        <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">1199: </span>          slotProps &amp;& context.addIdentifiers(slotProps)
<span class="linenr">1200: </span>        }
<span class="linenr">1201: </span>        context.scopes.vSlot++
<span class="linenr">1202: </span>        <span class=
"org-keyword">return</span> () =&gt; {
<span class="linenr">1203: </span>          <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">1204: </span>            slotProps &amp;& context.removeIdentifiers(slotProps)
<span class="linenr">1205: </span>          }
<span class="linenr">1206: </span>          context.scopes.vSlot--
<span class="linenr">1207: </span>        }
<span class="linenr">1208: </span>      }
<span class="linenr">1209: </span>    }
<span class="linenr">1210: </span>  }
<span class="linenr">1211: </span>  
<span class="linenr">1212: </span>  
<span class="linenr">1213: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">A NodeTransform that tracks scope identifiers for scoped slots with v-for.</span>
<span class="linenr">1214: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">This transform is only applied in non-browser builds with { prefixIdentifiers: true }</span>
<span class="linenr">1215: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">trackVForSlotScopes</span> = (node, context) =&gt; {
<span class="linenr">1216: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vFor</span>
<span class="linenr">1217: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">1218: </span>      isTemplateNode(node) &amp;&
<span class=
"linenr">1219: </span>      node.props.some(isVSlot) &amp;&
<span class=
"linenr">1220: </span>      (vFor = findDir(node, <span class=
"org-string">'for'</span>))
<span class="linenr">1221: </span>    ) {
<span class="linenr">1222: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">result</span> = (vFor.parseResult = parseForExpression(
<span class="linenr">1223: </span>        vFor.exp,
<span class="linenr">1224: </span>        context
<span class="linenr">1225: </span>      ))
<span class="linenr">1226: </span>      <span class=
"org-keyword">if</span> (result) {
<span class="linenr">1227: </span>        <span class=
"org-keyword">const</span> { value, key, index } = result
<span class="linenr">1228: </span>        <span class=
"org-keyword">const</span> { addIdentifiers, removeIdentifiers } = context
<span class=
"linenr">1229: </span>        value &amp;& addIdentifiers(value)
<span class=
"linenr">1230: </span>        key &amp;& addIdentifiers(key)
<span class=
"linenr">1231: </span>        index &amp;& addIdentifiers(index)
<span class="linenr">1232: </span>  
<span class="linenr">1233: </span>        <span class=
"org-keyword">return</span> () =&gt; {
<span class=
"linenr">1234: </span>          value &amp;& removeIdentifiers(value)
<span class=
"linenr">1235: </span>          key &amp;& removeIdentifiers(key)
<span class=
"linenr">1236: </span>          index &amp;& removeIdentifiers(index)
<span class="linenr">1237: </span>        }
<span class="linenr">1238: </span>      }
<span class="linenr">1239: </span>    }
<span class="linenr">1240: </span>  }
<span class="linenr">1241: </span>  
<span class="linenr">1242: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">buildClientSlotFn</span> = (props, children, loc) =&gt;
<span class="linenr">1243: </span>    createFunctionExpression(
<span class="linenr">1244: </span>      props,
<span class="linenr">1245: </span>      children,
<span class="linenr">1246: </span>      <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">newline</span><span class=
"org-comment-delimiter"> */</span>,
<span class="linenr">1247: </span>      <span class=
"org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isSlot</span><span class=
"org-comment-delimiter"> */</span>,
<span class=
"linenr">1248: </span>      children.length ? children[<span class=
"org-highlight-numbers-number">0</span>].loc : loc
<span class="linenr">1249: </span>    )
<span class="linenr">1250: </span>  
<span class="linenr">1251: </span>  
<span class="linenr">1252: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Instead of being a DirectiveTransform, v-slot processing is called during</span>
<span class="linenr">1253: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">transformElement to build the slots object for a component.</span>
<span class="linenr">1254: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">buildSlots</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">buildSlotFn</span>= <span class=
"org-variable-name">buildClientSlotFn</span>) {
<span class="linenr">1255: </span>    context.helper(WITH_CTX)
<span class="linenr">1256: </span>  
<span class="linenr">1257: </span>    <span class=
"org-keyword">const</span> { children, loc } = node
<span class="linenr">1258: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotsProperties</span> = []
<span class="linenr">1259: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dynamicSlots</span>= []
<span class="linenr">1260: </span>  
<span class="linenr">1261: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">If the slot is inside a v-for or another v-slot, force it to be dynamic</span>
<span class="linenr">1262: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">since it likely uses a scope variable.</span>
<span class="linenr">1263: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasDynamicSlots</span> = context.scopes.vSlot &gt; <span class="org-highlight-numbers-number">0</span> || context.scopes.vFor &gt; <span class="org-highlight-numbers-number">0</span>
<span class="linenr">1264: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">with `prefixIdentifiers: true`, this can be further optimized to make</span>
<span class="linenr">1265: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">it dynamic only when the slot actually uses the scope variables.</span>
<span class="linenr">1266: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& !context.ssr &amp;& context.prefixIdentifiers) {
<span class=
"linenr">1267: </span>      hasDynamicSlots = hasScopeRef(node, context.identifiers)
<span class="linenr">1268: </span>    }
<span class="linenr">1269: </span>  
<span class="linenr">1270: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Check for slot with slotProps on component itself.</span>
<span class="linenr">1271: </span>    <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">&lt;Comp v-slot="{ prop }"/&gt;</span>
<span class="linenr">1272: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onComponentSlot</span> = findDir(node, <span class="org-string">'slot'</span>, <span class="org-constant">true</span>)
<span class="linenr">1273: </span>    <span class=
"org-keyword">if</span> (onComponentSlot) {
<span class="linenr">1274: </span>      <span class=
"org-keyword">const</span> { arg, exp } = onComponentSlot
<span class="linenr">1275: </span>      <span class=
"org-keyword">if</span> (arg &amp;& !isStaticExp(arg)) {
<span class=
"linenr">1276: </span>        hasDynamicSlots = <span class=
"org-constant">true</span>
<span class="linenr">1277: </span>      }
<span class="linenr">1278: </span>      slotsProperties.push(
<span class="linenr">1279: </span>        createObjectProperty(
<span class=
"linenr">1280: </span>          arg || createSimpleExpression(<span class="org-string">'default'</span>, <span class="org-constant">true</span>),
<span class=
"linenr">1281: </span>          buildSlotFn(exp, children, loc)
<span class="linenr">1282: </span>        )
<span class="linenr">1283: </span>      )
<span class="linenr">1284: </span>    }
<span class="linenr">1285: </span>  
<span class="linenr">1286: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. Iterate through children and check for template slots</span>
<span class="linenr">1287: </span>    <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">&lt;template v-slot:foo="{ prop }"&gt;</span>
<span class="linenr">1288: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasTemplateSlots</span> = <span class=
"org-constant">false</span>
<span class="linenr">1289: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasNamedDefaultSlot</span> = <span class=
"org-constant">false</span>
<span class="linenr">1290: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">implicitDefaultChildren</span> = []
<span class="linenr">1291: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">seenSlotNames</span> = <span class=
"org-keyword">new</span> <span class="org-type">Set</span>()
<span class="linenr">1292: </span>  
<span class="linenr">1293: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; children.length; i++) {
<span class="linenr">1294: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotElement</span> = children[i]
<span class="linenr">1295: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">slotDir</span>
<span class="linenr">1296: </span>  
<span class="linenr">1297: </span>      <span class=
"org-keyword">if</span> (
<span class=
"linenr">1298: </span>        !isTemplateNode(slotElement) ||
<span class=
"linenr">1299: </span>        !(slotDir = findDir(slotElement, <span class="org-string">'slot'</span>, <span class="org-constant">true</span>))
<span class="linenr">1300: </span>      ) { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">收集不在 template v-slot 中的元素/组件，这些都会合并到默认插槽中去</span>
<span class="linenr">1301: </span>        <span class=
"org-keyword">if</span> (slotElement.type !== NodeTypes.COMMENT) {
<span class=
"linenr">1302: </span>          implicitDefaultChildren.push(slotElement)
<span class="linenr">1303: </span>        }
<span class="linenr">1304: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">1305: </span>      }
<span class="linenr">1306: </span>  
<span class="linenr">1307: </span>      <span class=
"org-keyword">if</span> (onComponentSlot) {
<span class="linenr">1308: </span>        logg(<span class=
"org-string">`buildSlots already has on-component slot - this is incorrect usage`</span>)
<span class="linenr">1309: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">1310: </span>      }
<span class="linenr">1311: </span>  
<span class=
"linenr">1312: </span>      hasTemplateSlots = <span class=
"org-constant">true</span>
<span class="linenr">1313: </span>      <span class=
"org-keyword">const</span> { children: <span class=
"org-variable-name">slotChildren</span>, loc: <span class=
"org-variable-name">slotLoc</span> } = slotElement
<span class="linenr">1314: </span>      <span class=
"org-keyword">const</span> {
<span class=
"linenr">1315: </span>        arg: slotName = createSimpleExpression(<span class="org-string">`default`</span>, <span class="org-constant">true</span>),
<span class="linenr">1316: </span>        exp: slotProps,
<span class="linenr">1317: </span>        loc: dirLoc
<span class="linenr">1318: </span>      } = slotDir
<span class="linenr">1319: </span>  
<span class="linenr">1320: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check if name is dynamic.</span>
<span class="linenr">1321: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">staticSlotName</span>
<span class="linenr">1322: </span>      <span class=
"org-keyword">if</span> (isStaticExp(slotName)) {
<span class=
"linenr">1323: </span>        staticSlotName = slotName ? slotName.content : <span class="org-string">`default`</span>
<span class="linenr">1324: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">1325: </span>        hasDynamicSlots = <span class=
"org-constant">true</span>
<span class="linenr">1326: </span>      }
<span class="linenr">1327: </span>  
<span class="linenr">1328: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotFunction</span> = buildSlotFn(slotProps, slotChildren, slotLoc)
<span class="linenr">1329: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check if this slot is conditional (v-if/v-for)</span>
<span class="linenr">1330: </span>      <span class=
"org-keyword">let</span> <span class="org-variable-name">vIf</span>
<span class="linenr">1331: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vElse</span>
<span class="linenr">1332: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vFor</span>
<span class="linenr">1333: </span>      <span class=
"org-keyword">if</span> ((vIf = findDir(slotElement, <span class=
"org-string">'if'</span>))) {
<span class=
"linenr">1334: </span>        hasDynamicSlots = <span class=
"org-constant">true</span>
<span class="linenr">1335: </span>        dynamicSlots.push(
<span class=
"linenr">1336: </span>          createConditionalExpression(
<span class="linenr">1337: </span>            vIf.exp,
<span class=
"linenr">1338: </span>            buildDynamicSlot(slotName, slotFunction),
<span class="linenr">1339: </span>            defaultFallback
<span class="linenr">1340: </span>          )
<span class="linenr">1341: </span>        )
<span class="linenr">1342: </span>      } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class=
"linenr">1343: </span>        (vElse = findDir(slotElement, <span class="org-string">/^else(-if)?$/</span>, <span class="org-constant">true</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">allowEmpty</span><span class="org-comment-delimiter"> */</span>))
<span class="linenr">1344: </span>      ) {
<span class="linenr">1345: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">find adjacent v-if</span>
<span class="linenr">1346: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">j</span> = i
<span class="linenr">1347: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">prev</span>
<span class="linenr">1348: </span>        <span class=
"org-keyword">while</span> (j--) {
<span class="linenr">1349: </span>          prev = children[j]
<span class="linenr">1350: </span>          <span class=
"org-keyword">if</span> (prev.type !== NodeTypes.COMMENT) {
<span class="linenr">1351: </span>            <span class=
"org-keyword">break</span>
<span class="linenr">1352: </span>          }
<span class="linenr">1353: </span>        }
<span class="linenr">1354: </span>        <span class=
"org-keyword">if</span> (prev &amp;& isTemplateNode(prev) &amp;& findDir(prev, <span class="org-string">'if'</span>)) {
<span class="linenr">1355: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">remove node</span>
<span class=
"linenr">1356: </span>          children.splice(i, <span class=
"org-highlight-numbers-number">1</span>)
<span class="linenr">1357: </span>          i--
<span class="linenr">1358: </span>  
<span class="linenr">1359: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">attach this slot to previous conditional</span>
<span class="linenr">1360: </span>          <span class=
"org-keyword">let</span> <span class=
"org-variable-name">conditional</span> = dynamicSlots[
<span class=
"linenr">1361: </span>            dynamicSlots.length - <span class="org-highlight-numbers-number">1</span>
<span class="linenr">1362: </span>          ]
<span class="linenr">1363: </span>          <span class=
"org-keyword">while</span> (
<span class=
"linenr">1364: </span>            conditional.alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION
<span class="linenr">1365: </span>          ) {
<span class=
"linenr">1366: </span>            conditional = conditional.alternate
<span class="linenr">1367: </span>          }
<span class=
"linenr">1368: </span>          conditional.alternate = vElse.exp
<span class=
"linenr">1369: </span>            ? createConditionalExpression(
<span class="linenr">1370: </span>                vElse.exp,
<span class=
"linenr">1371: </span>                buildDynamicSlot(slotName, slotFunction),
<span class="linenr">1372: </span>                defaultFallback
<span class="linenr">1373: </span>              )
<span class=
"linenr">1374: </span>            : buildDynamicSlot(slotName, slotFunction)
<span class="linenr">1375: </span>        }
<span class="linenr">1376: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> ((vFor = findDir(slotElement, <span class=
"org-string">'for'</span>))) {
<span class=
"linenr">1377: </span>        hasDynamicSlots = <span class=
"org-constant">true</span>
<span class="linenr">1378: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parseResult</span> =
<span class="linenr">1379: </span>          vFor.parseResult ||
<span class=
"linenr">1380: </span>          parseForExpression(vFor.exp , context)
<span class="linenr">1381: </span>        <span class=
"org-keyword">if</span> (parseResult) {
<span class="linenr">1382: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Render the dynamic slots as an array and add it to the createSlot()</span>
<span class="linenr">1383: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">args. The runtime knows how to handle it appropriately.</span>
<span class="linenr">1384: </span>          dynamicSlots.push(
<span class=
"linenr">1385: </span>            createCallExpression(context.helper(RENDER_LIST), [
<span class="linenr">1386: </span>              parseResult.source,
<span class=
"linenr">1387: </span>              createFunctionExpression(
<span class=
"linenr">1388: </span>                createForLoopParams(parseResult),
<span class=
"linenr">1389: </span>                buildDynamicSlot(slotName, slotFunction),
<span class="linenr">1390: </span>                <span class=
"org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">force newline</span><span class=
"org-comment-delimiter"> */</span>
<span class="linenr">1391: </span>              )
<span class="linenr">1392: </span>            ])
<span class="linenr">1393: </span>          )
<span class="linenr">1394: </span>        }
<span class="linenr">1395: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">1396: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check duplicate static names</span>
<span class="linenr">1397: </span>        <span class=
"org-keyword">if</span> (staticSlotName) {
<span class="linenr">1398: </span>          <span class=
"org-keyword">if</span> (seenSlotNames.has(staticSlotName)) {
<span class="linenr">1399: </span>            logg(<span class=
"org-string">`buildSlots seenSlotNames has slot name`</span>)
<span class="linenr">1400: </span>            <span class=
"org-keyword">continue</span>
<span class="linenr">1401: </span>          }
<span class=
"linenr">1402: </span>          seenSlotNames.add(staticSlotName)
<span class="linenr">1403: </span>          <span class=
"org-keyword">if</span> (staticSlotName === <span class=
"org-string">'default'</span>) {
<span class=
"linenr">1404: </span>            hasNamedDefaultSlot = <span class="org-constant">true</span>
<span class="linenr">1405: </span>          }
<span class="linenr">1406: </span>        }
<span class=
"linenr">1407: </span>        slotsProperties.push(createObjectProperty(slotName, slotFunction))
<span class="linenr">1408: </span>      }
<span class="linenr">1409: </span>    }
<span class="linenr">1410: </span>  
<span class="linenr">1411: </span>    <span class=
"org-keyword">if</span> (!onComponentSlot) {
<span class="linenr">1412: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">buildDefaultSlotProperty</span> = (props, children) =&gt; {
<span class="linenr">1413: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fn</span> = buildSlotFn(props, children, loc)
<span class="linenr">1414: </span>  
<span class="linenr">1415: </span>        <span class=
"org-keyword">return</span> createObjectProperty(<span class=
"org-string">`default`</span>, fn)
<span class="linenr">1416: </span>      }
<span class="linenr">1417: </span>  
<span class="linenr">1418: </span>      <span class=
"org-keyword">if</span> (!hasTemplateSlots) {
<span class="linenr">1419: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">implicit default slot (on component)</span>
<span class=
"linenr">1420: </span>        slotsProperties.push(buildDefaultSlotProperty(<span class="org-constant">undefined</span>, children))
<span class="linenr">1421: </span>      } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class=
"linenr">1422: </span>        implicitDefaultChildren.length &amp;&
<span class="linenr">1423: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#3766</span>
<span class="linenr">1424: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">with whitespace: 'preserve', whitespaces between slots will end up in</span>
<span class="linenr">1425: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">implicitDefaultChildren. Ignore if all implicit children are whitespaces.</span>
<span class=
"linenr">1426: </span>        implicitDefaultChildren.some(node =&gt; isNonWhitespaceContent(node))
<span class="linenr">1427: </span>      ) {
<span class="linenr">1428: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">implicit default slot (mixed with named slots)</span>
<span class="linenr">1429: </span>        <span class=
"org-keyword">if</span> (hasNamedDefaultSlot) {
<span class="linenr">1430: </span>          logg(<span class=
"org-string">`buildSlots hasNamedDefaultSlot`</span>)
<span class="linenr">1431: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">1432: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">合并到默认插槽</span>
<span class="linenr">1433: </span>          slotsProperties.push(
<span class=
"linenr">1434: </span>            buildDefaultSlotProperty(<span class="org-constant">undefined</span>, implicitDefaultChildren)
<span class="linenr">1435: </span>          )
<span class="linenr">1436: </span>        }
<span class="linenr">1437: </span>      }
<span class="linenr">1438: </span>    }
<span class="linenr">1439: </span>  
<span class="linenr">1440: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotFlag</span> = hasDynamicSlots
<span class="linenr">1441: </span>      ? SlotFlags.DYNAMIC
<span class=
"linenr">1442: </span>      : hasForwardedSlots(node.children)
<span class="linenr">1443: </span>      ? SlotFlags.FORWARDED
<span class="linenr">1444: </span>      : SlotFlags.STABLE
<span class="linenr">1445: </span>  
<span class="linenr">1446: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">slots</span> = createObjectExpression(
<span class="linenr">1447: </span>      slotsProperties.concat(
<span class="linenr">1448: </span>        createObjectProperty(
<span class="linenr">1449: </span>          <span class=
"org-string">`_`</span>,
<span class="linenr">1450: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2 = compiled but dynamic = can skip normalization, but must run diff</span>
<span class="linenr">1451: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1 = compiled and static = can skip normalization AND diff as optimized</span>
<span class="linenr">1452: </span>          createSimpleExpression(
<span class=
"linenr">1453: </span>            slotFlag + (__DEV__ ? <span class="org-string">` /* ${slotFlagsText[slotFlag]} */`</span> : <span class="org-string">``</span>),
<span class="linenr">1454: </span>            <span class=
"org-constant">false</span>
<span class="linenr">1455: </span>          )
<span class="linenr">1456: </span>        )
<span class="linenr">1457: </span>      ),
<span class="linenr">1458: </span>      loc
<span class="linenr">1459: </span>    )
<span class="linenr">1460: </span>    <span class=
"org-keyword">if</span> (dynamicSlots.length) {
<span class=
"linenr">1461: </span>      slots = createCallExpression(context.helper(CREATE_SLOTS), [
<span class="linenr">1462: </span>        slots,
<span class=
"linenr">1463: </span>        createArrayExpression(dynamicSlots)
<span class="linenr">1464: </span>      ])
<span class="linenr">1465: </span>    }
<span class="linenr">1466: </span>  
<span class="linenr">1467: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">1468: </span>      slots,
<span class="linenr">1469: </span>      hasDynamicSlots
<span class="linenr">1470: </span>    }
<span class="linenr">1471: </span>  }
<span class="linenr">1472: </span>  
<span class="linenr">1473: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">buildDynamicSlot</span>(<span class=
"org-variable-name">name</span>, <span class=
"org-variable-name">fn</span>) {
<span class="linenr">1474: </span>    <span class=
"org-keyword">return</span> createObjectExpression([
<span class=
"linenr">1475: </span>      createObjectProperty(<span class=
"org-string">`name`</span>, name),
<span class=
"linenr">1476: </span>      createObjectProperty(<span class=
"org-string">`fn`</span>, fn)
<span class="linenr">1477: </span>    ])
<span class="linenr">1478: </span>  }
<span class="linenr">1479: </span>  
<span class="linenr">1480: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">hasForwardedSlots</span>(<span class=
"org-variable-name">children</span>) {
<span class="linenr">1481: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; children.length; i++) {
<span class="linenr">1482: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[i]
<span class="linenr">1483: </span>      <span class=
"org-keyword">switch</span> (child.type) {
<span class="linenr">1484: </span>        <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr">1485: </span>          <span class=
"org-keyword">if</span> (
<span class=
"linenr">1486: </span>            child.tagType === ElementTypes.SLOT ||
<span class=
"linenr">1487: </span>            hasForwardedSlots(child.children)
<span class="linenr">1488: </span>          ) {
<span class="linenr">1489: </span>            <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">1490: </span>          }
<span class="linenr">1491: </span>          <span class=
"org-keyword">break</span>
<span class="linenr">1492: </span>        <span class=
"org-keyword">case</span> NodeTypes.IF:
<span class="linenr">1493: </span>          <span class=
"org-keyword">if</span> (hasForwardedSlots(child.branches)) <span class="org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">1494: </span>          <span class=
"org-keyword">break</span>
<span class="linenr">1495: </span>        <span class=
"org-keyword">case</span> NodeTypes.IF_BRANCH:
<span class="linenr">1496: </span>        <span class=
"org-keyword">case</span> NodeTypes.FOR:
<span class="linenr">1497: </span>          <span class=
"org-keyword">if</span> (hasForwardedSlots(child.children)) <span class="org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">1498: </span>          <span class=
"org-keyword">break</span>
<span class="linenr">1499: </span>        <span class=
"org-keyword">default</span>:
<span class="linenr">1500: </span>          <span class=
"org-keyword">break</span>
<span class="linenr">1501: </span>      }
<span class="linenr">1502: </span>    }
<span class="linenr">1503: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">1504: </span>  }
<span class="linenr">1505: </span>  
<span class="linenr">1506: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">isNonWhitespaceContent</span>(<span class=
"org-variable-name">node</span>){
<span class="linenr">1507: </span>    <span class=
"org-keyword">if</span> (node.type !== NodeTypes.TEXT &amp;& node.type !== NodeTypes.TEXT_CALL)
<span class="linenr">1508: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">1509: </span>    <span class=
"org-keyword">return</span> node.type === NodeTypes.TEXT
<span class="linenr">1510: </span>      ? !!node.content.trim()
<span class=
"linenr">1511: </span>      : isNonWhitespaceContent(node.content)
<span class="linenr">1512: </span>  }
<span class="linenr">1513: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">some directive transforms (e.g. v-model) may return a symbol for runtime</span>
<span class="linenr">1514: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">import, which should be used instead of a resolveDirective call.</span>
<span class="linenr">1515: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">directiveImportMap</span> = <span class=
"org-keyword">new</span> <span class="org-type">WeakMap</span>()
<span class="linenr">1516: </span>  
<span class="linenr">1517: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generate a JavaScript AST for this element's codegen</span>
<span class="linenr">1518: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformElement</span> = (node, context) =&gt; {
<span class="linenr">1519: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">perform the work on exit, after all child expressions have been</span>
<span class="linenr">1520: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">processed and merged.</span>
<span class="linenr">1521: </span>    <span class=
"org-keyword">return</span> <span class=
"org-keyword">function</span> postTransformElement() {
<span class="linenr">1522: </span>      node = context.currentNode
<span class="linenr">1523: </span>  
<span class="linenr">1524: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">1525: </span>        !(
<span class=
"linenr">1526: </span>          node.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr">1527: </span>          (node.tagType === ElementTypes.ELEMENT ||
<span class=
"linenr">1528: </span>            node.tagType === ElementTypes.COMPONENT)
<span class="linenr">1529: </span>        )
<span class="linenr">1530: </span>      ) {
<span class="linenr">1531: </span>        <span class=
"org-keyword">return</span>
<span class="linenr">1532: </span>      }
<span class="linenr">1533: </span>  
<span class="linenr">1534: </span>      <span class=
"org-keyword">const</span> { tag, props } = node
<span class="linenr">1535: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isComponent</span> = node.tagType === ElementTypes.COMPONENT
<span class="linenr">1536: </span>  
<span class="linenr">1537: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">The goal of the transform is to create a codegenNode implementing the</span>
<span class="linenr">1538: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">VNodeCall interface.</span>
<span class="linenr">1539: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeTag</span> = isComponent
<span class=
"linenr">1540: </span>        ? resolveComponentType(node, context)
<span class="linenr">1541: </span>        : <span class=
"org-string">`"${tag}"`</span>
<span class="linenr">1542: </span>  
<span class="linenr">1543: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDynamicComponent</span> =
<span class=
"linenr">1544: </span>        isObject(vnodeTag) &amp;& vnodeTag.callee === RESOLVE_DYNAMIC_COMPONENT
<span class="linenr">1545: </span>  
<span class="linenr">1546: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeProps</span>
<span class="linenr">1547: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeChildren</span>
<span class="linenr">1548: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodePatchFlag</span>
<span class="linenr">1549: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">1550: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeDynamicProps</span>
<span class="linenr">1551: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">dynamicPropNames</span>
<span class="linenr">1552: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">vnodeDirectives</span>
<span class="linenr">1553: </span>  
<span class="linenr">1554: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">shouldUseBlock</span> =
<span class="linenr">1555: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dynamic component may resolve to plain elements</span>
<span class="linenr">1556: </span>        isDynamicComponent ||
<span class="linenr">1557: </span>        vnodeTag === TELEPORT ||
<span class="linenr">1558: </span>        vnodeTag === SUSPENSE ||
<span class="linenr">1559: </span>        (!isComponent &amp;&
<span class="linenr">1560: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;svg&gt; and &lt;foreignObject&gt; must be forced into blocks so that block</span>
<span class="linenr">1561: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">updates inside get proper isSVG flag at runtime. (#639, #643)</span>
<span class="linenr">1562: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">This is technically web-specific, but splitting the logic out of core</span>
<span class="linenr">1563: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">leads to too much unnecessary complexity.</span>
<span class="linenr">1564: </span>          (tag === <span class=
"org-string">'svg'</span> || tag === <span class=
"org-string">'foreignObject'</span>))
<span class="linenr">1565: </span>  
<span class="linenr">1566: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">props</span>
<span class="linenr">1567: </span>      <span class=
"org-keyword">if</span> (props.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">1568: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">propsBuildResult</span> = buildProps(node, context)
<span class=
"linenr">1569: </span>        vnodeProps = propsBuildResult.props
<span class=
"linenr">1570: </span>        patchFlag = propsBuildResult.patchFlag
<span class=
"linenr">1571: </span>        dynamicPropNames = propsBuildResult.dynamicPropNames
<span class="linenr">1572: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">directives</span> = propsBuildResult.directives
<span class="linenr">1573: </span>        vnodeDirectives =
<span class=
"linenr">1574: </span>          directives &amp;& directives.length
<span class=
"linenr">1575: </span>            ? (createArrayExpression(
<span class=
"linenr">1576: </span>                directives.map(dir =&gt; buildDirectiveArgs(dir, context))
<span class="linenr">1577: </span>              ))
<span class="linenr">1578: </span>            : <span class=
"org-constant">undefined</span>
<span class="linenr">1579: </span>  
<span class="linenr">1580: </span>        <span class=
"org-keyword">if</span> (propsBuildResult.shouldUseBlock) {
<span class=
"linenr">1581: </span>          shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr">1582: </span>        }
<span class="linenr">1583: </span>      }
<span class="linenr">1584: </span>  
<span class="linenr">1585: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">children</span>
<span class="linenr">1586: </span>      <span class=
"org-keyword">if</span> (node.children.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">1587: </span>        <span class=
"org-keyword">if</span> (vnodeTag === KEEP_ALIVE) {
<span class="linenr">1588: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Although a built-in component, we compile KeepAlive with raw children</span>
<span class="linenr">1589: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">instead of slot functions so that it can be used inside Transition</span>
<span class="linenr">1590: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">or other Transition-wrapping HOCs.</span>
<span class="linenr">1591: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">To ensure correct updates with block optimizations, we need to:</span>
<span class="linenr">1592: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Force keep-alive into a block. This avoids its children being</span>
<span class="linenr">1593: </span>          <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">collected by a parent block.</span>
<span class=
"linenr">1594: </span>          shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr">1595: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. Force keep-alive to always be updated, since it uses raw children.</span>
<span class=
"linenr">1596: </span>          patchFlag |= PatchFlags.DYNAMIC_SLOTS
<span class="linenr">1597: </span>        }
<span class="linenr">1598: </span>  
<span class="linenr">1599: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">shouldBuildAsSlots</span> =
<span class="linenr">1600: </span>          isComponent &amp;&
<span class="linenr">1601: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Teleport is not a real component and has dedicated runtime handling</span>
<span class=
"linenr">1602: </span>          vnodeTag !== TELEPORT &amp;&
<span class="linenr">1603: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">explained above.</span>
<span class="linenr">1604: </span>          vnodeTag !== KEEP_ALIVE
<span class="linenr">1605: </span>  
<span class="linenr">1606: </span>        <span class=
"org-keyword">if</span> (shouldBuildAsSlots) {
<span class="linenr">1607: </span>          <span class=
"org-keyword">const</span> { slots, hasDynamicSlots } = buildSlots(node, context)
<span class="linenr">1608: </span>          vnodeChildren = slots
<span class="linenr">1609: </span>          <span class=
"org-keyword">if</span> (hasDynamicSlots) {
<span class=
"linenr">1610: </span>            patchFlag |= PatchFlags.DYNAMIC_SLOTS
<span class="linenr">1611: </span>          }
<span class="linenr">1612: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;& vnodeTag !== TELEPORT) {
<span class="linenr">1613: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = node.children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">1614: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">type</span> = child.type
<span class="linenr">1615: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check for dynamic text children</span>
<span class="linenr">1616: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasDynamicTextChild</span> =
<span class=
"linenr">1617: </span>            type === NodeTypes.INTERPOLATION ||
<span class=
"linenr">1618: </span>            type === NodeTypes.COMPOUND_EXPRESSION
<span class="linenr">1619: </span>          <span class=
"org-keyword">if</span> (
<span class=
"linenr">1620: </span>            hasDynamicTextChild &amp;&
<span class=
"linenr">1621: </span>            getConstantType(child, context) === ConstantTypes.NOT_CONSTANT
<span class="linenr">1622: </span>          ) {
<span class=
"linenr">1623: </span>            patchFlag |= PatchFlags.TEXT
<span class="linenr">1624: </span>          }
<span class="linenr">1625: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">pass directly if the only child is a text node</span>
<span class="linenr">1626: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(plain / interpolation / expression)</span>
<span class="linenr">1627: </span>          <span class=
"org-keyword">if</span> (hasDynamicTextChild || type === NodeTypes.TEXT) {
<span class="linenr">1628: </span>            vnodeChildren = child
<span class="linenr">1629: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr">1630: </span>            vnodeChildren = node.children
<span class="linenr">1631: </span>          }
<span class="linenr">1632: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">1633: </span>          vnodeChildren = node.children
<span class="linenr">1634: </span>        }
<span class="linenr">1635: </span>      }
<span class="linenr">1636: </span>  
<span class="linenr">1637: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag & dynamicPropNames</span>
<span class="linenr">1638: </span>      <span class=
"org-keyword">if</span> (patchFlag !== <span class=
"org-highlight-numbers-number">0</span>) {
<span class=
"linenr">1639: </span>        vnodePatchFlag = String(patchFlag)
<span class="linenr">1640: </span>        <span class=
"org-keyword">if</span> (dynamicPropNames &amp;& dynamicPropNames.length) {
<span class=
"linenr">1641: </span>          vnodeDynamicProps = stringifyDynamicPropNames(dynamicPropNames)
<span class="linenr">1642: </span>        }
<span class="linenr">1643: </span>      }
<span class="linenr">1644: </span>  
<span class=
"linenr">1645: </span>      node.codegenNode = createVNodeCall(
<span class="linenr">1646: </span>        context,
<span class="linenr">1647: </span>        vnodeTag,
<span class="linenr">1648: </span>        vnodeProps,
<span class="linenr">1649: </span>        vnodeChildren,
<span class="linenr">1650: </span>        vnodePatchFlag,
<span class="linenr">1651: </span>        vnodeDynamicProps,
<span class="linenr">1652: </span>        vnodeDirectives,
<span class="linenr">1653: </span>        !!shouldUseBlock,
<span class="linenr">1654: </span>        <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">disableTracking</span><span class=
"org-comment-delimiter"> */</span>,
<span class="linenr">1655: </span>        isComponent,
<span class="linenr">1656: </span>        node.loc
<span class="linenr">1657: </span>      )
<span class="linenr">1658: </span>    }
<span class="linenr">1659: </span>  }
<span class="linenr">1660: </span>  
<span class="linenr">1661: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">resolveComponentType</span>(
<span class="linenr">1662: </span>    <span class=
"org-variable-name">node</span>,
<span class="linenr">1663: </span>    <span class=
"org-variable-name">context</span>,
<span class="linenr">1664: </span>    ssr = <span class=
"org-constant">false</span>
<span class="linenr">1665: </span>  ) {
<span class="linenr">1666: </span>    <span class=
"org-keyword">let</span> { tag } = node
<span class="linenr">1667: </span>  
<span class="linenr">1668: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. dynamic component</span>
<span class="linenr">1669: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isExplicitDynamic</span> = isComponentTag(tag)
<span class="linenr">1670: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isProp</span> = findProp(node, <span class=
"org-string">'is'</span>)
<span class="linenr">1671: </span>    <span class=
"org-keyword">if</span> (isProp) {
<span class="linenr">1672: </span>      <span class=
"org-keyword">if</span> (isExplicitDynamic ) {
<span class="linenr">1673: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> =
<span class=
"linenr">1674: </span>          isProp.type === NodeTypes.ATTRIBUTE
<span class=
"linenr">1675: </span>            ? isProp.value &amp;& createSimpleExpression(isProp.value.content, <span class="org-constant">true</span>)
<span class="linenr">1676: </span>            : isProp.exp
<span class="linenr">1677: </span>        <span class=
"org-keyword">if</span> (exp) {
<span class="linenr">1678: </span>          <span class=
"org-keyword">return</span> createCallExpression(context.helper(RESOLVE_DYNAMIC_COMPONENT), [
<span class="linenr">1679: </span>            exp
<span class="linenr">1680: </span>          ])
<span class="linenr">1681: </span>        }
<span class="linenr">1682: </span>      } <span class=
"org-keyword">else</span> <span class="org-keyword">if</span> (
<span class=
"linenr">1683: </span>        isProp.type === NodeTypes.ATTRIBUTE &amp;&
<span class=
"linenr">1684: </span>        isProp.value.content.startsWith(<span class="org-string">'vue:'</span>)
<span class="linenr">1685: </span>      ) {
<span class="linenr">1686: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;button is="vue:xxx"&gt;</span>
<span class="linenr">1687: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if not &lt;component&gt;, only is value that starts with "vue:" will be</span>
<span class="linenr">1688: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">treated as component by the parse phase and reach here, unless it's</span>
<span class="linenr">1689: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">compat mode where all is values are considered components</span>
<span class=
"linenr">1690: </span>        tag = isProp.value.content.slice(<span class="org-highlight-numbers-number">4</span>)
<span class="linenr">1691: </span>      }
<span class="linenr">1692: </span>    }
<span class="linenr">1693: </span>  
<span class="linenr">1694: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1.5 v-is (</span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO:</span></span></span><span class=
"org-comment"> Deprecate)</span>
<span class="linenr">1695: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDir</span> = !isExplicitDynamic &amp;& findDir(node, <span class="org-string">'is'</span>)
<span class="linenr">1696: </span>    <span class=
"org-keyword">if</span> (isDir &amp;& isDir.exp) {
<span class="linenr">1697: </span>      <span class=
"org-keyword">return</span> createCallExpression(context.helper(RESOLVE_DYNAMIC_COMPONENT), [
<span class="linenr">1698: </span>        isDir.exp
<span class="linenr">1699: </span>      ])
<span class="linenr">1700: </span>    }
<span class="linenr">1701: </span>  
<span class="linenr">1702: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. built-in components (Teleport, Transition, KeepAlive, Suspense...)</span>
<span class="linenr">1703: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">builtIn</span> = isCoreComponent(tag) || context.isBuiltInComponent(tag)
<span class="linenr">1704: </span>    <span class=
"org-keyword">if</span> (builtIn) {
<span class="linenr">1705: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">built-ins are simply fallthroughs / have special handling during ssr</span>
<span class="linenr">1706: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so we don't need to import their runtime equivalents</span>
<span class="linenr">1707: </span>      <span class=
"org-keyword">if</span> (!ssr) context.helper(builtIn)
<span class="linenr">1708: </span>      <span class=
"org-keyword">return</span> builtIn
<span class="linenr">1709: </span>    }
<span class="linenr">1710: </span>  
<span class="linenr">1711: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. user component (from setup bindings)</span>
<span class="linenr">1712: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this is skipped in browser build since browser builds do not perform</span>
<span class="linenr">1713: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">binding analysis.</span>
<span class="linenr">1714: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__) {
<span class="linenr">1715: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromSetup</span> = resolveSetupReference(tag, context)
<span class="linenr">1716: </span>      <span class=
"org-keyword">if</span> (fromSetup) {
<span class="linenr">1717: </span>        <span class=
"org-keyword">return</span> fromSetup
<span class="linenr">1718: </span>      }
<span class="linenr">1719: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dotIndex</span> = tag.indexOf(<span class=
"org-string">'.'</span>)
<span class="linenr">1720: </span>      <span class=
"org-keyword">if</span> (dotIndex &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">1721: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ns</span> = resolveSetupReference(tag.slice(<span class="org-highlight-numbers-number">0</span>, dotIndex), context)
<span class="linenr">1722: </span>        <span class=
"org-keyword">if</span> (ns) {
<span class="linenr">1723: </span>          <span class=
"org-keyword">return</span> ns + tag.slice(dotIndex)
<span class="linenr">1724: </span>        }
<span class="linenr">1725: </span>      }
<span class="linenr">1726: </span>    }
<span class="linenr">1727: </span>  
<span class="linenr">1728: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">4. Self referencing component (inferred from filename)</span>
<span class="linenr">1729: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">1730: </span>      !__BROWSER__ &amp;&
<span class="linenr">1731: </span>      context.selfName &amp;&
<span class=
"linenr">1732: </span>      capitalize(camelize(tag)) === context.selfName
<span class="linenr">1733: </span>    ) {
<span class=
"linenr">1734: </span>      context.helper(RESOLVE_COMPONENT)
<span class="linenr">1735: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">codegen.ts has special check for __self postfix when generating</span>
<span class="linenr">1736: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">component imports, which will pass additional `maybeSelfReference` flag</span>
<span class="linenr">1737: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to `resolveComponent`.</span>
<span class=
"linenr">1738: </span>      context.components.add(tag + <span class="org-string">`__self`</span>)
<span class="linenr">1739: </span>      <span class=
"org-keyword">return</span> toValidAssetId(tag, <span class=
"org-string">`component`</span>)
<span class="linenr">1740: </span>    }
<span class="linenr">1741: </span>  
<span class="linenr">1742: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">5. user component (resolve)</span>
<span class=
"linenr">1743: </span>    context.helper(RESOLVE_COMPONENT)
<span class="linenr">1744: </span>    context.components.add(tag)
<span class="linenr">1745: </span>    <span class=
"org-keyword">return</span> toValidAssetId(tag, <span class=
"org-string">`component`</span>)
<span class="linenr">1746: </span>  }
<span class="linenr">1747: </span>  
<span class="linenr">1748: </span>  
<span class="linenr">1749: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">resolveSetupReference</span>(<span class=
"org-variable-name">name</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">1750: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bindings</span> = context.bindingMetadata
<span class="linenr">1751: </span>    <span class=
"org-keyword">if</span> (!bindings || bindings.__isScriptSetup === <span class="org-constant">false</span>) {
<span class="linenr">1752: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">1753: </span>    }
<span class="linenr">1754: </span>  
<span class="linenr">1755: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">camelName</span> = camelize(name)
<span class="linenr">1756: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">PascalName</span> = capitalize(camelName)
<span class="linenr">1757: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">checkType</span> = (type) =&gt; {
<span class="linenr">1758: </span>      <span class=
"org-keyword">if</span> (bindings[name] === type) {
<span class="linenr">1759: </span>        <span class=
"org-keyword">return</span> name
<span class="linenr">1760: </span>      }
<span class="linenr">1761: </span>      <span class=
"org-keyword">if</span> (bindings[camelName] === type) {
<span class="linenr">1762: </span>        <span class=
"org-keyword">return</span> camelName
<span class="linenr">1763: </span>      }
<span class="linenr">1764: </span>      <span class=
"org-keyword">if</span> (bindings[PascalName] === type) {
<span class="linenr">1765: </span>        <span class=
"org-keyword">return</span> PascalName
<span class="linenr">1766: </span>      }
<span class="linenr">1767: </span>    }
<span class="linenr">1768: </span>  
<span class="linenr">1769: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromConst</span> = checkType(BindingTypes.SETUP_CONST)
<span class="linenr">1770: </span>    <span class=
"org-keyword">if</span> (fromConst) {
<span class="linenr">1771: </span>      <span class=
"org-keyword">return</span> context.inline
<span class="linenr">1772: </span>        ? <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in inline mode, const setup bindings (e.g. imports) can be used as-is</span>
<span class="linenr">1773: </span>          fromConst
<span class="linenr">1774: </span>        : <span class=
"org-string">`$setup[${JSON.stringify(fromConst)}]`</span>
<span class="linenr">1775: </span>    }
<span class="linenr">1776: </span>  
<span class="linenr">1777: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromMaybeRef</span> =
<span class=
"linenr">1778: </span>      checkType(BindingTypes.SETUP_LET) ||
<span class=
"linenr">1779: </span>      checkType(BindingTypes.SETUP_REF) ||
<span class=
"linenr">1780: </span>      checkType(BindingTypes.SETUP_MAYBE_REF)
<span class="linenr">1781: </span>    <span class=
"org-keyword">if</span> (fromMaybeRef) {
<span class="linenr">1782: </span>      <span class=
"org-keyword">return</span> context.inline
<span class="linenr">1783: </span>        ? <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">setup scope bindings that may be refs need to be unrefed</span>
<span class="linenr">1784: </span>          <span class=
"org-string">`${context.helperString(UNREF)}(${fromMaybeRef})`</span>
<span class="linenr">1785: </span>        : <span class=
"org-string">`$setup[${JSON.stringify(fromMaybeRef)}]`</span>
<span class="linenr">1786: </span>    }
<span class="linenr">1787: </span>  }
<span class="linenr">1788: </span>  
<span class="linenr">1789: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">buildProps</span>(
<span class="linenr">1790: </span>    <span class=
"org-variable-name">node</span>,
<span class="linenr">1791: </span>    <span class=
"org-variable-name">context</span>,
<span class="linenr">1792: </span>    props = node.props,
<span class="linenr">1793: </span>    ssr = <span class=
"org-constant">false</span>
<span class="linenr">1794: </span>  ) {
<span class="linenr">1795: </span>    <span class=
"org-keyword">const</span> { tag, loc: elementLoc, children } = node
<span class="linenr">1796: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isComponent</span> = node.tagType === ElementTypes.COMPONENT
<span class="linenr">1797: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">properties</span> = []
<span class="linenr">1798: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">mergeArgs</span> = []
<span class="linenr">1799: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">runtimeDirectives</span> = []
<span class="linenr">1800: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasChildren</span> = children.length &gt; <span class="org-highlight-numbers-number">0</span>
<span class="linenr">1801: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">shouldUseBlock</span> = <span class=
"org-constant">false</span>
<span class="linenr">1802: </span>  
<span class="linenr">1803: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag analysis</span>
<span class="linenr">1804: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">1805: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasRef</span> = <span class=
"org-constant">false</span>
<span class="linenr">1806: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasClassBinding</span> = <span class=
"org-constant">false</span>
<span class="linenr">1807: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasStyleBinding</span> = <span class=
"org-constant">false</span>
<span class="linenr">1808: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasHydrationEventBinding</span> = <span class=
"org-constant">false</span>
<span class="linenr">1809: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasDynamicKeys</span> = <span class=
"org-constant">false</span>
<span class="linenr">1810: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasVnodeHook</span> = <span class=
"org-constant">false</span>
<span class="linenr">1811: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dynamicPropNames</span> = []
<span class="linenr">1812: </span>  
<span class="linenr">1813: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">analyzePatchFlag</span> = ({ key, value }) =&gt; {
<span class="linenr">1814: </span>      <span class=
"org-keyword">if</span> (isStaticExp(key)) {
<span class="linenr">1815: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> = key.content
<span class="linenr">1816: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isEventHandler</span> = isOn(name)
<span class="linenr">1817: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">1818: </span>          !isComponent &amp;&
<span class="linenr">1819: </span>          isEventHandler &amp;&
<span class="linenr">1820: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">omit the flag for click handlers because hydration gives click</span>
<span class="linenr">1821: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dedicated fast path.</span>
<span class=
"linenr">1822: </span>          name.toLowerCase() !== <span class=
"org-string">'onclick'</span> &amp;&
<span class="linenr">1823: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">omit v-model handlers</span>
<span class="linenr">1824: </span>          name !== <span class=
"org-string">'onUpdate:modelValue'</span> &amp;&
<span class="linenr">1825: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">omit onVnodeXXX hooks</span>
<span class="linenr">1826: </span>          !isReservedProp(name)
<span class="linenr">1827: </span>        ) {
<span class=
"linenr">1828: </span>          hasHydrationEventBinding = <span class="org-constant">true</span>
<span class="linenr">1829: </span>        }
<span class="linenr">1830: </span>  
<span class="linenr">1831: </span>        <span class=
"org-keyword">if</span> (isEventHandler &amp;& isReservedProp(name)) {
<span class=
"linenr">1832: </span>          hasVnodeHook = <span class=
"org-constant">true</span>
<span class="linenr">1833: </span>        }
<span class="linenr">1834: </span>  
<span class="linenr">1835: </span>        <span class=
"org-keyword">if</span> (
<span class=
"linenr">1836: </span>          value.type === NodeTypes.JS_CACHE_EXPRESSION ||
<span class=
"linenr">1837: </span>          ((value.type === NodeTypes.SIMPLE_EXPRESSION ||
<span class=
"linenr">1838: </span>            value.type === NodeTypes.COMPOUND_EXPRESSION) &amp;&
<span class=
"linenr">1839: </span>            getConstantType(value, context) &gt; <span class="org-highlight-numbers-number">0</span>)
<span class="linenr">1840: </span>        ) {
<span class="linenr">1841: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip if the prop is a cached handler or has constant value</span>
<span class="linenr">1842: </span>          <span class=
"org-keyword">return</span>
<span class="linenr">1843: </span>        }
<span class="linenr">1844: </span>  
<span class="linenr">1845: </span>        <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'ref'</span>) {
<span class="linenr">1846: </span>          hasRef = <span class=
"org-constant">true</span>
<span class="linenr">1847: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'class'</span>) {
<span class=
"linenr">1848: </span>          hasClassBinding = <span class=
"org-constant">true</span>
<span class="linenr">1849: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'style'</span>) {
<span class=
"linenr">1850: </span>          hasStyleBinding = <span class=
"org-constant">true</span>
<span class="linenr">1851: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (name !== <span class=
"org-string">'key'</span> &amp;& !dynamicPropNames.includes(name)) {
<span class=
"linenr">1852: </span>          dynamicPropNames.push(name)
<span class="linenr">1853: </span>        }
<span class="linenr">1854: </span>  
<span class="linenr">1855: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">treat the dynamic class and style binding of the component as dynamic props</span>
<span class="linenr">1856: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">1857: </span>          isComponent &amp;&
<span class="linenr">1858: </span>          (name === <span class=
"org-string">'class'</span> || name === <span class=
"org-string">'style'</span>) &amp;&
<span class=
"linenr">1859: </span>          !dynamicPropNames.includes(name)
<span class="linenr">1860: </span>        ) {
<span class=
"linenr">1861: </span>          dynamicPropNames.push(name)
<span class="linenr">1862: </span>        }
<span class="linenr">1863: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">1864: </span>        hasDynamicKeys = <span class=
"org-constant">true</span>
<span class="linenr">1865: </span>      }
<span class="linenr">1866: </span>    }
<span class="linenr">1867: </span>  
<span class="linenr">1868: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; props.length; i++) {
<span class="linenr">1869: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">static attribute</span>
<span class="linenr">1870: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prop</span> = props[i]
<span class="linenr">1871: </span>      <span class=
"org-keyword">if</span> (prop.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">1872: </span>        <span class=
"org-keyword">const</span> { loc, name, value } = prop
<span class="linenr">1873: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isStatic</span> = <span class=
"org-constant">true</span>
<span class="linenr">1874: </span>        <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'ref'</span>) {
<span class="linenr">1875: </span>          hasRef = <span class=
"org-constant">true</span>
<span class="linenr">1876: </span>          <span class=
"org-keyword">if</span> (context.scopes.vFor &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">1877: </span>            properties.push(
<span class=
"linenr">1878: </span>              createObjectProperty(
<span class=
"linenr">1879: </span>                createSimpleExpression(<span class="org-string">'ref_for'</span>, <span class="org-constant">true</span>),
<span class=
"linenr">1880: </span>                createSimpleExpression(<span class="org-string">'true'</span>)
<span class="linenr">1881: </span>              )
<span class="linenr">1882: </span>            )
<span class="linenr">1883: </span>          }
<span class="linenr">1884: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in inline mode there is no setupState object, so we can't use string</span>
<span class="linenr">1885: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">keys to set the ref. Instead, we need to transform it to pass the</span>
<span class="linenr">1886: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">actual ref instead.</span>
<span class="linenr">1887: </span>          <span class=
"org-keyword">if</span> (
<span class="linenr">1888: </span>            !__BROWSER__ &amp;&
<span class="linenr">1889: </span>            value &amp;&
<span class="linenr">1890: </span>            context.inline &amp;&
<span class=
"linenr">1891: </span>            context.bindingMetadata[value.content]
<span class="linenr">1892: </span>          ) {
<span class=
"linenr">1893: </span>            isStatic = <span class=
"org-constant">false</span>
<span class="linenr">1894: </span>            properties.push(
<span class=
"linenr">1895: </span>              createObjectProperty(
<span class=
"linenr">1896: </span>                createSimpleExpression(<span class="org-string">'ref_key'</span>, <span class="org-constant">true</span>),
<span class=
"linenr">1897: </span>                createSimpleExpression(value.content, <span class="org-constant">true</span>, value.loc)
<span class="linenr">1898: </span>              )
<span class="linenr">1899: </span>            )
<span class="linenr">1900: </span>          }
<span class="linenr">1901: </span>        }
<span class="linenr">1902: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip is on &lt;component&gt;, or is="vue:xxx"</span>
<span class="linenr">1903: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">1904: </span>          name === <span class=
"org-string">'is'</span> &amp;&
<span class="linenr">1905: </span>          (isComponentTag(tag) ||
<span class=
"linenr">1906: </span>            (value &amp;& value.content.startsWith(<span class="org-string">'vue:'</span>)))
<span class="linenr">1907: </span>        ) {
<span class="linenr">1908: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">1909: </span>        }
<span class="linenr">1910: </span>        properties.push(
<span class="linenr">1911: </span>          createObjectProperty(
<span class=
"linenr">1912: </span>            createSimpleExpression(
<span class="linenr">1913: </span>              name,
<span class="linenr">1914: </span>              <span class=
"org-constant">true</span>,
<span class=
"linenr">1915: </span>              getInnerRange(loc, <span class=
"org-highlight-numbers-number">0</span>, name.length)
<span class="linenr">1916: </span>            ),
<span class=
"linenr">1917: </span>            createSimpleExpression(
<span class=
"linenr">1918: </span>              value ? value.content : <span class="org-string">''</span>,
<span class="linenr">1919: </span>              isStatic,
<span class=
"linenr">1920: </span>              value ? value.loc : loc
<span class="linenr">1921: </span>            )
<span class="linenr">1922: </span>          )
<span class="linenr">1923: </span>        )
<span class="linenr">1924: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">1925: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">directives</span>
<span class="linenr">1926: </span>        <span class=
"org-keyword">const</span> { name, arg, exp, loc } = prop
<span class="linenr">1927: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isVBind</span> = name === <span class=
"org-string">'bind'</span>
<span class="linenr">1928: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isVOn</span> = name === <span class=
"org-string">'on'</span>
<span class="linenr">1929: </span>  
<span class="linenr">1930: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-slot - it is handled by its dedicated transform.</span>
<span class="linenr">1931: </span>        <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'slot'</span>) {
<span class="linenr">1932: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">1933: </span>        }
<span class="linenr">1934: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-once/v-memo - they are handled by dedicated transforms.</span>
<span class="linenr">1935: </span>        <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'once'</span> || name === <span class=
"org-string">'memo'</span>) {
<span class="linenr">1936: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">1937: </span>        }
<span class="linenr">1938: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-is and :is on &lt;component&gt;</span>
<span class="linenr">1939: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">1940: </span>          name === <span class=
"org-string">'is'</span> ||
<span class="linenr">1941: </span>          (isVBind &amp;&
<span class=
"linenr">1942: </span>            isStaticArgOf(arg, <span class=
"org-string">'is'</span>) &amp;&
<span class="linenr">1943: </span>            isComponentTag(tag))
<span class="linenr">1944: </span>        ) {
<span class="linenr">1945: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">1946: </span>        }
<span class="linenr">1947: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip v-on in SSR compilation</span>
<span class="linenr">1948: </span>        <span class=
"org-keyword">if</span> (isVOn &amp;& ssr) {
<span class="linenr">1949: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">1950: </span>        }
<span class="linenr">1951: </span>  
<span class="linenr">1952: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">1953: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#938: elements with dynamic keys should be forced into blocks</span>
<span class=
"linenr">1954: </span>          (isVBind &amp;& isStaticArgOf(arg, <span class="org-string">'key'</span>)) ||
<span class="linenr">1955: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inline before-update hooks need to force block so that it is invoked</span>
<span class="linenr">1956: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">before children</span>
<span class=
"linenr">1957: </span>          (isVOn &amp;& hasChildren &amp;& isStaticArgOf(arg, <span class="org-string">'vue:before-update'</span>))
<span class="linenr">1958: </span>        ) {
<span class=
"linenr">1959: </span>          shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr">1960: </span>        }
<span class="linenr">1961: </span>  
<span class="linenr">1962: </span>        <span class=
"org-keyword">if</span> (isVBind &amp;& isStaticArgOf(arg, <span class="org-string">'ref'</span>) &amp;& context.scopes.vFor &gt; <span class="org-highlight-numbers-number">0</span>) {
<span class="linenr">1963: </span>          properties.push(
<span class="linenr">1964: </span>            createObjectProperty(
<span class=
"linenr">1965: </span>              createSimpleExpression(<span class="org-string">'ref_for'</span>, <span class="org-constant">true</span>),
<span class=
"linenr">1966: </span>              createSimpleExpression(<span class="org-string">'true'</span>)
<span class="linenr">1967: </span>            )
<span class="linenr">1968: </span>          )
<span class="linenr">1969: </span>        }
<span class="linenr">1970: </span>  
<span class="linenr">1971: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">special case for v-bind and v-on with no argument</span>
<span class="linenr">1972: </span>        <span class=
"org-keyword">if</span> (!arg &amp;& (isVBind || isVOn)) {
<span class=
"linenr">1973: </span>          hasDynamicKeys = <span class=
"org-constant">true</span>
<span class="linenr">1974: </span>          <span class=
"org-keyword">if</span> (exp) {
<span class="linenr">1975: </span>            <span class=
"org-keyword">if</span> (properties.length) {
<span class="linenr">1976: </span>              mergeArgs.push(
<span class=
"linenr">1977: </span>                createObjectExpression(dedupeProperties(properties), elementLoc)
<span class="linenr">1978: </span>              )
<span class="linenr">1979: </span>              properties = []
<span class="linenr">1980: </span>            }
<span class="linenr">1981: </span>            <span class=
"org-keyword">if</span> (isVBind) {
<span class="linenr">1982: </span>              mergeArgs.push(exp)
<span class="linenr">1983: </span>            } <span class=
"org-keyword">else</span> {
<span class="linenr">1984: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on="obj" -&gt; toHandlers(obj)</span>
<span class="linenr">1985: </span>              mergeArgs.push({
<span class=
"linenr">1986: </span>                type: NodeTypes.JS_CALL_EXPRESSION,
<span class="linenr">1987: </span>                loc,
<span class=
"linenr">1988: </span>                callee: context.helper(TO_HANDLERS),
<span class="linenr">1989: </span>                <span class=
"org-constant">arguments</span>: [exp]
<span class="linenr">1990: </span>              })
<span class="linenr">1991: </span>            }
<span class="linenr">1992: </span>          }
<span class="linenr">1993: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">1994: </span>        }
<span class="linenr">1995: </span>  
<span class="linenr">1996: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">directiveTransform</span> = context.directiveTransforms[name]
<span class="linenr">1997: </span>        <span class=
"org-keyword">if</span> (directiveTransform) {
<span class="linenr">1998: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">has built-in directive transform.</span>
<span class="linenr">1999: </span>          <span class=
"org-keyword">const</span> { props, needRuntime } = directiveTransform(prop, node, context)
<span class=
"linenr">2000: </span>          !ssr &amp;& props.forEach(analyzePatchFlag)
<span class=
"linenr">2001: </span>          properties.push(...props)
<span class="linenr">2002: </span>          <span class=
"org-keyword">if</span> (needRuntime) {
<span class=
"linenr">2003: </span>            runtimeDirectives.push(prop)
<span class="linenr">2004: </span>            <span class=
"org-keyword">if</span> (isSymbol(needRuntime)) {
<span class=
"linenr">2005: </span>              directiveImportMap.set(prop, needRuntime)
<span class="linenr">2006: </span>            }
<span class="linenr">2007: </span>          }
<span class="linenr">2008: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!isBuiltInDirective(name)) {
<span class="linenr">2009: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no built-in transform, this is a user custom directive.</span>
<span class=
"linenr">2010: </span>          runtimeDirectives.push(prop)
<span class="linenr">2011: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">custom dirs may use beforeUpdate so they need to force blocks</span>
<span class="linenr">2012: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to ensure before-update gets called before children update</span>
<span class="linenr">2013: </span>          <span class=
"org-keyword">if</span> (hasChildren) {
<span class=
"linenr">2014: </span>            shouldUseBlock = <span class=
"org-constant">true</span>
<span class="linenr">2015: </span>          }
<span class="linenr">2016: </span>        }
<span class="linenr">2017: </span>      }
<span class="linenr">2018: </span>    }
<span class="linenr">2019: </span>  
<span class="linenr">2020: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">propsExpression</span> = <span class=
"org-constant">undefined</span>
<span class="linenr">2021: </span>  
<span class="linenr">2022: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">has v-bind="object" or v-on="object", wrap with mergeProps</span>
<span class="linenr">2023: </span>    <span class=
"org-keyword">if</span> (mergeArgs.length) {
<span class="linenr">2024: </span>      <span class=
"org-keyword">if</span> (properties.length) {
<span class="linenr">2025: </span>        mergeArgs.push(
<span class=
"linenr">2026: </span>          createObjectExpression(dedupeProperties(properties), elementLoc)
<span class="linenr">2027: </span>        )
<span class="linenr">2028: </span>      }
<span class="linenr">2029: </span>      <span class=
"org-keyword">if</span> (mergeArgs.length &gt; <span class=
"org-highlight-numbers-number">1</span>) {
<span class=
"linenr">2030: </span>        propsExpression = createCallExpression(
<span class=
"linenr">2031: </span>          context.helper(MERGE_PROPS),
<span class="linenr">2032: </span>          mergeArgs,
<span class="linenr">2033: </span>          elementLoc
<span class="linenr">2034: </span>        )
<span class="linenr">2035: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">2036: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single v-bind with nothing else - no need for a mergeProps call</span>
<span class=
"linenr">2037: </span>        propsExpression = mergeArgs[<span class="org-highlight-numbers-number">0</span>]
<span class="linenr">2038: </span>      }
<span class="linenr">2039: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (properties.length) {
<span class=
"linenr">2040: </span>      propsExpression = createObjectExpression(
<span class=
"linenr">2041: </span>        dedupeProperties(properties),
<span class="linenr">2042: </span>        elementLoc
<span class="linenr">2043: </span>      )
<span class="linenr">2044: </span>    }
<span class="linenr">2045: </span>  
<span class="linenr">2046: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">patchFlag analysis</span>
<span class="linenr">2047: </span>    <span class=
"org-keyword">if</span> (hasDynamicKeys) {
<span class=
"linenr">2048: </span>      patchFlag |= PatchFlags.FULL_PROPS
<span class="linenr">2049: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">2050: </span>      <span class=
"org-keyword">if</span> (hasClassBinding &amp;& !isComponent) {
<span class=
"linenr">2051: </span>        patchFlag |= PatchFlags.CLASS
<span class="linenr">2052: </span>      }
<span class="linenr">2053: </span>      <span class=
"org-keyword">if</span> (hasStyleBinding &amp;& !isComponent) {
<span class=
"linenr">2054: </span>        patchFlag |= PatchFlags.STYLE
<span class="linenr">2055: </span>      }
<span class="linenr">2056: </span>      <span class=
"org-keyword">if</span> (dynamicPropNames.length) {
<span class=
"linenr">2057: </span>        patchFlag |= PatchFlags.PROPS
<span class="linenr">2058: </span>      }
<span class="linenr">2059: </span>      <span class=
"org-keyword">if</span> (hasHydrationEventBinding) {
<span class=
"linenr">2060: </span>        patchFlag |= PatchFlags.HYDRATE_EVENTS
<span class="linenr">2061: </span>      }
<span class="linenr">2062: </span>    }
<span class="linenr">2063: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">2064: </span>      !shouldUseBlock &amp;&
<span class="linenr">2065: </span>      (patchFlag === <span class=
"org-highlight-numbers-number">0</span> || patchFlag === PatchFlags.HYDRATE_EVENTS) &amp;&
<span class=
"linenr">2066: </span>      (hasRef || hasVnodeHook || runtimeDirectives.length &gt; <span class="org-highlight-numbers-number">0</span>)
<span class="linenr">2067: </span>    ) {
<span class=
"linenr">2068: </span>      patchFlag |= PatchFlags.NEED_PATCH
<span class="linenr">2069: </span>    }
<span class="linenr">2070: </span>  
<span class="linenr">2071: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">pre-normalize props, SSR is skipped for now</span>
<span class="linenr">2072: </span>    <span class=
"org-keyword">if</span> (!context.inSSR &amp;& propsExpression) {
<span class="linenr">2073: </span>      <span class=
"org-keyword">switch</span> (propsExpression.type) {
<span class="linenr">2074: </span>        <span class=
"org-keyword">case</span> NodeTypes.JS_OBJECT_EXPRESSION:
<span class="linenr">2075: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">means that there is no v-bind,</span>
<span class="linenr">2076: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">but still need to deal with dynamic key binding</span>
<span class="linenr">2077: </span>          <span class=
"org-keyword">let</span> <span class=
"org-variable-name">classKeyIndex</span> = -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">2078: </span>          <span class=
"org-keyword">let</span> <span class=
"org-variable-name">styleKeyIndex</span> = -<span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">2079: </span>          <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasDynamicKey</span> = <span class=
"org-constant">false</span>
<span class="linenr">2080: </span>  
<span class="linenr">2081: </span>          <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; propsExpression.properties.length; i++) {
<span class="linenr">2082: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> = propsExpression.properties[i].key
<span class="linenr">2083: </span>            <span class=
"org-keyword">if</span> (isStaticExp(key)) {
<span class="linenr">2084: </span>              <span class=
"org-keyword">if</span> (key.content === <span class=
"org-string">'class'</span>) {
<span class="linenr">2085: </span>                classKeyIndex = i
<span class="linenr">2086: </span>              } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (key.content === <span class=
"org-string">'style'</span>) {
<span class="linenr">2087: </span>                styleKeyIndex = i
<span class="linenr">2088: </span>              }
<span class="linenr">2089: </span>            } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!key.isHandlerKey) {
<span class=
"linenr">2090: </span>              hasDynamicKey = <span class=
"org-constant">true</span>
<span class="linenr">2091: </span>            }
<span class="linenr">2092: </span>          }
<span class="linenr">2093: </span>  
<span class="linenr">2094: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">classProp</span> = propsExpression.properties[classKeyIndex]
<span class="linenr">2095: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">styleProp</span> = propsExpression.properties[styleKeyIndex]
<span class="linenr">2096: </span>  
<span class="linenr">2097: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">no dynamic key</span>
<span class="linenr">2098: </span>          <span class=
"org-keyword">if</span> (!hasDynamicKey) {
<span class="linenr">2099: </span>            <span class=
"org-keyword">if</span> (classProp &amp;& !isStaticExp(classProp.value)) {
<span class=
"linenr">2100: </span>              classProp.value = createCallExpression(
<span class=
"linenr">2101: </span>                context.helper(NORMALIZE_CLASS),
<span class="linenr">2102: </span>                [classProp.value]
<span class="linenr">2103: </span>              )
<span class="linenr">2104: </span>            }
<span class="linenr">2105: </span>            <span class=
"org-keyword">if</span> (
<span class="linenr">2106: </span>              styleProp &amp;&
<span class=
"linenr">2107: </span>              !isStaticExp(styleProp.value) &amp;&
<span class="linenr">2108: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the static style is compiled into an object,</span>
<span class="linenr">2109: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so use `hasStyleBinding` to ensure that it is a dynamic style binding</span>
<span class="linenr">2110: </span>              (hasStyleBinding ||
<span class="linenr">2111: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-bind:style and style both exist,</span>
<span class="linenr">2112: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-bind:style with static literal object</span>
<span class=
"linenr">2113: </span>                styleProp.value.type === NodeTypes.JS_ARRAY_EXPRESSION)
<span class="linenr">2114: </span>            ) {
<span class=
"linenr">2115: </span>              styleProp.value = createCallExpression(
<span class=
"linenr">2116: </span>                context.helper(NORMALIZE_STYLE),
<span class="linenr">2117: </span>                [styleProp.value]
<span class="linenr">2118: </span>              )
<span class="linenr">2119: </span>            }
<span class="linenr">2120: </span>          } <span class=
"org-keyword">else</span> {
<span class="linenr">2121: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dynamic key binding, wrap with `normalizeProps`</span>
<span class=
"linenr">2122: </span>            propsExpression = createCallExpression(
<span class=
"linenr">2123: </span>              context.helper(NORMALIZE_PROPS),
<span class="linenr">2124: </span>              [propsExpression]
<span class="linenr">2125: </span>            )
<span class="linenr">2126: </span>          }
<span class="linenr">2127: </span>          <span class=
"org-keyword">break</span>
<span class="linenr">2128: </span>        <span class=
"org-keyword">case</span> NodeTypes.JS_CALL_EXPRESSION:
<span class="linenr">2129: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mergeProps call, do nothing</span>
<span class="linenr">2130: </span>          <span class=
"org-keyword">break</span>
<span class="linenr">2131: </span>        <span class=
"org-keyword">default</span>:
<span class="linenr">2132: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single v-bind</span>
<span class=
"linenr">2133: </span>          propsExpression = createCallExpression(
<span class=
"linenr">2134: </span>            context.helper(NORMALIZE_PROPS),
<span class="linenr">2135: </span>            [
<span class=
"linenr">2136: </span>              createCallExpression(context.helper(GUARD_REACTIVE_PROPS), [
<span class="linenr">2137: </span>                propsExpression
<span class="linenr">2138: </span>              ])
<span class="linenr">2139: </span>            ]
<span class="linenr">2140: </span>          )
<span class="linenr">2141: </span>          <span class=
"org-keyword">break</span>
<span class="linenr">2142: </span>      }
<span class="linenr">2143: </span>    }
<span class="linenr">2144: </span>  
<span class="linenr">2145: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">2146: </span>      props: propsExpression,
<span class=
"linenr">2147: </span>      directives: runtimeDirectives,
<span class="linenr">2148: </span>      patchFlag,
<span class="linenr">2149: </span>      dynamicPropNames,
<span class="linenr">2150: </span>      shouldUseBlock
<span class="linenr">2151: </span>    }
<span class="linenr">2152: </span>  }
<span class="linenr">2153: </span>  
<span class="linenr">2154: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Dedupe props in an object literal.</span>
<span class="linenr">2155: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Literal duplicated attributes would have been warned during the parse phase,</span>
<span class="linenr">2156: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">however, it's possible to encounter duplicated `onXXX` handlers with different</span>
<span class="linenr">2157: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">modifiers. We also need to merge static and dynamic class / style attributes.</span>
<span class="linenr">2158: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- onXXX handlers / style: merge into array</span>
<span class="linenr">2159: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">- class: merge into single expression with concatenation</span>
<span class="linenr">2160: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">dedupeProperties</span>(<span class=
"org-variable-name">properties</span>) {
<span class="linenr">2161: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">knownProps</span> = <span class=
"org-keyword">new</span> <span class="org-type">Map</span>()
<span class="linenr">2162: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">deduped</span> = []
<span class="linenr">2163: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; properties.length; i++) {
<span class="linenr">2164: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prop</span> = properties[i]
<span class="linenr">2165: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dynamic keys are always allowed</span>
<span class="linenr">2166: </span>      <span class=
"org-keyword">if</span> (prop.key.type === NodeTypes.COMPOUND_EXPRESSION || !prop.key.isStatic) {
<span class="linenr">2167: </span>        deduped.push(prop)
<span class="linenr">2168: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">2169: </span>      }
<span class="linenr">2170: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> = prop.key.content
<span class="linenr">2171: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">existing</span> = knownProps.get(name)
<span class="linenr">2172: </span>      <span class=
"org-keyword">if</span> (existing) {
<span class="linenr">2173: </span>        <span class=
"org-keyword">if</span> (name === <span class=
"org-string">'style'</span> || name === <span class=
"org-string">'class'</span> || isOn(name)) {
<span class=
"linenr">2174: </span>          mergeAsArray(existing, prop)
<span class="linenr">2175: </span>        }
<span class="linenr">2176: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">unexpected duplicate, should have emitted error during parse</span>
<span class="linenr">2177: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2178: </span>        knownProps.set(name, prop)
<span class="linenr">2179: </span>        deduped.push(prop)
<span class="linenr">2180: </span>      }
<span class="linenr">2181: </span>    }
<span class="linenr">2182: </span>    <span class=
"org-keyword">return</span> deduped
<span class="linenr">2183: </span>  }
<span class="linenr">2184: </span>  
<span class="linenr">2185: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">mergeAsArray</span>(<span class=
"org-variable-name">existing</span>, <span class=
"org-variable-name">incoming</span>) {
<span class="linenr">2186: </span>    <span class=
"org-keyword">if</span> (existing.value.type === NodeTypes.JS_ARRAY_EXPRESSION) {
<span class=
"linenr">2187: </span>      existing.value.elements.push(incoming.value)
<span class="linenr">2188: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2189: </span>      existing.value = createArrayExpression(
<span class=
"linenr">2190: </span>        [existing.value, incoming.value],
<span class="linenr">2191: </span>        existing.loc
<span class="linenr">2192: </span>      )
<span class="linenr">2193: </span>    }
<span class="linenr">2194: </span>  }
<span class="linenr">2195: </span>  
<span class="linenr">2196: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">buildDirectiveArgs</span>(
<span class="linenr">2197: </span>    <span class=
"org-variable-name">dir</span>,
<span class="linenr">2198: </span>    context
<span class="linenr">2199: </span>  ) {
<span class="linenr">2200: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dirArgs</span> = []
<span class="linenr">2201: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">runtime</span> = directiveImportMap.get(dir)
<span class="linenr">2202: </span>    <span class=
"org-keyword">if</span> (runtime) {
<span class="linenr">2203: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">built-in directive with runtime</span>
<span class=
"linenr">2204: </span>      dirArgs.push(context.helperString(runtime))
<span class="linenr">2205: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">2206: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">user directive.</span>
<span class="linenr">2207: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">see if we have directives exposed via &lt;script setup&gt;</span>
<span class="linenr">2208: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fromSetup</span> =
<span class=
"linenr">2209: </span>        !__BROWSER__ &amp;& resolveSetupReference(<span class="org-string">'v-'</span> + dir.name, context)
<span class="linenr">2210: </span>      <span class=
"org-keyword">if</span> (fromSetup) {
<span class="linenr">2211: </span>        dirArgs.push(fromSetup)
<span class="linenr">2212: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">2213: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inject statement for resolving directive</span>
<span class=
"linenr">2214: </span>        context.helper(RESOLVE_DIRECTIVE)
<span class=
"linenr">2215: </span>        context.directives.add(dir.name)
<span class=
"linenr">2216: </span>        dirArgs.push(toValidAssetId(dir.name, <span class="org-string">`directive`</span>))
<span class="linenr">2217: </span>      }
<span class="linenr">2218: </span>    }
<span class="linenr">2219: </span>    <span class=
"org-keyword">const</span> { loc } = dir
<span class="linenr">2220: </span>    <span class=
"org-keyword">if</span> (dir.exp) dirArgs.push(dir.exp)
<span class="linenr">2221: </span>    <span class=
"org-keyword">if</span> (dir.arg) {
<span class="linenr">2222: </span>      <span class=
"org-keyword">if</span> (!dir.exp) {
<span class="linenr">2223: </span>        dirArgs.push(<span class=
"org-string">`void 0`</span>)
<span class="linenr">2224: </span>      }
<span class="linenr">2225: </span>      dirArgs.push(dir.arg)
<span class="linenr">2226: </span>    }
<span class="linenr">2227: </span>    <span class=
"org-keyword">if</span> (Object.keys(dir.modifiers).length) {
<span class="linenr">2228: </span>      <span class=
"org-keyword">if</span> (!dir.arg) {
<span class="linenr">2229: </span>        <span class=
"org-keyword">if</span> (!dir.exp) {
<span class=
"linenr">2230: </span>          dirArgs.push(<span class=
"org-string">`void 0`</span>)
<span class="linenr">2231: </span>        }
<span class="linenr">2232: </span>        dirArgs.push(<span class=
"org-string">`void 0`</span>)
<span class="linenr">2233: </span>      }
<span class="linenr">2234: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">trueExpression</span> = createSimpleExpression(<span class="org-string">`true`</span>, <span class="org-constant">false</span>, loc)
<span class="linenr">2235: </span>      dirArgs.push(
<span class="linenr">2236: </span>        createObjectExpression(
<span class=
"linenr">2237: </span>          dir.modifiers.map(modifier =&gt;
<span class=
"linenr">2238: </span>            createObjectProperty(modifier, trueExpression)
<span class="linenr">2239: </span>          ),
<span class="linenr">2240: </span>          loc
<span class="linenr">2241: </span>        )
<span class="linenr">2242: </span>      )
<span class="linenr">2243: </span>    }
<span class="linenr">2244: </span>    <span class=
"org-keyword">return</span> createArrayExpression(dirArgs, dir.loc)
<span class="linenr">2245: </span>  }
<span class="linenr">2246: </span>  
<span class="linenr">2247: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyDynamicPropNames</span>(<span class=
"org-variable-name">props</span>) {
<span class="linenr">2248: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">propsNamesString</span> = <span class=
"org-string">`[`</span>
<span class="linenr">2249: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>, <span class=
"org-variable-name">l</span> = props.length; i &lt; l; i++) {
<span class=
"linenr">2250: </span>      propsNamesString += JSON.stringify(props[i])
<span class="linenr">2251: </span>      <span class=
"org-keyword">if</span> (i &lt; l - <span class=
"org-highlight-numbers-number">1</span>) propsNamesString += <span class="org-string">', '</span>
<span class="linenr">2252: </span>    }
<span class="linenr">2253: </span>    <span class=
"org-keyword">return</span> propsNamesString + <span class=
"org-string">`]`</span>
<span class="linenr">2254: </span>  }
<span class="linenr">2255: </span>  
<span class="linenr">2256: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">isComponentTag</span>(<span class=
"org-variable-name">tag</span>) {
<span class="linenr">2257: </span>    <span class=
"org-keyword">return</span> tag === <span class=
"org-string">'component'</span> || tag === <span class=
"org-string">'Component'</span>
<span class="linenr">2258: </span>  }
<span class="linenr">2259: </span>  
<span class="linenr">2260: </span>  
<span class="linenr">2261: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isLiteralWhitelisted</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(<span class=
"org-string">'true,false,null,this'</span>)
<span class="linenr">2262: </span>  
<span class="linenr">2263: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformExpression</span> = (node, context) =&gt; {
<span class="linenr">2264: </span>    logg(<span class=
"org-string">`transformExpression`</span>, node)
<span class="linenr">2265: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">插值处理</span>
<span class="linenr">2266: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.INTERPOLATION) {
<span class=
"linenr">2267: </span>      node.content = processExpression(
<span class="linenr">2268: </span>        node.content ,
<span class="linenr">2269: </span>        context
<span class="linenr">2270: </span>      )
<span class="linenr">2271: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT) {
<span class="linenr">2272: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">处理元素上的指令</span>
<span class="linenr">2273: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">2274: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dir</span> = node.props[i]
<span class="linenr">2275: </span>        logg(<span class=
"org-string">`transformExpression - prop[${i}] - directive`</span>, node.props[i])
<span class="linenr">2276: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">do not process for v-on & v-for since they are special handled</span>
<span class="linenr">2277: </span>        <span class=
"org-keyword">if</span> (dir.type === NodeTypes.DIRECTIVE &amp;& dir.name !== <span class="org-string">'for'</span>) { <span class="org-comment-delimiter">// </span><span class="org-comment">v-for 在 vFor.ts 中处理</span>
<span class="linenr">2278: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> = dir.exp
<span class="linenr">2279: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">arg</span> = dir.arg
<span class="linenr">2280: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">do not process exp if this is v-on:arg - we need special handling</span>
<span class="linenr">2281: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for wrapping inline statements.</span>
<span class="linenr">2282: </span>          <span class=
"org-keyword">if</span> (
<span class="linenr">2283: </span>            exp &amp;&
<span class=
"linenr">2284: </span>            exp.type === NodeTypes.SIMPLE_EXPRESSION &amp;&
<span class=
"linenr">2285: </span>            !(dir.name === <span class=
"org-string">'on'</span> &amp;& arg)
<span class="linenr">2286: </span>          ) {
<span class=
"linenr">2287: </span>            dir.exp = processExpression(
<span class="linenr">2288: </span>              exp,
<span class="linenr">2289: </span>              context,
<span class="linenr">2290: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">slot args must be processed as function params</span>
<span class=
"linenr">2291: </span>              dir.name === <span class=
"org-string">'slot'</span>
<span class="linenr">2292: </span>            )
<span class="linenr">2293: </span>          }
<span class="linenr">2294: </span>          <span class=
"org-keyword">if</span> (arg &amp;& arg.type === NodeTypes.SIMPLE_EXPRESSION &amp;& !arg.isStatic) {
<span class=
"linenr">2295: </span>            dir.arg = processExpression(arg, context)
<span class="linenr">2296: </span>          }
<span class="linenr">2297: </span>        }
<span class="linenr">2298: </span>      }
<span class="linenr">2299: </span>    }
<span class="linenr">2300: </span>  }
<span class="linenr">2301: </span>  
<span class="linenr">2302: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Important: since this function uses Node.js only dependencies, it should</span>
<span class="linenr">2303: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">always be used with a leading !__BROWSER__ check so that it can be</span>
<span class="linenr">2304: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">tree-shaken from the browser build.</span>
<span class="linenr">2305: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">processExpression</span>(
<span class="linenr">2306: </span>    <span class=
"org-variable-name">node</span>,
<span class="linenr">2307: </span>    <span class=
"org-variable-name">context</span>,
<span class="linenr">2308: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">some expressions like v-slot props & v-for aliases should be parsed as</span>
<span class="linenr">2309: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">function params</span>
<span class="linenr">2310: </span>    asParams = <span class=
"org-constant">false</span>,
<span class="linenr">2311: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on handler values may contain multiple statements</span>
<span class=
"linenr">2312: </span>    asRawStatements = <span class="org-constant">false</span>,
<span class=
"linenr">2313: </span>    localVars = Object.create(context.identifiers)
<span class="linenr">2314: </span>  ) {
<span class="linenr">2315: </span>    <span class=
"org-keyword">if</span> (__BROWSER__) {
<span class="linenr">2316: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">2317: </span>    }
<span class="linenr">2318: </span>  
<span class="linenr">2319: </span>    <span class=
"org-keyword">if</span> (!context.prefixIdentifiers || !node.content.trim()) {
<span class="linenr">2320: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">2321: </span>    }
<span class="linenr">2322: </span>  
<span class="linenr">2323: </span>    <span class=
"org-keyword">const</span> { inline, bindingMetadata } = context
<span class="linenr">2324: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rewriteIdentifier</span> = (raw, parent, id) =&gt; {
<span class="linenr">2325: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">type</span> = hasOwn(bindingMetadata, raw) &amp;& bindingMetadata[raw]
<span class="linenr">2326: </span>      <span class=
"org-keyword">if</span> (inline) {
<span class="linenr">2327: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x = y</span>
<span class="linenr">2328: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isAssignmentLVal</span> =
<span class=
"linenr">2329: </span>          parent &amp;& parent.type === <span class="org-string">'AssignmentExpression'</span> &amp;& parent.left === id
<span class="linenr">2330: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x++</span>
<span class="linenr">2331: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isUpdateArg</span> =
<span class=
"linenr">2332: </span>          parent &amp;& parent.type === <span class="org-string">'UpdateExpression'</span> &amp;& parent.argument === id
<span class="linenr">2333: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">({ x } = y)</span>
<span class="linenr">2334: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDestructureAssignment</span> =
<span class=
"linenr">2335: </span>          parent &amp;& isInDestructureAssignment(parent, parentStack)
<span class="linenr">2336: </span>  
<span class="linenr">2337: </span>        <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_CONST || localVars[raw]) {
<span class="linenr">2338: </span>          <span class=
"org-keyword">return</span> raw
<span class="linenr">2339: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_REF) {
<span class="linenr">2340: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`${raw}.value`</span>
<span class="linenr">2341: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_MAYBE_REF) {
<span class="linenr">2342: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">const binding that may or may not be ref</span>
<span class="linenr">2343: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if it's not a ref, then assignments don't make sense -</span>
<span class="linenr">2344: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so we ignore the non-ref assignment case and generate code</span>
<span class="linenr">2345: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">that assumes the value to be a ref for more efficiency</span>
<span class="linenr">2346: </span>          <span class=
"org-keyword">return</span> isAssignmentLVal || isUpdateArg || isDestructureAssignment
<span class="linenr">2347: </span>            ? <span class=
"org-string">`${raw}.value`</span>
<span class="linenr">2348: </span>            : <span class=
"org-string">`${context.helperString(UNREF)}(${raw})`</span>
<span class="linenr">2349: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_LET) {
<span class="linenr">2350: </span>          <span class=
"org-keyword">if</span> (isAssignmentLVal) {
<span class="linenr">2351: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding.</span>
<span class="linenr">2352: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this is a bit more tricky as we need to cover the case where</span>
<span class="linenr">2353: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let is a local non-ref value, and we need to replicate the</span>
<span class="linenr">2354: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">right hand side value.</span>
<span class="linenr">2355: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x = y --&gt; isRef(x) ? x.value = y : x = y</span>
<span class="linenr">2356: </span>            <span class=
"org-keyword">const</span> { right: rVal, operator } = parent
<span class="linenr">2357: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rExp</span> = rawExp.slice(rVal.start - <span class="org-highlight-numbers-number">1</span>, rVal.end - <span class="org-highlight-numbers-number">1</span>)
<span class="linenr">2358: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rExpString</span> = stringifyExpression(
<span class="linenr">2359: </span>              processExpression(
<span class=
"linenr">2360: </span>                createSimpleExpression(rExp, <span class="org-constant">false</span>),
<span class="linenr">2361: </span>                context,
<span class="linenr">2362: </span>                <span class=
"org-constant">false</span>,
<span class="linenr">2363: </span>                <span class=
"org-constant">false</span>,
<span class="linenr">2364: </span>                knownIds
<span class="linenr">2365: </span>              )
<span class="linenr">2366: </span>            )
<span class="linenr">2367: </span>            <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(IS_REF)}(${raw})${``} ? ${raw}.value ${operator} ${rExpString} : ${raw}`</span>
<span class="linenr">2368: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isUpdateArg) {
<span class="linenr">2369: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">make id replace parent in the code range so the raw update operator</span>
<span class="linenr">2370: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">is removed</span>
<span class=
"linenr">2371: </span>            id.start = parent.start
<span class="linenr">2372: </span>            id.end = parent.end
<span class="linenr">2373: </span>            <span class=
"org-keyword">const</span> { prefix: isPrefix, operator } = parent
<span class="linenr">2374: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prefix</span> = isPrefix ? operator : <span class="org-string">``</span>
<span class="linenr">2375: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">postfix</span> = isPrefix ? <span class=
"org-string">``</span> : operator
<span class="linenr">2376: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding.</span>
<span class="linenr">2377: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x++ --&gt; isRef(a) ? a.value++ : a++</span>
<span class="linenr">2378: </span>            <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(IS_REF)}(${raw})${``} ? ${prefix}${raw}.value${postfix} : ${prefix}${raw}${postfix}`</span>
<span class="linenr">2379: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isDestructureAssignment) {
<span class="linenr">2380: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span>
<span class="linenr">2381: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding in a destructure assignment - it's very tricky to</span>
<span class="linenr">2382: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">handle both possible cases here without altering the original</span>
<span class="linenr">2383: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">structure of the code, so we just assume it's not a ref here</span>
<span class="linenr">2384: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for now</span>
<span class="linenr">2385: </span>            <span class=
"org-keyword">return</span> raw
<span class="linenr">2386: </span>          } <span class=
"org-keyword">else</span> {
<span class="linenr">2387: </span>            <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(UNREF)}(${raw})`</span>
<span class="linenr">2388: </span>          }
<span class="linenr">2389: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS) {
<span class="linenr">2390: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">use __props which is generated by compileScript so in ts mode</span>
<span class="linenr">2391: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">it gets correct type</span>
<span class="linenr">2392: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`__props.${raw}`</span>
<span class="linenr">2393: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS_ALIASED) {
<span class="linenr">2394: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">prop with a different local alias (from defineProps() destructure)</span>
<span class="linenr">2395: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`__props.${bindingMetadata.__propsAliases[raw]}`</span>
<span class="linenr">2396: </span>        }
<span class="linenr">2397: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">2398: </span>        <span class=
"org-keyword">if</span> (type &amp;& type.startsWith(<span class=
"org-string">'setup'</span>)) {
<span class="linenr">2399: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">setup bindings in non-inline mode</span>
<span class="linenr">2400: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`$setup.${raw}`</span>
<span class="linenr">2401: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS_ALIASED) {
<span class="linenr">2402: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`$props.${bindingMetadata.__propsAliases[raw]}`</span>
<span class="linenr">2403: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type) {
<span class="linenr">2404: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`$${type}.${raw}`</span>
<span class="linenr">2405: </span>        }
<span class="linenr">2406: </span>      }
<span class="linenr">2407: </span>  
<span class="linenr">2408: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fallback to ctx</span>
<span class="linenr">2409: </span>      <span class=
"org-keyword">return</span> <span class=
"org-string">`_ctx.${raw}`</span>
<span class="linenr">2410: </span>    }
<span class="linenr">2411: </span>  
<span class="linenr">2412: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fast path if expression is a simple identifier.</span>
<span class="linenr">2413: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawExp</span> = node.content
<span class="linenr">2414: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail constant on parens (function invocation) and dot (member access)</span>
<span class="linenr">2415: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bailConstant</span> = rawExp.indexOf(<span class="org-string">`(`</span>) &gt; -<span class="org-highlight-numbers-number">1</span> || rawExp.indexOf(<span class="org-string">'.'</span>) &gt; <span class="org-highlight-numbers-number">0</span>
<span class="linenr">2416: </span>  
<span class="linenr">2417: </span>    logg(<span class=
"org-string">`processExpression - node.content: ${rawExp}`</span>)
<span class="linenr">2418: </span>    <span class=
"org-keyword">if</span> (isSimpleIdentifier(rawExp)) {
<span class="linenr">2419: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isScopeVarReference</span> = context.identifiers[rawExp]
<span class="linenr">2420: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isAllowedGlobal</span> = isGloballyWhitelisted(rawExp)
<span class="linenr">2421: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isLiteral</span> = isLiteralWhitelisted(rawExp)
<span class="linenr">2422: </span>      <span class=
"org-keyword">if</span> (!asParams &amp;& !isScopeVarReference &amp;& !isAllowedGlobal &amp;& !isLiteral) {
<span class="linenr">2423: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">const bindings exposed from setup can be skipped for patching but</span>
<span class="linenr">2424: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">cannot be hoisted to module scope</span>
<span class="linenr">2425: </span>        <span class=
"org-keyword">if</span> (bindingMetadata[node.content] === BindingTypes.SETUP_CONST) {
<span class=
"linenr">2426: </span>          node.constType = ConstantTypes.CAN_SKIP_PATCH
<span class="linenr">2427: </span>        }
<span class=
"linenr">2428: </span>        node.content = rewriteIdentifier(rawExp)
<span class="linenr">2429: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!isScopeVarReference) {
<span class="linenr">2430: </span>        <span class=
"org-keyword">if</span> (isLiteral) {
<span class=
"linenr">2431: </span>          node.constType = ConstantTypes.CAN_STRINGIFY
<span class="linenr">2432: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2433: </span>          node.constType = ConstantTypes.CAN_HOIST
<span class="linenr">2434: </span>        }
<span class="linenr">2435: </span>      }
<span class="linenr">2436: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">2437: </span>    }
<span class="linenr">2438: </span>  
<span class="linenr">2439: </span>    <span class=
"org-keyword">let</span> <span class="org-variable-name">ast</span>
<span class="linenr">2440: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">exp needs to be parsed differently:</span>
<span class="linenr">2441: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Multiple inline statements (v-on, with presence of `;`): parse as raw</span>
<span class="linenr">2442: </span>    <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">exp, but make sure to pad with spaces for consistent ranges</span>
<span class="linenr">2443: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. Expressions: wrap with parens (for e.g. object expressions)</span>
<span class="linenr">2444: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. Function arguments (v-for, v-slot): place in a function argument position</span>
<span class="linenr">2445: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">source</span> = asRawStatements
<span class="linenr">2446: </span>      ? <span class=
"org-string">` ${rawExp} `</span>
<span class="linenr">2447: </span>      : <span class=
"org-string">`(${rawExp})${asParams ? `</span>=&gt;{}<span class=
"org-string">` : ``}`</span>
<span class="linenr">2448: </span>    <span class=
"org-keyword">try</span> {
<span class=
"linenr">2449: </span>      ast = babelParser.parse(source, {
<span class=
"linenr">2450: </span>        plugins: context.expressionPlugins
<span class="linenr">2451: </span>      }).program
<span class="linenr">2452: </span>    } <span class=
"org-keyword">catch</span> (e) {
<span class="linenr">2453: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">2454: </span>    }
<span class="linenr">2455: </span>  
<span class="linenr">2456: </span>    logg(<span class=
"org-string">`processExpression - babel parse`</span>, ast)
<span class="linenr">2457: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ids</span> = []
<span class="linenr">2458: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parentStack</span> = []
<span class="linenr">2459: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">knownIds</span> = Object.create(context.identifiers)
<span class="linenr">2460: </span>  
<span class="linenr">2461: </span>    walkIdentifiers(
<span class="linenr">2462: </span>      ast,
<span class=
"linenr">2463: </span>      (node, parent, _, isReferenced, isLocal) =&gt; {
<span class="linenr">2464: </span>        <span class=
"org-keyword">if</span> (isStaticPropertyKey(node, parent)) {
<span class="linenr">2465: </span>          <span class=
"org-keyword">return</span>
<span class="linenr">2466: </span>        }
<span class="linenr">2467: </span>  
<span class="linenr">2468: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needPrefix</span> = isReferenced &amp;& canPrefix(node)
<span class="linenr">2469: </span>        <span class=
"org-keyword">if</span> (needPrefix &amp;& !isLocal) {
<span class="linenr">2470: </span>          <span class=
"org-keyword">if</span> (isStaticProperty(parent) &amp;& parent.shorthand) {
<span class="linenr">2471: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">property shorthand like { foo }, we need to add the key since</span>
<span class="linenr">2472: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we rewrite the value</span>
<span class=
"linenr">2473: </span>            node.prefix = <span class=
"org-string">`${node.name}: `</span>
<span class="linenr">2474: </span>          }
<span class=
"linenr">2475: </span>          node.name = rewriteIdentifier(node.name, parent, node)
<span class="linenr">2476: </span>          ids.push(node)
<span class="linenr">2477: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">2478: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">The identifier is considered constant unless it's pointing to a</span>
<span class="linenr">2479: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">local scope variable (a v-for alias, or a v-slot prop)</span>
<span class="linenr">2480: </span>          <span class=
"org-keyword">if</span> (!(needPrefix &amp;& isLocal) &amp;& !bailConstant) {
<span class=
"linenr">2481: </span>            node.isConstant = <span class=
"org-constant">true</span>
<span class="linenr">2482: </span>          }
<span class="linenr">2483: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also generate sub-expressions for other identifiers for better</span>
<span class="linenr">2484: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">source map support. (except for property keys which are static)</span>
<span class="linenr">2485: </span>          ids.push(node)
<span class="linenr">2486: </span>        }
<span class="linenr">2487: </span>      },
<span class="linenr">2488: </span>      <span class=
"org-constant">true</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">invoke on ALL identifiers</span>
<span class="linenr">2489: </span>      parentStack,
<span class="linenr">2490: </span>      knownIds
<span class="linenr">2491: </span>    )
<span class="linenr">2492: </span>  
<span class="linenr">2493: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">We break up the compound expression into an array of strings and sub</span>
<span class="linenr">2494: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">expressions (for identifiers that have been prefixed). In codegen, if</span>
<span class="linenr">2495: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">an ExpressionNode has the `.children` property, it will be used instead of</span>
<span class="linenr">2496: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`.content`.</span>
<span class="linenr">2497: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">children</span> = []
<span class=
"linenr">2498: </span>    ids.sort((a, b) =&gt; a.start - b.start)
<span class="linenr">2499: </span>    ids.forEach((id, i) =&gt; {
<span class="linenr">2500: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">range is offset by -1 due to the wrapping parens when parsed</span>
<span class="linenr">2501: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = id.start - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">2502: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">end</span> = id.end - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">2503: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">last</span> = ids[i - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">2504: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">leadingText</span> = rawExp.slice(last ? last.end - <span class="org-highlight-numbers-number">1</span> : <span class="org-highlight-numbers-number">0</span>, start)
<span class="linenr">2505: </span>      <span class=
"org-keyword">if</span> (leadingText.length || id.prefix) {
<span class=
"linenr">2506: </span>        children.push(leadingText + (id.prefix || <span class="org-string">``</span>))
<span class="linenr">2507: </span>      }
<span class="linenr">2508: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">source</span> = rawExp.slice(start, end)
<span class="linenr">2509: </span>      children.push(
<span class="linenr">2510: </span>        createSimpleExpression(
<span class="linenr">2511: </span>          id.name,
<span class="linenr">2512: </span>          <span class=
"org-constant">false</span>,
<span class="linenr">2513: </span>          {
<span class="linenr">2514: </span>            source,
<span class=
"linenr">2515: </span>            start: advancePositionWithClone(node.loc.start, source, start),
<span class=
"linenr">2516: </span>            end: advancePositionWithClone(node.loc.start, source, end)
<span class="linenr">2517: </span>          },
<span class=
"linenr">2518: </span>          id.isConstant ? ConstantTypes.CAN_STRINGIFY : ConstantTypes.NOT_CONSTANT
<span class="linenr">2519: </span>        )
<span class="linenr">2520: </span>      )
<span class="linenr">2521: </span>      <span class=
"org-keyword">if</span> (i === ids.length - <span class=
"org-highlight-numbers-number">1</span> &amp;& end &lt; rawExp.length) {
<span class=
"linenr">2522: </span>        children.push(rawExp.slice(end))
<span class="linenr">2523: </span>      }
<span class="linenr">2524: </span>    })
<span class="linenr">2525: </span>  
<span class="linenr">2526: </span>    <span class=
"org-keyword">let</span> <span class="org-variable-name">ret</span>
<span class="linenr">2527: </span>    <span class=
"org-keyword">if</span> (children.length) {
<span class=
"linenr">2528: </span>      ret = createCompoundExpression(children, node.loc)
<span class="linenr">2529: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">2530: </span>      ret = node
<span class=
"linenr">2531: </span>      ret.constType = bailConstant
<span class=
"linenr">2532: </span>        ? ConstantTypes.NOT_CONSTANT
<span class=
"linenr">2533: </span>        : ConstantTypes.CAN_STRINGIFY
<span class="linenr">2534: </span>    }
<span class=
"linenr">2535: </span>    ret.identifiers = Object.keys(knownIds)
<span class="linenr">2536: </span>    <span class=
"org-keyword">return</span> ret
<span class="linenr">2537: </span>  }
<span class="linenr">2538: </span>  
<span class="linenr">2539: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">canPrefix</span>(<span class=
"org-variable-name">id</span>) {
<span class="linenr">2540: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip whitelisted globals</span>
<span class="linenr">2541: </span>    <span class=
"org-keyword">if</span> (isGloballyWhitelisted(id.name)) {
<span class="linenr">2542: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">2543: </span>    }
<span class="linenr">2544: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">special case for webpack compilation</span>
<span class="linenr">2545: </span>    <span class=
"org-keyword">if</span> (id.name === <span class=
"org-string">'require'</span>) {
<span class="linenr">2546: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">2547: </span>    }
<span class="linenr">2548: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">2549: </span>  }
<span class="linenr">2550: </span>  
<span class="linenr">2551: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyExpression</span>(<span class=
"org-variable-name">exp</span>) {
<span class="linenr">2552: </span>    <span class=
"org-keyword">if</span> (isString(exp)) {
<span class="linenr">2553: </span>      <span class=
"org-keyword">return</span> exp
<span class="linenr">2554: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">2555: </span>      <span class=
"org-keyword">return</span> exp.content
<span class="linenr">2556: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">2557: </span>      <span class=
"org-keyword">return</span> (exp.children)
<span class="linenr">2558: </span>        .map(stringifyExpression)
<span class="linenr">2559: </span>        .join(<span class=
"org-string">''</span>)
<span class="linenr">2560: </span>    }
<span class="linenr">2561: </span>  }
<span class="linenr">2562: </span>  
<span class="linenr">2563: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformSlotOutlet</span> = (node, context) =&gt; {
<span class="linenr">2564: </span>    <span class=
"org-keyword">if</span> (isSlotOutlet(node)) { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;slot/&gt;</span>
<span class="linenr">2565: </span>      <span class=
"org-keyword">const</span> { children, loc } = node
<span class="linenr">2566: </span>      <span class=
"org-keyword">const</span> { slotName, slotProps } = processSlotOutlet(node, context)
<span class="linenr">2567: </span>  
<span class="linenr">2568: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotArgs</span> = [
<span class=
"linenr">2569: </span>        context.prefixIdentifiers ? <span class="org-string">`_ctx.$slots`</span> : <span class="org-string">`$slots`</span>,
<span class="linenr">2570: </span>        slotName,
<span class="linenr">2571: </span>        <span class=
"org-string">'{}'</span>, <span class=
"org-comment-delimiter">//  </span><span class=
"org-comment">props</span>
<span class="linenr">2572: </span>        <span class=
"org-string">'undefined'</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">children</span>
<span class="linenr">2573: </span>        <span class=
"org-string">'true'</span>
<span class="linenr">2574: </span>      ]
<span class="linenr">2575: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">expectedLen</span> = <span class=
"org-highlight-numbers-number">2</span>
<span class="linenr">2576: </span>  
<span class="linenr">2577: </span>      <span class=
"org-keyword">if</span> (slotProps) {
<span class="linenr">2578: </span>        slotArgs[<span class=
"org-highlight-numbers-number">2</span>] = slotProps
<span class=
"linenr">2579: </span>        expectedLen = <span class="org-highlight-numbers-number">3</span>
<span class="linenr">2580: </span>      }
<span class="linenr">2581: </span>  
<span class="linenr">2582: </span>      <span class=
"org-keyword">if</span> (children.length) {
<span class="linenr">2583: </span>        slotArgs[<span class=
"org-highlight-numbers-number">3</span>] = createFunctionExpression([], children, <span class="org-constant">false</span>, <span class="org-constant">false</span>, loc)
<span class=
"linenr">2584: </span>        expectedLen = <span class="org-highlight-numbers-number">4</span>
<span class="linenr">2585: </span>      }
<span class="linenr">2586: </span>  
<span class="linenr">2587: </span>      <span class=
"org-keyword">if</span> (context.scopeId &amp;& !context.slotted) {
<span class=
"linenr">2588: </span>        expectedLen = <span class="org-highlight-numbers-number">5</span>
<span class="linenr">2589: </span>      }
<span class=
"linenr">2590: </span>      slotArgs.splice(expectedLen) <span class="org-comment-delimiter">// </span><span class="org-comment">remove unused arguments</span>
<span class="linenr">2591: </span>  
<span class="linenr">2592: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">-&gt; renderSlot($slots, slotName, props, children, true)</span>
<span class=
"linenr">2593: </span>      node.codegenNode = createCallExpression(
<span class=
"linenr">2594: </span>        context.helper(RENDER_SLOT), <span class="org-comment-delimiter">// </span><span class="org-comment">renderSlot</span>
<span class="linenr">2595: </span>        slotArgs,
<span class="linenr">2596: </span>        loc
<span class="linenr">2597: </span>      )
<span class="linenr">2598: </span>    }
<span class="linenr">2599: </span>  }
<span class="linenr">2600: </span>  
<span class="linenr">2601: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">processSlotOutlet</span>(
<span class="linenr">2602: </span>    <span class=
"org-variable-name">node</span>,
<span class="linenr">2603: </span>    context
<span class="linenr">2604: </span>  ) {
<span class="linenr">2605: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">slotName</span> = <span class=
"org-string">`"default"`</span>
<span class="linenr">2606: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">slotProps</span> = <span class=
"org-constant">undefined</span>
<span class="linenr">2607: </span>  
<span class="linenr">2608: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nonNameProps</span> = [] <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">无名插槽</span>
<span class="linenr">2609: </span>    logg(<span class=
"org-string">`processSlotOutlet| props.length = ${node.props.length}`</span>)
<span class="linenr">2610: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">2611: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">2612: </span>      logg(<span class=
"org-string">`processSlotOutlet| props[${i}]`</span>, p)
<span class="linenr">2613: </span>      <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE) { <span class="org-comment-delimiter">// </span><span class="org-comment">静态 &lt;slot name="xxx"/&gt;</span>
<span class="linenr">2614: </span>        <span class=
"org-keyword">if</span> (p.value) {
<span class="linenr">2615: </span>          <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'name'</span>) {
<span class=
"linenr">2616: </span>            slotName = JSON.stringify(p.value.content)
<span class="linenr">2617: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2618: </span>            p.name = camelize(p.name)
<span class="linenr">2619: </span>            nonNameProps.push(p)
<span class="linenr">2620: </span>          }
<span class="linenr">2621: </span>        }
<span class="linenr">2622: </span>      } <span class=
"org-keyword">else</span> { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">动态 &lt;slot :name="xxx"/&gt;</span>
<span class="linenr">2623: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">动态插槽 &lt;slot v-bind:name="slotName"/&gt;</span>
<span class="linenr">2624: </span>        <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'bind'</span> &amp;& isStaticArgOf(p.arg, <span class=
"org-string">'name'</span>)) {
<span class="linenr">2625: </span>          <span class=
"org-keyword">if</span> (p.exp) slotName = p.exp
<span class="linenr">2626: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">2627: </span>          <span class=
"org-keyword">if</span> (p.name === <span class=
"org-string">'bind'</span> &amp;& p.arg &amp;& isStaticExp(p.arg)) {
<span class=
"linenr">2628: </span>            p.arg.content = camelize(p.arg.content)
<span class="linenr">2629: </span>          }
<span class="linenr">2630: </span>          nonNameProps.push(p)
<span class="linenr">2631: </span>        }
<span class="linenr">2632: </span>      }
<span class="linenr">2633: </span>    }
<span class="linenr">2634: </span>  
<span class="linenr">2635: </span>    logg(<span class=
"org-string">`processSlotOutlet| nonNameProps.length=${nonNameProps.length}`</span>)
<span class="linenr">2636: </span>    <span class=
"org-keyword">if</span> (nonNameProps.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">2637: </span>      <span class=
"org-keyword">const</span> { props, directives } = buildProps(node, context, nonNameProps)
<span class="linenr">2638: </span>      slotProps = props
<span class="linenr">2639: </span>  
<span class="linenr">2640: </span>      <span class=
"org-keyword">if</span> (directives.length) {
<span class="linenr">2641: </span>        logg(<span class=
"org-string">'[ERROR] X_V_SLOT_UNEXPECTED_DIRECTIVE_ON_SLOT_OUTLET'</span>)
<span class="linenr">2642: </span>      }
<span class="linenr">2643: </span>    }
<span class="linenr">2644: </span>  
<span class="linenr">2645: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">2646: </span>      slotName,
<span class="linenr">2647: </span>      slotProps
<span class="linenr">2648: </span>    }
<span class="linenr">2649: </span>  }
<span class="linenr">2650: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Merge adjacent text nodes and expressions into a single expression</span>
<span class="linenr">2651: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">e.g. &lt;div&gt;abc {{ d }} {{ e }}&lt;/div&gt; should have a single expression node as child.</span>
<span class="linenr">2652: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformText</span> = (node, context) =&gt; {
<span class="linenr">2653: </span>    <span class=
"org-keyword">if</span> (
<span class=
"linenr">2654: </span>      node.type === NodeTypes.ROOT ||
<span class=
"linenr">2655: </span>      node.type === NodeTypes.ELEMENT ||
<span class=
"linenr">2656: </span>      node.type === NodeTypes.FOR ||
<span class=
"linenr">2657: </span>      node.type === NodeTypes.IF_BRANCH
<span class="linenr">2658: </span>    ) {
<span class="linenr">2659: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">perform the transform on node exit so that all expressions have already</span>
<span class="linenr">2660: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">been processed.</span>
<span class="linenr">2661: </span>      <span class=
"org-keyword">return</span> () =&gt; {
<span class="linenr">2662: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">children</span> = node.children
<span class="linenr">2663: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">currentContainer</span> = <span class=
"org-constant">undefined</span>
<span class="linenr">2664: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">hasText</span> = <span class=
"org-constant">false</span>
<span class="linenr">2665: </span>  
<span class="linenr">2666: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; children.length; i++) {
<span class="linenr">2667: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[i]
<span class="linenr">2668: </span>          <span class=
"org-keyword">if</span> (isText(child)) {
<span class=
"linenr">2669: </span>            hasText = <span class="org-constant">true</span>
<span class="linenr">2670: </span>            <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">j</span> = i + <span class=
"org-highlight-numbers-number">1</span>; j &lt; children.length; j++) {
<span class="linenr">2671: </span>              <span class=
"org-keyword">const</span> <span class=
"org-variable-name">next</span> = children[j]
<span class="linenr">2672: </span>              <span class=
"org-keyword">if</span> (isText(next)) {
<span class="linenr">2673: </span>                <span class=
"org-keyword">if</span> (!currentContainer) {
<span class=
"linenr">2674: </span>                  currentContainer = children[i] = {
<span class=
"linenr">2675: </span>                    type: NodeTypes.COMPOUND_EXPRESSION,
<span class=
"linenr">2676: </span>                    loc: child.loc,
<span class=
"linenr">2677: </span>                    children: [child]
<span class="linenr">2678: </span>                  }
<span class="linenr">2679: </span>                }
<span class="linenr">2680: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">merge adjacent text node into current</span>
<span class=
"linenr">2681: </span>                currentContainer.children.push(<span class="org-string">` + `</span>, next)
<span class=
"linenr">2682: </span>                children.splice(j, <span class="org-highlight-numbers-number">1</span>)
<span class="linenr">2683: </span>                j--
<span class="linenr">2684: </span>              } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2685: </span>                currentContainer = <span class="org-constant">undefined</span>
<span class="linenr">2686: </span>                <span class=
"org-keyword">break</span>
<span class="linenr">2687: </span>              }
<span class="linenr">2688: </span>            }
<span class="linenr">2689: </span>          }
<span class="linenr">2690: </span>        }
<span class="linenr">2691: </span>  
<span class="linenr">2692: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">2693: </span>          !hasText ||
<span class="linenr">2694: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if this is a plain element with a single text child, leave it</span>
<span class="linenr">2695: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">as-is since the runtime has dedicated fast path for this by directly</span>
<span class="linenr">2696: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">setting textContent of the element.</span>
<span class="linenr">2697: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for component root it's always normalized anyway.</span>
<span class=
"linenr">2698: </span>          (children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;&
<span class=
"linenr">2699: </span>            (node.type === NodeTypes.ROOT ||
<span class=
"linenr">2700: </span>              (node.type === NodeTypes.ELEMENT &amp;&
<span class=
"linenr">2701: </span>                node.tagType === ElementTypes.ELEMENT &amp;&
<span class="linenr">2702: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#3756</span>
<span class="linenr">2703: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">custom directives can potentially add DOM elements arbitrarily,</span>
<span class="linenr">2704: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we need to avoid setting textContent of the element at runtime</span>
<span class="linenr">2705: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to avoid accidentally overwriting the DOM elements added</span>
<span class="linenr">2706: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">by the user through custom directives.</span>
<span class="linenr">2707: </span>                !node.props.find(
<span class="linenr">2708: </span>                  p =&gt;
<span class=
"linenr">2709: </span>                    p.type === NodeTypes.DIRECTIVE &amp;&
<span class=
"linenr">2710: </span>                    !context.directiveTransforms[p.name]
<span class="linenr">2711: </span>                ))))
<span class="linenr">2712: </span>        ) {
<span class="linenr">2713: </span>          <span class=
"org-keyword">return</span>
<span class="linenr">2714: </span>        }
<span class="linenr">2715: </span>  
<span class="linenr">2716: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">pre-convert text nodes into createTextVNode(text) calls to avoid</span>
<span class="linenr">2717: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">runtime normalization.</span>
<span class="linenr">2718: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; children.length; i++) {
<span class="linenr">2719: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[i]
<span class="linenr">2720: </span>          <span class=
"org-keyword">if</span> (isText(child) || child.type === NodeTypes.COMPOUND_EXPRESSION) {
<span class="linenr">2721: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">callArgs</span> = []
<span class="linenr">2722: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">createTextVNode defaults to single whitespace, so if it is a</span>
<span class="linenr">2723: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single space the code could be an empty call to save bytes.</span>
<span class="linenr">2724: </span>            <span class=
"org-keyword">if</span> (child.type !== NodeTypes.TEXT || child.content !== <span class="org-string">' '</span>) {
<span class=
"linenr">2725: </span>              callArgs.push(child)
<span class="linenr">2726: </span>            }
<span class="linenr">2727: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mark dynamic text with flag so it gets patched inside a block</span>
<span class="linenr">2728: </span>            <span class=
"org-keyword">if</span> (
<span class="linenr">2729: </span>              !context.ssr &amp;&
<span class=
"linenr">2730: </span>              getConstantType(child, context) === ConstantTypes.NOT_CONSTANT
<span class="linenr">2731: </span>            ) {
<span class="linenr">2732: </span>              callArgs.push(
<span class="linenr">2733: </span>                PatchFlags.TEXT +
<span class=
"linenr">2734: </span>                  (__DEV__ ? <span class=
"org-string">` /* ${PatchFlagNames[PatchFlags.TEXT]} */`</span> : <span class="org-string">``</span>)
<span class="linenr">2735: </span>              )
<span class="linenr">2736: </span>            }
<span class="linenr">2737: </span>            children[i] = {
<span class=
"linenr">2738: </span>              type: NodeTypes.TEXT_CALL,
<span class="linenr">2739: </span>              content: child,
<span class="linenr">2740: </span>              loc: child.loc,
<span class=
"linenr">2741: </span>              codegenNode: createCallExpression(
<span class=
"linenr">2742: </span>                context.helper(CREATE_TEXT),
<span class="linenr">2743: </span>                callArgs
<span class="linenr">2744: </span>              )
<span class="linenr">2745: </span>            }
<span class="linenr">2746: </span>          }
<span class="linenr">2747: </span>        }
<span class="linenr">2748: </span>      }
<span class="linenr">2749: </span>    }
<span class="linenr">2750: </span>  }
<span class="linenr">2751: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-bind without arg is handled directly in ./transformElements.ts due to it affecting</span>
<span class="linenr">2752: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">codegen for the entire props object. This transform here is only for v-bind</span>
<span class="linenr">2753: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">*with* args.</span>
<span class="linenr">2754: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformBind</span> = (dir, _node, context) =&gt; {
<span class="linenr">2755: </span>    <span class=
"org-keyword">const</span> { exp, modifiers, loc } = dir
<span class="linenr">2756: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">arg</span> = dir.arg
<span class="linenr">2757: </span>  
<span class="linenr">2758: </span>    <span class=
"org-keyword">if</span> (arg.type !== NodeTypes.SIMPLE_EXPRESSION) {
<span class=
"linenr">2759: </span>      arg.children.unshift(<span class=
"org-string">`(`</span>)
<span class=
"linenr">2760: </span>      arg.children.push(<span class=
"org-string">`) || ""`</span>)
<span class="linenr">2761: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!arg.isStatic) {
<span class="linenr">2762: </span>      arg.content = <span class=
"org-string">`${arg.content} || ""`</span>
<span class="linenr">2763: </span>    }
<span class="linenr">2764: </span>  
<span class="linenr">2765: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">.sync is replaced by v-model:arg</span>
<span class="linenr">2766: </span>    <span class=
"org-keyword">if</span> (modifiers.includes(<span class=
"org-string">'camel'</span>)) {
<span class="linenr">2767: </span>      <span class=
"org-keyword">if</span> (arg.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">2768: </span>        <span class=
"org-keyword">if</span> (arg.isStatic) {
<span class=
"linenr">2769: </span>          arg.content = camelize(arg.content)
<span class="linenr">2770: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2771: </span>          arg.content = <span class=
"org-string">`${context.helperString(CAMELIZE)}(${arg.content})`</span>
<span class="linenr">2772: </span>        }
<span class="linenr">2773: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2774: </span>        arg.children.unshift(<span class=
"org-string">`${context.helperString(CAMELIZE)}(`</span>)
<span class=
"linenr">2775: </span>        arg.children.push(<span class=
"org-string">`)`</span>)
<span class="linenr">2776: </span>      }
<span class="linenr">2777: </span>    }
<span class="linenr">2778: </span>  
<span class="linenr">2779: </span>    <span class=
"org-keyword">if</span> (!context.inSSR) {
<span class="linenr">2780: </span>      <span class=
"org-keyword">if</span> (modifiers.includes(<span class=
"org-string">'prop'</span>)) {
<span class=
"linenr">2781: </span>        injectPrefix(arg, <span class=
"org-string">'.'</span>)
<span class="linenr">2782: </span>      }
<span class="linenr">2783: </span>      <span class=
"org-keyword">if</span> (modifiers.includes(<span class=
"org-string">'attr'</span>)) {
<span class=
"linenr">2784: </span>        injectPrefix(arg, <span class=
"org-string">'^'</span>)
<span class="linenr">2785: </span>      }
<span class="linenr">2786: </span>    }
<span class="linenr">2787: </span>  
<span class="linenr">2788: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">2789: </span>      !exp ||
<span class=
"linenr">2790: </span>      (exp.type === NodeTypes.SIMPLE_EXPRESSION &amp;& !exp.content.trim())
<span class="linenr">2791: </span>    ) {
<span class="linenr">2792: </span>      logg(<span class=
"org-string">`transformBind v-bind no expression`</span>)
<span class="linenr">2793: </span>      <span class=
"org-keyword">return</span> {
<span class=
"linenr">2794: </span>        props: [createObjectProperty(arg, createSimpleExpression(<span class="org-string">''</span>, <span class="org-constant">true</span>, loc))]
<span class="linenr">2795: </span>      }
<span class="linenr">2796: </span>    }
<span class="linenr">2797: </span>  
<span class="linenr">2798: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">2799: </span>      props: [createObjectProperty(arg, exp)]
<span class="linenr">2800: </span>    }
<span class="linenr">2801: </span>  }
<span class="linenr">2802: </span>  
<span class="linenr">2803: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">injectPrefix</span> = (arg, prefix) =&gt; {
<span class="linenr">2804: </span>    <span class=
"org-keyword">if</span> (arg.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">2805: </span>      <span class=
"org-keyword">if</span> (arg.isStatic) {
<span class=
"linenr">2806: </span>        arg.content = prefix + arg.content
<span class="linenr">2807: </span>      } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2808: </span>        arg.content = <span class="org-string">`\`${prefix}\${${arg.content}}\``</span>
<span class="linenr">2809: </span>      }
<span class="linenr">2810: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2811: </span>      arg.children.unshift(<span class=
"org-string">`'${prefix}' + (`</span>)
<span class=
"linenr">2812: </span>      arg.children.push(<span class=
"org-string">`)`</span>)
<span class="linenr">2813: </span>    }
<span class="linenr">2814: </span>  }
<span class="linenr">2815: </span>  
<span class="linenr">2816: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformFor</span> = createStructuralDirectiveTransform(
<span class="linenr">2817: </span>    <span class=
"org-string">'for'</span>,
<span class="linenr">2818: </span>    (node, dir, context) =&gt; {
<span class="linenr">2819: </span>      <span class=
"org-keyword">const</span> { helper, removeHelper } = context
<span class="linenr">2820: </span>      <span class=
"org-keyword">return</span> processFor(node, dir, context, forNode =&gt; {
<span class="linenr">2821: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">create the loop render function expression now, and add the</span>
<span class="linenr">2822: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">iterator on exit after all children have been traversed</span>
<span class="linenr">2823: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">renderExp</span> = createCallExpression(helper(RENDER_LIST), [
<span class="linenr">2824: </span>          forNode.source
<span class="linenr">2825: </span>        ])
<span class="linenr">2826: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isTemplate</span> = isTemplateNode(node)
<span class="linenr">2827: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">memo</span> = findDir(node, <span class=
"org-string">'memo'</span>)
<span class="linenr">2828: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyProp</span> = findProp(node, <span class=
"org-string">`key`</span>)
<span class="linenr">2829: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyExp</span> =
<span class="linenr">2830: </span>          keyProp &amp;&
<span class=
"linenr">2831: </span>          (keyProp.type === NodeTypes.ATTRIBUTE
<span class=
"linenr">2832: </span>            ? createSimpleExpression(keyProp.value.content, <span class="org-constant">true</span>)
<span class="linenr">2833: </span>            : keyProp.exp)
<span class="linenr">2834: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyProperty</span> = keyProp ? createObjectProperty(<span class="org-string">`key`</span>, keyExp) : <span class="org-constant">null</span>
<span class="linenr">2835: </span>  
<span class="linenr">2836: </span>        <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& isTemplate) {
<span class="linenr">2837: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#2085 / #5288 process :key and v-memo expressions need to be</span>
<span class="linenr">2838: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">processed on `&lt;template v-for&gt;`. In this case the node is discarded</span>
<span class="linenr">2839: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">and never traversed so its binding expressions won't be processed</span>
<span class="linenr">2840: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">by the normal transforms.</span>
<span class="linenr">2841: </span>          <span class=
"org-keyword">if</span> (memo) {
<span class=
"linenr">2842: </span>            memo.exp = processExpression(
<span class="linenr">2843: </span>              memo.exp ,
<span class="linenr">2844: </span>              context
<span class="linenr">2845: </span>            )
<span class="linenr">2846: </span>          }
<span class="linenr">2847: </span>          <span class=
"org-keyword">if</span> (keyProperty &amp;& keyProp.type !== NodeTypes.ATTRIBUTE) {
<span class=
"linenr">2848: </span>            keyProperty.value = processExpression(
<span class="linenr">2849: </span>              keyProperty.value ,
<span class="linenr">2850: </span>              context
<span class="linenr">2851: </span>            )
<span class="linenr">2852: </span>          }
<span class="linenr">2853: </span>        }
<span class="linenr">2854: </span>  
<span class="linenr">2855: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStableFragment</span> =
<span class=
"linenr">2856: </span>          forNode.source.type === NodeTypes.SIMPLE_EXPRESSION &amp;&
<span class=
"linenr">2857: </span>          forNode.source.constType &gt; ConstantTypes.NOT_CONSTANT
<span class="linenr">2858: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fragmentFlag</span> = isStableFragment
<span class=
"linenr">2859: </span>          ? PatchFlags.STABLE_FRAGMENT
<span class="linenr">2860: </span>          : keyProp
<span class=
"linenr">2861: </span>          ? PatchFlags.KEYED_FRAGMENT
<span class=
"linenr">2862: </span>          : PatchFlags.UNKEYED_FRAGMENT
<span class="linenr">2863: </span>  
<span class=
"linenr">2864: </span>        forNode.codegenNode = createVNodeCall(
<span class="linenr">2865: </span>          context,
<span class="linenr">2866: </span>          helper(FRAGMENT),
<span class="linenr">2867: </span>          <span class=
"org-constant">undefined</span>,
<span class="linenr">2868: </span>          renderExp,
<span class="linenr">2869: </span>          fragmentFlag +
<span class=
"linenr">2870: </span>            (__DEV__ ? <span class=
"org-string">` /* ${PatchFlagNames[fragmentFlag]} */`</span> : <span class="org-string">``</span>),
<span class="linenr">2871: </span>          <span class=
"org-constant">undefined</span>,
<span class="linenr">2872: </span>          <span class=
"org-constant">undefined</span>,
<span class="linenr">2873: </span>          <span class=
"org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isBlock</span><span class=
"org-comment-delimiter"> */</span>,
<span class=
"linenr">2874: </span>          !isStableFragment <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">disableTracking</span><span class=
"org-comment-delimiter"> */</span>,
<span class="linenr">2875: </span>          <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isComponent</span><span class=
"org-comment-delimiter"> */</span>,
<span class="linenr">2876: </span>          node.loc
<span class="linenr">2877: </span>        )
<span class="linenr">2878: </span>  
<span class="linenr">2879: </span>        <span class=
"org-keyword">return</span> () =&gt; {
<span class="linenr">2880: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">finish the codegen now that all children have been traversed</span>
<span class="linenr">2881: </span>          <span class=
"org-keyword">let</span> <span class=
"org-variable-name">childBlock</span>
<span class="linenr">2882: </span>          <span class=
"org-keyword">const</span> { children } = forNode
<span class="linenr">2883: </span>  
<span class="linenr">2884: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check &lt;template v-for&gt; key placement</span>
<span class="linenr">2885: </span>          <span class=
"org-keyword">if</span> ((__DEV__ || !__BROWSER__) &amp;& isTemplate) {
<span class=
"linenr">2886: </span>            node.children.some(c =&gt; {
<span class="linenr">2887: </span>              <span class=
"org-keyword">if</span> (c.type === NodeTypes.ELEMENT) {
<span class="linenr">2888: </span>                <span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> = findProp(c, <span class=
"org-string">'key'</span>)
<span class="linenr">2889: </span>                <span class=
"org-keyword">if</span> (key) {
<span class=
"linenr">2890: </span>                  logg(<span class=
"org-string">`transformFor - key on template`</span>)
<span class="linenr">2891: </span>                  <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">2892: </span>                }
<span class="linenr">2893: </span>              }
<span class="linenr">2894: </span>            })
<span class="linenr">2895: </span>          }
<span class="linenr">2896: </span>  
<span class="linenr">2897: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needFragmentWrapper</span> =
<span class=
"linenr">2898: </span>            children.length !== <span class=
"org-highlight-numbers-number">1</span> || children[<span class=
"org-highlight-numbers-number">0</span>].type !== NodeTypes.ELEMENT
<span class="linenr">2899: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotOutlet</span> = isSlotOutlet(node)
<span class="linenr">2900: </span>            ? node
<span class="linenr">2901: </span>            : isTemplate &amp;&
<span class=
"linenr">2902: </span>              node.children.length === <span class="org-highlight-numbers-number">1</span> &amp;&
<span class=
"linenr">2903: </span>              isSlotOutlet(node.children[<span class="org-highlight-numbers-number">0</span>])
<span class=
"linenr">2904: </span>            ? node.children[<span class=
"org-highlight-numbers-number">0</span>] <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">api-extractor somehow fails to infer this</span>
<span class="linenr">2905: </span>            : <span class=
"org-constant">null</span>
<span class="linenr">2906: </span>  
<span class="linenr">2907: </span>          <span class=
"org-keyword">if</span> (slotOutlet) {
<span class="linenr">2908: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;slot v-for="..."&gt; or &lt;template v-for="..."&gt;&lt;slot/&gt;&lt;/template&gt;</span>
<span class=
"linenr">2909: </span>            childBlock = slotOutlet.codegenNode
<span class="linenr">2910: </span>            <span class=
"org-keyword">if</span> (isTemplate &amp;& keyProperty) {
<span class="linenr">2911: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;template v-for="..." :key="..."&gt;&lt;slot/&gt;&lt;/template&gt;</span>
<span class="linenr">2912: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we need to inject the key to the renderSlot() call.</span>
<span class="linenr">2913: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the props for renderSlot is passed as the 3rd argument.</span>
<span class=
"linenr">2914: </span>              injectProp(childBlock, keyProperty, context)
<span class="linenr">2915: </span>            }
<span class="linenr">2916: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (needFragmentWrapper) {
<span class="linenr">2917: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;template v-for="..."&gt; with text or multi-elements</span>
<span class="linenr">2918: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">should generate a fragment block for each loop</span>
<span class=
"linenr">2919: </span>            childBlock = createVNodeCall(
<span class="linenr">2920: </span>              context,
<span class="linenr">2921: </span>              helper(FRAGMENT),
<span class=
"linenr">2922: </span>              keyProperty ? createObjectExpression([keyProperty]) : <span class="org-constant">undefined</span>,
<span class="linenr">2923: </span>              node.children,
<span class=
"linenr">2924: </span>              PatchFlags.STABLE_FRAGMENT +
<span class="linenr">2925: </span>                (__DEV__
<span class="linenr">2926: </span>                  ? <span class=
"org-string">` /* ${PatchFlagNames[PatchFlags.STABLE_FRAGMENT]} */`</span>
<span class="linenr">2927: </span>                  : <span class=
"org-string">``</span>),
<span class="linenr">2928: </span>              <span class=
"org-constant">undefined</span>,
<span class="linenr">2929: </span>              <span class=
"org-constant">undefined</span>,
<span class="linenr">2930: </span>              <span class=
"org-constant">true</span>,
<span class="linenr">2931: </span>              <span class=
"org-constant">undefined</span>,
<span class="linenr">2932: </span>              <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isComponent</span><span class=
"org-comment-delimiter"> */</span>
<span class="linenr">2933: </span>            )
<span class="linenr">2934: </span>          } <span class=
"org-keyword">else</span> {
<span class="linenr">2935: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Normal element v-for. Directly use the child's codegenNode</span>
<span class="linenr">2936: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">but mark it as a block.</span>
<span class=
"linenr">2937: </span>            childBlock = children[<span class="org-highlight-numbers-number">0</span>].codegenNode
<span class="linenr">2938: </span>            <span class=
"org-keyword">if</span> (isTemplate &amp;& keyProperty) {
<span class=
"linenr">2939: </span>              injectProp(childBlock, keyProperty, context)
<span class="linenr">2940: </span>            }
<span class="linenr">2941: </span>            <span class=
"org-keyword">if</span> (childBlock.isBlock !== !isStableFragment) {
<span class="linenr">2942: </span>              <span class=
"org-keyword">if</span> (childBlock.isBlock) {
<span class="linenr">2943: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">switch from block to vnode</span>
<span class=
"linenr">2944: </span>                removeHelper(OPEN_BLOCK)
<span class="linenr">2945: </span>                removeHelper(
<span class=
"linenr">2946: </span>                  getVNodeBlockHelper(context.inSSR, childBlock.isComponent)
<span class="linenr">2947: </span>                )
<span class="linenr">2948: </span>              } <span class=
"org-keyword">else</span> {
<span class="linenr">2949: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">switch from vnode to block</span>
<span class="linenr">2950: </span>                removeHelper(
<span class=
"linenr">2951: </span>                  getVNodeHelper(context.inSSR, childBlock.isComponent)
<span class="linenr">2952: </span>                )
<span class="linenr">2953: </span>              }
<span class="linenr">2954: </span>            }
<span class=
"linenr">2955: </span>            childBlock.isBlock = !isStableFragment
<span class="linenr">2956: </span>            <span class=
"org-keyword">if</span> (childBlock.isBlock) {
<span class="linenr">2957: </span>              helper(OPEN_BLOCK)
<span class=
"linenr">2958: </span>              helper(getVNodeBlockHelper(context.inSSR, childBlock.isComponent))
<span class="linenr">2959: </span>            } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2960: </span>              helper(getVNodeHelper(context.inSSR, childBlock.isComponent))
<span class="linenr">2961: </span>            }
<span class="linenr">2962: </span>          }
<span class="linenr">2963: </span>  
<span class="linenr">2964: </span>          <span class=
"org-keyword">if</span> (memo) {
<span class="linenr">2965: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loop</span> = createFunctionExpression(
<span class=
"linenr">2966: </span>              createForLoopParams(forNode.parseResult, [
<span class=
"linenr">2967: </span>                createSimpleExpression(<span class="org-string">`_cached`</span>)
<span class="linenr">2968: </span>              ])
<span class="linenr">2969: </span>            )
<span class=
"linenr">2970: </span>            loop.body = createBlockStatement([
<span class=
"linenr">2971: </span>              createCompoundExpression([<span class="org-string">`const _memo = (`</span>, memo.exp, <span class="org-string">`)`</span>]),
<span class=
"linenr">2972: </span>              createCompoundExpression([
<span class="linenr">2973: </span>                <span class=
"org-string">`if (_cached`</span>,
<span class=
"linenr">2974: </span>                ...(keyExp ? [<span class=
"org-string">` &amp;& _cached.key === `</span>, keyExp] : []),
<span class="linenr">2975: </span>                <span class=
"org-string">` &amp;& ${context.helperString(</span>
<span class="linenr">2976: </span><span class=
"org-string">                  IS_MEMO_SAME</span>
<span class="linenr">2977: </span><span class=
"org-string">                )}(_cached, _memo)) return _cached`</span>
<span class="linenr">2978: </span>              ]),
<span class=
"linenr">2979: </span>              createCompoundExpression([<span class="org-string">`const _item = `</span>, childBlock]),
<span class=
"linenr">2980: </span>              createSimpleExpression(<span class="org-string">`_item.memo = _memo`</span>),
<span class=
"linenr">2981: </span>              createSimpleExpression(<span class="org-string">`return _item`</span>)
<span class="linenr">2982: </span>            ])
<span class=
"linenr">2983: </span>            renderExp.<span class="org-constant">arguments</span>.push(
<span class="linenr">2984: </span>              loop,
<span class=
"linenr">2985: </span>              createSimpleExpression(<span class="org-string">`_cache`</span>),
<span class=
"linenr">2986: </span>              createSimpleExpression(String(context.cached++))
<span class="linenr">2987: </span>            )
<span class="linenr">2988: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr">2989: </span>            renderExp.<span class="org-constant">arguments</span>.push(
<span class=
"linenr">2990: </span>              createFunctionExpression(
<span class=
"linenr">2991: </span>                createForLoopParams(forNode.parseResult),
<span class="linenr">2992: </span>                childBlock,
<span class="linenr">2993: </span>                <span class=
"org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">force newline</span><span class=
"org-comment-delimiter"> */</span>
<span class="linenr">2994: </span>              )
<span class="linenr">2995: </span>            )
<span class="linenr">2996: </span>          }
<span class="linenr">2997: </span>        }
<span class="linenr">2998: </span>      })
<span class="linenr">2999: </span>    }
<span class="linenr">3000: </span>  )
<span class="linenr">3001: </span>  
<span class="linenr">3002: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">target-agnostic transform used for both Client and SSR</span>
<span class="linenr">3003: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">processFor</span>(
<span class="linenr">3004: </span>    <span class=
"org-variable-name">node</span>,
<span class="linenr">3005: </span>    <span class=
"org-variable-name">dir</span>,
<span class="linenr">3006: </span>    <span class=
"org-variable-name">context</span>,
<span class="linenr">3007: </span>    processCodegen
<span class="linenr">3008: </span>  ) {
<span class="linenr">3009: </span>    <span class=
"org-keyword">if</span> (!dir.exp) {
<span class="linenr">3010: </span>      logg(<span class=
"org-string">`processFor - dir.exp is null`</span>)
<span class="linenr">3011: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">3012: </span>    }
<span class="linenr">3013: </span>  
<span class="linenr">3014: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parseResult</span> = parseForExpression(
<span class="linenr">3015: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">can only be simple expression because vFor transform is applied</span>
<span class="linenr">3016: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">before expression transform.</span>
<span class="linenr">3017: </span>      dir.exp,
<span class="linenr">3018: </span>      context
<span class="linenr">3019: </span>    )
<span class="linenr">3020: </span>  
<span class="linenr">3021: </span>    <span class=
"org-keyword">if</span> (!parseResult) {
<span class="linenr">3022: </span>      logg(<span class=
"org-string">`processFor - parseResult is null`</span>)
<span class="linenr">3023: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">3024: </span>    }
<span class="linenr">3025: </span>  
<span class="linenr">3026: </span>    <span class=
"org-keyword">const</span> { addIdentifiers, removeIdentifiers, scopes } = context
<span class="linenr">3027: </span>    <span class=
"org-keyword">const</span> { source, value, key, index } = parseResult
<span class="linenr">3028: </span>  
<span class="linenr">3029: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">forNode</span> = {
<span class="linenr">3030: </span>      type: NodeTypes.FOR,
<span class="linenr">3031: </span>      loc: dir.loc,
<span class="linenr">3032: </span>      source,
<span class="linenr">3033: </span>      valueAlias: value,
<span class="linenr">3034: </span>      keyAlias: key,
<span class="linenr">3035: </span>      objectIndexAlias: index,
<span class="linenr">3036: </span>      parseResult,
<span class=
"linenr">3037: </span>      children: isTemplateNode(node) ? node.children : [node]
<span class="linenr">3038: </span>    }
<span class="linenr">3039: </span>  
<span class="linenr">3040: </span>    context.replaceNode(forNode)
<span class="linenr">3041: </span>  
<span class="linenr">3042: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bookkeeping</span>
<span class="linenr">3043: </span>    scopes.vFor++
<span class="linenr">3044: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class="linenr">3045: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">scope management</span>
<span class="linenr">3046: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inject identifiers to context</span>
<span class=
"linenr">3047: </span>      value &amp;& addIdentifiers(value)
<span class=
"linenr">3048: </span>      key &amp;& addIdentifiers(key)
<span class=
"linenr">3049: </span>      index &amp;& addIdentifiers(index)
<span class="linenr">3050: </span>    }
<span class="linenr">3051: </span>  
<span class="linenr">3052: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = processCodegen &amp;& processCodegen(forNode)
<span class="linenr">3053: </span>  
<span class="linenr">3054: </span>    <span class=
"org-keyword">return</span> () =&gt; {
<span class="linenr">3055: </span>      scopes.vFor--
<span class="linenr">3056: </span>      <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">3057: </span>        value &amp;& removeIdentifiers(value)
<span class=
"linenr">3058: </span>        key &amp;& removeIdentifiers(key)
<span class=
"linenr">3059: </span>        index &amp;& removeIdentifiers(index)
<span class="linenr">3060: </span>      }
<span class="linenr">3061: </span>      <span class=
"org-keyword">if</span> (onExit) onExit()
<span class="linenr">3062: </span>    }
<span class="linenr">3063: </span>  }
<span class="linenr">3064: </span>  
<span class="linenr">3065: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">forAliasRE</span> = <span class=
"org-string">/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/</span>
<span class="linenr">3066: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">This regex doesn't cover the case if key or index aliases have destructuring,</span>
<span class="linenr">3067: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">but those do not make sense in the first place, so this works in practice.</span>
<span class="linenr">3068: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">forIteratorRE</span> = <span class=
"org-string">/,([^,\}\]]*)(?:,([^,\}\]]*))?$/</span>
<span class="linenr">3069: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">stripParensRE</span> = <span class=
"org-string">/^\(|\)$/</span>g
<span class="linenr">3070: </span>  
<span class="linenr">3071: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parseForExpression</span>(
<span class="linenr">3072: </span>    <span class=
"org-variable-name">input</span>,
<span class="linenr">3073: </span>    context
<span class="linenr">3074: </span>  ) {
<span class="linenr">3075: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = input.loc
<span class="linenr">3076: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> = input.content
<span class="linenr">3077: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">inMatch</span> = exp.match(forAliasRE)
<span class="linenr">3078: </span>    <span class=
"org-keyword">if</span> (!inMatch) <span class=
"org-keyword">return</span>
<span class="linenr">3079: </span>  
<span class="linenr">3080: </span>    <span class=
"org-keyword">const</span> [, <span class=
"org-variable-name">LHS</span>, <span class=
"org-variable-name">RHS</span>] = inMatch
<span class="linenr">3081: </span>  
<span class="linenr">3082: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">result</span> = {
<span class=
"linenr">3083: </span>      source: createAliasExpression(
<span class="linenr">3084: </span>        loc,
<span class="linenr">3085: </span>        RHS.trim(),
<span class=
"linenr">3086: </span>        exp.indexOf(RHS, LHS.length)
<span class="linenr">3087: </span>      ),
<span class="linenr">3088: </span>      value: <span class=
"org-constant">undefined</span>,
<span class="linenr">3089: </span>      key: <span class=
"org-constant">undefined</span>,
<span class="linenr">3090: </span>      index: <span class=
"org-constant">undefined</span>
<span class="linenr">3091: </span>    }
<span class="linenr">3092: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">3093: </span>      result.source = processExpression(
<span class="linenr">3094: </span>        result.source,
<span class="linenr">3095: </span>        context
<span class="linenr">3096: </span>      )
<span class="linenr">3097: </span>    }
<span class="linenr">3098: </span>  
<span class="linenr">3099: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">valueContent</span> = LHS.trim().replace(stripParensRE, <span class="org-string">''</span>).trim()
<span class="linenr">3100: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">trimmedOffset</span> = LHS.indexOf(valueContent)
<span class="linenr">3101: </span>  
<span class="linenr">3102: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">iteratorMatch</span> = valueContent.match(forIteratorRE)
<span class="linenr">3103: </span>    <span class=
"org-keyword">if</span> (iteratorMatch) {
<span class=
"linenr">3104: </span>      valueContent = valueContent.replace(forIteratorRE, <span class="org-string">''</span>).trim()
<span class="linenr">3105: </span>  
<span class="linenr">3106: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyContent</span> = iteratorMatch[<span class=
"org-highlight-numbers-number">1</span>].trim()
<span class="linenr">3107: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">keyOffset</span>
<span class="linenr">3108: </span>      <span class=
"org-keyword">if</span> (keyContent) {
<span class=
"linenr">3109: </span>        keyOffset = exp.indexOf(keyContent, trimmedOffset + valueContent.length)
<span class=
"linenr">3110: </span>        result.key = createAliasExpression(loc, keyContent, keyOffset)
<span class="linenr">3111: </span>        <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">3112: </span>          result.key = processExpression(result.key, context, <span class="org-constant">true</span>)
<span class="linenr">3113: </span>        }
<span class="linenr">3114: </span>      }
<span class="linenr">3115: </span>  
<span class="linenr">3116: </span>      <span class=
"org-keyword">if</span> (iteratorMatch[<span class=
"org-highlight-numbers-number">2</span>]) {
<span class="linenr">3117: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">indexContent</span> = iteratorMatch[<span class="org-highlight-numbers-number">2</span>].trim()
<span class="linenr">3118: </span>  
<span class="linenr">3119: </span>        <span class=
"org-keyword">if</span> (indexContent) {
<span class=
"linenr">3120: </span>          result.index = createAliasExpression(
<span class="linenr">3121: </span>            loc,
<span class="linenr">3122: </span>            indexContent,
<span class="linenr">3123: </span>            exp.indexOf(
<span class="linenr">3124: </span>              indexContent,
<span class="linenr">3125: </span>              result.key
<span class=
"linenr">3126: </span>                ? keyOffset + keyContent.length
<span class=
"linenr">3127: </span>                : trimmedOffset + valueContent.length
<span class="linenr">3128: </span>            )
<span class="linenr">3129: </span>          )
<span class="linenr">3130: </span>          <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">3131: </span>            result.index = processExpression(result.index, context, <span class="org-constant">true</span>)
<span class="linenr">3132: </span>          }
<span class="linenr">3133: </span>        }
<span class="linenr">3134: </span>      }
<span class="linenr">3135: </span>    }
<span class="linenr">3136: </span>  
<span class="linenr">3137: </span>    <span class=
"org-keyword">if</span> (valueContent) {
<span class=
"linenr">3138: </span>      result.value = createAliasExpression(loc, valueContent, trimmedOffset)
<span class="linenr">3139: </span>      <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">3140: </span>        result.value = processExpression(result.value, context, <span class="org-constant">true</span>)
<span class="linenr">3141: </span>      }
<span class="linenr">3142: </span>    }
<span class="linenr">3143: </span>  
<span class="linenr">3144: </span>    <span class=
"org-keyword">return</span> result
<span class="linenr">3145: </span>  }
<span class="linenr">3146: </span>  
<span class="linenr">3147: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createAliasExpression</span>(
<span class="linenr">3148: </span>    <span class=
"org-variable-name">range</span>,
<span class="linenr">3149: </span>    <span class=
"org-variable-name">content</span>,
<span class="linenr">3150: </span>    offset
<span class="linenr">3151: </span>  ) {
<span class="linenr">3152: </span>    <span class=
"org-keyword">return</span> createSimpleExpression(
<span class="linenr">3153: </span>      content,
<span class="linenr">3154: </span>      <span class=
"org-constant">false</span>,
<span class=
"linenr">3155: </span>      getInnerRange(range, offset, content.length)
<span class="linenr">3156: </span>    )
<span class="linenr">3157: </span>  }
<span class="linenr">3158: </span>  
<span class="linenr">3159: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createForLoopParams</span>(
<span class="linenr">3160: </span>    { value, key, index },
<span class="linenr">3161: </span>    memoArgs = []
<span class="linenr">3162: </span>  ) {
<span class="linenr">3163: </span>    <span class=
"org-keyword">return</span> createParamsList([value, key, index, ...memoArgs])
<span class="linenr">3164: </span>  }
<span class="linenr">3165: </span>  
<span class="linenr">3166: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createParamsList</span>(<span class=
"org-variable-name">args</span>) {
<span class="linenr">3167: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = args.length
<span class="linenr">3168: </span>    <span class=
"org-keyword">while</span> (i--) {
<span class="linenr">3169: </span>      <span class=
"org-keyword">if</span> (args[i]) <span class=
"org-keyword">break</span>
<span class="linenr">3170: </span>    }
<span class="linenr">3171: </span>    <span class=
"org-keyword">return</span> args
<span class="linenr">3172: </span>      .slice(<span class=
"org-highlight-numbers-number">0</span>, i + <span class=
"org-highlight-numbers-number">1</span>)
<span class=
"linenr">3173: </span>      .map((arg, i) =&gt; arg || createSimpleExpression(<span class="org-string">`_`</span>.repeat(i + <span class="org-highlight-numbers-number">1</span>), <span class="org-constant">false</span>))
<span class="linenr">3174: </span>  }
<span class="linenr">3175: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">processIf</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">dir</span>, <span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">processCodegen</span>) {
<span class="linenr">3176: </span>    logg(<span class=
"org-string">'processIf - node - dir'</span>, node, dir)
<span class="linenr">3177: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">3178: </span>      dir.name !== <span class=
"org-string">'else'</span> &amp;&
<span class=
"linenr">3179: </span>      (!dir.exp || !dir.exp.content.trim())
<span class="linenr">3180: </span>    ) {
<span class="linenr">3181: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">loc</span> = dir.exp ? dir.exp.loc : node.loc
<span class="linenr">3182: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">&lt;div v-if&gt;&lt;/div&gt; 没有指令值的情况，默认值为 true</span>
<span class=
"linenr">3183: </span>      dir.exp = createSimpleExpression(<span class="org-string">`true`</span>, <span class="org-constant">false</span>, loc)
<span class="linenr">3184: </span>    }
<span class="linenr">3185: </span>  
<span class="linenr">3186: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers &amp;& dir.exp) {
<span class="linenr">3187: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">dir.exp can only be simple expression because vIf transform is applied</span>
<span class="linenr">3188: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">before expression transform.</span>
<span class=
"linenr">3189: </span>      dir.exp = processExpression(dir.exp, context)
<span class="linenr">3190: </span>    }
<span class="linenr">3191: </span>  
<span class="linenr">3192: </span>    <span class=
"org-keyword">if</span> (dir.name === <span class=
"org-string">'if'</span>) { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-if</span>
<span class="linenr">3193: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">branch</span> = createIfBranch(node, dir)
<span class="linenr">3194: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ifNode</span> = {
<span class="linenr">3195: </span>        type: NodeTypes.IF,
<span class="linenr">3196: </span>        loc: node.loc,
<span class="linenr">3197: </span>        branches: [branch]
<span class="linenr">3198: </span>      }
<span class="linenr">3199: </span>      context.replaceNode(ifNode)
<span class="linenr">3200: </span>      <span class=
"org-keyword">if</span> (processCodegen) {
<span class="linenr">3201: </span>        <span class=
"org-keyword">return</span> processCodegen(ifNode, branch, <span class="org-constant">true</span>)
<span class="linenr">3202: </span>      }
<span class="linenr">3203: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">3204: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">locate the adjacent v-if</span>
<span class="linenr">3205: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">siblings</span> = context.parent.children
<span class="linenr">3206: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">comments</span> = []
<span class="linenr">3207: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = siblings.indexOf(node)
<span class="linenr">3208: </span>      <span class=
"org-keyword">while</span> (i-- &gt;= -<span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">3209: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">sibling</span> = siblings[i]
<span class="linenr">3210: </span>  
<span class="linenr">3211: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">空行，空文本</span>
<span class="linenr">3212: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">3213: </span>          sibling &amp;&
<span class=
"linenr">3214: </span>          sibling.type === NodeTypes.TEXT &amp;&
<span class=
"linenr">3215: </span>          !sibling.content.trim().length
<span class="linenr">3216: </span>        ) {
<span class=
"linenr">3217: </span>          context.removeNode(sibling)
<span class="linenr">3218: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">3219: </span>        }
<span class="linenr">3220: </span>  
<span class="linenr">3221: </span>        <span class=
"org-keyword">if</span> (sibling &amp;& sibling.type === NodeTypes.IF) {
<span class="linenr">3222: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里会将原本的结点删除，而是用新组装的 if 结构(包含else-if, else 分支的结构，node.branches[...])</span>
<span class="linenr">3223: </span>          context.removeNode()
<span class="linenr">3224: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">branch</span> = createIfBranch(node, dir)
<span class=
"linenr">3225: </span>          sibling.branches.push(branch)
<span class="linenr">3226: </span>  
<span class="linenr">3227: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">onExit</span> = processCodegen &amp;& processCodegen(sibling, branch, <span class="org-constant">false</span>)
<span class="linenr">3228: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里需要手动触发一次遍历，因为上面将原本的分支节点从原来的节点树中删除了</span>
<span class=
"linenr">3229: </span>          traverseNode(branch, context)
<span class="linenr">3230: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">回溯结束后执行收集到的 transformXxx 函数</span>
<span class="linenr">3231: </span>          <span class=
"org-keyword">if</span> (onExit) onExit()
<span class="linenr">3232: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">make sure to reset currentNode after traversal to indicate this</span>
<span class="linenr">3233: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node has been removed.</span>
<span class=
"linenr">3234: </span>          context.currentNode = <span class=
"org-constant">null</span>
<span class="linenr">3235: </span>        }
<span class="linenr">3236: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">3237: </span>      }
<span class="linenr">3238: </span>    }
<span class="linenr">3239: </span>  }
<span class="linenr">3240: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createIfBranch</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">dir</span>) {
<span class="linenr">3241: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">3242: </span>      type: NodeTypes.IF_BRANCH,
<span class="linenr">3243: </span>      loc: node.loc,
<span class=
"linenr">3244: </span>      condition: dir.name === <span class=
"org-string">'else'</span> ? <span class=
"org-constant">undefined</span> : dir.exp,
<span class="linenr">3245: </span>      children:
<span class=
"linenr">3246: </span>        node.tagType === ElementTypes.TEMPLATE &amp;& !findDir(node, <span class="org-string">'for'</span>)
<span class="linenr">3247: </span>          ? node.children
<span class="linenr">3248: </span>          : [node],
<span class=
"linenr">3249: </span>      userKey: findProp(node, <span class=
"org-string">`key`</span>)
<span class="linenr">3250: </span>    }
<span class="linenr">3251: </span>  }
<span class="linenr">3252: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createCodegenNodeForBranch</span>(<span class=
"org-variable-name">branch</span>, <span class=
"org-variable-name">keyIndex</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">3253: </span>    <span class=
"org-keyword">if</span> (branch.condition) {
<span class="linenr">3254: </span>      <span class=
"org-keyword">return</span> createConditionalExpression(
<span class="linenr">3255: </span>        branch.condition,
<span class=
"linenr">3256: </span>        createChildrenCodegenNode(branch, keyIndex, context),
<span class="linenr">3257: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里是考虑到只有 v-if 的情况，因为 v-if 指令最后都会被解析成三目运算符形式</span>
<span class="linenr">3258: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如： &lt;div v-if="foo"/&gt;&lt;div v-else/&gt; =&gt; foo ? ... : ...</span>
<span class="linenr">3259: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">如： &lt;div v-if="foo"/&gt;&lt;div v-else-if="bar"/&gt;&lt;div v-else/&gt; =&gt; foo ? ... : bar ? ... : ...</span>
<span class="linenr">3260: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">所以必需得要有一个 v-else，如果没有的话就相当于是 `foo ? ...` 这样的语句是不合法的</span>
<span class="linenr">3261: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">因此这里在判断没有 v-else 分支的情况时默认给它创建了个注释节点</span>
<span class=
"linenr">3262: </span>        createCallExpression(context.helper(CREATE_COMMENT), [
<span class="linenr">3263: </span>          __DEV__ ? <span class=
"org-string">'"v-if"'</span> : <span class=
"org-string">'""'</span>,
<span class="linenr">3264: </span>          <span class=
"org-string">'true'</span>
<span class="linenr">3265: </span>        ])
<span class="linenr">3266: </span>      )
<span class="linenr">3267: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">3268: </span>      <span class=
"org-keyword">return</span> createChildrenCodegenNode(branch, keyIndex, context)
<span class="linenr">3269: </span>    }
<span class="linenr">3270: </span>  }
<span class="linenr">3271: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createChildrenCodegenNode</span>(<span class=
"org-variable-name">branch</span>, <span class=
"org-variable-name">keyIndex</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">3272: </span>    <span class=
"org-keyword">const</span> { helper } = context
<span class="linenr">3273: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyProperty</span> = createObjectProperty(
<span class="linenr">3274: </span>      <span class=
"org-string">`key`</span>,
<span class="linenr">3275: </span>      createSimpleExpression(
<span class="linenr">3276: </span>        <span class=
"org-string">`${keyIndex}`</span>,
<span class="linenr">3277: </span>        <span class=
"org-constant">false</span>,
<span class="linenr">3278: </span>        locStub,
<span class="linenr">3279: </span>        ConstantTypes.CAN_HOIST
<span class="linenr">3280: </span>      )
<span class="linenr">3281: </span>    )
<span class="linenr">3282: </span>    <span class=
"org-keyword">const</span> { children } = branch
<span class="linenr">3283: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">firstChild</span> = children[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">3284: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needFragmentWrapper</span> =
<span class=
"linenr">3285: </span>      children.length !== <span class=
"org-highlight-numbers-number">1</span> || firstChild.type !== NodeTypes.ELEMENT
<span class="linenr">3286: </span>    <span class=
"org-keyword">if</span> (needFragmentWrapper) {
<span class="linenr">3287: </span>      <span class=
"org-keyword">if</span> (children.length === <span class=
"org-highlight-numbers-number">1</span> &amp;& firstChild.type === NodeTypes.FOR) {
<span class="linenr">3288: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">optimize away nested fragments when child is a ForNode</span>
<span class="linenr">3289: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">vnodeCall</span> = firstChild.codegenNode
<span class=
"linenr">3290: </span>        injectProp(vnodeCall, keyProperty, context)
<span class="linenr">3291: </span>        <span class=
"org-keyword">return</span> vnodeCall
<span class="linenr">3292: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">3293: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlag</span> = PatchFlags.STABLE_FRAGMENT
<span class="linenr">3294: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">patchFlagText</span> = PatchFlagNames[PatchFlags.STABLE_FRAGMENT]
<span class="linenr">3295: </span>  
<span class="linenr">3296: </span>        <span class=
"org-keyword">return</span> createVNodeCall(
<span class="linenr">3297: </span>          context,
<span class="linenr">3298: </span>          helper(FRAGMENT),
<span class=
"linenr">3299: </span>          createObjectExpression([keyProperty]),
<span class="linenr">3300: </span>          children,
<span class=
"linenr">3301: </span>          patchFlag + (__DEV__ ? <span class=
"org-string">` /* ${patchFlagText} */`</span> : <span class=
"org-string">``</span>),
<span class="linenr">3302: </span>          <span class=
"org-constant">undefined</span>,
<span class="linenr">3303: </span>          <span class=
"org-constant">undefined</span>,
<span class="linenr">3304: </span>          <span class=
"org-constant">true</span>,
<span class="linenr">3305: </span>          <span class=
"org-constant">false</span>,
<span class="linenr">3306: </span>          <span class=
"org-constant">false</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">isComponent</span><span class=
"org-comment-delimiter"> */</span>,
<span class="linenr">3307: </span>          branch.loc
<span class="linenr">3308: </span>        )
<span class="linenr">3309: </span>      }
<span class="linenr">3310: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">3311: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ret</span> = firstChild.codegenNode
<span class="linenr">3312: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">vnodeCall</span> = getMemoedVNodeCall(ret)
<span class="linenr">3313: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Change createVNode to createBlock.</span>
<span class="linenr">3314: </span>      <span class=
"org-keyword">if</span> (vnodeCall.type === NodeTypes.VNODE_CALL) {
<span class=
"linenr">3315: </span>        makeBlock(vnodeCall, context)
<span class="linenr">3316: </span>      }
<span class="linenr">3317: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inject branch key</span>
<span class=
"linenr">3318: </span>      injectProp(vnodeCall, keyProperty, context)
<span class="linenr">3319: </span>      <span class=
"org-keyword">return</span> ret
<span class="linenr">3320: </span>    }
<span class="linenr">3321: </span>  }
<span class="linenr">3322: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">isSameKey</span>(<span class=
"org-variable-name">a</span>, <span class=
"org-variable-name">b</span>) {
<span class="linenr">3323: </span>    <span class=
"org-keyword">if</span> (!a || a.type !== b.type) {
<span class="linenr">3324: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">3325: </span>    }
<span class="linenr">3326: </span>    <span class=
"org-keyword">if</span> (a.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">3327: </span>      <span class=
"org-keyword">if</span> (a.value.content !== b.value.content) {
<span class="linenr">3328: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">3329: </span>      }
<span class="linenr">3330: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">3331: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">directive</span>
<span class="linenr">3332: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> = a.exp
<span class="linenr">3333: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">branchExp</span> = b.exp
<span class="linenr">3334: </span>      <span class=
"org-keyword">if</span> (exp.type !== branchExp.type) {
<span class="linenr">3335: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">3336: </span>      }
<span class="linenr">3337: </span>      <span class=
"org-keyword">if</span> (
<span class=
"linenr">3338: </span>        exp.type !== NodeTypes.SIMPLE_EXPRESSION ||
<span class=
"linenr">3339: </span>        exp.isStatic !== branchExp.isStatic ||
<span class=
"linenr">3340: </span>        exp.content !== branchExp.content
<span class="linenr">3341: </span>      ) {
<span class="linenr">3342: </span>        <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">3343: </span>      }
<span class="linenr">3344: </span>    }
<span class="linenr">3345: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">3346: </span>  }
<span class="linenr">3347: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getParentCondition</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">3348: </span>    <span class=
"org-keyword">while</span> (<span class=
"org-constant">true</span>) {
<span class="linenr">3349: </span>      <span class=
"org-keyword">if</span> (node.type === NodeTypes.JS_CONDITIONAL_EXPRESSION) {
<span class="linenr">3350: </span>        <span class=
"org-keyword">if</span> (node.alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION) {
<span class="linenr">3351: </span>          node = node.alternate
<span class="linenr">3352: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">3353: </span>          <span class=
"org-keyword">return</span> node
<span class="linenr">3354: </span>        }
<span class="linenr">3355: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (node.type === NodeTypes.JS_CACHE_EXPRESSION) {
<span class="linenr">3356: </span>        node = node.value
<span class="linenr">3357: </span>      }
<span class="linenr">3358: </span>    }
<span class="linenr">3359: </span>  }
<span class="linenr">3360: </span>  
<span class="linenr">3361: </span>  
<span class="linenr">3362: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformIf</span> = createStructuralDirectiveTransform(
<span class="linenr">3363: </span>    <span class=
"org-string">/^(if|else|else-if)$/</span>,
<span class="linenr">3364: </span>    (node, dir, context) =&gt; {
<span class="linenr">3365: </span>      <span class=
"org-keyword">return</span> processIf(node, dir, context, (ifNode, branch, isRoot) =&gt; {
<span class="linenr">3366: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">siblings</span> = context.parent.children
<span class="linenr">3367: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if...else if...else 都处于同级渲染</span>
<span class="linenr">3368: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = siblings.indexOf(ifNode)
<span class="linenr">3369: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">key</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">3370: </span>        <span class=
"org-keyword">while</span> (i-- &gt;= <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">3371: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">sibling</span> = siblings[i]
<span class="linenr">3372: </span>          <span class=
"org-keyword">if</span> (sibling &amp;& sibling.type === NodeTypes.IF) {
<span class=
"linenr">3373: </span>            key += sibling.branches.length
<span class="linenr">3374: </span>          }
<span class="linenr">3375: </span>        }
<span class="linenr">3376: </span>  
<span class="linenr">3377: </span>        logg(<span class=
"org-string">'transformIf'</span>, ifNode, { isRoot, branch })
<span class="linenr">3378: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">退出时的回调，当所有 children 被遍历转换完成时被调用生成 codegenNode</span>
<span class="linenr">3379: </span>        <span class=
"org-keyword">return</span> () =&gt; {
<span class="linenr">3380: </span>          <span class=
"org-keyword">if</span> (isRoot) { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-if</span>
<span class=
"linenr">3381: </span>            ifNode.codegenNode = createCodegenNodeForBranch(
<span class=
"linenr">3382: </span>              branch, key, context
<span class="linenr">3383: </span>            )
<span class="linenr">3384: </span>            logg(<span class=
"org-string">'transformIf - isRoot - v-if'</span>, ifNode)
<span class="linenr">3385: </span>          } <span class=
"org-keyword">else</span> { <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-else, v-else-if</span>
<span class="linenr">3386: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将 v-else-* 分枝挂到 v-if 节点下面</span>
<span class="linenr">3387: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parentCondition</span> = getParentCondition(ifNode.codegenNode)
<span class=
"linenr">3388: </span>            parentCondition.alternate = createCodegenNodeForBranch(
<span class=
"linenr">3389: </span>              branch, key + ifNode.branches.length - <span class="org-highlight-numbers-number">1</span>,
<span class="linenr">3390: </span>              context
<span class="linenr">3391: </span>            )
<span class="linenr">3392: </span>            logg(<span class=
"org-string">'transformIf - v-else-*'</span>, ifNode)
<span class="linenr">3393: </span>          }
<span class="linenr">3394: </span>        }
<span class="linenr">3395: </span>  
<span class="linenr">3396: </span>      })
<span class="linenr">3397: </span>    }
<span class="linenr">3398: </span>  )
<span class="linenr">3399: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">memoSeen</span> = <span class=
"org-keyword">new</span> <span class="org-type">WeakSet</span>()
<span class="linenr">3400: </span>  
<span class="linenr">3401: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformMemo</span> = (node, context) =&gt; {
<span class="linenr">3402: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT) {
<span class="linenr">3403: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dir</span> = findDir(node, <span class=
"org-string">'memo'</span>)
<span class="linenr">3404: </span>      <span class=
"org-keyword">if</span> (!dir || memoSeen.has(node)) {
<span class="linenr">3405: </span>        <span class=
"org-keyword">return</span>
<span class="linenr">3406: </span>      }
<span class="linenr">3407: </span>      memoSeen.add(node)
<span class="linenr">3408: </span>      <span class=
"org-keyword">return</span> () =&gt; {
<span class="linenr">3409: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">codegenNode</span> = node.codegenNode || context.currentNode.codegenNode
<span class="linenr">3410: </span>        <span class=
"org-keyword">if</span> (codegenNode &amp;& codegenNode.type === NodeTypes.VNODE_CALL) {
<span class="linenr">3411: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">non-component sub tree should be turned into a block</span>
<span class="linenr">3412: </span>          <span class=
"org-keyword">if</span> (node.tagType !== ElementTypes.COMPONENT) {
<span class=
"linenr">3413: </span>            makeBlock(codegenNode, context)
<span class="linenr">3414: </span>          }
<span class=
"linenr">3415: </span>          node.codegenNode = createCallExpression(context.helper(WITH_MEMO), [
<span class="linenr">3416: </span>            dir.exp,
<span class=
"linenr">3417: </span>            createFunctionExpression(<span class="org-constant">undefined</span>, codegenNode),
<span class="linenr">3418: </span>            <span class=
"org-string">`_cache`</span>,
<span class=
"linenr">3419: </span>            String(context.cached++)
<span class="linenr">3420: </span>          ])
<span class="linenr">3421: </span>        }
<span class="linenr">3422: </span>      }
<span class="linenr">3423: </span>    }
<span class="linenr">3424: </span>  }
<span class="linenr">3425: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformModel</span> = (dir, node, context) =&gt; {
<span class="linenr">3426: </span>    <span class=
"org-keyword">const</span> { exp, arg } = dir
<span class="linenr">3427: </span>    <span class=
"org-keyword">if</span> (!exp) {
<span class="linenr">3428: </span>      logg(<span class=
"org-string">`transformModel no exp`</span>)
<span class="linenr">3429: </span>      <span class=
"org-keyword">return</span> createTransformProps()
<span class="linenr">3430: </span>    }
<span class="linenr">3431: </span>  
<span class="linenr">3432: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawExp</span> = exp.loc.source
<span class="linenr">3433: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">expString</span> =
<span class=
"linenr">3434: </span>      exp.type === NodeTypes.SIMPLE_EXPRESSION ? exp.content : rawExp
<span class="linenr">3435: </span>  
<span class="linenr">3436: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">im SFC &lt;script setup&gt; inline mode, the exp may have been transformed into</span>
<span class="linenr">3437: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">_unref(exp)</span>
<span class="linenr">3438: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bindingType</span> = context.bindingMetadata[rawExp]
<span class="linenr">3439: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">maybeRef</span> =
<span class="linenr">3440: </span>      !__BROWSER__ &amp;&
<span class="linenr">3441: </span>      context.inline &amp;&
<span class="linenr">3442: </span>      bindingType &amp;&
<span class=
"linenr">3443: </span>      bindingType !== BindingTypes.SETUP_CONST
<span class="linenr">3444: </span>  
<span class="linenr">3445: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">3446: </span>      !expString.trim() ||
<span class=
"linenr">3447: </span>      (!isMemberExpression(expString, context) &amp;& !maybeRef)
<span class="linenr">3448: </span>    ) {
<span class="linenr">3449: </span>      <span class=
"org-keyword">return</span> createTransformProps()
<span class="linenr">3450: </span>    }
<span class="linenr">3451: </span>  
<span class="linenr">3452: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">3453: </span>      !__BROWSER__ &amp;&
<span class=
"linenr">3454: </span>      context.prefixIdentifiers &amp;&
<span class=
"linenr">3455: </span>      isSimpleIdentifier(expString) &amp;&
<span class=
"linenr">3456: </span>      context.identifiers[expString]
<span class="linenr">3457: </span>    ) {
<span class="linenr">3458: </span>      <span class=
"org-keyword">return</span> createTransformProps()
<span class="linenr">3459: </span>    }
<span class="linenr">3460: </span>  
<span class="linenr">3461: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">propName</span> = arg ? arg : createSimpleExpression(<span class="org-string">'modelValue'</span>, <span class="org-constant">true</span>)
<span class="linenr">3462: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">eventName</span> = arg
<span class="linenr">3463: </span>      ? isStaticExp(arg)
<span class="linenr">3464: </span>        ? <span class=
"org-string">`onUpdate:${arg.content}`</span>
<span class=
"linenr">3465: </span>        : createCompoundExpression([<span class="org-string">'"onUpdate:" + '</span>, arg])
<span class="linenr">3466: </span>      : <span class=
"org-string">`onUpdate:modelValue`</span>
<span class="linenr">3467: </span>  
<span class="linenr">3468: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">assignmentExp</span>
<span class="linenr">3469: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">eventArg</span> = context.isTS ? <span class=
"org-string">`($event: any)`</span> : <span class=
"org-string">`$event`</span>
<span class="linenr">3470: </span>    <span class=
"org-keyword">if</span> (maybeRef) {
<span class="linenr">3471: </span>      <span class=
"org-keyword">if</span> (bindingType === BindingTypes.SETUP_REF) {
<span class="linenr">3472: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-model used on known ref.</span>
<span class=
"linenr">3473: </span>        assignmentExp = createCompoundExpression([
<span class="linenr">3474: </span>          <span class=
"org-string">`${eventArg} =&gt; ((`</span>,
<span class=
"linenr">3475: </span>          createSimpleExpression(rawExp, <span class="org-constant">false</span>, exp.loc),
<span class="linenr">3476: </span>          <span class=
"org-string">`).value = $event)`</span>
<span class="linenr">3477: </span>        ])
<span class="linenr">3478: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">3479: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-model used on a potentially ref binding in &lt;script setup&gt; inline mode.</span>
<span class="linenr">3480: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the assignment needs to check whether the binding is actually a ref.</span>
<span class="linenr">3481: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">altAssignment</span> =
<span class=
"linenr">3482: </span>          bindingType === BindingTypes.SETUP_LET ? <span class="org-string">`${rawExp} = $event`</span> : <span class="org-string">`null`</span>
<span class=
"linenr">3483: </span>        assignmentExp = createCompoundExpression([
<span class="linenr">3484: </span>          <span class=
"org-string">`${eventArg} =&gt; (${context.helperString(IS_REF)}(${rawExp}) ? (`</span>,
<span class=
"linenr">3485: </span>          createSimpleExpression(rawExp, <span class="org-constant">false</span>, exp.loc),
<span class="linenr">3486: </span>          <span class=
"org-string">`).value = $event : ${altAssignment})`</span>
<span class="linenr">3487: </span>        ])
<span class="linenr">3488: </span>      }
<span class="linenr">3489: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">3490: </span>      assignmentExp = createCompoundExpression([
<span class="linenr">3491: </span>        <span class=
"org-string">`${eventArg} =&gt; ((`</span>,
<span class="linenr">3492: </span>        exp,
<span class="linenr">3493: </span>        <span class=
"org-string">`) = $event)`</span>
<span class="linenr">3494: </span>      ])
<span class="linenr">3495: </span>    }
<span class="linenr">3496: </span>  
<span class="linenr">3497: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">props</span> = [
<span class="linenr">3498: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">modelValue: foo</span>
<span class=
"linenr">3499: </span>      createObjectProperty(propName, dir.exp),
<span class="linenr">3500: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">"onUpdate:modelValue": $event =&gt; (foo = $event)</span>
<span class=
"linenr">3501: </span>      createObjectProperty(eventName, assignmentExp)
<span class="linenr">3502: </span>    ]
<span class="linenr">3503: </span>  
<span class="linenr">3504: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">cache v-model handler if applicable (when it doesn't refer any scope vars)</span>
<span class="linenr">3505: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">3506: </span>      !__BROWSER__ &amp;&
<span class=
"linenr">3507: </span>      context.prefixIdentifiers &amp;&
<span class="linenr">3508: </span>      !context.inVOnce &amp;&
<span class=
"linenr">3509: </span>      context.cacheHandlers &amp;&
<span class=
"linenr">3510: </span>      !hasScopeRef(exp, context.identifiers)
<span class="linenr">3511: </span>    ) {
<span class="linenr">3512: </span>      props[<span class=
"org-highlight-numbers-number">1</span>].value = context.cache(props[<span class="org-highlight-numbers-number">1</span>].value)
<span class="linenr">3513: </span>    }
<span class="linenr">3514: </span>  
<span class="linenr">3515: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">modelModifiers: { foo: true, "bar-baz": true }</span>
<span class="linenr">3516: </span>    <span class=
"org-keyword">if</span> (dir.modifiers.length &amp;& node.tagType === ElementTypes.COMPONENT) {
<span class="linenr">3517: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifiers</span> = dir.modifiers
<span class=
"linenr">3518: </span>        .map(m =&gt; (isSimpleIdentifier(m) ? m : JSON.stringify(m)) + <span class="org-string">`: true`</span>)
<span class="linenr">3519: </span>        .join(<span class=
"org-string">`, `</span>)
<span class="linenr">3520: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifiersKey</span> = arg
<span class="linenr">3521: </span>        ? isStaticExp(arg)
<span class="linenr">3522: </span>          ? <span class=
"org-string">`${arg.content}Modifiers`</span>
<span class=
"linenr">3523: </span>          : createCompoundExpression([arg, <span class="org-string">' + "Modifiers"'</span>])
<span class="linenr">3524: </span>        : <span class=
"org-string">`modelModifiers`</span>
<span class="linenr">3525: </span>      props.push(
<span class="linenr">3526: </span>        createObjectProperty(
<span class="linenr">3527: </span>          modifiersKey,
<span class="linenr">3528: </span>          createSimpleExpression(
<span class="linenr">3529: </span>            <span class=
"org-string">`{ ${modifiers} }`</span>,
<span class="linenr">3530: </span>            <span class=
"org-constant">false</span>,
<span class="linenr">3531: </span>            dir.loc,
<span class=
"linenr">3532: </span>            ConstantTypes.CAN_HOIST
<span class="linenr">3533: </span>          )
<span class="linenr">3534: </span>        )
<span class="linenr">3535: </span>      )
<span class="linenr">3536: </span>    }
<span class="linenr">3537: </span>  
<span class="linenr">3538: </span>    <span class=
"org-keyword">return</span> createTransformProps(props)
<span class="linenr">3539: </span>  }
<span class="linenr">3540: </span>  
<span class="linenr">3541: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createTransformProps</span>(<span class=
"org-variable-name">props</span> = []) {
<span class="linenr">3542: </span>    <span class=
"org-keyword">return</span> { props }
<span class="linenr">3543: </span>  }
<span class="linenr">3544: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">函数表达式正则, @click="fnExp"</span>
<span class="linenr">3545: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">fnExpRE</span> =
<span class="linenr">3546: </span>    <span class=
"org-string">/^\s*([\w$_]+|(async\s*)?\([^)]*?\))\s*=&gt;|^\s*(async\s+)?function(?:\s+[\w$]+)?\s*\(/</span>
<span class="linenr">3547: </span>  
<span class="linenr">3548: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformOn</span> = (
<span class="linenr">3549: </span>    dir,
<span class="linenr">3550: </span>    node,
<span class="linenr">3551: </span>    context,
<span class="linenr">3552: </span>    augmentor
<span class="linenr">3553: </span>  ) =&gt; {
<span class="linenr">3554: </span>    <span class=
"org-keyword">const</span> { loc, modifiers, arg } = dir
<span class="linenr">3555: </span>  
<span class="linenr">3556: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">eventName</span>
<span class="linenr">3557: </span>    <span class=
"org-keyword">if</span> (arg.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">3558: </span>      <span class=
"org-keyword">if</span> (arg.isStatic) {
<span class="linenr">3559: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">rawName</span> = arg.content
<span class="linenr">3560: </span>  
<span class="linenr">3561: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将事件名转成驼峰式</span>
<span class=
"linenr">3562: </span>        eventName = createSimpleExpression(
<span class=
"linenr">3563: </span>          toHandlerKey(camelize(rawName)),
<span class="linenr">3564: </span>          <span class=
"org-constant">true</span>,
<span class="linenr">3565: </span>          arg.loc
<span class="linenr">3566: </span>        )
<span class="linenr">3567: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">3568: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#2388 toHandlerKey 将事件名转成 onXxx, 如：eventName -&gt; onEventName</span>
<span class=
"linenr">3569: </span>        eventName = createCompoundExpression([
<span class="linenr">3570: </span>          <span class=
"org-string">`${context.helperString(TO_HANDLER_KEY)}(`</span>,
<span class="linenr">3571: </span>          arg,
<span class="linenr">3572: </span>          <span class=
"org-string">`)`</span>
<span class="linenr">3573: </span>        ])
<span class="linenr">3574: </span>      }
<span class="linenr">3575: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">3576: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">already a compound expression.</span>
<span class="linenr">3577: </span>  
<span class="linenr">3578: </span>      eventName = arg
<span class=
"linenr">3579: </span>      eventName.children.unshift(<span class=
"org-string">`${context.helperString(TO_HANDLER_KEY)}(`</span>)
<span class=
"linenr">3580: </span>      eventName.children.push(<span class=
"org-string">`)`</span>)
<span class="linenr">3581: </span>    }
<span class="linenr">3582: </span>  
<span class="linenr">3583: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">handler processing, 事件表达式内容</span>
<span class="linenr">3584: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">exp</span> = dir.exp
<span class="linenr">3585: </span>    <span class=
"org-keyword">if</span> (exp &amp;& !exp.content.trim()) {
<span class="linenr">3586: </span>      exp = <span class=
"org-constant">undefined</span>
<span class="linenr">3587: </span>    }
<span class="linenr">3588: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">事件处理函数缓存</span>
<span class="linenr">3589: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">shouldCache</span> = context.cacheHandlers &amp;& !exp &amp;& !context.inVOnce
<span class="linenr">3590: </span>    <span class=
"org-keyword">if</span> (exp) {
<span class="linenr">3591: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isMemberExp</span> = isMemberExpression(exp.content, context)
<span class="linenr">3592: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isInlineStatement</span> = !(isMemberExp || fnExpRE.test(exp.content))
<span class="linenr">3593: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasMultipleStatements</span> = exp.content.includes(<span class="org-string">`;`</span>)
<span class="linenr">3594: </span>  
<span class="linenr">3595: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">process the expression since it's been skipped</span>
<span class="linenr">3596: </span>      <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.prefixIdentifiers) {
<span class=
"linenr">3597: </span>        isInlineStatement &amp;& context.addIdentifiers(<span class="org-string">`$event`</span>)
<span class=
"linenr">3598: </span>        exp = dir.exp = processExpression(
<span class="linenr">3599: </span>          exp,
<span class="linenr">3600: </span>          context,
<span class="linenr">3601: </span>          <span class=
"org-constant">false</span>,
<span class="linenr">3602: </span>          hasMultipleStatements
<span class="linenr">3603: </span>        )
<span class=
"linenr">3604: </span>        isInlineStatement &amp;& context.removeIdentifiers(<span class="org-string">`$event`</span>)
<span class="linenr">3605: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">with scope analysis, the function is hoistable if it has no reference</span>
<span class="linenr">3606: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to scope variables.</span>
<span class="linenr">3607: </span>        shouldCache =
<span class=
"linenr">3608: </span>          context.cacheHandlers &amp;&
<span class="linenr">3609: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">unnecessary to cache inside v-once</span>
<span class="linenr">3610: </span>          !context.inVOnce &amp;&
<span class="linenr">3611: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">runtime constants don't need to be cached</span>
<span class="linenr">3612: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(this is analyzed by compileScript in SFC &lt;script setup&gt;)</span>
<span class=
"linenr">3613: </span>          !(exp.type === NodeTypes.SIMPLE_EXPRESSION &amp;& exp.constType &gt; <span class="org-highlight-numbers-number">0</span>) &amp;&
<span class="linenr">3614: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#1541 bail if this is a member exp handler passed to a component -</span>
<span class="linenr">3615: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we need to use the original function to preserve arity,</span>
<span class="linenr">3616: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">e.g. &lt;transition&gt; relies on checking cb.length to determine</span>
<span class="linenr">3617: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">transition end handling. Inline function is ok since its arity</span>
<span class="linenr">3618: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">is preserved even when cached.</span>
<span class=
"linenr">3619: </span>          !(isMemberExp &amp;& node.tagType === ElementTypes.COMPONENT) &amp;&
<span class="linenr">3620: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail if the function references closure variables (v-for, v-slot)</span>
<span class="linenr">3621: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">it must be passed fresh to avoid stale values.</span>
<span class=
"linenr">3622: </span>          !hasScopeRef(exp, context.identifiers)
<span class="linenr">3623: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">If the expression is optimizable and is a member expression pointing</span>
<span class="linenr">3624: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to a function, turn it into invocation (and wrap in an arrow function</span>
<span class="linenr">3625: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">below) so that it always accesses the latest value when called - thus</span>
<span class="linenr">3626: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">avoiding the need to be patched.</span>
<span class="linenr">3627: </span>        <span class=
"org-keyword">if</span> (shouldCache &amp;& isMemberExp) {
<span class="linenr">3628: </span>          <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class=
"linenr">3629: </span>            exp.content = <span class=
"org-string">`${exp.content} &amp;& ${exp.content}(...args)`</span>
<span class="linenr">3630: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr">3631: </span>            exp.children = [...exp.children, <span class="org-string">` &amp;& `</span>, ...exp.children, <span class="org-string">`(...args)`</span>]
<span class="linenr">3632: </span>          }
<span class="linenr">3633: </span>        }
<span class="linenr">3634: </span>      }
<span class="linenr">3635: </span>  
<span class="linenr">3636: </span>      <span class=
"org-keyword">if</span> (isInlineStatement || (shouldCache &amp;& isMemberExp)) {
<span class="linenr">3637: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">wrap inline statement in a function expression</span>
<span class="linenr">3638: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">($event) =&gt; statement</span>
<span class="linenr">3639: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(...args) =&gt; { statement1;statement2 }</span>
<span class=
"linenr">3640: </span>        exp = createCompoundExpression([
<span class="linenr">3641: </span>          <span class=
"org-string">`${</span>
<span class="linenr">3642: </span><span class=
"org-string">            isInlineStatement</span>
<span class="linenr">3643: </span><span class=
"org-string">              ? `</span>$event<span class=
"org-string">`</span>
<span class="linenr">3644: </span><span class=
"org-string">              : `</span>(...args)<span class=
"org-string">`</span>
<span class="linenr">3645: </span><span class=
"org-string">          } =&gt; ${hasMultipleStatements ? `</span>{<span class="org-string">` : `</span>(<span class="org-string">`}`</span>,
<span class="linenr">3646: </span>          exp,
<span class=
"linenr">3647: </span>          hasMultipleStatements ? <span class="org-string">`}`</span> : <span class="org-string">`)`</span>
<span class="linenr">3648: </span>        ])
<span class="linenr">3649: </span>      }
<span class="linenr">3650: </span>    }
<span class="linenr">3651: </span>  
<span class="linenr">3652: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ret</span> = {
<span class="linenr">3653: </span>      props: [
<span class="linenr">3654: </span>        createObjectProperty(
<span class="linenr">3655: </span>          eventName,
<span class=
"linenr">3656: </span>          exp || createSimpleExpression(<span class="org-string">`() =&gt; {}`</span>, <span class="org-constant">false</span>, loc)
<span class="linenr">3657: </span>        )
<span class="linenr">3658: </span>      ]
<span class="linenr">3659: </span>    }
<span class="linenr">3660: </span>  
<span class="linenr">3661: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">apply extended compiler augmentor</span>
<span class="linenr">3662: </span>    <span class=
"org-keyword">if</span> (augmentor) {
<span class="linenr">3663: </span>      ret = augmentor(ret)
<span class="linenr">3664: </span>    }
<span class="linenr">3665: </span>  
<span class="linenr">3666: </span>    <span class=
"org-keyword">if</span> (shouldCache) {
<span class="linenr">3667: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">cache handlers so that it's always the same handler being passed down.</span>
<span class="linenr">3668: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this avoids unnecessary re-renders when users use inline handlers on</span>
<span class="linenr">3669: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">components.</span>
<span class="linenr">3670: </span>      ret.props[<span class=
"org-highlight-numbers-number">0</span>].value = context.cache(ret.props[<span class="org-highlight-numbers-number">0</span>].value)
<span class="linenr">3671: </span>    }
<span class="linenr">3672: </span>  
<span class="linenr">3673: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mark the key as handler for props normalization check</span>
<span class=
"linenr">3674: </span>    ret.props.forEach(p =&gt; (p.key.isHandlerKey = <span class="org-constant">true</span>))
<span class="linenr">3675: </span>    <span class=
"org-keyword">return</span> ret
<span class="linenr">3676: </span>  }
<span class="linenr">3677: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">seen</span> = <span class=
"org-keyword">new</span> <span class="org-type">WeakSet</span>()
<span class="linenr">3678: </span>  
<span class="linenr">3679: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformOnce</span> = (node, context) =&gt; {
<span class="linenr">3680: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT &amp;& findDir(node, <span class="org-string">'once'</span>, <span class="org-constant">true</span>)) {
<span class="linenr">3681: </span>      <span class=
"org-keyword">if</span> (seen.has(node) || context.inVOnce) {
<span class="linenr">3682: </span>        logg(<span class=
"org-string">`transformOnce node has seen`</span>)
<span class="linenr">3683: </span>        <span class=
"org-keyword">return</span>
<span class="linenr">3684: </span>      }
<span class="linenr">3685: </span>      seen.add(node)
<span class=
"linenr">3686: </span>      context.inVOnce = <span class=
"org-constant">true</span>
<span class=
"linenr">3687: </span>      context.helper(SET_BLOCK_TRACKING)
<span class="linenr">3688: </span>      <span class=
"org-keyword">return</span> () =&gt; {
<span class=
"linenr">3689: </span>        context.inVOnce = <span class=
"org-constant">false</span>
<span class="linenr">3690: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">cur</span> = context.currentNode
<span class="linenr">3691: </span>        <span class=
"org-keyword">if</span> (cur.codegenNode) {
<span class=
"linenr">3692: </span>          cur.codegenNode = context.cache(cur.codegenNode, <span class="org-constant">true</span> <span class="org-comment-delimiter">/* </span><span class="org-comment">isVNode</span><span class="org-comment-delimiter"> */</span>)
<span class="linenr">3693: </span>        }
<span class="linenr">3694: </span>      }
<span class="linenr">3695: </span>    }
<span class="linenr">3696: </span>  }
<span class="linenr">3697: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Important: since this function uses Node.js only dependencies, it should</span>
<span class="linenr">3698: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">always be used with a leading !__BROWSER__ check so that it can be</span>
<span class="linenr">3699: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">tree-shaken from the browser build.</span>
<span class="linenr">3700: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">processExpression</span>(
<span class="linenr">3701: </span>    <span class=
"org-variable-name">node</span>,
<span class="linenr">3702: </span>    <span class=
"org-variable-name">context</span>,
<span class="linenr">3703: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">some expressions like v-slot props & v-for aliases should be parsed as</span>
<span class="linenr">3704: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">function params</span>
<span class="linenr">3705: </span>    asParams = <span class=
"org-constant">false</span>,
<span class="linenr">3706: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">v-on handler values may contain multiple statements</span>
<span class=
"linenr">3707: </span>    asRawStatements = <span class="org-constant">false</span>,
<span class=
"linenr">3708: </span>    localVars = Object.create(context.identifiers)
<span class="linenr">3709: </span>  ) {
<span class="linenr">3710: </span>    <span class=
"org-keyword">if</span> (__BROWSER__) {
<span class="linenr">3711: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">3712: </span>    }
<span class="linenr">3713: </span>  
<span class="linenr">3714: </span>    <span class=
"org-keyword">if</span> (!context.prefixIdentifiers || !node.content.trim()) {
<span class="linenr">3715: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">3716: </span>    }
<span class="linenr">3717: </span>  
<span class="linenr">3718: </span>    <span class=
"org-keyword">const</span> { inline, bindingMetadata } = context
<span class="linenr">3719: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rewriteIdentifier</span> = (raw, parent, id) =&gt; {
<span class="linenr">3720: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">type</span> = hasOwn(bindingMetadata, raw) &amp;& bindingMetadata[raw]
<span class="linenr">3721: </span>      <span class=
"org-keyword">if</span> (inline) {
<span class="linenr">3722: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x = y</span>
<span class="linenr">3723: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isAssignmentLVal</span> =
<span class=
"linenr">3724: </span>          parent &amp;& parent.type === <span class="org-string">'AssignmentExpression'</span> &amp;& parent.left === id
<span class="linenr">3725: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x++</span>
<span class="linenr">3726: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isUpdateArg</span> =
<span class=
"linenr">3727: </span>          parent &amp;& parent.type === <span class="org-string">'UpdateExpression'</span> &amp;& parent.argument === id
<span class="linenr">3728: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">({ x } = y)</span>
<span class="linenr">3729: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isDestructureAssignment</span> =
<span class=
"linenr">3730: </span>          parent &amp;& isInDestructureAssignment(parent, parentStack)
<span class="linenr">3731: </span>  
<span class="linenr">3732: </span>        <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_CONST || localVars[raw]) {
<span class="linenr">3733: </span>          <span class=
"org-keyword">return</span> raw
<span class="linenr">3734: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_REF) {
<span class="linenr">3735: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`${raw}.value`</span>
<span class="linenr">3736: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_MAYBE_REF) {
<span class="linenr">3737: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">const binding that may or may not be ref</span>
<span class="linenr">3738: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if it's not a ref, then assignments don't make sense -</span>
<span class="linenr">3739: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">so we ignore the non-ref assignment case and generate code</span>
<span class="linenr">3740: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">that assumes the value to be a ref for more efficiency</span>
<span class="linenr">3741: </span>          <span class=
"org-keyword">return</span> isAssignmentLVal || isUpdateArg || isDestructureAssignment
<span class="linenr">3742: </span>            ? <span class=
"org-string">`${raw}.value`</span>
<span class="linenr">3743: </span>            : <span class=
"org-string">`${context.helperString(UNREF)}(${raw})`</span>
<span class="linenr">3744: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.SETUP_LET) {
<span class="linenr">3745: </span>          <span class=
"org-keyword">if</span> (isAssignmentLVal) {
<span class="linenr">3746: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding.</span>
<span class="linenr">3747: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this is a bit more tricky as we need to cover the case where</span>
<span class="linenr">3748: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let is a local non-ref value, and we need to replicate the</span>
<span class="linenr">3749: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">right hand side value.</span>
<span class="linenr">3750: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x = y --&gt; isRef(x) ? x.value = y : x = y</span>
<span class="linenr">3751: </span>            <span class=
"org-keyword">const</span> { right: rVal, operator } = parent
<span class="linenr">3752: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rExp</span> = rawExp.slice(rVal.start - <span class="org-highlight-numbers-number">1</span>, rVal.end - <span class="org-highlight-numbers-number">1</span>)
<span class="linenr">3753: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rExpString</span> = stringifyExpression(
<span class="linenr">3754: </span>              processExpression(
<span class=
"linenr">3755: </span>                createSimpleExpression(rExp, <span class="org-constant">false</span>),
<span class="linenr">3756: </span>                context,
<span class="linenr">3757: </span>                <span class=
"org-constant">false</span>,
<span class="linenr">3758: </span>                <span class=
"org-constant">false</span>,
<span class="linenr">3759: </span>                knownIds
<span class="linenr">3760: </span>              )
<span class="linenr">3761: </span>            )
<span class="linenr">3762: </span>            <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(IS_REF)}(${raw})${``} ? ${raw}.value ${operator} ${rExpString} : ${raw}`</span>
<span class="linenr">3763: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isUpdateArg) {
<span class="linenr">3764: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">make id replace parent in the code range so the raw update operator</span>
<span class="linenr">3765: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">is removed</span>
<span class=
"linenr">3766: </span>            id.start = parent.start
<span class="linenr">3767: </span>            id.end = parent.end
<span class="linenr">3768: </span>            <span class=
"org-keyword">const</span> { prefix: isPrefix, operator } = parent
<span class="linenr">3769: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prefix</span> = isPrefix ? operator : <span class="org-string">``</span>
<span class="linenr">3770: </span>            <span class=
"org-keyword">const</span> <span class=
"org-variable-name">postfix</span> = isPrefix ? <span class=
"org-string">``</span> : operator
<span class="linenr">3771: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding.</span>
<span class="linenr">3772: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">x++ --&gt; isRef(a) ? a.value++ : a++</span>
<span class="linenr">3773: </span>            <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(IS_REF)}(${raw})${``} ? ${prefix}${raw}.value${postfix} : ${prefix}${raw}${postfix}`</span>
<span class="linenr">3774: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isDestructureAssignment) {
<span class="linenr">3775: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span>
<span class="linenr">3776: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">let binding in a destructure assignment - it's very tricky to</span>
<span class="linenr">3777: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">handle both possible cases here without altering the original</span>
<span class="linenr">3778: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">structure of the code, so we just assume it's not a ref here</span>
<span class="linenr">3779: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for now</span>
<span class="linenr">3780: </span>            <span class=
"org-keyword">return</span> raw
<span class="linenr">3781: </span>          } <span class=
"org-keyword">else</span> {
<span class="linenr">3782: </span>            <span class=
"org-keyword">return</span> <span class=
"org-string">`${context.helperString(UNREF)}(${raw})`</span>
<span class="linenr">3783: </span>          }
<span class="linenr">3784: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS) {
<span class="linenr">3785: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">use __props which is generated by compileScript so in ts mode</span>
<span class="linenr">3786: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">it gets correct type</span>
<span class="linenr">3787: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`__props.${raw}`</span>
<span class="linenr">3788: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS_ALIASED) {
<span class="linenr">3789: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">prop with a different local alias (from defineProps() destructure)</span>
<span class="linenr">3790: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`__props.${bindingMetadata.__propsAliases[raw]}`</span>
<span class="linenr">3791: </span>        }
<span class="linenr">3792: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">3793: </span>        <span class=
"org-keyword">if</span> (type &amp;& type.startsWith(<span class=
"org-string">'setup'</span>)) {
<span class="linenr">3794: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">setup bindings in non-inline mode</span>
<span class="linenr">3795: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`$setup.${raw}`</span>
<span class="linenr">3796: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type === BindingTypes.PROPS_ALIASED) {
<span class="linenr">3797: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`$props.${bindingMetadata.__propsAliases[raw]}`</span>
<span class="linenr">3798: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type) {
<span class="linenr">3799: </span>          <span class=
"org-keyword">return</span> <span class=
"org-string">`$${type}.${raw}`</span>
<span class="linenr">3800: </span>        }
<span class="linenr">3801: </span>      }
<span class="linenr">3802: </span>  
<span class="linenr">3803: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fallback to ctx</span>
<span class="linenr">3804: </span>      <span class=
"org-keyword">return</span> <span class=
"org-string">`_ctx.${raw}`</span>
<span class="linenr">3805: </span>    }
<span class="linenr">3806: </span>  
<span class="linenr">3807: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fast path if expression is a simple identifier.</span>
<span class="linenr">3808: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">rawExp</span> = node.content
<span class="linenr">3809: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail constant on parens (function invocation) and dot (member access)</span>
<span class="linenr">3810: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bailConstant</span> = rawExp.indexOf(<span class="org-string">`(`</span>) &gt; -<span class="org-highlight-numbers-number">1</span> || rawExp.indexOf(<span class="org-string">'.'</span>) &gt; <span class="org-highlight-numbers-number">0</span>
<span class="linenr">3811: </span>  
<span class="linenr">3812: </span>    <span class=
"org-keyword">if</span> (isSimpleIdentifier(rawExp)) {
<span class="linenr">3813: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isScopeVarReference</span> = context.identifiers[rawExp]
<span class="linenr">3814: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isAllowedGlobal</span> = isGloballyWhitelisted(rawExp)
<span class="linenr">3815: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isLiteral</span> = isLiteralWhitelisted(rawExp)
<span class="linenr">3816: </span>      <span class=
"org-keyword">if</span> (!asParams &amp;& !isScopeVarReference &amp;& !isAllowedGlobal &amp;& !isLiteral) {
<span class="linenr">3817: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">const bindings exposed from setup can be skipped for patching but</span>
<span class="linenr">3818: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">cannot be hoisted to module scope</span>
<span class="linenr">3819: </span>        <span class=
"org-keyword">if</span> (bindingMetadata[node.content] === BindingTypes.SETUP_CONST) {
<span class=
"linenr">3820: </span>          node.constType = ConstantTypes.CAN_SKIP_PATCH
<span class="linenr">3821: </span>        }
<span class=
"linenr">3822: </span>        node.content = rewriteIdentifier(rawExp)
<span class="linenr">3823: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (!isScopeVarReference) {
<span class="linenr">3824: </span>        <span class=
"org-keyword">if</span> (isLiteral) {
<span class=
"linenr">3825: </span>          node.constType = ConstantTypes.CAN_STRINGIFY
<span class="linenr">3826: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">3827: </span>          node.constType = ConstantTypes.CAN_HOIST
<span class="linenr">3828: </span>        }
<span class="linenr">3829: </span>      }
<span class="linenr">3830: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">3831: </span>    }
<span class="linenr">3832: </span>  
<span class="linenr">3833: </span>    <span class=
"org-keyword">let</span> <span class="org-variable-name">ast</span>
<span class="linenr">3834: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">exp needs to be parsed differently:</span>
<span class="linenr">3835: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">1. Multiple inline statements (v-on, with presence of `;`): parse as raw</span>
<span class="linenr">3836: </span>    <span class=
"org-comment-delimiter">//    </span><span class=
"org-comment">exp, but make sure to pad with spaces for consistent ranges</span>
<span class="linenr">3837: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">2. Expressions: wrap with parens (for e.g. object expressions)</span>
<span class="linenr">3838: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">3. Function arguments (v-for, v-slot): place in a function argument position</span>
<span class="linenr">3839: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">source</span> = asRawStatements
<span class="linenr">3840: </span>      ? <span class=
"org-string">` ${rawExp} `</span>
<span class="linenr">3841: </span>      : <span class=
"org-string">`(${rawExp})${asParams ? `</span>=&gt;{}<span class=
"org-string">` : ``}`</span>
<span class="linenr">3842: </span>    <span class=
"org-keyword">try</span> {
<span class=
"linenr">3843: </span>      ast = babelParser.parse(source, {
<span class=
"linenr">3844: </span>        plugins: context.expressionPlugins
<span class="linenr">3845: </span>      }).program
<span class="linenr">3846: </span>    } <span class=
"org-keyword">catch</span> (e) {
<span class="linenr">3847: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">3848: </span>    }
<span class="linenr">3849: </span>  
<span class="linenr">3850: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ids</span>= []
<span class="linenr">3851: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parentStack</span> = []
<span class="linenr">3852: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">knownIds</span> = Object.create(context.identifiers)
<span class="linenr">3853: </span>  
<span class="linenr">3854: </span>    walkIdentifiers(
<span class="linenr">3855: </span>      ast,
<span class=
"linenr">3856: </span>      (node, parent, _, isReferenced, isLocal) =&gt; {
<span class="linenr">3857: </span>        <span class=
"org-keyword">if</span> (isStaticPropertyKey(node, parent)) {
<span class="linenr">3858: </span>          <span class=
"org-keyword">return</span>
<span class="linenr">3859: </span>        }
<span class="linenr">3860: </span>  
<span class="linenr">3861: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needPrefix</span> = isReferenced &amp;& canPrefix(node)
<span class="linenr">3862: </span>        <span class=
"org-keyword">if</span> (needPrefix &amp;& !isLocal) {
<span class="linenr">3863: </span>          <span class=
"org-keyword">if</span> (isStaticProperty(parent) &amp;& parent.shorthand) {
<span class="linenr">3864: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">property shorthand like { foo }, we need to add the key since</span>
<span class="linenr">3865: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we rewrite the value</span>
<span class=
"linenr">3866: </span>            node.prefix = <span class=
"org-string">`${node.name}: `</span>
<span class="linenr">3867: </span>          }
<span class=
"linenr">3868: </span>          node.name = rewriteIdentifier(node.name, parent, node)
<span class="linenr">3869: </span>          ids.push(node)
<span class="linenr">3870: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">3871: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">The identifier is considered constant unless it's pointing to a</span>
<span class="linenr">3872: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">local scope variable (a v-for alias, or a v-slot prop)</span>
<span class="linenr">3873: </span>          <span class=
"org-keyword">if</span> (!(needPrefix &amp;& isLocal) &amp;& !bailConstant) {
<span class=
"linenr">3874: </span>            node.isConstant = <span class=
"org-constant">true</span>
<span class="linenr">3875: </span>          }
<span class="linenr">3876: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also generate sub-expressions for other identifiers for better</span>
<span class="linenr">3877: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">source map support. (except for property keys which are static)</span>
<span class="linenr">3878: </span>          ids.push(node)
<span class="linenr">3879: </span>        }
<span class="linenr">3880: </span>      },
<span class="linenr">3881: </span>      <span class=
"org-constant">true</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">invoke on ALL identifiers</span>
<span class="linenr">3882: </span>      parentStack,
<span class="linenr">3883: </span>      knownIds
<span class="linenr">3884: </span>    )
<span class="linenr">3885: </span>  
<span class="linenr">3886: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">We break up the compound expression into an array of strings and sub</span>
<span class="linenr">3887: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">expressions (for identifiers that have been prefixed). In codegen, if</span>
<span class="linenr">3888: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">an ExpressionNode has the `.children` property, it will be used instead of</span>
<span class="linenr">3889: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">`.content`.</span>
<span class="linenr">3890: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">children</span> = []
<span class=
"linenr">3891: </span>    ids.sort((a, b) =&gt; a.start - b.start)
<span class="linenr">3892: </span>    ids.forEach((id, i) =&gt; {
<span class="linenr">3893: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">range is offset by -1 due to the wrapping parens when parsed</span>
<span class="linenr">3894: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">start</span> = id.start - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">3895: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">end</span> = id.end - <span class=
"org-highlight-numbers-number">1</span>
<span class="linenr">3896: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">last</span> = ids[i - <span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr">3897: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">leadingText</span> = rawExp.slice(last ? last.end - <span class="org-highlight-numbers-number">1</span> : <span class="org-highlight-numbers-number">0</span>, start)
<span class="linenr">3898: </span>      <span class=
"org-keyword">if</span> (leadingText.length || id.prefix) {
<span class=
"linenr">3899: </span>        children.push(leadingText + (id.prefix || <span class="org-string">``</span>))
<span class="linenr">3900: </span>      }
<span class="linenr">3901: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">source</span> = rawExp.slice(start, end)
<span class="linenr">3902: </span>      children.push(
<span class="linenr">3903: </span>        createSimpleExpression(
<span class="linenr">3904: </span>          id.name,
<span class="linenr">3905: </span>          <span class=
"org-constant">false</span>,
<span class="linenr">3906: </span>          {
<span class="linenr">3907: </span>            source,
<span class=
"linenr">3908: </span>            start: advancePositionWithClone(node.loc.start, source, start),
<span class=
"linenr">3909: </span>            end: advancePositionWithClone(node.loc.start, source, end)
<span class="linenr">3910: </span>          },
<span class=
"linenr">3911: </span>          id.isConstant ? ConstantTypes.CAN_STRINGIFY : ConstantTypes.NOT_CONSTANT
<span class="linenr">3912: </span>        )
<span class="linenr">3913: </span>      )
<span class="linenr">3914: </span>      <span class=
"org-keyword">if</span> (i === ids.length - <span class=
"org-highlight-numbers-number">1</span> &amp;& end &lt; rawExp.length) {
<span class=
"linenr">3915: </span>        children.push(rawExp.slice(end))
<span class="linenr">3916: </span>      }
<span class="linenr">3917: </span>    })
<span class="linenr">3918: </span>  
<span class="linenr">3919: </span>    <span class=
"org-keyword">let</span> <span class="org-variable-name">ret</span>
<span class="linenr">3920: </span>    <span class=
"org-keyword">if</span> (children.length) {
<span class=
"linenr">3921: </span>      ret = createCompoundExpression(children, node.loc)
<span class="linenr">3922: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">3923: </span>      ret = node
<span class=
"linenr">3924: </span>      ret.constType = bailConstant
<span class=
"linenr">3925: </span>        ? ConstantTypes.NOT_CONSTANT
<span class=
"linenr">3926: </span>        : ConstantTypes.CAN_STRINGIFY
<span class="linenr">3927: </span>    }
<span class=
"linenr">3928: </span>    ret.identifiers = Object.keys(knownIds)
<span class="linenr">3929: </span>    <span class=
"org-keyword">return</span> ret
<span class="linenr">3930: </span>  }
<span class="linenr">3931: </span>  
<span class="linenr">3932: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">canPrefix</span>(<span class=
"org-variable-name">id</span>) {
<span class="linenr">3933: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">skip whitelisted globals</span>
<span class="linenr">3934: </span>    <span class=
"org-keyword">if</span> (isGloballyWhitelisted(id.name)) {
<span class="linenr">3935: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">3936: </span>    }
<span class="linenr">3937: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">special case for webpack compilation</span>
<span class="linenr">3938: </span>    <span class=
"org-keyword">if</span> (id.name === <span class=
"org-string">'require'</span>) {
<span class="linenr">3939: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">3940: </span>    }
<span class="linenr">3941: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">3942: </span>  }
<span class="linenr">3943: </span>  
<span class="linenr">3944: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyExpression</span>(<span class=
"org-variable-name">exp</span>){
<span class="linenr">3945: </span>    <span class=
"org-keyword">if</span> (isString(exp)) {
<span class="linenr">3946: </span>      <span class=
"org-keyword">return</span> exp
<span class="linenr">3947: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">3948: </span>      <span class=
"org-keyword">return</span> exp.content
<span class="linenr">3949: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">3950: </span>      <span class=
"org-keyword">return</span> exp.children.map(stringifyExpression).join(<span class="org-string">''</span>)
<span class="linenr">3951: </span>    }
<span class="linenr">3952: </span>  }
<span class="linenr">3953: </span>  
<span class="linenr">3954: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createRoot</span>(<span class=
"org-variable-name">children</span>, <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">locStub</span>) {
<span class="linenr">3955: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">3956: </span>      type: NodeTypes.ROOT,
<span class="linenr">3957: </span>      children,
<span class="linenr">3958: </span>      helpers: [],
<span class="linenr">3959: </span>      components: [],
<span class="linenr">3960: </span>      directives: [],
<span class="linenr">3961: </span>      hoists: [],
<span class="linenr">3962: </span>      imports: [],
<span class="linenr">3963: </span>      cached: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">3964: </span>      temps: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">3965: </span>      codegenNode: <span class=
"org-constant">undefined</span>,
<span class="linenr">3966: </span>      loc
<span class="linenr">3967: </span>    }
<span class="linenr">3968: </span>  }
<span class="linenr">3969: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createVNodeCall</span>(
<span class="linenr">3970: </span>    <span class=
"org-variable-name">context</span>,
<span class="linenr">3971: </span>    <span class=
"org-variable-name">tag</span>,
<span class="linenr">3972: </span>    <span class=
"org-variable-name">props</span>,
<span class="linenr">3973: </span>    <span class=
"org-variable-name">children</span>,
<span class="linenr">3974: </span>    <span class=
"org-variable-name">patchFlag</span>,
<span class="linenr">3975: </span>    <span class=
"org-variable-name">dynamicProps</span>,
<span class="linenr">3976: </span>    <span class=
"org-variable-name">directives</span>,
<span class="linenr">3977: </span>    isBlock = <span class=
"org-constant">false</span>,
<span class=
"linenr">3978: </span>    disableTracking = <span class="org-constant">false</span>,
<span class="linenr">3979: </span>    isComponent = <span class=
"org-constant">false</span>,
<span class="linenr">3980: </span>    loc = locStub
<span class="linenr">3981: </span>  ) {
<span class="linenr">3982: </span>    <span class=
"org-keyword">if</span> (context) {
<span class="linenr">3983: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">单个子节点用 block</span>
<span class="linenr">3984: </span>      <span class=
"org-keyword">if</span> (isBlock) {
<span class=
"linenr">3985: </span>        context.helper(OPEN_BLOCK)
<span class=
"linenr">3986: </span>        context.helper(getVNodeBlockHelper(context.inSSR, isComponent))
<span class="linenr">3987: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">3988: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">多个节节点用 fragment</span>
<span class=
"linenr">3989: </span>        context.helper(getVNodeHelper(context.inSSR, isComponent))
<span class="linenr">3990: </span>      }
<span class="linenr">3991: </span>      <span class=
"org-keyword">if</span> (directives) {
<span class=
"linenr">3992: </span>        context.helper(WITH_DIRECTIVES)
<span class="linenr">3993: </span>      }
<span class="linenr">3994: </span>    }
<span class="linenr">3995: </span>  
<span class="linenr">3996: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">3997: </span>      type: NodeTypes.VNODE_CALL,
<span class="linenr">3998: </span>      tag,
<span class="linenr">3999: </span>      props,
<span class="linenr">4000: </span>      children,
<span class="linenr">4001: </span>      patchFlag,
<span class="linenr">4002: </span>      dynamicProps,
<span class="linenr">4003: </span>      directives,
<span class="linenr">4004: </span>      isBlock,
<span class="linenr">4005: </span>      disableTracking,
<span class="linenr">4006: </span>      isComponent,
<span class="linenr">4007: </span>      loc
<span class="linenr">4008: </span>    }
<span class="linenr">4009: </span>  }
<span class="linenr">4010: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createArrayExpression</span>(<span class=
"org-variable-name">elements</span>, <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">locStub</span>) {
<span class="linenr">4011: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4012: </span>      type: NodeTypes.JS_ARRAY_EXPRESSION,
<span class="linenr">4013: </span>      loc,
<span class="linenr">4014: </span>      elements
<span class="linenr">4015: </span>    }
<span class="linenr">4016: </span>  }
<span class="linenr">4017: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createObjectExpression</span>(<span class=
"org-variable-name">properties</span>, <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">locStub</span>) {
<span class="linenr">4018: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4019: </span>      type: NodeTypes.JS_OBJECT_EXPRESSION,
<span class="linenr">4020: </span>      loc,
<span class="linenr">4021: </span>      properties
<span class="linenr">4022: </span>    }
<span class="linenr">4023: </span>  }
<span class="linenr">4024: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createObjectProperty</span>(<span class=
"org-variable-name">key</span>, <span class=
"org-variable-name">value</span>) {
<span class="linenr">4025: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4026: </span>      type: NodeTypes.JS_PROPERTY,
<span class="linenr">4027: </span>      loc: locStub,
<span class=
"linenr">4028: </span>      key: isString(key) ? createSimpleExpression(key, <span class="org-constant">true</span>) : key,
<span class="linenr">4029: </span>      value
<span class="linenr">4030: </span>    }
<span class="linenr">4031: </span>  }
<span class="linenr">4032: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createSimpleExpression</span>(
<span class="linenr">4033: </span>    <span class=
"org-variable-name">content</span>,
<span class="linenr">4034: </span>    isStatic = <span class=
"org-constant">false</span>,
<span class="linenr">4035: </span>    loc  = locStub,
<span class=
"linenr">4036: </span>    constType = ConstantTypes.NOT_CONSTANT
<span class="linenr">4037: </span>  ) {
<span class="linenr">4038: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4039: </span>      type: NodeTypes.SIMPLE_EXPRESSION,
<span class="linenr">4040: </span>      loc,
<span class="linenr">4041: </span>      content,
<span class="linenr">4042: </span>      isStatic,
<span class=
"linenr">4043: </span>      constType: isStatic ? ConstantTypes.CAN_STRINGIFY : constType
<span class="linenr">4044: </span>    }
<span class="linenr">4045: </span>  }
<span class="linenr">4046: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createInterpolation</span>(<span class=
"org-variable-name">content</span>, <span class=
"org-variable-name">loc</span>) {
<span class="linenr">4047: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4048: </span>      type: NodeTypes.INTERPOLATION,
<span class="linenr">4049: </span>      loc,
<span class="linenr">4050: </span>      content: isString(content)
<span class=
"linenr">4051: </span>        ? createSimpleExpression(content, <span class="org-constant">false</span>, loc)
<span class="linenr">4052: </span>        : content
<span class="linenr">4053: </span>    }
<span class="linenr">4054: </span>  }
<span class="linenr">4055: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createCompoundExpression</span>(<span class=
"org-variable-name">children</span>, <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">locStub</span>) {
<span class="linenr">4056: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4057: </span>      type: NodeTypes.COMPOUND_EXPRESSION,
<span class="linenr">4058: </span>      loc,
<span class="linenr">4059: </span>      children
<span class="linenr">4060: </span>    }
<span class="linenr">4061: </span>  }
<span class="linenr">4062: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createCallExpression</span>(<span class=
"org-variable-name">callee</span>, <span class=
"org-variable-name">args</span> = [], <span class=
"org-variable-name">loc</span> = <span class=
"org-variable-name">locStub</span>) {
<span class="linenr">4063: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4064: </span>      type: NodeTypes.JS_CALL_EXPRESSION,
<span class="linenr">4065: </span>      loc,
<span class="linenr">4066: </span>      callee,
<span class="linenr">4067: </span>      <span class=
"org-constant">arguments</span>: args
<span class="linenr">4068: </span>    }
<span class="linenr">4069: </span>  }
<span class="linenr">4070: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createFunctionExpression</span>(
<span class="linenr">4071: </span>    <span class=
"org-variable-name">params</span>,
<span class="linenr">4072: </span>    returns = <span class=
"org-constant">undefined</span>,
<span class="linenr">4073: </span>    newline = <span class=
"org-constant">false</span>,
<span class="linenr">4074: </span>    isSlot = <span class=
"org-constant">false</span>,
<span class="linenr">4075: </span>    loc = locStub
<span class="linenr">4076: </span>  ) {
<span class="linenr">4077: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4078: </span>      type: NodeTypes.JS_FUNCTION_EXPRESSION,
<span class="linenr">4079: </span>      params,
<span class="linenr">4080: </span>      returns,
<span class="linenr">4081: </span>      newline,
<span class="linenr">4082: </span>      isSlot,
<span class="linenr">4083: </span>      loc
<span class="linenr">4084: </span>    }
<span class="linenr">4085: </span>  }
<span class="linenr">4086: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createConditionalExpression</span>(
<span class="linenr">4087: </span>    <span class=
"org-variable-name">test</span>,
<span class="linenr">4088: </span>    <span class=
"org-variable-name">consequent</span>,
<span class="linenr">4089: </span>    <span class=
"org-variable-name">alternate</span>,
<span class="linenr">4090: </span>    newline = <span class=
"org-constant">true</span>
<span class="linenr">4091: </span>  ) {
<span class="linenr">4092: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4093: </span>      type: NodeTypes.JS_CONDITIONAL_EXPRESSION,
<span class="linenr">4094: </span>      test,
<span class="linenr">4095: </span>      consequent,
<span class="linenr">4096: </span>      alternate,
<span class="linenr">4097: </span>      newline,
<span class="linenr">4098: </span>      loc: locStub
<span class="linenr">4099: </span>    }
<span class="linenr">4100: </span>  }
<span class="linenr">4101: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createCacheExpression</span>(
<span class="linenr">4102: </span>    <span class=
"org-variable-name">index</span>,
<span class="linenr">4103: </span>    <span class=
"org-variable-name">value</span>,
<span class="linenr">4104: </span>    isVNode = <span class=
"org-constant">false</span>
<span class="linenr">4105: </span>  ) {
<span class="linenr">4106: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4107: </span>      type: NodeTypes.JS_CACHE_EXPRESSION,
<span class="linenr">4108: </span>      index,
<span class="linenr">4109: </span>      value,
<span class="linenr">4110: </span>      isVNode,
<span class="linenr">4111: </span>      loc: locStub
<span class="linenr">4112: </span>    }
<span class="linenr">4113: </span>  }
<span class="linenr">4114: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createBlockStatement</span>(<span class=
"org-variable-name">body</span>) {
<span class="linenr">4115: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4116: </span>      type: NodeTypes.JS_BLOCK_STATEMENT,
<span class="linenr">4117: </span>      body,
<span class="linenr">4118: </span>      loc: locStub
<span class="linenr">4119: </span>    }
<span class="linenr">4120: </span>  }
<span class="linenr">4121: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createTemplateLiteral</span>(<span class=
"org-variable-name">elements</span>) {
<span class="linenr">4122: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4123: </span>      type: NodeTypes.JS_TEMPLATE_LITERAL,
<span class="linenr">4124: </span>      elements,
<span class="linenr">4125: </span>      loc: locStub
<span class="linenr">4126: </span>    }
<span class="linenr">4127: </span>  }
<span class="linenr">4128: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createIfStatement</span>(<span class=
"org-variable-name">test</span>, <span class=
"org-variable-name">consequent</span>, <span class=
"org-variable-name">alternate</span>) {
<span class="linenr">4129: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4130: </span>      type: NodeTypes.JS_IF_STATEMENT,
<span class="linenr">4131: </span>      test,
<span class="linenr">4132: </span>      consequent,
<span class="linenr">4133: </span>      alternate,
<span class="linenr">4134: </span>      loc: locStub
<span class="linenr">4135: </span>    }
<span class="linenr">4136: </span>  }
<span class="linenr">4137: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createAssignmentExpression</span>(<span class=
"org-variable-name">left</span>, <span class=
"org-variable-name">right</span>) {
<span class="linenr">4138: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4139: </span>      type: NodeTypes.JS_ASSIGNMENT_EXPRESSION,
<span class="linenr">4140: </span>      left,
<span class="linenr">4141: </span>      right,
<span class="linenr">4142: </span>      loc: locStub
<span class="linenr">4143: </span>    }
<span class="linenr">4144: </span>  }
<span class="linenr">4145: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createSequenceExpression</span>(<span class=
"org-variable-name">expressions</span>) {
<span class="linenr">4146: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4147: </span>      type: NodeTypes.JS_SEQUENCE_EXPRESSION,
<span class="linenr">4148: </span>      expressions,
<span class="linenr">4149: </span>      loc: locStub
<span class="linenr">4150: </span>    }
<span class="linenr">4151: </span>  }
<span class="linenr">4152: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createReturnStatement</span>(<span class=
"org-variable-name">returns</span>) {
<span class="linenr">4153: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">4154: </span>      type: NodeTypes.JS_RETURN_STATEMENT,
<span class="linenr">4155: </span>      returns,
<span class="linenr">4156: </span>      loc: locStub
<span class="linenr">4157: </span>    }
<span class="linenr">4158: </span>  }
<span class="linenr">4159: </span>  
<span class="linenr">4160: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">transform</span>(<span class=
"org-variable-name">root</span>, <span class=
"org-variable-name">options</span>) {
<span class="linenr">4161: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">transform 上下文</span>
<span class="linenr">4162: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = createTransformContext(root, options)
<span class="linenr">4163: </span>  
<span class="linenr">4164: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">递归遍历整个 ast root 树，最终为每颗子树生成 codegenNode</span>
<span class="linenr">4165: </span>    traverseNode(root, context)
<span class="linenr">4166: </span>  
<span class="linenr">4167: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">静态提升处理</span>
<span class="linenr">4168: </span>    <span class=
"org-keyword">if</span> (options.hoistStatic) {
<span class="linenr">4169: </span>      hoistStatic(root, context)
<span class="linenr">4170: </span>    }
<span class="linenr">4171: </span>  
<span class="linenr">4172: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">创建 root codegenNode 代码</span>
<span class="linenr">4173: </span>    <span class=
"org-keyword">if</span> (!options.ssr) {
<span class=
"linenr">4174: </span>      createRootCodegen(root, context)
<span class="linenr">4175: </span>    }
<span class="linenr">4176: </span>  
<span class="linenr">4177: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">finalize meta information</span>
<span class=
"linenr">4178: </span>    root.helpers = [...context.helpers.keys()]
<span class=
"linenr">4179: </span>    root.components = [...context.components]
<span class=
"linenr">4180: </span>    root.directives = [...context.directives]
<span class=
"linenr">4181: </span>    root.imports = context.imports
<span class="linenr">4182: </span>    root.hoists = context.hoists
<span class="linenr">4183: </span>    root.temps = context.temps
<span class="linenr">4184: </span>    root.cached = context.cached
<span class="linenr">4185: </span>  }
<span class="linenr">4186: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">getBaseTransformPreset</span>(<span class=
"org-variable-name">prefixIdentifiers</span>) {
<span class="linenr">4187: </span>    <span class=
"org-keyword">return</span> [
<span class="linenr">4188: </span>      [
<span class="linenr">4189: </span>        transformOnce,
<span class="linenr">4190: </span>        transformIf,
<span class="linenr">4191: </span>        transformMemo,
<span class="linenr">4192: </span>        transformFor,
<span class=
"linenr">4193: </span>        ...(!__BROWSER__ &amp;& prefixIdentifiers
<span class="linenr">4194: </span>          ? [
<span class="linenr">4195: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">order is important</span>
<span class=
"linenr">4196: </span>              trackVForSlotScopes,
<span class="linenr">4197: </span>              transformExpression
<span class="linenr">4198: </span>            ]
<span class=
"linenr">4199: </span>          : __BROWSER__ &amp;& __DEV__
<span class="linenr">4200: </span>          ? [transformExpression]
<span class="linenr">4201: </span>          : []),
<span class="linenr">4202: </span>        transformSlotOutlet,
<span class="linenr">4203: </span>        transformElement,
<span class="linenr">4204: </span>        trackSlotScopes,
<span class="linenr">4205: </span>        transformText
<span class="linenr">4206: </span>      ],
<span class="linenr">4207: </span>      {
<span class="linenr">4208: </span>        on: transformOn,
<span class="linenr">4209: </span>        bind: transformBind,
<span class="linenr">4210: </span>        model: transformModel
<span class="linenr">4211: </span>      }
<span class="linenr">4212: </span>    ]
<span class="linenr">4213: </span>  }
<span class="linenr">4214: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">createCodegenContext</span>(
<span class="linenr">4215: </span>    <span class=
"org-variable-name">ast</span>,
<span class="linenr">4216: </span>    {
<span class="linenr">4217: </span>      mode = <span class=
"org-string">'function'</span>,
<span class=
"linenr">4218: </span>      prefixIdentifiers = mode === <span class="org-string">'module'</span>,
<span class="linenr">4219: </span>      sourceMap = <span class=
"org-constant">false</span>,
<span class="linenr">4220: </span>      filename = <span class=
"org-string">`template.vue.html`</span>,
<span class="linenr">4221: </span>      scopeId = <span class=
"org-constant">null</span>,
<span class=
"linenr">4222: </span>      optimizeImports = <span class=
"org-constant">false</span>,
<span class=
"linenr">4223: </span>      runtimeGlobalName = <span class=
"org-string">`Vue`</span>,
<span class=
"linenr">4224: </span>      runtimeModuleName = <span class=
"org-string">`vue`</span>,
<span class=
"linenr">4225: </span>      ssrRuntimeModuleName = <span class=
"org-string">'vue/server-renderer'</span>,
<span class="linenr">4226: </span>      ssr = <span class=
"org-constant">false</span>,
<span class="linenr">4227: </span>      isTS = <span class=
"org-constant">false</span>,
<span class="linenr">4228: </span>      inSSR = <span class=
"org-constant">false</span>
<span class="linenr">4229: </span>    }
<span class="linenr">4230: </span>  ) {
<span class="linenr">4231: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = {
<span class="linenr">4232: </span>      mode,
<span class="linenr">4233: </span>      prefixIdentifiers,
<span class="linenr">4234: </span>      sourceMap,
<span class="linenr">4235: </span>      filename,
<span class="linenr">4236: </span>      scopeId,
<span class="linenr">4237: </span>      optimizeImports,
<span class="linenr">4238: </span>      runtimeGlobalName,
<span class="linenr">4239: </span>      runtimeModuleName,
<span class="linenr">4240: </span>      ssrRuntimeModuleName,
<span class="linenr">4241: </span>      ssr,
<span class="linenr">4242: </span>      isTS,
<span class="linenr">4243: </span>      inSSR,
<span class="linenr">4244: </span>      source: ast.loc.source,
<span class="linenr">4245: </span>      code: <span class=
"org-string">``</span>,
<span class="linenr">4246: </span>      column: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">4247: </span>      line: <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">4248: </span>      offset: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">4249: </span>      indentLevel: <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">4250: </span>      pure: <span class=
"org-constant">false</span>,
<span class="linenr">4251: </span>      map: <span class=
"org-constant">undefined</span>,
<span class="linenr">4252: </span>      helper(key) {
<span class="linenr">4253: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`_${helperNameMap[key]}`</span>
<span class="linenr">4254: </span>      },
<span class="linenr">4255: </span>      push(code, node) {
<span class="linenr">4256: </span>        context.code += code
<span class="linenr">4257: </span>        <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& context.map) {
<span class="linenr">4258: </span>          <span class=
"org-keyword">if</span> (node) {
<span class="linenr">4259: </span>            <span class=
"org-keyword">let</span> <span class=
"org-variable-name">name</span>
<span class="linenr">4260: </span>            <span class=
"org-keyword">if</span> (node.type === NodeTypes.SIMPLE_EXPRESSION &amp;& !node.isStatic) {
<span class="linenr">4261: </span>              <span class=
"org-keyword">const</span> <span class=
"org-variable-name">content</span> = node.content.replace(<span class="org-string">/^_ctx\./</span>, <span class="org-string">''</span>)
<span class="linenr">4262: </span>              <span class=
"org-keyword">if</span> (content !== node.content &amp;& isSimpleIdentifier(content)) {
<span class="linenr">4263: </span>                name = content
<span class="linenr">4264: </span>              }
<span class="linenr">4265: </span>            }
<span class=
"linenr">4266: </span>            addMapping(node.loc.start, name)
<span class="linenr">4267: </span>          }
<span class=
"linenr">4268: </span>          advancePositionWithMutation(context, code)
<span class="linenr">4269: </span>          <span class=
"org-keyword">if</span> (node &amp;& node.loc !== locStub) {
<span class=
"linenr">4270: </span>            addMapping(node.loc.end)
<span class="linenr">4271: </span>          }
<span class="linenr">4272: </span>        }
<span class="linenr">4273: </span>      },
<span class="linenr">4274: </span>      indent() {
<span class=
"linenr">4275: </span>        newline(++context.indentLevel)
<span class="linenr">4276: </span>      },
<span class=
"linenr">4277: </span>      deindent(withoutNewLine = <span class=
"org-constant">false</span>) {
<span class="linenr">4278: </span>        <span class=
"org-keyword">if</span> (withoutNewLine) {
<span class="linenr">4279: </span>          --context.indentLevel
<span class="linenr">4280: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">4281: </span>          newline(--context.indentLevel)
<span class="linenr">4282: </span>        }
<span class="linenr">4283: </span>      },
<span class="linenr">4284: </span>      newline() {
<span class=
"linenr">4285: </span>        newline(context.indentLevel)
<span class="linenr">4286: </span>      }
<span class="linenr">4287: </span>    }
<span class="linenr">4288: </span>  
<span class="linenr">4289: </span>    <span class=
"org-keyword">function</span> <span class=
"org-function-name">newline</span>(<span class=
"org-variable-name">n</span>) {
<span class="linenr">4290: </span>      context.push(<span class=
"org-string">'\n'</span> + <span class=
"org-string">`  `</span>.repeat(n))
<span class="linenr">4291: </span>    }
<span class="linenr">4292: </span>  
<span class="linenr">4293: </span>    <span class=
"org-keyword">function</span> <span class=
"org-function-name">addMapping</span>(<span class=
"org-variable-name">loc</span>, <span class=
"org-variable-name">name</span>) {
<span class="linenr">4294: </span>      context.map.addMapping({
<span class="linenr">4295: </span>        name,
<span class="linenr">4296: </span>        source: context.filename,
<span class="linenr">4297: </span>        original: {
<span class="linenr">4298: </span>          line: loc.line,
<span class=
"linenr">4299: </span>          column: loc.column - <span class=
"org-highlight-numbers-number">1</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">source-map column is 0 based</span>
<span class="linenr">4300: </span>        },
<span class="linenr">4301: </span>        generated: {
<span class="linenr">4302: </span>          line: context.line,
<span class=
"linenr">4303: </span>          column: context.column - <span class="org-highlight-numbers-number">1</span>
<span class="linenr">4304: </span>        }
<span class="linenr">4305: </span>      })
<span class="linenr">4306: </span>    }
<span class="linenr">4307: </span>  
<span class="linenr">4308: </span>    <span class=
"org-keyword">return</span> context
<span class="linenr">4309: </span>  }
<span class="linenr">4310: </span>  
<span class="linenr">4311: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genModulePreamble</span>(<span class=
"org-variable-name">ast</span>, <span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">genScopeId</span>, <span class=
"org-variable-name">inline</span>) {
<span class="linenr">4312: </span>    <span class=
"org-keyword">const</span> {
<span class="linenr">4313: </span>      push,
<span class="linenr">4314: </span>      newline,
<span class="linenr">4315: </span>      optimizeImports,
<span class="linenr">4316: </span>      runtimeModuleName,
<span class="linenr">4317: </span>      ssrRuntimeModuleName
<span class="linenr">4318: </span>    } = context
<span class="linenr">4319: </span>  
<span class="linenr">4320: </span>    <span class=
"org-keyword">if</span> (genScopeId &amp;& ast.hoists.length) {
<span class=
"linenr">4321: </span>      ast.helpers.push(PUSH_SCOPE_ID, POP_SCOPE_ID)
<span class="linenr">4322: </span>    }
<span class="linenr">4323: </span>  
<span class="linenr">4324: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generate import statements for helpers</span>
<span class="linenr">4325: </span>    <span class=
"org-keyword">if</span> (ast.helpers.length) {
<span class="linenr">4326: </span>      <span class=
"org-keyword">if</span> (optimizeImports) {
<span class="linenr">4327: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">when bundled with webpack with code-split, calling an import binding</span>
<span class="linenr">4328: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">as a function leads to it being wrapped with `Object(a.b)` or `(0,a.b)`,</span>
<span class="linenr">4329: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">incurring both payload size increase and potential perf overhead.</span>
<span class="linenr">4330: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">therefore we assign the imports to variables (which is a constant ~50b</span>
<span class="linenr">4331: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">cost per-component instead of scaling with template size)</span>
<span class="linenr">4332: </span>        push(
<span class="linenr">4333: </span>          <span class=
"org-string">`import { ${ast.helpers</span>
<span class="linenr">4334: </span><span class=
"org-string">            .map(s =&gt; helperNameMap[s])</span>
<span class="linenr">4335: </span><span class=
"org-string">            .join(', ')} } from ${JSON.stringify(runtimeModuleName)}\n`</span>
<span class="linenr">4336: </span>        )
<span class="linenr">4337: </span>        push(
<span class="linenr">4338: </span>          <span class=
"org-string">`\n// Binding optimization for webpack code-split\nconst ${ast.helpers</span>
<span class="linenr">4339: </span><span class=
"org-string">            .map(s =&gt; `</span>_${helperNameMap[s]} = ${helperNameMap[s]}<span class="org-string">`)</span>
<span class="linenr">4340: </span><span class=
"org-string">            .join(', ')}\n`</span>
<span class="linenr">4341: </span>        )
<span class="linenr">4342: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">4343: </span>        push(
<span class="linenr">4344: </span>          <span class=
"org-string">`import { ${ast.helpers</span>
<span class="linenr">4345: </span><span class=
"org-string">            .map(s =&gt; `</span>${helperNameMap[s]} as _${helperNameMap[s]}<span class="org-string">`)</span>
<span class="linenr">4346: </span><span class=
"org-string">            .join(', ')} } from ${JSON.stringify(runtimeModuleName)}\n`</span>
<span class="linenr">4347: </span>        )
<span class="linenr">4348: </span>      }
<span class="linenr">4349: </span>    }
<span class="linenr">4350: </span>  
<span class="linenr">4351: </span>    <span class=
"org-keyword">if</span> (ast.ssrHelpers &amp;& ast.ssrHelpers.length) {
<span class="linenr">4352: </span>      push(
<span class="linenr">4353: </span>        <span class=
"org-string">`import { ${ast.ssrHelpers</span>
<span class="linenr">4354: </span><span class=
"org-string">          .map(s =&gt; `</span>${helperNameMap[s]} as _${helperNameMap[s]}<span class="org-string">`)</span>
<span class="linenr">4355: </span><span class=
"org-string">          .join(', ')} } from "${ssrRuntimeModuleName}"\n`</span>
<span class="linenr">4356: </span>      )
<span class="linenr">4357: </span>    }
<span class="linenr">4358: </span>  
<span class="linenr">4359: </span>    <span class=
"org-keyword">if</span> (ast.imports.length) {
<span class=
"linenr">4360: </span>      genImports(ast.imports, context)
<span class="linenr">4361: </span>      newline()
<span class="linenr">4362: </span>    }
<span class="linenr">4363: </span>  
<span class=
"linenr">4364: </span>    genHoists(ast.hoists, context)
<span class="linenr">4365: </span>    newline()
<span class="linenr">4366: </span>  
<span class="linenr">4367: </span>    <span class=
"org-keyword">if</span> (!inline) {
<span class="linenr">4368: </span>      push(<span class=
"org-string">`export `</span>)
<span class="linenr">4369: </span>    }
<span class="linenr">4370: </span>  }
<span class="linenr">4371: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genImports</span>(<span class=
"org-variable-name">importsOptions</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4372: </span>    <span class=
"org-keyword">if</span> (!importsOptions.length) {
<span class="linenr">4373: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">4374: </span>    }
<span class=
"linenr">4375: </span>    importsOptions.forEach(imports =&gt; {
<span class="linenr">4376: </span>      context.push(<span class=
"org-string">`import `</span>)
<span class=
"linenr">4377: </span>      genNode(imports.exp, context)
<span class="linenr">4378: </span>      context.push(<span class=
"org-string">` from '${imports.path}'`</span>)
<span class="linenr">4379: </span>      context.newline()
<span class="linenr">4380: </span>    })
<span class="linenr">4381: </span>  }
<span class="linenr">4382: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genFunctionPreamble</span>(<span class=
"org-variable-name">ast</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4383: </span>    <span class=
"org-keyword">const</span> {
<span class="linenr">4384: </span>      ssr,
<span class="linenr">4385: </span>      prefixIdentifiers,
<span class="linenr">4386: </span>      push,
<span class="linenr">4387: </span>      newline,
<span class="linenr">4388: </span>      runtimeModuleName,
<span class="linenr">4389: </span>      runtimeGlobalName,
<span class="linenr">4390: </span>      ssrRuntimeModuleName
<span class="linenr">4391: </span>    } = context
<span class="linenr">4392: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">VueBinding</span> =
<span class="linenr">4393: </span>      !__BROWSER__ &amp;& ssr
<span class="linenr">4394: </span>        ? <span class=
"org-string">`require(${JSON.stringify(runtimeModuleName)})`</span>
<span class="linenr">4395: </span>        : runtimeGlobalName
<span class="linenr">4396: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">aliasHelper</span> = (s) =&gt; <span class=
"org-string">`${helperNameMap[s]}: _${helperNameMap[s]}`</span>
<span class="linenr">4397: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Generate const declaration for helpers</span>
<span class="linenr">4398: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">In prefix mode, we place the const declaration at top so it's done</span>
<span class="linenr">4399: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">only once; But if we not prefixing, we place the declaration inside the</span>
<span class="linenr">4400: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">with block so it doesn't incur the `in` check cost for every helper access.</span>
<span class="linenr">4401: </span>    <span class=
"org-keyword">if</span> (ast.helpers.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">4402: </span>      <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& prefixIdentifiers) {
<span class="linenr">4403: </span>        push(
<span class="linenr">4404: </span>          <span class=
"org-string">`const { ${ast.helpers.map(aliasHelper).join(', ')} } = ${VueBinding}\n`</span>
<span class="linenr">4405: </span>        )
<span class="linenr">4406: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">4407: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">"with" mode.</span>
<span class="linenr">4408: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">save Vue in a separate variable to avoid collision</span>
<span class="linenr">4409: </span>        push(<span class=
"org-string">`const _Vue = ${VueBinding}\n`</span>)
<span class="linenr">4410: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in "with" mode, helpers are declared inside the with block to avoid</span>
<span class="linenr">4411: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">has check cost, but hoists are lifted out of the function - we need</span>
<span class="linenr">4412: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">to provide the helper here.</span>
<span class="linenr">4413: </span>        <span class=
"org-keyword">if</span> (ast.hoists.length) {
<span class="linenr">4414: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">staticHelpers</span> = [
<span class="linenr">4415: </span>            CREATE_VNODE,
<span class="linenr">4416: </span>            CREATE_ELEMENT_VNODE,
<span class="linenr">4417: </span>            CREATE_COMMENT,
<span class="linenr">4418: </span>            CREATE_TEXT,
<span class="linenr">4419: </span>            CREATE_STATIC
<span class="linenr">4420: </span>          ]
<span class=
"linenr">4421: </span>            .filter(helper =&gt; ast.helpers.includes(helper))
<span class="linenr">4422: </span>            .map(aliasHelper)
<span class="linenr">4423: </span>            .join(<span class=
"org-string">', '</span>)
<span class="linenr">4424: </span>          push(<span class=
"org-string">`const { ${staticHelpers} } = _Vue\n`</span>)
<span class="linenr">4425: </span>        }
<span class="linenr">4426: </span>      }
<span class="linenr">4427: </span>    }
<span class="linenr">4428: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generate variables for ssr helpers</span>
<span class="linenr">4429: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& ast.ssrHelpers &amp;& ast.ssrHelpers.length) {
<span class="linenr">4430: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ssr guarantees prefixIdentifier: true</span>
<span class="linenr">4431: </span>      push(
<span class="linenr">4432: </span>        <span class=
"org-string">`const { ${ast.ssrHelpers</span>
<span class="linenr">4433: </span><span class=
"org-string">          .map(aliasHelper)</span>
<span class="linenr">4434: </span><span class=
"org-string">          .join(', ')} } = require("${ssrRuntimeModuleName}")\n`</span>
<span class="linenr">4435: </span>      )
<span class="linenr">4436: </span>    }
<span class=
"linenr">4437: </span>    genHoists(ast.hoists, context)
<span class="linenr">4438: </span>    newline()
<span class="linenr">4439: </span>    push(<span class=
"org-string">`return `</span>)
<span class="linenr">4440: </span>  }
<span class="linenr">4441: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genHoists</span>(<span class=
"org-variable-name">hoists</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4442: </span>    <span class=
"org-keyword">if</span> (!hoists.length) {
<span class="linenr">4443: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">4444: </span>    }
<span class="linenr">4445: </span>    context.pure = <span class=
"org-constant">true</span>
<span class="linenr">4446: </span>    <span class=
"org-keyword">const</span> { push, newline, helper, scopeId, mode } = context
<span class="linenr">4447: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">genScopeId</span> = !__BROWSER__ &amp;& scopeId != <span class="org-constant">null</span> &amp;& mode !== <span class="org-string">'function'</span>
<span class="linenr">4448: </span>    newline()
<span class="linenr">4449: </span>  
<span class="linenr">4450: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generate inlined withScopeId helper</span>
<span class="linenr">4451: </span>    <span class=
"org-keyword">if</span> (genScopeId) {
<span class="linenr">4452: </span>      push(
<span class="linenr">4453: </span>        <span class=
"org-string">`const _withScopeId = n =&gt; (${helper(</span>
<span class="linenr">4454: </span><span class=
"org-string">          PUSH_SCOPE_ID</span>
<span class="linenr">4455: </span><span class=
"org-string">        )}("${scopeId}"),n=n(),${helper(POP_SCOPE_ID)}(),n)`</span>
<span class="linenr">4456: </span>      )
<span class="linenr">4457: </span>      newline()
<span class="linenr">4458: </span>    }
<span class="linenr">4459: </span>  
<span class="linenr">4460: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; hoists.length; i++) {
<span class="linenr">4461: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> = hoists[i]
<span class="linenr">4462: </span>      <span class=
"org-keyword">if</span> (exp) {
<span class="linenr">4463: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needScopeIdWrapper</span> = genScopeId &amp;& exp.type === NodeTypes.VNODE_CALL
<span class="linenr">4464: </span>        push(
<span class="linenr">4465: </span>          <span class=
"org-string">`const _hoisted_${i + 1} = ${</span>
<span class="linenr">4466: </span><span class=
"org-string">            needScopeIdWrapper ? `</span>${PURE_ANNOTATION} _withScopeId(() =&gt; <span class="org-string">` : ``</span>
<span class="linenr">4467: </span><span class=
"org-string">          }`</span>
<span class="linenr">4468: </span>        )
<span class="linenr">4469: </span>        genNode(exp, context)
<span class="linenr">4470: </span>        <span class=
"org-keyword">if</span> (needScopeIdWrapper) {
<span class="linenr">4471: </span>          push(<span class=
"org-string">`)`</span>)
<span class="linenr">4472: </span>        }
<span class="linenr">4473: </span>        newline()
<span class="linenr">4474: </span>      }
<span class="linenr">4475: </span>    }
<span class="linenr">4476: </span>  
<span class="linenr">4477: </span>    context.pure = <span class=
"org-constant">false</span>
<span class="linenr">4478: </span>  }
<span class="linenr">4479: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">type = 'component' | 'directive' | 'filter'</span>
<span class="linenr">4480: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genAssets</span>(<span class=
"org-variable-name">assets</span>, <span class=
"org-variable-name">type</span>, { <span class=
"org-variable-name">helper</span>, <span class=
"org-variable-name">push</span>, <span class=
"org-variable-name">newline</span>, <span class=
"org-variable-name">isTS</span> }) {
<span class="linenr">4481: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">resolver</span> = helper(
<span class="linenr">4482: </span>      type === <span class=
"org-string">'component'</span>
<span class="linenr">4483: </span>        ? RESOLVE_COMPONENT
<span class="linenr">4484: </span>        : RESOLVE_DIRECTIVE
<span class="linenr">4485: </span>    )
<span class="linenr">4486: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; assets.length; i++) {
<span class="linenr">4487: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">id</span> = assets[i]
<span class="linenr">4488: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">potential component implicit self-reference inferred from SFC filename</span>
<span class="linenr">4489: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">maybeSelfReference</span> = id.endsWith(<span class="org-string">'__self'</span>)
<span class="linenr">4490: </span>      <span class=
"org-keyword">if</span> (maybeSelfReference) {
<span class=
"linenr">4491: </span>        id = id.slice(<span class="org-highlight-numbers-number">0</span>, -<span class="org-highlight-numbers-number">6</span>)
<span class="linenr">4492: </span>      }
<span class="linenr">4493: </span>      push(
<span class="linenr">4494: </span>        <span class=
"org-string">`const ${toValidAssetId(id, type)} = ${resolver}(${JSON.stringify(id)}${</span>
<span class="linenr">4495: </span><span class=
"org-string">          maybeSelfReference ? `</span>, <span class=
"org-constant">true</span><span class="org-string">` : ``</span>
<span class="linenr">4496: </span><span class=
"org-string">        })${isTS ? `</span>!<span class=
"org-string">` : ``}`</span>
<span class="linenr">4497: </span>      )
<span class="linenr">4498: </span>      <span class=
"org-keyword">if</span> (i &lt; assets.length - <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">4499: </span>        newline()
<span class="linenr">4500: </span>      }
<span class="linenr">4501: </span>    }
<span class="linenr">4502: </span>  }
<span class="linenr">4503: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genText</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class=
"linenr">4504: </span>    context.push(JSON.stringify(node.content), node)
<span class="linenr">4505: </span>  }
<span class="linenr">4506: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4507: </span>    <span class=
"org-keyword">const</span> { content, isStatic } = node
<span class=
"linenr">4508: </span>    context.push(isStatic ? JSON.stringify(content) : content, node)
<span class="linenr">4509: </span>  }
<span class="linenr">4510: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genInterpolation</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4511: </span>    <span class=
"org-keyword">const</span> { push, helper, pure } = context
<span class="linenr">4512: </span>    <span class=
"org-keyword">if</span> (pure) push(PURE_ANNOTATION)
<span class="linenr">4513: </span>    push(<span class=
"org-string">`${helper(TO_DISPLAY_STRING)}(`</span>)
<span class=
"linenr">4514: </span>    genNode(node.content, context)
<span class="linenr">4515: </span>    push(<span class=
"org-string">`)`</span>)
<span class="linenr">4516: </span>  }
<span class="linenr">4517: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genCompoundExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4518: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class="linenr">4519: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = node.children[i]
<span class="linenr">4520: </span>      <span class=
"org-keyword">if</span> (isString(child)) {
<span class="linenr">4521: </span>        context.push(child)
<span class="linenr">4522: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">4523: </span>        genNode(child, context)
<span class="linenr">4524: </span>      }
<span class="linenr">4525: </span>    }
<span class="linenr">4526: </span>  }
<span class="linenr">4527: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genComment</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4528: </span>    <span class=
"org-keyword">const</span> { push, helper, pure } = context
<span class="linenr">4529: </span>    <span class=
"org-keyword">if</span> (pure) {
<span class="linenr">4530: </span>      push(PURE_ANNOTATION)
<span class="linenr">4531: </span>    }
<span class="linenr">4532: </span>    push(<span class=
"org-string">`${helper(CREATE_COMMENT)}(${JSON.stringify(node.content)})`</span>, node)
<span class="linenr">4533: </span>  }
<span class="linenr">4534: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genVNodeCall</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4535: </span>    <span class=
"org-keyword">const</span> { push, helper, pure } = context
<span class="linenr">4536: </span>    <span class=
"org-keyword">const</span> {
<span class="linenr">4537: </span>      tag,
<span class="linenr">4538: </span>      props,
<span class="linenr">4539: </span>      children,
<span class="linenr">4540: </span>      patchFlag,
<span class="linenr">4541: </span>      dynamicProps,
<span class="linenr">4542: </span>      directives,
<span class="linenr">4543: </span>      isBlock,
<span class="linenr">4544: </span>      disableTracking,
<span class="linenr">4545: </span>      isComponent
<span class="linenr">4546: </span>    } = node
<span class="linenr">4547: </span>    <span class=
"org-keyword">if</span> (directives) {
<span class=
"linenr">4548: </span>      push(helper(WITH_DIRECTIVES) + <span class="org-string">`(`</span>)
<span class="linenr">4549: </span>    }
<span class="linenr">4550: </span>    <span class=
"org-keyword">if</span> (isBlock) {
<span class="linenr">4551: </span>      push(<span class=
"org-string">`(${helper(OPEN_BLOCK)}(${disableTracking ? `</span><span class="org-constant">true</span><span class="org-string">` : ``}), `</span>)
<span class="linenr">4552: </span>    }
<span class="linenr">4553: </span>    <span class=
"org-keyword">if</span> (pure) {
<span class="linenr">4554: </span>      push(PURE_ANNOTATION)
<span class="linenr">4555: </span>    }
<span class="linenr">4556: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">callHelper</span> = isBlock
<span class=
"linenr">4557: </span>      ? getVNodeBlockHelper(context.inSSR, isComponent)
<span class=
"linenr">4558: </span>      : getVNodeHelper(context.inSSR, isComponent)
<span class=
"linenr">4559: </span>    push(helper(callHelper) + <span class=
"org-string">`(`</span>, node)
<span class="linenr">4560: </span>    genNodeList(
<span class=
"linenr">4561: </span>      genNullableArgs([tag, props, children, patchFlag, dynamicProps]),
<span class="linenr">4562: </span>      context
<span class="linenr">4563: </span>    )
<span class="linenr">4564: </span>    push(<span class=
"org-string">`)`</span>)
<span class="linenr">4565: </span>    <span class=
"org-keyword">if</span> (isBlock) {
<span class="linenr">4566: </span>      push(<span class=
"org-string">`)`</span>)
<span class="linenr">4567: </span>    }
<span class="linenr">4568: </span>    <span class=
"org-keyword">if</span> (directives) {
<span class="linenr">4569: </span>      push(<span class=
"org-string">`, `</span>)
<span class=
"linenr">4570: </span>      genNode(directives, context)
<span class="linenr">4571: </span>      push(<span class=
"org-string">`)`</span>)
<span class="linenr">4572: </span>    }
<span class="linenr">4573: </span>  }
<span class="linenr">4574: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">JavaScript</span>
<span class="linenr">4575: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genCallExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4576: </span>    <span class=
"org-keyword">const</span> { push, helper, pure } = context
<span class="linenr">4577: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">callee</span> = isString(node.callee) ? node.callee : helper(node.callee)
<span class="linenr">4578: </span>    <span class=
"org-keyword">if</span> (pure) {
<span class="linenr">4579: </span>      push(PURE_ANNOTATION)
<span class="linenr">4580: </span>    }
<span class="linenr">4581: </span>    push(callee + <span class=
"org-string">`(`</span>, node)
<span class="linenr">4582: </span>    genNodeList(node.<span class=
"org-constant">arguments</span>, context)
<span class="linenr">4583: </span>    push(<span class=
"org-string">`)`</span>)
<span class="linenr">4584: </span>  }
<span class="linenr">4585: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genObjectExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4586: </span>    <span class=
"org-keyword">const</span> { push, indent, deindent, newline } = context
<span class="linenr">4587: </span>    <span class=
"org-keyword">const</span> { properties } = node
<span class="linenr">4588: </span>    <span class=
"org-keyword">if</span> (!properties.length) {
<span class="linenr">4589: </span>      push(<span class=
"org-string">`{}`</span>, node)
<span class="linenr">4590: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">4591: </span>    }
<span class="linenr">4592: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">multilines</span> =
<span class=
"linenr">4593: </span>      properties.length &gt; <span class=
"org-highlight-numbers-number">1</span> ||
<span class=
"linenr">4594: </span>      ((!__BROWSER__ || __DEV__) &amp;&
<span class=
"linenr">4595: </span>        properties.some(p =&gt; p.value.type !== NodeTypes.SIMPLE_EXPRESSION))
<span class=
"linenr">4596: </span>    push(multilines ? <span class="org-string">`{`</span> : <span class="org-string">`{ `</span>)
<span class="linenr">4597: </span>    multilines &amp;& indent()
<span class="linenr">4598: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; properties.length; i++) {
<span class="linenr">4599: </span>      <span class=
"org-keyword">const</span> { key, value } = properties[i]
<span class="linenr">4600: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">key</span>
<span class=
"linenr">4601: </span>      genExpressionAsPropertyKey(key, context)
<span class="linenr">4602: </span>      push(<span class=
"org-string">`: `</span>)
<span class="linenr">4603: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">value</span>
<span class="linenr">4604: </span>      genNode(value, context)
<span class="linenr">4605: </span>      <span class=
"org-keyword">if</span> (i &lt; properties.length - <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">4606: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">will only reach this if it's multilines</span>
<span class="linenr">4607: </span>        push(<span class=
"org-string">`,`</span>)
<span class="linenr">4608: </span>        newline()
<span class="linenr">4609: </span>      }
<span class="linenr">4610: </span>    }
<span class="linenr">4611: </span>    multilines &amp;& deindent()
<span class=
"linenr">4612: </span>    push(multilines ? <span class="org-string">`}`</span> : <span class="org-string">` }`</span>)
<span class="linenr">4613: </span>  }
<span class="linenr">4614: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genArrayExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class=
"linenr">4615: </span>    genNodeListAsArray(node.elements, context)
<span class="linenr">4616: </span>  }
<span class="linenr">4617: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genFunctionExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4618: </span>    <span class=
"org-keyword">const</span> { push, indent, deindent } = context
<span class="linenr">4619: </span>    <span class=
"org-keyword">const</span> { params, returns, body, newline, isSlot } = node
<span class="linenr">4620: </span>    <span class=
"org-keyword">if</span> (isSlot) {
<span class="linenr">4621: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">wrap slot functions with owner context</span>
<span class="linenr">4622: </span>      push(<span class=
"org-string">`_${helperNameMap[WITH_CTX]}(`</span>)
<span class="linenr">4623: </span>    }
<span class="linenr">4624: </span>    push(<span class=
"org-string">`(`</span>, node)
<span class="linenr">4625: </span>    <span class=
"org-keyword">if</span> (isArray(params)) {
<span class=
"linenr">4626: </span>      genNodeList(params, context)
<span class="linenr">4627: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (params) {
<span class="linenr">4628: </span>      genNode(params, context)
<span class="linenr">4629: </span>    }
<span class="linenr">4630: </span>    push(<span class=
"org-string">`) =&gt; `</span>)
<span class="linenr">4631: </span>    <span class=
"org-keyword">if</span> (newline || body) {
<span class="linenr">4632: </span>      push(<span class=
"org-string">`{`</span>)
<span class="linenr">4633: </span>      indent()
<span class="linenr">4634: </span>    }
<span class="linenr">4635: </span>    <span class=
"org-keyword">if</span> (returns) {
<span class="linenr">4636: </span>      <span class=
"org-keyword">if</span> (newline) {
<span class="linenr">4637: </span>        push(<span class=
"org-string">`return `</span>)
<span class="linenr">4638: </span>      }
<span class="linenr">4639: </span>      <span class=
"org-keyword">if</span> (isArray(returns)) {
<span class=
"linenr">4640: </span>        genNodeListAsArray(returns, context)
<span class="linenr">4641: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">4642: </span>        genNode(returns, context)
<span class="linenr">4643: </span>      }
<span class="linenr">4644: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (body) {
<span class="linenr">4645: </span>      genNode(body, context)
<span class="linenr">4646: </span>    }
<span class="linenr">4647: </span>    <span class=
"org-keyword">if</span> (newline || body) {
<span class="linenr">4648: </span>      deindent()
<span class="linenr">4649: </span>      push(<span class=
"org-string">`}`</span>)
<span class="linenr">4650: </span>    }
<span class="linenr">4651: </span>    <span class=
"org-keyword">if</span> (isSlot) {
<span class="linenr">4652: </span>      push(<span class=
"org-string">`)`</span>)
<span class="linenr">4653: </span>    }
<span class="linenr">4654: </span>  }
<span class="linenr">4655: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genConditionalExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4656: </span>    <span class=
"org-keyword">const</span> { test, consequent, alternate, newline: needNewline } = node
<span class="linenr">4657: </span>    <span class=
"org-keyword">const</span> { push, indent, deindent, newline } = context
<span class="linenr">4658: </span>    <span class=
"org-keyword">if</span> (test.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">4659: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">needsParens</span> = !isSimpleIdentifier(test.content)
<span class=
"linenr">4660: </span>      needsParens &amp;& push(<span class=
"org-string">`(`</span>)
<span class=
"linenr">4661: </span>      genExpression(test, context)
<span class=
"linenr">4662: </span>      needsParens &amp;& push(<span class=
"org-string">`)`</span>)
<span class="linenr">4663: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">4664: </span>      push(<span class=
"org-string">`(`</span>)
<span class="linenr">4665: </span>      genNode(test, context)
<span class="linenr">4666: </span>      push(<span class=
"org-string">`)`</span>)
<span class="linenr">4667: </span>    }
<span class="linenr">4668: </span>    needNewline &amp;& indent()
<span class="linenr">4669: </span>    context.indentLevel++
<span class=
"linenr">4670: </span>    needNewline || push(<span class=
"org-string">` `</span>)
<span class="linenr">4671: </span>    push(<span class=
"org-string">`? `</span>)
<span class="linenr">4672: </span>    genNode(consequent, context)
<span class="linenr">4673: </span>    context.indentLevel--
<span class="linenr">4674: </span>    needNewline &amp;& newline()
<span class=
"linenr">4675: </span>    needNewline || push(<span class=
"org-string">` `</span>)
<span class="linenr">4676: </span>    push(<span class=
"org-string">`: `</span>)
<span class="linenr">4677: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isNested</span> = alternate.type === NodeTypes.JS_CONDITIONAL_EXPRESSION
<span class="linenr">4678: </span>    <span class=
"org-keyword">if</span> (!isNested) {
<span class="linenr">4679: </span>      context.indentLevel++
<span class="linenr">4680: </span>    }
<span class="linenr">4681: </span>    genNode(alternate, context)
<span class="linenr">4682: </span>    <span class=
"org-keyword">if</span> (!isNested) {
<span class="linenr">4683: </span>      context.indentLevel--
<span class="linenr">4684: </span>    }
<span class=
"linenr">4685: </span>    needNewline &amp;& deindent(<span class=
"org-constant">true</span> <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">without newline</span><span class=
"org-comment-delimiter"> */</span>)
<span class="linenr">4686: </span>  }
<span class="linenr">4687: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genCacheExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4688: </span>    <span class=
"org-keyword">const</span> { push, helper, indent, deindent, newline } = context
<span class="linenr">4689: </span>    push(<span class=
"org-string">`_cache[${node.index}] || (`</span>)
<span class="linenr">4690: </span>    <span class=
"org-keyword">if</span> (node.isVNode) {
<span class="linenr">4691: </span>      indent()
<span class="linenr">4692: </span>      push(<span class=
"org-string">`${helper(SET_BLOCK_TRACKING)}(-1),`</span>)
<span class="linenr">4693: </span>      newline()
<span class="linenr">4694: </span>    }
<span class="linenr">4695: </span>    push(<span class=
"org-string">`_cache[${node.index}] = `</span>)
<span class="linenr">4696: </span>    genNode(node.value, context)
<span class="linenr">4697: </span>    <span class=
"org-keyword">if</span> (node.isVNode) {
<span class="linenr">4698: </span>      push(<span class=
"org-string">`,`</span>)
<span class="linenr">4699: </span>      newline()
<span class="linenr">4700: </span>      push(<span class=
"org-string">`${helper(SET_BLOCK_TRACKING)}(1),`</span>)
<span class="linenr">4701: </span>      newline()
<span class="linenr">4702: </span>      push(<span class=
"org-string">`_cache[${node.index}]`</span>)
<span class="linenr">4703: </span>      deindent()
<span class="linenr">4704: </span>    }
<span class="linenr">4705: </span>    push(<span class=
"org-string">`)`</span>)
<span class="linenr">4706: </span>  }
<span class="linenr">4707: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genNodeList</span>(<span class=
"org-variable-name">nodes</span>, <span class=
"org-variable-name">context</span>, <span class=
"org-variable-name">multilines</span> = <span class=
"org-constant">false</span>, <span class=
"org-variable-name">comma</span> = <span class=
"org-constant">true</span>) {
<span class="linenr">4708: </span>    <span class=
"org-keyword">const</span> { push, newline } = context
<span class="linenr">4709: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; nodes.length; i++) {
<span class="linenr">4710: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">node</span> = nodes[i]
<span class="linenr">4711: </span>      <span class=
"org-keyword">if</span> (isString(node)) {
<span class="linenr">4712: </span>        push(node)
<span class="linenr">4713: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isArray(node)) {
<span class=
"linenr">4714: </span>        genNodeListAsArray(node, context)
<span class="linenr">4715: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">4716: </span>        genNode(node, context)
<span class="linenr">4717: </span>      }
<span class="linenr">4718: </span>      <span class=
"org-keyword">if</span> (i &lt; nodes.length - <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">4719: </span>        <span class=
"org-keyword">if</span> (multilines) {
<span class=
"linenr">4720: </span>          comma &amp;& push(<span class=
"org-string">','</span>)
<span class="linenr">4721: </span>          newline()
<span class="linenr">4722: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">4723: </span>          comma &amp;& push(<span class=
"org-string">', '</span>)
<span class="linenr">4724: </span>        }
<span class="linenr">4725: </span>      }
<span class="linenr">4726: </span>    }
<span class="linenr">4727: </span>  }
<span class="linenr">4728: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genTemplateLiteral</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4729: </span>    <span class=
"org-keyword">const</span> { push, indent, deindent } = context
<span class="linenr">4730: </span>    push(<span class=
"org-string">'`'</span>)
<span class="linenr">4731: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">l</span> = node.elements.length
<span class="linenr">4732: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">multilines</span> = l &gt; <span class=
"org-highlight-numbers-number">3</span>
<span class="linenr">4733: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; l; i++) {
<span class="linenr">4734: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">e</span> = node.elements[i]
<span class="linenr">4735: </span>      <span class=
"org-keyword">if</span> (isString(e)) {
<span class=
"linenr">4736: </span>        push(e.replace(<span class=
"org-string">/(`|\$|\\)/</span>g, <span class=
"org-string">'\\$1'</span>))
<span class="linenr">4737: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">4738: </span>        push(<span class=
"org-string">'${'</span>)
<span class="linenr">4739: </span>        <span class=
"org-keyword">if</span> (multilines) indent()
<span class="linenr">4740: </span>        genNode(e, context)
<span class="linenr">4741: </span>        <span class=
"org-keyword">if</span> (multilines) deindent()
<span class="linenr">4742: </span>        push(<span class=
"org-string">'}'</span>)
<span class="linenr">4743: </span>      }
<span class="linenr">4744: </span>    }
<span class="linenr">4745: </span>    push(<span class=
"org-string">'`'</span>)
<span class="linenr">4746: </span>  }
<span class="linenr">4747: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genIfStatement</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4748: </span>    <span class=
"org-keyword">const</span> { push, indent, deindent } = context
<span class="linenr">4749: </span>    <span class=
"org-keyword">const</span> { test, consequent, alternate } = node
<span class="linenr">4750: </span>    push(<span class=
"org-string">`if (`</span>)
<span class="linenr">4751: </span>    genNode(test, context)
<span class="linenr">4752: </span>    push(<span class=
"org-string">`) {`</span>)
<span class="linenr">4753: </span>    indent()
<span class="linenr">4754: </span>    genNode(consequent, context)
<span class="linenr">4755: </span>    deindent()
<span class="linenr">4756: </span>    push(<span class=
"org-string">`}`</span>)
<span class="linenr">4757: </span>    <span class=
"org-keyword">if</span> (alternate) {
<span class="linenr">4758: </span>      push(<span class=
"org-string">` else `</span>)
<span class="linenr">4759: </span>      <span class=
"org-keyword">if</span> (alternate.type === NodeTypes.JS_IF_STATEMENT) {
<span class=
"linenr">4760: </span>        genIfStatement(alternate, context)
<span class="linenr">4761: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">4762: </span>        push(<span class=
"org-string">`{`</span>)
<span class="linenr">4763: </span>        indent()
<span class=
"linenr">4764: </span>        genNode(alternate, context)
<span class="linenr">4765: </span>        deindent()
<span class="linenr">4766: </span>        push(<span class=
"org-string">`}`</span>)
<span class="linenr">4767: </span>      }
<span class="linenr">4768: </span>    }
<span class="linenr">4769: </span>  }
<span class="linenr">4770: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genAssignmentExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4771: </span>    genNode(node.left, context)
<span class="linenr">4772: </span>    context.push(<span class=
"org-string">` = `</span>)
<span class="linenr">4773: </span>    genNode(node.right, context)
<span class="linenr">4774: </span>  }
<span class="linenr">4775: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genSequenceExpression</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4776: </span>    context.push(<span class=
"org-string">`(`</span>)
<span class=
"linenr">4777: </span>    genNodeList(node.expressions, context)
<span class="linenr">4778: </span>    context.push(<span class=
"org-string">`)`</span>)
<span class="linenr">4779: </span>  }
<span class="linenr">4780: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genReturnStatement</span>({ returns }, context) {
<span class="linenr">4781: </span>    context.push(<span class=
"org-string">`return `</span>)
<span class="linenr">4782: </span>    <span class=
"org-keyword">if</span> (isArray(returns)) {
<span class=
"linenr">4783: </span>      genNodeListAsArray(returns, context)
<span class="linenr">4784: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">4785: </span>      genNode(returns, context)
<span class="linenr">4786: </span>    }
<span class="linenr">4787: </span>  }
<span class="linenr">4788: </span>  
<span class="linenr">4789: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genNode</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4790: </span>    <span class=
"org-keyword">if</span> (isString(node)) {
<span class="linenr">4791: </span>      context.push(node)
<span class="linenr">4792: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">4793: </span>    }
<span class="linenr">4794: </span>    <span class=
"org-keyword">if</span> (isSymbol(node)) {
<span class=
"linenr">4795: </span>      context.push(context.helper(node))
<span class="linenr">4796: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">4797: </span>    }
<span class="linenr">4798: </span>    <span class=
"org-keyword">switch</span> (node.type) {
<span class="linenr">4799: </span>      <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr">4800: </span>      <span class=
"org-keyword">case</span> NodeTypes.IF:
<span class="linenr">4801: </span>      <span class=
"org-keyword">case</span> NodeTypes.FOR:
<span class=
"linenr">4802: </span>        genNode(node.codegenNode, context)
<span class="linenr">4803: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4804: </span>      <span class=
"org-keyword">case</span> NodeTypes.TEXT:
<span class="linenr">4805: </span>        genText(node, context)
<span class="linenr">4806: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4807: </span>      <span class=
"org-keyword">case</span> NodeTypes.SIMPLE_EXPRESSION:
<span class=
"linenr">4808: </span>        genExpression(node, context)
<span class="linenr">4809: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4810: </span>      <span class=
"org-keyword">case</span> NodeTypes.INTERPOLATION:
<span class=
"linenr">4811: </span>        genInterpolation(node, context)
<span class="linenr">4812: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4813: </span>      <span class=
"org-keyword">case</span> NodeTypes.TEXT_CALL:
<span class=
"linenr">4814: </span>        genNode(node.codegenNode, context)
<span class="linenr">4815: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4816: </span>      <span class=
"org-keyword">case</span> NodeTypes.COMPOUND_EXPRESSION:
<span class=
"linenr">4817: </span>        genCompoundExpression(node, context)
<span class="linenr">4818: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4819: </span>      <span class=
"org-keyword">case</span> NodeTypes.COMMENT:
<span class="linenr">4820: </span>        genComment(node, context)
<span class="linenr">4821: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4822: </span>      <span class=
"org-keyword">case</span> NodeTypes.VNODE_CALL:
<span class=
"linenr">4823: </span>        genVNodeCall(node, context)
<span class="linenr">4824: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4825: </span>  
<span class="linenr">4826: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_CALL_EXPRESSION:
<span class=
"linenr">4827: </span>        genCallExpression(node, context)
<span class="linenr">4828: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4829: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_OBJECT_EXPRESSION:
<span class=
"linenr">4830: </span>        genObjectExpression(node, context)
<span class="linenr">4831: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4832: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_ARRAY_EXPRESSION:
<span class=
"linenr">4833: </span>        genArrayExpression(node, context)
<span class="linenr">4834: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4835: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_FUNCTION_EXPRESSION:
<span class=
"linenr">4836: </span>        genFunctionExpression(node, context)
<span class="linenr">4837: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4838: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_CONDITIONAL_EXPRESSION:
<span class=
"linenr">4839: </span>        genConditionalExpression(node, context)
<span class="linenr">4840: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4841: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_CACHE_EXPRESSION:
<span class=
"linenr">4842: </span>        genCacheExpression(node, context)
<span class="linenr">4843: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4844: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_BLOCK_STATEMENT:
<span class=
"linenr">4845: </span>        genNodeList(node.body, context, <span class="org-constant">true</span>, <span class="org-constant">false</span>)
<span class="linenr">4846: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4847: </span>  
<span class="linenr">4848: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">SSR only types</span>
<span class="linenr">4849: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_TEMPLATE_LITERAL:
<span class=
"linenr">4850: </span>        !__BROWSER__ &amp;& genTemplateLiteral(node, context)
<span class="linenr">4851: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4852: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_IF_STATEMENT:
<span class=
"linenr">4853: </span>        !__BROWSER__ &amp;& genIfStatement(node, context)
<span class="linenr">4854: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4855: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_ASSIGNMENT_EXPRESSION:
<span class=
"linenr">4856: </span>        !__BROWSER__ &amp;& genAssignmentExpression(node, context)
<span class="linenr">4857: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4858: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_SEQUENCE_EXPRESSION:
<span class=
"linenr">4859: </span>        !__BROWSER__ &amp;& genSequenceExpression(node, context)
<span class="linenr">4860: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4861: </span>      <span class=
"org-keyword">case</span> NodeTypes.JS_RETURN_STATEMENT:
<span class=
"linenr">4862: </span>        !__BROWSER__ &amp;& genReturnStatement(node, context)
<span class="linenr">4863: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4864: </span>  
<span class="linenr">4865: </span>      <span class=
"org-comment-delimiter">/* </span><span class=
"org-comment">istanbul ignore next</span><span class=
"org-comment-delimiter"> */</span>
<span class="linenr">4866: </span>      <span class=
"org-keyword">case</span> NodeTypes.IF_BRANCH:
<span class="linenr">4867: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">noop</span>
<span class="linenr">4868: </span>        <span class=
"org-keyword">break</span>
<span class="linenr">4869: </span>      <span class=
"org-keyword">default</span>:
<span class="linenr">4870: </span>        logg(<span class=
"org-string">`unhandled codegen node type: ${node.type}`</span>)
<span class="linenr">4871: </span>    }
<span class="linenr">4872: </span>  }
<span class="linenr">4873: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">genNodeListAsArray</span>(<span class=
"org-variable-name">nodes</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">4874: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">multilines</span> =
<span class=
"linenr">4875: </span>      nodes.length &gt; <span class=
"org-highlight-numbers-number">3</span> ||
<span class=
"linenr">4876: </span>      ((!__BROWSER__ || __DEV__) &amp;& nodes.some(n =&gt; isArray(n) || !isText(n)))
<span class="linenr">4877: </span>    context.push(<span class=
"org-string">`[`</span>)
<span class=
"linenr">4878: </span>    multilines &amp;& context.indent()
<span class=
"linenr">4879: </span>    genNodeList(nodes, context, multilines)
<span class=
"linenr">4880: </span>    multilines &amp;& context.deindent()
<span class="linenr">4881: </span>    context.push(<span class=
"org-string">`]`</span>)
<span class="linenr">4882: </span>  }
<span class="linenr">4883: </span>  
<span class="linenr">4884: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">generate</span>(<span class=
"org-variable-name">ast</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr">4885: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">context</span> = createCodegenContext(ast, options)
<span class="linenr">4886: </span>    <span class=
"org-keyword">if</span> (options.onContextCreated) options.onContextCreated(context)
<span class="linenr">4887: </span>    <span class=
"org-keyword">const</span> {
<span class="linenr">4888: </span>      mode,
<span class="linenr">4889: </span>      push,
<span class="linenr">4890: </span>      prefixIdentifiers,
<span class="linenr">4891: </span>      indent,
<span class="linenr">4892: </span>      deindent,
<span class="linenr">4893: </span>      newline,
<span class="linenr">4894: </span>      scopeId,
<span class="linenr">4895: </span>      ssr
<span class="linenr">4896: </span>    } = context
<span class="linenr">4897: </span>  
<span class="linenr">4898: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hasHelpers</span> = ast.helpers.length &gt; <span class="org-highlight-numbers-number">0</span>
<span class="linenr">4899: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">useWithBlock</span> = !prefixIdentifiers &amp;& mode !== <span class="org-string">'module'</span>
<span class="linenr">4900: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">genScopeId</span> = !__BROWSER__ &amp;& scopeId != <span class="org-constant">null</span> &amp;& mode === <span class="org-string">'module'</span>
<span class="linenr">4901: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isSetupInlined</span> = !__BROWSER__ &amp;& !!options.inline
<span class="linenr">4902: </span>  
<span class="linenr">4903: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">preambles</span>
<span class="linenr">4904: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in setup() inline mode, the preamble is generated in a sub context</span>
<span class="linenr">4905: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">and returned separately.</span>
<span class="linenr">4906: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">preambleContext</span> = isSetupInlined
<span class=
"linenr">4907: </span>      ? createCodegenContext(ast, options)
<span class="linenr">4908: </span>      : context
<span class="linenr">4909: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& mode === <span class=
"org-string">'module'</span>) {
<span class=
"linenr">4910: </span>      genModulePreamble(ast, preambleContext, genScopeId, isSetupInlined)
<span class="linenr">4911: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">4912: </span>      genFunctionPreamble(ast, preambleContext)
<span class="linenr">4913: </span>    }
<span class="linenr">4914: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">enter render function</span>
<span class="linenr">4915: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">functionName</span> = ssr ? <span class=
"org-string">`ssrRender`</span> : <span class=
"org-string">`render`</span>
<span class="linenr">4916: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">args</span> = ssr ? [<span class=
"org-string">'_ctx'</span>, <span class=
"org-string">'_push'</span>, <span class=
"org-string">'_parent'</span>, <span class=
"org-string">'_attrs'</span>] : [<span class=
"org-string">'_ctx'</span>, <span class=
"org-string">'_cache'</span>]
<span class="linenr">4917: </span>    <span class=
"org-keyword">if</span> (!__BROWSER__ &amp;& options.bindingMetadata &amp;& !options.inline) {
<span class="linenr">4918: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">binding optimization args</span>
<span class="linenr">4919: </span>      args.push(<span class=
"org-string">'$props'</span>, <span class=
"org-string">'$setup'</span>, <span class=
"org-string">'$data'</span>, <span class=
"org-string">'$options'</span>)
<span class="linenr">4920: </span>    }
<span class="linenr">4921: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">signature</span> =
<span class=
"linenr">4922: </span>      !__BROWSER__ &amp;& options.isTS
<span class=
"linenr">4923: </span>        ? args.map(arg =&gt; <span class=
"org-string">`${arg}: any`</span>).join(<span class=
"org-string">','</span>)
<span class="linenr">4924: </span>        : args.join(<span class=
"org-string">', '</span>)
<span class="linenr">4925: </span>  
<span class="linenr">4926: </span>    <span class=
"org-keyword">if</span> (isSetupInlined) {
<span class="linenr">4927: </span>      push(<span class=
"org-string">`(${signature}) =&gt; {`</span>)
<span class="linenr">4928: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">4929: </span>      push(<span class=
"org-string">`function ${functionName}(${signature}) {`</span>)
<span class="linenr">4930: </span>    }
<span class="linenr">4931: </span>    indent()
<span class="linenr">4932: </span>  
<span class="linenr">4933: </span>    <span class=
"org-keyword">if</span> (useWithBlock) {
<span class="linenr">4934: </span>      push(<span class=
"org-string">`with (_ctx) {`</span>)
<span class="linenr">4935: </span>      indent()
<span class="linenr">4936: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">function mode const declarations should be inside with block</span>
<span class="linenr">4937: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also they should be renamed to avoid collision with user properties</span>
<span class="linenr">4938: </span>      <span class=
"org-keyword">if</span> (hasHelpers) {
<span class="linenr">4939: </span>        push(
<span class="linenr">4940: </span>          <span class=
"org-string">`const { ${ast.helpers</span>
<span class="linenr">4941: </span><span class=
"org-string">            .map(s =&gt; `</span>${helperNameMap[s]}: _${helperNameMap[s]}<span class="org-string">`)</span>
<span class="linenr">4942: </span><span class=
"org-string">            .join(', ')} } = _Vue`</span>
<span class="linenr">4943: </span>        )
<span class="linenr">4944: </span>        push(<span class=
"org-string">`\n`</span>)
<span class="linenr">4945: </span>        newline()
<span class="linenr">4946: </span>      }
<span class="linenr">4947: </span>    }
<span class="linenr">4948: </span>  
<span class="linenr">4949: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generate asset resolution statements</span>
<span class="linenr">4950: </span>    <span class=
"org-keyword">if</span> (ast.components.length) {
<span class=
"linenr">4951: </span>      genAssets(ast.components, <span class=
"org-string">'component'</span>, context)
<span class="linenr">4952: </span>      <span class=
"org-keyword">if</span> (ast.directives.length || ast.temps &gt; <span class="org-highlight-numbers-number">0</span>) {
<span class="linenr">4953: </span>        newline()
<span class="linenr">4954: </span>      }
<span class="linenr">4955: </span>    }
<span class="linenr">4956: </span>    <span class=
"org-keyword">if</span> (ast.directives.length) {
<span class=
"linenr">4957: </span>      genAssets(ast.directives, <span class=
"org-string">'directive'</span>, context)
<span class="linenr">4958: </span>      <span class=
"org-keyword">if</span> (ast.temps &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">4959: </span>        newline()
<span class="linenr">4960: </span>      }
<span class="linenr">4961: </span>    }
<span class="linenr">4962: </span>  
<span class="linenr">4963: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">临时变量</span>
<span class="linenr">4964: </span>    <span class=
"org-keyword">if</span> (ast.temps &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">4965: </span>      push(<span class=
"org-string">`let `</span>)
<span class="linenr">4966: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; ast.temps; i++) {
<span class="linenr">4967: </span>        push(<span class=
"org-string">`${i &gt; 0 ? `</span>, <span class=
"org-string">` : ``}_temp${i}`</span>)
<span class="linenr">4968: </span>      }
<span class="linenr">4969: </span>    }
<span class="linenr">4970: </span>    <span class=
"org-keyword">if</span> (ast.components.length || ast.directives.length || ast.temps) {
<span class="linenr">4971: </span>      push(<span class=
"org-string">`\n`</span>)
<span class="linenr">4972: </span>      newline()
<span class="linenr">4973: </span>    }
<span class="linenr">4974: </span>  
<span class="linenr">4975: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">generate the VNode tree expression</span>
<span class="linenr">4976: </span>    <span class=
"org-keyword">if</span> (!ssr) {
<span class="linenr">4977: </span>      push(<span class=
"org-string">`return `</span>)
<span class="linenr">4978: </span>    }
<span class="linenr">4979: </span>    <span class=
"org-keyword">if</span> (ast.codegenNode) {
<span class=
"linenr">4980: </span>      genNode(ast.codegenNode, context)
<span class="linenr">4981: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">4982: </span>      push(<span class=
"org-string">`null`</span>)
<span class="linenr">4983: </span>    }
<span class="linenr">4984: </span>  
<span class="linenr">4985: </span>    <span class=
"org-keyword">if</span> (useWithBlock) {
<span class="linenr">4986: </span>      deindent()
<span class="linenr">4987: </span>      push(<span class=
"org-string">`}`</span>)
<span class="linenr">4988: </span>    }
<span class="linenr">4989: </span>  
<span class="linenr">4990: </span>    deindent()
<span class="linenr">4991: </span>    push(<span class=
"org-string">`}`</span>)
<span class="linenr">4992: </span>  
<span class="linenr">4993: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">4994: </span>      ast,
<span class="linenr">4995: </span>      code: context.code,
<span class=
"linenr">4996: </span>      preamble: isSetupInlined ? preambleContext.code : <span class="org-string">``</span>,
<span class="linenr">4997: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">SourceMapGenerator does have toJSON() method but it's not in the types</span>
<span class=
"linenr">4998: </span>      map: context.map ? context.map.toJSON() : <span class="org-constant">undefined</span>
<span class="linenr">4999: </span>    }
<span class="linenr">5000: </span>  }
<span class="linenr">5001: </span>
<span class="linenr">5002: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">baseCompile</span>(<span class=
"org-variable-name">template</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr">5003: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isModuleMode</span> = options.mode === <span class="org-string">'module'</span>
<span class="linenr">5004: </span>
<span class="linenr">5005: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">prefixIdentifiers</span> =
<span class=
"linenr">5006: </span>        !__BROWSER__ &amp;& (options.prefixIdentifiers === <span class="org-constant">true</span> || isModuleMode)
<span class="linenr">5007: </span>
<span class="linenr">5008: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ast</span> = isString(template) ? baseParse(template, options) : template
<span class="linenr">5009: </span>    <span class=
"org-keyword">const</span> [<span class=
"org-variable-name">nodeTransforms</span>, <span class=
"org-variable-name">directiveTransforms</span>] = getBaseTransformPreset(prefixIdentifiers)
<span class="linenr">5010: </span>
<span class="linenr">5011: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">转换出每个节点的 codegenNode</span>
<span class="linenr">5012: </span>    transform(
<span class="linenr">5013: </span>        ast,
<span class="linenr">5014: </span>        extend({}, options, {
<span class="linenr">5015: </span>        prefixIdentifiers,
<span class="linenr">5016: </span>        nodeTransforms: [
<span class="linenr">5017: </span>            ...nodeTransforms,
<span class=
"linenr">5018: </span>            ...(options.nodeTransforms || []) <span class="org-comment-delimiter">// </span><span class="org-comment">user transforms</span>
<span class="linenr">5019: </span>        ],
<span class=
"linenr">5020: </span>        directiveTransforms: extend(
<span class="linenr">5021: </span>            {},
<span class="linenr">5022: </span>            directiveTransforms,
<span class=
"linenr">5023: </span>            options.directiveTransforms || {} <span class="org-comment-delimiter">// </span><span class="org-comment">user transforms</span>
<span class="linenr">5024: </span>        )
<span class="linenr">5025: </span>        })
<span class="linenr">5026: </span>    )
<span class="linenr">5027: </span>
<span class="linenr">5028: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">生成 codegen</span>
<span class="linenr">5029: </span>    <span class=
"org-keyword">return</span> generate(ast, extend({}, options, { prefixIdentifiers }))
<span class="linenr">5030: </span>  }
</pre>
      </div>
    </details>
    <div id="outline-container-org1b608bd" class="outline-2">
      <h2 id="org1b608bd"><span class="section-number-2">1.</span>
      APIs</h2>
      <div class="outline-text-2" id="text-1">
        <p>compiler-dom 包包含以下 APIs 这个包主要是针对一些指令进行加工处理，如：
        <code>v-html</code>, <code>v-text</code> 等等。</p>
        <table>
          <colgroup>
            <col class="org-left">
            <col class="org-left">
          </colgroup>
          <thead>
            <tr>
              <th scope="col" class="org-left">name</th>
              <th scope="col" class="org-left">description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="org-left">&nbsp;</td>
              <td class="org-left">combine & normalize, result to
              object <code>{a:b, c:d}</code></td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#orgf5d5345">transformVHtml()</a>
              </td>
              <td class="org-left">v-html</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org94fde9a">transformVText()</a>
              </td>
              <td class="org-left">v-text</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#orgf13f87c">transformModel()</a>
              </td>
              <td class="org-left">v-model, transform bind value
              and event handler</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org5117ca4">transformOn()</a>
              </td>
              <td class="org-left">v-on, handle the event
              modifiers</td>
            </tr>
            <tr>
              <td class="org-left">
                <a href="#org728c08d">transformShow()</a>
              </td>
              <td class="org-left">v-show</td>
            </tr>
          </tbody>
        </table><br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "red">compiler-dom</font></strong>
          </summary>
          <div class="org-src-container">
            <pre class="src src-js" id="orgf3d4572"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">compilerDom</span> = (<span class=
            "org-keyword">function</span>() {
<span class="linenr">  2: </span>  
<span class="linenr">  3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Parse inline CSS strings for static style attributes into an object.</span>
<span class="linenr">  4: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">This is a NodeTransform since it works on the static `style` attribute and</span>
<span class="linenr">  5: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">converts it into a dynamic equivalent:</span>
<span class="linenr">  6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">style="color: red" -&gt; :style='{ "color": "red" }'</span>
<span class="linenr">  7: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">It is then processed by `transformElement` and included in the generated</span>
<span class="linenr">  8: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">props.</span>
<span class="linenr">  9: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformStyle</span> = node =&gt; {
<span class="linenr"> 10: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT) {
<span class=
"linenr"> 11: </span>      node.props.forEach((p, i) =&gt; {
<span class="linenr"> 12: </span>        <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE &amp;& p.name === <span class="org-string">'style'</span> &amp;& p.value) {
<span class="linenr"> 13: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">replace p with an expression node</span>
<span class="linenr"> 14: </span>          node.props[i] = {
<span class=
"linenr"> 15: </span>            type: NodeTypes.DIRECTIVE,
<span class="linenr"> 16: </span>            name: <span class=
"org-string">`bind`</span>,
<span class=
"linenr"> 17: </span>            arg: createSimpleExpression(<span class="org-string">`style`</span>, <span class="org-constant">true</span>, p.loc),
<span class=
"linenr"> 18: </span>            exp: parseInlineCSS(p.value.content, p.loc),
<span class="linenr"> 19: </span>            modifiers: [],
<span class="linenr"> 20: </span>            loc: p.loc
<span class="linenr"> 21: </span>          }
<span class="linenr"> 22: </span>        }
<span class="linenr"> 23: </span>      })
<span class="linenr"> 24: </span>    }
<span class="linenr"> 25: </span>  }
<span class="linenr"> 26: </span>  
<span class="linenr"> 27: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">parseInlineCSS</span> = (cssText, loc) =&gt; {
<span class="linenr"> 28: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">normalized</span> = parseStringStyle(cssText)
<span class="linenr"> 29: </span>    <span class=
"org-keyword">return</span> createSimpleExpression(
<span class="linenr"> 30: </span>      JSON.stringify(normalized),
<span class="linenr"> 31: </span>      <span class=
"org-constant">false</span>,
<span class="linenr"> 32: </span>      loc,
<span class="linenr"> 33: </span>      ConstantTypes.CAN_STRINGIFY
<span class="linenr"> 34: </span>    )
<span class="linenr"> 35: </span>  }
<span class="linenr"> 36: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformVHtml</span> = (dir, node, context) =&gt; {
<span class="linenr"> 37: </span>    <span class=
"org-keyword">const</span> { exp, loc } = dir
<span class="linenr"> 38: </span>    <span class=
"org-keyword">if</span> (!exp) {
<span class="linenr"> 39: </span>      logg(<span class=
"org-string">"v-html no exp"</span>)
<span class="linenr"> 40: </span>    }
<span class="linenr"> 41: </span>    <span class=
"org-keyword">if</span> (node.children.length) {
<span class="linenr"> 42: </span>      logg(<span class=
"org-string">'v-html can not has children'</span>)
<span class=
"linenr"> 43: </span>      node.children.length = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 44: </span>    }
<span class="linenr"> 45: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr"> 46: </span>      props: [
<span class="linenr"> 47: </span>        createObjectProperty(
<span class=
"linenr"> 48: </span>          createSimpleExpression(<span class=
"org-string">`innerHTML`</span>, <span class=
"org-constant">true</span>, loc),
<span class=
"linenr"> 49: </span>          exp || createSimpleExpression(<span class="org-string">''</span>, <span class="org-constant">true</span>)
<span class="linenr"> 50: </span>        )
<span class="linenr"> 51: </span>      ]
<span class="linenr"> 52: </span>    }
<span class="linenr"> 53: </span>  }
<span class="linenr"> 54: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformVText</span> = (dir, node, context) =&gt; {
<span class="linenr"> 55: </span>    <span class=
"org-keyword">const</span> { exp, loc } = dir
<span class="linenr"> 56: </span>    <span class=
"org-keyword">if</span> (!exp) {
<span class="linenr"> 57: </span>      logg(<span class=
"org-string">'v-text no exp'</span>)
<span class="linenr"> 58: </span>    }
<span class="linenr"> 59: </span>    <span class=
"org-keyword">if</span> (node.children.length) {
<span class="linenr"> 60: </span>      logg(<span class=
"org-string">'v-text can not have children'</span>)
<span class=
"linenr"> 61: </span>      node.children.length = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 62: </span>    }
<span class="linenr"> 63: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr"> 64: </span>      props: [
<span class="linenr"> 65: </span>        createObjectProperty(
<span class=
"linenr"> 66: </span>          createSimpleExpression(<span class=
"org-string">`textContent`</span>, <span class=
"org-constant">true</span>),
<span class="linenr"> 67: </span>          exp
<span class=
"linenr"> 68: </span>            ? createCallExpression(
<span class=
"linenr"> 69: </span>                context.helperString(TO_DISPLAY_STRING),
<span class="linenr"> 70: </span>                [exp],
<span class="linenr"> 71: </span>                loc
<span class="linenr"> 72: </span>              )
<span class=
"linenr"> 73: </span>            : createSimpleExpression(<span class="org-string">''</span>, <span class="org-constant">true</span>)
<span class="linenr"> 74: </span>        )
<span class="linenr"> 75: </span>      ]
<span class="linenr"> 76: </span>    }
<span class="linenr"> 77: </span>  }
<span class="linenr"> 78: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformModel</span> = (dir, node, context) =&gt; {
<span class="linenr"> 79: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">baseResult</span> = transformModel(dir, node, context)
<span class="linenr"> 80: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">base transform has errors OR component v-model (only need props)</span>
<span class="linenr"> 81: </span>    <span class=
"org-keyword">if</span> (!baseResult.props.length || node.tagType === ElementTypes.COMPONENT) {
<span class="linenr"> 82: </span>      <span class=
"org-keyword">return</span> baseResult
<span class="linenr"> 83: </span>    }
<span class="linenr"> 84: </span>  
<span class="linenr"> 85: </span>    <span class=
"org-keyword">if</span> (dir.arg) {
<span class="linenr"> 86: </span>      logg(<span class=
"org-string">"transfromModel - X_V_MODEL_ARG_ON_ELEMENT"</span>)
<span class="linenr"> 87: </span>    }
<span class="linenr"> 88: </span>  
<span class="linenr"> 89: </span>    <span class=
"org-keyword">function</span> <span class=
"org-function-name">checkDuplicatedValue</span>() {
<span class="linenr"> 90: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">value</span> = findProp(node, <span class=
"org-string">'value'</span>)
<span class="linenr"> 91: </span>      <span class=
"org-keyword">if</span> (value) {
<span class="linenr"> 92: </span>        logg(<span class=
"org-string">"transfromModel - X_V_MODEL_UNNECESSARY_VALUE"</span>)
<span class="linenr"> 93: </span>      }
<span class="linenr"> 94: </span>    }
<span class="linenr"> 95: </span>  
<span class="linenr"> 96: </span>    <span class=
"org-keyword">const</span> { tag } = node
<span class="linenr"> 97: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isCustomElement</span> = context.isCustomElement(tag)
<span class="linenr"> 98: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr"> 99: </span>      tag === <span class=
"org-string">'input'</span> ||
<span class="linenr">100: </span>      tag === <span class=
"org-string">'textarea'</span> ||
<span class="linenr">101: </span>      tag === <span class=
"org-string">'select'</span> ||
<span class="linenr">102: </span>      isCustomElement
<span class="linenr">103: </span>    ) {
<span class="linenr">104: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">directiveToUse</span> = V_MODEL_TEXT
<span class="linenr">105: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isInvalidType</span> = <span class=
"org-constant">false</span>
<span class="linenr">106: </span>      <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'input'</span> || isCustomElement) {
<span class="linenr">107: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">type</span> = findProp(node, <span class=
"org-string">`type`</span>)
<span class="linenr">108: </span>        <span class=
"org-keyword">if</span> (type) {
<span class="linenr">109: </span>          <span class=
"org-keyword">if</span> (type.type === NodeTypes.DIRECTIVE) {
<span class="linenr">110: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">:type="foo"</span>
<span class=
"linenr">111: </span>            directiveToUse = V_MODEL_DYNAMIC
<span class="linenr">112: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type.value) {
<span class="linenr">113: </span>            <span class=
"org-keyword">switch</span> (type.value.content) {
<span class="linenr">114: </span>              <span class=
"org-keyword">case</span> <span class="org-string">'radio'</span>:
<span class=
"linenr">115: </span>                directiveToUse = V_MODEL_RADIO
<span class="linenr">116: </span>                <span class=
"org-keyword">break</span>
<span class="linenr">117: </span>              <span class=
"org-keyword">case</span> <span class=
"org-string">'checkbox'</span>:
<span class=
"linenr">118: </span>                directiveToUse = V_MODEL_CHECKBOX
<span class="linenr">119: </span>                <span class=
"org-keyword">break</span>
<span class="linenr">120: </span>              <span class=
"org-keyword">case</span> <span class="org-string">'file'</span>:
<span class=
"linenr">121: </span>                isInvalidType = <span class=
"org-constant">true</span>
<span class="linenr">122: </span>                logg(<span class=
"org-string">"[DOM]transformModel - X_V_MODEL_ON_FILE_INPUT_ELEMENT"</span>)
<span class="linenr">123: </span>                <span class=
"org-keyword">break</span>
<span class="linenr">124: </span>              <span class=
"org-keyword">default</span>:
<span class="linenr">125: </span>                <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">text type</span>
<span class=
"linenr">126: </span>                __DEV__ &amp;& checkDuplicatedValue()
<span class="linenr">127: </span>                <span class=
"org-keyword">break</span>
<span class="linenr">128: </span>            }
<span class="linenr">129: </span>          }
<span class="linenr">130: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (hasDynamicKeyVBind(node)) {
<span class="linenr">131: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">element has bindings with dynamic keys, which can possibly contain</span>
<span class="linenr">132: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">"type".</span>
<span class=
"linenr">133: </span>          directiveToUse = V_MODEL_DYNAMIC
<span class="linenr">134: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">135: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">text type</span>
<span class=
"linenr">136: </span>          __DEV__ &amp;& checkDuplicatedValue()
<span class="linenr">137: </span>        }
<span class="linenr">138: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'select'</span>) {
<span class=
"linenr">139: </span>        directiveToUse = V_MODEL_SELECT
<span class="linenr">140: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">141: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">textarea</span>
<span class=
"linenr">142: </span>        __DEV__ &amp;& checkDuplicatedValue()
<span class="linenr">143: </span>      }
<span class="linenr">144: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inject runtime directive</span>
<span class="linenr">145: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">by returning the helper symbol via needRuntime</span>
<span class="linenr">146: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the import will replaced a resolveDirective call.</span>
<span class="linenr">147: </span>      <span class=
"org-keyword">if</span> (!isInvalidType) {
<span class=
"linenr">148: </span>        baseResult.needRuntime = context.helper(directiveToUse)
<span class="linenr">149: </span>      }
<span class="linenr">150: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">151: </span>      logg(<span class=
"org-string">"[DOM]transformModel - X_V_MODEL_ON_INVALID_ELEMENT"</span>)
<span class="linenr">152: </span>    }
<span class="linenr">153: </span>  
<span class="linenr">154: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">native vmodel doesn't need the `modelValue` props since they are also</span>
<span class="linenr">155: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">passed to the runtime as `binding.value`. removing it reduces code size.</span>
<span class=
"linenr">156: </span>    baseResult.props = baseResult.props.filter(
<span class="linenr">157: </span>      p =&gt;
<span class="linenr">158: </span>        !(
<span class=
"linenr">159: </span>          p.key.type === NodeTypes.SIMPLE_EXPRESSION &amp;&
<span class=
"linenr">160: </span>          p.key.content === <span class=
"org-string">'modelValue'</span>
<span class="linenr">161: </span>        )
<span class="linenr">162: </span>    )
<span class="linenr">163: </span>  
<span class="linenr">164: </span>    <span class=
"org-keyword">return</span> baseResult
<span class="linenr">165: </span>  }
<span class="linenr">166: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isEventOptionModifier</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(<span class=
"org-string">`passive,once,capture`</span>)
<span class="linenr">167: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isNonKeyModifier</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr">168: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">event propagation management</span>
<span class="linenr">169: </span>    <span class=
"org-string">`stop,prevent,self,`</span> +
<span class="linenr">170: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">system modifiers + exact</span>
<span class="linenr">171: </span>      <span class=
"org-string">`ctrl,shift,alt,meta,exact,`</span> +
<span class="linenr">172: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mouse</span>
<span class="linenr">173: </span>      <span class=
"org-string">`middle`</span>
<span class="linenr">174: </span>  )
<span class="linenr">175: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">left & right could be mouse or key modifiers based on event type</span>
<span class="linenr">176: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">maybeKeyModifier</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(<span class=
"org-string">'left,right'</span>)
<span class="linenr">177: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isKeyboardEvent</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr">178: </span>    <span class=
"org-string">`onkeyup,onkeydown,onkeypress`</span>,
<span class="linenr">179: </span>    <span class=
"org-constant">true</span>
<span class="linenr">180: </span>  )
<span class="linenr">181: </span>  
<span class="linenr">182: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将修饰符分类</span>
<span class="linenr">183: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">resolveModifiers</span> = (key, modifiers, context, loc) =&gt; {
<span class="linenr">184: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyModifiers</span> = []
<span class="linenr">185: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nonKeyModifiers</span> = []
<span class="linenr">186: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">eventOptionModifiers</span> = []
<span class="linenr">187: </span>  
<span class="linenr">188: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; modifiers.length; i++) {
<span class="linenr">189: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifier</span> = modifiers[i]
<span class="linenr">190: </span>  
<span class="linenr">191: </span>      <span class=
"org-keyword">if</span> (isEventOptionModifier(modifier)) {
<span class="linenr">192: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">eventOptionModifiers: modifiers for addEventListener() options,</span>
<span class="linenr">193: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">e.g. .passive & .capture</span>
<span class=
"linenr">194: </span>        eventOptionModifiers.push(modifier)
<span class="linenr">195: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">196: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">runtimeModifiers: modifiers that needs runtime guards</span>
<span class="linenr">197: </span>        <span class=
"org-keyword">if</span> (maybeKeyModifier(modifier)) {
<span class="linenr">198: </span>          <span class=
"org-keyword">if</span> (isStaticExp(key)) {
<span class="linenr">199: </span>            <span class=
"org-keyword">if</span> (isKeyboardEvent(key.content)) {
<span class=
"linenr">200: </span>              keyModifiers.push(modifier)
<span class="linenr">201: </span>            } <span class=
"org-keyword">else</span> {
<span class=
"linenr">202: </span>              nonKeyModifiers.push(modifier)
<span class="linenr">203: </span>            }
<span class="linenr">204: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr">205: </span>            keyModifiers.push(modifier)
<span class=
"linenr">206: </span>            nonKeyModifiers.push(modifier)
<span class="linenr">207: </span>          }
<span class="linenr">208: </span>        } <span class=
"org-keyword">else</span> {
<span class="linenr">209: </span>          <span class=
"org-keyword">if</span> (isNonKeyModifier(modifier)) {
<span class=
"linenr">210: </span>            nonKeyModifiers.push(modifier)
<span class="linenr">211: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr">212: </span>            keyModifiers.push(modifier)
<span class="linenr">213: </span>          }
<span class="linenr">214: </span>        }
<span class="linenr">215: </span>      }
<span class="linenr">216: </span>    }
<span class="linenr">217: </span>  
<span class="linenr">218: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">219: </span>      keyModifiers,
<span class="linenr">220: </span>      nonKeyModifiers,
<span class="linenr">221: </span>      eventOptionModifiers
<span class="linenr">222: </span>    }
<span class="linenr">223: </span>  }
<span class="linenr">224: </span>  
<span class="linenr">225: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">原生 click 事件</span>
<span class="linenr">226: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformClick</span> = (key, event) =&gt; {
<span class="linenr">227: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStaticClick</span> =
<span class=
"linenr">228: </span>      isStaticExp(key) &amp;& key.content.toLowerCase() === <span class="org-string">'onclick'</span>
<span class="linenr">229: </span>    <span class=
"org-keyword">return</span> isStaticClick
<span class=
"linenr">230: </span>      ? createSimpleExpression(event, <span class="org-constant">true</span>)
<span class=
"linenr">231: </span>      : key.type !== NodeTypes.SIMPLE_EXPRESSION
<span class="linenr">232: </span>      ? createCompoundExpression([
<span class="linenr">233: </span>          <span class=
"org-string">`(`</span>,
<span class="linenr">234: </span>          key,
<span class="linenr">235: </span>          <span class=
"org-string">`) === "onClick" ? "${event}" : (`</span>,
<span class="linenr">236: </span>          key,
<span class="linenr">237: </span>          <span class=
"org-string">`)`</span>
<span class="linenr">238: </span>        ])
<span class="linenr">239: </span>      : key
<span class="linenr">240: </span>  }
<span class="linenr">241: </span>  
<span class="linenr">242: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformOn</span> = (dir, node, context) =&gt; {
<span class="linenr">243: </span>    <span class=
"org-keyword">return</span> transformOn(dir, node, context, baseResult =&gt; {
<span class="linenr">244: </span>      <span class=
"org-keyword">const</span> { modifiers } = dir
<span class="linenr">245: </span>      <span class=
"org-keyword">if</span> (!modifiers.length) <span class=
"org-keyword">return</span> baseResult
<span class="linenr">246: </span>  
<span class="linenr">247: </span>      <span class=
"org-keyword">let</span> { key, value: handlerExp } = baseResult.props[<span class="org-highlight-numbers-number">0</span>]
<span class="linenr">248: </span>      <span class=
"org-keyword">const</span> { keyModifiers, nonKeyModifiers, eventOptionModifiers } =
<span class=
"linenr">249: </span>        resolveModifiers(key, modifiers, context, dir.loc)
<span class="linenr">250: </span>  
<span class="linenr">251: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">normalize click.right and click.middle since they don't actually fire</span>
<span id="coderef-transformOn-right" class=
"coderef-off"><span class="linenr">252: </span>      <span class=
"org-keyword">if</span> (nonKeyModifiers.includes(<span class=
"org-string">'right'</span>)) {</span>
<span class=
"linenr">253: </span>        key = transformClick(key, <span class=
"org-string">`onContextmenu`</span>)
<span class="linenr">254: </span>      }
<span class="linenr">255: </span>      <span class=
"org-keyword">if</span> (nonKeyModifiers.includes(<span class=
"org-string">'middle'</span>)) {
<span class=
"linenr">256: </span>        key = transformClick(key, <span class=
"org-string">`onMouseup`</span>)
<span class="linenr">257: </span>      }
<span class="linenr">258: </span>  
<span class="linenr">259: </span>      <span class=
"org-keyword">if</span> (nonKeyModifiers.length) {
<span class=
"linenr">260: </span>        handlerExp = createCallExpression(context.helper(V_ON_WITH_MODIFIERS), [
<span class="linenr">261: </span>          handlerExp,
<span class=
"linenr">262: </span>          JSON.stringify(nonKeyModifiers)
<span class="linenr">263: </span>        ])
<span class="linenr">264: </span>      }
<span class="linenr">265: </span>  
<span class="linenr">266: </span>      <span class=
"org-keyword">if</span> (
<span class="linenr">267: </span>        keyModifiers.length &amp;&
<span class="linenr">268: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if event name is dynamic, always wrap with keys guard</span>
<span class=
"linenr">269: </span>        (!isStaticExp(key) || isKeyboardEvent(key.content))
<span class="linenr">270: </span>      ) {
<span class=
"linenr">271: </span>        handlerExp = createCallExpression(context.helper(V_ON_WITH_KEYS), [
<span class="linenr">272: </span>          handlerExp,
<span class=
"linenr">273: </span>          JSON.stringify(keyModifiers)
<span class="linenr">274: </span>        ])
<span class="linenr">275: </span>      }
<span class="linenr">276: </span>  
<span class="linenr">277: </span>      <span class=
"org-keyword">if</span> (eventOptionModifiers.length) {
<span class="linenr">278: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifierPostfix</span> = eventOptionModifiers.map(capitalize).join(<span class="org-string">''</span>)
<span class="linenr">279: </span>        key = isStaticExp(key)
<span class=
"linenr">280: </span>          ? createSimpleExpression(<span class="org-string">`${key.content}${modifierPostfix}`</span>, <span class="org-constant">true</span>)
<span class=
"linenr">281: </span>          : createCompoundExpression([<span class="org-string">`(`</span>, key, <span class="org-string">`) + "${modifierPostfix}"`</span>])
<span class="linenr">282: </span>      }
<span class="linenr">283: </span>  
<span class="linenr">284: </span>      <span class=
"org-keyword">return</span> {
<span class=
"linenr">285: </span>        props: [createObjectProperty(key, handlerExp)]
<span class="linenr">286: </span>      }
<span class="linenr">287: </span>    })
<span class="linenr">288: </span>  }
<span class="linenr">289: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformShow</span> = (dir, node, context) =&gt; {
<span class="linenr">290: </span>    <span class=
"org-keyword">const</span> { exp, loc } = dir
<span class="linenr">291: </span>    <span class=
"org-keyword">if</span> (!exp) {
<span class="linenr">292: </span>      logg(<span class=
"org-string">'transformShow no exp.'</span>)
<span class="linenr">293: </span>    }
<span class="linenr">294: </span>  
<span class="linenr">295: </span>    <span class=
"org-keyword">return</span> {
<span class="linenr">296: </span>      props: [],
<span class=
"linenr">297: </span>      needRuntime: context.helper(V_SHOW)
<span class="linenr">298: </span>    }
<span class="linenr">299: </span>  }
<span class="linenr">300: </span>   <span class=
"org-keyword">const</span> <span class=
"org-variable-name">StringifyThresholds</span> = {
<span class=
"linenr">301: </span>     ELEMENT_WITH_BINDING_COUNT: <span class=
"org-highlight-numbers-number">5</span>,
<span class="linenr">302: </span>     NODE_COUNT: <span class=
"org-highlight-numbers-number">20</span>
<span class="linenr">303: </span>  }
<span class="linenr">304: </span>  
<span class="linenr">305: </span>  <span class="org-doc">/**</span>
<span class="linenr">306: </span><span class=
"org-doc">   * Regex for replacing placeholders for embedded constant variables</span>
<span class="linenr">307: </span><span class=
"org-doc">   * (e.g. import URL string constants generated by compiler-sfc)</span>
<span class="linenr">308: </span><span class="org-doc">   */</span>
<span class="linenr">309: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">expReplaceRE</span> = <span class=
"org-string">/__VUE_EXP_START__(.*?)__VUE_EXP_END__/</span>g
<span class="linenr">310: </span>  
<span class="linenr">311: </span>  <span class="org-doc">/**</span>
<span class="linenr">312: </span><span class=
"org-doc">   * Turn eligible hoisted static trees into stringified static nodes, e.g.</span>
<span class="linenr">313: </span><span class="org-doc">   *</span>
<span class="linenr">314: </span><span class=
"org-doc">   * ```js</span>
<span class="linenr">315: </span><span class=
"org-doc">   * const _hoisted_1 = createStaticVNode(`&lt;div class="foo"&gt;bar&lt;/div&gt;`)</span>
<span class="linenr">316: </span><span class=
"org-doc">   * ```</span>
<span class="linenr">317: </span><span class="org-doc">   *</span>
<span class="linenr">318: </span><span class=
"org-doc">   * A single static vnode can contain stringified content for **multiple**</span>
<span class="linenr">319: </span><span class=
"org-doc">   * consecutive nodes (element and plain text), called a "chunk".</span>
<span class="linenr">320: </span><span class=
"org-doc">   * `@vue/runtime-dom` will create the content via innerHTML in a hidden</span>
<span class="linenr">321: </span><span class=
"org-doc">   * container element and insert all the nodes in place. The call must also</span>
<span class="linenr">322: </span><span class=
"org-doc">   * provide the number of nodes contained in the chunk so that during hydration</span>
<span class="linenr">323: </span><span class=
"org-doc">   * we can know how many nodes the static vnode should adopt.</span>
<span class="linenr">324: </span><span class="org-doc">   *</span>
<span class="linenr">325: </span><span class=
"org-doc">   * The optimization scans a children list that contains hoisted nodes, and</span>
<span class="linenr">326: </span><span class=
"org-doc">   * tries to find the largest chunk of consecutive hoisted nodes before running</span>
<span class="linenr">327: </span><span class=
"org-doc">   * into a non-hoisted node or the end of the list. A chunk is then converted</span>
<span class="linenr">328: </span><span class=
"org-doc">   * into a single static vnode and replaces the hoisted expression of the first</span>
<span class="linenr">329: </span><span class=
"org-doc">   * node in the chunk. Other nodes in the chunk are considered "merged" and</span>
<span class="linenr">330: </span><span class=
"org-doc">   * therefore removed from both the hoist list and the children array.</span>
<span class="linenr">331: </span><span class="org-doc">   *</span>
<span class="linenr">332: </span><span class=
"org-doc">   * This optimization is only performed in Node.js.</span>
<span class="linenr">333: </span><span class="org-doc">   */</span>
<span class="linenr">334: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">stringifyStatic</span> = (children, context, parent) =&gt; {
<span class="linenr">335: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail stringification for slot content</span>
<span class="linenr">336: </span>    <span class=
"org-keyword">if</span> (context.scopes.vSlot &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">337: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">338: </span>    }
<span class="linenr">339: </span>  
<span class="linenr">340: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">nc</span> = <span class=
"org-highlight-numbers-number">0</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">current node count</span>
<span class="linenr">341: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ec</span> = <span class=
"org-highlight-numbers-number">0</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">current element with binding count</span>
<span class="linenr">342: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">currentChunk</span> = []
<span class="linenr">343: </span>  
<span class="linenr">344: </span>    logg(<span class=
"org-string">`stringifyStatic - children.length = ${children.length}`</span>)
<span class="linenr">345: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">stringifyCurrentChunk</span> = (currentIndex) =&gt; {
<span class="linenr">346: </span>      <span class=
"org-keyword">if</span> (
<span class=
"linenr">347: </span>        nc &gt;= StringifyThresholds.NODE_COUNT ||
<span class=
"linenr">348: </span>        ec &gt;= StringifyThresholds.ELEMENT_WITH_BINDING_COUNT
<span class="linenr">349: </span>      ) {
<span class="linenr">350: </span>        logg(<span class=
"org-string">`stringifyCurrentChunk - index = ${currentIndex}`</span>)
<span class="linenr">351: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">combine all currently eligible nodes into a single static vnode call</span>
<span class="linenr">352: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">staticCall</span> = createCallExpression(context.helper(CREATE_STATIC), [
<span class="linenr">353: </span>          JSON.stringify(
<span class=
"linenr">354: </span>            currentChunk.map(node =&gt; stringifyNode(node, context)).join(<span class="org-string">''</span>)
<span class=
"linenr">355: </span>          ).replace(expReplaceRE, <span class=
"org-string">`" + $1 + "`</span>),
<span class="linenr">356: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the 2nd argument indicates the number of DOM nodes this static vnode</span>
<span class="linenr">357: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">will insert / hydrate</span>
<span class=
"linenr">358: </span>          String(currentChunk.length)
<span class="linenr">359: </span>        ])
<span class="linenr">360: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">replace the first node's hoisted expression with the static vnode call</span>
<span class=
"linenr">361: </span>        replaceHoist(currentChunk[<span class=
"org-highlight-numbers-number">0</span>], staticCall, context)
<span class="linenr">362: </span>  
<span class="linenr">363: </span>        <span class=
"org-keyword">if</span> (currentChunk.length &gt; <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr">364: </span>          <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">1</span>; i &lt; currentChunk.length; i++) {
<span class="linenr">365: </span>            <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for the merged nodes, set their hoisted expression to null</span>
<span class=
"linenr">366: </span>            replaceHoist(currentChunk[i], <span class="org-constant">null</span>, context)
<span class="linenr">367: </span>          }
<span class="linenr">368: </span>  
<span class="linenr">369: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also remove merged nodes from children</span>
<span class="linenr">370: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">deleteCount</span> = currentChunk.length - <span class="org-highlight-numbers-number">1</span>
<span class=
"linenr">371: </span>          children.splice(currentIndex - currentChunk.length + <span class="org-highlight-numbers-number">1</span>, deleteCount)
<span class="linenr">372: </span>          <span class=
"org-keyword">return</span> deleteCount
<span class="linenr">373: </span>        }
<span class="linenr">374: </span>      }
<span class="linenr">375: </span>      <span class=
"org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">376: </span>    }
<span class="linenr">377: </span>  
<span class="linenr">378: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">379: </span>    <span class=
"org-keyword">for</span> (; i &lt; children.length; i++) {
<span class="linenr">380: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[i]
<span class="linenr">381: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hoisted</span> = getHoistedNode(child)
<span class="linenr">382: </span>      <span class=
"org-keyword">if</span> (hoisted) {
<span class="linenr">383: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">presence of hoisted means child must be a stringifiable node</span>
<span class="linenr">384: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">node</span> = child
<span class="linenr">385: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">result</span> = analyzeNode(node)
<span class="linenr">386: </span>        <span class=
"org-keyword">if</span> (result) {
<span class="linenr">387: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node is stringifiable, record state</span>
<span class=
"linenr">388: </span>          nc += result[<span class="org-highlight-numbers-number">0</span>]
<span class=
"linenr">389: </span>          ec += result[<span class="org-highlight-numbers-number">1</span>]
<span class="linenr">390: </span>          currentChunk.push(node)
<span class="linenr">391: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">392: </span>        }
<span class="linenr">393: </span>      }
<span class="linenr">394: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we only reach here if we ran into a node that is not stringifiable</span>
<span class="linenr">395: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check if currently analyzed nodes meet criteria for stringification.</span>
<span class="linenr">396: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">adjust iteration index</span>
<span class=
"linenr">397: </span>      i -= stringifyCurrentChunk(i)
<span class="linenr">398: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">reset state</span>
<span class="linenr">399: </span>      nc = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">400: </span>      ec = <span class=
"org-highlight-numbers-number">0</span>
<span class=
"linenr">401: </span>      currentChunk.length = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">402: </span>    }
<span class="linenr">403: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in case the last node was also stringifiable</span>
<span class="linenr">404: </span>    stringifyCurrentChunk(i)
<span class="linenr">405: </span>  }
<span class="linenr">406: </span>  
<span class="linenr">407: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">getHoistedNode</span> = (node) =&gt;
<span class=
"linenr">408: </span>    ((node.type === NodeTypes.ELEMENT &amp;& node.tagType === ElementTypes.ELEMENT) ||
<span class=
"linenr">409: </span>      node.type == NodeTypes.TEXT_CALL) &amp;&
<span class="linenr">410: </span>    node.codegenNode &amp;&
<span class=
"linenr">411: </span>    node.codegenNode.type === NodeTypes.SIMPLE_EXPRESSION &amp;&
<span class="linenr">412: </span>    node.codegenNode.hoisted
<span class="linenr">413: </span>  
<span class="linenr">414: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">dataAriaRE</span> = <span class=
"org-string">/^(data|aria)-/</span>
<span class="linenr">415: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStringifiableAttr</span> = (name, ns) =&gt; {
<span class="linenr">416: </span>    <span class=
"org-keyword">return</span> (
<span class="linenr">417: </span>      (ns === DOMNamespaces.HTML
<span class="linenr">418: </span>        ? isKnownHtmlAttr(name)
<span class="linenr">419: </span>        : ns === DOMNamespaces.SVG
<span class="linenr">420: </span>        ? isKnownSvgAttr(name)
<span class="linenr">421: </span>        : <span class=
"org-constant">false</span>) || dataAriaRE.test(name)
<span class="linenr">422: </span>    )
<span class="linenr">423: </span>  }
<span class="linenr">424: </span>  
<span class="linenr">425: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">replaceHoist</span> = (node,replacement,context) =&gt; {
<span class="linenr">426: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hoistToReplace</span> = node.codegenNode.hoisted
<span class=
"linenr">427: </span>    context.hoists[context.hoists.indexOf(hoistToReplace)] = replacement
<span class="linenr">428: </span>  }
<span class="linenr">429: </span>  
<span class="linenr">430: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isNonStringifiable</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr">431: </span>    <span class=
"org-string">`caption,thead,tr,th,tbody,td,tfoot,colgroup,col`</span>
<span class="linenr">432: </span>  )
<span class="linenr">433: </span>  
<span class="linenr">434: </span>  <span class="org-doc">/**</span>
<span class="linenr">435: </span><span class=
"org-doc">   * for a hoisted node, analyze it and return:</span>
<span class="linenr">436: </span><span class=
"org-doc">   * - false: bailed (contains non-stringifiable props or runtime constant)</span>
<span class="linenr">437: </span><span class=
"org-doc">   * - [nc, ec] where</span>
<span class="linenr">438: </span><span class=
"org-doc">   *   - nc is the number of nodes inside</span>
<span class="linenr">439: </span><span class=
"org-doc">   *   - ec is the number of element with bindings inside</span>
<span class="linenr">440: </span><span class="org-doc">   */</span>
<span class="linenr">441: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">analyzeNode</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">442: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT &amp;& isNonStringifiable(node.tag)) {
<span class="linenr">443: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">444: </span>    }
<span class="linenr">445: </span>  
<span class="linenr">446: </span>    <span class=
"org-keyword">if</span> (node.type === NodeTypes.TEXT_CALL) {
<span class="linenr">447: </span>      <span class=
"org-keyword">return</span> [<span class=
"org-highlight-numbers-number">1</span>, <span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">448: </span>    }
<span class="linenr">449: </span>  
<span class="linenr">450: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">nc</span> = <span class=
"org-highlight-numbers-number">1</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node count</span>
<span class="linenr">451: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ec</span> = node.props.length &gt; <span class=
"org-highlight-numbers-number">0</span> ? <span class=
"org-highlight-numbers-number">1</span> : <span class=
"org-highlight-numbers-number">0</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">element w/ binding count</span>
<span class="linenr">452: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">bailed</span> = <span class=
"org-constant">false</span>
<span class="linenr">453: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bail</span> = () =&gt; {
<span class="linenr">454: </span>      bailed = <span class=
"org-constant">true</span>
<span class="linenr">455: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">456: </span>    }
<span class="linenr">457: </span>  
<span class="linenr">458: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO:</span></span></span><span class=
"org-comment"> check for cases where using innerHTML will result in different</span>
<span class="linenr">459: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">output compared to imperative node insertions.</span>
<span class="linenr">460: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">probably only need to check for most common case</span>
<span class="linenr">461: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">i.e. non-phrasing-content tags inside `&lt;p&gt;`</span>
<span class="linenr">462: </span>    <span class=
"org-keyword">function</span> <span class=
"org-function-name">walk</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">463: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">464: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">465: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail on non-attr bindings</span>
<span class="linenr">466: </span>        <span class=
"org-keyword">if</span> (
<span class=
"linenr">467: </span>          p.type === NodeTypes.ATTRIBUTE &amp;&
<span class=
"linenr">468: </span>          !isStringifiableAttr(p.name, node.ns)
<span class="linenr">469: </span>        ) {
<span class="linenr">470: </span>          <span class=
"org-keyword">return</span> bail()
<span class="linenr">471: </span>        }
<span class="linenr">472: </span>        <span class=
"org-keyword">if</span> (p.type === NodeTypes.DIRECTIVE &amp;& p.name === <span class="org-string">'bind'</span>) {
<span class="linenr">473: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail on non-attr bindings</span>
<span class="linenr">474: </span>          <span class=
"org-keyword">if</span> (
<span class="linenr">475: </span>            p.arg &amp;&
<span class=
"linenr">476: </span>            (p.arg.type === NodeTypes.COMPOUND_EXPRESSION ||
<span class=
"linenr">477: </span>              (p.arg.isStatic &amp;& !isStringifiableAttr(p.arg.content, node.ns)))
<span class="linenr">478: </span>          ) {
<span class="linenr">479: </span>            <span class=
"org-keyword">return</span> bail()
<span class="linenr">480: </span>          }
<span class="linenr">481: </span>          <span class=
"org-keyword">if</span> (
<span class="linenr">482: </span>            p.exp &amp;&
<span class=
"linenr">483: </span>            (p.exp.type === NodeTypes.COMPOUND_EXPRESSION ||
<span class=
"linenr">484: </span>              p.exp.constType &lt; ConstantTypes.CAN_STRINGIFY)
<span class="linenr">485: </span>          ) {
<span class="linenr">486: </span>            <span class=
"org-keyword">return</span> bail()
<span class="linenr">487: </span>          }
<span class="linenr">488: </span>        }
<span class="linenr">489: </span>      }
<span class="linenr">490: </span>      <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class="linenr">491: </span>        nc++
<span class="linenr">492: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = node.children[i]
<span class="linenr">493: </span>        <span class=
"org-keyword">if</span> (child.type === NodeTypes.ELEMENT) {
<span class="linenr">494: </span>          <span class=
"org-keyword">if</span> (child.props.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">495: </span>            ec++
<span class="linenr">496: </span>          }
<span class="linenr">497: </span>          walk(child)
<span class="linenr">498: </span>          <span class=
"org-keyword">if</span> (bailed) {
<span class="linenr">499: </span>            <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">500: </span>          }
<span class="linenr">501: </span>        }
<span class="linenr">502: </span>      }
<span class="linenr">503: </span>      <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">504: </span>    }
<span class="linenr">505: </span>  
<span class="linenr">506: </span>    <span class=
"org-keyword">return</span> walk(node) ? [nc, ec] : <span class=
"org-constant">false</span>
<span class="linenr">507: </span>  }
<span class="linenr">508: </span>  
<span class="linenr">509: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyNode</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">510: </span>    <span class=
"org-keyword">if</span> (isString(node)) {
<span class="linenr">511: </span>      <span class=
"org-keyword">return</span> node
<span class="linenr">512: </span>    }
<span class="linenr">513: </span>    <span class=
"org-keyword">if</span> (isSymbol(node)) {
<span class="linenr">514: </span>      <span class=
"org-keyword">return</span> <span class="org-string">``</span>
<span class="linenr">515: </span>    }
<span class="linenr">516: </span>    <span class=
"org-keyword">switch</span> (node.type) {
<span class="linenr">517: </span>      <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr">518: </span>        <span class=
"org-keyword">return</span> stringifyElement(node, context)
<span class="linenr">519: </span>      <span class=
"org-keyword">case</span> NodeTypes.TEXT:
<span class="linenr">520: </span>        <span class=
"org-keyword">return</span> escapeHtml(node.content)
<span class="linenr">521: </span>      <span class=
"org-keyword">case</span> NodeTypes.COMMENT:
<span class="linenr">522: </span>        <span class=
"org-keyword">return</span> <span class=
"org-string">`&lt;!--${escapeHtml(node.content)}--&gt;`</span>
<span class="linenr">523: </span>      <span class=
"org-keyword">case</span> NodeTypes.INTERPOLATION:
<span class="linenr">524: </span>        <span class=
"org-keyword">return</span> escapeHtml(toDisplayString(evaluateConstant(node.content)))
<span class="linenr">525: </span>      <span class=
"org-keyword">case</span> NodeTypes.COMPOUND_EXPRESSION:
<span class="linenr">526: </span>        <span class=
"org-keyword">return</span> escapeHtml(evaluateConstant(node))
<span class="linenr">527: </span>      <span class=
"org-keyword">case</span> NodeTypes.TEXT_CALL:
<span class="linenr">528: </span>        <span class=
"org-keyword">return</span> stringifyNode(node.content, context)
<span class="linenr">529: </span>      <span class=
"org-keyword">default</span>:
<span class="linenr">530: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">static trees will not contain if/for nodes</span>
<span class="linenr">531: </span>        <span class=
"org-keyword">return</span> <span class="org-string">''</span>
<span class="linenr">532: </span>    }
<span class="linenr">533: </span>  }
<span class="linenr">534: </span>  
<span class="linenr">535: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyElement</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">536: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">res</span> = <span class=
"org-string">`&lt;${node.tag}`</span>
<span class="linenr">537: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">538: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">539: </span>      <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">540: </span>        res += <span class=
"org-string">` ${p.name}`</span>
<span class="linenr">541: </span>        <span class=
"org-keyword">if</span> (p.value) {
<span class="linenr">542: </span>          res += <span class=
"org-string">`="${escapeHtml(p.value.content)}"`</span>
<span class="linenr">543: </span>        }
<span class="linenr">544: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (p.type === NodeTypes.DIRECTIVE &amp;& p.name === <span class="org-string">'bind'</span>) {
<span class="linenr">545: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> = p.exp
<span class="linenr">546: </span>        <span class=
"org-keyword">if</span> (exp.content[<span class=
"org-highlight-numbers-number">0</span>] === <span class=
"org-string">'_'</span>) {
<span class="linenr">547: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">internally generated string constant references</span>
<span class="linenr">548: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">e.g. imported URL strings via compiler-sfc transformAssetUrl plugin</span>
<span class="linenr">549: </span>          res += <span class=
"org-string">` ${p.arg.content}="__VUE_EXP_START__${</span>
<span class="linenr">550: </span><span class=
"org-string">            exp.content</span>
<span class="linenr">551: </span><span class=
"org-string">          }__VUE_EXP_END__"`</span>
<span class="linenr">552: </span>          <span class=
"org-keyword">continue</span>
<span class="linenr">553: </span>        }
<span class="linenr">554: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">constant v-bind, e.g. :foo="1"</span>
<span class="linenr">555: </span>        <span class=
"org-keyword">let</span> <span class=
"org-variable-name">evaluated</span> = evaluateConstant(exp)
<span class="linenr">556: </span>        <span class=
"org-keyword">if</span> (evaluated != <span class=
"org-constant">null</span>) {
<span class="linenr">557: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">arg</span> = p.arg &amp;& p.arg.content
<span class="linenr">558: </span>          <span class=
"org-keyword">if</span> (arg === <span class=
"org-string">'class'</span>) {
<span class=
"linenr">559: </span>            evaluated = normalizeClass(evaluated)
<span class="linenr">560: </span>          } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (arg === <span class=
"org-string">'style'</span>) {
<span class=
"linenr">561: </span>            evaluated = stringifyStyle(normalizeStyle(evaluated))
<span class="linenr">562: </span>          }
<span class="linenr">563: </span>          res += <span class=
"org-string">` ${p.arg.content}="${escapeHtml(evaluated)}"`</span>
<span class="linenr">564: </span>        }
<span class="linenr">565: </span>      }
<span class="linenr">566: </span>    }
<span class="linenr">567: </span>    <span class=
"org-keyword">if</span> (context.scopeId) {
<span class="linenr">568: </span>      res += <span class=
"org-string">` ${context.scopeId}`</span>
<span class="linenr">569: </span>    }
<span class="linenr">570: </span>    res += <span class=
"org-string">`&gt;`</span>
<span class="linenr">571: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class=
"linenr">572: </span>      res += stringifyNode(node.children[i], context)
<span class="linenr">573: </span>    }
<span class="linenr">574: </span>    <span class=
"org-keyword">if</span> (!isVoidTag(node.tag)) {
<span class="linenr">575: </span>      res += <span class=
"org-string">`&lt;/${node.tag}&gt;`</span>
<span class="linenr">576: </span>    }
<span class="linenr">577: </span>    <span class=
"org-keyword">return</span> res
<span class="linenr">578: </span>  }
<span class="linenr">579: </span>  
<span class="linenr">580: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">__UNSAFE__</span>
<span class="linenr">581: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Reason: eval.</span>
<span class="linenr">582: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">It's technically safe to eval because only constant expressions are possible</span>
<span class="linenr">583: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">here, e.g. `{{ 1 }}` or `{{ 'foo' }}`</span>
<span class="linenr">584: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in addition, constant exps bail on presence of parens so you can't even</span>
<span class="linenr">585: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">run JSFuck in here. But we mark it unsafe for security review purposes.</span>
<span class="linenr">586: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(see compiler-core/src/transformExpressions)</span>
<span class="linenr">587: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">evaluateConstant</span>(<span class=
"org-variable-name">exp</span>) {
<span class="linenr">588: </span>    <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">589: </span>      <span class=
"org-keyword">return</span> <span class=
"org-keyword">new</span> <span class=
"org-type">Function</span>(<span class=
"org-string">`return ${exp.content}`</span>)()
<span class="linenr">590: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">591: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">compound</span>
<span class="linenr">592: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">res</span> = <span class="org-string">``</span>
<span class=
"linenr">593: </span>      exp.children.forEach(c =&gt; {
<span class="linenr">594: </span>        <span class=
"org-keyword">if</span> (isString(c) || isSymbol(c)) {
<span class="linenr">595: </span>          <span class=
"org-keyword">return</span>
<span class="linenr">596: </span>        }
<span class="linenr">597: </span>        <span class=
"org-keyword">if</span> (c.type === NodeTypes.TEXT) {
<span class="linenr">598: </span>          res += c.content
<span class="linenr">599: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (c.type === NodeTypes.INTERPOLATION) {
<span class=
"linenr">600: </span>          res += toDisplayString(evaluateConstant(c.content))
<span class="linenr">601: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">602: </span>          res += evaluateConstant(c)
<span class="linenr">603: </span>        }
<span class="linenr">604: </span>      })
<span class="linenr">605: </span>      <span class=
"org-keyword">return</span> res
<span class="linenr">606: </span>    }
<span class="linenr">607: </span>  }
<span class="linenr">608: </span>  
<span class="linenr">609: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">DOMDirectiveTransforms</span> = {
<span class="linenr">610: </span>    cloak: noopDirectiveTransform,
<span class="linenr">611: </span>    html: transformVHtml,
<span class="linenr">612: </span>    text: transformVText,
<span class=
"linenr">613: </span>    model: transformModel, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">override compiler-core</span>
<span class="linenr">614: </span>    on: transformOn, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">override compiler-core</span>
<span class="linenr">615: </span>    show: transformShow
<span class="linenr">616: </span>  }
<span class="linenr">617: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">DOMNodeTransforms</span> = [
<span class="linenr">618: </span>    transformStyle,
<span class=
"linenr">619: </span>    ...(__DEV__ ? [warnTransitionChildren] : [])
<span class="linenr">620: </span>  ]
<span class="linenr">621: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">compile</span>(<span class=
"org-variable-name">template</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr">622: </span>    <span class=
"org-keyword">return</span> baseCompile(
<span class="linenr">623: </span>      template,
<span class=
"linenr">624: </span>      extend({}, parserOptions, options, {
<span class="linenr">625: </span>        nodeTransforms: [
<span class="linenr">626: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ignore &lt;script&gt; and &lt;tag&gt;</span>
<span class="linenr">627: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this is not put inside DOMNodeTransforms because that list is used</span>
<span class="linenr">628: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">by compiler-ssr to generate vnode fallback branches</span>
<span class="linenr">629: </span>          ignoreSideEffectTags,
<span class="linenr">630: </span>          ...DOMNodeTransforms,
<span class=
"linenr">631: </span>          ...(options.nodeTransforms || [])
<span class="linenr">632: </span>        ],
<span class=
"linenr">633: </span>        directiveTransforms: extend(
<span class="linenr">634: </span>          {},
<span class="linenr">635: </span>          DOMDirectiveTransforms,
<span class=
"linenr">636: </span>          options.directiveTransforms || {}
<span class="linenr">637: </span>        ),
<span class=
"linenr">638: </span>        transformHoist: __BROWSER__ ? <span class="org-constant">null</span> : stringifyStatic
<span class="linenr">639: </span>      })
<span class="linenr">640: </span>    )
<span class="linenr">641: </span>  }
<span class="linenr">642: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">parse</span>(<span class=
"org-variable-name">template</span>, <span class=
"org-variable-name">options</span> = {}) {
<span class="linenr">643: </span>    <span class=
"org-keyword">return</span> baseParse(template, extend({}, parserOptions, options))
<span class="linenr">644: </span>  }
<span class="linenr">645: </span>
<span class="linenr">646: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">647: </span>    DOMNodeTransforms,
<span class="linenr">648: </span>    DOMDirectiveTransforms,
<span class="linenr">649: </span>    compile,
<span class="linenr">650: </span>    parse,
<span class="linenr">651: </span>    transformStyle,
<span class="linenr">652: </span>  }
<span class="linenr">653: </span>}())
</pre>
          </div>
        </details>
        <p>test utils from <a href=
        "../../../../.gclrc/org/roam/build_your_own_vue_compiler_core.html#ID-5eff117f-92ba-490a-ba9c-e5f59e0cbe47">
        build your own vue compiler-core</a>:</p>
        <div class="org-src-container">
          <pre class="src src-js" id=
          "orgd372417">&lt;&lt;globalVars&gt;&gt;
&lt;&lt;compiler-core&gt;&gt;
</pre>
        </div>
        <p>test utils:</p>
        <div class="org-src-container">
          <pre class="src src-js" id=
          "orgd29792a">&lt;&lt;cc-test-utils&gt;&gt;
&lt;&lt;globalVarsDom&gt;&gt;
&lt;&lt;compiler-dom&gt;&gt;
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-org8137a12" class="outline-2">
      <h2 id="org8137a12"><span class="section-number-2">2.</span>
      transforms</h2>
      <div class="outline-text-2" id="text-2">
        <div class="org-src-container">
          <pre class="src src-js" id="org955f06f"><span class=
          "linenr">1: </span><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">DOMDirectiveTransforms</span> = {
<span class="linenr">2: </span>  cloak: noopDirectiveTransform,
<span class="linenr">3: </span>  html: transformVHtml,
<span class="linenr">4: </span>  text: transformVText,
<span class=
"linenr">5: </span>  model: transformModel, <span class="org-comment-delimiter">// </span><span class="org-comment">override compiler-core</span>
<span class="linenr">6: </span>  on: transformOn, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">override compiler-core</span>
<span class="linenr">7: </span>  show: transformShow
<span class="linenr">8: </span>}
</pre>
        </div>
        <div class="org-src-container">
          <pre class="src src-js" id="org1bb0c15"><span class=
          "linenr">1: </span><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">DOMNodeTransforms</span> = [
<span class="linenr">2: </span>  transformStyle,
<span class=
"linenr">3: </span>  ...(__DEV__ ? [warnTransitionChildren] : [])
<span class="linenr">4: </span>]
</pre>
        </div>
      </div>
      <div id="outline-container-orgd77600a" class="outline-3">
        <h3 id="orgd77600a"><span class=
        "section-number-3">2.1.</span> style</h3>
        <div class="outline-text-3" id="text-2-1">
          <p>compiler-dom 之前：</p>
          <div class="org-src-container">
            <pre class="src src-js" id="org7e066e7"><span class=
            "linenr">1: </span>&lt;&lt;cc-test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> { baseCompile } = compilerCore
<span class="linenr">4: </span>logOff()
<span class="linenr">5: </span><span class=
"org-keyword">const</span> { code } = baseCompile(<span class=
"org-string">'&lt;div style="width:200px" :style="{height: `200px`}" /&gt;'</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">6: </span>logOn()
<span class="linenr">7: </span>logg(<span class=
"org-string">'&lt;div style="width:200px" /&gt;'</span>, code)
</pre>
          </div>
          <p>对 style 属性进行加工处理，字符串拆成对象，然后合并到，同时支持多种使用方式</p>
          <ol class="org-ol">
            <li><code>&lt;div style="width:100px"&gt;</code> =&gt;
            <code>{width:'100px'}</code></li>
            <li><code>&lt;div :style="{width:'100px'}"&gt;</code>
            =&gt; <code>{width:'100px'}</code></li>
            <li><code>&lt;div :style="{width:'100px'}
            style="height:100px"&gt;</code> =&gt;
            <code>{width:'100px',height:'100px'}</code></li>
          </ol>
          <div class="org-src-container">
            <pre class="src src-js" id="orgcc35511"><span class=
            "linenr"> 1: </span>
<span class="linenr"> 2: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Parse inline CSS strings for static style attributes into an object.</span>
<span class="linenr"> 3: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">This is a NodeTransform since it works on the static `style` attribute and</span>
<span class="linenr"> 4: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">converts it into a dynamic equivalent:</span>
<span class="linenr"> 5: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">style="color: red" -&gt; :style='{ "color": "red" }'</span>
<span class="linenr"> 6: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">It is then processed by `transformElement` and included in the generated</span>
<span class="linenr"> 7: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">props.</span>
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformStyle</span> = node =&gt; {
<span class="linenr"> 9: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT) {
<span class=
"linenr">10: </span>    node.props.forEach((p, i) =&gt; {
<span class="linenr">11: </span>      <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE &amp;& p.name === <span class="org-string">'style'</span> &amp;& p.value) {
<span class="linenr">12: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">replace p with an expression node</span>
<span class="linenr">13: </span>        node.props[i] = {
<span class=
"linenr">14: </span>          type: NodeTypes.DIRECTIVE,
<span class="linenr">15: </span>          name: <span class=
"org-string">`bind`</span>,
<span class=
"linenr">16: </span>          arg: createSimpleExpression(<span class="org-string">`style`</span>, <span class="org-constant">true</span>, p.loc),
<span class=
"linenr">17: </span>          exp: parseInlineCSS(p.value.content, p.loc),
<span class="linenr">18: </span>          modifiers: [],
<span class="linenr">19: </span>          loc: p.loc
<span class="linenr">20: </span>        }
<span class="linenr">21: </span>      }
<span class="linenr">22: </span>    })
<span class="linenr">23: </span>  }
<span class="linenr">24: </span>}
<span class="linenr">25: </span>
<span class="linenr">26: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">parseInlineCSS</span> = (cssText, loc) =&gt; {
<span class="linenr">27: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">normalized</span> = parseStringStyle(cssText)
<span class="linenr">28: </span>  <span class=
"org-keyword">return</span> createSimpleExpression(
<span class="linenr">29: </span>    JSON.stringify(normalized),
<span class="linenr">30: </span>    <span class=
"org-constant">false</span>,
<span class="linenr">31: </span>    loc,
<span class="linenr">32: </span>    ConstantTypes.CAN_STRINGIFY
<span class="linenr">33: </span>  )
<span class="linenr">34: </span>}
</pre>
          </div>
          <p>将字符串解析成对象 <code>"width:100px"</code> =&gt; <code>{
          width: '100px' }</code></p>
          <p>将对象转成字符串 <code>{ width: '100px' }</code> =&gt;
          <code>"width:100px"</code></p>
          <p>解析 style 的值，可能是 <code>"width:100px"</code> 或
          <code>{width:'100px'}</code> 也可以是 <code>['width:100px',
          {height:'100px'}]</code> 的混合方式，最终都会被解析成对象
          <code>{width:'100px', height: '100px'}</code> 。</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr"> 1: </span>&lt;&lt;test-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">const</span> { parseStringStyle, stringifyStyle, normalizeStyle } = compilerDom
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">pss</span> = s =&gt; parseStringStyle(s)
<span class="linenr"> 5: </span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">r</span> = pss(<span class=
"org-string">'width:100px;height:100px'</span>)
<span class="linenr"> 6: </span>logg(<span class=
"org-string">'parseStringStyle'</span>, r)
<span class="linenr"> 7: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">sfs</span> = s =&gt; stringifyStyle(s)
<span class="linenr"> 8: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">s</span> = sfs(r)
<span class="linenr"> 9: </span>logg(<span class=
"org-string">'stringifyStyle'</span>, s)
<span class="linenr">10: </span>logg(<span class=
"org-string">'normalizeStyle'</span>, normalizeStyle([r, s, <span class="org-string">'font-size:12px'</span>, { <span class="org-string">'line-height'</span>: <span class="org-highlight-numbers-number">1.2</span> }]))
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span><span class=
"org-keyword">const</span> { compile } = compilerDom
<span class="linenr">4: </span>logOff()
<span class="linenr">5: </span><span class=
"org-keyword">const</span> { code } = compile(<span class=
"org-string">'&lt;div style="width:200px" :style="{height: `200px`}" /&gt;'</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">6: </span>logOn()
<span class="linenr">7: </span>logg(<span class=
"org-string">'&lt;div style="width:200px" /&gt;'</span>, code)
</pre>
          </div>
          <p>注意与 <a href="#org7e066e7">实现 compiler-dom 之前测试结果</a>
          对比结果，会发现后者的 <code>style</code> 都会被转成对 象形式。</p>
          <p>之前：</p>
          <div class="org-src-container">
            <pre class="src src-js"> style: _normalizeStyle([
   <span class="org-string">"width:200px"</span>,
   {height: <span class="org-string">`200px`</span>}
 ])
</pre>
          </div>
          <p>之后：</p>
          <div class="org-src-container">
            <pre class="src src-js">style: _normalizeStyle([
  {<span class="org-string">"width"</span>:<span class=
"org-string">"200px"</span>},
  {height: <span class="org-string">`200px`</span>}
])
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org9e1ea19" class="outline-3">
        <h3 id="org9e1ea19"><span class=
        "section-number-3">2.2.</span> v-html</h3>
        <div class="outline-text-3" id="text-2-2">
          <div class="org-src-container">
            <pre class="src src-js" id="orgf5d5345"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">transformVHtml</span> = (dir, node, context) =&gt; {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> { exp, loc } = dir
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (!exp) {
<span class="linenr"> 4: </span>    logg(<span class=
"org-string">"v-html no exp"</span>)
<span class="linenr"> 5: </span>  }
<span class="linenr"> 6: </span>  <span class=
"org-keyword">if</span> (node.children.length) {
<span class="linenr"> 7: </span>    logg(<span class=
"org-string">'v-html can not has children'</span>)
<span class=
"linenr"> 8: </span>    node.children.length = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 9: </span>  }
<span class="linenr">10: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">11: </span>    props: [
<span class="linenr">12: </span>      createObjectProperty(
<span class=
"linenr">13: </span>        createSimpleExpression(<span class=
"org-string">`innerHTML`</span>, <span class=
"org-constant">true</span>, loc),
<span class=
"linenr">14: </span>        exp || createSimpleExpression(<span class="org-string">''</span>, <span class="org-constant">true</span>)
<span class="linenr">15: </span>      )
<span class="linenr">16: </span>    ]
<span class="linenr">17: </span>  }
<span class="linenr">18: </span>}
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <p>before: 不会被处理</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;cc-test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = baseCompile(<span class=
"org-string">"&lt;div v-html='foo'&gt;&lt;span/&gt;&lt;/div&gt;"</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>logg(<span class=
"org-string">'v-html'</span>, code)
</pre>
          </div>
          <p>after:</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = compile(<span class=
"org-string">"&lt;div v-html='foo'&gt;&lt;span/&gt;&lt;/div&gt;"</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>logg(<span class=
"org-string">'v-html'</span>, code)
</pre>
          </div>
          <p>注意看前后的结果， compile-core 阶段是没有对 v-html 进行处理的，且 after 结果中
          的 <code>&lt;span/&gt;</code> 已经没有了，且增加了 <code>{ innerHTML
          }</code> 属性。</p>
        </div>
      </div>
      <div id="outline-container-org643a510" class="outline-3">
        <h3 id="org643a510"><span class=
        "section-number-3">2.3.</span> v-text</h3>
        <div class="outline-text-3" id="text-2-3">
          <div class="org-src-container">
            <pre class="src src-js" id="org94fde9a"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">transformVText</span> = (dir, node, context) =&gt; {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> { exp, loc } = dir
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (!exp) {
<span class="linenr"> 4: </span>    logg(<span class=
"org-string">'v-text no exp'</span>)
<span class="linenr"> 5: </span>  }
<span class="linenr"> 6: </span>  <span class=
"org-keyword">if</span> (node.children.length) {
<span class="linenr"> 7: </span>    logg(<span class=
"org-string">'v-text can not have children'</span>)
<span class=
"linenr"> 8: </span>    node.children.length = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 9: </span>  }
<span class="linenr">10: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr">11: </span>    props: [
<span class="linenr">12: </span>      createObjectProperty(
<span class=
"linenr">13: </span>        createSimpleExpression(<span class=
"org-string">`textContent`</span>, <span class=
"org-constant">true</span>),
<span class="linenr">14: </span>        exp
<span class="linenr">15: </span>          ? createCallExpression(
<span class=
"linenr">16: </span>              context.helperString(TO_DISPLAY_STRING),
<span class="linenr">17: </span>              [exp],
<span class="linenr">18: </span>              loc
<span class="linenr">19: </span>            )
<span class=
"linenr">20: </span>          : createSimpleExpression(<span class=
"org-string">''</span>, <span class="org-constant">true</span>)
<span class="linenr">21: </span>      )
<span class="linenr">22: </span>    ]
<span class="linenr">23: </span>  }
<span class="linenr">24: </span>}
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <p>before: compiler-core 中也没有对 v-text 指令的处理</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;cc-test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = baseCompile(<span class=
"org-string">"&lt;div v-text='foo'&gt;&lt;span/&gt;&lt;/div&gt;"</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>logg(<span class=
"org-string">'v-text'</span>, code)
</pre>
          </div>
          <p>after: <code>&lt;span/&gt;</code> 所有子节点都会被删除，增加
          <code>{ textContent }</code> 属性。</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = compile(<span class=
"org-string">"&lt;div v-text='foo'&gt;&lt;span/&gt;&lt;/div&gt;"</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>logg(<span class=
"org-string">'v-text'</span>, code)
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org032264e" class="outline-3">
        <h3 id="org032264e"><span class=
        "section-number-3">2.4.</span> v-model</h3>
        <div class="outline-text-3" id="text-2-4">
          <div class="org-src-container">
            <pre class="src src-js" id="orgf13f87c"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">transformModel</span> = (dir, node, context) =&gt; {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">baseResult</span> = transformModel(dir, node, context)
<span class="linenr"> 3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">base transform has errors OR component v-model (only need props)</span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">if</span> (!baseResult.props.length || node.tagType === ElementTypes.COMPONENT) {
<span class="linenr"> 5: </span>    <span class=
"org-keyword">return</span> baseResult
<span class="linenr"> 6: </span>  }
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span>  <span class=
"org-keyword">if</span> (dir.arg) {
<span class="linenr"> 9: </span>    logg(<span class=
"org-string">"transfromModel - X_V_MODEL_ARG_ON_ELEMENT"</span>)
<span class="linenr">10: </span>  }
<span class="linenr">11: </span>
<span class="linenr">12: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">checkDuplicatedValue</span>() {
<span class="linenr">13: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">value</span> = findProp(node, <span class=
"org-string">'value'</span>)
<span class="linenr">14: </span>    <span class=
"org-keyword">if</span> (value) {
<span class="linenr">15: </span>      logg(<span class=
"org-string">"transfromModel - X_V_MODEL_UNNECESSARY_VALUE"</span>)
<span class="linenr">16: </span>    }
<span class="linenr">17: </span>  }
<span class="linenr">18: </span>
<span class="linenr">19: </span>  <span class=
"org-keyword">const</span> { tag } = node
<span class="linenr">20: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isCustomElement</span> = context.isCustomElement(tag)
<span class="linenr">21: </span>  <span class=
"org-keyword">if</span> (
<span class="linenr">22: </span>    tag === <span class=
"org-string">'input'</span> ||
<span class="linenr">23: </span>    tag === <span class=
"org-string">'textarea'</span> ||
<span class="linenr">24: </span>    tag === <span class=
"org-string">'select'</span> ||
<span class="linenr">25: </span>    isCustomElement
<span class="linenr">26: </span>  ) {
<span class="linenr">27: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">directiveToUse</span> = V_MODEL_TEXT
<span class="linenr">28: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">isInvalidType</span> = <span class=
"org-constant">false</span>
<span class="linenr">29: </span>    <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'input'</span> || isCustomElement) {
<span class="linenr">30: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">type</span> = findProp(node, <span class=
"org-string">`type`</span>)
<span class="linenr">31: </span>      <span class=
"org-keyword">if</span> (type) {
<span class="linenr">32: </span>        <span class=
"org-keyword">if</span> (type.type === NodeTypes.DIRECTIVE) {
<span class="linenr">33: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">:type="foo"</span>
<span class=
"linenr">34: </span>          directiveToUse = V_MODEL_DYNAMIC
<span class="linenr">35: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (type.value) {
<span class="linenr">36: </span>          <span class=
"org-keyword">switch</span> (type.value.content) {
<span class="linenr">37: </span>            <span class=
"org-keyword">case</span> <span class="org-string">'radio'</span>:
<span class=
"linenr">38: </span>              directiveToUse = V_MODEL_RADIO
<span class="linenr">39: </span>              <span class=
"org-keyword">break</span>
<span class="linenr">40: </span>            <span class=
"org-keyword">case</span> <span class=
"org-string">'checkbox'</span>:
<span class=
"linenr">41: </span>              directiveToUse = V_MODEL_CHECKBOX
<span class="linenr">42: </span>              <span class=
"org-keyword">break</span>
<span class="linenr">43: </span>            <span class=
"org-keyword">case</span> <span class="org-string">'file'</span>:
<span class=
"linenr">44: </span>              isInvalidType = <span class=
"org-constant">true</span>
<span class="linenr">45: </span>              logg(<span class=
"org-string">"[DOM]transformModel - X_V_MODEL_ON_FILE_INPUT_ELEMENT"</span>)
<span class="linenr">46: </span>              <span class=
"org-keyword">break</span>
<span class="linenr">47: </span>            <span class=
"org-keyword">default</span>:
<span class="linenr">48: </span>              <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">text type</span>
<span class=
"linenr">49: </span>              __DEV__ &amp;& checkDuplicatedValue()
<span class="linenr">50: </span>              <span class=
"org-keyword">break</span>
<span class="linenr">51: </span>          }
<span class="linenr">52: </span>        }
<span class="linenr">53: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (hasDynamicKeyVBind(node)) {
<span class="linenr">54: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">element has bindings with dynamic keys, which can possibly contain</span>
<span class="linenr">55: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">"type".</span>
<span class=
"linenr">56: </span>        directiveToUse = V_MODEL_DYNAMIC
<span class="linenr">57: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">58: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">text type</span>
<span class=
"linenr">59: </span>        __DEV__ &amp;& checkDuplicatedValue()
<span class="linenr">60: </span>      }
<span class="linenr">61: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (tag === <span class=
"org-string">'select'</span>) {
<span class=
"linenr">62: </span>      directiveToUse = V_MODEL_SELECT
<span class="linenr">63: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">64: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">textarea</span>
<span class=
"linenr">65: </span>      __DEV__ &amp;& checkDuplicatedValue()
<span class="linenr">66: </span>    }
<span class="linenr">67: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">inject runtime directive</span>
<span class="linenr">68: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">by returning the helper symbol via needRuntime</span>
<span class="linenr">69: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the import will replaced a resolveDirective call.</span>
<span class="linenr">70: </span>    <span class=
"org-keyword">if</span> (!isInvalidType) {
<span class=
"linenr">71: </span>      baseResult.needRuntime = context.helper(directiveToUse)
<span class="linenr">72: </span>    }
<span class="linenr">73: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">74: </span>    logg(<span class=
"org-string">"[DOM]transformModel - X_V_MODEL_ON_INVALID_ELEMENT"</span>)
<span class="linenr">75: </span>  }
<span class="linenr">76: </span>
<span class="linenr">77: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">native vmodel doesn't need the `modelValue` props since they are also</span>
<span class="linenr">78: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">passed to the runtime as `binding.value`. removing it reduces code size.</span>
<span class=
"linenr">79: </span>  baseResult.props = baseResult.props.filter(
<span class="linenr">80: </span>    p =&gt;
<span class="linenr">81: </span>      !(
<span class=
"linenr">82: </span>        p.key.type === NodeTypes.SIMPLE_EXPRESSION &amp;&
<span class=
"linenr">83: </span>        p.key.content === <span class=
"org-string">'modelValue'</span>
<span class="linenr">84: </span>      )
<span class="linenr">85: </span>  )
<span class="linenr">86: </span>
<span class="linenr">87: </span>  <span class=
"org-keyword">return</span> baseResult
<span class="linenr">88: </span>}
</pre>
          </div>
          <ol class="org-ol">
            <li>只处理 input, textarea, select 文本框标签，或自定义的标签</li>
            <li>&lt;input&gt; 标签类型分为 radio 和 checkbox 单复选项框处理，不能使用
            type=’file’ 类型</li>
            <li>&lt;select&gt; 下拉选项框的处理</li>
            <li>过滤掉 transform 之后的 <code>{modelValue: value,
            'onUpdate:value': $event =&gt; value = $event}</code>
            里面的 <code>modelValue：value</code> 属性，因为在 runtime-core
            时期的 <a href="#orgad4a849">withDirectives(</a>)
            处理里面会被绑定到 value 属性上
            </li>
          </ol>
          <p><span style="color:red;">Testing</span></p>
          <p>before:</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;cc-test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = baseCompile(<span class=
"org-string">"&lt;input type='text' v-model='value' /&gt;"</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>log(<span class=
"org-string">'v-model'</span>, code)
</pre>
          </div>
          <p>after: 多了一层包装 <code>_withDirectives()</code></p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = compile(<span class=
"org-string">"&lt;input type='text' v-model='value' /&gt;"</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>log(<span class=
"org-string">'v-model'</span>, code)
</pre>
          </div>
          <p>那来看下 <code>_withDirectives()</code> 里面做了什么？</p>
          <div class="org-src-container">
            <pre class="src src-js" id="orgad4a849"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">withDirectives</span>(<span class=
            "org-variable-name">vnode</span>, <span class=
            "org-variable-name">directives</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">internalInstance</span> = currentRenderingInstance
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (internalInstance === <span class=
"org-constant">null</span>) {
<span class="linenr"> 4: </span>    <span class=
"org-keyword">return</span> vnode
<span class="linenr"> 5: </span>  }
<span class="linenr"> 6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">取当前应用实例</span>
<span class="linenr"> 7: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">instance</span> = getExposeProxy(internalInstance) || internalInstance.proxy
<span class="linenr"> 8: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bindings</span> = vnode.dirs || (vnode.dirs = [])
<span class="linenr"> 9: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; directives.length; i++) {
<span class="linenr">10: </span>
<span class="linenr">11: </span>    <span class=
"org-keyword">let</span> [dir, value, arg, modifiers = EMPTY_OBJ] = directives[i]
<span class="linenr">12: </span>    <span class=
"org-keyword">if</span> (isFunction(dir)) {
<span class="linenr">13: </span>      dir = {
<span class="linenr">14: </span>        mounted: dir,
<span class="linenr">15: </span>        updated: dir
<span class="linenr">16: </span>      }
<span class="linenr">17: </span>    }
<span class="linenr">18: </span>    <span class=
"org-keyword">if</span> (dir.deep) {
<span class="linenr">19: </span>      traverse(value)
<span class="linenr">20: </span>    }
<span class="linenr">21: </span>    bindings.push({
<span class="linenr">22: </span>      dir,
<span class="linenr">23: </span>      instance,
<span class="linenr">24: </span>      value,
<span class="linenr">25: </span>      oldValue: <span class=
"org-keyword">void</span> <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">26: </span>      arg,
<span class="linenr">27: </span>      modifiers
<span class="linenr">28: </span>    })
<span class="linenr">29: </span>  }
<span class="linenr">30: </span>  <span class=
"org-keyword">return</span> vnode
<span class="linenr">31: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org9c909f9" class="outline-3">
        <h3 id="org9c909f9"><span class=
        "section-number-3">2.5.</span> v-on</h3>
        <div class="outline-text-3" id="text-2-5">
          <div class="org-src-container">
            <pre class="src src-js" id="org5117ca4"><span class=
            "linenr">  1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">isEventOptionModifier</span> = <span class=
            "org-comment-delimiter">/*</span><span class=
            "org-comment">#__PURE__</span><span class=
            "org-comment-delimiter">*/</span> makeMap(<span class=
            "org-string">`passive,once,capture`</span>)
<span class="linenr">  2: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isNonKeyModifier</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr">  3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">event propagation management</span>
<span class="linenr">  4: </span>  <span class=
"org-string">`stop,prevent,self,`</span> +
<span class="linenr">  5: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">system modifiers + exact</span>
<span class="linenr">  6: </span>    <span class=
"org-string">`ctrl,shift,alt,meta,exact,`</span> +
<span class="linenr">  7: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">mouse</span>
<span class="linenr">  8: </span>    <span class=
"org-string">`middle`</span>
<span class="linenr">  9: </span>)
<span class="linenr"> 10: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">left & right could be mouse or key modifiers based on event type</span>
<span class="linenr"> 11: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">maybeKeyModifier</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(<span class=
"org-string">'left,right'</span>)
<span class="linenr"> 12: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isKeyboardEvent</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr"> 13: </span>  <span class=
"org-string">`onkeyup,onkeydown,onkeypress`</span>,
<span class="linenr"> 14: </span>  <span class=
"org-constant">true</span>
<span class="linenr"> 15: </span>)
<span class="linenr"> 16: </span>
<span class="linenr"> 17: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">将修饰符分类</span>
<span class="linenr"> 18: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">resolveModifiers</span> = (key, modifiers, context, loc) =&gt; {
<span class="linenr"> 19: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">keyModifiers</span> = []
<span class="linenr"> 20: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">nonKeyModifiers</span> = []
<span class="linenr"> 21: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">eventOptionModifiers</span> = []
<span class="linenr"> 22: </span>
<span class="linenr"> 23: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; modifiers.length; i++) {
<span class="linenr"> 24: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifier</span> = modifiers[i]
<span class="linenr"> 25: </span>
<span class="linenr"> 26: </span>    <span class=
"org-keyword">if</span> (isEventOptionModifier(modifier)) {
<span class="linenr"> 27: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">eventOptionModifiers: modifiers for addEventListener() options,</span>
<span class="linenr"> 28: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">e.g. .passive & .capture</span>
<span class=
"linenr"> 29: </span>      eventOptionModifiers.push(modifier)
<span class="linenr"> 30: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr"> 31: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">runtimeModifiers: modifiers that needs runtime guards</span>
<span class="linenr"> 32: </span>      <span class=
"org-keyword">if</span> (maybeKeyModifier(modifier)) {
<span class="linenr"> 33: </span>        <span class=
"org-keyword">if</span> (isStaticExp(key)) {
<span class="linenr"> 34: </span>          <span class=
"org-keyword">if</span> (isKeyboardEvent(key.content)) {
<span class=
"linenr"> 35: </span>            keyModifiers.push(modifier)
<span class="linenr"> 36: </span>          } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 37: </span>            nonKeyModifiers.push(modifier)
<span class="linenr"> 38: </span>          }
<span class="linenr"> 39: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 40: </span>          keyModifiers.push(modifier)
<span class=
"linenr"> 41: </span>          nonKeyModifiers.push(modifier)
<span class="linenr"> 42: </span>        }
<span class="linenr"> 43: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr"> 44: </span>        <span class=
"org-keyword">if</span> (isNonKeyModifier(modifier)) {
<span class=
"linenr"> 45: </span>          nonKeyModifiers.push(modifier)
<span class="linenr"> 46: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr"> 47: </span>          keyModifiers.push(modifier)
<span class="linenr"> 48: </span>        }
<span class="linenr"> 49: </span>      }
<span class="linenr"> 50: </span>    }
<span class="linenr"> 51: </span>  }
<span class="linenr"> 52: </span>
<span class="linenr"> 53: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr"> 54: </span>    keyModifiers,
<span class="linenr"> 55: </span>    nonKeyModifiers,
<span class="linenr"> 56: </span>    eventOptionModifiers
<span class="linenr"> 57: </span>  }
<span class="linenr"> 58: </span>}
<span class="linenr"> 59: </span>
<span class="linenr"> 60: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">原生 click 事件</span>
<span class="linenr"> 61: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformClick</span> = (key, event) =&gt; {
<span class="linenr"> 62: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStaticClick</span> =
<span class=
"linenr"> 63: </span>    isStaticExp(key) &amp;& key.content.toLowerCase() === <span class="org-string">'onclick'</span>
<span class="linenr"> 64: </span>  <span class=
"org-keyword">return</span> isStaticClick
<span class=
"linenr"> 65: </span>    ? createSimpleExpression(event, <span class="org-constant">true</span>)
<span class=
"linenr"> 66: </span>    : key.type !== NodeTypes.SIMPLE_EXPRESSION
<span class="linenr"> 67: </span>    ? createCompoundExpression([
<span class="linenr"> 68: </span>        <span class=
"org-string">`(`</span>,
<span class="linenr"> 69: </span>        key,
<span class="linenr"> 70: </span>        <span class=
"org-string">`) === "onClick" ? "${event}" : (`</span>,
<span class="linenr"> 71: </span>        key,
<span class="linenr"> 72: </span>        <span class=
"org-string">`)`</span>
<span class="linenr"> 73: </span>      ])
<span class="linenr"> 74: </span>    : key
<span class="linenr"> 75: </span>}
<span class="linenr"> 76: </span>
<span class="linenr"> 77: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">transformOn</span> = (dir, node, context) =&gt; {
<span class="linenr"> 78: </span>  <span class=
"org-keyword">return</span> transformOn(dir, node, context, baseResult =&gt; {
<span class="linenr"> 79: </span>    <span class=
"org-keyword">const</span> { modifiers } = dir
<span class="linenr"> 80: </span>    <span class=
"org-keyword">if</span> (!modifiers.length) <span class=
"org-keyword">return</span> baseResult
<span class="linenr"> 81: </span>
<span class="linenr"> 82: </span>    <span class=
"org-keyword">let</span> { key, value: handlerExp } = baseResult.props[<span class="org-highlight-numbers-number">0</span>]
<span class="linenr"> 83: </span>    <span class=
"org-keyword">const</span> { keyModifiers, nonKeyModifiers, eventOptionModifiers } =
<span class=
"linenr"> 84: </span>      resolveModifiers(key, modifiers, context, dir.loc)
<span class="linenr"> 85: </span>
<span class="linenr"> 86: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">normalize click.right and click.middle since they don't actually fire</span>
<span id="coderef-transformOn-right" class=
"coderef-off"><span class="linenr"> 87: </span>    <span class=
"org-keyword">if</span> (nonKeyModifiers.includes(<span class=
"org-string">'right'</span>)) {</span>
<span class=
"linenr"> 88: </span>      key = transformClick(key, <span class=
"org-string">`onContextmenu`</span>)
<span class="linenr"> 89: </span>    }
<span class="linenr"> 90: </span>    <span class=
"org-keyword">if</span> (nonKeyModifiers.includes(<span class=
"org-string">'middle'</span>)) {
<span class=
"linenr"> 91: </span>      key = transformClick(key, <span class=
"org-string">`onMouseup`</span>)
<span class="linenr"> 92: </span>    }
<span class="linenr"> 93: </span>
<span class="linenr"> 94: </span>    <span class=
"org-keyword">if</span> (nonKeyModifiers.length) {
<span class=
"linenr"> 95: </span>      handlerExp = createCallExpression(context.helper(V_ON_WITH_MODIFIERS), [
<span class="linenr"> 96: </span>        handlerExp,
<span class=
"linenr"> 97: </span>        JSON.stringify(nonKeyModifiers)
<span class="linenr"> 98: </span>      ])
<span class="linenr"> 99: </span>    }
<span class="linenr">100: </span>
<span class="linenr">101: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">102: </span>      keyModifiers.length &amp;&
<span class="linenr">103: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if event name is dynamic, always wrap with keys guard</span>
<span class=
"linenr">104: </span>      (!isStaticExp(key) || isKeyboardEvent(key.content))
<span class="linenr">105: </span>    ) {
<span class=
"linenr">106: </span>      handlerExp = createCallExpression(context.helper(V_ON_WITH_KEYS), [
<span class="linenr">107: </span>        handlerExp,
<span class=
"linenr">108: </span>        JSON.stringify(keyModifiers)
<span class="linenr">109: </span>      ])
<span class="linenr">110: </span>    }
<span class="linenr">111: </span>
<span class="linenr">112: </span>    <span class=
"org-keyword">if</span> (eventOptionModifiers.length) {
<span class="linenr">113: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">modifierPostfix</span> = eventOptionModifiers.map(capitalize).join(<span class="org-string">''</span>)
<span class="linenr">114: </span>      key = isStaticExp(key)
<span class=
"linenr">115: </span>        ? createSimpleExpression(<span class=
"org-string">`${key.content}${modifierPostfix}`</span>, <span class="org-constant">true</span>)
<span class=
"linenr">116: </span>        : createCompoundExpression([<span class="org-string">`(`</span>, key, <span class="org-string">`) + "${modifierPostfix}"`</span>])
<span class="linenr">117: </span>    }
<span class="linenr">118: </span>
<span class="linenr">119: </span>    <span class=
"org-keyword">return</span> {
<span class=
"linenr">120: </span>      props: [createObjectProperty(key, handlerExp)]
<span class="linenr">121: </span>    }
<span class="linenr">122: </span>  })
<span class="linenr">123: </span>}
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <p>before: 注意看结果会发现修饰符并没有出现在 render 函数中</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;cc-test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = baseCompile(<span class=
"org-string">`&lt;div @click.enter.passive="handleClick" /&gt;`</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>log(<span class=
"org-string">'onclick'</span>, code)
</pre>
          </div>
          <p>after:</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "linenr">1: </span>&lt;&lt;test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { code } = compile(<span class=
"org-string">`&lt;div @click.right.passive="handleClick" /&gt;`</span>, { filename: <span class="org-string">'foo.vue'</span> })
<span class="linenr">5: </span>logOn()
<span class="linenr">6: </span>log(<span class=
"org-string">'onclick'</span>, code)
</pre>
          </div>
          <ol class="org-ol">
            <li>right 修饰符下的 click 事件被转成了 <code>onContextmenu</code>
            右键点击事件</li>
            <li>passive 修饰符直接被追加到了事件 key 后面
            <code>onContextmenuPassive</code>, 这也是 vue 中
            对修饰符的处理方式(如： <code>@click.right.once</code> =&gt;
            <code>onContextmenuOnce</code>)</li>
          </ol>
          <p>当有修饰符的时候会使用到 withModifiers, 每个修饰符都有自己对应的一个函数，只有当
          满足条件的才会让事件继续，也就是最后的 <code>fn(event, ...args)</code>
          执行:</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">modifierGuards</span>: <span class=
            "org-type">Record</span>&lt;
<span class="linenr"> 2: </span>  <span class=
"org-typescript-primitive">string</span>,
<span class="linenr"> 3: </span>  <span class=
"org-rainbow-delimiters-depth-1">(</span>e: <span class=
"org-type">Event</span>, modifiers: <span class=
"org-typescript-primitive">string</span><span class=
"org-rainbow-delimiters-depth-2">[]</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-typescript-primitive">void</span> | <span class=
"org-typescript-primitive">boolean</span>
<span class="linenr"> 4: </span>&gt; = <span class=
"org-rainbow-delimiters-depth-1">{</span>
<span class="linenr"> 5: </span>  stop: e <span class=
"org-keyword">=&gt;</span> e.<span class=
"org-function-name">stopPropagation</span><span class=
"org-rainbow-delimiters-depth-2">()</span>,
<span class="linenr"> 6: </span>  prevent: e <span class=
"org-keyword">=&gt;</span> e.<span class=
"org-function-name">preventDefault</span><span class=
"org-rainbow-delimiters-depth-2">()</span>,
<span class="linenr"> 7: </span>  self: e <span class=
"org-keyword">=&gt;</span> e.target !== e.currentTarget,
<span class="linenr"> 8: </span>  ctrl: e <span class=
"org-keyword">=&gt;</span> !<span class=
"org-rainbow-delimiters-depth-2">(</span>e <span class=
"org-keyword">as</span> KeyedEvent<span class=
"org-rainbow-delimiters-depth-2">)</span>.ctrlKey,
<span class="linenr"> 9: </span>  shift: e <span class=
"org-keyword">=&gt;</span> !<span class=
"org-rainbow-delimiters-depth-2">(</span>e <span class=
"org-keyword">as</span> KeyedEvent<span class=
"org-rainbow-delimiters-depth-2">)</span>.shiftKey,
<span class="linenr">10: </span>  alt: e <span class=
"org-keyword">=&gt;</span> !<span class=
"org-rainbow-delimiters-depth-2">(</span>e <span class=
"org-keyword">as</span> KeyedEvent<span class=
"org-rainbow-delimiters-depth-2">)</span>.altKey,
<span class="linenr">11: </span>  meta: e <span class=
"org-keyword">=&gt;</span> !<span class=
"org-rainbow-delimiters-depth-2">(</span>e <span class=
"org-keyword">as</span> KeyedEvent<span class=
"org-rainbow-delimiters-depth-2">)</span>.metaKey,
<span class="linenr">12: </span>  left: e <span class=
"org-keyword">=&gt;</span> <span class=
"org-string">'button'</span> <span class=
"org-keyword">in</span> e &amp;& <span class=
"org-rainbow-delimiters-depth-2">(</span>e <span class=
"org-keyword">as</span> MouseEvent<span class=
"org-rainbow-delimiters-depth-2">)</span>.button !== <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">13: </span>  middle: e <span class=
"org-keyword">=&gt;</span> <span class=
"org-string">'button'</span> <span class=
"org-keyword">in</span> e &amp;& <span class=
"org-rainbow-delimiters-depth-2">(</span>e <span class=
"org-keyword">as</span> MouseEvent<span class=
"org-rainbow-delimiters-depth-2">)</span>.button !== <span class=
"org-highlight-numbers-number">1</span>,
<span class="linenr">14: </span>  right: e <span class=
"org-keyword">=&gt;</span> <span class=
"org-string">'button'</span> <span class=
"org-keyword">in</span> e &amp;& <span class=
"org-rainbow-delimiters-depth-2">(</span>e <span class=
"org-keyword">as</span> MouseEvent<span class=
"org-rainbow-delimiters-depth-2">)</span>.button !== <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr">15: </span>  exact: <span class=
"org-rainbow-delimiters-depth-2">(</span>e, modifiers<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">=&gt;</span>
<span class="linenr">16: </span>    systemModifiers.<span class=
"org-function-name">some</span><span class=
"org-rainbow-delimiters-depth-2">(</span>m <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>e <span class=
"org-keyword">as</span> <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-3">)[</span><span class=
"org-string">`${m}Key`</span><span class=
"org-rainbow-delimiters-depth-3">]</span> &amp;& !modifiers.<span class="org-function-name">includes</span><span class="org-rainbow-delimiters-depth-3">(</span>m<span class="org-rainbow-delimiters-depth-3">)</span><span class="org-rainbow-delimiters-depth-2">)</span>
<span class="linenr">17: </span><span class=
"org-rainbow-delimiters-depth-1">}</span>
<span class="linenr">18: </span>
<span class="linenr">19: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">withModifiers</span> = <span class=
"org-rainbow-delimiters-depth-1">(</span>fn: <span class=
"org-type">Function</span>, modifiers: <span class=
"org-typescript-primitive">string</span><span class=
"org-rainbow-delimiters-depth-2">[]</span><span class=
"org-rainbow-delimiters-depth-1">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
<span class="linenr">20: </span>  <span class=
"org-keyword">return</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>event: <span class=
"org-type">Event</span>, ...args: <span class=
"org-typescript-primitive">unknown</span><span class=
"org-rainbow-delimiters-depth-3">[]</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-keyword">=&gt;</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
<span class="linenr">21: </span>    <span class=
"org-keyword">for</span> <span class=
"org-rainbow-delimiters-depth-3">(</span><span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; <span class=
"org-type">modifiers</span>.<span class=
"org-type">length</span>; <span class=
"org-type">i</span>++<span class=
"org-rainbow-delimiters-depth-3">)</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
<span class="linenr">22: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">guard</span> = modifierGuards<span class=
"org-rainbow-delimiters-depth-4">[</span>modifiers<span class=
"org-rainbow-delimiters-depth-1">[</span>i<span class=
"org-rainbow-delimiters-depth-1">]</span><span class=
"org-rainbow-delimiters-depth-4">]</span>
<span class="linenr">23: </span>      <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-4">(</span>guard &amp;& <span class=
"org-function-name">guard</span><span class=
"org-rainbow-delimiters-depth-1">(</span>event, modifiers<span class="org-rainbow-delimiters-depth-1">)</span><span class="org-rainbow-delimiters-depth-4">)</span> <span class="org-keyword">return</span>
<span class="linenr">24: </span>    <span class=
"org-rainbow-delimiters-depth-3">}</span>
<span class="linenr">25: </span>    <span class=
"org-keyword">return</span> <span class=
"org-function-name">fn</span><span class=
"org-rainbow-delimiters-depth-3">(</span>event, ...args<span class=
"org-rainbow-delimiters-depth-3">)</span>
<span class="linenr">26: </span>  <span class=
"org-rainbow-delimiters-depth-2">}</span>
<span class="linenr">27: </span><span class=
"org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
          <div style=
          "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <h3>小结</h3>
            <p>compiler-dom 对 v-on 指令的处理就是对修饰符的处理，将事件函数进行转换，使用
            <code>withModifiers()</code> 进行封装。</p>
            <p>修饰符有三类：</p>
            <ol class="org-ol">
              <li>
                <p>事件选项<kbd style="">passive,once,capture</kbd></p>
                <p><a href=
                "https://segmentfault.com/a/1190000017247263">passive的作用和原理
                - SegmentFault 思否</a></p>
                <p><a href=
                "https://blog.techbridge.cc/2017/07/15/javascript-event-propagation/">
                DOM 的事件傳遞機制：捕獲與冒泡</a></p>
              </li>
              <li>冒泡相关 <kbd style="">stop,prevent,self</kbd>, 系统组合键
              <kbd style="">ctrl,shift,alt,meta,exact</kbd>, 鼠 标按键
              <kbd style="">middle</kbd></li>
              <li><kbd style="">left, right</kbd>
              可能是鼠标也可以是键盘上的左右键</li>
            </ol>
            <p>修饰符影响事件类型：</p>
            <ol class="org-ol">
              <li>click.right 转成右键菜单键
              <code>onContextmenu</code></li>
              <li>click.middle 转成鼠标中键 <code>onMouseUp</code></li>
            </ol>
          </div>
        </div>
      </div>
      <div id="outline-container-orgdbe7e18" class="outline-3">
        <h3 id="orgdbe7e18"><span class=
        "section-number-3">2.6.</span> v-show</h3>
        <div class="outline-text-3" id="text-2-6">
          <p>v-show 在这里并没有真正的被处理到，而在 runtime 运行时才会被处理，也就是后面会完 成的
          <code>runtime-dom</code> 包里，实现原理其实就是控制元素
          <code>display</code> 属性，这里只是将其标识了 下需要运行时去处理。</p>
          <p>旧博客中有相关分析：<a href=
          "https://www.cheng92.com/vue/vue-mind-map-runtime-dom/#v-show">Vue3
          源码头脑风暴之 8 ☞ runtime-dom - 若叶知秋</a></p>
          <div class="org-src-container">
            <pre class="src src-js" id="org728c08d"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">transformShow</span> = (dir, node, context) =&gt; {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">const</span> { exp, loc } = dir
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (!exp) {
<span class="linenr"> 4: </span>    logg(<span class=
"org-string">'transformShow no exp.'</span>)
<span class="linenr"> 5: </span>  }
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span>  <span class=
"org-keyword">return</span> {
<span class="linenr"> 8: </span>    props: [],
<span class=
"linenr"> 9: </span>    needRuntime: context.helper(V_SHOW)
<span class="linenr">10: </span>  }
<span class="linenr">11: </span>}
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org8fb1bee" class="outline-3">
        <h3 id="org8fb1bee"><span class=
        "section-number-3">2.7.</span> stringifyStatic</h3>
        <div class="outline-text-3" id="text-2-7">
          <p>在处理静态提升代码时需要用到 <code>stringifyStatic</code>,
          它会将静态提升的节点直接字符串化， 然后创建一个 off-dom 节点来保存它，等到需要使用的时候直接使用这个
          off-dom 节点。</p>
          <div class="org-src-container">
            <pre class="src src-js" id="orge08be2e"><span class=
            "linenr">  1: </span> <span class=
            "org-keyword">const</span> <span class=
            "org-variable-name">StringifyThresholds</span> = {
<span class=
"linenr">  2: </span>   ELEMENT_WITH_BINDING_COUNT: <span class=
"org-highlight-numbers-number">5</span>,
<span class="linenr">  3: </span>   NODE_COUNT: <span class=
"org-highlight-numbers-number">20</span>
<span class="linenr">  4: </span>}
<span class="linenr">  5: </span>
<span class="linenr">  6: </span><span class="org-doc">/**</span>
<span class="linenr">  7: </span><span class=
"org-doc"> * Regex for replacing placeholders for embedded constant variables</span>
<span class="linenr">  8: </span><span class=
"org-doc"> * (e.g. import URL string constants generated by compiler-sfc)</span>
<span class="linenr">  9: </span><span class="org-doc"> */</span>
<span class="linenr"> 10: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">expReplaceRE</span> = <span class=
"org-string">/__VUE_EXP_START__(.*?)__VUE_EXP_END__/</span>g
<span class="linenr"> 11: </span>
<span class="linenr"> 12: </span><span class="org-doc">/**</span>
<span class="linenr"> 13: </span><span class=
"org-doc"> * Turn eligible hoisted static trees into stringified static nodes, e.g.</span>
<span class="linenr"> 14: </span><span class="org-doc"> *</span>
<span class="linenr"> 15: </span><span class=
"org-doc"> * ```js</span>
<span class="linenr"> 16: </span><span class=
"org-doc"> * const _hoisted_1 = createStaticVNode(`&lt;div class="foo"&gt;bar&lt;/div&gt;`)</span>
<span class="linenr"> 17: </span><span class=
"org-doc"> * ```</span>
<span class="linenr"> 18: </span><span class="org-doc"> *</span>
<span class="linenr"> 19: </span><span class=
"org-doc"> * A single static vnode can contain stringified content for **multiple**</span>
<span class="linenr"> 20: </span><span class=
"org-doc"> * consecutive nodes (element and plain text), called a "chunk".</span>
<span class="linenr"> 21: </span><span class=
"org-doc"> * `@vue/runtime-dom` will create the content via innerHTML in a hidden</span>
<span class="linenr"> 22: </span><span class=
"org-doc"> * container element and insert all the nodes in place. The call must also</span>
<span class="linenr"> 23: </span><span class=
"org-doc"> * provide the number of nodes contained in the chunk so that during hydration</span>
<span class="linenr"> 24: </span><span class=
"org-doc"> * we can know how many nodes the static vnode should adopt.</span>
<span class="linenr"> 25: </span><span class="org-doc"> *</span>
<span class="linenr"> 26: </span><span class=
"org-doc"> * The optimization scans a children list that contains hoisted nodes, and</span>
<span class="linenr"> 27: </span><span class=
"org-doc"> * tries to find the largest chunk of consecutive hoisted nodes before running</span>
<span class="linenr"> 28: </span><span class=
"org-doc"> * into a non-hoisted node or the end of the list. A chunk is then converted</span>
<span class="linenr"> 29: </span><span class=
"org-doc"> * into a single static vnode and replaces the hoisted expression of the first</span>
<span class="linenr"> 30: </span><span class=
"org-doc"> * node in the chunk. Other nodes in the chunk are considered "merged" and</span>
<span class="linenr"> 31: </span><span class=
"org-doc"> * therefore removed from both the hoist list and the children array.</span>
<span class="linenr"> 32: </span><span class="org-doc"> *</span>
<span class="linenr"> 33: </span><span class=
"org-doc"> * This optimization is only performed in Node.js.</span>
<span class="linenr"> 34: </span><span class="org-doc"> */</span>
<span class="linenr"> 35: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">stringifyStatic</span> = (children, context, parent) =&gt; {
<span class="linenr"> 36: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail stringification for slot content</span>
<span class="linenr"> 37: </span>  <span class=
"org-keyword">if</span> (context.scopes.vSlot &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr"> 38: </span>    <span class=
"org-keyword">return</span>
<span class="linenr"> 39: </span>  }
<span class="linenr"> 40: </span>
<span class="linenr"> 41: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">nc</span> = <span class=
"org-highlight-numbers-number">0</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">current node count</span>
<span class="linenr"> 42: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ec</span> = <span class=
"org-highlight-numbers-number">0</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">current element with binding count</span>
<span class="linenr"> 43: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">currentChunk</span> = []
<span class="linenr"> 44: </span>
<span class="linenr"> 45: </span>  logg(<span class=
"org-string">`stringifyStatic - children.length = ${children.length}`</span>)
<span class="linenr"> 46: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">stringifyCurrentChunk</span> = (currentIndex) =&gt; {
<span class="linenr"> 47: </span>    <span class=
"org-keyword">if</span> (
<span class=
"linenr"> 48: </span>      nc &gt;= StringifyThresholds.NODE_COUNT ||
<span class=
"linenr"> 49: </span>      ec &gt;= StringifyThresholds.ELEMENT_WITH_BINDING_COUNT
<span class="linenr"> 50: </span>    ) {
<span class="linenr"> 51: </span>      logg(<span class=
"org-string">`stringifyCurrentChunk - index = ${currentIndex}`</span>)
<span class="linenr"> 52: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">combine all currently eligible nodes into a single static vnode call</span>
<span class="linenr"> 53: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">staticCall</span> = createCallExpression(context.helper(CREATE_STATIC), [
<span class="linenr"> 54: </span>        JSON.stringify(
<span class=
"linenr"> 55: </span>          currentChunk.map(node =&gt; stringifyNode(node, context)).join(<span class="org-string">''</span>)
<span class=
"linenr"> 56: </span>        ).replace(expReplaceRE, <span class=
"org-string">`" + $1 + "`</span>),
<span class="linenr"> 57: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the 2nd argument indicates the number of DOM nodes this static vnode</span>
<span class="linenr"> 58: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">will insert / hydrate</span>
<span class=
"linenr"> 59: </span>        String(currentChunk.length)
<span class="linenr"> 60: </span>      ])
<span class="linenr"> 61: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">replace the first node's hoisted expression with the static vnode call</span>
<span class=
"linenr"> 62: </span>      replaceHoist(currentChunk[<span class=
"org-highlight-numbers-number">0</span>], staticCall, context)
<span class="linenr"> 63: </span>
<span class="linenr"> 64: </span>      <span class=
"org-keyword">if</span> (currentChunk.length &gt; <span class=
"org-highlight-numbers-number">1</span>) {
<span class="linenr"> 65: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">1</span>; i &lt; currentChunk.length; i++) {
<span class="linenr"> 66: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">for the merged nodes, set their hoisted expression to null</span>
<span class=
"linenr"> 67: </span>          replaceHoist(currentChunk[i], <span class="org-constant">null</span>, context)
<span class="linenr"> 68: </span>        }
<span class="linenr"> 69: </span>
<span class="linenr"> 70: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">also remove merged nodes from children</span>
<span class="linenr"> 71: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">deleteCount</span> = currentChunk.length - <span class="org-highlight-numbers-number">1</span>
<span class=
"linenr"> 72: </span>        children.splice(currentIndex - currentChunk.length + <span class="org-highlight-numbers-number">1</span>, deleteCount)
<span class="linenr"> 73: </span>        <span class=
"org-keyword">return</span> deleteCount
<span class="linenr"> 74: </span>      }
<span class="linenr"> 75: </span>    }
<span class="linenr"> 76: </span>    <span class=
"org-keyword">return</span> <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 77: </span>  }
<span class="linenr"> 78: </span>
<span class="linenr"> 79: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 80: </span>  <span class=
"org-keyword">for</span> (; i &lt; children.length; i++) {
<span class="linenr"> 81: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = children[i]
<span class="linenr"> 82: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hoisted</span> = getHoistedNode(child)
<span class="linenr"> 83: </span>    <span class=
"org-keyword">if</span> (hoisted) {
<span class="linenr"> 84: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">presence of hoisted means child must be a stringifiable node</span>
<span class="linenr"> 85: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">node</span> = child
<span class="linenr"> 86: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">result</span> = analyzeNode(node)
<span class="linenr"> 87: </span>      <span class=
"org-keyword">if</span> (result) {
<span class="linenr"> 88: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node is stringifiable, record state</span>
<span class="linenr"> 89: </span>        nc += result[<span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr"> 90: </span>        ec += result[<span class=
"org-highlight-numbers-number">1</span>]
<span class="linenr"> 91: </span>        currentChunk.push(node)
<span class="linenr"> 92: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr"> 93: </span>      }
<span class="linenr"> 94: </span>    }
<span class="linenr"> 95: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">we only reach here if we ran into a node that is not stringifiable</span>
<span class="linenr"> 96: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">check if currently analyzed nodes meet criteria for stringification.</span>
<span class="linenr"> 97: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">adjust iteration index</span>
<span class="linenr"> 98: </span>    i -= stringifyCurrentChunk(i)
<span class="linenr"> 99: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">reset state</span>
<span class="linenr">100: </span>    nc = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">101: </span>    ec = <span class=
"org-highlight-numbers-number">0</span>
<span class=
"linenr">102: </span>    currentChunk.length = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">103: </span>  }
<span class="linenr">104: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in case the last node was also stringifiable</span>
<span class="linenr">105: </span>  stringifyCurrentChunk(i)
<span class="linenr">106: </span>}
<span class="linenr">107: </span>
<span class="linenr">108: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">getHoistedNode</span> = (node) =&gt;
<span class=
"linenr">109: </span>  ((node.type === NodeTypes.ELEMENT &amp;& node.tagType === ElementTypes.ELEMENT) ||
<span class=
"linenr">110: </span>    node.type == NodeTypes.TEXT_CALL) &amp;&
<span class="linenr">111: </span>  node.codegenNode &amp;&
<span class=
"linenr">112: </span>  node.codegenNode.type === NodeTypes.SIMPLE_EXPRESSION &amp;&
<span class="linenr">113: </span>  node.codegenNode.hoisted
<span class="linenr">114: </span>
<span class="linenr">115: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">dataAriaRE</span> = <span class=
"org-string">/^(data|aria)-/</span>
<span class="linenr">116: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isStringifiableAttr</span> = (name, ns) =&gt; {
<span class="linenr">117: </span>  <span class=
"org-keyword">return</span> (
<span class="linenr">118: </span>    (ns === DOMNamespaces.HTML
<span class="linenr">119: </span>      ? isKnownHtmlAttr(name)
<span class="linenr">120: </span>      : ns === DOMNamespaces.SVG
<span class="linenr">121: </span>      ? isKnownSvgAttr(name)
<span class="linenr">122: </span>      : <span class=
"org-constant">false</span>) || dataAriaRE.test(name)
<span class="linenr">123: </span>  )
<span class="linenr">124: </span>}
<span class="linenr">125: </span>
<span class="linenr">126: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">replaceHoist</span> = (node,replacement,context) =&gt; {
<span class="linenr">127: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">hoistToReplace</span> = node.codegenNode.hoisted
<span class=
"linenr">128: </span>  context.hoists[context.hoists.indexOf(hoistToReplace)] = replacement
<span class="linenr">129: </span>}
<span class="linenr">130: </span>
<span class="linenr">131: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">isNonStringifiable</span> = <span class=
"org-comment-delimiter">/*</span><span class=
"org-comment">#__PURE__</span><span class=
"org-comment-delimiter">*/</span> makeMap(
<span class="linenr">132: </span>  <span class=
"org-string">`caption,thead,tr,th,tbody,td,tfoot,colgroup,col`</span>
<span class="linenr">133: </span>)
<span class="linenr">134: </span>
<span class="linenr">135: </span><span class="org-doc">/**</span>
<span class="linenr">136: </span><span class=
"org-doc"> * for a hoisted node, analyze it and return:</span>
<span class="linenr">137: </span><span class=
"org-doc"> * - false: bailed (contains non-stringifiable props or runtime constant)</span>
<span class="linenr">138: </span><span class=
"org-doc"> * - [nc, ec] where</span>
<span class="linenr">139: </span><span class=
"org-doc"> *   - nc is the number of nodes inside</span>
<span class="linenr">140: </span><span class=
"org-doc"> *   - ec is the number of element with bindings inside</span>
<span class="linenr">141: </span><span class="org-doc"> */</span>
<span class="linenr">142: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">analyzeNode</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">143: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.ELEMENT &amp;& isNonStringifiable(node.tag)) {
<span class="linenr">144: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">145: </span>  }
<span class="linenr">146: </span>
<span class="linenr">147: </span>  <span class=
"org-keyword">if</span> (node.type === NodeTypes.TEXT_CALL) {
<span class="linenr">148: </span>    <span class=
"org-keyword">return</span> [<span class=
"org-highlight-numbers-number">1</span>, <span class=
"org-highlight-numbers-number">0</span>]
<span class="linenr">149: </span>  }
<span class="linenr">150: </span>
<span class="linenr">151: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">nc</span> = <span class=
"org-highlight-numbers-number">1</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">node count</span>
<span class="linenr">152: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ec</span> = node.props.length &gt; <span class=
"org-highlight-numbers-number">0</span> ? <span class=
"org-highlight-numbers-number">1</span> : <span class=
"org-highlight-numbers-number">0</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">element w/ binding count</span>
<span class="linenr">153: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">bailed</span> = <span class=
"org-constant">false</span>
<span class="linenr">154: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">bail</span> = () =&gt; {
<span class="linenr">155: </span>    bailed = <span class=
"org-constant">true</span>
<span class="linenr">156: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">157: </span>  }
<span class="linenr">158: </span>
<span class="linenr">159: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO:</span></span></span><span class=
"org-comment"> check for cases where using innerHTML will result in different</span>
<span class="linenr">160: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">output compared to imperative node insertions.</span>
<span class="linenr">161: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">probably only need to check for most common case</span>
<span class="linenr">162: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">i.e. non-phrasing-content tags inside `&lt;p&gt;`</span>
<span class="linenr">163: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">walk</span>(<span class=
"org-variable-name">node</span>) {
<span class="linenr">164: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">165: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">166: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail on non-attr bindings</span>
<span class="linenr">167: </span>      <span class=
"org-keyword">if</span> (
<span class=
"linenr">168: </span>        p.type === NodeTypes.ATTRIBUTE &amp;&
<span class=
"linenr">169: </span>        !isStringifiableAttr(p.name, node.ns)
<span class="linenr">170: </span>      ) {
<span class="linenr">171: </span>        <span class=
"org-keyword">return</span> bail()
<span class="linenr">172: </span>      }
<span class="linenr">173: </span>      <span class=
"org-keyword">if</span> (p.type === NodeTypes.DIRECTIVE &amp;& p.name === <span class="org-string">'bind'</span>) {
<span class="linenr">174: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">bail on non-attr bindings</span>
<span class="linenr">175: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">176: </span>          p.arg &amp;&
<span class=
"linenr">177: </span>          (p.arg.type === NodeTypes.COMPOUND_EXPRESSION ||
<span class=
"linenr">178: </span>            (p.arg.isStatic &amp;& !isStringifiableAttr(p.arg.content, node.ns)))
<span class="linenr">179: </span>        ) {
<span class="linenr">180: </span>          <span class=
"org-keyword">return</span> bail()
<span class="linenr">181: </span>        }
<span class="linenr">182: </span>        <span class=
"org-keyword">if</span> (
<span class="linenr">183: </span>          p.exp &amp;&
<span class=
"linenr">184: </span>          (p.exp.type === NodeTypes.COMPOUND_EXPRESSION ||
<span class=
"linenr">185: </span>            p.exp.constType &lt; ConstantTypes.CAN_STRINGIFY)
<span class="linenr">186: </span>        ) {
<span class="linenr">187: </span>          <span class=
"org-keyword">return</span> bail()
<span class="linenr">188: </span>        }
<span class="linenr">189: </span>      }
<span class="linenr">190: </span>    }
<span class="linenr">191: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class="linenr">192: </span>      nc++
<span class="linenr">193: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">child</span> = node.children[i]
<span class="linenr">194: </span>      <span class=
"org-keyword">if</span> (child.type === NodeTypes.ELEMENT) {
<span class="linenr">195: </span>        <span class=
"org-keyword">if</span> (child.props.length &gt; <span class=
"org-highlight-numbers-number">0</span>) {
<span class="linenr">196: </span>          ec++
<span class="linenr">197: </span>        }
<span class="linenr">198: </span>        walk(child)
<span class="linenr">199: </span>        <span class=
"org-keyword">if</span> (bailed) {
<span class="linenr">200: </span>          <span class=
"org-keyword">return</span> <span class="org-constant">false</span>
<span class="linenr">201: </span>        }
<span class="linenr">202: </span>      }
<span class="linenr">203: </span>    }
<span class="linenr">204: </span>    <span class=
"org-keyword">return</span> <span class="org-constant">true</span>
<span class="linenr">205: </span>  }
<span class="linenr">206: </span>
<span class="linenr">207: </span>  <span class=
"org-keyword">return</span> walk(node) ? [nc, ec] : <span class=
"org-constant">false</span>
<span class="linenr">208: </span>}
<span class="linenr">209: </span>
<span class="linenr">210: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyNode</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">211: </span>  <span class=
"org-keyword">if</span> (isString(node)) {
<span class="linenr">212: </span>    <span class=
"org-keyword">return</span> node
<span class="linenr">213: </span>  }
<span class="linenr">214: </span>  <span class=
"org-keyword">if</span> (isSymbol(node)) {
<span class="linenr">215: </span>    <span class=
"org-keyword">return</span> <span class="org-string">``</span>
<span class="linenr">216: </span>  }
<span class="linenr">217: </span>  <span class=
"org-keyword">switch</span> (node.type) {
<span class="linenr">218: </span>    <span class=
"org-keyword">case</span> NodeTypes.ELEMENT:
<span class="linenr">219: </span>      <span class=
"org-keyword">return</span> stringifyElement(node, context)
<span class="linenr">220: </span>    <span class=
"org-keyword">case</span> NodeTypes.TEXT:
<span class="linenr">221: </span>      <span class=
"org-keyword">return</span> escapeHtml(node.content)
<span class="linenr">222: </span>    <span class=
"org-keyword">case</span> NodeTypes.COMMENT:
<span class="linenr">223: </span>      <span class=
"org-keyword">return</span> <span class=
"org-string">`&lt;!--${escapeHtml(node.content)}--&gt;`</span>
<span class="linenr">224: </span>    <span class=
"org-keyword">case</span> NodeTypes.INTERPOLATION:
<span class="linenr">225: </span>      <span class=
"org-keyword">return</span> escapeHtml(toDisplayString(evaluateConstant(node.content)))
<span class="linenr">226: </span>    <span class=
"org-keyword">case</span> NodeTypes.COMPOUND_EXPRESSION:
<span class="linenr">227: </span>      <span class=
"org-keyword">return</span> escapeHtml(evaluateConstant(node))
<span class="linenr">228: </span>    <span class=
"org-keyword">case</span> NodeTypes.TEXT_CALL:
<span class="linenr">229: </span>      <span class=
"org-keyword">return</span> stringifyNode(node.content, context)
<span class="linenr">230: </span>    <span class=
"org-keyword">default</span>:
<span class="linenr">231: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">static trees will not contain if/for nodes</span>
<span class="linenr">232: </span>      <span class=
"org-keyword">return</span> <span class="org-string">''</span>
<span class="linenr">233: </span>  }
<span class="linenr">234: </span>}
<span class="linenr">235: </span>
<span class="linenr">236: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyElement</span>(<span class=
"org-variable-name">node</span>, <span class=
"org-variable-name">context</span>) {
<span class="linenr">237: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">res</span> = <span class=
"org-string">`&lt;${node.tag}`</span>
<span class="linenr">238: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.props.length; i++) {
<span class="linenr">239: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">p</span> = node.props[i]
<span class="linenr">240: </span>    <span class=
"org-keyword">if</span> (p.type === NodeTypes.ATTRIBUTE) {
<span class="linenr">241: </span>      res += <span class=
"org-string">` ${p.name}`</span>
<span class="linenr">242: </span>      <span class=
"org-keyword">if</span> (p.value) {
<span class="linenr">243: </span>        res += <span class=
"org-string">`="${escapeHtml(p.value.content)}"`</span>
<span class="linenr">244: </span>      }
<span class="linenr">245: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (p.type === NodeTypes.DIRECTIVE &amp;& p.name === <span class="org-string">'bind'</span>) {
<span class="linenr">246: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">exp</span> = p.exp
<span class="linenr">247: </span>      <span class=
"org-keyword">if</span> (exp.content[<span class=
"org-highlight-numbers-number">0</span>] === <span class=
"org-string">'_'</span>) {
<span class="linenr">248: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">internally generated string constant references</span>
<span class="linenr">249: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">e.g. imported URL strings via compiler-sfc transformAssetUrl plugin</span>
<span class="linenr">250: </span>        res += <span class=
"org-string">` ${p.arg.content}="__VUE_EXP_START__${</span>
<span class="linenr">251: </span><span class=
"org-string">          exp.content</span>
<span class="linenr">252: </span><span class=
"org-string">        }__VUE_EXP_END__"`</span>
<span class="linenr">253: </span>        <span class=
"org-keyword">continue</span>
<span class="linenr">254: </span>      }
<span class="linenr">255: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">constant v-bind, e.g. :foo="1"</span>
<span class="linenr">256: </span>      <span class=
"org-keyword">let</span> <span class=
"org-variable-name">evaluated</span> = evaluateConstant(exp)
<span class="linenr">257: </span>      <span class=
"org-keyword">if</span> (evaluated != <span class=
"org-constant">null</span>) {
<span class="linenr">258: </span>        <span class=
"org-keyword">const</span> <span class=
"org-variable-name">arg</span> = p.arg &amp;& p.arg.content
<span class="linenr">259: </span>        <span class=
"org-keyword">if</span> (arg === <span class=
"org-string">'class'</span>) {
<span class=
"linenr">260: </span>          evaluated = normalizeClass(evaluated)
<span class="linenr">261: </span>        } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (arg === <span class=
"org-string">'style'</span>) {
<span class=
"linenr">262: </span>          evaluated = stringifyStyle(normalizeStyle(evaluated))
<span class="linenr">263: </span>        }
<span class="linenr">264: </span>        res += <span class=
"org-string">` ${p.arg.content}="${escapeHtml(evaluated)}"`</span>
<span class="linenr">265: </span>      }
<span class="linenr">266: </span>    }
<span class="linenr">267: </span>  }
<span class="linenr">268: </span>  <span class=
"org-keyword">if</span> (context.scopeId) {
<span class="linenr">269: </span>    res += <span class=
"org-string">` ${context.scopeId}`</span>
<span class="linenr">270: </span>  }
<span class="linenr">271: </span>  res += <span class=
"org-string">`&gt;`</span>
<span class="linenr">272: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; node.children.length; i++) {
<span class=
"linenr">273: </span>    res += stringifyNode(node.children[i], context)
<span class="linenr">274: </span>  }
<span class="linenr">275: </span>  <span class=
"org-keyword">if</span> (!isVoidTag(node.tag)) {
<span class="linenr">276: </span>    res += <span class=
"org-string">`&lt;/${node.tag}&gt;`</span>
<span class="linenr">277: </span>  }
<span class="linenr">278: </span>  <span class=
"org-keyword">return</span> res
<span class="linenr">279: </span>}
<span class="linenr">280: </span>
<span class="linenr">281: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">__UNSAFE__</span>
<span class="linenr">282: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Reason: eval.</span>
<span class="linenr">283: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">It's technically safe to eval because only constant expressions are possible</span>
<span class="linenr">284: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">here, e.g. `{{ 1 }}` or `{{ 'foo' }}`</span>
<span class="linenr">285: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">in addition, constant exps bail on presence of parens so you can't even</span>
<span class="linenr">286: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">run JSFuck in here. But we mark it unsafe for security review purposes.</span>
<span class="linenr">287: </span><span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(see compiler-core/src/transformExpressions)</span>
<span class="linenr">288: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">evaluateConstant</span>(<span class=
"org-variable-name">exp</span>) {
<span class="linenr">289: </span>  <span class=
"org-keyword">if</span> (exp.type === NodeTypes.SIMPLE_EXPRESSION) {
<span class="linenr">290: </span>    <span class=
"org-keyword">return</span> <span class=
"org-keyword">new</span> <span class=
"org-type">Function</span>(<span class=
"org-string">`return ${exp.content}`</span>)()
<span class="linenr">291: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">292: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">compound</span>
<span class="linenr">293: </span>    <span class=
"org-keyword">let</span> <span class=
"org-variable-name">res</span> = <span class="org-string">``</span>
<span class="linenr">294: </span>    exp.children.forEach(c =&gt; {
<span class="linenr">295: </span>      <span class=
"org-keyword">if</span> (isString(c) || isSymbol(c)) {
<span class="linenr">296: </span>        <span class=
"org-keyword">return</span>
<span class="linenr">297: </span>      }
<span class="linenr">298: </span>      <span class=
"org-keyword">if</span> (c.type === NodeTypes.TEXT) {
<span class="linenr">299: </span>        res += c.content
<span class="linenr">300: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (c.type === NodeTypes.INTERPOLATION) {
<span class=
"linenr">301: </span>        res += toDisplayString(evaluateConstant(c.content))
<span class="linenr">302: </span>      } <span class=
"org-keyword">else</span> {
<span class="linenr">303: </span>        res += evaluateConstant(c)
<span class="linenr">304: </span>      }
<span class="linenr">305: </span>    })
<span class="linenr">306: </span>    <span class=
"org-keyword">return</span> res
<span class="linenr">307: </span>  }
<span class="linenr">308: </span>}
<span class="linenr">309: </span>
</pre>
          </div>
          <p><span style="color:red;">Testing</span></p>
          <div class="org-src-container">
            <pre class="src src-js" id="org3843fea"><span class=
            "linenr"> 1: </span>&lt;&lt;test-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">compileWithStringify</span>(<span class=
"org-variable-name">template</span>) {
<span class="linenr"> 4: </span>    <span class=
"org-keyword">return</span> compile(template, {
<span class="linenr"> 5: </span>      hoistStatic: <span class=
"org-constant">true</span>,
<span class=
"linenr"> 6: </span>      prefixIdentifiers: <span class=
"org-constant">true</span>,
<span class=
"linenr"> 7: </span>      transformHoist: stringifyStatic
<span class="linenr"> 8: </span>    })
<span class="linenr"> 9: </span>  }
<span class="linenr">10: </span>
<span class="linenr">11: </span>  <span class=
"org-keyword">function</span> <span class=
"org-function-name">repeat</span>(<span class=
"org-variable-name">code</span>, <span class=
"org-variable-name">n</span>) {
<span class="linenr">12: </span>    <span class=
"org-keyword">return</span> <span class=
"org-keyword">new</span> <span class="org-type">Array</span>(n)
<span class="linenr">13: </span>      .fill(<span class=
"org-highlight-numbers-number">0</span>)
<span class="linenr">14: </span>      .map(() =&gt; code)
<span class="linenr">15: </span>      .join(<span class=
"org-string">''</span>)
<span class="linenr">16: </span>  }
</pre>
          </div><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">should bail on non-eligible static
              trees</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr">1: </span>&lt;&lt;stringifyStatic-test-utils&gt;&gt;
<span class="linenr">2: </span>
<span class="linenr">3: </span>logOff()
<span class="linenr">4: </span><span class=
"org-keyword">const</span> { ast, code } = compileWithStringify(
<span class="linenr">5: </span>  <span class=
"org-string">`&lt;div&gt;&lt;div&gt;&lt;div&gt;hello&lt;/div&gt;&lt;div&gt;hello&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;`</span>
<span class="linenr">6: </span>)
<span class="linenr">7: </span>logOn()
<span class="linenr">8: </span>logg(<span class=
"org-string">'ast hoists'</span>, ast.hoists)
<span class="linenr">9: </span>logg(<span class=
"org-string">'code'</span>, code)
</pre>
            </div>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">should work on eligible content (elements with
              binding &gt; 5)</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;stringifyStatic-test-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span>logOff()
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> { ast, code } = compileWithStringify(
<span class="linenr"> 5: </span>  <span class=
"org-string">`&lt;div&gt;&lt;div&gt;${repeat(</span>
<span class="linenr"> 6: </span><span class=
"org-string">        `</span>&lt;span <span class=
"org-keyword">class</span>=<span class=
"org-string">"foo"</span>/&gt;<span class="org-string">`,</span>
<span class="linenr"> 7: </span><span class=
"org-string">        StringifyThresholds.ELEMENT_WITH_BINDING_COUNT</span>
<span class="linenr"> 8: </span><span class=
"org-string">      )}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;`</span>
<span class="linenr"> 9: </span>  <span class=
"org-comment-delimiter">//</span><span class=
"org-comment">`&lt;div&gt;&lt;div&gt;&lt;div&gt;hello&lt;/div&gt;&lt;div&gt;hello&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;`</span>
<span class="linenr">10: </span>)
<span class="linenr">11: </span>logOn()
<span class="linenr">12: </span>logg(<span class=
"org-string">'ast hoists'</span>, ast.hoists)
<span class="linenr">13: </span>logg(<span class=
"org-string">'code'</span>, code)
</pre>
            </div>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">should work on eligible content (elements &gt;
              20)</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;stringifyStatic-test-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span>logOff()
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> { ast, code } = compileWithStringify(
<span class="linenr"> 5: </span>  <span class=
"org-string">`&lt;div&gt;&lt;div&gt;${repeat(</span>
<span class="linenr"> 6: </span><span class=
"org-string">        `</span>&lt;span/&gt;<span class=
"org-string">`,</span>
<span class="linenr"> 7: </span><span class=
"org-string">        StringifyThresholds.NODE_COUNT</span>
<span class="linenr"> 8: </span><span class=
"org-string">      )}&lt;/div&gt;&lt;/div&gt;`</span>
<span class="linenr"> 9: </span>)
<span class="linenr">10: </span>logOn()
<span class="linenr">11: </span>logg(<span class=
"org-string">'ast hoists'</span>, ast.hoists)
<span class="linenr">12: </span>logg(<span class=
"org-string">'code'</span>, code)
</pre>
            </div>
          </details><br>
          <details class="code-details" style=
          "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
            <summary>
              <strong><font face="Courier" size="3" color=
              "red">serializing constant bindings</font></strong>
            </summary>
            <div class="org-src-container">
              <pre class="src src-js"><span class=
              "linenr"> 1: </span>&lt;&lt;stringifyStatic-test-utils&gt;&gt;
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span>logOff()
<span class="linenr"> 4: </span><span class=
"org-keyword">const</span> { ast, code } = compileWithStringify(
<span class="linenr"> 5: </span>  <span class=
"org-string">`&lt;div&gt;&lt;div :style="{ color: 'red' }"&gt;${repeat(</span>
<span class="linenr"> 6: </span><span class=
"org-string">        `</span>&lt;span :<span class=
"org-keyword">class</span>=<span class=
"org-string">"[{ foo: true }, { bar: true }]"</span>&gt;{{ <span class="org-highlight-numbers-number">1</span> }} + {{ <span class="org-constant">false</span> }}&lt;/span&gt;<span class="org-string">`,</span>
<span class="linenr"> 7: </span><span class=
"org-string">        StringifyThresholds.ELEMENT_WITH_BINDING_COUNT</span>
<span class="linenr"> 8: </span><span class=
"org-string">      )}&lt;/div&gt;&lt;/div&gt;`</span>
<span class="linenr"> 9: </span>)
<span class="linenr">10: </span>logOn()
<span class="linenr">11: </span>logg(<span class=
"org-string">'ast hoists'</span>, ast.hoists)
<span class="linenr">12: </span>logg(<span class=
"org-string">'code'</span>, code)
</pre>
            </div>
          </details>
          <p>createStaticVNode:</p>
          <div class="org-src-container">
            <pre class="src src-typescript"><span class=
            "linenr"> 1: </span><span class=
            "org-keyword">function</span> <span class=
            "org-function-name">createStaticVNode</span><span class=
            "org-rainbow-delimiters-depth-1">(</span>
<span class="linenr"> 2: </span>  content: <span class=
"org-typescript-primitive">string</span>,
<span class="linenr"> 3: </span>  numberOfNodes: <span class=
"org-typescript-primitive">number</span>
<span class="linenr"> 4: </span><span class=
"org-rainbow-delimiters-depth-1">)</span>: <span class=
"org-type">VNode</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
<span class="linenr"> 5: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">A static vnode can contain multiple stringified elements, and the number</span>
<span class="linenr"> 6: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">of elements is necessary for hydration.</span>
<span class="linenr"> 7: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">vnode</span> = <span class=
"org-function-name">createVNode</span><span class=
"org-rainbow-delimiters-depth-2">(</span>Static, <span class=
"org-constant">null</span>, content<span class=
"org-rainbow-delimiters-depth-2">)</span>
<span class="linenr"> 8: </span>  vnode.staticCount = numberOfNodes
<span class="linenr"> 9: </span>  <span class=
"org-keyword">return</span> vnode
<span class="linenr">10: </span><span class=
"org-rainbow-delimiters-depth-1">}</span>
</pre>
          </div>
        </div>
      </div>
    </div>
    <div id="outline-container-org7cef3c2" class="outline-2">
      <h2 id="org7cef3c2"><span class="section-number-2">3.</span>
      compile()</h2>
      <div class="outline-text-2" id="text-3">
        <div class="org-src-container">
          <pre class="src src-js" id="orgcedfa12"><span class=
          "linenr"> 1: </span><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">compile</span>(<span class=
          "org-variable-name">template</span>, <span class=
          "org-variable-name">options</span> = {}) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">return</span> baseCompile(
<span class="linenr"> 3: </span>    template,
<span class=
"linenr"> 4: </span>    extend({}, parserOptions, options, {
<span class="linenr"> 5: </span>      nodeTransforms: [
<span class="linenr"> 6: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ignore &lt;script&gt; and &lt;tag&gt;</span>
<span class="linenr"> 7: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this is not put inside DOMNodeTransforms because that list is used</span>
<span class="linenr"> 8: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">by compiler-ssr to generate vnode fallback branches</span>
<span class="linenr"> 9: </span>        ignoreSideEffectTags,
<span class="linenr">10: </span>        ...DOMNodeTransforms,
<span class=
"linenr">11: </span>        ...(options.nodeTransforms || [])
<span class="linenr">12: </span>      ],
<span class="linenr">13: </span>      directiveTransforms: extend(
<span class="linenr">14: </span>        {},
<span class="linenr">15: </span>        DOMDirectiveTransforms,
<span class=
"linenr">16: </span>        options.directiveTransforms || {}
<span class="linenr">17: </span>      ),
<span class=
"linenr">18: </span>      transformHoist: __BROWSER__ ? <span class="org-constant">null</span> : stringifyStatic
<span class="linenr">19: </span>    })
<span class="linenr">20: </span>  )
<span class="linenr">21: </span>}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-orgf5b54fb" class="outline-2">
      <h2 id="orgf5b54fb"><span class="section-number-2">4.</span>
      parse</h2>
      <div class="outline-text-2" id="text-4">
        <div class="org-src-container">
          <pre class="src src-js" id="org0b42ac2"><span class=
          "linenr">1: </span><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">parse</span>(<span class=
          "org-variable-name">template</span>, <span class=
          "org-variable-name">options</span> = {}) {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> baseParse(template, extend({}, parserOptions, options))
<span class="linenr">3: </span>}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-org5ae5b01" class="outline-2">
      <h2 id="org5ae5b01"><span class="section-number-2">5.</span>
      testing</h2>
      <div class="outline-text-2" id="text-5">
        <p>更多测试(<a href=
        "https://github.com/vuejs/core/blob/main/packages/compiler-dom/__tests__/transforms/stringifyStatic.spec.ts">core/stringifyStatic.spec.ts
        at main · vuejs/core</a>)：</p>
        <script src="/assets/tests/globalVars.js"></script> 
        <script src="/assets/tests/globalVarsDom.js"></script> 
        <script src="/assets/tests/compiler-core.js"></script> 
        <script src="/assets/tests/compiler-dom.js"></script>
        <div id="h1Mvr33k"></div>
        <script src="/assets/js/vue-json-viewer/index.js"></script>
        
        <script src="/assets/tests/h1Mvr33k.js"></script>
      </div>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Zhicheng Lee</p>
    <p class="date">Created: 2022-05-05 Thu 15:25</p>
  </div>
</body>
</html>
