<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-07-20 Wed 20:33 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>Build your own react</title>
  <meta name="author" content="Lee Zhicheng">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <link rel="icon" type="image/png" sizes="48x48" href=
  "/favicon.ico">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <link rel="stylesheet" href="/assets/js/fancybox/fancybox.css"
  type="text/css" media="screen">
  <script type="text/javascript" src=
  "/assets/js/fancybox/fancybox.umd.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-icons.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/apps.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="react">
  <meta name="createdAt" content="2022-03-06 09:40:27">
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">Build your own react</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#map">1. ä»£ç è„‘å›¾</a>
          </li>
          <li>
            <a href="#preview">2. é¢„è§ˆ</a>
          </li>
          <li>
            <a href="#create-element">3. createElement</a>
          </li>
          <li>
            <a href="#render">4. render</a>
          </li>
          <li>
            <a href="#concurrent">5. å¹¶å‘æ¨¡å¼(workLoop())</a>
          </li>
          <li>
            <a href="#fibers">6. Fibers</a>
          </li>
          <li>
            <a href="#render-commit">7. Render and Commit é˜¶æ®µ</a>
          </li>
          <li>
            <a href="#update-delete">8. updating and deleting
            æ›´æ–°å’Œåˆ é™¤</a>
          </li>
          <li>
            <a href="#function-component">9. å‡½æ•°ç»„ä»¶</a>
          </li>
          <li>
            <a href="#hooks">10. hooks</a>
          </li>
          <li>
            <a href="#src-map">11. æœ€ç»ˆæºç æµç¨‹å›¾</a>
          </li>
          <li>
            <a href="#test">12. æµ‹è¯•</a>
          </li>
          <li>
            <a href="#summary">13. æ€»ç»“</a>
          </li>
        </ul>
      </div>
    </div>
    <p>&lt;badge: GCCLL | Homepage | green | / | gnu-emacs |
    tinder&gt;</p>
    <link href=
    "https://fonts.goo~gleapis.com/cs~s2?family=ZCOOL+XiaoWei&amp;display=swap"
    rel="stylesheet"><kbd><font color="blue" size="3" style=
    "font-family: 'ZCOOL XiaoWei', serif;">è¯—å·ï¼šåŠç¥åŠåœ£äº¦åŠä»™ï¼Œå…¨å„’å…¨é“æ˜¯å…¨è´¤ï¼Œè„‘ä¸­çœŸä¹¦è—ä¸‡å·ï¼ŒæŒæ¡æ–‡æ­¦åŠè¾¹å¤©ã€‚</font></kbd><br>

    <br>
    <script src="/js/react/didact.js"></script> <img src=
    "/img/bdx/shz-001.jpg">
    <blockquote>
      <p>è¯¥æ–‡ä»£ç å‡æ¥è‡ªï¼š<a href=
      "https://pomb.us/build-your-own-react/">Build your own
      React</a>ï¼Œ æ‰€ä»¥æ–‡ä¸­ä»£ç ä¼šä¿æŒå’ŒåŸä½œè€…å®šä¹‰ä¸€è‡´ã€‚</p>
    </blockquote>
    <div id="outline-container-map" class="outline-2">
      <h2 id="map"><span class="section-number-2">1.</span>
      ä»£ç è„‘å›¾</h2>
      <div class="outline-text-2" id="text-map">
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">element</span> = &lt;h1 title=<span class=
          "org-string">"foo"</span>&gt;Hello&lt;/h1&gt;;
<span class="org-keyword">const</span> <span class=
"org-variable-name">container</span> = document.getElementById(<span class="org-string">"root"</span>);
ReactDOM.render(element, container);
</pre>
        </div>
        <div id="orgfa92bee" class="figure">
          <p><img src="file:///assets/img/react/react-zero.svg"
          alt="react-zero.svg" class="org-svg"></p>
        </div>
        <p>å®ç°ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤</p>
        <ol class="org-ol">
          <li>createElement å‡½æ•°å®ç°</li>
          <li>render å‡½æ•°å®ç°</li>
          <li>å¹¶å‘æ¨¡å¼ï¼Œæ¸²æŸ“ä»»åŠ¡çš„æ‰§è¡Œ <code>workLoop()</code> å‡½æ•°</li>
          <li>Fibers react ä¸­é€šè¿‡ fiber ç»“æ„æ¥é“¾æ¥ parent, first child,
          sibling ä»¥åŠä½œä¸ºèŠ‚ ç‚¹çš„ç»“æ„ï¼Œç±»ä¼¼ vue çš„ VNode</li>
          <li>æ¸²æŸ“å’Œ commit é˜¶æ®µï¼Œä¸ºäº†è§£å†³æ¸²æŸ“è¿›ç¨‹å¯èƒ½è¢«æµè§ˆå™¨ä¸­æ–­çš„é—®é¢˜ï¼Œé‡‡å–çš„æ˜¯å»¶è¿Ÿæ¸²æŸ“ï¼Œ å³åœ¨æ‰€æœ‰çš„
          fiber å¤„ç†å®Œä¹‹åï¼Œåœ¨æœ€åæ‰§è¡Œæ¸²æŸ“æ“ä½œã€‚</li>
          <li>æ›´æ–°ï¼Œæ–°å¢ï¼Œåˆ é™¤æ“ä½œ</li>
          <li>å‡½æ•°å¼ç»„ä»¶å®ç°</li>
          <li>é’©å­å‡½æ•°çš„å®ç° <code>useState</code></li>
        </ol>
      </div>
    </div>
    <div id="outline-container-preview" class="outline-2">
      <h2 id="preview"><span class="section-number-2">2.</span>
      é¢„è§ˆ</h2>
      <div class="outline-text-2" id="text-preview">
        <p>react ä½¿ç”¨å®ä¾‹ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">element</span> = &lt;h1 title=<span class=
          "org-string">"foo"</span>&gt;Hello&lt;/h1&gt;;
<span class="org-keyword">const</span> <span class=
"org-variable-name">container</span> = document.getElementById(<span class="org-string">'root'</span>);
ReactDOM.render(element, container)
</pre>
        </div>
        <p>é¦–å…ˆ <code>const element = &lt;h1
        title="foo"&gt;Hello&lt;/h1&gt;;</code> å±äº JSX ä¹¦å†™é£æ ¼ï¼Œè¿™ä¸ªä¼šè¢«è½¬
        æ¢æˆ JS ä»£ç :</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-comment-delimiter">// </span><span class=
          "org-comment">å‚æ•°ï¼š</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">1. type: 'h1' æ ‡ç­¾å</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">2. props: {title: 'foo'} ä¸ºå…ƒç´ çš„å±æ€§å¯¹è±¡</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">3. children: 'Hello' ä¸ºå­å…ƒç´ </span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = React.createElement(<span class="org-string">"h1"</span>, { title: <span class="org-string">"foo"</span> }, <span class="org-string">"Hello"</span>);
</pre>
        </div>
        <p>å…¶æ¬¡æ˜¯ <code>ReactDOM.render(element, container)</code>
        è¿›è¡Œæ¸²æŸ“åˆ°çœŸå®DOMçš„æ“ä½œï¼Œè¿™ä¸ªå‡½æ•°çš„ åŠŸèƒ½ç®€è¿°ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-comment-delimiter">// </span><span class=
          "org-comment">1. æ ¹æ® element.type å»åˆ›å»º off-dom å…ƒç´ </span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">node</span> = document.createElement(element.type);
<span class="org-comment-delimiter">// </span><span class=
"org-comment">2. è®¾ç½®å±æ€§ props</span>
node[<span class="org-string">'title'</span>] = element.props.title

<span class="org-comment-delimiter">// </span><span class=
"org-comment">3. å¤„ç† children å­å…ƒç´ </span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">text</span> = document.createTextNode(<span class="org-string">''</span>)
text[<span class=
"org-string">'nodeValue'</span>] = element.props.children

<span class="org-comment-delimiter">// </span><span class=
"org-comment">4. æœ€åæ›´æ–°åˆ°çœŸå®DOMæ ‘</span>
node.appendChild(text)
container.appendChild(node)
</pre>
        </div>
        <p>æ‰€ä»¥ render å‡½æ•°çš„åŠŸèƒ½æ€»ç»“ä¸‹æ¥å°±åˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p>
        <ol class="org-ol">
          <li>æ‹¿åˆ°èŠ‚ç‚¹çš„ fiber ç»“æ„ï¼Œåˆ›å»º off-dom å…ƒç´ </li>
          <li>å¤„ç† element.props å±æ€§(å¯èƒ½æ˜¯åŠ¨æ€ï¼Œé™æ€ï¼Œä¹Ÿå¯èƒ½æ˜¯äº‹ä»¶å±æ€§)</li>
          <li>å¤„ç† element.children å­å…ƒç´ </li>
          <li>æ›´æ–°åˆ°çœŸå®çš„ DOM æ ‘</li>
        </ol>
        <p>å…·ä½“çš„å®ç°éƒ½æ˜¯å›´ç»•è¿™ä¸ªç‚¹å»å®Œæˆçš„ï¼Œ</p>
        <p>æ¯”å¦‚ <b>1</b> ä¼šä½¿ç”¨ fiber ç»“æ„æ¥ç»„ç»‡æ¯ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹ç»“æ„ä¸€èˆ¬ä¼šæœ‰ä¸‰ä¸ªå¼•ç”¨ï¼š
        parentã€first childã€sibling è¿™ä¸‰ä¸ªé“¾æ¥è¿™ä¸ªæ•´ä¸ªfiber æ ‘çš„ï¼Œè¿™ä¹Ÿä¸ºäº†åé¢èŠ‚ç‚¹æ“ä½œ
        æ—¶æ–¹ä¾¿æŸ¥æ‰¾ã€‚</p>
        <p>åˆæ¯”å¦‚ <b>2</b> ä¸­å¯¹ props çš„å¤„ç†ï¼Œä¼šè€ƒè™‘æ˜¯ä¸æ˜¯äº‹ä»¶å±æ€§ onXxx ã€‚</p>
        <p>ä»¥åŠæœ€åæ›´æ–°çœŸå®DOMçš„æ—¶æœºç­‰å¾…ã€‚</p>
        <blockquote>
          <p>nodeValue: <a href=
          "https://www.w3schools.com/jsref/prop_node_nodevalue.asp">
          HTML DOM nodeValue Property</a></p>
          <div id="orgccc460e" class="figure">
            <p><img src="file:///img/tmp/dom-prop-nodeValue.png"
            alt="dom-prop-nodeValue.png"></p>
          </div>
        </blockquote>
        <p>å®Œæ•´ä»£ç ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-comment-delimiter">// </span><span class=
          "org-comment">createElement: jsx -&gt; js vnode ç»“æ„</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = {
  type: <span class="org-string">'h1'</span>,
  props: {
    title: <span class="org-string">'foo'</span>,
    children: <span class="org-string">'Hello'</span>
  }
}

<span class="org-keyword">const</span> <span class=
"org-variable-name">container</span> = document.getElementById(<span class="org-string">'root'</span>)

<span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆ›å»ºèŠ‚ç‚¹</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">node</span> = document.createElement(element.type)
node[<span class="org-string">'title'</span>] = element.props.title

<span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆ›å»ºå­èŠ‚ç‚¹</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">text</span> = document.createTextNode(<span class="org-string">''</span>)
text[<span class=
"org-string">'nodeValue'</span>] = element.props.children

node.appendChild(text)
container.appendChild(node)
</pre>
        </div><font color="blue">æµ‹è¯•ï¼š</font>
        <div id="c07Rp8"></div>
        <script>
        // createElement: jsx -> js vnode ç»“æ„
        const element = {
        type: 'h1',
        props: {
        title: 'foo',
        children: 'Hello'
        }
        }

        const container = document.getElementById('c07Rp8')

        // åˆ›å»ºèŠ‚ç‚¹
        const node = document.createElement(element.type)
        node['title'] = element.props.title

        // åˆ›å»ºå­èŠ‚ç‚¹
        const text = document.createTextNode('')
        text['nodeValue'] = element.props.children

        node.appendChild(text)
        container.appendChild(node)
        </script>
        <div id="orgd512d53" class="figure">
          <p><img src=
          "file:///assets/img/react/react-render-brief.svg" alt=
          "react-render-brief.svg" class="org-svg"></p>
        </div>
      </div>
    </div>
    <div id="outline-container-create-element" class="outline-2">
      <h2 id="create-element"><span class=
      "section-number-2">3.</span> createElement</h2>
      <div class="outline-text-2" id="text-create-element">
        <p>JSX å®ä¾‹:</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">element</span> = (
  &lt;div id=<span class="org-string">"foo"</span>&gt;
    &lt;a&gt;bar&lt;/a&gt;
    &lt;b /&gt;
  &lt;/div&gt;
)
</pre>
        </div>
        <p>è½¬æˆ JS åè°ƒç”¨ createElement:</p>
        <div class="org-src-container">
          <pre class="src src-js">React.createElement(
  <span class="org-string">"div"</span>,
  {
    id: <span class="org-string">"foo"</span>,
  },
  React.createElement(<span class=
"org-string">"a"</span>, <span class=
"org-constant">null</span>, <span class="org-string">"bar"</span>),
  React.createElement(<span class="org-string">"b"</span>)
);
</pre>
        </div>
        <p>ä¸€ä¸ªèŠ‚ç‚¹åœ¨æ¸²æŸ“åˆ° DOM ä¹‹å‰éƒ½ä¼šæ˜¯ä»¥ä¸€ä¸ªVNode å½¢å¼å­˜åœ¨ï¼Œå…¶ä¸­å°±åŒ…å«æœ€åŸºæœ¬çš„ type, props
        å±æ€§ã€‚</p>
        <p><code>{type: 'div', props: { id: 'foo', children: ... }
        }</code></p>
        <p>è¿™å’Œ vue vnode ç»“æ„æ˜¯ç±»ä¼¼çš„ï¼Œåªä¸è¿‡ vue vnode çš„ children ä¸æ˜¯åœ¨ props
        é‡Œé¢ï¼š</p>
        <p><code>{type: 'div', props: {id: 'foo'}, children: [...]
        }</code></p>
        <p>è¿™é‡Œåªè¦çŸ¥é“ createElement ç›®çš„æ˜¯è§£æèŠ‚ç‚¹ï¼Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹ç»“æ„å¯¹è±¡ï¼Œä¸‹é¢å°±å¯ä»¥å¼€å§‹å° è¯•å®ç°
        createElement äº†</p>
        <p>æœ€ç®€å•çš„å®ç°ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-comment-delimiter">// </span><span class=
          "org-comment">ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹éƒ½å½“åšå­å…ƒç´ </span>
<span class="org-keyword">function</span> <span class=
"org-function-name">createElement</span>(<span class=
"org-variable-name">type</span>, <span class=
"org-variable-name">props</span>, ...<span class=
"org-variable-name">children</span>) {
  <span class="org-keyword">return</span> {
    type,
    props: {
      ...props,
      children,
    },
  };
}

<span class="org-comment-delimiter">// </span><span class=
"org-comment">æ‰€ä»¥ï¼Œä¸Šé¢çš„å®ä¾‹ä¼šæœ‰å¦‚ä¸‹ç»“æ„ï¼š</span>
<span class="org-keyword">var</span> <span class=
"org-variable-name">div</span> = {
  type: <span class="org-string">"div"</span>,
  props: { id: <span class=
"org-string">"foo"</span>, children: [a, b] },
};

<span class="org-keyword">var</span> <span class=
"org-variable-name">a</span> = {
  type: <span class="org-string">"a"</span>,
  props: {
    children: [<span class="org-string">"bar"</span>],
  },
};

<span class="org-keyword">var</span> <span class=
"org-variable-name">b</span> = {
  type: <span class="org-string">"b"</span>,
  props: {
    children: [], <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">æ²¡æœ‰çš„æ—¶å€™é»˜è®¤è¿”å›ç©ºæ•°ç»„</span>
  },
};
</pre>
        </div>
        <p>è¿™é‡Œé¢å¯¹äº children æœ‰ä¸¤ç§ç±»å‹</p>
        <ol class="org-ol">
          <li><code>&lt;a&gt;bar&lt;/a&gt;</code> çš„ children åªæœ‰
          â€œbarâ€ æ˜¯ä¸ªçº¯æ–‡æœ¬ç±»å‹</li>
          <li><code>&lt;div&gt;...&lt;/div&gt;</code> çš„ children
          æœ‰ä¸¤ä¸ªèŠ‚ç‚¹ a å’Œ b ï¼Œä»–ä»¬ç»è¿‡ createElement ä¹‹å
          éƒ½æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿›è¡Œåˆ¤æ–­ä¸‹ï¼Œçº¯æ–‡æœ¬å»åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹</li>
        </ol>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">createElement</span>(<span class=
          "org-variable-name">type</span>, <span class=
          "org-variable-name">props</span>, ...<span class=
          "org-variable-name">children</span>) {
  <span class="org-keyword">return</span> {
    type,
    props: {
      ...props,
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¿™é‡Œå¯¹äºæ–‡æœ¬å†…å®¹ï¼Œå»åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹</span>
      children: children.map((child) =&gt;
        <span class=
"org-keyword">typeof</span> child === <span class=
"org-string">"object"</span> ? child : createTextElement(child)
      ),
    },
  };
}

<span class="org-keyword">function</span> <span class=
"org-function-name">createTextElement</span>(<span class=
"org-variable-name">text</span>) {
  <span class="org-keyword">return</span> {
    type: <span class=
"org-string">"TEXT_ELEMENT"</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">æ ‡è®°ç±»å‹</span>
    props: {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">node.nodeValue å±æ€§å¯ä»¥è®¾ç½®æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹ï¼Œç±»ä¼¼ textContent</span>
      nodeValue: text,
      children: [],
    },
  };
}

<span class="org-comment-delimiter">// </span><span class=
"org-comment">æµ‹è¯•</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = createElement(
  <span class="org-string">"div"</span>,
  { id: <span class="org-string">"foo"</span> },
  createElement(<span class="org-string">"a"</span>, <span class=
"org-constant">null</span>, <span class="org-string">"bar"</span>),
  createElement(<span class="org-string">"b"</span>)
);
console.log(
  <span class="org-string">"è¾“å‡ºç»“æ„&gt;&gt;&gt; \n"</span>,
  element,
  <span class="org-string">"\n &gt; element children: \n"</span>,
  element.props.children,
  <span class="org-string">"\n &gt; a children: \n"</span>,
  element.props.children[<span class=
"org-highlight-numbers-number">0</span>].props.children
);

<span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸ºäº†åŒºåˆ« Reactï¼Œè¿™é‡Œé‡‡ç”¨æ–‡å­—ä½œè€…çš„å‘½åç©ºé—´ï¼š Didact</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">Didact</span> = {
  createElement
}
</pre>
        </div>
        <p>ä¸ºäº†æ–¹ä¾¿åé¢çš„æµ‹è¯•ï¼Œè€ƒè™‘åˆ°ä»£ç ä¼šæ…¢æ…¢å˜é•¿é—®é¢˜ï¼Œåé¢çš„ä»£ç ä¼šç§»åˆ° <a href=
        "file:///js/react/didact.js">file:///js/react/didact.js</a>
        ä¸­å»ã€‚</p>
        <p>ä¹‹åæµ‹è¯•æ–¹å¼ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">import</span>(process.env.BLOG_JS + <span class=
          "org-string">"/react/didact.js"</span>).then(({ <span class=
          "org-keyword">default</span>: Didact }) =&gt; {
  console.log(Didact);
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¿™æ ·ç…§æ ·å¯ä»¥å®Œæˆä¸Šé¢çš„æµ‹è¯•</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = Didact.createElement(
    <span class="org-string">"div"</span>,
    { id: <span class="org-string">"foo"</span> },
    Didact.createElement(<span class=
"org-string">"a"</span>, <span class=
"org-constant">null</span>, <span class="org-string">"bar"</span>),
    Didact.createElement(<span class="org-string">"b"</span>)
  );
  console.log(element);
});
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-render" class="outline-2">
      <h2 id="render"><span class="section-number-2">4.</span>
      render</h2>
      <div class="outline-text-2" id="text-render">
        <p>å¢åŠ  render å‡½æ•°ï¼Œå®ƒçš„ç›®çš„åœ¨ä¸€å¼€å§‹ä¹Ÿè¯´äº†ï¼Œå°±æ˜¯å°† vnode æ¸²æŸ“åˆ°çœŸå®DOMï¼Œè‡³äºæ€ä¹ˆæ¸²
        æŸ“ï¼Œç»“æ„åˆæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Œè¿™ä¹‹åä¼šæ…¢æ…¢çš„å»å®Œæˆã€‚</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">Didact</span> = {
  createElement,
  render
}

<span class="org-comment-delimiter">// </span><span class=
"org-comment">ReactDOM.render</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">render</span>(<span class=
"org-variable-name">element</span>, <span class=
"org-variable-name">container</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span>
}
</pre>
        </div>
        <p>æ¸²æŸ“å½“å‰æ ‘æ ¹èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹å…ƒç´ æ¸²æŸ“å·¥ä½œï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-comment-delimiter">// </span><span class=
          "org-comment">ReactDOM.render</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">render</span>(<span class=
"org-variable-name">element</span>, <span class=
"org-variable-name">container</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ </span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">dom</span> = document.createElement(element.type)

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ </span>
  element.props.children.forEach(child =&gt; render(child, dom <span class="org-comment-delimiter">/*</span><span class="org-comment">parent</span><span class="org-comment-delimiter">*/</span>))

  container.appendChild(dom)
}
</pre>
        </div>
        <p>ä½†æ˜¯èŠ‚ç‚¹ç±»å‹æœ‰å¯èƒ½æ˜¯çº¯æ–‡æœ¬çš„ï¼Œæ¯”å¦‚ <a href=
        "#create-element">createElement ä¸€èŠ‚</a> ä¸­çš„ä¾‹å­é‡Œé¢çš„
        <code>&lt;a&gt;bar&lt;/a&gt;</code> å°±æœ‰ä¸€ä¸ªçº¯æ–‡æœ¬çš„
        <code>"bar"</code> èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹ç»è¿‡ createElement ä¹‹åç»“æ„ æ˜¯ï¼š
        <code>{type: 'TEXT_ELEMENT', props: {...}}</code>
        ï¼Œæ‰€ä»¥è¿™é‡Œé¢åªéœ€è¦é’ˆå¯¹ <code>TEXT_ELEMENT</code>
        åšä¸‹ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœæ˜¯æ–‡æœ¬å°±åˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡æœ¬èŠ‚ç‚¹æ¥å®¹ä¹ƒè¯¥æ–‡æœ¬å†…å®¹ã€‚</p>
        <div class="org-src-container">
          <pre class="src src-diff"><span class=
          "org-diff-context">// ReactDOM.render</span>
<span class=
"org-diff-context">function render(element, container) {</span>
<span class="org-diff-context">  // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ </span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  const dom = document.createElement(element.type)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  const dom =</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    element.type === "TEXT_ELEMENT"</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      ? document.createTextNode("")</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">      : document.createElement(element.type);</span>

<span class="org-diff-context">  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ </span>
<span class=
"org-diff-context">  element.props.children.forEach((child) =&gt; render(child, dom /*parent*/));</span>

<span class="org-diff-context">  container.appendChild(dom);</span>
}
</pre>
        </div>
        <p>æœ€åæ˜¯ props çš„å¤„ç†ï¼Œè¿™é‡Œè®°å¾—è¦æ’é™¤ <code>props.children</code></p>
        <div class="org-src-container">
          <pre class="src src-diff"><span class=
          "org-diff-context">// ReactDOM.render</span>
<span class=
"org-diff-context">function render(element, container) {</span>
<span class="org-diff-context">  // 1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ </span>
<span class="org-diff-context">  const dom =</span>
<span class=
"org-diff-context">    element.type === "TEXT_ELEMENT"</span>
<span class=
"org-diff-context">      ? document.createTextNode("")</span>
<span class=
"org-diff-context">      : document.createElement(element.type);</span>

<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  const isProperty = (key) =&gt; key !== "children";</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  Object.keys(element.props)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    .filter(isProperty)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    .forEach((name) =&gt; (dom[name] = element.props[name]));</span>

<span class="org-diff-context">  // 2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ </span>
<span class=
"org-diff-context">  element.props.children.forEach((child) =&gt; render(child, dom /*parent*/));</span>

<span class="org-diff-context">  container.appendChild(dom);</span>
}
</pre>
        </div>
        <p>æœ€åè¯¥é˜¶æ®µå®Œæ•´çš„ä»£ç ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js">console.log(<span class=
          "org-string">"\n"</span>);
<span class="org-keyword">const</span> <span class=
"org-variable-name">Didact</span> = {
  createElement,
  render,
};

<span class="org-comment-delimiter">// </span><span class=
"org-comment">ReactDOM.render</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">render</span>(<span class=
"org-variable-name">element</span>, <span class=
"org-variable-name">container</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ </span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">dom</span> =
    element.type === <span class="org-string">"TEXT_ELEMENT"</span>
      ? document.createTextNode(<span class="org-string">""</span>)
      : document.createElement(element.type);

  <span class="org-keyword">const</span> <span class=
"org-variable-name">isProperty</span> = (key) =&gt; key !== <span class="org-string">"children"</span>;
  Object.keys(element.props)
    .filter(isProperty)
    .forEach((name) =&gt; (dom[name] = element.props[name]));

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">2. éå†æ‰€æœ‰çš„ children åˆ›å»ºå­å…ƒç´ </span>
  element.props.children.forEach((child) =&gt; render(child, dom <span class="org-comment-delimiter">/*</span><span class="org-comment">parent</span><span class="org-comment-delimiter">*/</span>));

  container.appendChild(dom);
}

<span class="org-comment-delimiter">// </span><span class=
"org-comment">React.createElement</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">createElement</span>(<span class=
"org-variable-name">type</span>, <span class=
"org-variable-name">props</span>, ...<span class=
"org-variable-name">children</span>) {
  <span class="org-keyword">return</span> {
    type,
    props: {
      ...props,
      children: children.map((child) =&gt;
        <span class=
"org-keyword">typeof</span> child === <span class=
"org-string">"object"</span> ? child : createTextElement(child)
      ),
    },
  };
}

<span class="org-keyword">function</span> <span class=
"org-function-name">createTextElement</span>(<span class=
"org-variable-name">text</span>) {
  <span class="org-keyword">return</span> {
    type: <span class="org-string">"TEXT_ELEMENT"</span>,
    props: {
      nodeValue: text, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ç±»ä¼¼ textContent å¯ä»¥ä¿®æ”¹èŠ‚ç‚¹æ–‡æœ¬å†…å®¹çš„å±æ€§</span>
      children: [],
    },
  };
}
</pre>
        </div>
        <p>æµ‹è¯•:</p>
        <div id="qoCIUr"></div>
        <script>
        (function() {
        console.log(Didact)

        const container = document.getElementById('qoCIUr')
        const element = Didact.createElement('div', {
        id: 'foo',
        }, Didact.createElement('a', null, 'bar'),
        Didact.createElement('b'))

        Didact.render(element, container)
        }());
        </script>
        <p>æµ‹è¯•ä»£ç ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js">console.log(Didact);

<span class="org-keyword">const</span> <span class=
"org-variable-name">container</span> = document.getElementById(<span class="org-string">"qoCIUr"</span>);
<span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = Didact.createElement(
  <span class="org-string">"div"</span>,
  {
    id: <span class="org-string">"foo"</span>,
  },
  Didact.createElement(<span class=
"org-string">"a"</span>, <span class=
"org-constant">null</span>, <span class="org-string">"bar"</span>),
  Didact.createElement(<span class="org-string">"b"</span>)
);

Didact.render(element, container);
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-concurrent" class="outline-2">
      <h2 id="concurrent"><span class="section-number-2">5.</span>
      å¹¶å‘æ¨¡å¼(workLoop())</h2>
      <div class="outline-text-2" id="text-concurrent">
        <p>æ³¨æ„çœ‹ä¸Šä¸€èŠ‚æœ€åçš„ä»£ç ï¼Œåœ¨ <a href="#render">render</a> ä¸­ä¼šé€’å½’è°ƒç”¨æ¥å®Œæˆ
        children çš„æ¸²æŸ“å·¥ä½œï¼Œè¿™é‡Œå°± ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œåªè¦ render
        ä¸€æ—¦æ‰§è¡Œï¼Œåœ¨æ¸²æŸ“å®Œæ•´æ£µæ ‘ä¹‹å‰æ˜¯ä¸èƒ½åœæ­¢çš„ï¼Œå¦åˆ™å°†å¯¼è‡´ é¡µé¢ä¸å®Œæ•´ã€‚</p>
        <blockquote>
          <p>æ˜¨å¤©å¾®ä¿¡é‡Œé¢çœ‹åˆ°ä¸€ç¯‡æ–‡ç« ï¼š</p>
          <p><a href=
          "https://mp.weixin.qq.com/s/g_-blGV4CVF5EogYZaPMzQ">Event
          Loop å’Œ JS å¼•æ“ã€æ¸²æŸ“å¼•æ“çš„å…³ç³»</a></p>
          <p>è¿™é‡Œé¢å¤§æ¦‚è®²è¿°äº†ä¸€äº›JS å’Œ æ¸²æŸ“ä¹‹é—´çš„ä¸€äº›å…³ç³»ï¼Œè€Œè¿™é‡Œçš„å®ç°å’Œè¿™æ–‡ç« é‡Œè®²è¿°çš„ä¸€äº›åŸ ç†æ˜¯ç›¸é€šçš„ã€‚</p>
        </blockquote>
        <p>è¦è§£å†³ render é€’å½’çš„é—®é¢˜ï¼Œå¤§è‡´çš„æ€æƒ³æ˜¯é€šè¿‡ Fiber å°†æ¸²æŸ“ä»»åŠ¡å°è£…ï¼Œåœ¨æŸä¸€ä¸ªç©ºé—²çš„ æ—¶åˆ»å»æ‰§è¡Œè¿™äº›
        Fibers è¿›è¡Œå®é™…çš„æ¸²æŸ“ï¼Œè¿™æ ·ä¸è‡³äºé˜»å¡ä¸»ä»»åŠ¡çš„æ‰§è¡Œã€‚</p>
        <p>è¿™é‡Œçš„æ¯ä¸ª Fiber ä¹Ÿè¢«ç§°ä½œ work unitï¼Œå½“ä¸€ä¸ª work unit å®Œæˆä¼šè‡ªåŠ¨æ‰¾åˆ°ä¸‹ä¸€ä¸ªåº”è¯¥æ‰§
        è¡Œçš„ work unit ä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ª Fiberï¼Œä¸ºä»€ä¹ˆå«åº”è¯¥å‘¢ï¼Œå› ä¸ºæ¯ä¸ª Fiber ä¸Šé¢ä¸æ­¢æœ‰ä¸€ä¸ª
        å¼•ç”¨æŒ‡å‘ä¸‹ä¸€ä¸ª Fiberï¼Œç„¶åå¦‚ä½•å†³å®šä¸‹ä¸€ä¸ª work unit è·Ÿæ¸²æŸ“çš„ä¼˜å…ˆçº§æœ‰å…³ç³»ã€‚</p>
        <p>æ¯ä¸ª Fiber ä¸Šé¢æœ€å¤šæœ‰ä¸‰ä¸ªå¼•ç”¨ parent, first child, parent sibling
        ä¸‰ä¸ªèŠ‚ç‚¹ã€‚</p>
        <p>ä¼˜å…ˆçº§æ˜¯: first child &gt; parent sibling &gt; parentã€‚</p>
        <p>å¦‚ä½•æ‰§è¡Œ work unit ?</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">let</span> <span class=
          "org-variable-name">nextUnitOfWork</span> = <span class=
          "org-constant">null</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">workLoop</span>(<span class=
"org-variable-name">deadline</span>) {
  <span class="org-keyword">let</span> <span class=
"org-variable-name">shouldYield</span> = <span class=
"org-constant">false</span>
  <span class=
"org-keyword">while</span> (nextUnitOfWork &amp;& !shouldYield) {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ‰§è¡Œå½“å‰çš„ work unit è¿”å›ä¸‹ä¸€ä¸ªå°†è¦æ‰§è¡Œçš„ work unit</span>
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork)
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ²¡æœ‰ç©ºé—²çš„æ—¶é—´äº†</span>
    shouldYield = deadline.timeRemaining() &lt; <span class=
"org-highlight-numbers-number">1</span>
  }
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸‹ä¸ªç©ºé—²æ—¶é—´å»æ‰§è¡Œä¸‹ä¸€æ¬¡ work unit loop</span>
  requestIdleCallback(workLoop)
}

<span class="org-keyword">function</span> <span class=
"org-function-name">performUnitOfWork</span>(<span class=
"org-variable-name">nextUnitOfWork</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span>
}
</pre>
        </div>
        <div id="org1ffe645" class="figure">
          <p><img src="file:///img/js/request-idle-callback.png"
          alt="request-idle-callback.png"></p>
        </div>
        <p>è¿™é‡Œä½¿ç”¨ <code>requestIdleCallback</code>
        è¿™ä¸ªå‡½æ•°ä¼šåœ¨æ¸²æŸ“ä¹‹å‰æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰ç©ºé—²çš„æ—¶é—´ï¼Œå¦‚æœ æœ‰åˆ™æ‰§è¡Œå›è°ƒï¼Œæˆ–è€…è¶…æ—¶äº†å¼ºåˆ¶æ‰§è¡Œå›è°ƒã€‚</p>
        <blockquote>
          <p>React å·²ç»ä¸ç”¨è¿™ä¸ªäº†ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº† <a href=
          "https://github.com/facebook/react/tree/master/packages/scheduler">
          react/packages/scheduler at master Â· facebook/react</a>
          æ¥ç®¡ç† fiber çš„æ‰§è¡Œæ—¶æœºã€‚</p>
        </blockquote>
      </div>
    </div>
    <div id="outline-container-fibers" class="outline-2">
      <h2 id="fibers"><span class="section-number-2">6.</span>
      Fibers</h2>
      <div class="outline-text-2" id="text-fibers">
        <p>ä¸Šä¸€èŠ‚åœ¨å®ç° <code>workLoop()</code> æåˆ°äº† work unit å³
        fiberã€‚</p>
        <p>ä¸ºäº†æ–¹ä¾¿ç®¡ç†ä¸€ä¸ª work unit ï¼Œéœ€è¦ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„ç»“æ„ï¼Œé‡Œé¢èƒ½ä¿å­˜ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ï¼Œ æ¯”å¦‚ parent,
        first child, parent sibling å¼•ç”¨ï¼Œ VNode èŠ‚ç‚¹ä¿¡æ¯ï¼Œç­‰å¾…ã€‚</p>
        <p>è¿™ä¸ªç»“æœå°±æ˜¯: Fiber tree ç”±ä¸€ä¸ªä¸ª fiber ç»“æ„é€šè¿‡é“¾æ¥ç»„æˆçš„æ ‘ï¼Œå…¶å®å°±æ˜¯ç±»ä¼¼ Vue ä¸­çš„
        VNode èŠ‚ç‚¹æ ‘ã€‚</p>
        <p>ä¾‹å¦‚ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js">Didact.render(
  &lt;div&gt;
    &lt;h1&gt;
      &lt;p /&gt;
      &lt;a /&gt;
    &lt;/h1&gt;
    &lt;h2 /&gt;
  &lt;/div&gt;,
  container
)
</pre>
        </div>
        <p>æœ‰å¦‚ä¸‹çš„ç»“æ„ï¼Œè¯¥ç»“æ„è®©æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ€å¤šæŒæœ‰ä¸‰ä¸ªå¼•ç”¨ï¼Œä»è€Œæ›´æ–¹ä¾¿çš„æ‰¾åˆ°ä¸‹ä¸€ä¸ª work unit:</p>
        <div id="orgd8db6d7" class="figure">
          <p><img src="file:///img/react/fiber-0.png" alt=
          "fiber-0.png"></p>
        </div>
        <p>render æŸ¥æ‰¾æ­¥éª¤æ‹†è§£ï¼š</p>
        <p><code>root</code> -&gt; <code>&lt;div&gt;</code> -&gt;
        <code>&lt;h1&gt;</code> -&gt; <code>&lt;p&gt;</code> è¿™æ˜¯éµå¾ª
        first child ä¼˜å…ˆçº§æœ€é«˜æŸ¥æ‰¾çš„ç»“æœï¼Œä¸€æ—¦è¿™ä¸ª è¿‡ç¨‹æ¸²æŸ“å®Œæˆï¼Œæ¥ä¸‹æ¥åº”è¯¥æ‰¾
        <code>&lt;p&gt;</code> çš„ sibling(å› ä¸º sibling ä¼˜å…ˆçº§é«˜äº parent ä½äº
        first child):</p>
        <p><code>&lt;a&gt;</code> -&gt; <code>&lt;h2&gt;</code> å› ä¸º
        <code>&lt;a&gt;</code> æ—¢æ²¡æœ‰ first child ä¹Ÿæ²¡æœ‰ sibling æ‰€ä»¥æ‰¾
        parent sibling å³ <code>&lt;h2&gt;</code> ç„¶åç»§ç»­æ‰¾å‘ç°
        <code>&lt;div&gt;</code> å¹¶æ²¡æœ‰ siblingï¼Œä¸€ç›´å¦‚æ­¤çŸ¥é“æ ¹èŠ‚ç‚¹ã€‚</p>
        <p>æ›´æ–° render å‡½æ•°ï¼Œå°† DOM å…ƒç´ çš„åˆ›å»ºä» render ä¸­æŠ½ç¦»å‡ºæ¥æˆ
        <code>createDom</code> å‡½æ•°ï¼Œè¿™é‡Œå¼€å§‹ä½¿ç”¨ fiber:</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">createDom</span>(<span class=
          "org-variable-name">fiber</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">1. åˆ›å»ºå½“å‰æ ‘æ ¹èŠ‚ç‚¹å…ƒç´ </span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">dom</span> =
    fiber.type === <span class="org-string">"TEXT_ELEMENT"</span>
      ? document.createTextNode(<span class="org-string">""</span>)
      : document.createElement(fiber.type);

  <span class="org-keyword">const</span> <span class=
"org-variable-name">isProperty</span> = (key) =&gt; key !== <span class="org-string">"children"</span>;
  Object.keys(fiber.props)
    .filter(isProperty)
    .forEach((name) =&gt; (fiber[name] = fiber.props[name]));

  <span class="org-keyword">return</span> dom;
}

<span class="org-keyword">let</span> <span class=
"org-variable-name">nextUnitOfWork</span> = <span class=
"org-constant">null</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">render</span>(<span class=
"org-variable-name">element</span>, <span class=
"org-variable-name">container</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ„å»º root fiber ä½œä¸ºç¬¬ä¸€ä¸ª nextUnitOfWork</span>
  nextUnitOfWork = {
    dom: container,
    props: {
      children: [element]
    }
  }
}
</pre>
        </div>
        <p>åœ¨ render ä¸€å¼€å§‹ä¼šåˆ›å»ºä¸€ä¸ª root fiber å¹¶ä¸”å°†å®ƒä½œä¸ºç¬¬ä¸€ä¸ª
        <code>nextUnitOfWork</code> ï¼Œè€Œå é¢åˆ™æ˜¯æ‰§è¡Œ
        <code>performUnitOfWork</code> è¿™é‡Œé¢ä¸»è¦å®Œæˆä¸‰éƒ¨åˆ†ä»»åŠ¡ï¼š</p>
        <ol class="org-ol">
          <li>å°† fiber å¯¹åº”çš„ element æ·»åŠ åˆ° DOM</li>
          <li>ä¸º <b>1</b> ä¸­çš„ <code>element.children</code> åˆ›å»º
          fibers</li>
          <li>æ‰¾åˆ°åˆé€‚çš„ä¸‹ä¸€ä¸ª work unit è¿”å›</li>
        </ol>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">performUnitOfWork</span>(<span class=
          "org-variable-name">fiber</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">1. åˆ›å»º fiber dom å…ƒç´ </span>
  <span class="org-keyword">if</span> (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">2. å°† fiber dom æ·»åŠ åˆ° parent DOM æ ‘ä¸­å»</span>
  <span class="org-keyword">if</span> (fiber.parent) {
    fiber.parent.dom.appendChild(fiber.dom);
  }

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">3. å¤„ç† children</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">elements</span> = fiber.props.children;
  <span class="org-keyword">let</span> <span class=
"org-variable-name">index</span> = <span class=
"org-highlight-numbers-number">0</span>;
  <span class="org-keyword">let</span> <span class=
"org-variable-name">prevSibling</span> = <span class=
"org-constant">null</span>;

  <span class=
"org-keyword">while</span> (index &lt; elements.length) {
    <span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = elements[index];

    <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸ºæ¯ä¸ª child æ„å»º fiber ç»“æ„</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">newFiber</span> = {
      type: element.type,
      props: element.props,
      parent: fiber, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">æŒ‡å‘çˆ¶çº§ fiber çš„å¼•ç”¨</span>
      dom: <span class="org-constant">null</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">æŒ‡å‘çœŸå®DOMå…ƒç´ çš„å¼•ç”¨</span>
    };

    <span class="org-keyword">if</span> (indx === <span class=
"org-highlight-numbers-number">0</span>) {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¡¨ç¤ºæ˜¯ parent çš„ç¬¬ä¸€ä¸ª childï¼Œæ ‡è®°ä¸º first child</span>
      firber.child = newFiber; <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ç¬¬ä¸€ä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§æœ€é«˜</span>
    } <span class="org-keyword">else</span> {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">éç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œç­‰äºæ˜¯èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">ç¬¬äºŒä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§ä½äº first child</span>
      prevSibling.sibling = newFiber;
    }

    prevSibling = newFiber;
    index++;
  }

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆ°è¿™é‡Œ fiber ç»“æ„åˆå§‹åŒ–å®Œæˆï¼Œæ­¤æ—¶æ¯ä¸ª fiber ä¹Ÿæœ‰äº†è‡ªå·±çš„</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸‰ä¸ªå¼•ç”¨ fiber.child, fiber.parent, fiber.sibling</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸‹é¢å°†è¦å»æ‰¾åˆ°å½“å‰ Fiber çš„ä¸‹ä¸€ä¸ª work unitï¼ŒæŸ¥æ‰¾éµå¾ªä¼˜å…ˆçº§:</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">fiber.child &gt; fiber.sibling &gt; fiber.parent.sibling</span>
  <span class="org-keyword">if</span> (fiber.child) {
    <span class="org-keyword">return</span> fiber.child;
  }
  <span class="org-keyword">let</span> <span class=
"org-variable-name">nextFiber</span> = fiber;
  <span class="org-keyword">while</span> (nextFiber) {
    <span class="org-keyword">if</span> (nextFiber.sibling) {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">ç¬¬ä¸€æ¬¡è¿™é‡Œæ‰¾çš„æ˜¯å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æ‰¾åˆ°</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¾ç€ fiber æ ‘å¾€ä¸Šæ‰¾ parent çš„ sibling</span>
      <span class="org-keyword">return</span> nextFiber.sibling;
    }

    nextFiber = fiber.parent;
  }
}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-render-commit" class="outline-2">
      <h2 id="render-commit"><span class=
      "section-number-2">7.</span> Render and Commit é˜¶æ®µ</h2>
      <div class="outline-text-2" id="text-render-commit">
        <p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå‰é¢éƒ½åªæ˜¯åœ¨ fiber tree åŸºç¡€ä¸Šå»åšäº†å¤„ç†ï¼ˆåˆ›å»º DOM å…ƒç´ ï¼Œé“¾æ¥ fiber
        treeï¼Œæ‰¾ä¸‹ä¸€ä¸ª work unitï¼‰ï¼Œä½†å®é™…å¹¶æ²¡æœ‰å¼€å§‹æ¸²æŸ“ã€‚</p>
        <p>å¹¶ä¸”è¿™é‡Œ performUnitOfWork å®ç°ä¸­æœ‰ä¸ªé—®é¢˜ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">if</span> (fiber.parent) {
  fiber.parent.dom.appendChild(fiber.dom);
}
</pre>
        </div>
        <p>å³è¿™é‡Œæ¯æ¬¡æ‰§è¡Œ work unit çš„æ—¶å€™éƒ½ä¼šç«‹å³å°† fiber.dom æ·»åŠ åˆ° parent çš„ DOM
        ğŸŒ²ä¸­å»ï¼Œ ç„¶åè¿™ä¸ªæ“ä½œå¾ˆæœ‰å¯èƒ½åœ¨å®Œæˆæ•´æ£µæ ‘çš„æ¸²æŸ“ä¹‹å‰è¢«æµè§ˆå™¨ç»™ç»ˆæ­¢äº†ã€‚</p>
        <p>æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</p>
        <p>ä»æ ¹ä¸Šå»è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå³åœ¨ render ä¸­ä¸ç”¨ä¸€å¼€å§‹å°±å»è¿›è¡Œ append æ“ä½œï¼Œè€Œæ˜¯ä» root
        å¼€å§‹å»è·Ÿè¸ªæ•´ä¸ªæ ‘çš„ç»“æ„å˜åŒ–ï¼Œå°† root ä¹Ÿå°è£…æˆ fiberã€‚</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">let</span> <span class=
          "org-variable-name">wipRoot</span> = <span class=
          "org-constant">null</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">render</span>(<span class=
"org-variable-name">element</span>, <span class=
"org-variable-name">container</span>) {
  wipRoot = {
    dom: container,
    props: {
      children: [element]
    }
  }

  nextUnitOfWork = wipRoot
}
</pre>
        </div>
        <p>ç„¶åï¼Œä¸€æ—¦ wookLoop() çš„ä¸€æ¬¡å¾ªç¯ç»“æŸäº†å°±è¿›è¡Œä¸€æ¬¡æäº¤ï¼Œå»ä¸€æ¬¡æ€§å®Œæˆæ¸²æŸ“ä»»åŠ¡ã€‚</p>
        <p>é‚£æ€ä¹ˆåˆ¤æ–­è¯´ä¸€æ¬¡å¾ªç¯ç»“æŸäº†ï¼Ÿ</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">commitRoot</span>() {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ‰§è¡Œ DOM æ¸²æŸ“</span>
  commitWork(wipRoot.child);
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æäº¤å®Œæˆä¹‹åè¦é‡ç½®ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ›´æ–°çš„ä»»åŠ¡</span>
  wipRoot = <span class="org-constant">null</span>;
}

<span class="org-keyword">function</span> <span class=
"org-function-name">commitWork</span>(<span class=
"org-variable-name">fiber</span>) {
  <span class="org-keyword">if</span> (!fiber) <span class=
"org-keyword">return</span>;

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -&gt; fiber.child -&gt; fiber.sibling</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">domParent</span> = fiber.parent.dom;
  domParent.appendChild(fiber.dom);
  commitWork(fiber.child);
  commitWork(fiber.sibling);
}

<span class="org-keyword">function</span> <span class=
"org-function-name">workLoop</span>(<span class=
"org-variable-name">deadline</span>) {
  <span class="org-keyword">let</span> <span class=
"org-variable-name">shouldYield</span> = <span class=
"org-constant">false</span>;
  <span class=
"org-keyword">while</span> (nextUnitOfWork &amp;& !shouldYield) {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ‰§è¡Œå½“å‰çš„ work unit è¿”å›ä¸‹ä¸€ä¸ªå°†è¦æ‰§è¡Œçš„ work unit</span>
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ²¡æœ‰ç©ºé—²çš„æ—¶é—´äº†</span>
    shouldYield = deadline.timeRemaining() &lt; <span class=
"org-highlight-numbers-number">1</span>;
  }

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¿™é‡Œæ£€æµ‹æ²¡æœ‰ä¸‹ä¸€ä¸ª work unit äº†ï¼Œè¯´æ˜æ•´ä¸ªæ ‘éå†å®Œæˆäº†</span>
  <span class=
"org-keyword">if</span> (!nextUnitOfWork &amp;& wipRoot) {
    commitRoot();
  }

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸‹ä¸ªç©ºé—²æ—¶é—´å»æ‰§è¡Œä¸‹ä¸€æ¬¡ work unit loop</span>
  requestIdleCallback(workLoop);
}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-update-delete" class="outline-2">
      <h2 id="update-delete"><span class=
      "section-number-2">8.</span> updating and deleting æ›´æ–°å’Œåˆ é™¤</h2>
      <div class="outline-text-2" id="text-update-delete">
        <p>è¿™ä¸€èŠ‚å°†è®²è¿°å¦‚ä½•å°† old fiber å’Œ new fiber è¿›è¡Œæ¯”è¾ƒæ¥åˆ¤æ–­æ˜¯è¿›è¡Œ update è¿˜æ˜¯
        delete æ“ä½œã€‚</p>
        <p>æ‰€ä»¥ Fiber é‡Œé¢éœ€è¦å¯¹ä¸Šä¸€æ¬¡çš„æäº¤çš„ fiber tree è¿›è¡Œå¤‡ä»½ã€‚</p>
        <p>è¿™é‡Œç”¨ <code>currentRoot</code> è¡¨ç¤º new fiber ç”¨
        fiber.alternate æ¥ä¿å­˜ old fiberã€‚</p>
        <div class="org-src-container">
          <pre class="src src-diff"><span class=
          "org-diff-indicator-added">+</span><span class=
          "org-diff-added"> let currentRoot = null</span>
<span class="org-diff-context">function commitRoot() {</span>
<span class="org-diff-context">  commitWork(wipRoot.child)</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  // å½“å‰æ¸²æŸ“çš„æ ‘è¿›è¡Œå¤‡ä»½</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  currentRoot = wipRoot</span>
<span class="org-diff-context">  wipRoot = null</span>
<span class="org-diff-context">}</span>

<span class=
"org-diff-context">function render(element, container) {</span>
<span class="org-diff-context">  wipRoot = {</span>
<span class="org-diff-context">    dom: container,</span>
<span class="org-diff-context">    props: {</span>
<span class="org-diff-context">      children: [element]</span>
<span class="org-diff-context">    },</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    // ä¿å­˜ä¸€ä»½è€æ ‘</span>
<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">    alternate: currentRoot</span>
<span class="org-diff-context">  }</span>

<span class="org-diff-context">  nextUnitOfWork = wipRoot</span>
}
</pre>
        </div>
        <p>å°† <code>performUnitOfWork</code> ä¸­åˆ›å»º Fiber çš„æŠ½ç¦»åˆ°
        <code>reconcileChildren</code> ä¸­å»æ–¹ä¾¿æ·»åŠ æ›´ æ–°å’Œåˆ é™¤æ“ä½œã€‚</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">reconcileChildren</span>(<span class=
          "org-variable-name">wipFiber</span>, <span class=
          "org-variable-name">elements</span>) {
  <span class="org-keyword">let</span> <span class=
"org-variable-name">index</span> = <span class=
"org-highlight-numbers-number">0</span>;
  <span class="org-keyword">let</span> <span class=
"org-variable-name">oldFiber</span> = wipFiber.alternate &amp;& wipFiber.alternate.child
  <span class="org-keyword">let</span> <span class=
"org-variable-name">prevSibling</span> = <span class=
"org-constant">null</span>;

  <span class=
"org-keyword">while</span> (index &lt; elements.length) {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¿™ä¸ª element æ˜¯å°†è¦æ›´æ–°åˆ°DOMä¸­çš„èŠ‚ç‚¹</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = elements[index];
    <span class="org-keyword">let</span> <span class=
"org-variable-name">newFiber</span> = <span class=
"org-constant">null</span>

    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ¯”è¾ƒ oldFiber å’Œ element</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">ç±»å‹ä¸€æ ·ï¼Œå±äºæ›´æ–°</span>
    <span class="org-keyword">const</span> <span class=
"org-variable-name">sameType</span> = oldFiber &amp;& element &amp;& oldFiber.type === element.type
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸‹é¢çš„æ›´æ–°å¹¶éæ˜¯ç›´æ¥ç«‹å³æ›´æ–°ï¼Œè€Œæ˜¯ä¸º Fiber èµ‹äºˆæ–°çš„å±æ€§æ¥æ ‡è¯†è¯¥èŠ‚ç‚¹</span>
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">åœ¨ commit é˜¶æ®µåº”è¯¥æ‰§è¡Œä»€ä¹ˆæ“ä½œ</span>

    <span class="org-keyword">if</span> (sameType) {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ›´æ–°èŠ‚ç‚¹</span>
      newFiber = {
        type: oldFiber.type,
        props: element.props,
        dom: oldFiber.dom,
        parent: wipFiber,
        alternate: oldFiber,
        effectTag: <span class="org-string">'UPDATE'</span>
      }
    }

    <span class=
"org-keyword">if</span> (element &amp;& !sameType) {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ·»åŠ èŠ‚ç‚¹</span>
      newFiber = {
        type: element.type,
        props: element.props,
        dom: <span class="org-constant">null</span>,
        parent: wipFiber,
        alternate: <span class="org-constant">null</span>,
        effectTag: <span class="org-string">'PLACEMENT'</span>
      }
    }

    <span class=
"org-keyword">if</span> (oldFiber &amp;& !sameType) {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆ é™¤èŠ‚ç‚¹</span>
      oldFiber.effecTag = <span class=
"org-string">'DELETION'</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">å› ä¸º commit æ˜¯ä» root ä»ä¸Šå¾€ä¸‹æäº¤çš„ï¼Œä¸”åœ¨æäº¤é˜¶æ®µ</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">å·²ç»ä¸¢å¤±äº† old fiberï¼Œå› ä¸ºä¸Šé¢ç»“æ„å·²ç»æ›´æ–°äº†ï¼Œå› æ­¤è¿™é‡Œéœ€è¦è®°å½•</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">å“ªäº›èŠ‚ç‚¹éœ€è¦åˆ é™¤</span>
      deletion.push(oldFiber)
    }

    <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸ºæ¯ä¸ª child æ„å»º fiber ç»“æ„</span>
    newFiber = {
      type: element.type,
      props: element.props,
      parent: fiber, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">æŒ‡å‘çˆ¶çº§ fiber çš„å¼•ç”¨</span>
      dom: <span class="org-constant">null</span>, <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">æŒ‡å‘çœŸå®DOMå…ƒç´ çš„å¼•ç”¨</span>
    };

    <span class="org-keyword">if</span> (indx === <span class=
"org-highlight-numbers-number">0</span>) {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¡¨ç¤ºæ˜¯ parent çš„ç¬¬ä¸€ä¸ª childï¼Œæ ‡è®°ä¸º first child</span>
      firber.child = newFiber; <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">ç¬¬ä¸€ä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§æœ€é«˜</span>
    } <span class="org-keyword">else</span> {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">éç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œç­‰äºæ˜¯èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">ç¬¬äºŒä¸ªå¼•ç”¨ï¼Œä¼˜å…ˆçº§ä½äº first child</span>
      prevSibling.sibling = newFiber;
    }

    prevSibling = newFiber;
    index++;
  }
}
</pre>
        </div>
        <p>ç„¶åä¿®æ”¹ render ï¼Œåˆå§‹åŒ–æˆ–é‡ç½® deletion:</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">let</span> <span class=
          "org-variable-name">deletion</span> = <span class=
          "org-constant">null</span>
<span class="org-comment-delimiter">// </span><span class=
"org-comment">ReactDOM.render</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">render</span>(<span class=
"org-variable-name">element</span>, <span class=
"org-variable-name">container</span>) {
  wipRoot = {
    dom: container,
    props: {
      children: [element],
    },
    alternate: currentRoot,
  };

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆå§‹åŒ–æˆ–é‡ç½®å¾…åˆ é™¤çš„èŠ‚ç‚¹ï¼Œå› ä¸º fiber tree æ›´æ–°å‘ç”Ÿåœ¨ commit ä¹‹å‰</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">å› æ­¤åœ¨ commit é˜¶æ®µ old fiber å·²ç»è¢«æ›¿æ¢äº†ï¼Œæ‰€ä»¥åœ¨ fiber tree æ›´æ–°çš„</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ—¶å€™å°±è¦å°†è¦åˆ é™¤çš„ old fiber ç¼“å­˜èµ·æ¥</span>
  deletion = [];
  nextUnitOfWork = wipRoot;
}
</pre>
        </div>
        <p>ç„¶ååœ¨æäº¤é˜¶æ®µ commitRoot ä¸­æ‰§è¡Œåˆ é™¤</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">commitRoot</span>() {
  deletion.forEach(commitWork) <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">æ‰§è¡ŒèŠ‚ç‚¹åˆ é™¤</span>
  commitWork(wipRoot.child)
  currentRoot = wipRoot
  wipRoot = <span class="org-constant">null</span>
}

</pre>
        </div>
        <p>æœ€åä¿®æ”¹ commitWork å»å¤„ç†æ–°å¢çš„ fiber.effectTag æ ¹æ®ä¸åŒç±»å‹æ‰§è¡Œç›¸åº”çš„å¢åŠ ã€åˆ 
        é™¤ã€æ›´æ–°æ“ä½œã€‚</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">commitWork</span>(<span class=
          "org-variable-name">fiber</span>) {
  <span class="org-keyword">if</span> (!fiber) <span class=
"org-keyword">return</span>;

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -&gt; fiber.child -&gt; fiber.sibling</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">domParent</span> = fiber.parent.dom;
  <span class=
"org-keyword">if</span> (fiber.effectTag === <span class=
"org-string">"PLACEMENT"</span> &amp;& fiber.dom != <span class=
"org-constant">null</span>) {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ·»åŠ æ–°èŠ‚ç‚¹</span>
    domParent.appendChild(fiber.dom);
  } <span class="org-keyword">else</span> <span class=
"org-keyword">if</span> (fiber.effectTag === <span class=
"org-string">"DELETION"</span>) {
    domParent.removeChild(fiber.dom);
  } <span class="org-keyword">else</span> <span class=
"org-keyword">if</span> (fiber.effectTag === <span class=
"org-string">"UPDATE"</span> &amp;& fiber.dom != <span class=
"org-constant">null</span>) {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ›´æ–°èŠ‚ç‚¹</span>
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  }

  commitWork(fiber.child);
  commitWork(fiber.sibling);
}
</pre>
        </div>
        <p>æ›´æ–°èŠ‚ç‚¹ï¼Œéœ€è¦å¯¹çŠ¶æ€è¿›è¡Œå¯¹æ¯”ï¼Œè¿›è¡Œæ›´æ–°ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">isProperty</span> = (key) =&gt; key !== <span class="org-string">"children"</span>;
<span class="org-comment-delimiter">// </span><span class=
"org-comment">æ–°å±æ€§</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">isNew</span> = (prev, next) =&gt; (key) =&gt; prev[key] !== next[key];
<span class="org-comment-delimiter">// </span><span class=
"org-comment">è¦åˆ é™¤çš„å±æ€§</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">isGone</span> = (prev, next) =&gt; (key) =&gt; !key <span class="org-keyword">in</span> next;
<span class="org-keyword">function</span> <span class=
"org-function-name">updateDom</span>(<span class=
"org-variable-name">dom</span>, <span class=
"org-variable-name">prevProps</span>, <span class=
"org-variable-name">nextProps</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆ é™¤</span>
  Object.keys(prevProps)
    .filter(isProperty)
    .filter(isGone(prevProps, nextProps))
    .forEach((name) =&gt; (dom[name] = <span class=
"org-string">""</span>));

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ›´æ–°æ–°å¢</span>
  Object.keys(nextProps)
  .filter(isProperty)
  .filter(isNew(prevProps, nextProps))
  .forEach(name =&gt; (dom[name] = nextProps[name]))
}
</pre>
        </div>
        <p>å¤„ç†ç‰¹æ®Šå±æ€§ï¼šäº‹ä»¶å±æ€§çš„å¤„ç†ï¼Œéœ€è¦å°†åŸæ¥çš„ handler å…ˆç§»é™¤å†æ·»åŠ æ–°çš„ handlerã€‚</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">isEvent</span> = (key) =&gt; key.startsWith(<span class="org-string">"on"</span>);
<span class="org-keyword">const</span> <span class=
"org-variable-name">isProperty</span> = (key) =&gt; key !== <span class="org-string">"children"</span> &amp;& !isEvent(key);
<span class="org-comment-delimiter">// </span><span class=
"org-comment">æ–°å±æ€§</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">isNew</span> = (prev, next) =&gt; (key) =&gt; prev[key] !== next[key];
<span class="org-comment-delimiter">// </span><span class=
"org-comment">è¦åˆ é™¤çš„å±æ€§</span>
<span class="org-keyword">const</span> <span class=
"org-variable-name">isGone</span> = (prev, next) =&gt; (key) =&gt; !key <span class="org-keyword">in</span> next;
<span class="org-keyword">function</span> <span class=
"org-function-name">updateDom</span>(<span class=
"org-variable-name">dom</span>, <span class=
"org-variable-name">prevProps</span>, <span class=
"org-variable-name">nextProps</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">ç§»é™¤æˆ–æ›´æ–° event listeners</span>
  Object.keys(prevProps)
    .filter(isEvent)
    .filter((key) =&gt; !(key <span class=
"org-keyword">in</span> nextProps) || isNew(prevProps, nextProps)(key))
    .forEach((name) =&gt; {
      <span class="org-keyword">const</span> <span class=
"org-variable-name">eventType</span> = name.toLowerCase().substring(<span class="org-highlight-numbers-number">2</span>);
      dom.removeEventListener(eventType, prevProps[name]);
    });
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆ é™¤</span>
  Object.keys(prevProps)
    .filter(isProperty)
    .filter(isGone(prevProps, nextProps))
    .forEach((name) =&gt; (dom[name] = <span class=
"org-string">""</span>));

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ›´æ–°æ–°å¢</span>
  Object.keys(nextProps)
    .filter(isProperty)
    .filter(isNew(prevProps, nextProps))
    .forEach((name) =&gt; (dom[name] = nextProps[name]));

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ–°å¢äº‹ä»¶å±æ€§</span>
  Object.keys(nextProps)
    .filter(isEvent)
    .filter(isNew(prevProps, nextProps))
    .forEach((name) =&gt; {
      <span class="org-keyword">const</span> <span class=
"org-variable-name">eventType</span> = name.toLowerCase().substring(<span class="org-highlight-numbers-number">2</span>);
      dom.addEventListener(eventType, nextProps[name]);
    });
}
</pre>
        </div>
        <p>ä¿®æ”¹ createDom åˆåˆ›å»º DOM å…ƒç´ çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ <code>updateDom(dom, {},
        fiber.props)</code></p>
        <div class="org-src-container">
          <pre class="src src-diff"><span class=
          "org-diff-context">function createDom(fiber) {</span>
<span class=
"org-diff-context">  const dom = fiber.type === 'TEXT_ELEMENT'</span>
<span class=
"org-diff-context">    ? document.createTextNode('')</span>
<span class=
"org-diff-context">    : document.createElement(fiber.type)</span>

<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  const isProperty = (key) =&gt; key !== "children";</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">  Object.keys(fiber.props)</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    .filter(isProperty)</span>
<span class="org-diff-indicator-removed">-</span><span class=
"org-diff-removed">    .forEach((name) =&gt; (fiber[name] = fiber.props[name]));</span>

<span class="org-diff-indicator-added">+</span><span class=
"org-diff-added">  updateDom(dom, {}, fiber.props)</span>

<span class="org-diff-context">  return dom</span>
}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-function-component" class=
    "outline-2">
      <h2 id="function-component"><span class=
      "section-number-2">9.</span> å‡½æ•°ç»„ä»¶</h2>
      <div class="outline-text-2" id="text-function-component">
        <p>å¦‚å®ä¾‹ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">App</span>(<span class=
          "org-variable-name">props</span>) {
  <span class=
"org-keyword">return</span> &lt;h1&gt;Hi {props.name}&lt;/h1&gt;
}
<span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = &lt;App name=<span class=
"org-string">"foo"</span>/&gt;
<span class="org-comment-delimiter">// </span><span class=
"org-comment">jsx -&gt; js</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">App</span>(<span class=
"org-variable-name">props</span>) {
  <span class=
"org-keyword">return</span> Didact.createElement(<span class=
"org-string">'h1'</span>, <span class=
"org-constant">null</span>, <span class=
"org-string">"Hi "</span>, props.name)
}
<span class="org-keyword">const</span> <span class=
"org-variable-name">element</span> = Didact.createElement(App, {
  name: <span class="org-string">'foo'</span>
})
</pre>
        </div>
        <p>å‡½æ•°ç»„ä»¶ä¸æ™®é€šç»„ä»¶ä¸åŒç‚¹:</p>
        <ol class="org-ol">
          <li>æ¥è‡ªå‡½æ•°ç»„ä»¶çš„ Fiber æ²¡æœ‰ DOM èŠ‚ç‚¹</li>
          <li>fiber.children æ¥è‡ªå‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œè€Œä¸æ˜¯ç›´æ¥ä» props ä¸­å–</li>
        </ol>
        <p>ä¿®æ”¹ performUnitOfWork å¢åŠ å‡½æ•°ç»„ä»¶åˆ¤æ–­:</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">performUnitOfWork</span>(<span class=
          "org-variable-name">fiber</span>) {
  <span class="org-keyword">const</span> <span class=
"org-variable-name">isFunctionComponent</span> = fiber.type <span class="org-keyword">instanceof</span> <span class="org-type">Function</span>
  <span class="org-keyword">if</span> (isFunctionComponent) {
    updateFunctionComponent(fiber)
  } <span class="org-keyword">else</span> {
    updateHostComponent(fiber)
  }

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">åˆ°è¿™é‡Œ fiber ç»“æ„åˆå§‹åŒ–å®Œæˆï¼Œæ­¤æ—¶æ¯ä¸ª fiber ä¹Ÿæœ‰äº†è‡ªå·±çš„</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸‰ä¸ªå¼•ç”¨ fiber.child, fiber.parent, fiber.sibling</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¸‹é¢å°†è¦å»æ‰¾åˆ°å½“å‰ Fiber çš„ä¸‹ä¸€ä¸ª work unitï¼ŒæŸ¥æ‰¾éµå¾ªä¼˜å…ˆçº§:</span>
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">fiber.child &gt; fiber.sibling &gt; fiber.parent.sibling</span>
  <span class="org-keyword">if</span> (fiber.child) {
    <span class="org-keyword">return</span> fiber.child;
  }
  <span class="org-keyword">let</span> <span class=
"org-variable-name">nextFiber</span> = fiber;
  <span class="org-keyword">while</span> (nextFiber) {
    <span class="org-keyword">if</span> (nextFiber.sibling) {
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">ç¬¬ä¸€æ¬¡è¿™é‡Œæ‰¾çš„æ˜¯å½“å‰èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æ‰¾åˆ°</span>
      <span class="org-comment-delimiter">// </span><span class=
"org-comment">ä¾ç€ fiber æ ‘å¾€ä¸Šæ‰¾ parent çš„ sibling</span>
      <span class="org-keyword">return</span> nextFiber.sibling;
    }

    nextFiber = nextFiber.parent;
  }
}
</pre>
        </div>
        <p>æ›´æ–°å‡½æ•°ç»„ä»¶ <code>updateFunctionComponent(fiber)</code> :</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">updateFunctionComponent</span>(<span class=
          "org-variable-name">fiber</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ‰§è¡Œå‡½æ•°ç»„ä»¶å¾—åˆ° children</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">children</span> = [fiber.type(fiber.props)]
  reconcileChildren(fiber, children)
}
</pre>
        </div>
        <p>æ›´æ–°æ™®é€šç»„ä»¶ <code>updateHostComponent(fiber)</code> ç›´æ¥æŠŠ
        performUnitOfWork ä¸­åŸæ¥çš„å¤„ç† æŒªè¿›æ¥å°± OK:</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">updateHostComponent</span>(<span class=
          "org-variable-name">fiber</span>) {
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">1. åˆ›å»º fiber dom å…ƒç´ </span>
  <span class="org-keyword">if</span> (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }

  reconcileChildren(fiber, fiber.props.children);
}
</pre>
        </div>
        <p>å› ä¸ºå‡½æ•°ç»„ä»¶å¹¶æ²¡æœ‰ DOM å…ƒç´ ï¼Œæ‰€ä»¥ commit é˜¶æ®µéœ€è¦è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰å°±å¾€ä¸Šæ‰¾çˆ¶çº§ çš„ dom
        å…ƒç´ ä½œä¸º parent ã€‚</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">commitWork</span>(<span class=
          "org-variable-name">fiber</span>) {
  <span class="org-keyword">if</span> (!fiber) <span class=
"org-keyword">return</span>;

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">è¿™é‡Œé¡ºåºä¹Ÿæ˜¯ä¸€æ · fiber -&gt; fiber.child -&gt; fiber.sibling</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">domParentFiber</span> = fiber.parent;
  <span class="org-comment-delimiter">// </span><span class=
"org-comment">å¦‚æœæ˜¯å‡½æ•°ç»„ä»¶æ˜¯æ²¡æœ‰ dom çš„ï¼Œé‚£ä¹ˆéœ€è¦æ‰¾åˆ°å®ƒçš„çˆ¶çº§ä½œä¸ºç›®æ ‡ parent</span>
  <span class="org-keyword">while</span> (!domParentFiber.dom) {
    domParentFiber = domParentFiber.parent;
  }
  <span class="org-keyword">const</span> <span class=
"org-variable-name">domParent</span> = domParentFiber.dom;

  <span class=
"org-keyword">if</span> (fiber.effectTag === <span class=
"org-string">"PLACEMENT"</span> &amp;& fiber.dom != <span class=
"org-constant">null</span>) {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ·»åŠ æ–°èŠ‚ç‚¹</span>
    domParent.appendChild(fiber.dom);
  } <span class="org-keyword">else</span> <span class=
"org-keyword">if</span> (fiber.effectTag === <span class=
"org-string">"UPDATE"</span> &amp;& fiber.dom != <span class=
"org-constant">null</span>) {
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ›´æ–°èŠ‚ç‚¹</span>
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  } <span class="org-keyword">else</span> <span class=
"org-keyword">if</span> (fiber.effectTag === <span class=
"org-string">"DELETION"</span>) {
    commitDeletion(fiber, domParent);
  }

  commitWork(fiber.child);
  commitWork(fiber.sibling);
}
</pre>
        </div>
        <p>åˆ é™¤çš„æ—¶å€™ä¹Ÿå¿…é¡»æ‰¾åˆ°æœ‰ child çš„ fiber, commitDeletion ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">commitDeletion</span>(<span class=
          "org-variable-name">fiber</span>, <span class=
          "org-variable-name">domParent</span>) {
  <span class="org-keyword">if</span> (fiber.dom) {
    domParent.removeChild(fiber.dom)
  } <span class="org-keyword">else</span> {
    commitDeletion(fiber.child, domParent)
  }
}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-hooks" class="outline-2">
      <h2 id="hooks"><span class="section-number-2">10.</span>
      hooks</h2>
      <div class="outline-text-2" id="text-hooks">
        <p>æ·»åŠ çŠ¶æ€å’Œ hooksã€‚</p>
        <p>åœ¨å‡½æ•°ç»„ä»¶ä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>useState</code> hook æ¥è·å–çŠ¶æ€ä»¥åŠæ”¹å˜çŠ¶æ€çš„å‡½æ•°
        <code>setState</code> è®©æˆ‘ä»¬èƒ½åœ¨å‡½æ•°ç»„ä»¶ä¸­æ¥æ›´æ–°çŠ¶æ€ï¼Œä»è€Œæ¥æ›´æ–°UIã€‚</p>
        <p>å®ä¾‹ï¼š</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">Counter</span>() {
<span class="org-keyword">const</span> [<span class=
"org-variable-name">state</span>, <span class=
"org-variable-name">setState</span>] = useState(<span class=
"org-highlight-numbers-number">1</span>)
  <span class="org-keyword">return</span> (
    &lt;h1 onClick={() =&gt; setState(c =&gt; c+<span class=
"org-highlight-numbers-number">1</span>)}&gt;
      Count: { state }
    &lt;/h1&gt;
  )
}
<span class="org-keyword">const</span> <span class=
"org-variable-name">elment</span> = &lt;Counter/&gt;
</pre>
        </div>
        <p>å®ç° useState å¹¶ä¸”ä¿®æ”¹å‡½æ•°ç»„ä»¶çš„æ›´æ–°å‡½æ•° updateFunctionComponent
        è®©çŠ¶æ€çš„ä¿®æ”¹èƒ½ è§¦å‘è¯¥å‡½æ•°æ‰§è¡Œ:</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">useState</span>(<span class=
          "org-variable-name">initial</span>) {
}

<span class="org-keyword">let</span> <span class=
"org-variable-name">wipFiber</span> = <span class=
"org-constant">null</span>
<span class="org-keyword">let</span> <span class=
"org-variable-name">hookIndex</span> = <span class=
"org-constant">null</span>
<span class="org-keyword">function</span> <span class=
"org-function-name">updateFunctionComponent</span>(<span class=
"org-variable-name">fiber</span>) {
  wipFiber = fiber
  hookIndex = <span class="org-highlight-numbers-number">0</span>
  wipFiber.hooks = []

  <span class="org-keyword">const</span> <span class=
"org-variable-name">children</span> = [fiber.type(fiber.props)]
  reconcileChildren(fiber, children)
}
</pre>
        </div>
        <p>æ–°å¢ fiber.hooks ç›®çš„æ˜¯ä¸ºäº†åœ¨åŒä¸€ä¸ªç»„ä»¶å†…å¯ä»¥å¤šæ¬¡è°ƒç”¨ <code>useState</code>,
        å¹¶ä¸”è®°å½•æ¯ä¸ª hook æ‰€åœ¨çš„ç´¢å¼• hookIndex ã€‚</p>
        <p>å½“ç»„ä»¶è°ƒç”¨ <code>useState</code> æ—¶å€™ï¼Œåœ¨é‡Œé¢è¦å»æ£€æµ‹æ˜¯ä¸æ˜¯æœ‰ old hookï¼Œä»
        fiber.alternate æ ¹æ® hookIndex å»æ‰¾ã€‚</p>
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">useState</span>(<span class=
          "org-variable-name">initial</span>) {
  <span class="org-keyword">const</span> <span class=
"org-variable-name">oldHook</span> =
    wipFiber.alternate &amp;&
    wipFiber.alternate.hooks &amp;&
    wipFiber.alternate.hooks[hookIndex];

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">å¦‚æœæœ‰è€çš„ hook ï¼Œè¦å°†è€çš„ hook state æ›´æ–°è¿‡æ¥</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">hook</span> = {
    state: oldHook ? oldHook.state : initial,
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">ç¼“å­˜çŠ¶æ€æ›´æ–°çš„ action</span>
    queue: [],
  };

  <span class="org-comment-delimiter">// </span><span class=
"org-comment">æ›´æ–°ä¹‹å‰å…ˆæ‰§è¡Œ actions æ›´æ–°çŠ¶æ€ï¼Œå› æ­¤åœ¨çŠ¶æ€è¿”å›ä¹‹å‰æ˜¯æœ€æ–°çš„</span>
  <span class="org-keyword">const</span> <span class=
"org-variable-name">actions</span> = oldHook ? oldHook.queue : [];
  actions.forEach((action) =&gt; (hook.state = action(hook.state)));

  <span class="org-keyword">const</span> <span class=
"org-variable-name">setState</span> = (action) =&gt; {
    hook.queue.push(action);
    wipRoot = {
      dom: currentRoot.dom,
      props: currentRoot.props,
      alternate: currentRoot,
    };
    <span class="org-comment-delimiter">// </span><span class=
"org-comment">çŠ¶æ€æ›´æ–°ï¼Œæ’å…¥æ–°çš„ work unit</span>
    nextUnitOfWork = wipRoot;
    deletion = [];
  };

  wipFiber.hooks.push(hook);
  hookIndex++;
  <span class="org-keyword">return</span> [hook.state, setState];
}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-src-map" class="outline-2">
      <h2 id="src-map"><span class="section-number-2">11.</span>
      æœ€ç»ˆæºç æµç¨‹å›¾</h2>
      <div class="outline-text-2" id="text-src-map">
        <div id="org2957e92" class="figure">
          <p><img src="file:///assets/img/react/react-src-code.svg"
          alt="react-src-code.svg" class="org-svg"></p>
        </div>
      </div>
    </div>
    <div id="outline-container-test" class="outline-2">
      <h2 id="test"><span class="section-number-2">12.</span>
      æµ‹è¯•</h2>
      <div class="outline-text-2" id="text-test">
        <div id="qvJvTTqyJw"></div>
        <script src="/js/react/tests/qvJvTTqyJw.js"></script>
        <p>diff è¿˜æ²¡æœ‰æ·±å…¥å®ç°ï¼Œæ²¡åšåˆ° setState åªæ›´æ–°ç›¸åº”çš„æ–‡æœ¬ <code>count =
        0</code> ç»„ä»¶ã€‚</p>
        <p>è¿˜æœ‰å¾…ç»§ç»­ç ”ç©¶ï¼ï¼ï¼</p>
      </div>
    </div>
    <div id="outline-container-summary" class="outline-2">
      <h2 id="summary"><span class="section-number-2">13.</span>
      æ€»ç»“</h2>
      <div class="outline-text-2" id="text-summary">
        <p>é€šè¿‡<a href=
        "https://pomb.us/build-your-own-react/">ä½œè€…</a>çš„è¿™ä¸ªå®ç°ï¼Œå¯¹ react
        çš„éƒ¨åˆ†ä¸»è¦åŠŸèƒ½æœ‰äº†ä¸€å®šçš„è®¤çŸ¥ï¼Œæ–‡å†…æ¶‰åŠçš„ä¸»è¦çŸ¥è¯†ç‚¹ï¼š</p>
        <ol class="org-ol">
          <li>createElement å®ç°</li>
          <li>render å‡½æ•°çš„å®ç°</li>
          <li>fiber tree çš„å¤„ç†(åˆå§‹åŒ–ï¼Œæ›´æ–°ï¼Œåˆ é™¤ï¼Œæ–°å¢ç­‰)</li>
          <li>commit é˜¶æ®µå¤„ç†ï¼Œå®é™…æ¸²æŸ“DOMå’Œ fiber tree çš„éå†æ˜¯åˆ†å¼€çš„</li>
          <li>useState hook å‡½æ•°å®ç°çš„åŸºç¡€åŸç†ï¼Œé€šè¿‡ wipFiber + hookIndex
          æ¥å®ç°å‡½æ•°ç»„ä»¶å’Œ useState çš„è¿æ¥ï¼Œä»è€Œäº’ç›¸å½±å“ã€‚</li>
        </ol>
      </div>
    </div>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Lee Zhicheng</p>
    <p class="date">Created: 2022-07-20 Wed 20:33</p>
  </div>
</body>
</html>
