<!DOCTYPE html>
<html lang="en">
<head>
  <!-- 2022-05-12 Thu 14:39 -->
  <meta charset="utf-8">
  <meta name="viewport" content=
  "width=device-width, initial-scale=1">
  <title>build your own vue runtime-core</title>
  <meta name="author" content="Zhicheng Lee">
  <meta name="generator" content="Org Mode">
  <style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/htmlize.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/readtheorg.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/global.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/element-plus.css">
  <link rel="icon" type="image/png" sizes="48x48" href=
  "/favicon.ico">
  <script type="text/javascript" src=
  "/assets/js/jquery.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/bootstrap.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/lodash.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/readtheorg.js"></script>
  <link rel="stylesheet" href="/assets/js/fancybox/fancybox.css"
  type="text/css" media="screen">
  <script type="text/javascript" src=
  "/assets/js/fancybox/fancybox.umd.js"></script>
  <script type="text/javascript" src=
  "/assets/js/mobile-detect.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/Valine.min.js"></script>
  <script type="text/javascript" src="/assets/js/vue.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-plus.js"></script>
  <script type="text/javascript" src=
  "/assets/js/element-icons.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/stats.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/apps.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/global.js"></script>
  <meta name="category" content="vue">
  <meta name="tags" content="runtime-core">
  <meta name="createdAt" content="2022-05-09 09:40:04">
  <style>
        /* From: https://endlessparentheses.com/public/css/endless.css */
        /* See also: https://meta.superuser.com/questions/4788/css-for-the-new-kbd-style */
        kbd
        {
          -moz-border-radius: 6px;
          -moz-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          -webkit-border-radius: 6px;
          -webkit-box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          background-color: #f7f7f7;
          border: 1px solid #ccc;
          border-radius: 6px;
          box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
          color: #333;
          display: inline-block;
          font-family: 'Droid Sans Mono', monospace;
          font-size: 80%;
          font-weight: normal;
          line-height: inherit;
          margin: 0 .1em;
          padding: .08em .4em;
          text-shadow: 0 1px 0 #fff;
          word-spacing: -4px;
        
          box-shadow: 2px 2px 2px #222; /* MA: An extra I've added. */
        }
  </style>
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster.bundle.min.css">
  <link rel="stylesheet" type="text/css" href=
  "/assets/css/tooltipster-sideTip-punk.min.css">
  <script type="text/javascript">
            if (typeof jQuery == 'undefined') {
                document.write(unescape('%3Cscript src="https://code.jquery.com/jquery-1.10.0.min.js"%3E%3C/script%3E'));
            }
  </script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster.bundle.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/tooltipster-scrollableTip.min.js"></script>
  <script type="text/javascript" src=
  "/assets/js/dist/tooltips.js"></script>
  <style>
           abbr {color: red;}
        
           .tooltip { border-bottom: 1px dotted #000;
                      color:red;
                      text-decoration: none;}
  </style>
</head>
<body>
  <div id="content" class="content">
    <h1 class="title">build your own vue runtime-core</h1>
    <div id="table-of-contents" role="doc-toc">
      <h2>Table of Contents</h2>
      <div id="text-table-of-contents" role="doc-toc">
        <ul>
          <li>
            <a href="#orgc5cede5">1. 简介</a>
          </li>
          <li>
            <a href="#org20aca26">2. mount()</a>
          </li>
          <li>
            <a href="#orged10293">3. createVNode()</a>
            <ul>
              <li>
                <a href="#org9d61672">3.1. cloneVNode()</a>
              </li>
              <li>
                <a href="#orgc7ded08">3.2. normalizeChildren()</a>
              </li>
              <li>
                <a href="#orgb8983f4">3.3. createBaseVNode()</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org9357b3e">4. h()</a>
          </li>
          <li>
            <a href="#org5c4f1d5">5. utils</a>
            <ul>
              <li>
                <a href="#orga2c7f83">5.1. normalizeClass()</a>
              </li>
              <li>
                <a href="#org5da451e">5.2. normalizeStyle()</a>
              </li>
              <li>
                <a href="#orgeeee497">5.3. normalizeKey()</a>
              </li>
              <li>
                <a href="#org47aad84">5.4. normalizeRef()</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#orge9e728f">6. watch</a>
          </li>
        </ul>
      </div>
    </div>
    <p><a href="/"><img src=
    "https://img.shields.io/badge/GCCLL-Homepage-green?logo=gnu-emacs"></a></p>
    <div style=
    "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <h3>Vue3 runtime-core</h3>
      <p>旧博客中的相关文章：</p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-runtime-core-1/">Vue3
      源码头脑风暴之 7 ☞ runtime-core(1) - 若叶知秋</a></p>
      <p><a href=
      "https://www.cheng92.com/vue/vue-mind-map-runtime-core-2-render/">
      Vue3 源码头脑风暴之 7 ☞ runtime-core(2) - render - 若叶知秋</a></p>
      <p><span style="color:red;">测试代码涉及到非runtime-core的会直接使用</span>
      <a href=
      "https://github.com/vuejs/core/tree/main/packages">core/packages
      at main · vuejs/core</a> <span style=
      "color:red;">现成的代码去测试</span></p>
      <p><a href=
      "https://github.com/vuejs/core/tree/main/packages/runtime-core">
      core/packages/runtime-core at main · vuejs/core</a>
      应该说是最核心的一个模块了，以 h 函数为入口涵盖了组件完整生命周期的处理，从 vnode -&gt; dom,
      mount -&gt; update -&gt; unmount 的实现原理。</p>
    </div><br>
    <br>
    <details class="code-details" style=
    "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
      <summary>
        <strong><font face="Courier" size="3" color=
        "green">GlobalVars</font></strong>
      </summary>
      <div class="org-src-container">
        <pre class="src src-js" id="org9b13f76"><span class=
        "linenr"> 1: </span><span class=
        "org-keyword">const</span> <span class=
        "org-variable-name">compilerSFC</span> = require(process.env.NODE_LIB + <span class="org-string">"/@vue/compiler-sfc"</span>)
<span class="linenr"> 2: </span><span class=
"org-keyword">const</span> {
<span class="linenr"> 3: </span>  isArray,
<span class="linenr"> 4: </span>  isFunction,
<span class="linenr"> 5: </span>  isString,
<span class="linenr"> 6: </span>  isObject,
<span class="linenr"> 7: </span>  EMPTY_ARR,
<span class="linenr"> 8: </span>  extend,
<span class="linenr"> 9: </span>  PatchFlags,
<span class="linenr">10: </span>  ShapeFlags,
<span class="linenr">11: </span>  SlotFlags,
<span class="linenr">12: </span>  isOn,
<span class="linenr">13: </span>  toDisplayString,
<span class="linenr">14: </span>  camelize,
<span class="linenr">15: </span>  capitalize,
<span class="linenr">16: </span>  toHandlerKey,
<span class="linenr">17: </span>  normalizeProps,
<span class="linenr">18: </span>  normalizeClass,
<span class="linenr">19: </span>  normalizeStyle,
<span class="linenr">20: </span>  isNoUnitNumericStyleProp
<span class=
"linenr">21: </span>} = require(process.env.NODE_LIB + <span class=
"org-string">"/@vue/shared"</span>)
<span class="linenr">22: </span>
<span class="linenr">23: </span><span class=
"org-keyword">const</span> {
<span class="linenr">24: </span>  isProxy, Ref, toRaw, isRef
<span class=
"linenr">25: </span>} = require(process.env.NODE_LIB + <span class=
"org-string">"/@vue/reactivity"</span>)
<span class="linenr">26: </span>
<span class="linenr">27: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">InternalObjectKey</span> = <span class=
"org-string">`__vInternal`</span>
<span class="linenr">28: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">ShapeFlags</span> = {
<span class="linenr">29: </span>  ELEMENT: <span class=
"org-highlight-numbers-number">1</span>,
<span class=
"linenr">30: </span>  FUNCTIONAL_COMPONENT: <span class="org-highlight-numbers-number">1</span> &lt;&lt; <span class="org-highlight-numbers-number">1</span>,
<span class="linenr">31: </span>  STATEFUL_COMPONENT: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">2</span>,
<span class="linenr">32: </span>  TEXT_CHILDREN: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">3</span>,
<span class="linenr">33: </span>  ARRAY_CHILDREN: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">4</span>,
<span class="linenr">34: </span>  SLOTS_CHILDREN: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">5</span>,
<span class="linenr">35: </span>  TELEPORT: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">6</span>,
<span class="linenr">36: </span>  SUSPENSE: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">7</span>,
<span class=
"linenr">37: </span>  COMPONENT_SHOULD_KEEP_ALIVE: <span class=
"org-highlight-numbers-number">1</span> &lt;&lt; <span class=
"org-highlight-numbers-number">8</span>,
<span class=
"linenr">38: </span>  COMPONENT_KEPT_ALIVE: <span class="org-highlight-numbers-number">1</span> &lt;&lt; <span class="org-highlight-numbers-number">9</span>,
<span class=
"linenr">39: </span>  COMPONENT: ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT
<span class="linenr">40: </span>}
</pre>
      </div>
    </details>
    <div id="outline-container-orgc5cede5" class="outline-2">
      <h2 id="orgc5cede5"><span class="section-number-2">1.</span>
      简介</h2>
      <div class="outline-text-2" id="text-1">
        <p><span style=
        "color:green;">runtime-core的核心入口函数即h也就是createVNode函数，所以会以这个为切入点</span>。</p><a href="../assets/img/vue3/runtime-core/vue-runtime-core.svg"
        data-fancybox="gallery" data-caption="Preview"><img src=
        "../assets/img/vue3/runtime-core/vue-runtime-core.svg"></a><br>

        <br>
        <details class="code-details" style=
        "padding: 1em; background-color: #e5f5e5; /* background-color: pink; */ border-radius: 15px; color: hsl(157 75%); font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
          <summary>
            <strong><font face="Courier" size="3" color=
            "red">本文中涉及的一些关键点记录</font></strong>
          </summary>
          <ul class="org-ul">
            <li>class 支持数组(<code>['foo',
            'bar']</code>)，对象(<code>{foo:true,bar:false}</code>)，字符串(<code>'foo
            bar'</code>)</li>
            <li>style 支持数组(<code>['color:red',
            {foo:'foo'}]</code>)，对象(<code>{color:'red',foo:'foo'}</code>)，字符串(<code>'color:red'</code>)</li>
            <li>class component 条件：
              <ol class="org-ol">
                <li>必须是 function 类型，其实 class
                只不是个语法糖，实际它也是个函数类型。</li>
                <li>含 <code>__vccOpts = { template: '&lt;div
                /&gt;'}</code></li>
              </ol>
            </li>
            <li></li>
            <li></li>
            <li>
              <p>和 函数多种使用方式组合？</p>
              <p><code>h(type, propsOrChildren,
              ...children)</code>, 参数个数多变，对于这个函数的使用方法 记
              忆只要记住一点：</p>
              <div style=
              "padding: 1em; background-color: #CCFFCC;border-radius: 15px; font-size: 0.9em; box-shadow: 0.05em 0.1em 5px 0.01em #00000057;">
                <h3></h3>
                <p>props 总是对象，children 可以是对象(必须是 VNode 类型
                _<sub>v</sub><sub>isVNode</sub>)也可以是 数 组，所以：</p>
                <p>argc = 2, 如果是数组就一定是 children</p>
                <p>argc = 2, 如果是对象且有
                _<sub>v</sub><sub>isVNode</sub> 标识，一定是 children 否则是
                props</p>
                <p>argc = 3, 按照 h(type, props, children) 处理</p>
                <p>argc &gt; 3, 按照 h(type, props, …children)
                处理，从第三个开始都是 children</p>
                <p><code>createVNode(type, props, children)</code>,
                固定三个参数，第二个一定是 props, 第三 个 一定是数组类型的
                children，因为它后面还有更多的其他参数(patchFlag, dynamicProps,
                isBlockNode)，所以前三个必须确定下来。</p>
              </div>
            </li>
          </ul>
        </details>
      </div>
      <ul class="org-ul">
        <li></li>
        <li>中的 source 只能是 reactive/ref/function/array 类型，
        如果是数组时其元素只能是 reactive/ref/function</li>
        <li></li>
        <li>
          <p>是如何直接使用 <code>newVal.a</code> 的？</p>
          <div class="org-src-container">
            <pre class="src src-js"><span class=
            "org-keyword">var</span> <span class=
            "org-variable-name">obj</span> = shallowRef({ a: <span class=
            "org-highlight-numbers-number">0</span> });
watch(shallowRef, (newVal) =&gt; {
  dummy = newVal.a; <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">这里为什么可以直接访问 obj.a，obj 又是什么？</span>
});
</pre>
          </div>
        </li>
        <li>
          <p>？</p>
          <p>实际上就是一个应用级别的全局变量，然后通过原型链继承的方式实现传递。</p>
          <p><code>provide(key,value)</code> 向组件
          <code>provides[key] = value</code> 设置</p>
          <p><code>inject(key)</code> 从组件
          <code>provides[key]</code> 取值</p>
        </li>
        <li>
          <p>setup() 返回值用来做了啥？</p>
          <p>如果是函数会被当做是该组件的 render 函数，可在使用 jsx 或 api 方式定义组件的时
          候使用。</p>
          <p>如果是一个对象则会被合并到 data 上去,所以如果使用了 setup() 可以考虑省略掉 vue2 的
          options api 写法。</p>
        </li>
        <li>组件声明周期函数(onBeforeXxx, onXxx)触发顺序是什么？</li>
      </ul>
      <p>在开始之前，先来看看 <code>createApp()</code> 做了什么，首先看一下 vue3
      是如何启动项目的。</p>
      <div class="org-src-container">
        <pre class=
        "src src-js">createApp(&lt;App/&gt;).use(ElementPlus).mount(<span class="org-string">'#app'</span>)
</pre>
      </div>
      <p>因此首先应该是 <code>createApp(&lt;App/&gt;)</code> 然后才是
      mount，这个两个关键节点的实现也都在 runtime-core
      这个包里面，所以这里就按照这个开发流程一步步往下解析(注： 至于 <code>&lt;App/&gt;</code>
      就不讲了，这个其实就是一个 root render 函数，与 <a href=
      "../../../../.gclrc/org/roam/build_your_own_vue_compiler_core.html#ID-5eff117f-92ba-490a-ba9c-e5f59e0cbe47">
      build your own vue compiler-core</a> 有关)。</p>
      <p>下面是一个大致的流程图，供参考。</p><a href=
      "../assets/img/vue3/runtime-core/runtime-core-brief-structure.svg"
      data-fancybox="gallery" data-caption="Preview"><img src=
      "../assets/img/vue3/runtime-core/runtime-core-brief-structure.svg"></a>
      <p>如上图， app 提供了几个能力：</p>
      <ol class="org-ol">
        <li>
          <code>app.config</code> 配置应用的能力
          <ul class="org-ul">
            <li><code>app.config.globalProperties</code>
            注册全局对象</li>
            <li><code>app.config.compilerOptions</code>
            提供额外的编译选项</li>
          </ul>
        </li>
        <li><code>app.use(Plugin)</code> 注册插件，如：
        <code>use(router)</code>, <code>use(ElementPlus)</code>,
        <code>use(vuex)</code> 等等</li>
        <li><code>app.component(name, MyComponent)</code> 注册全局组件到
        <code>context.components[]</code> ，这里注册的组件可以直接在任意子组 件中直接使用
        <code>&lt;my-component/&gt;</code> 而不需要引入。</li>
        <li><code>app.mixin()</code> 这个是为了兼容 vue2.x 的 options
        api。</li>
        <li><code>app.directive(name, { beforeMount, mounted, ...
        })</code>
        注册全局指令(<code>context.directives[]</code>)使用的。</li>
        <li><code>app.mount(Container)</code></li>
        <li><code>app.provide(key, value)</code> 注入 root
        级别的共享变量，子组件中可以通过 <code>inject(key)</code>
        拿到这些变量，实现就是基于原型链。</li>
      </ol>
    </div>
  </div>
  <div id="outline-container-org20aca26" class="outline-2">
    <h2 id="org20aca26"><span class="section-number-2">2.</span>
    mount()</h2>
    <div class="outline-text-2" id="text-2">
      <p>createVNode 构建完整的 vnode 树，再 render 到 DOM 。</p>
      <div class="org-src-container">
        <pre class="src src-typescript"><span class=
        "linenr"> 1: </span><span class=
        "org-keyword">export</span> <span class=
        "org-keyword">function</span> <span class=
        "org-function-name">createAppAPI</span>&lt;<span class=
        "org-type">HostElement</span>&gt;<span class=
        "org-rainbow-delimiters-depth-1">(</span>
<span class="linenr"> 2: </span>  render: <span class=
"org-type">RootRenderFunction</span>,
<span class="linenr"> 3: </span>  hydrate?: <span class=
"org-type">RootHydrateFunction</span>
<span class="linenr"> 4: </span><span class=
"org-rainbow-delimiters-depth-1">)</span>: <span class=
"org-type">CreateAppFunction</span>&lt;<span class=
"org-type">HostElement</span>&gt; <span class=
"org-rainbow-delimiters-depth-1">{</span>
<span class="linenr"> 5: </span>  <span class=
"org-keyword">return</span> <span class=
"org-keyword">function</span> <span class=
"org-function-name">createApp</span><span class=
"org-rainbow-delimiters-depth-2">(</span><span class=
"org-variable-name">rootComponent</span>, <span class=
"org-variable-name">rootProps</span> = <span class=
"org-constant">null</span><span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">...</span>
<span class="linenr"> 8: </span>
<span class="linenr"> 9: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">app</span>: <span class=
"org-type">App</span> = <span class=
"org-rainbow-delimiters-depth-3">(</span>context.app = <span class=
"org-rainbow-delimiters-depth-4">{</span>
<span class="linenr">10: </span>      <span class=
"org-function-name">mount</span><span class=
"org-rainbow-delimiters-depth-1">(</span>
<span class="linenr">11: </span>        rootContainer: <span class=
"org-type">HostElement</span>,
<span class="linenr">12: </span>        isHydrate?: <span class=
"org-typescript-primitive">boolean</span>,
<span class="linenr">13: </span>        isSVG?: <span class=
"org-typescript-primitive">boolean</span>
<span class="linenr">14: </span>      <span class=
"org-rainbow-delimiters-depth-1">)</span>: <span class=
"org-typescript-primitive">any</span> <span class=
"org-rainbow-delimiters-depth-1">{</span>
<span class="linenr">15: </span>        <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-2">(</span>!isMounted<span class=
"org-rainbow-delimiters-depth-2">)</span> <span class=
"org-rainbow-delimiters-depth-2">{</span>
<span class="linenr">16: </span>          <span class=
"org-keyword">const</span> <span class=
"org-variable-name">vnode</span> = <span class=
"org-function-name">createVNode</span><span class=
"org-rainbow-delimiters-depth-3">(</span>
<span class=
"linenr">17: </span>            rootComponent <span class=
"org-keyword">as</span> ConcreteComponent,
<span class="linenr">18: </span>            rootProps
<span class="linenr">19: </span>          <span class=
"org-rainbow-delimiters-depth-3">)</span>
<span class="linenr">20: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">store app context on the root VNode.</span>
<span class="linenr">21: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">this will be set on the root instance on initial mount.</span>
<span class=
"linenr">22: </span>          vnode.appContext = context
<span class="linenr">23: </span>
<span class="linenr">24: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">...</span>
<span class="linenr">25: </span>
<span class="linenr">26: </span>          <span class=
"org-keyword">if</span> <span class=
"org-rainbow-delimiters-depth-3">(</span>isHydrate &amp;& hydrate<span class="org-rainbow-delimiters-depth-3">)</span> <span class="org-rainbow-delimiters-depth-3">{</span>
<span class="linenr">27: </span>            <span class=
"org-function-name">hydrate</span><span class=
"org-rainbow-delimiters-depth-4">(</span>vnode <span class=
"org-keyword">as</span> VNode&lt;<span class=
"org-type">Node</span>, <span class=
"org-type">Element</span>&gt;, rootContainer <span class=
"org-keyword">as</span> <span class=
"org-typescript-primitive">any</span><span class=
"org-rainbow-delimiters-depth-4">)</span>
<span class="linenr">28: </span>          <span class=
"org-rainbow-delimiters-depth-3">}</span> <span class=
"org-keyword">else</span> <span class=
"org-rainbow-delimiters-depth-3">{</span>
<span class="linenr">29: </span>            <span class=
"org-function-name">render</span><span class=
"org-rainbow-delimiters-depth-4">(</span>vnode, rootContainer, isSVG<span class="org-rainbow-delimiters-depth-4">)</span>
<span class="linenr">30: </span>          <span class=
"org-rainbow-delimiters-depth-3">}</span>
<span class="linenr">31: </span>
<span class="linenr">32: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">...</span>
<span class="linenr">33: </span>          <span class=
"org-keyword">return</span> <span class=
"org-function-name">getExposeProxy</span><span class=
"org-rainbow-delimiters-depth-3">(</span>vnode.component!<span class="org-rainbow-delimiters-depth-3">)</span> || vnode.component!.proxy
<span class="linenr">34: </span>        <span class=
"org-rainbow-delimiters-depth-2">}</span>
<span class="linenr">35: </span>      <span class=
"org-rainbow-delimiters-depth-1">}</span>,
<span class="linenr">36: </span>    <span class=
"org-rainbow-delimiters-depth-4">}</span><span class=
"org-rainbow-delimiters-depth-3">)</span>
<span class="linenr">37: </span>
<span class="linenr">38: </span>    <span class=
"org-keyword">return</span> app
<span class="linenr">39: </span>  <span class=
"org-rainbow-delimiters-depth-2">}</span>
<span class="linenr">40: </span><span class=
"org-rainbow-delimiters-depth-1">}</span>
</pre>
      </div>
    </div>
  </div>
  <div id="outline-container-orged10293" class="outline-2">
    <h2 id="orged10293"><span class="section-number-2">3.</span>
    createVNode()</h2>
    <div class="outline-text-2" id="text-3">
      <p>rootProps 是在 <code>createApp(Root, props)</code>
      的第二个参数传过来的对象做为 root 组件的 props。</p>
      <div class="org-src-container">
        <pre class="src src-js" id="orgcdc5b7c"><span class=
        "linenr"> 1: </span><span class=
        "org-keyword">function</span> <span class=
        "org-function-name">isVNode</span>(<span class=
        "org-variable-name">value</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">return</span> value ? value.__v_isVNode === <span class="org-constant">true</span> : <span class="org-constant">false</span>
<span class="linenr"> 3: </span>}
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">createVNode</span>(
<span class="linenr"> 6: </span>  <span class=
"org-variable-name">type</span>,
<span class="linenr"> 7: </span>  <span class=
"org-variable-name">props</span>,
<span class="linenr"> 8: </span>  children = <span class=
"org-constant">null</span>,
<span class="linenr"> 9: </span>  patchFlag = <span class=
"org-highlight-numbers-number">0</span>,
<span class="linenr">10: </span>  dynamicProps = <span class=
"org-constant">null</span>,
<span class="linenr">11: </span>  isBlockNode = <span class=
"org-constant">false</span>
<span class="linenr">12: </span>) {
<span class="linenr">13: </span>  <span class=
"org-keyword">if</span> (isVNode(type)) {
<span class="linenr">14: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">cloned</span> = cloneVNode(type, props)
<span class="linenr">15: </span>    <span class=
"org-keyword">if</span> (children) {
<span class=
"linenr">16: </span>      normalizeChildren(cloned, children)
<span class="linenr">17: </span>    }
<span class="linenr">18: </span>    <span class=
"org-keyword">return</span> cloned
<span class="linenr">19: </span>  }
<span class="linenr">20: </span>
<span class="linenr">21: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">class 和 style 处理</span>
<span class="linenr">22: </span>  <span class=
"org-keyword">if</span> (props) {
<span class="linenr">23: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment"><span class="org-bold"><span class=
"org-warning">TODO</span></span></span>
<span class="linenr">24: </span>  }
<span class="linenr">25: </span>
<span class="linenr">26: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">shapeFlag</span> = isString(type)
<span class="linenr">27: </span>    ? ShapeFlags.ELEMENT
<span class="linenr">28: </span>    : isSuspense(type)
<span class="linenr">29: </span>    ? ShapeFlags.SUSPENSE
<span class="linenr">30: </span>    : isTeleport(type)
<span class="linenr">31: </span>    ? ShapeFlags.TELEPORT
<span class="linenr">32: </span>    : isObject(type)
<span class="linenr">33: </span>    ? ShapeFlags.STATEFUL_COMPONENT
<span class="linenr">34: </span>    : isFunction(type)
<span class=
"linenr">35: </span>    ? ShapeFlags.FUNCTIONAL_COMPONENT
<span class="linenr">36: </span>    : <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr">37: </span>
<span class="linenr">38: </span>
<span class="linenr">39: </span>  <span class=
"org-keyword">return</span> createBaseVNode(
<span class="linenr">40: </span>    type,
<span class="linenr">41: </span>    props,
<span class="linenr">42: </span>    children,
<span class="linenr">43: </span>    patchFlag,
<span class="linenr">44: </span>    dynamicProps,
<span class="linenr">45: </span>    shapeFlag,
<span class="linenr">46: </span>    isBlockNode,
<span class="linenr">47: </span>    <span class=
"org-constant">true</span>
<span class="linenr">48: </span>  )
<span class="linenr">49: </span>}
</pre>
      </div>
    </div>
    <div id="outline-container-org9d61672" class="outline-3">
      <h3 id="org9d61672"><span class=
      "section-number-3">3.1.</span> cloneVNode()</h3>
      <div class="outline-text-3" id="text-3-1">
        <p>克隆过程中处理了 key 和 ref 属性：</p>
        <ol class="org-ol">
          <li>这个里面处理了 class 和 style
            <ul class="org-ul">
              <li>
                <a href="#orgf0e9bb9">normalizeClass()</a>
              </li>
              <li>
                <a href="#org234a92d">normalizeStyle()</a>
              </li>
            </ul>
          </li>
          <li>
            <a href="#org65186a4">normalizeKey(mergedProps)</a>, 处理
            prop key
          </li>
          <li>, 处理 prop ref</li>
        </ol>
        <div class="org-src-container">
          <pre class="src src-js" id="orga1649b0"><span class=
          "linenr"> 1: </span><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">cloneVNode</span>(<span class=
          "org-variable-name">vnode</span>, <span class=
          "org-variable-name">extraProps</span>, <span class=
          "org-variable-name">mergeRef</span> = <span class=
          "org-constant">false</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">This is intentionally NOT using spread or extend to avoid the runtime</span>
<span class="linenr"> 3: </span>  <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">key enumeration cost.</span>
<span class="linenr"> 4: </span>  <span class=
"org-keyword">const</span> { props, ref, patchFlag, children } = vnode
<span class="linenr"> 5: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">mergedProps</span> = extraProps ? mergeProps(props || {}, extraProps) : props
<span class="linenr"> 6: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">cloned</span> = {
<span class="linenr"> 7: </span>    __v_isVNode: <span class=
"org-constant">true</span>,
<span class="linenr"> 8: </span>    __v_skip: <span class=
"org-constant">true</span>,
<span class="linenr"> 9: </span>    type: vnode.type,
<span class="linenr">10: </span>    props: mergedProps,
<span class=
"linenr">11: </span>    key: mergedProps &amp;& normalizeKey(mergedProps),
<span class="linenr">12: </span>    ref:
<span class=
"linenr">13: </span>      extraProps &amp;& extraProps.ref
<span class="linenr">14: </span>        ? <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">#2078 in the case of &lt;component :is="vnode" ref="extra"/&gt;</span>
<span class="linenr">15: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if the vnode itself already has a ref, cloneVNode will need to merge</span>
<span class="linenr">16: </span>          <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">the refs so the single vnode can be set on multiple refs</span>
<span class="linenr">17: </span>          mergeRef &amp;& ref
<span class="linenr">18: </span>          ? isArray(ref)
<span class=
"linenr">19: </span>            ? ref.concat(normalizeRef(extraProps)!)
<span class=
"linenr">20: </span>            : [ref, normalizeRef(extraProps)]
<span class=
"linenr">21: </span>          : normalizeRef(extraProps)
<span class="linenr">22: </span>        : ref,
<span class="linenr">23: </span>    scopeId: vnode.scopeId,
<span class=
"linenr">24: </span>    slotScopeIds: vnode.slotScopeIds,
<span class="linenr">25: </span>    children,
<span class="linenr">26: </span>    target: vnode.target,
<span class=
"linenr">27: </span>    targetAnchor: vnode.targetAnchor,
<span class="linenr">28: </span>    staticCount: vnode.staticCount,
<span class="linenr">29: </span>    shapeFlag: vnode.shapeFlag,
<span class="linenr">30: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if the vnode is cloned with extra props, we can no longer assume its</span>
<span class="linenr">31: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">existing patch flag to be reliable and need to add the FULL_PROPS flag.</span>
<span class="linenr">32: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">note: preserve flag for fragments since they use the flag for children</span>
<span class="linenr">33: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">fast paths only.</span>
<span class="linenr">34: </span>    patchFlag:
<span class=
"linenr">35: </span>      extraProps &amp;& vnode.type !== Fragment
<span class=
"linenr">36: </span>        ? patchFlag === -<span class=
"org-highlight-numbers-number">1</span> <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">hoisted node</span>
<span class="linenr">37: </span>          ? PatchFlags.FULL_PROPS
<span class=
"linenr">38: </span>          : patchFlag | PatchFlags.FULL_PROPS
<span class="linenr">39: </span>        : patchFlag,
<span class=
"linenr">40: </span>    dynamicProps: vnode.dynamicProps,
<span class=
"linenr">41: </span>    dynamicChildren: vnode.dynamicChildren,
<span class="linenr">42: </span>    appContext: vnode.appContext,
<span class="linenr">43: </span>    dirs: vnode.dirs,
<span class="linenr">44: </span>    transition: vnode.transition,
<span class="linenr">45: </span>
<span class="linenr">46: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">These should technically only be non-null on mounted VNodes. However,</span>
<span class="linenr">47: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">they *should* be copied for kept-alive vnodes. So we just always copy</span>
<span class="linenr">48: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">them since them being non-null during a mount doesn't affect the logic as</span>
<span class="linenr">49: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">they will simply be overwritten.</span>
<span class="linenr">50: </span>    component: vnode.component,
<span class="linenr">51: </span>    suspense: vnode.suspense,
<span class=
"linenr">52: </span>    ssContent: vnode.ssContent &amp;& cloneVNode(vnode.ssContent),
<span class=
"linenr">53: </span>    ssFallback: vnode.ssFallback &amp;& cloneVNode(vnode.ssFallback),
<span class="linenr">54: </span>    el: vnode.el,
<span class="linenr">55: </span>    anchor: vnode.anchor
<span class="linenr">56: </span>  }
<span class="linenr">57: </span>
<span class="linenr">58: </span>  <span class=
"org-keyword">return</span> cloned
<span class="linenr">59: </span>}
<span class="linenr">60: </span>
<span class="linenr">61: </span>
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-orgc7ded08" class="outline-3">
      <h3 id="orgc7ded08"><span class=
      "section-number-3">3.2.</span> normalizeChildren()</h3>
      <div class="outline-text-3" id="text-3-2">
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "linenr"> 1: </span><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">normalizeChildren</span>(<span class=
          "org-variable-name">vnode</span>, <span class=
          "org-variable-name">children</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">type</span> = <span class=
"org-highlight-numbers-number">0</span>
<span class="linenr"> 3: </span>  <span class=
"org-keyword">const</span> { shapeFlag } = vnode
<span class="linenr"> 4: </span>  <span class=
"org-keyword">if</span> (children == <span class=
"org-constant">null</span>) {
<span class="linenr"> 5: </span>    children = <span class=
"org-constant">null</span>
<span class="linenr"> 6: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isArray(children)) {
<span class=
"linenr"> 7: </span>    type = ShapeFlags.ARRAY_CHILDREN
<span class="linenr"> 8: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (<span class=
"org-keyword">typeof</span> children === <span class=
"org-string">'object'</span>) {
<span class="linenr"> 9: </span>    <span class=
"org-keyword">if</span> (shapeFlag & (ShapeFlags.ELEMENT | ShapeFlags.TELEPORT)) {
<span class="linenr">10: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">Normalize slot to plain children for plain element and Teleport</span>
<span class="linenr">11: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slot</span> = children.<span class=
"org-keyword">default</span>
<span class="linenr">12: </span>      <span class=
"org-keyword">if</span> (slot) {
<span class="linenr">13: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">_c marker is added by withCtx() indicating this is a compiled slot</span>
<span class=
"linenr">14: </span>        slot._c &amp;& (slot._d = <span class=
"org-constant">false</span>)
<span class=
"linenr">15: </span>        normalizeChildren(vnode, slot())
<span class=
"linenr">16: </span>        slot._c &amp;& (slot._d = <span class=
"org-constant">true</span>)
<span class="linenr">17: </span>      }
<span class="linenr">18: </span>      <span class=
"org-keyword">return</span>
<span class="linenr">19: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">20: </span>      type = ShapeFlags.SLOTS_CHILDREN
<span class="linenr">21: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">slotFlag</span> = children._
<span class="linenr">22: </span>      <span class=
"org-keyword">if</span> (!slotFlag &amp;& !(InternalObjectKey <span class="org-keyword">in</span> children)) {
<span class="linenr">23: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">if slots are not normalized, attach context instance</span>
<span class="linenr">24: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">(compiled / normalized slots already have context)</span>
<span class=
"linenr">25: </span>        children._ctx = currentRenderingInstance
<span class="linenr">26: </span>      } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (slotFlag === SlotFlags.FORWARDED &amp;& currentRenderingInstance) {
<span class="linenr">27: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">a child component receives forwarded slots from the parent.</span>
<span class="linenr">28: </span>        <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">its slot type is determined by its parent's slot type.</span>
<span class="linenr">29: </span>        <span class=
"org-keyword">if</span> (
<span class=
"linenr">30: </span>          (currentRenderingInstance.slots as RawSlots)._ === SlotFlags.STABLE
<span class="linenr">31: </span>        ) {
<span class=
"linenr">32: </span>          ;(children as RawSlots)._ = SlotFlags.STABLE
<span class="linenr">33: </span>        } <span class=
"org-keyword">else</span> {
<span class=
"linenr">34: </span>          ;(children as RawSlots)._ = SlotFlags.DYNAMIC
<span class=
"linenr">35: </span>          vnode.patchFlag |= PatchFlags.DYNAMIC_SLOTS
<span class="linenr">36: </span>        }
<span class="linenr">37: </span>      }
<span class="linenr">38: </span>    }
<span class="linenr">39: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isFunction(children)) {
<span class="linenr">40: </span>    children = { <span class=
"org-keyword">default</span>: children, _ctx: currentRenderingInstance }
<span class=
"linenr">41: </span>    type = ShapeFlags.SLOTS_CHILDREN
<span class="linenr">42: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">43: </span>    children = String(children)
<span class="linenr">44: </span>    <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">force teleport children to array so it can be moved around</span>
<span class="linenr">45: </span>    <span class=
"org-keyword">if</span> (shapeFlag & ShapeFlags.TELEPORT) {
<span class=
"linenr">46: </span>      type = ShapeFlags.ARRAY_CHILDREN
<span class=
"linenr">47: </span>      children = [createTextVNode(children as string)]
<span class="linenr">48: </span>    } <span class=
"org-keyword">else</span> {
<span class=
"linenr">49: </span>      type = ShapeFlags.TEXT_CHILDREN
<span class="linenr">50: </span>    }
<span class="linenr">51: </span>  }
<span class="linenr">52: </span>  vnode.children = children
<span class="linenr">53: </span>  vnode.shapeFlag |= type
<span class="linenr">54: </span>}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-orgb8983f4" class="outline-3">
      <h3 id="orgb8983f4"><span class=
      "section-number-3">3.3.</span> createBaseVNode()</h3>
    </div>
  </div>
  <div id="outline-container-org9357b3e" class="outline-2">
    <h2 id="org9357b3e"><span class="section-number-2">4.</span>
    h()</h2>
    <div class="outline-text-2" id="text-4">
      <p>h 函数实际上是对 createVNode 函数的一次包装，主要是支持多种参数传递方式。</p>
      <div class="org-src-container">
        <pre class="src src-js" id="org1c404f8"><span class=
        "linenr"> 1: </span>&lt;&lt;vue-pkgs&gt;&gt;
<span class="linenr"> 2: </span>&lt;&lt;utils&gt;&gt;
<span class="linenr"> 3: </span>&lt;&lt;createVNode&gt;&gt;
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">h</span>(<span class=
"org-variable-name">type</span>, <span class=
"org-variable-name">propsOrChildren</span>, <span class=
"org-variable-name">children</span>) {
<span class="linenr"> 6: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">l</span> = <span class=
"org-constant">arguments</span>.length
<span class="linenr"> 7: </span>  <span class=
"org-keyword">if</span> (l === <span class=
"org-highlight-numbers-number">2</span>) {
<span class="linenr"> 8: </span>    <span class=
"org-keyword">if</span> (isObject(propsOrChildren) &amp;& !isArray(propsOrChildren)) {
<span class="linenr"> 9: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">single vnode without props</span>
<span class="linenr">10: </span>      <span class=
"org-keyword">if</span> (isVNode(propsOrChildren)) {
<span class="linenr">11: </span>        <span class=
"org-keyword">return</span> createVNode(type, <span class=
"org-constant">null</span>, [propsOrChildren])
<span class="linenr">12: </span>      }
<span class="linenr">13: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">props without children</span>
<span class="linenr">14: </span>      <span class=
"org-keyword">return</span> createVNode(type, propsOrChildren)
<span class="linenr">15: </span>    } <span class=
"org-keyword">else</span> {
<span class="linenr">16: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">omit props</span>
<span class="linenr">17: </span>      <span class=
"org-keyword">return</span> createVNode(type, <span class=
"org-constant">null</span>, propsOrChildren)
<span class="linenr">18: </span>    }
<span class="linenr">19: </span>  } <span class=
"org-keyword">else</span> {
<span class="linenr">20: </span>    <span class=
"org-keyword">if</span> (l &gt; <span class=
"org-highlight-numbers-number">3</span>) {
<span class="linenr">21: </span>      children = Array.<span class=
"org-constant">prototype</span>.slice.call(<span class=
"org-constant">arguments</span>, <span class=
"org-highlight-numbers-number">2</span>)
<span class="linenr">22: </span>    } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (l === <span class=
"org-highlight-numbers-number">3</span> &amp;& isVNode(children)) {
<span class="linenr">23: </span>      children = [children]
<span class="linenr">24: </span>    }
<span class="linenr">25: </span>    <span class=
"org-keyword">return</span> createVNode(type, propsOrChildren, children)
<span class="linenr">26: </span>  }
<span class="linenr">27: </span>}
</pre>
      </div>
    </div>
  </div>
  <div id="outline-container-org5c4f1d5" class="outline-2">
    <h2 id="org5c4f1d5"><span class="section-number-2">5.</span>
    utils</h2>
    <div class="outline-text-2" id="text-5">
      <div class="org-src-container">
        <pre class="src src-js" id="org54b8dc6"><span class=
        "linenr">1: </span><span class=
        "org-keyword">const</span> <span class=
        "org-variable-name">InternalObjectKey</span> = <span class=
        "org-string">`__vInternal`</span>
<span class="linenr">2: </span>
<span class="linenr">3: </span>&lt;&lt;normalizeKey&gt;&gt;
<span class="linenr">4: </span>&lt;&lt;normalizeRef&gt;&gt;
<span class="linenr">5: </span>&lt;&lt;normalizeClass&gt;&gt;
<span class="linenr">6: </span>&lt;&lt;normalizeStyle&gt;&gt;
</pre>
      </div>
    </div>
    <div id="outline-container-orga2c7f83" class="outline-3">
      <h3 id="orga2c7f83"><span class=
      "section-number-3">5.1.</span> normalizeClass()</h3>
      <div class="outline-text-3" id="text-5-1">
        <p>兼容各种类型的 class 使用：</p>
        <ol class="org-ol">
          <li><code>&lt;div class="name"&gt;</code> =&gt;
          <code>"name"</code></li>
          <li><code>&lt;div :class="['name1', 'name2']&gt;</code>
          =&gt; <code>"name1 name2"</code></li>
          <li><code>&lt;div :class="{ name1: true, name2: true
          }"&gt;</code> =&gt; <code>"name1 name2"</code></li>
        </ol>
        <p>并且三种情况可以同时使用：</p>
        <p><code>&lt;div class="name1" :class="['name2', 'name3']"
        :class="{ name4: true }"&gt;</code> =&gt; <code>"name1
        name2 name3 name4"</code></p>
        <div class="org-src-container">
          <pre class="src src-js" id="orgf0e9bb9"><span class=
          "linenr"> 1: </span><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">normalizeClass</span>(<span class=
          "org-variable-name">value</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">res</span> = <span class="org-string">''</span>
<span class="linenr"> 3: </span>  <span class=
"org-keyword">if</span> (isString(value)) {
<span class="linenr"> 4: </span>    res = value
<span class="linenr"> 5: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isArray(value)) {
<span class="linenr"> 6: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; value.length; i++) {
<span class="linenr"> 7: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">normalized</span> = normalizeClass(value[i])
<span class="linenr"> 8: </span>      <span class=
"org-keyword">if</span> (normalized) {
<span class=
"linenr"> 9: </span>        res += normalized + <span class=
"org-string">' '</span>
<span class="linenr">10: </span>      }
<span class="linenr">11: </span>    }
<span class="linenr">12: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isObject(value)) {
<span class="linenr">13: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">name</span> <span class=
"org-keyword">in</span> value) {
<span class="linenr">14: </span>      <span class=
"org-keyword">if</span> (value[name]) {
<span class="linenr">15: </span>        res += name + <span class=
"org-string">' '</span>
<span class="linenr">16: </span>      }
<span class="linenr">17: </span>    }
<span class="linenr">18: </span>  }
<span class="linenr">19: </span>  <span class=
"org-keyword">return</span> res.trim()
<span class="linenr">20: </span>}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-org5da451e" class="outline-3">
      <h3 id="org5da451e"><span class=
      "section-number-3">5.2.</span> normalizeStyle()</h3>
      <div class="outline-text-3" id="text-5-2">
        <div class="org-src-container">
          <pre class="src src-js" id="org234a92d"><span class=
          "linenr"> 1: </span><span class=
          "org-keyword">function</span> <span class=
          "org-function-name">normalizeStyle</span>(<span class=
          "org-variable-name">value</span>) {
<span class="linenr"> 2: </span>  <span class=
"org-keyword">if</span> (isArray(value)) {
<span class="linenr"> 3: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">res</span> = {}
<span class="linenr"> 4: </span>    <span class=
"org-keyword">for</span> (<span class=
"org-keyword">let</span> <span class=
"org-variable-name">i</span> = <span class=
"org-highlight-numbers-number">0</span>; i &lt; value.length; i++) {
<span class="linenr"> 5: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">item</span> = value[i]
<span class="linenr"> 6: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">normalized</span> = isString(item)
<span class="linenr"> 7: </span>        ? parseStringStyle(item)
<span class="linenr"> 8: </span>        : (normalizeStyle(item))
<span class="linenr"> 9: </span>      <span class=
"org-keyword">if</span> (normalized) {
<span class="linenr">10: </span>        <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> <span class=
"org-keyword">in</span> normalized) {
<span class=
"linenr">11: </span>          res[key] = normalized[key]
<span class="linenr">12: </span>        }
<span class="linenr">13: </span>      }
<span class="linenr">14: </span>    }
<span class="linenr">15: </span>    <span class=
"org-keyword">return</span> res
<span class="linenr">16: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isString(value)) {
<span class="linenr">17: </span>    <span class=
"org-keyword">return</span> value
<span class="linenr">18: </span>  } <span class=
"org-keyword">else</span> <span class=
"org-keyword">if</span> (isObject(value)) {
<span class="linenr">19: </span>    <span class=
"org-keyword">return</span> value
<span class="linenr">20: </span>  }
<span class="linenr">21: </span>}
<span class="linenr">22: </span>
<span class="linenr">23: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">listDelimiterRE</span> = <span class=
"org-string">/;(?![^(]*\))/</span>g
<span class="linenr">24: </span><span class=
"org-keyword">const</span> <span class=
"org-variable-name">propertyDelimiterRE</span> = <span class=
"org-string">/:(.+)/</span>
<span class="linenr">25: </span>
<span class="linenr">26: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">parseStringStyle</span>(<span class=
"org-variable-name">cssText</span>) {
<span class="linenr">27: </span>  <span class=
"org-keyword">const</span> <span class=
"org-variable-name">ret</span> = {}
<span class=
"linenr">28: </span>  cssText.split(listDelimiterRE).forEach(item =&gt; {
<span class="linenr">29: </span>    <span class=
"org-keyword">if</span> (item) {
<span class="linenr">30: </span>      <span class=
"org-keyword">const</span> <span class=
"org-variable-name">tmp</span> = item.split(propertyDelimiterRE)
<span class="linenr">31: </span>      tmp.length &gt; <span class=
"org-highlight-numbers-number">1</span> &amp;& (ret[tmp[<span class="org-highlight-numbers-number">0</span>].trim()] = tmp[<span class="org-highlight-numbers-number">1</span>].trim())
<span class="linenr">32: </span>    }
<span class="linenr">33: </span>  })
<span class="linenr">34: </span>  <span class=
"org-keyword">return</span> ret
<span class="linenr">35: </span>}
<span class="linenr">36: </span>
<span class="linenr">37: </span><span class=
"org-keyword">function</span> <span class=
"org-function-name">stringifyStyle</span>(<span class=
"org-variable-name">styles</span>) {
<span class="linenr">38: </span>  <span class=
"org-keyword">let</span> <span class=
"org-variable-name">ret</span> = <span class="org-string">''</span>
<span class="linenr">39: </span>  <span class=
"org-keyword">if</span> (!styles || isString(styles)) {
<span class="linenr">40: </span>    <span class=
"org-keyword">return</span> ret
<span class="linenr">41: </span>  }
<span class="linenr">42: </span>  <span class=
"org-keyword">for</span> (<span class=
"org-keyword">const</span> <span class=
"org-variable-name">key</span> <span class=
"org-keyword">in</span> styles) {
<span class="linenr">43: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">value</span> = styles[key]
<span class="linenr">44: </span>    <span class=
"org-keyword">const</span> <span class=
"org-variable-name">normalizedKey</span> = key.startsWith(<span class="org-string">`--`</span>) ? key : hyphenate(key)
<span class="linenr">45: </span>    <span class=
"org-keyword">if</span> (
<span class="linenr">46: </span>      isString(value) ||
<span class="linenr">47: </span>      (<span class=
"org-keyword">typeof</span> value === <span class=
"org-string">'number'</span> &amp;& isNoUnitNumericStyleProp(normalizedKey))
<span class="linenr">48: </span>    ) {
<span class="linenr">49: </span>      <span class=
"org-comment-delimiter">// </span><span class=
"org-comment">only render valid values</span>
<span class="linenr">50: </span>      ret += <span class=
"org-string">`${normalizedKey}:${value};`</span>
<span class="linenr">51: </span>    }
<span class="linenr">52: </span>  }
<span class="linenr">53: </span>  <span class=
"org-keyword">return</span> ret
<span class="linenr">54: </span>}
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-orgeeee497" class="outline-3">
      <h3 id="orgeeee497"><span class=
      "section-number-3">5.3.</span> normalizeKey()</h3>
      <div class="outline-text-3" id="text-5-3">
        <div class="org-src-container">
          <pre class="src src-js" id="org65186a4"><span class=
          "linenr">1: </span><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">normalizeKey</span> = ({ key }) =&gt; key != <span class="org-constant">null</span> ? key : <span class="org-constant">null</span>
</pre>
        </div>
      </div>
    </div>
    <div id="outline-container-org47aad84" class="outline-3">
      <h3 id="org47aad84"><span class=
      "section-number-3">5.4.</span> normalizeRef()</h3>
      <div class="outline-text-3" id="text-5-4">
        <div class="org-src-container">
          <pre class="src src-js"><span class=
          "linenr">1: </span><span class=
          "org-keyword">const</span> <span class=
          "org-variable-name">normalizeRef</span> = ({ ref, ref_key, ref_for }) =&gt; {
<span class="linenr">2: </span>  <span class=
"org-keyword">return</span> (
<span class="linenr">3: </span>    ref != <span class=
"org-constant">null</span>
<span class=
"linenr">4: </span>      ? isString(ref) || isRef(ref) || isFunction(ref)
<span class=
"linenr">5: </span>        ? { i: currentRenderingInstance, r: ref, k: ref_key, f: !!ref_for }
<span class="linenr">6: </span>        : ref
<span class="linenr">7: </span>      : <span class=
"org-constant">null</span>
<span class="linenr">8: </span>  )
<span class="linenr">9: </span>}
</pre>
        </div>
      </div>
    </div>
  </div>
  <div id="outline-container-orge9e728f" class="outline-2">
    <h2 id="orge9e728f"><span class="section-number-2">6.</span>
    watch</h2>
  </div>
  <div id="postamble" class="status">
    <p class="author">Author: Zhicheng Lee</p>
    <p class="date">Created: 2022-05-12 Thu 14:39</p>
  </div>
</body>
</html>
